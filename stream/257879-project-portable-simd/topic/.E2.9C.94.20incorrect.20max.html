<html>
<head><meta charset="utf-8"><title>✔ incorrect max · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html">✔ incorrect max</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274513250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274513250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274513250">(Mar 08 2022 at 09:10)</a>:</h4>
<p>I am getting this strange bug. The below fails:</p>
<div class="codehilite"><pre><span></span><code>fn main() {
    let a = i64x2::from_array([0, 0]);
    let b = i64x2::from_array([1, -10]);
    let max = a.max(b);
    assert_eq!(max, i64x2::from_array([1, 0]));
}
</code></pre></div>
<p>However, I can't find an obvious error in the core_simd code. Can someone reproduce this?</p>



<a name="274515424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274515424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274515424">(Mar 08 2022 at 09:33)</a>:</h4>
<p>that is <a href="https://github.com/rust-lang/portable-simd/issues/247">portable-simd#247</a></p>



<a name="274515666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274515666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274515666">(Mar 08 2022 at 09:34)</a>:</h4>
<p>basically, min/max are currently only defined for floats, so you're seeing Ord::max, which compares the whole vector as a unit, rather than lane-wise</p>



<a name="274515769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274515769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274515769">(Mar 08 2022 at 09:35)</a>:</h4>
<p>is there an API to perform the lane-wise comparison?</p>



<a name="274515874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274515874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274515874">(Mar 08 2022 at 09:36)</a>:</h4>
<p>yes, lanes_lt combined with select</p>



<a name="274515913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274515913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274515913">(Mar 08 2022 at 09:36)</a>:</h4>
<p>there isn't a lanewise min/max, though we plan on most likely adding one</p>



<a name="274516982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274516982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274516982">(Mar 08 2022 at 09:47)</a>:</h4>
<p>we just rolled std::simd to arrow2 and Polars to give it a spin and had to revert all of that because of this. XD</p>



<a name="274517435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274517435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274517435">(Mar 08 2022 at 09:51)</a>:</h4>
<p>well, the correct max will probably just call lanes_lt and select internally, llvm has no separate simd integer max operations.</p>



<a name="274517740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274517740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274517740">(Mar 08 2022 at 09:54)</a>:</h4>
<p>afaict lanewise <code>a.max(b)</code> is just <code>a.lanes_lt(b).select(b, a)</code></p>



<a name="274518861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274518861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274518861">(Mar 08 2022 at 10:04)</a>:</h4>
<p>created: <a href="https://github.com/rust-lang/portable-simd/issues/257">https://github.com/rust-lang/portable-simd/issues/257</a></p>



<a name="274518934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274518934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274518934">(Mar 08 2022 at 10:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="399416">Jorge Leitao</span> has marked this topic as resolved.</p>



<a name="274601143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274601143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274601143">(Mar 08 2022 at 20:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max/near/274517435">said</a>:</p>
<blockquote>
<p>well, the correct max will probably just call lanes_lt and select internally, llvm has no separate simd integer max operations.</p>
</blockquote>
<p>That used to be the case, but on trunk they've added them: <a href="https://llvm.org/docs/LangRef.html#llvm-smax-intrinsic">https://llvm.org/docs/LangRef.html#llvm-smax-intrinsic</a></p>



<a name="274602492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274602492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274602492">(Mar 08 2022 at 20:33)</a>:</h4>
<p>ooh, neat!</p>



<a name="274602760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274602760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274602760">(Mar 08 2022 at 20:35)</a>:</h4>
<p>yooo that's on 13.0</p>



<a name="274602912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274602912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274602912">(Mar 08 2022 at 20:36)</a>:</h4>
<p>Oh I think it's on 12 too.</p>



<a name="274604553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274604553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274604553">(Mar 08 2022 at 20:49)</a>:</h4>
<p>it was added here: <a href="https://github.com/llvm/llvm-project/commit/fef0cf081076006887362d6bfcfc306522ce2bd3">https://github.com/llvm/llvm-project/commit/fef0cf081076006887362d6bfcfc306522ce2bd3</a></p>



<a name="274604686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/274604686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#274604686">(Mar 08 2022 at 20:50)</a>:</h4>
<p>they added abs too</p>



<a name="275136848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/275136848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#275136848">(Mar 13 2022 at 06:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="399416">Jorge Leitao</span> has marked this topic as resolved.</p>



<a name="275186069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20incorrect%20max/near/275186069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max.html#275186069">(Mar 14 2022 at 01:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/.E2.9C.94.20incorrect.20max/near/275127773">said</a>:</p>
<blockquote>
<p>I'm just not sure we should be putting this particular state out for public consumption, explaining "sometimes you use <code>lanes_eq</code>, sometimes you use <code>eq</code>" probably isn't going to give anyone much confidence in the implementation</p>
</blockquote>
<p>dunno, makes a lot of sense to me -- these two functions don't even have the same type, so it seems unlikely one would confuse them.<br>
but then it should be <code>lanes_max</code> etc. (in particular it should also be that for float vectors, so this is somewhat orthogonal to <code>Ord</code>.)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>