<html>
<head><meta charset="utf-8"><title>Why is scatter ordered? · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html">Why is scatter ordered?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252775406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252775406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252775406">(Sep 10 2021 at 12:04)</a>:</h4>
<p>I was reading the docs for the pointer scatter operation, and they say that if two writes conflict, the writes are applied in order. Any ideas where this come from? I'd expect that to be UB.</p>



<a name="252775810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252775810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252775810">(Sep 10 2021 at 12:07)</a>:</h4>
<p><a href="https://llvm.org/docs/LangRef.html#llvm-masked-scatter-intrinsics">https://llvm.org/docs/LangRef.html#llvm-masked-scatter-intrinsics</a></p>



<a name="252775853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252775853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252775853">(Sep 10 2021 at 12:07)</a>:</h4>
<p>The LLVM documentation seems to indicate it is ordered</p>



<a name="252782350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252782350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252782350">(Sep 10 2021 at 12:58)</a>:</h4>
<p>Right, but why does the Rust exposure needs to be ordered?</p>



<a name="252782373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252782373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252782373">(Sep 10 2021 at 12:58)</a>:</h4>
<p>Which hardware has an ordered instruction for this ?</p>



<a name="252782501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252782501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252782501">(Sep 10 2021 at 12:59)</a>:</h4>
<p>if you think of each SIMD lane as doing independent operations in parallel, then two parallel writes to some memory without synchronization looks like a data-race to me</p>



<a name="252782656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252782656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252782656">(Sep 10 2021 at 13:00)</a>:</h4>
<p>you can always provide an API on top that adds synchronization to, e.g., perform writes in order to avoid data-races, but you can't build an unsynchronized API on top of a synchronized one</p>



<a name="252782766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252782766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252782766">(Sep 10 2021 at 13:01)</a>:</h4>
<blockquote>
<p>Scatter with overlapping addresses is guaranteed to be ordered from least-significant to most-significant element.</p>
</blockquote>
<p>I think it is only ordered within a single instruction, not between instructions.</p>



<a name="252782923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252782923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252782923">(Sep 10 2021 at 13:02)</a>:</h4>
<p>So two concurrent scatters to the same element would be a data-race, but within a single scatter two writes to the same element have a guaranteed ordering.</p>



<a name="252783208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252783208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252783208">(Sep 10 2021 at 13:04)</a>:</h4>
<p>Yeah, this is just a guarantee if you have duplicate pointers in a single scatter.  It isn't UB, otherwise we couldn't allow it behind a safe interface at all</p>



<a name="252787796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252787796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252787796">(Sep 10 2021 at 13:36)</a>:</h4>
<p>It is not a safe interface since it does (multiple) raw pointer writes.</p>



<a name="252787915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252787915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252787915">(Sep 10 2021 at 13:37)</a>:</h4>
<p>If the rationale is "because llvm.scatter provides this guarantee", then my question turns into two:</p>
<ul>
<li>why does llvm.scatter provide this guarantee?</li>
<li>why does rust has to provide the same guarantee?</li>
</ul>



<a name="252787924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252787924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252787924">(Sep 10 2021 at 13:37)</a>:</h4>
<p>I meant more the interface that operates over a slice</p>



<a name="252789626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252789626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252789626">(Sep 10 2021 at 13:50)</a>:</h4>
<p>Are there architectures where that isn't the case?</p>



<a name="252791992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252791992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252791992">(Sep 10 2021 at 14:04)</a>:</h4>
<p>i don't know any arch with scatters wher that is the case. All gpus come to mind as architectures where scatters race with themselves.</p>



<a name="252794225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252794225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252794225">(Sep 10 2021 at 14:19)</a>:</h4>
<p>arm scatters don't say what happen in this case (i suppose its undefined)</p>



<a name="252794264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252794264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252794264">(Sep 10 2021 at 14:19)</a>:</h4>
<p>AVX scatters are ordered</p>



<a name="252794363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252794363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252794363">(Sep 10 2021 at 14:20)</a>:</h4>
<p>I just looked through the SVE reference and agreed, it doesn't seem to say. Though I am guessing there is an implied behavior based on the memory model</p>



<a name="252794443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252794443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252794443">(Sep 10 2021 at 14:21)</a>:</h4>
<p>I don't know much about GPUs, but I couldn't find an nvptx reference at all</p>



<a name="252794692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252794692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252794692">(Sep 10 2021 at 14:23)</a>:</h4>
<p>Arm loads and stores are always atomic so at worst it would be unspecified, and not UB</p>



<a name="252795167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252795167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252795167">(Sep 10 2021 at 14:26)</a>:</h4>
<blockquote>
<p>AVX scatters are ordered</p>
</blockquote>
<p>Do you have a link to the scatter that you are referring to?</p>
<blockquote>
<p>[..] GPUs</p>
</blockquote>
<p>For amdgpu and nvptx each thread of a group would execute one of the writes of the scatter, so writes from two threads without sync race. IIUC, that's HW UB for amdgpu, but for nvptx data-races are not HW ub (you see one of the writes, but it can be different each time).</p>



<a name="252795290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252795290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252795290">(Sep 10 2021 at 14:27)</a>:</h4>
<blockquote>
<p>Arm loads and stores are always atomic so at worst it would be unspecified, and not UB</p>
</blockquote>
<p>Yes, you could see a different result each time. If we require sequential ordering though, we can't use ARM instructions, and have to lower this to a scalar loop there.</p>



<a name="252795384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252795384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252795384">(Sep 10 2021 at 14:28)</a>:</h4>
<p><a href="https://www.felixcloutier.com/x86/vpscatterdd:vpscatterdq:vpscatterqd:vpscatterqq">https://www.felixcloutier.com/x86/vpscatterdd:vpscatterdq:vpscatterqd:vpscatterqq</a></p>



<a name="252795551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252795551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252795551">(Sep 10 2021 at 14:29)</a>:</h4>
<blockquote>
<p>Only writes to overlapping vector indices are guaranteed to be ordered with respect to each other (from LSB to MSB of the source registers). Note that this also include partially overlapping vector indices. Writes that are not overlapped may happen in any order. Memory ordering with other instructions follows the Intel-64 memory ordering model. Note that this does not account for non-overlapping indices that map into the same physical address locations.</p>
</blockquote>



<a name="252795977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252795977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252795977">(Sep 10 2021 at 14:32)</a>:</h4>
<p>That's indeed ordered.</p>



<a name="252796015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252796015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252796015">(Sep 10 2021 at 14:32)</a>:</h4>
<p><a href="https://software.intel.com/sites/landingpage/IntrinsicsGuide/#text=_mm512_i32extscatter_epi32&amp;expand=3848">https://software.intel.com/sites/landingpage/IntrinsicsGuide/#text=_mm512_i32extscatter_epi32&amp;expand=3848</a></p>
<p>shows the "operational semantics" of this</p>



<a name="252796029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252796029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252796029">(Sep 10 2021 at 14:32)</a>:</h4>
<p>is an ordered loop</p>



<a name="252796458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252796458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252796458">(Sep 10 2021 at 14:35)</a>:</h4>
<p>Reading through the arm memory model, I interpret this as the last value (MSB) will be returned but the processor is allowed to entirely drop the first access</p>



<a name="252796705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252796705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252796705">(Sep 10 2021 at 14:37)</a>:</h4>
<p><a href="https://github.com/riscv/riscv-v-spec/blob/ba75fb7c72160bb6030f126eb476cf575089fc8c/v-spec.adoc#76-vector-indexed-instructions">https://github.com/riscv/riscv-v-spec/blob/ba75fb7c72160bb6030f126eb476cf575089fc8c/v-spec.adoc#76-vector-indexed-instructions</a> RISC-V supports both</p>



<a name="252796851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252796851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252796851">(Sep 10 2021 at 14:38)</a>:</h4>
<blockquote>
<p>The vector indexed load and store memory operations have two forms, ordered and unordered. The indexed-ordered variants preserve element ordering on memory accesses.</p>
<p>For unordered instructions (mop!=11) there is no guarantee on element access order. If the accesses are to a strongly ordered IO region, the element accesses can be initiated in any order.</p>
</blockquote>



<a name="252799549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252799549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252799549">(Sep 10 2021 at 14:56)</a>:</h4>
<p>So the ARM spec says that their writes are ordered in chapter 4 (memory order section).</p>



<a name="252801516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252801516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252801516">(Sep 10 2021 at 15:09)</a>:</h4>
<p>I tend to think that the scatter should be split into an <code>_ordered</code> and an <code>_unordered</code> variant, similar to how RISC-V instructions work</p>



<a name="252801901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252801901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252801901">(Sep 10 2021 at 15:12)</a>:</h4>
<p>So, at least as far as portable-simd is concerned, we're not really interested in supporting every possible configuration (that's what vendor intrinsics are for), but rather the most useful and universal configuration, which does appear to be ordered in this case</p>



<a name="252802027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802027">(Sep 10 2021 at 15:13)</a>:</h4>
<p>unordered is more universal, since it allows more hardware implementations</p>



<a name="252802085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802085">(Sep 10 2021 at 15:13)</a>:</h4>
<p>by definition ordering is more restrictive</p>



<a name="252802311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802311">(Sep 10 2021 at 15:15)</a>:</h4>
<p>from the usefulness point of view, the scatters are masked, so I don't see what's the point of requiring an order</p>



<a name="252802351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802351">(Sep 10 2021 at 15:15)</a>:</h4>
<p>if you have multiple writes to the same location, the mask allows you to specify which one you want to "happen"</p>



<a name="252802557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802557">(Sep 10 2021 at 15:17)</a>:</h4>
<p>At least in what's currently supported by LLVM, it seems they're pretty much equivalently universal</p>



<a name="252802599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802599">(Sep 10 2021 at 15:17)</a>:</h4>
<p>what do you mean by universal ?</p>



<a name="252802615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802615">(Sep 10 2021 at 15:17)</a>:</h4>
<p>Not having a guaranteed ordering prevents the safe implementation we already have: <a href="https://rust-lang.github.io/portable-simd/core_simd/struct.Simd.html#method.scatter">https://rust-lang.github.io/portable-simd/core_simd/struct.Simd.html#method.scatter</a></p>



<a name="252802641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802641">(Sep 10 2021 at 15:17)</a>:</h4>
<p>why?</p>



<a name="252802788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802788">(Sep 10 2021 at 15:18)</a>:</h4>
<p>Well, it wouldn't prevent it, but it would make it useless because you would need to check that there are no duplicate indices</p>



<a name="252802809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802809">(Sep 10 2021 at 15:18)</a>:</h4>
<p>??</p>



<a name="252802828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802828">(Sep 10 2021 at 15:18)</a>:</h4>
<p>this is safe <code>array[random()] = 42;</code></p>



<a name="252802868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802868">(Sep 10 2021 at 15:19)</a>:</h4>
<p>if you do multiple writes from a single thread to the location, in a random order, that's safe</p>



<a name="252802934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252802934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252802934">(Sep 10 2021 at 15:19)</a>:</h4>
<p>is there an RFC discussion of the rationale of the scatter semantics ?</p>



<a name="252803140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803140">(Sep 10 2021 at 15:21)</a>:</h4>
<p>i think the only way for the unordered constraint to impact safety would be if, from a memory model perspective, we say that SIMD operations fork the thread into number of lanes threads, perform a small program, and then join them back</p>



<a name="252803190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803190">(Sep 10 2021 at 15:21)</a>:</h4>
<p>its not clear to me that we want to do this</p>



<a name="252803264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803264">(Sep 10 2021 at 15:22)</a>:</h4>
<p>but even then, we can just say that the writes are atomic relaxed, and get a safe API for scatter</p>



<a name="252803303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803303">(Sep 10 2021 at 15:22)</a>:</h4>
<p>Do you mean an LLVM RFC?</p>



<a name="252803330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803330">(Sep 10 2021 at 15:22)</a>:</h4>
<p>We have not produced the portable simd RFC yet</p>



<a name="252803346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803346">(Sep 10 2021 at 15:22)</a>:</h4>
<p>i mean a rust rfc explaining why these semantics were given to the scatter intrinsics</p>



<a name="252803380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803380">(Sep 10 2021 at 15:22)</a>:</h4>
<p>or any document that explains why from all possible options, this option was picked</p>



<a name="252803425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803425">(Sep 10 2021 at 15:23)</a>:</h4>
<p>Well, a simple answer is that it's the only thing available in our backend.</p>



<a name="252803602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803602">(Sep 10 2021 at 15:24)</a>:</h4>
<p>our backend also supports generating unordered intrinsics for riscv by calling the corresponding arch-specific version there</p>



<a name="252803693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803693">(Sep 10 2021 at 15:25)</a>:</h4>
<p>anyways i don't have anything else to say about this, good luck</p>



<a name="252803707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803707">(Sep 10 2021 at 15:25)</a>:</h4>
<p>you have clarified my question about why you want to expose it like this</p>



<a name="252803717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803717">(Sep 10 2021 at 15:25)</a>:</h4>
<p>Yes, and that's what vendor intrinsics are for, but there is no corresponding generic instruction</p>



<a name="252803776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803776">(Sep 10 2021 at 15:26)</a>:</h4>
<p>so?</p>



<a name="252803825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803825">(Sep 10 2021 at 15:26)</a>:</h4>
<p>there were not electric cars 20 years ago therefore electric cars should not be pursued</p>



<a name="252803876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803876">(Sep 10 2021 at 15:26)</a>:</h4>
<p>if that's your only rationale, it's illogical</p>



<a name="252803974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252803974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252803974">(Sep 10 2021 at 15:27)</a>:</h4>
<p>repeating the argument does not make it better</p>



<a name="252804294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252804294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252804294">(Sep 10 2021 at 15:30)</a>:</h4>
<p>Well, if someone wants to add unordered scatter/gather to LLVM we may choose to expose that instead, but until then we are all volunteers, and only some of us write C++ and I'd hazard none of us have the bandwidth to contribute something like that to LLVM, so it's really outside of the scope of this project group.</p>



<a name="252808878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252808878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252808878">(Sep 10 2021 at 15:59)</a>:</h4>
<p>We can also just not expose scatter if we can't explain why we expose it this way.</p>



<a name="252809053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252809053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252809053">(Sep 10 2021 at 16:00)</a>:</h4>
<p>But "this is how it works in LLVM" is just like "this is how it works in C", and there are many things that we do very differently than C for good reason.</p>



<a name="252809511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252809511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252809511">(Sep 10 2021 at 16:03)</a>:</h4>
<p>I find the operation useful, and if the only issue is that we don't know whether it should be ordered or unordered, we can just say its unordered, and we can always make it ordered later (that's a forward compatible change).</p>



<a name="252809546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252809546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252809546">(Sep 10 2021 at 16:03)</a>:</h4>
<p>i think both operations are different and both make sense</p>



<a name="252810046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252810046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252810046">(Sep 10 2021 at 16:07)</a>:</h4>
<p>Well, LLVM is our backend, so that's a very good reason to do what LLVM does.    We don't have any other choice.</p>



<a name="252810051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252810051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252810051">(Sep 10 2021 at 16:07)</a>:</h4>
<p>I would assume that the unordered variant has LLVM level UB when an index is used more than once. In this case the safe scatter version has to be ordered.</p>



<a name="252821094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252821094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Henrik Lievonen <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252821094">(Sep 10 2021 at 17:28)</a>:</h4>
<p>Could the order of the scatter be documented as "unspecified", somewhat similarly as <a href="https://doc.rust-lang.org/std/primitive.slice.html#method.binary_search"><code>binary_search</code></a> documents "The index is chosen deterministically, but is subject to change in future versions of Rust."? On the platforms where it is cheap to do ordered scatter, this would be according to the documentation, and on the platforms where the order is undefined, but not UB, this would also be according to the documentation? Even if LLVM doesn't support this currently, it might in the future, and if Rust uses it in this way, LLVM developers might be tempted to declare their operation as "unspecified" instead of UB if they ever rework their scatter intrinsics. And in the meanwhile, it would be perfectly fine to just compile to the ordered variant.</p>



<a name="252827210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252827210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252827210">(Sep 10 2021 at 18:13)</a>:</h4>
<p>Unspecified seems fine at first glance, since the important thing is really just having a strict order.  Not sure this addresses the original concern, but it may be something we want to change.</p>



<a name="252859129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859129">(Sep 10 2021 at 22:27)</a>:</h4>
<blockquote>
<p>We don't have any other choice.</p>
</blockquote>
<p>Of course we have.</p>



<a name="252859224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859224">(Sep 10 2021 at 22:28)</a>:</h4>
<p>You seem to claim that LLVM is immutable, immodifiable, out of reach, only for .... gods?</p>



<a name="252859257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859257">(Sep 10 2021 at 22:28)</a>:</h4>
<p>Yet... dozens of diffs are merged per day.</p>



<a name="252859282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859282">(Sep 10 2021 at 22:28)</a>:</h4>
<p>Written by people, the same people that added <code>llvm.masked.scatter</code>, when there was none.</p>



<a name="252859317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859317">(Sep 10 2021 at 22:29)</a>:</h4>
<p>And the same people that added all the portable simd intrinsics to llvm, where there only used to be arch specific ones.</p>



<a name="252859332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859332">(Sep 10 2021 at 22:29)</a>:</h4>
<p>What you seem to try to say is that "for you" there is no other choice.</p>



<a name="252859343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859343">(Sep 10 2021 at 22:29)</a>:</h4>
<p>But somehow you are extrapolating that to Rust.</p>



<a name="252859410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859410">(Sep 10 2021 at 22:30)</a>:</h4>
<p>Please stop doing that.</p>



<a name="252859457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859457">(Sep 10 2021 at 22:31)</a>:</h4>
<p>LLVM has tousands of bugs open and hundreds of things that make no sense.</p>



<a name="252859476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859476">(Sep 10 2021 at 22:31)</a>:</h4>
<p>The question is what semantics make sense for Rust here, and whether it makes sense to expose two semantics, or one.</p>



<a name="252859581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859581">(Sep 10 2021 at 22:32)</a>:</h4>
<p>Whatever LLVM does or doesn't do, particularly for something like scatter which is ~100 LOC of C++... doesn't matter much. If we need an unordered scatter in LLVM we can just add it, or add an "order" argument to the scatter intrinsic, or... many other things.</p>



<a name="252859621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859621">(Sep 10 2021 at 22:33)</a>:</h4>
<blockquote>
<p>I would assume that the unordered variant has LLVM level UB when an index is used more than once. In this case the safe scatter version has to be ordered.</p>
</blockquote>
<p>Why?</p>



<a name="252859668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252859668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252859668">(Sep 10 2021 at 22:33)</a>:</h4>
<p>say I have a "vector" a[N] with N elements and a pointer to the memory <code>ptr</code>, and do <code>*ptr = a[random(0, N)]</code></p>



<a name="252860130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860130">(Sep 10 2021 at 22:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="409057">hannahE2</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F/near/252859621">said</a>:</p>
<blockquote>
<blockquote>
<p>I would assume that the unordered variant has LLVM level UB when an index is used more than once. In this case the safe scatter version has to be ordered.</p>
</blockquote>
<p>Why?</p>
</blockquote>
<p>I think what this means is that if <code>llvm.scatter.unordered</code> has LLVM level UB, then it can't be used by Rust's unordered scatter operation, even if Rust specifies that the choice is arbitrary / unspecified (but still safe)</p>



<a name="252860215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860215">(Sep 10 2021 at 22:40)</a>:</h4>
<p>i'm out of this discussion</p>



<a name="252860222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860222">(Sep 10 2021 at 22:40)</a>:</h4>
<p>If you have the time to make the changes to LLVM I'd be happy to review the subsequent changes to core_simd.  It would be nice if our implementation could be constrained only by what we want Rust to be, but every technical decision since the inception of this project group has been constrained by the fact that we are only a few people donating our time, and we would like this project to be complete before the obsoletion of Rust as a language, which involves some conpromises.</p>



<a name="252860274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860274">(Sep 10 2021 at 22:40)</a>:</h4>
<p>if you don't have time to work on this, that's ok</p>



<a name="252860322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860322">(Sep 10 2021 at 22:41)</a>:</h4>
<p>I'm still open to the idea of an unordered scatter, but there doesn't seem to be a critical difference between the two, particularly because I haven't yet seen a technical specification for an architecture that only has unordered scatters.</p>



<a name="252860375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860375">(Sep 10 2021 at 22:42)</a>:</h4>
<p>i'm not going to continue this discussion</p>



<a name="252860377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860377">(Sep 10 2021 at 22:42)</a>:</h4>
<p>I agree with the general sentiment that one shouldn't feel too constrained to make the API exactly match LLVM, even if that means there is some mismatch or slowness as a result. An API mistake is much harder to roll back after the fact than a performance issue</p>



<a name="252860400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860400">(Sep 10 2021 at 22:42)</a>:</h4>
<p>it makes me super uncofortable that you want to ship something that you don't have time to ship</p>



<a name="252860428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860428">(Sep 10 2021 at 22:43)</a>:</h4>
<p>and also how you extrapolate from you to me</p>



<a name="252860450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860450">(Sep 10 2021 at 22:43)</a>:</h4>
<p>i wanted to have a discussion about why the semantics for scatter in rust</p>



<a name="252860540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860540">(Sep 10 2021 at 22:44)</a>:</h4>
<p>and what semantics make sense</p>



<a name="252860661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860661">(Sep 10 2021 at 22:45)</a>:</h4>
<p>"most platforms supply or can guarantee ordered scatter" seems like a good reason to prioritize it. The most logical spec for unordered scatter involves UB, so it's not an option for rust without <code>unsafe</code>. The second most logical spec for unordered scatter (unspecified clobbering) might be useful but there is apparently not much demand for it</p>



<a name="252860752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860752">(Sep 10 2021 at 22:46)</a>:</h4>
<p>which scatter apis are safe?</p>



<a name="252860761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860761">(Sep 10 2021 at 22:47)</a>:</h4>
<p>Regarding semantics, the only technical spec with unordered semantics I have seen is the RISC-V scatter, which would be inappropriate for the current interface that we have due to not checking for duplicate indices</p>



<a name="252860770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860770">(Sep 10 2021 at 22:47)</a>:</h4>
<p>its <code>simd&lt;T*&gt;::write_to_slice</code></p>



<a name="252860805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860805">(Sep 10 2021 at 22:47)</a>:</h4>
<blockquote>
<p>Not having a guaranteed ordering prevents the safe implementation we already have: <a href="https://rust-lang.github.io/portable-simd/core_simd/struct.Simd.html#method.scatter">https://rust-lang.github.io/portable-simd/core_simd/struct.Simd.html#method.scatter</a></p>
</blockquote>



<a name="252860811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860811">(Sep 10 2021 at 22:47)</a>:</h4>
<p>From an earlier message</p>



<a name="252860969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252860969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252860969">(Sep 10 2021 at 22:49)</a>:</h4>
<p>The lowest effort way to address this issue is to add <code>scatter_unordered</code> as a synonym of <code>scatter</code> with a weaker API promise</p>



<a name="252861036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861036">(Sep 10 2021 at 22:50)</a>:</h4>
<p>and then ask LLVM kindly to add another intrinsic</p>



<a name="252861053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861053">(Sep 10 2021 at 22:50)</a>:</h4>
<p>that's going to have to do two reductions of the offsets, and then compare the slice bounds</p>



<a name="252861075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861075">(Sep 10 2021 at 22:50)</a>:</h4>
<p>This is the initial portable scatter that we have decided on after much discussion on the topic (somewhere else in this channel).  Different architectures handle the arguments, particularly the offsets/pointers, fairly differently (particularly x86).</p>



<a name="252861152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861152">(Sep 10 2021 at 22:51)</a>:</h4>
<p><span class="user-mention" data-user-id="312331">@Caleb Zulawski</span> Do you know if <code>scatter_unordered</code> as proposed would be able to get any immediate benefits over <code>scatter</code> on some platforms in the current implementation?</p>



<a name="252861231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861231">(Sep 10 2021 at 22:52)</a>:</h4>
<p>What's the % of the theoretical peak perf of x86 that this scatter achieves ?</p>



<a name="252861265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861265">(Sep 10 2021 at 22:53)</a>:</h4>
<p>On x86 I imagine there would be no benefit since the intrinsic is ordered</p>



<a name="252861285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861285">(Sep 10 2021 at 22:53)</a>:</h4>
<p>not really, the x86 hardware does the ordering in the load-store unit</p>



<a name="252861299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861299">(Sep 10 2021 at 22:53)</a>:</h4>
<p>Considering all architectures I am aware of support ordered scatter, no I am not aware of any performance difference.  Arm and x86 are already free to reorder the non-overlapping memory access</p>



<a name="252861305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861305">(Sep 10 2021 at 22:53)</a>:</h4>
<p>so it basically sends all writes "combined" and the LSU just cancels the las</p>



<a name="252861380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861380">(Sep 10 2021 at 22:54)</a>:</h4>
<p>is there an example of this on godbolt? one can run MCA there and compare with the raw scatter instruction</p>



<a name="252861392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861392">(Sep 10 2021 at 22:54)</a>:</h4>
<p>without the masking, the compare, the wrapping adds, etc.</p>



<a name="252861459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861459">(Sep 10 2021 at 22:55)</a>:</h4>
<p>I'm not sure what you mean by without all of that--in that case it maps directly to a single scatter instruction</p>



<a name="252861507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861507">(Sep 10 2021 at 22:56)</a>:</h4>
<p>right</p>



<a name="252861540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861540">(Sep 10 2021 at 22:56)</a>:</h4>
<p>when I want to do a scatter, I already know that the indices are in bounds, don't need the length mask, etc.</p>



<a name="252861602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861602">(Sep 10 2021 at 22:57)</a>:</h4>
<p>the library i'm using has a different unsafe write scatter which is what i've been using until now and works quite well</p>



<a name="252861685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861685">(Sep 10 2021 at 22:58)</a>:</h4>
<p>Well, our API does not support vectors-of-pointers yet, so for now you would at a minimum have the offsets converted to pointers still</p>



<a name="252861706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861706">(Sep 10 2021 at 22:58)</a>:</h4>
<p><a href="https://rust-lang.github.io/packed_simd/packed_simd_2/type.mptrx8.html#method.write">https://rust-lang.github.io/packed_simd/packed_simd_2/type.mptrx8.html#method.write</a> that's the one i'm using</p>



<a name="252861743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861743">(Sep 10 2021 at 22:59)</a>:</h4>
<p>i found vectors of pointers odd to be honest, i prefer the offsets that your API uses with a base address</p>



<a name="252861760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861760">(Sep 10 2021 at 22:59)</a>:</h4>
<p>or at least, for my use cases, i always splat the vector of pointers anyways</p>



<a name="252861898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861898">(Sep 10 2021 at 23:00)</a>:</h4>
<p>this api is already unsafe, so i don't understand what value it being ordered adds</p>



<a name="252861951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861951">(Sep 10 2021 at 23:00)</a>:</h4>
<p>i also don't understand why your api would become unsafe if it was unordered</p>



<a name="252861983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252861983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252861983">(Sep 10 2021 at 23:00)</a>:</h4>
<p>we have lots of unordered safe apis in rust</p>



<a name="252862193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252862193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252862193">(Sep 10 2021 at 23:03)</a>:</h4>
<p>Such as?</p>



<a name="252862274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252862274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252862274">(Sep 10 2021 at 23:04)</a>:</h4>
<p>It would depend on the semantics of the LLVM intrinsic and the underlying instructions, but writing to the same pointer twice would likely be UB</p>



<a name="252897287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252897287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252897287">(Sep 11 2021 at 09:43)</a>:</h4>
<p>on HW that doesn't guarantee ordering, each pointer write probably is pessimized. :D</p>



<a name="252897471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252897471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252897471">(Sep 11 2021 at 09:46)</a>:</h4>
<p>packed_simd's version is functionally the same API and lowers to the same things, it is just capable of issuing erroneous writes to out-of-range indices. We just formally documented that here. There is no difference.</p>



<a name="252897866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252897866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252897866">(Sep 11 2021 at 09:54)</a>:</h4>
<p>If you are happy with the packed_simd version, and you typically just want to write to the same slice, then you will basically get all benefits, no drawbacks, here. Remember, the writes are <strong>only</strong> "ordered" with respect to the ones that would touch the same index. All others are allowed to race.</p>



<a name="252899397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/252899397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#252899397">(Sep 11 2021 at 10:22)</a>:</h4>
<p>We likely will offer a more packed_simd-like interface at some point that lets you do maximal monstrosity to memory safety with all the limiters off and not even the guarantees the current packed_simd or portable-simd interfaces do, but we would want even the rough draft of that API to be better designed than we currently have bandwidth for.</p>



<a name="253222575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253222575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253222575">(Sep 14 2021 at 09:32)</a>:</h4>
<blockquote>
<p>It would depend on the semantics of the LLVM intrinsic and the underlying instructions, but writing to the same pointer twice would likely be UB</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>let ptr: *mut i32 = ...;
unsafe {
    ptr.write(42);
    ptr.write(13);
}
</code></pre></div>
<p>That snippet contains two writes to a pointer. How is the behavior of that undefined?</p>



<a name="253222852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253222852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253222852">(Sep 14 2021 at 09:35)</a>:</h4>
<p>This snippet contains two unordered writes to a ptr:</p>
<div class="codehilite"><pre><span></span><code>let ptr: *mut i32 = ...;
let perm = [13, 42].random_permutation();
unsafe {
    ptr.write(perm.next().unwrap());  // 13 or 42
    ptr.write(perm.next().uwnrap());  // the other one
}
</code></pre></div>
<p>How is the behavior of this undefined?</p>



<a name="253225143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253225143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253225143">(Sep 14 2021 at 09:59)</a>:</h4>
<p>In case of an unordered write, it may happen that two such unordered writes use a different order. If LLVM duplicates such a write (which it may for normal writes if it can prove that no other thread can access it due to data races being UB), this would cause UB.</p>



<a name="253225597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253225597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253225597">(Sep 14 2021 at 10:02)</a>:</h4>
<p>Say LLVM transforms the following pseudo code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">write_unordered</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">flag2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">flag2</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">unreachable</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>into</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">write_unordered</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="n">write_unordered</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">flag2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">flag2</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">unreachable</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><code>unreachable()</code> may suddenly become reachable.</p>



<a name="253291588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253291588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253291588">(Sep 14 2021 at 17:38)</a>:</h4>
<p>For genuinely unordered writes, LLVM is allowed to sequence them however it sees fit.</p>



<a name="253291638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253291638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253291638">(Sep 14 2021 at 17:38)</a>:</h4>
<p>Because that's the definition of an unordered write.</p>



<a name="253294333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253294333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253294333">(Sep 14 2021 at 17:57)</a>:</h4>
<p>a scatter can fault in a way that causes it to write zero times to a given memory location while writing to other locations. this means that the assumption you give, that all writes happen, is incorrect on a material hardware level. thus, the ordering of writes is somewhat important.</p>



<a name="253294851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253294851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253294851">(Sep 14 2021 at 18:00)</a>:</h4>
<p>So on top of what bjorn has shown: in the presence of a truly undefined order and possible faults that interrupt the scatter, a valid interpretation of multiple writes to a given pointer would be to write zero times.</p>



<a name="253298437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253298437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253298437">(Sep 14 2021 at 18:21)</a>:</h4>
<p>umm, if a scatter store faults, isn't that a SIGSEGV? why would llvm's semantics have to take out-of-bounds stores into account (I'm assuming the only way to cause a SIGSEGV ignoring alignment)? or can it fault from an in-bounds store?</p>



<a name="253298922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253298922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253298922">(Sep 14 2021 at 18:24)</a>:</h4>
<p>You could fault by accessing protected memory, too</p>



<a name="253299034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253299034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253299034">(Sep 14 2021 at 18:25)</a>:</h4>
<p>if it's protected, it's kinda by-definition out-of-bounds</p>



<a name="253299295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253299295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253299295">(Sep 14 2021 at 18:26)</a>:</h4>
<p>The benefit of ordering is for example if your vector is larger than a hardware vector</p>



<a name="253299304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253299304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253299304">(Sep 14 2021 at 18:26)</a>:</h4>
<p>also, I didn't see an unordered scatter intrinsic in llvm's LangRef</p>



<a name="253299368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253299368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253299368">(Sep 14 2021 at 18:27)</a>:</h4>
<p>It can change instruction scheduling if it knows it's ordered</p>



<a name="253299423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253299423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253299423">(Sep 14 2021 at 18:27)</a>:</h4>
<p>Yeah, there is none, which is my point as to why that's not something we're probably going to address</p>



<a name="253300034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253300034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253300034">(Sep 14 2021 at 18:31)</a>:</h4>
<p>I guess I wasn't paying too much attention, but I understood Jubilee to be making the argument that unordered scatters were necessary (they are useful, but not necessary imho), and that they could be UB if executed twice where the original code only ran once (llvm does know how to avoid duplicating stuff like that imho)</p>



<a name="253302645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253302645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253302645">(Sep 14 2021 at 18:48)</a>:</h4>
<blockquote>
<p>I guess I wasn't paying too much attention, but I understood Jubilee to be making the argument that unordered scatters were necessary (they are useful, but not necessary imho), <br>
I was not.</p>
</blockquote>



<a name="253302797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253302797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253302797">(Sep 14 2021 at 18:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F/near/253298437">said</a>:</p>
<blockquote>
<p>umm, if a scatter store faults, isn't that a SIGSEGV? why would llvm's semantics have to take out-of-bounds stores into account (I'm assuming the only way to cause a SIGSEGV ignoring alignment)? or can it fault from an in-bounds store?</p>
</blockquote>
<p>Scatters are allowed to suppress normal fault behavior. You may now begin screaming.</p>



<a name="253303121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253303121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253303121">(Sep 14 2021 at 18:51)</a>:</h4>
<p>By suppress, do you mean it can fault before retiring the entire instruction?</p>



<a name="253303457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253303457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253303457">(Sep 14 2021 at 18:53)</a>:</h4>
<p>I mean that the OS does not terminate the program.</p>



<a name="253303615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253303615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253303615">(Sep 14 2021 at 18:54)</a>:</h4>
<p>It can entirely suppress the signal???</p>



<a name="253303824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253303824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253303824">(Sep 14 2021 at 18:56)</a>:</h4>
<p>well, normal stores are also technically allowed to not terminate the program by installing a handler on SIGSEGV, that's how a JVM usually produces a NullReferenceException (or whatever that's called)</p>



<a name="253304003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253304003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253304003">(Sep 14 2021 at 18:57)</a>:</h4>
<p>The instruction itself basically winks at the OS and says "you see that fault? no I didn't."<br>
And then it pretends the attempt to write did not happen.</p>



<a name="253304162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253304162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253304162">(Sep 14 2021 at 18:58)</a>:</h4>
<p>i heard that can happen for vector loads on RVV and SVE, didn't know it could happen on stores</p>



<a name="253304232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253304232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253304232">(Sep 14 2021 at 18:58)</a>:</h4>
<p>which instruction?</p>



<a name="253304421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253304421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253304421">(Sep 14 2021 at 18:59)</a>:</h4>
<p>as I understand it, all the EVEX (AVX512) scatter/gathers.</p>



<a name="253305159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253305159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253305159">(Sep 14 2021 at 19:03)</a>:</h4>
<p>looking at: <a href="https://www.felixcloutier.com/x86/vpscatterdd:vpscatterdq:vpscatterqd:vpscatterqq">https://www.felixcloutier.com/x86/vpscatterdd:vpscatterdq:vpscatterqd:vpscatterqq</a></p>



<a name="253305648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253305648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253305648">(Sep 14 2021 at 19:06)</a>:</h4>
<p>from what I understand, in x86 lingo, a fault and an exception both cause an interrupt to OS, the OS can either send a signal/abort, or handle it as a transparent page fault (the instruction will resume storing after the OS finishes, eventually all stores will be completed)</p>



<a name="253305783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253305783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253305783">(Sep 14 2021 at 19:07)</a>:</h4>
<p>the mere fact that llvm uses x86 scatter stores when compiling llvm's ordered scatter means it must not have that crazy store-skipping behavior</p>



<a name="253306943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253306943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253306943">(Sep 14 2021 at 19:15)</a>:</h4>
<p><a href="https://llvm.godbolt.org/z/6Pb6xnEf5">https://llvm.godbolt.org/z/6Pb6xnEf5</a></p>



<a name="253307008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253307008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253307008">(Sep 14 2021 at 19:16)</a>:</h4>
<p>A fault is a kind of exception together with trap and abort.</p>
<p><a href="https://wiki.osdev.org/Exceptions">https://wiki.osdev.org/Exceptions</a></p>
<blockquote>
<p>Exceptions are classified as:</p>
<ul>
<li>Faults: These can be corrected and the program may continue as if nothing happened.</li>
<li>Traps: Traps are reported immediately after the execution of the trapping instruction.</li>
<li>Aborts: Some severe unrecoverable error.</li>
</ul>
</blockquote>
<p>Basically a fault resumes at the same instruction, a trap at the next instruction and an abort is a hardware or OS problem and the instruction pointer may often point anywhere.</p>



<a name="253309079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253309079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253309079">(Sep 14 2021 at 19:28)</a>:</h4>
<p>my point is they all go to the OS, and the OS (if it doesn't divert control-flow/abort) will resume the scatter store where it left off, such that when the scatter store completes, all elements will have been stored successfully to memory</p>



<a name="253311395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253311395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253311395">(Sep 14 2021 at 19:40)</a>:</h4>
<p>It has been a bit since I read this insane detail of the architecture, but my understanding is that the entire "thing" is here:</p>
<blockquote>
<p>Faults are delivered in a right-to-left manner. That is, if a fault is triggered by an element and delivered, all elements closer to the LSB of the destination ZMM will be completed (and non-faulting). Individual elements closer to the MSB <strong>may or may not</strong> be completed.</p>
</blockquote>



<a name="253311556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253311556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253311556">(Sep 14 2021 at 19:41)</a>:</h4>
<p>That is, it is valid for the architecture to continue writing to all valid addresses and only issue the faults after completing all viable writes.</p>



<a name="253312217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253312217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253312217">(Sep 14 2021 at 19:46)</a>:</h4>
<p>This is what I mean by pretending it didn't happen. <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span> <br>
This... probably doesn't explode anything, but really this is still very close to "spooky action at a distance".</p>
<p>And at the end of the day, no one is buying me a sufficiently large bottle of painkillers to work through all the ramifications of even an unrestricted version of the EVEX scatters yet.</p>



<a name="253312583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253312583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253312583">(Sep 14 2021 at 19:49)</a>:</h4>
<p>those elements closer to the msb if completed will clear their corresponding mask bit, leaving the incompleted elements to store again when the OS resumes the instruction. no elements end up getting skipped completely</p>



<a name="253312642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253312642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253312642">(Sep 14 2021 at 19:49)</a>:</h4>
<p>Right.</p>



<a name="253312649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253312649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253312649">(Sep 14 2021 at 19:49)</a>:</h4>
<p>so, it isn't always ordered</p>



<a name="253312675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253312675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253312675">(Sep 14 2021 at 19:49)</a>:</h4>
<p>but doesn't skip elements</p>



<a name="253312803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253312803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253312803">(Sep 14 2021 at 19:50)</a>:</h4>
<p>But it has to not write an element to the same location before handling a fault.</p>



<a name="253312840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253312840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253312840">(Sep 14 2021 at 19:50)</a>:</h4>
<p>I have no idea why one write would fault and not the second.</p>



<a name="253312886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253312886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253312886">(Sep 14 2021 at 19:51)</a>:</h4>
<p>I am just assuming that in the wild, wooly world of Turing machines, it's possible.</p>



<a name="253312946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253312946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253312946">(Sep 14 2021 at 19:51)</a>:</h4>
<p>Possibly the fault handler itself changes machine state enough to legalize the second write.</p>



<a name="253312980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253312980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253312980">(Sep 14 2021 at 19:51)</a>:</h4>
<p>because the OS changed the page tables when it handled the fault...that's how a page fault works</p>



<a name="253313210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253313210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253313210">(Sep 14 2021 at 19:52)</a>:</h4>
<p>so, i guess technically x86 scatters aren't a correct compilation of llvm scatters because they're not always ordered</p>



<a name="253313283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253313283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253313283">(Sep 14 2021 at 19:53)</a>:</h4>
<p>I think they are "as-if" valid.</p>



<a name="253313295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253313295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253313295">(Sep 14 2021 at 19:53)</a>:</h4>
<p>unless i missed something in the x86 docs</p>



<a name="253313438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253313438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253313438">(Sep 14 2021 at 19:54)</a>:</h4>
<p>Like, as I understand it, basically the ordering guarantees are JUST strict enough to validate the LLVM scatter.</p>



<a name="253313542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253313542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253313542">(Sep 14 2021 at 19:54)</a>:</h4>
<p>And that is basically why I don't want to deal with a truly racy unrestricted write yet unless someone is paying me for the therapy bills, at least.</p>



<a name="253313641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253313641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253313641">(Sep 14 2021 at 19:55)</a>:</h4>
<p>ah, in the x86 docs:</p>
<blockquote>
<p>Only writes to overlapping vector indices are guaranteed to be ordered with respect to each other (from LSB to MSB of the source registers). Note that this also include partially overlapping vector indices. Writes that are not overlapped may happen in any order. Memory ordering with other instructions follows the Intel-64 memory ordering model. Note that this does not account for non-overlapping indices that map into the same physical address locations.</p>
</blockquote>



<a name="253313646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253313646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253313646">(Sep 14 2021 at 19:55)</a>:</h4>
<p>I'm an American and not a particularly rich one, I don't have good healthcare like people in so-called "third world communist countries" do!</p>



<a name="253313715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253313715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253313715">(Sep 14 2021 at 19:56)</a>:</h4>
<p>oh, so am I</p>



<a name="253313745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253313745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253313745">(Sep 14 2021 at 19:56)</a>:</h4>
<p>I think we could provide an unsafe pointer interface with the caveat of you're not allowed to do anything that faults</p>



<a name="253313770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253313770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253313770">(Sep 14 2021 at 19:56)</a>:</h4>
<p>Or more like fault at your own risk</p>



<a name="253313994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253313994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253313994">(Sep 14 2021 at 19:58)</a>:</h4>
<p>well, technically page faults are supposed to be program transparent, where the OS can change  any page to fault at any time (swapping out) as long as the program acts like it's there when accessed (swapping back in)</p>



<a name="253314017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253314017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253314017">(Sep 14 2021 at 19:58)</a>:</h4>
<p>I'm pretty sure the slice one could technically fault if you ran out of ram and the slice swapped out</p>



<a name="253314098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253314098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253314098">(Sep 14 2021 at 19:58)</a>:</h4>
<p>Yep</p>



<a name="253314171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253314171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253314171">(Sep 14 2021 at 19:59)</a>:</h4>
<p>Right, I think saying "don't write to the same location twice in our <code>unsafe</code> scatter" is fine.</p>



<a name="253314186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253314186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253314186">(Sep 14 2021 at 19:59)</a>:</h4>
<p>If you can't swap back in youll probably get similarly weird behavior as if you had an access violation</p>



<a name="253314309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253314309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253314309">(Sep 14 2021 at 20:00)</a>:</h4>
<p>I actually think it's probably fine as long as you're not doing anything particularly weird</p>



<a name="253314634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253314634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253314634">(Sep 14 2021 at 20:01)</a>:</h4>
<p>hmm, well I'd say as long as a loop of scalar stores to each pointer in the vector is valid, a ordered scatter should be just as valid, hence a store to a vector of shared references to cells doesn't need to be unsafe</p>



<a name="253314833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253314833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253314833">(Sep 14 2021 at 20:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F/near/253313715">said</a>:</p>
<blockquote>
<p>oh, so am I</p>
</blockquote>
<p>Oh yes I expected as much. I am just emphasizing that we have limited bandwidth and  the cost of even maintaining spicy unordered scatter code is pretty high, nevermind developing it. It's a nontrivial ask.</p>



<a name="253314891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253314891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253314891">(Sep 14 2021 at 20:03)</a>:</h4>
<p>You mean a vector of &amp;mut?  I didn't even consider the possibility of reference vectors <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>



<a name="253314900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253314900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253314900">(Sep 14 2021 at 20:03)</a>:</h4>
<p>That does sound plausible too.</p>



<a name="253315065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315065">(Sep 14 2021 at 20:04)</a>:</h4>
<p>I actually like the idea of an unsafe function on pointer vectors casting it to references</p>



<a name="253315072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315072">(Sep 14 2021 at 20:04)</a>:</h4>
<p>yeah actually.<br>
A bunch of &amp;mut locations should be safe.</p>



<a name="253315118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315118">(Sep 14 2021 at 20:04)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">safe_scatter</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptrs</span>: <span class="nc">Simd</span><span class="o">&lt;&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">Cell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">values</span>: <span class="nc">Simd</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span>: <span class="nc">SimdMask</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ordered_scatter</span><span class="p">(</span><span class="n">ptrs</span><span class="p">.</span><span class="n">to_ptrs</span><span class="p">(),</span><span class="w"> </span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">);</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="253315132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315132">(Sep 14 2021 at 20:04)</a>:</h4>
<p>spicy.</p>



<a name="253315214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315214">(Sep 14 2021 at 20:05)</a>:</h4>
<p>Why cell, and not &amp;mut?</p>



<a name="253315252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315252">(Sep 14 2021 at 20:05)</a>:</h4>
<p>I used a vector of <code>&amp;Cell&lt;T&gt;</code> since that allows duplicates</p>



<a name="253315283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315283">(Sep 14 2021 at 20:05)</a>:</h4>
<p>Oh, like duplicates</p>



<a name="253315286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315286">(Sep 14 2021 at 20:05)</a>:</h4>
<p>Good point</p>



<a name="253315322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315322">(Sep 14 2021 at 20:06)</a>:</h4>
<p>Either would be valid</p>



<a name="253315410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315410">(Sep 14 2021 at 20:06)</a>:</h4>
<p>I feel some strange apis brewing, but I like them</p>



<a name="253315475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315475">(Sep 14 2021 at 20:06)</a>:</h4>
<p>scatter to <code>&amp;mut T</code> allows using scatter unordered, since there won't ever be duplicates</p>



<a name="253315522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315522">(Sep 14 2021 at 20:07)</a>:</h4>
<p>yeah.</p>



<a name="253315732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315732">(Sep 14 2021 at 20:08)</a>:</h4>
<p>vectors + references + lifetimes = awesome superpowers + headache</p>



<a name="253315873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315873">(Sep 14 2021 at 20:09)</a>:</h4>
<p>Now I am imagining scattering to refcells.  Which I think could be done with a sequence of checks followed by two scatters</p>



<a name="253315912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253315912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253315912">(Sep 14 2021 at 20:09)</a>:</h4>
<p>Actually, a gather and then a scatter</p>



<a name="253316275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253316275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253316275">(Sep 14 2021 at 20:12)</a>:</h4>
<p>well...refcells are only useful for non-copy <code>T</code>, all currently supported <code>T</code> are <code>Copy</code> ... though if we add <code>&amp;mut T</code>, that's non-copy.</p>



<a name="253316436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253316436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253316436">(Sep 14 2021 at 20:13)</a>:</h4>
<p>I'd be inclined to require <code>T: Copy</code> and make users use <code>&amp;Cell&lt;T&gt;</code></p>



<a name="253317765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253317765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253317765">(Sep 14 2021 at 20:22)</a>:</h4>
<p>Anyways hannah if you want to have unordered scatters we would probably have to see the documentation for the unordered scatter APIs you are mentioning (again, not the <code>packed_simd</code> one, as it is secretly ordered), and you would probably have to show them to LLVM too because I don't see us doing so hot at supporting something like that when our upstream does not.</p>



<a name="253423880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253423880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253423880">(Sep 15 2021 at 14:31)</a>:</h4>
<blockquote>
<p>umm, if a scatter store faults, isn't that a SIGSEGV?</p>
</blockquote>
<p>No, if that faults, its UB, and LLVM requires the user to make sure it never happens.</p>
<p>AVX-512 hardware says that the writes are ordered, so the first one will fault. But the faulting does not matter from LLVM's point of view because it can never happen in a valid program.</p>



<a name="253424595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253424595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253424595">(Sep 15 2021 at 14:35)</a>:</h4>
<blockquote>
<p>For genuinely unordered writes, LLVM is allowed to sequence them however it sees fit.</p>
</blockquote>
<p>We are talking here about the writes being "unordered" for the scatter instruction. The scatter itself has to happen in coherence order, and there exists a coherence order for the writes within the scatter in the memory model, even if we say that this order can be different each time. </p>
<p>"Truly unordered" is not a thing. Basically, what scatter can say is that it generates a random permutation of writes to the same index, and writes in the order given by that random permutation, but that's pretty much it. LLVM can lower this to whatever is most efficient, and LLVM optimizations only can assume the value written if LLVM lowers the scatter to a hw specific LLVM intrinsic that guarantees the order. Otherwise they can at most assume that one of the values passed will be written, and if they are all the same, well then they can assume that this value was written.</p>



<a name="253424800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253424800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253424800">(Sep 15 2021 at 14:37)</a>:</h4>
<p>I am happy with <code>packed_simd2</code> so that's what I'll continue using.</p>



<a name="253424934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253424934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253424934">(Sep 15 2021 at 14:37)</a>:</h4>
<p>I tried the new APIs on my app but the perf was ~60% slower due to all the stuff the safe scatter API is doing.</p>



<a name="253425084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253425084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253425084">(Sep 15 2021 at 14:38)</a>:</h4>
<p>And there appears to be other issues like way worse instructions being generated for the different shuffles :/</p>



<a name="253425129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253425129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253425129">(Sep 15 2021 at 14:38)</a>:</h4>
<p>But I really don't have time to look into any of this much.</p>



<a name="253425138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253425138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253425138">(Sep 15 2021 at 14:38)</a>:</h4>
<p>Can you explain what the difference is in your usage? That has nothing to do with ordering, packed-simd lowers to the exact same LLVM intrinsic.</p>



<a name="253425208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253425208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253425208">(Sep 15 2021 at 14:39)</a>:</h4>
<p>It is true that we simply haven't gotten around to an entirely unchecked API yet, but we do plan on it.</p>



<a name="253425276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253425276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253425276">(Sep 15 2021 at 14:39)</a>:</h4>
<p>packed-simd doesn't do bounds check, nor masks checks, etc. its a raw pointer write. the new simd api lowers to 3x more hw instructions</p>



<a name="253425459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253425459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253425459">(Sep 15 2021 at 14:40)</a>:</h4>
<p>API-wise, i'd be in general against making Rust do what intel does just because intel implemented llvm.masked.scatter in LLVM upstream</p>



<a name="253425503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253425503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253425503">(Sep 15 2021 at 14:40)</a>:</h4>
<p>i want portable SIMD to work on RISC-V well, and what works there best is the unordered scatter</p>



<a name="253425599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253425599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253425599">(Sep 15 2021 at 14:41)</a>:</h4>
<p>i am fine with providing both versions, ordered and unordered, but someone arguing that the default should be ordered should have an argument about "why is ordered better for applications that will use this API, and which apps, etc."</p>



<a name="253425611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253425611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253425611">(Sep 15 2021 at 14:41)</a>:</h4>
<p>like, "which apps need the ordering"</p>



<a name="253425791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253425791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253425791">(Sep 15 2021 at 14:42)</a>:</h4>
<p>the argument "intel gave llvm.masked.scatter ordered semantics therefore we do so for rust" is weak, i'd rather not have the intrinsic as portable than have it without good motivation</p>



<a name="253426129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253426129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253426129">(Sep 15 2021 at 14:45)</a>:</h4>
<p>The LLVM intrinsic isn't Intel specific, it also matches the SVE ST1 instruction</p>



<a name="253426449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253426449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253426449">(Sep 15 2021 at 14:47)</a>:</h4>
<p>Does the portable simd support SVE?</p>



<a name="253426518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253426518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253426518">(Sep 15 2021 at 14:47)</a>:</h4>
<p>the LLVM intrinsic does not support it</p>



<a name="253426561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253426561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253426561">(Sep 15 2021 at 14:47)</a>:</h4>
<p>(it requires a "packed" SIMD vector, while SVE vectors are "scalable")</p>



<a name="253426708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253426708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253426708">(Sep 15 2021 at 14:48)</a>:</h4>
<p>It would need rustc support, but it would work with the <code>sve-vector-bits</code> option</p>



<a name="253426966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253426966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253426966">(Sep 15 2021 at 14:50)</a>:</h4>
<p>LLVM can absolutely treat SVE vectors as regular sized vectors</p>



<a name="253427736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253427736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253427736">(Sep 15 2021 at 14:54)</a>:</h4>
<p>can you show a godbolt example ?</p>



<a name="253427954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253427954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253427954">(Sep 15 2021 at 14:56)</a>:</h4>
<p>what does <code>mem::size_of::&lt;V&gt;</code> return when <code>V</code> is a scalable vector ?</p>



<a name="253428126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428126">(Sep 15 2021 at 14:57)</a>:</h4>
<p>It would return the value determined by the current target features</p>



<a name="253428146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428146">(Sep 15 2021 at 14:57)</a>:</h4>
<p>?</p>



<a name="253428219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428219">(Sep 15 2021 at 14:58)</a>:</h4>
<p>You embed the SVE vector size in the ABI (or the entire program)</p>



<a name="253428261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428261">(Sep 15 2021 at 14:58)</a>:</h4>
<p>the code must run well on CPU0 with 128-bit SIMD vectors and CPU1 with 1024-bit vectors</p>



<a name="253428326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428326">(Sep 15 2021 at 14:58)</a>:</h4>
<p>if you have to pick 128-bit, then your code will run very poorly on a CPU with 1024-bit vectors</p>



<a name="253428341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428341">(Sep 15 2021 at 14:58)</a>:</h4>
<p>Yes, so you would multiversion the ABI just as you would with regular instruction sets</p>



<a name="253428353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428353">(Sep 15 2021 at 14:58)</a>:</h4>
<p>the whole point of SVE is not having to hardcode the vector length in your program</p>



<a name="253428374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428374">(Sep 15 2021 at 14:58)</a>:</h4>
<p>compile once, run everywhere, reasonably well</p>



<a name="253428562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428562">(Sep 15 2021 at 14:59)</a>:</h4>
<p>like, not having to multiversion the ABI is literally the main and only feature of SVE</p>



<a name="253428714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428714">(Sep 15 2021 at 15:00)</a>:</h4>
<p>when using C I don't have to do that, so I don't see why an API that forces you to do that would be acceptable for Rust</p>



<a name="253428838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428838">(Sep 15 2021 at 15:01)</a>:</h4>
<p>Well, you can write code that way, but then you can't for example pass vectors on the stack</p>



<a name="253428949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253428949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253428949">(Sep 15 2021 at 15:01)</a>:</h4>
<p>can you show a godbolt example of the code that <code>core::simd</code> generates for this ?</p>



<a name="253429069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253429069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253429069">(Sep 15 2021 at 15:02)</a>:</h4>
<p>I already said I believe it still needs rustc support, but LLVM supports it.</p>



<a name="253429092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253429092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253429092">(Sep 15 2021 at 15:02)</a>:</h4>
<p>i'd expect a good api for scalable vectors and the fixed-size vectors to be relatively different</p>



<a name="253429881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253429881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253429881">(Sep 15 2021 at 15:06)</a>:</h4>
<p>If you are looking to use them as unsized types, then you'll have to use the vendor intrinsics whenever those are available</p>



<a name="253429957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253429957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253429957">(Sep 15 2021 at 15:07)</a>:</h4>
<p>An inherent limitation on std::simd being portable is that the vectors are sized</p>



<a name="253429972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253429972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253429972">(Sep 15 2021 at 15:07)</a>:</h4>
<p>the only reason people would use a explicit simd api is perf</p>



<a name="253430020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430020">(Sep 15 2021 at 15:07)</a>:</h4>
<p>better to not support sve, than to support it with horrible perf</p>



<a name="253430208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430208">(Sep 15 2021 at 15:08)</a>:</h4>
<p>The performance would not be horrible? It would likely actually be more performant, since you can pass vectors on the stack, at the cost of a larger binary</p>



<a name="253430277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430277">(Sep 15 2021 at 15:09)</a>:</h4>
<p>if you have to pick 128-bit SVE for portability, perf on a 1024-bit wide SVE unit would be horrible</p>



<a name="253430321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430321">(Sep 15 2021 at 15:09)</a>:</h4>
<p>if that were even possible</p>



<a name="253430359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430359">(Sep 15 2021 at 15:09)</a>:</h4>
<p>Like I said, you would multiversion, just as you need to multiversion for the various Intel vector sizes</p>



<a name="253430386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430386">(Sep 15 2021 at 15:09)</a>:</h4>
<p>but for SVE the vector size is fixed and the user can't change it, so if you have to pick a length at compile time and multi version, your code would only work on that version</p>



<a name="253430450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430450">(Sep 15 2021 at 15:10)</a>:</h4>
<p>because at runtime its value is only controlled by the hardware</p>



<a name="253430496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430496">(Sep 15 2021 at 15:10)</a>:</h4>
<p>so you'd need to multi-version for all powers of 2 in range[128, 4096) which would blow up your binary size</p>



<a name="253430520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430520">(Sep 15 2021 at 15:10)</a>:</h4>
<p>the only problem SVE solves is this one</p>



<a name="253430551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430551">(Sep 15 2021 at 15:10)</a>:</h4>
<p>so might as well just use NEON, which is supported on all SVE hardware</p>



<a name="253430590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430590">(Sep 15 2021 at 15:11)</a>:</h4>
<p>Yes, that is your choice as the user</p>



<a name="253430599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430599">(Sep 15 2021 at 15:11)</a>:</h4>
<p>at least on A64FX you can't pick a vector length different from 512</p>



<a name="253430647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430647">(Sep 15 2021 at 15:11)</a>:</h4>
<p>so if you allow people to generate code for 128-bit using target features, that would have UB at runtime on A64FX</p>



<a name="253430683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430683">(Sep 15 2021 at 15:11)</a>:</h4>
<p>because all hardware instructions will try to read 512-bits from your 128-bit data types</p>



<a name="253430717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430717">(Sep 15 2021 at 15:12)</a>:</h4>
<p>have you ever used SVE?</p>



<a name="253430926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430926">(Sep 15 2021 at 15:13)</a>:</h4>
<p>No, I have not yet encountered a device with it</p>



<a name="253430960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430960">(Sep 15 2021 at 15:13)</a>:</h4>
<p>ok, i'm out of this group now</p>



<a name="253430973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253430973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253430973">(Sep 15 2021 at 15:13)</a>:</h4>
<p>this was all a waste of time</p>



<a name="253431441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253431441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253431441">(Sep 15 2021 at 15:16)</a>:</h4>
<p>Look, like I have said before, we are all volunteers.  We test dozens of architectures--of course I don't own one of each.</p>



<a name="253456564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Why%20is%20scatter%20ordered%3F/near/253456564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Why.20is.20scatter.20ordered.3F.html#253456564">(Sep 15 2021 at 17:39)</a>:</h4>
<p>do note that llvm's <code>llvm.masked.scatter.*</code> intrinsic totally supports scalable vectors: <a href="https://github.com/llvm/llvm-project/blob/3852b8c70fbf5ad55e87ab5ccb0bd2f0a5c65977/llvm/test/CodeGen/RISCV/rvv/mscatter-sdnode.ll">https://github.com/llvm/llvm-project/blob/3852b8c70fbf5ad55e87ab5ccb0bd2f0a5c65977/llvm/test/CodeGen/RISCV/rvv/mscatter-sdnode.ll</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>