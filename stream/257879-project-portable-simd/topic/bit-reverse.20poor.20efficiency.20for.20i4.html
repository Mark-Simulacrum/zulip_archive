<html>
<head><meta charset="utf-8"><title>bit-reverse poor efficiency for i4 · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html">bit-reverse poor efficiency for i4</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275607295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607295">(Mar 17 2022 at 04:51)</a>:</h4>
<p>maybe we should manually code bitreverse in Mask::to_bits? it gets terrible efficiency on anything without a native bitreverse instruction...<br>
<a href="https://llvm.godbolt.org/z/b1TreYWd8">https://llvm.godbolt.org/z/b1TreYWd8</a><br>
llvm needs an intrinsic for grev which fixes this exact problem...grev is kinda any combination of bitreverse, i2 reverse, nibble reverse, byte reverse, i16 reverse, i32 reverse, etc. all rolled into 1 instruction. RISC-V was planning on getting it (it was partially dropped from the v1.0 of bitmanip, leaving only bit and byte reverse instructions); it's also in the instructions Libre-SOC is busy working on adding to OpenPower: <a href="https://libre-soc.org/openpower/sv/bitmanip/">https://libre-soc.org/openpower/sv/bitmanip/</a></p>



<a name="275607373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607373">(Mar 17 2022 at 04:53)</a>:</h4>
<p>Yeah, maybe.  I also think a "to_native_bitmask" function is probably the most useful overall</p>



<a name="275607384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607384">(Mar 17 2022 at 04:53)</a>:</h4>
<p>i'd call it <code>to_ne_bits</code></p>



<a name="275607427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607427">(Mar 17 2022 at 04:54)</a>:</h4>
<p>I think it's questionable to call it endianness</p>



<a name="275607446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607446">(Mar 17 2022 at 04:55)</a>:</h4>
<p>it's bit-endianness?</p>



<a name="275607452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607452">(Mar 17 2022 at 04:55)</a>:</h4>
<p>And I think depending on backend and target it could potentially be stranger than just bit-reversed</p>



<a name="275607564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607564">(Mar 17 2022 at 04:58)</a>:</h4>
<p>well...llvm converts i4 bitreverse to i64 bitreverse (since that's the only legal word size) and a shift, but there's no bitreverse instruction, so it converts the i64 bitreverse to a series of 18(!) shift/and/or  instructions</p>



<a name="275607599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607599">(Mar 17 2022 at 04:59)</a>:</h4>
<p>whereas for i4 bitreverse you only need 6 shift/and/or instructions</p>



<a name="275607616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607616">(Mar 17 2022 at 04:59)</a>:</h4>
<p>Sorry I meant a native bitmask might have any arbitrary layout depending on whatever instructions the target happens to have</p>



<a name="275607759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607759">(Mar 17 2022 at 05:01)</a>:</h4>
<p>Yeah it seems like llvm is not very good at this</p>



<a name="275607829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607829">(Mar 17 2022 at 05:02)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">rev_4</span><span class="p">(</span><span class="n">v</span>: <span class="nc">i4</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">i4</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="mh">0x5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="mh">0xA</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275607830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607830">(Mar 17 2022 at 05:02)</a>:</h4>
<p>What happens if you explicitly clear the unused bits afterwards? One of the passes might remove the dead shuffles then</p>



<a name="275607849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607849">(Mar 17 2022 at 05:03)</a>:</h4>
<p>i explicitly branched before to tell llvm it was 0 &lt;= v &lt; 16, and it still generated a i64 bitreverse</p>



<a name="275607905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607905">(Mar 17 2022 at 05:04)</a>:</h4>
<p>I meant more like bitand afterwards so even if it generates the i64 bit-reverse it can throw out the unused portion</p>



<a name="275607921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275607921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275607921">(Mar 17 2022 at 05:04)</a>:</h4>
<p>also, i miscalculated instruction count...it would be 28 instructions for i64 bitreverse and 8 for i4</p>



<a name="275608038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275608038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275608038">(Mar 17 2022 at 05:07)</a>:</h4>
<p>masking afterwards does nothing: <a href="https://llvm.godbolt.org/z/TPa9hMaMK">https://llvm.godbolt.org/z/TPa9hMaMK</a></p>



<a name="275608079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/bit-reverse%20poor%20efficiency%20for%20i4/near/275608079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/bit-reverse.20poor.20efficiency.20for.20i4.html#275608079">(Mar 17 2022 at 05:08)</a>:</h4>
<p>Unfortunate</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>