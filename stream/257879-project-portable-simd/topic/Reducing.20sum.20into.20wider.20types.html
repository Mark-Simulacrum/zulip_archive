<html>
<head><meta charset="utf-8"><title>Reducing sum into wider types · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html">Reducing sum into wider types</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277545385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277545385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Samuel Shepard <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277545385">(Apr 02 2022 at 18:54)</a>:</h4>
<p>First, very grateful and excited about the work you all are doing. I think it'll be a game changer for those of us in science when it stabilizes.</p>
<p>Anyway, I just started playing with the nightly API and couldn't figure out how to reduce/horizontally add packed u8 into wider packed simd types OR into wider scalars. See an <a href="https://github.com/Daniel-Liu-c0deb0t/triple_accel/blob/e921c1450a78b4d75bce1e81964e9a84bc4ffefa/src/jewel.rs#L2496">example hamming distance implementation</a> where the author (not me!) reduces the packed vector first to a wider packed vector and then  eventually to a scalar.</p>
<p>Sorry if this is type of conversion is something silly and obvious, still starting to digest the awesome work.</p>



<a name="277545398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277545398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277545398">(Apr 02 2022 at 18:55)</a>:</h4>
<p>Hmm.</p>



<a name="277545414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277545414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277545414">(Apr 02 2022 at 18:55)</a>:</h4>
<p>I can only imagine casting to a bigger size and then summing...?</p>



<a name="277546062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Samuel Shepard <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546062">(Apr 02 2022 at 19:07)</a>:</h4>
<p>Is the cast just transmuting? If so, wouldn't it affect the correctness of the sums when you finally did the reduction to scalar? </p>
<p>The trick in this code basically embeds the partial sums as u16 within 2 packed u64 by adding to a zero vector. The max sum of the packed u8 can't be larger than u16 so this is safe in terms of correctness.</p>
<p>I will try the cast and see. Thanks.</p>



<a name="277546073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546073">(Apr 02 2022 at 19:07)</a>:</h4>
<p>the way <code>_mm_sad_epu8</code> works is absolutely nuts and unlikely to become an operation in the <em>portable</em> SIMD API that this part of the standard library is aiming to be.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// approximate rust for `_mm_sad_epu8`</span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0_</span><span class="k">u64</span><span class="p">;</span><span class="w"></span>

<span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">8</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">c1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)).</span><span class="n">abs_unsigned</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">8</span><span class="o">..</span><span class="mi">16</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">c2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">((</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)).</span><span class="n">abs_unsigned</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">];</span><span class="w"></span>
</code></pre></div>
<p>However, if you just have a look over in <code>core::arch</code> you'll find the exact function you're looking for.</p>



<a name="277546107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546107">(Apr 02 2022 at 19:08)</a>:</h4>
<blockquote>
<p>Compute the absolute differences of packed unsigned 8-bit integers in a and b, then horizontally sum each consecutive 8 differences to produce two unsigned 16-bit integers, and pack these unsigned 16-bit integers in the low 16 bits of 64-bit elements in dst.</p>
</blockquote>
<p><span aria-label="dizzy" class="emoji emoji-1f635" role="img" title="dizzy">:dizzy:</span></p>



<a name="277546160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546160">(Apr 02 2022 at 19:08)</a>:</h4>
<p>what</p>



<a name="277546173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546173">(Apr 02 2022 at 19:09)</a>:</h4>
<p>yes exactly</p>



<a name="277546308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546308">(Apr 02 2022 at 19:11)</a>:</h4>
<p>dst?</p>



<a name="277546352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546352">(Apr 02 2022 at 19:12)</a>:</h4>
<p>I don't understand what you're asking about</p>



<a name="277546354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546354">(Apr 02 2022 at 19:12)</a>:</h4>
<p>Comm. abbrev. for destination</p>



<a name="277546358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546358">(Apr 02 2022 at 19:12)</a>:</h4>
<p>Ach so. Thanks Jubilee.</p>



<a name="277546361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546361">(Apr 02 2022 at 19:12)</a>:</h4>
<p>but which destination</p>



<a name="277546372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546372">(Apr 02 2022 at 19:12)</a>:</h4>
<p>oh oh! in what scott posted! sorry</p>



<a name="277546385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546385">(Apr 02 2022 at 19:13)</a>:</h4>
<p>yeah what scott posted used <code>monospace</code> for the var names, which didn't paste into markdown properly</p>



<a name="277546392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546392">(Apr 02 2022 at 19:13)</a>:</h4>
<p>Oh yeah, I was just copying from the intel guide</p>



<a name="277546442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Samuel Shepard <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546442">(Apr 02 2022 at 19:14)</a>:</h4>
<p>Thanks for the kind suggestion and code example. The real work is being done in packed u8, so however I can add it up into a scalar without extra cleverness is probably fine.</p>
<p>Thanks again!</p>



<a name="277546457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546457">(Apr 02 2022 at 19:14)</a>:</h4>
<p>More generally, is there support for <code>Simd&lt;u8, N&gt;</code> -&gt; <code>Simd&lt;u16, N&gt;</code> today?  I didn't see anything obvious in the docs.</p>



<a name="277546480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546480">(Apr 02 2022 at 19:15)</a>:</h4>
<p>Yes, <code>.cast::&lt;U&gt;</code></p>



<a name="277546524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546524">(Apr 02 2022 at 19:16)</a>:</h4>
<p><span class="user-mention" data-user-id="480147">@Samuel Shepard</span> note that if you use the <code>core::arch</code> version it will likely be much faster than what I wrote, though you'll need a few unsafe blocks and probably a few transmutes</p>



<a name="277546532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546532">(Apr 02 2022 at 19:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="480147">Samuel Shepard</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277546062">said</a>:</p>
<blockquote>
<p>Is the cast just transmuting? If so, wouldn't it affect the correctness of the sums when you finally did the reduction to scalar? </p>
<p>The trick in this code basically embeds the partial sums as u16 within 2 packed u64 by adding to a zero vector. The max sum of the packed u8 can't be larger than u16 so this is safe in terms of correctness.</p>
<p>I will try the cast and see. Thanks.</p>
</blockquote>
<p>No, <code>fn cast</code> is not a transmutation, it is a conversion that follows the semantics of <code>as</code></p>



<a name="277546562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546562">(Apr 02 2022 at 19:17)</a>:</h4>
<p>For this particular op, i highly doubt llvm will "see what's going on" and optimize to this specific intrinsic on its own</p>



<a name="277546565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546565">(Apr 02 2022 at 19:17)</a>:</h4>
<p>Might not need transmutes, since there are all the <code>From</code>s like <a href="https://doc.rust-lang.org/nightly/core/simd/struct.Simd.html#impl-From%3CSimd%3Ci8%2C%2032_usize%3E%3E">https://doc.rust-lang.org/nightly/core/simd/struct.Simd.html#impl-From%3CSimd%3Ci8%2C%2032_usize%3E%3E</a></p>



<a name="277546606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546606">(Apr 02 2022 at 19:18)</a>:</h4>
<p>agreed, I didn't quite process the initial question.</p>



<a name="277546648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546648">(Apr 02 2022 at 19:19)</a>:</h4>
<p>I'm checking my own knowledge of that algo:<br>
You load 4 chars of u8s at a time from <code>a</code> and <code>b</code>,  widen them into i64x4 SIMD vectors, comp them, add the comparison into an accumulation vector, iterate that over the entire array and then <code>reduce_sum</code> at end, right?</p>



<a name="277546708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546708">(Apr 02 2022 at 19:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="480147">Samuel Shepard</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277545385">said</a>:</p>
<blockquote>
<p>Anyway, I just started playing with the nightly API and couldn't figure out how to reduce/horizontally add packed u8 into wider packed simd types OR into wider scalars.</p>
</blockquote>
<p>This looks like it works, for example: <a href="https://rust.godbolt.org/z/Me3T3qWq5">https://rust.godbolt.org/z/Me3T3qWq5</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">wider_reduce</span><span class="p">(</span><span class="n">x</span>: <span class="nc">Simd</span><span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u16</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nc">Simd</span><span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">cast</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">reduce_sum</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Is that the kind of thing you meant?  If not, maybe you can give a function signature?</p>



<a name="277546722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546722">(Apr 02 2022 at 19:21)</a>:</h4>
<p>I think today my brain will let me actually review code.</p>



<a name="277546951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277546951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Samuel Shepard <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277546951">(Apr 02 2022 at 19:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277546708">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="480147">Samuel Shepard</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277545385">said</a>:</p>
<blockquote>
<p>Anyway, I just started playing with the nightly API and couldn't figure out how to reduce/horizontally add packed u8 into wider packed simd types OR into wider scalars.</p>
</blockquote>
<p>This looks like it works, for example: <a href="https://rust.godbolt.org/z/Me3T3qWq5">https://rust.godbolt.org/z/Me3T3qWq5</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">wider_reduce</span><span class="p">(</span><span class="n">x</span>: <span class="nc">Simd</span><span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u16</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nc">Simd</span><span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">cast</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">reduce_sum</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Is that the kind of thing you meant?  If not, maybe you can give a function signature?</p>
</blockquote>
<p>This exactly, yes! Provided the cast does what I'd guess it to given other comments.</p>



<a name="277547026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547026">(Apr 02 2022 at 19:27)</a>:</h4>
<p>Hmmm - this isn’t a bad beginner example either. IDK how much vanilla Rust perf can leave on the table for a decent iter() version.</p>



<a name="277547112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547112">(Apr 02 2022 at 19:29)</a>:</h4>
<p>I am not sure either. I would guess that, while I doubt <code>_mm_sad_epu8</code> will correctly resolve in isel in LLVM, that at least "reduce into a wider type" should consistently optimize correctly using explicit vectorization, it just might choose the "wrong" sum between the... many exotic summation instructions x86 offers.</p>



<a name="277547231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547231">(Apr 02 2022 at 19:31)</a>:</h4>
<p>Ah, it uses punpcklbw for the <code>zext</code>.  Makes sense.</p>



<a name="277547286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547286">(Apr 02 2022 at 19:32)</a>:</h4>
<p>ahhh.</p>



<a name="277547295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547295">(Apr 02 2022 at 19:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="246783">Miguel Raz Guzmán Macedo</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277547026">said</a>:</p>
<blockquote>
<p>Hmmm - this isn’t a bad beginner example either. IDK how much vanilla Rust perf can leave on the table for a decent iter() version.</p>
</blockquote>
<p>Interesting, this is a case where the loop version works perfectly but the obvious iter one doesn't: <a href="https://rust.godbolt.org/z/nYjohGKcs">https://rust.godbolt.org/z/nYjohGKcs</a></p>



<a name="277547304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547304">(Apr 02 2022 at 19:33)</a>:</h4>
<p>that's</p>



<a name="277547309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547309">(Apr 02 2022 at 19:33)</a>:</h4>
<p>lmao</p>



<a name="277547315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547315">(Apr 02 2022 at 19:33)</a>:</h4>
<p>Oh, it's because <code>array::IntoIter</code> is apparently bad.  This one works greatL</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">wider_reduce_iter</span><span class="p">(</span><span class="n">x</span>: <span class="nc">Simd</span><span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u16</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">as_array</span><span class="p">().</span><span class="n">into_iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="kt">u16</span>::<span class="n">from</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)).</span><span class="n">sum</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277547384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547384">(Apr 02 2022 at 19:35)</a>:</h4>
<p>ohhh</p>



<a name="277547493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cyborus <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547493">(Apr 02 2022 at 19:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277547231">said</a>:</p>
<blockquote>
<p>punpcklbw</p>
</blockquote>
<p>looks like someone punched their keyboard</p>



<a name="277547608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547608">(Apr 02 2022 at 19:39)</a>:</h4>
<p>Hypothesis: it's using <code>.as_ref()</code> in the <code>fold</code> implementation.  And that usually pessimizes things.</p>
<p>I'll go make a codegen test and experiment <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="277547776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277547776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277547776">(Apr 02 2022 at 19:42)</a>:</h4>
<p>(This is why I added <a href="https://doc.rust-lang.org/nightly/src/core/iter/adapters/by_ref_sized.rs.html">https://doc.rust-lang.org/nightly/src/core/iter/adapters/by_ref_sized.rs.html</a> to core)</p>



<a name="277548660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277548660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277548660">(Apr 02 2022 at 20:00)</a>:</h4>
<p>Confirmed, it's the <code>as_ref</code> ruining everything, as usual.</p>



<a name="277548707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277548707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277548707">(Apr 02 2022 at 20:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277548660">said</a>:</p>
<blockquote>
<p>Confirmed, it's the <code>as_ref</code> ruining everything, as usual.</p>
</blockquote>
<p>How did you confirm this?</p>



<a name="277548749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277548749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277548749">(Apr 02 2022 at 20:02)</a>:</h4>
<p>(I'm guessing you added it to the godbolt snippet and then saw that the assembly gets horrible, but I'm a bit new to this.)</p>



<a name="277549020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277549020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277549020">(Apr 02 2022 at 20:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="246783">Miguel Raz Guzmán Macedo</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277548707">said</a>:</p>
<blockquote>
<p>How did you confirm this?</p>
</blockquote>
<p>Oh, by changing <code>core</code>:<br>
<a href="/user_uploads/4715/VVJr09IRicI-jHF_aJkJu8zs/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/4715/VVJr09IRicI-jHF_aJkJu8zs/image.png" title="image.png"><img src="/user_uploads/4715/VVJr09IRicI-jHF_aJkJu8zs/image.png"></a></div><p>And writing a codegen test:<br>
<a href="/user_uploads/4715/OEzGOGQ9ARuuYnJ8ZNZycmZk/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/OEzGOGQ9ARuuYnJ8ZNZycmZk/image.png" title="image.png"><img src="/user_uploads/4715/OEzGOGQ9ARuuYnJ8ZNZycmZk/image.png"></a></div>



<a name="277549139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277549139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277549139">(Apr 02 2022 at 20:10)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> oh gnarly - are you inlining <code>llvm-lit</code> tests into a Rust test?</p>



<a name="277549153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277549153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277549153">(Apr 02 2022 at 20:10)</a>:</h4>
<p>Also I don't think I've ever changed anything in <code>core</code> - I'm guessing that requires a Rust recompile.</p>



<a name="277549215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277549215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277549215">(Apr 02 2022 at 20:12)</a>:</h4>
<p>I've got the scalar version of <code>hamming0</code> in <a href="https://rust.godbolt.org/z/rrv5Kq9zd">rust godbolt</a> if anyone wants to take a stab at the SIMD version.</p>



<a name="277549217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277549217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277549217">(Apr 02 2022 at 20:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="246783">Miguel Raz Guzmán Macedo</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277549139">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> oh gnarly - are you inlining <code>llvm-lit</code> tests into a Rust test?</p>
</blockquote>
<p>Absolutely -- that's what the <code>src/test/codegen</code> folder is there for <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span> </p>
<p>See <a href="https://github.com/rust-lang/rust/blob/master/src/test/codegen/autovectorize-f32x4.rs">https://github.com/rust-lang/rust/blob/master/src/test/codegen/autovectorize-f32x4.rs</a></p>
<p><span class="user-mention silent" data-user-id="246783">Miguel Raz Guzmán Macedo</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277549153">said</a>:</p>
<blockquote>
<p>Also I don't think I've ever changed anything in <code>core</code> - I'm guessing that requires a Rust recompile.</p>
</blockquote>
<p>Yeah, I've got a rustc dev environment set up.</p>



<a name="277549243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277549243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277549243">(Apr 02 2022 at 20:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277549217">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="246783">Miguel Raz Guzmán Macedo</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277549139">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> oh gnarly - are you inlining <code>llvm-lit</code> tests into a Rust test?</p>
</blockquote>
<p>Absolutely -- that's what the <code>src/test/codegen</code> folder is there for <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span> </p>
<p>See <a href="https://github.com/rust-lang/rust/blob/master/src/test/codegen/autovectorize-f32x4.rs">https://github.com/rust-lang/rust/blob/master/src/test/codegen/autovectorize-f32x4.rs</a></p>
<p><span class="user-mention silent" data-user-id="246783">Miguel Raz Guzmán Macedo</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277549153">said</a>:</p>
<blockquote>
<p>Also I don't think I've ever changed anything in <code>core</code> - I'm guessing that requires a Rust recompile.</p>
</blockquote>
<p>Yeah, I've got a rustc dev environment set up.</p>
</blockquote>
<p>Whoah, that rustc dev environemnt sounds gnarly. How long does a 1 line recompile take?</p>



<a name="277549321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277549321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277549321">(Apr 02 2022 at 20:14)</a>:</h4>
<p>Depends greatly what you're changing.  If I just change a codegen test, it knows not to rebuild more than that so it's a few seconds.  But yeah, 2 years back a full build was well over two hours for me -- I've since upgraded to a 16T32C machine that makes things far less painful.</p>



<a name="277549356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277549356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277549356">(Apr 02 2022 at 20:15)</a>:</h4>
<p>There's a bunch of special "profiles" you can use now, though, so you can avoid building llvm if you don't care, avoid building rustc if you're just working on rustdoc, etc.</p>



<a name="277549433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277549433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277549433">(Apr 02 2022 at 20:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277549321">said</a>:</p>
<blockquote>
<p>Depends greatly what you're changing.  If I just change a codegen test, it knows not to rebuild more than that so it's a few seconds.  But yeah, 2 years back a full build was well over two hours for me -- I've since upgraded to a 16T32C machine that makes things far less painful.</p>
</blockquote>
<p>To quote <span class="user-mention" data-user-id="281757">@Jubilee</span> :<br>
<a href="/user_uploads/4715/fKfhzfKkrmrYDROlxHLYDgix/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/fKfhzfKkrmrYDROlxHLYDgix/image.png" title="image.png"><img src="/user_uploads/4715/fKfhzfKkrmrYDROlxHLYDgix/image.png"></a></div>



<a name="277549784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277549784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277549784">(Apr 02 2022 at 20:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="246783">Miguel Raz Guzmán Macedo</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277549243">said</a>:</p>
<blockquote>
<p>Whoah, that rustc dev environemnt sounds gnarly. How long does a 1 line recompile take?</p>
</blockquote>
<p>Well, I added a new <code>DoubleEndedIterator</code> implementation in core, and there's what it did up through running the codegen test:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>&gt; python x.py -j 16 test --keep-stage 0 src\test\codegen --test-args wide-sum
Updating only changed submodules
  Submodules updated in 0.03 seconds
Building rustbuild
    Finished dev [unoptimized] target(s) in 0.21s
Warning: Using a potentially old libstd. This may not behave well.
Copying stage0 std from stage0 (x86_64-pc-windows-msvc -&gt; x86_64-pc-windows-msvc / x86_64-pc-windows-msvc)
Warning: Using a potentially old librustc. This may not behave well.
Warning: Use `--keep-stage-std` if you want to rebuild the compiler when it changes
Copying stage0 rustc from stage0 (x86_64-pc-windows-msvc -&gt; x86_64-pc-windows-msvc / x86_64-pc-windows-msvc)
Assembling stage1 compiler (x86_64-pc-windows-msvc)
Building stage0 tool lld-wrapper (x86_64-pc-windows-msvc)
    Finished release [optimized] target(s) in 0.33s
Building stage0 tool lld-wrapper (x86_64-pc-windows-msvc)
    Finished release [optimized] target(s) in 0.33s
Building stage1 std artifacts (x86_64-pc-windows-msvc -&gt; x86_64-pc-windows-msvc)
   Compiling core v0.0.0 (C:\src\rust\library\core)
   Compiling rustc-std-workspace-core v1.99.0 (C:\src\rust\library\rustc-std-workspace-core)
   Compiling compiler_builtins v0.1.70
   Compiling libc v0.2.116
   Compiling alloc v0.0.0 (C:\src\rust\library\alloc)
   Compiling cfg-if v0.1.10
   Compiling memchr v2.4.1
   Compiling adler v0.2.3
   Compiling rustc-demangle v0.1.21
   Compiling unwind v0.0.0 (C:\src\rust\library\unwind)
   Compiling rustc-std-workspace-alloc v1.99.0 (C:\src\rust\library\rustc-std-workspace-alloc)
   Compiling panic_unwind v0.0.0 (C:\src\rust\library\panic_unwind)
   Compiling panic_abort v0.0.0 (C:\src\rust\library\panic_abort)
   Compiling gimli v0.25.0
   Compiling object v0.26.2
   Compiling hashbrown v0.12.0
   Compiling miniz_oxide v0.4.0
   Compiling std_detect v0.1.5 (C:\src\rust\library\stdarch\crates\std_detect)
   Compiling addr2line v0.16.0
   Compiling std v0.0.0 (C:\src\rust\library\std)
   Compiling rustc-std-workspace-std v1.99.0 (C:\src\rust\library\rustc-std-workspace-std)
   Compiling proc_macro v0.0.0 (C:\src\rust\library\proc_macro)
   Compiling unicode-width v0.1.8
   Compiling getopts v0.2.21
   Compiling test v0.0.0 (C:\src\rust\library\test)
    Finished release [optimized] target(s) in 18.87s
Copying stage1 std from stage1 (x86_64-pc-windows-msvc -&gt; x86_64-pc-windows-msvc / x86_64-pc-windows-msvc)
Building stage0 tool compiletest (x86_64-pc-windows-msvc)
    Finished release [optimized] target(s) in 0.52s
Check compiletest suite=codegen mode=codegen (x86_64-pc-windows-msvc -&gt; x86_64-pc-windows-msvc)

running 1 test
.
test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 328 filtered out; finished in 0.10s

        finished in 0.218 seconds
Build completed successfully in 0:00:21
</code></pre></div>



<a name="277550037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277550037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277550037">(Apr 02 2022 at 20:30)</a>:</h4>
<p>Neat!</p>



<a name="277552807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277552807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277552807">(Apr 02 2022 at 21:31)</a>:</h4>
<p>PR up to fix the <code>.into_iter()</code> version of this: <a href="https://github.com/rust-lang/rust/issues/95602">#95602</a></p>



<a name="277659460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659460">(Apr 03 2022 at 20:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277546073">said</a>:</p>
<blockquote>
<p>the way <code>_mm_sad_epu8</code> works is absolutely nuts and unlikely to become an operation in the <em>portable</em> SIMD API that this part of the standard library is aiming to be.</p>
</blockquote>
<p>We only really need <code>abs_diff</code> and then to ensure a horizontal sum for it does what's expected</p>



<a name="277659537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659537">(Apr 03 2022 at 20:32)</a>:</h4>
<p>And <a href="https://doc.rust-lang.org/nightly/std/primitive.i16.html#method.abs_diff">https://doc.rust-lang.org/nightly/std/primitive.i16.html#method.abs_diff</a> is now stable on scalars, so it would make sense to offer on <code>Simd</code> too.</p>



<a name="277659632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659632">(Apr 03 2022 at 20:36)</a>:</h4>
<p>abs_diff+sum is the backbone of many video codecs, so it seems <em>very</em> useful to ensure <code>some_u8s.abs_diff(other_u8s).horizontal_sum::&lt;u32&gt;()</code> or something is possible (and does what's needed). The details of the x86 intrinsics are not important to preserve, though.</p>
<p>We even jump through hoops to ensure it gets vectorized for summing a <code>[u8; 16]</code>: <a href="https://doc.rust-lang.org/nightly/src/core/num/uint_macros.rs.html#1650">https://doc.rust-lang.org/nightly/src/core/num/uint_macros.rs.html#1650</a> (this was mostly needed because of how fragile LLVM's optimization for this is, though -- naively it fails unless the C-specific int promotion rules are used)</p>



<a name="277659676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659676">(Apr 03 2022 at 20:36)</a>:</h4>
<p>Do we have a widening sum?</p>



<a name="277659684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659684">(Apr 03 2022 at 20:36)</a>:</h4>
<p>Widening sum would be performed with cast and sum</p>



<a name="277659686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659686">(Apr 03 2022 at 20:36)</a>:</h4>
<p><code>abs_diff</code> should be pretty easy to implement, too.  For unsigned I think it's just <code>a.lanes_lt(b).select(b - a, a - b)</code>?</p>



<a name="277659695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659695">(Apr 03 2022 at 20:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277659684">said</a>:</p>
<blockquote>
<p>Widening sum would be performed with cast and sum</p>
</blockquote>
<p>This seems good (assuming it gets compiled right, which I'd expect).</p>



<a name="277659696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659696">(Apr 03 2022 at 20:37)</a>:</h4>
<p>(if it's requested enough a function could be added)</p>



<a name="277659702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659702">(Apr 03 2022 at 20:37)</a>:</h4>
<p>Yeah I'd hope it would work, there's no other way to represent it in LLVM afaik</p>



<a name="277659907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659907">(Apr 03 2022 at 20:41)</a>:</h4>
<p>so yeah, abs_diff + cast + sum would hopefully use psadbw. It might be worth checking that it actually does too, since (IMO) this is a pretty important operation.</p>



<a name="277659966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659966">(Apr 03 2022 at 20:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types/near/277659695">said</a>:</p>
<blockquote>
<p>(assuming it gets compiled right, which I'd expect).</p>
</blockquote>
<p>Well, LLVM even turns the scalar version of the wider sum into <code>zext</code>+<code>reduce.sum</code>, so I'd expect that's the right way to represent it, at least.</p>
<p>See the codegen test I'm adding in <a href="https://github.com/rust-lang/rust/pull/95602/files#diff-8cead13d3f6954e31e2d320dd04677b5031db80ffc0de93578c6b3cc9fd0ead4R23">https://github.com/rust-lang/rust/pull/95602/files#diff-8cead13d3f6954e31e2d320dd04677b5031db80ffc0de93578c6b3cc9fd0ead4R23</a></p>
<p>(Which also fixes a problem in <code>array::IntoIter</code> that kept it from autovectorizing too.)</p>



<a name="277659973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659973">(Apr 03 2022 at 20:42)</a>:</h4>
<p>and while emulating the x86 intrisinc would not be portable, certainly x86 and neon both have a way to do this efficiently, and i think altivec does too (but its been a while)</p>



<a name="277659990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277659990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277659990">(Apr 03 2022 at 20:43)</a>:</h4>
<p>(it's used for motion estimation in video codecs)</p>



<a name="277660321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277660321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277660321">(Apr 03 2022 at 20:51)</a>:</h4>
<p>Hmm, neither of these do <code>psadbw</code> &lt;<a href="https://rust.godbolt.org/z/P31endW8r">https://rust.godbolt.org/z/P31endW8r</a>&gt;</p>



<a name="277660534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277660534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277660534">(Apr 03 2022 at 20:55)</a>:</h4>
<p>No luck trying</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">abs_diff_then_wider_sum_3</span><span class="p">(</span><span class="n">x</span>: <span class="nc">Simd</span><span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="nc">Simd</span><span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u16</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">d</span>: <span class="nc">Simd</span><span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">)).</span><span class="n">cast</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">d</span><span class="p">.</span><span class="n">reduce_sum</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>either.</p>



<a name="277660697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277660697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277660697">(Apr 03 2022 at 20:58)</a>:</h4>
<p>I think it may be possible to use the underlying intrinsic to sum directly into a wider type.</p>



<a name="277660725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277660725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277660725">(Apr 03 2022 at 20:58)</a>:</h4>
<p>Searching the LLVM issues hints that maybe psadbw is used only for optimizing special conditions of sums and not actually for sums of absolute differences</p>



<a name="277660769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277660769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277660769">(Apr 03 2022 at 21:00)</a>:</h4>
<p>weird.</p>



<a name="277660871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277660871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277660871">(Apr 03 2022 at 21:00)</a>:</h4>
<p>The LLVM instruction requires the output to be the same type</p>



<a name="277660874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277660874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277660874">(Apr 03 2022 at 21:00)</a>:</h4>
<p>Oh it has to be the same type as the vector type? damn.</p>



<a name="277660880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277660880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277660880">(Apr 03 2022 at 21:01)</a>:</h4>
<p>Yeah then cast is as far as we can go.</p>



<a name="277660887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277660887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277660887">(Apr 03 2022 at 21:01)</a>:</h4>
<p>I think the cast is pretty explicit to the optimizer anyway</p>



<a name="277660986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277660986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277660986">(Apr 03 2022 at 21:03)</a>:</h4>
<p>Then I would rather put "cycles I have free on engaging with LLVM nonsense" towards the dynamic swizzle and vectorized pointer ops, tbh.</p>



<a name="277661289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277661289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277661289">(Apr 03 2022 at 21:10)</a>:</h4>
<p>Agreed</p>



<a name="277697519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Reducing%20sum%20into%20wider%20types/near/277697519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Reducing.20sum.20into.20wider.20types.html#277697519">(Apr 04 2022 at 08:26)</a>:</h4>
<p>Hm, yes, it's hard to seriously consider this more important than those. I been naively assuming that it wouldn't be that bad, since it sometimes autovectorizes scalar code to use it.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>