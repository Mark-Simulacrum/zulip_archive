<html>
<head><meta charset="utf-8"><title>Broken compilation as of 2021-09-01 · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html">Broken compilation as of 2021-09-01</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252044854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252044854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252044854">(Sep 05 2021 at 03:06)</a>:</h4>
<p>So I guess it's time to analyze this once more, huh.</p>



<a name="252045594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252045594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252045594">(Sep 05 2021 at 03:21)</a>:</h4>
<p>Passing on x86_64:</p>
<div class="codehilite"><pre><span></span><code>cargo test --all # note lack of optimization
cargo test --release --test &quot;f*_ops&quot;
cargo test --release --test &quot;[iu][1-6][1-6]_ops&quot;
</code></pre></div>
<p>Failing on x86_64:</p>
<div class="codehilite"><pre><span></span><code>cargo test --release --test [iu]8_ops
</code></pre></div>
<p>So the question is: what assumption is being made only on byte ops?</p>



<a name="252045678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252045678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252045678">(Sep 05 2021 at 03:23)</a>:</h4>
<p>I suppose it's possible we're accidentally relying on some UB?</p>



<a name="252045686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252045686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252045686">(Sep 05 2021 at 03:23)</a>:</h4>
<p>That fails some sort of assertion?</p>



<a name="252048254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252048254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252048254">(Sep 05 2021 at 04:16)</a>:</h4>
<p>I mean it is also always possible that the error is with LLVM.</p>



<a name="252549642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252549642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252549642">(Sep 08 2021 at 23:31)</a>:</h4>
<p>alright, re-rerunning the tests.</p>
<p>I think the issue must be with inlining since it succeeds in debug.<br>
It would be nice to isolate where.</p>



<a name="252549808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252549808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252549808">(Sep 08 2021 at 23:33)</a>:</h4>
<p>Same.</p>



<a name="252550114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252550114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252550114">(Sep 08 2021 at 23:37)</a>:</h4>
<p>I assume LLVM has been updated recently?</p>



<a name="252550134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252550134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252550134">(Sep 08 2021 at 23:37)</a>:</h4>
<p>I doubt anything changed on the rustc end</p>



<a name="252550553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252550553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252550553">(Sep 08 2021 at 23:42)</a>:</h4>
<p>I believe we recently moved to LLVM 13.</p>



<a name="252551492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252551492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252551492">(Sep 08 2021 at 23:55)</a>:</h4>
<p>Yes, it is, August 21 or so had LLVM 13 merged in, so right after the last green. <a href="https://github.com/rust-lang/rust/pull/87570">https://github.com/rust-lang/rust/pull/87570</a><br>
<span class="user-mention" data-user-id="312331">@Caleb Zulawski</span> Motion to merge with broken tests given we can verify everything else works OK and it is almost certainly LLVM 13. Also would accept: disabling these tests in CI and filing the issue.</p>



<a name="252551617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252551617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252551617">(Sep 08 2021 at 23:56)</a>:</h4>
<p>I'm okay with merging it broken, to some extent I think I'd prefer keeping the broken tests</p>



<a name="252551632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252551632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252551632">(Sep 08 2021 at 23:57)</a>:</h4>
<p>Considering they're by far the most frequent usage</p>



<a name="252551674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252551674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252551674">(Sep 08 2021 at 23:57)</a>:</h4>
<p>Absolutely fine by me.</p>



<a name="252552511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252552511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252552511">(Sep 09 2021 at 00:08)</a>:</h4>
<p>filed <a href="https://github.com/rust-lang/rust/issues/88769">https://github.com/rust-lang/rust/issues/88769</a></p>



<a name="252552703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252552703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252552703">(Sep 09 2021 at 00:11)</a>:</h4>
<p>Might be worth bringing that up in the LLVM channel if you haven't already</p>



<a name="252552713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252552713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252552713">(Sep 09 2021 at 00:11)</a>:</h4>
<p>I wonder if it affects the stable intrinsics</p>



<a name="252556761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252556761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252556761">(Sep 09 2021 at 01:10)</a>:</h4>
<p>It is entirely possible, tbh.</p>



<a name="252556786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252556786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252556786">(Sep 09 2021 at 01:11)</a>:</h4>
<p>I wasn't under the impression they're tested particularly exhaustively</p>



<a name="252559747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252559747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252559747">(Sep 09 2021 at 01:57)</a>:</h4>
<p>Nothing appears to break, running the stdarch tests.</p>



<a name="252559798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252559798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252559798">(Sep 09 2021 at 01:58)</a>:</h4>
<p>That's good, I suppose</p>



<a name="252559824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252559824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252559824">(Sep 09 2021 at 01:58)</a>:</h4>
<p>Though I was kind of hoping something did so it didn't fall completely on us <span aria-label="innocent" class="emoji emoji-1f607" role="img" title="innocent">:innocent:</span></p>



<a name="252560339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252560339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252560339">(Sep 09 2021 at 02:05)</a>:</h4>
<p>pffft</p>



<a name="252560385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252560385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252560385">(Sep 09 2021 at 02:05)</a>:</h4>
<p>...oh, many do if I turn on avx2.</p>



<a name="252560610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252560610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252560610">(Sep 09 2021 at 02:08)</a>:</h4>
<p>It looks like it's mostly the instruction assertions.</p>



<a name="252562617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252562617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252562617">(Sep 09 2021 at 02:35)</a>:</h4>
<p><a href="https://github.com/rust-lang/stdarch/issues/1209">https://github.com/rust-lang/stdarch/issues/1209</a><br>
Yeah in <code>--release</code> with higher-level instruction sets on it's doing extra optimizations and inlining.</p>



<a name="252562692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252562692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252562692">(Sep 09 2021 at 02:36)</a>:</h4>
<p>Ah so might be okay</p>



<a name="252562827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252562827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252562827">(Sep 09 2021 at 02:38)</a>:</h4>
<p>Well in this case it basically is emitting VEX prefixed versions of instructions.<br>
I am guessing some optimization that LLVM now emits is subtly bogus.</p>



<a name="252563269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252563269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252563269">(Sep 09 2021 at 02:44)</a>:</h4>
<p>That or we are majorly screwed up! :D</p>



<a name="252563280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252563280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252563280">(Sep 09 2021 at 02:45)</a>:</h4>
<p>...nah that doesn't seem likely.</p>



<a name="252563411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252563411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252563411">(Sep 09 2021 at 02:46)</a>:</h4>
<p>If we can narrow down which fns it's choking on maybe it will reveal we did screw up lol</p>



<a name="252563421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252563421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252563421">(Sep 09 2021 at 02:46)</a>:</h4>
<p>But agreed it's unlikely</p>



<a name="252574917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252574917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252574917">(Sep 09 2021 at 05:57)</a>:</h4>
<p>yeah, need to bisect the test suite.</p>



<a name="252575207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252575207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252575207">(Sep 09 2021 at 06:00)</a>:</h4>
<p><code>cargo test --doc --release</code> passes, so there's that.</p>



<a name="252575388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252575388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252575388">(Sep 09 2021 at 06:03)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="k">fn</span> <span class="nf">horizontal_product</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">LANES</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">test_helpers</span>::<span class="n">test_1</span><span class="p">(</span><span class="o">&amp;|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">test_helpers</span>::<span class="n">prop_assert_biteq</span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="cp">$vector</span>::<span class="o">&lt;</span><span class="n">LANES</span><span class="o">&gt;</span>::<span class="n">from_array</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">horizontal_product</span><span class="p">(),</span><span class="w"></span>
<span class="w">                    </span><span class="n">x</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">copied</span><span class="p">().</span><span class="n">fold</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="cp">$scalar</span><span class="p">,</span><span class="w"> </span><span class="cp">$scalar</span>::<span class="n">wrapping_mul</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="w">            </span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I found the murderer.</p>



<a name="252583069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252583069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252583069">(Sep 09 2021 at 07:33)</a>:</h4>
<p>Merely invoking</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"platform-intrinsic"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">simd_reduce_mul_ordered</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">y</span>: <span class="nc">U</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>isn't enough, though, it seems.</p>



<a name="252682154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/252682154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#252682154">(Sep 09 2021 at 19:35)</a>:</h4>
<p><a href="https://bugs.llvm.org/show_bug.cgi?id=51811">https://bugs.llvm.org/show_bug.cgi?id=51811</a> looks like it's this.</p>



<a name="253172323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253172323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253172323">(Sep 13 2021 at 22:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> has marked this topic as unresolved.</p>



<a name="253172415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253172415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253172415">(Sep 13 2021 at 22:50)</a>:</h4>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>mkdir issue-88769
<span class="nb">cd</span> issue-88769

curl -sSO https://gist.githubusercontent.com/eddyb/08ea4736082d9b2326a984c4cb828a08/raw/6a2b96cd8422950fa2b160e518671df66965a863/issue-88769-min.rs

rustup toolchain install nightly-2021-09-12 -c llvm-tools-preview

<span class="c1"># This will crash - ignore the crash and keep going, `-C save-temps` works.</span>
rustc +nightly-2021-09-12 issue-88769-min.rs -O -C save-temps

<span class="c1"># This reproduces the crash using the `.bc` from `-C save-temps`.</span>
~/.rustup/toolchains/2021-09-12-x*64*/lib/rustlib/x*64*/bin/opt -O3 issue-88769-min.*-cgu.3.rcgu.no-opt.bc &gt; opt.bc
</code></pre></div>
<p>Could someone run this and see if the minimization still repros?</p>



<a name="253178605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253178605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253178605">(Sep 13 2021 at 23:59)</a>:</h4>
<p>Well, I didn't run the minimization yet, but I can't build portable-simd</p>



<a name="253178883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253178883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253178883">(Sep 14 2021 at 00:01)</a>:</h4>
<p>really??? can't even <code>cargo build</code>?</p>



<a name="253178947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253178947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253178947">(Sep 14 2021 at 00:02)</a>:</h4>
<p>I ran the example and opt crashes in the same spot</p>



<a name="253178986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253178986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253178986">(Sep 14 2021 at 00:02)</a>:</h4>
<p>wait</p>



<a name="253179016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253179016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253179016">(Sep 14 2021 at 00:03)</a>:</h4>
<div class="codehilite"><pre><span></span><code># rustc +nightly-2021-09-12 --version
rustc 1.57.0-nightly (8c2b6ea37 2021-09-11)
</code></pre></div>



<a name="253179207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253179207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253179207">(Sep 14 2021 at 00:04)</a>:</h4>
<p>I tested in the meeting thread on today's nightly, probably <code>nightly-2021-09-13</code></p>



<a name="253179646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253179646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253179646">(Sep 14 2021 at 00:08)</a>:</h4>
<p>so to clarify, I can <code>cargo build --release</code>, I meant that I can't build the tests</p>



<a name="253179826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253179826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253179826">(Sep 14 2021 at 00:10)</a>:</h4>
<div class="codehilite"><pre><span></span><code>rustc 1.57.0-nightly (51e514c0f 2021-09-12)
</code></pre></div>



<a name="253179832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253179832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253179832">(Sep 14 2021 at 00:10)</a>:</h4>
<p>is the current nightly, that still fails</p>



<a name="253179878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253179878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253179878">(Sep 14 2021 at 00:11)</a>:</h4>
<p>looking at the git log, the llvm update commit should be in that nightly commit</p>



<a name="253179980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253179980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253179980">(Sep 14 2021 at 00:12)</a>:</h4>
<p>does the llvm build get cached? maybe it's using the old one by mistake</p>



<a name="253180033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253180033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253180033">(Sep 14 2021 at 00:13)</a>:</h4>
<p>is there any chance the release doesn't use the in-tree llvm?</p>



<a name="253180041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253180041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253180041">(Sep 14 2021 at 00:13)</a>:</h4>
<p>maybe pulling from ci?</p>



<a name="253181014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253181014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253181014">(Sep 14 2021 at 00:26)</a>:</h4>
<p>idk, didn't see anything after some looking, but it's highly likely I was just looking in the wrong spot</p>



<a name="253181858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Broken%20compilation%20as%20of%202021-09-01/near/253181858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Broken.20compilation.20as.20of.202021-09-01.html#253181858">(Sep 14 2021 at 00:38)</a>:</h4>
<p>Okay, it should be the nightly with the tree LLVM updated.z</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>