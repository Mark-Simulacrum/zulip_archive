<html>
<head><meta charset="utf-8"><title>Scatter to [MaybeUninit&lt;T&gt;] · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html">Scatter to [MaybeUninit&lt;T&gt;]</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263636386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263636386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263636386">(Dec 03 2021 at 20:51)</a>:</h4>
<p><span class="user-mention" data-user-id="312331">@Caleb Zulawski</span> Nah it's not unsound to scatter to <code>[MaybeUninit&lt;T&gt;]</code>, it's only unsound to treat <code>&amp;mut [MaybeUninit&lt;T&gt;]</code> as <code>&amp;mut [T]</code>.</p>



<a name="263636419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263636419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263636419">(Dec 03 2021 at 20:51)</a>:</h4>
<p>Agreed</p>



<a name="263636485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263636485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263636485">(Dec 03 2021 at 20:52)</a>:</h4>
<p>I'm guessing there is a function to go the other way? But I'm not sure</p>



<a name="263636542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263636542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263636542">(Dec 03 2021 at 20:52)</a>:</h4>
<p>I thought there was, but I couldn't find it</p>



<a name="263637584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263637584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263637584">(Dec 03 2021 at 20:58)</a>:</h4>
<p>You can convert the <code>[MaybeUninit&lt;T&gt;]</code> to <code>[T]</code> if it's completely initialized.</p>



<a name="263637651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263637651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263637651">(Dec 03 2021 at 20:59)</a>:</h4>
<p>I meant if you still want to scatter to a plain slice</p>



<a name="263638033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263638033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263638033">(Dec 03 2021 at 21:01)</a>:</h4>
<p>Oh.</p>



<a name="263638058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263638058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263638058">(Dec 03 2021 at 21:01)</a>:</h4>
<p>What I am confused now <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="263638199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263638199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263638199">(Dec 03 2021 at 21:02)</a>:</h4>
<p>scatter to <code>[T]</code> by calling scatter to <code>[MaybeUninit&lt;T&gt;]</code></p>



<a name="263638396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263638396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263638396">(Dec 03 2021 at 21:04)</a>:</h4>
<p>Uhhh I think it would be an unacceptable ergonomics loss to have to call a function on a slice to pretend it is MaybeUninit and then write to it, even if it existed.</p>



<a name="263652945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263652945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263652945">(Dec 03 2021 at 21:05)</a>:</h4>
<p>I think changing <code>scatter_select_unchecked</code> to use a base <code>*mut T</code> is fine, since that's basically already happening.</p>



<a name="263653030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263653030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263653030">(Dec 03 2021 at 21:06)</a>:</h4>
<p>Though that requires people who want to manually mask also call <code>.len()</code> in the right order.</p>



<a name="263653034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263653034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263653034">(Dec 03 2021 at 21:06)</a>:</h4>
<p>ugh.</p>



<a name="263657097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263657097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263657097">(Dec 03 2021 at 21:44)</a>:</h4>
<p>Yeah no even as an <code>unsafe</code> function that's too many invariants to expose.</p>



<a name="263657170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263657170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263657170">(Dec 03 2021 at 21:45)</a>:</h4>
<p>Like what?</p>



<a name="263657277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263657277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263657277">(Dec 03 2021 at 21:46)</a>:</h4>
<p>Uh, "if you so much as looked at the <code>*mut T</code> wrong it breaks".</p>



<a name="263657304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263657304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263657304">(Dec 03 2021 at 21:46)</a>:</h4>
<p>I'm not sure what you mean</p>



<a name="263657398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263657398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263657398">(Dec 03 2021 at 21:47)</a>:</h4>
<p>If I changed it to accept <code>*mut T</code> the only safe way to use the unsafe <code>scatter_select_unchecked</code> would be in fact to write</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">simd</span><span class="p">.</span><span class="n">scatter_select_unchecked</span><span class="p">(</span><span class="n">slice</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">idxs</span><span class="p">);</span><span class="w"></span>
<span class="c1">// or</span>
<span class="n">simd</span><span class="p">.</span><span class="n">scatter_select_unchecked</span><span class="p">(</span><span class="n">MaybeUninit</span>::<span class="n">slice_as_mut_ptr</span><span class="p">(</span><span class="n">slice</span><span class="p">),</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">idxs</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="263657573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263657573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263657573">(Dec 03 2021 at 21:49)</a>:</h4>
<p>yeah...that's not much different than trying to copy a slice by calling <code>memcpy</code> directly...i don't see how that's "too unsafe"</p>



<a name="263657803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263657803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263657803">(Dec 03 2021 at 21:51)</a>:</h4>
<p>the problem is that</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slice</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">mask</span>: <span class="nc">Mask</span><span class="o">&lt;</span><span class="kt">isize</span><span class="p">,</span><span class="w"> </span><span class="n">LANES</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idxs</span><span class="p">.</span><span class="n">lanes_lt</span><span class="p">(</span><span class="n">Simd</span>::<span class="n">splat</span><span class="p">(</span><span class="n">slice</span><span class="p">.</span><span class="n">len</span><span class="p">()));</span><span class="w"></span>
<span class="n">simd</span><span class="p">.</span><span class="n">scatter_select_unchecked</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">idxs</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>is wrong.</p>



<a name="263657959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263657959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263657959">(Dec 03 2021 at 21:52)</a>:</h4>
<p>Why?</p>



<a name="263658097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263658097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263658097">(Dec 03 2021 at 21:53)</a>:</h4>
<p>that's exactly like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slice</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slice</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"></span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">c_void</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="263658213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263658213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263658213">(Dec 03 2021 at 21:54)</a>:</h4>
<p>which is also wrong, but <code>memcpy</code> is not declared "too unsafe" to include in the libc crate</p>



<a name="263658282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263658282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263658282">(Dec 03 2021 at 21:55)</a>:</h4>
<p>it's wrong cuz the slice being borrowed immutably for <code>len</code> invalidates the mutable borrow for <code>ptr</code></p>



<a name="263658286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263658286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263658286">(Dec 03 2021 at 21:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D/near/263657959">said</a>:</p>
<blockquote>
<p>Why?</p>
</blockquote>
<p>The <code>.len()</code> call interacts with the <code>&amp;mut [T]</code> when it creates the <code>&amp;[T]</code> reference and basically reasserts the uniqueness assumptions.</p>



<a name="263658324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263658324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263658324">(Dec 03 2021 at 21:55)</a>:</h4>
<p>yeah.</p>



<a name="263658771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263658771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263658771">(Dec 03 2021 at 21:59)</a>:</h4>
<p>hmm, how about we just leave out unchecked_scatter and instead tell people to use vectors of pointers?</p>



<a name="263658883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263658883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263658883">(Dec 03 2021 at 22:00)</a>:</h4>
<p>though otoh maybe we need unchecked_scatter anyway</p>



<a name="263659217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263659217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263659217">(Dec 03 2021 at 22:03)</a>:</h4>
<p>Is there a reference on not being able to hold a mutable pointer to something while accessing it? Miri doesn't complain</p>



<a name="263659423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263659423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263659423">(Dec 03 2021 at 22:05)</a>:</h4>
<p>What exactly are you running past Miri?</p>



<a name="263659441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263659441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263659441">(Dec 03 2021 at 22:05)</a>:</h4>
<p>And "Miri doesn't complain" isn't "it's not UB" or "it's a good idea".</p>



<a name="263659472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263659472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263659472">(Dec 03 2021 at 22:05)</a>:</h4>
<p>Yeah, that's why I was looking for a reference</p>



<a name="263659539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263659539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263659539">(Dec 03 2021 at 22:06)</a>:</h4>
<p>I did basically this, I get a pointer, then check the length, then write to the pointer</p>



<a name="263661196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263661196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263661196">(Dec 03 2021 at 22:20)</a>:</h4>
<blockquote>
<p>Finding live shared references propagates recursively through references, but not through raw pointers.<br>
<a href="https://rust-lang.github.io/unsafe-code-guidelines/glossary.html">https://rust-lang.github.io/unsafe-code-guidelines/glossary.html</a></p>
</blockquote>
<p>This is basically the opposite case</p>



<a name="263664674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263664674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263664674">(Dec 03 2021 at 23:00)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> Hey did you ever document the no-transitive-reference thing?</p>



<a name="263666608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263666608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263666608">(Dec 03 2021 at 23:24)</a>:</h4>
<p>so i might be a little lost here but aren't there just gonna be <em>two</em> functions? one for a normal slice and one for the maybeuninit slice?</p>
<p>heck if the target to scatter to is an arg to the scatter function we can even make one generic function with some sort of unsafe trait for the target and users could extend it to their own types that way if they absolutely need to.</p>



<a name="263666739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263666739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263666739">(Dec 03 2021 at 23:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D/near/263666608">said</a>:</p>
<blockquote>
<p>so i might be a little lost here but aren't there just gonna be <em>two</em> functions? one for a normal slice and one for the maybeuninit slice?</p>
</blockquote>
<p>yup, that's what I'd expect</p>



<a name="263666776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263666776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263666776">(Dec 03 2021 at 23:27)</a>:</h4>
<p>ohgod lol</p>



<a name="263666778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263666778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263666778">(Dec 03 2021 at 23:27)</a>:</h4>
<p>yeah, I think there would be a second function. there will probably be several variations once we have vectors of pointers, too</p>



<a name="263666784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263666784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263666784">(Dec 03 2021 at 23:27)</a>:</h4>
<p>yes that was my initial intention.</p>



<a name="263666840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263666840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263666840">(Dec 03 2021 at 23:28)</a>:</h4>
<p>I'm still not sure which one we want to consider the fundamental "scatter" function</p>



<a name="263666856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263666856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263666856">(Dec 03 2021 at 23:28)</a>:</h4>
<p>the intrinsic, of course!</p>



<a name="263666872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263666872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263666872">(Dec 03 2021 at 23:28)</a>:</h4>
<p>i'd pick the pointer vector scatter</p>



<a name="263666903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/263666903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#263666903">(Dec 03 2021 at 23:29)</a>:</h4>
<p>I think I agree</p>



<a name="264538141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/264538141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#264538141">(Dec 11 2021 at 03:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D/near/263664674">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> Hey did you ever document the no-other-reference-while-<code>*mut T</code>-is-live thing?</p>
</blockquote>
<p>it's "documented" in all my Stacked Borrows description, but I guess that is not what you mean?</p>



<a name="264538152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/264538152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#264538152">(Dec 11 2021 at 03:27)</a>:</h4>
<p>There is no RFC deciding that these are actually the final rules we will go with, so there isn't much "official" documentation either</p>



<a name="264538322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/264538322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#264538322">(Dec 11 2021 at 03:31)</a>:</h4>
<p>Is it unsound today? I wouldn't be surprised if there aren't many instances of this floating around...</p>



<a name="264539153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/264539153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#264539153">(Dec 11 2021 at 03:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D/near/264538141">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D/near/263664674">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> Hey did you ever document the no-other-reference-while-<code>*mut T</code>-is-live thing?</p>
</blockquote>
<p>it's "documented" in all my Stacked Borrows description, but I guess that is not what you mean?</p>
</blockquote>
<p>I think we were hoping for something in the UCG or something.</p>



<a name="264658234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/264658234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#264658234">(Dec 13 2021 at 02:44)</a>:</h4>
<blockquote>
<p>However, be aware that Miri will not catch all cases of undefined behavior in your program, and cannot run all programs:<br>
   There are still plenty of open questions around the basic invariants for some types and when these invariants even have to hold. Miri tries to avoid false positives here, so if your program runs fine in Miri right now that is by no means a guarantee that it is UB-free when these questions get answered.</p>
</blockquote>



<a name="265030141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265030141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265030141">(Dec 15 2021 at 15:54)</a>:</h4>
<p>the only official thing is that it is UB to "Breaking the pointer aliasing rules. &amp;mut T and &amp;T follow LLVM’s scoped noalias model, except if the &amp;T contains an UnsafeCell&lt;U&gt;." (<a href="https://doc.rust-lang.org/reference/behavior-considered-undefined.html">https://doc.rust-lang.org/reference/behavior-considered-undefined.html</a>)</p>



<a name="265030272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265030272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265030272">(Dec 15 2021 at 15:55)</a>:</h4>
<p>everything else is Stacked Borrows, which is my experiment but not RFC'd or ratified in any way -- so it's not documented outside the resources collected at <a href="https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md">https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md</a> (and its <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues?q=is%3Aissue+is%3Aopen+label%3AT-stacked-borrows">list of issues</a>)</p>



<a name="265030797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265030797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265030797">(Dec 15 2021 at 15:58)</a>:</h4>
<p>and your issue is specifically <a href="https://github.com/rust-lang/unsafe-code-guidelines/issues/133">https://github.com/rust-lang/unsafe-code-guidelines/issues/133</a>, I think, which I hope we can fix in the future</p>



<a name="265040188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265040188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265040188">(Dec 15 2021 at 17:00)</a>:</h4>
<p>I don't see anyone else with a competing model, and all I am getting out of this conversation is "we can't promise we break it, but we shouldn't document that we can't promise we won't break it because what if we make the model more permissive?"<br>
When it is precisely the opposite direction that is forward compatible.</p>



<a name="265041015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265041015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265041015">(Dec 15 2021 at 17:04)</a>:</h4>
<p>My argument is that it's entirely outside of the scope of this project group, we should specify that we follow the same model as regular pointers, and if those are not documented correctly or need a more accurate model that should be done, but not as part of this group</p>



<a name="265041293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265041293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265041293">(Dec 15 2021 at 17:06)</a>:</h4>
<p>Partially because of the scope of this group, and partially because doing it as part of std::simd implies that we handle pointers _differently_ than the rest of rust, which is misleading</p>



<a name="265042068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042068">(Dec 15 2021 at 17:11)</a>:</h4>
<p>I don't care <strong>where</strong> in the compiler the documentation is, I just care that the documentation for a function is as complete and correct as possible for the most obvious use-case. And the most obvious use case has to do with mutable slices and pointers to them. And apparently no one is allowed to document how to interact with mutable slices completely, so we're not going to add an unsafe function that would interact with one.</p>



<a name="265042598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042598">(Dec 15 2021 at 17:15)</a>:</h4>
<p>And just because you didn't know Stacked Borrows may not allow certain things doesn't mean that we handle pointers differently from the rest of Rust. That is a simply fallacious accusation and I have nowhere implied it.</p>



<a name="265042657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042657">(Dec 15 2021 at 17:15)</a>:</h4>
<p>I don't see how something along the lines of "scatter is equivalent to calling ptr::write sequentially" is not as correct as possible?</p>



<a name="265042709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042709">(Dec 15 2021 at 17:15)</a>:</h4>
<p>That's not documenting the actual example.</p>



<a name="265042780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042780">(Dec 15 2021 at 17:16)</a>:</h4>
<p>Which is what I wanted to do after drafting all that.</p>



<a name="265042783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042783">(Dec 15 2021 at 17:16)</a>:</h4>
<p>Stacked borrows is not the current aliasing rule for rust, so if we say we use it, that is handling it differently than the rest of rust.</p>



<a name="265042810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042810">(Dec 15 2021 at 17:16)</a>:</h4>
<p>That is because THERE IS NO ALIASING RULE.</p>



<a name="265042842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042842">(Dec 15 2021 at 17:16)</a>:</h4>
<p>yes unfortunately :(</p>



<a name="265042868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042868">(Dec 15 2021 at 17:17)</a>:</h4>
<p>but also Stacked Borrows isnt ready for an RFC yet</p>



<a name="265042878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042878">(Dec 15 2021 at 17:17)</a>:</h4>
<p>Yes, which still means it's incorrect for us to say we use it.</p>



<a name="265042914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042914">(Dec 15 2021 at 17:17)</a>:</h4>
<p>I feel like whether the stdlib docs should use stacked borrows to give guidance is up to t-libs or t-libs-api</p>



<a name="265042943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042943">(Dec 15 2021 at 17:17)</a>:</h4>
<p>Then we will not add anything to do with aliasing.</p>



<a name="265042951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265042951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265042951">(Dec 15 2021 at 17:17)</a>:</h4>
<p>I would be totally fine with this but I think Id way overstep my competence by making such a decision</p>



<a name="265043067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265043067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265043067">(Dec 15 2021 at 17:18)</a>:</h4>
<p>It is absolutely correct to say it's equivalent to sequential scalar pointer writes, and if those aren't well documented or established, they should be, but that isn't SIMD specific</p>



<a name="265043147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265043147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265043147">(Dec 15 2021 at 17:19)</a>:</h4>
<p>Any function would make it a lot easier to do a lot more of them.</p>



<a name="265043161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265043161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265043161">(Dec 15 2021 at 17:19)</a>:</h4>
<p>I'm not saying there shouldn't be a rule, I'm just saying scatter isn't the place to define it</p>



<a name="265043178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265043178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265043178">(Dec 15 2021 at 17:19)</a>:</h4>
<p>there are some carefully places aliasing-related things in the docs where everyone agreed that whatever the eventual model will be, its likely going to require this. maybe something like that is possible here, not sure. this mostly has to do with converting &amp;T to raw ptrs, casting, and then doing a <code>write</code> though, which is a much clearer situation</p>



<a name="265043209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265043209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265043209">(Dec 15 2021 at 17:19)</a>:</h4>
<p>Which is why I want to include a carefully worked example.</p>



<a name="265043368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265043368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265043368">(Dec 15 2021 at 17:20)</a>:</h4>
<p>maybe this can be solved with different framing? "the aliasing rules arent clear yet, and when naively calling this function it is easy to write code whose well-definedness is ambiguous, so here is some guidance for how to stay clear of such ambiguity"</p>



<a name="265043369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265043369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265043369">(Dec 15 2021 at 17:20)</a>:</h4>
<p>Because it's exposing oneself to the risks of UB 4 times faster.</p>



<a name="265043422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265043422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265043422">(Dec 15 2021 at 17:20)</a>:</h4>
<p>that sounds very different from "do this or else UB" but could still nudge people into the safe(r) corners of the design space</p>



<a name="265043541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265043541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265043541">(Dec 15 2021 at 17:21)</a>:</h4>
<p>I... genuinely don't parse that differently but if that reads differently to everyone else then okay.</p>



<a name="265043545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265043545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265043545">(Dec 15 2021 at 17:21)</a>:</h4>
<p>not sure if scatter is the right place or some module-level docs somewhere, but that seems easy to adjust later</p>



<a name="265043792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265043792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265043792">(Dec 15 2021 at 17:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D/near/265043541">said</a>:</p>
<blockquote>
<p>I... genuinely don't parse that differently but if that reads differently to everyone else then okay.</p>
</blockquote>
<p>it avoids claerly saying that something is UB, and instead says it is insufficiently defined... yeah our terminology sucks but I blame C. :/<br>
"UB" doesnt mean "it has not been defined", it means "it has been carefully defined to not be allowed".</p>



<a name="265044056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265044056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265044056">(Dec 15 2021 at 17:25)</a>:</h4>
<p>To me, the absence of an aliasing rule means that all documentation is equally correct regarding the rule and the only preference is aesthetic, because the only aliasing rule is "false" et ex falso quodlibet. <span aria-label="relaxed" class="emoji emoji-263a" role="img" title="relaxed">:relaxed:</span></p>



<a name="265044543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265044543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265044543">(Dec 15 2021 at 17:28)</a>:</h4>
<p>arent docs mostly about getting the aesthetics right?^^ it's not like they are mathematical formula...</p>



<a name="265044852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265044852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265044852">(Dec 15 2021 at 17:30)</a>:</h4>
<p>i'd argue that the closer they are to specifying exact requirements/guarantees while still being readily understandable the better</p>



<a name="265044926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265044926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265044926">(Dec 15 2021 at 17:31)</a>:</h4>
<p>cuz vagueness is a good way to cause misunderstandings/bugs</p>



<a name="265045108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265045108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265045108">(Dec 15 2021 at 17:32)</a>:</h4>
<p>Well yes, basically. The entire API surface is mostly a matter of aesthetics. We are writing all this code because writing a bunch of assembly is ugly (and thus tedious, hard to maintain, etc.)</p>
<p>But genuinely from a strict, validity-oriented "is this correct?" perspective, I think "colorless green dreams sleep furiously" is valid documentation on what the semantics of the aliasing rules in Rust are.</p>
<p>But I have strong preferences regarding making the documentation helpful to users and making the functions easy to use, and that's why I approached writing the most correct thing from a probabilistic frame.</p>



<a name="265045125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265045125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265045125">(Dec 15 2021 at 17:32)</a>:</h4>
<p>so specifying that scatter is a sequence of <code>if mask { ptr::write(ptr.wrapping_add(index), value) }</code> is a good idea</p>



<a name="265046274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265046274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265046274">(Dec 15 2021 at 17:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D/near/265045108">said</a>:</p>
<blockquote>
<p>But I have strong preferences regarding making the documentation helpful to users and making the functions easy to use, and that's why I approached writing the most correct thing from a probabilistic frame.</p>
</blockquote>
<p>This is also why I don't really care what the documentation of <code>core::ptr</code> is, really, because a lot of users will not follow the outbound link to <code>core::ptr</code>, and most will not care to internalize all that just to call <code>scatter</code>, because of course they "know it's safe", they've done it a thousand times <strong>in assembly, which has fewer constraints by design</strong>.</p>



<a name="265046818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265046818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265046818">(Dec 15 2021 at 17:45)</a>:</h4>
<p>I dont disagre with any of that, as long as the docs do not state that certain things "are (definitely) UB" when that decision has not been made yet. for me this is all about careful wording, and I think the docs can be helpful and precise without saying incorrect things.</p>



<a name="265047061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265047061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265047061">(Dec 15 2021 at 17:46)</a>:</h4>
<p>And yes, I have already literally gotten the objection (and verbal abuse! that was great!) that we shouldn't document scatter as following a sequential left-to-right rule, but should instead in fact say that it works in such a way that it allows a processor to follow any order, so it's UB to write to the same index twice, because optimizations or "that's not how it works in <code>${asm_lang}</code>" or something. <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="265048897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265048897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265048897">(Dec 15 2021 at 17:57)</a>:</h4>
<p>Did we decide that LLVM scatter is left-to-right, but can technically ignore duplicate writes?</p>



<a name="265049204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265049204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265049204">(Dec 15 2021 at 17:59)</a>:</h4>
<p>Yes, that matches the AVX semantics. I am not sure if Arm SVE differs, matching semantics is certainly what their pseudocode implies. I think RVV doesn't either.</p>



<a name="265049214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265049214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265049214">(Dec 15 2021 at 17:59)</a>:</h4>
<p>Unless you're dealing with virtual memory with protection etc I feel like the order doesn't really matter anyway <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="265049261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265049261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265049261">(Dec 15 2021 at 18:00)</a>:</h4>
<p>It only matters if you have a duplicate index.</p>



<a name="265049369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265049369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265049369">(Dec 15 2021 at 18:00)</a>:</h4>
<p>Arm actually allows the processor itself to discard duplicate writes, lol</p>



<a name="265049411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265049411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265049411">(Dec 15 2021 at 18:00)</a>:</h4>
<p>iirc llvm only has to have the final written values be correct, if scatter writes multiple times to the same byte it may elide previous stores -- just like any non-atomic llvm store instruction (simd or not)</p>



<a name="265049442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265049442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265049442">(Dec 15 2021 at 18:00)</a>:</h4>
<p>Though I assume none do that</p>



<a name="265049475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265049475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265049475">(Dec 15 2021 at 18:00)</a>:</h4>
<p>who knows?</p>



<a name="265049518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265049518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265049518">(Dec 15 2021 at 18:00)</a>:</h4>
<p>The Cortex-X2 isn't out yet.<br>
Oh btw that's happening.</p>



<a name="265049585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265049585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265049585">(Dec 15 2021 at 18:01)</a>:</h4>
<p><span class="user-mention" data-user-id="312331">@Caleb Zulawski</span> Consumer hardware with Arm SVE next year, on the fanciest phones.</p>



<a name="265049673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265049673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265049673">(Dec 15 2021 at 18:01)</a>:</h4>
<p>yeah, sorry about my contributions to verbal abuse...</p>



<a name="265049865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265049865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265049865">(Dec 15 2021 at 18:03)</a>:</h4>
<p>eh I have had arguments with people but the person who was just insulting was someone else, that fellow followed up by explicitly denigrating my... lack of HPC experience?</p>



<a name="265050238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265050238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265050238">(Dec 15 2021 at 18:05)</a>:</h4>
<p>llvm removing stores: <a href="https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=0c07586cc6e608442fa6d3cc97857b6e">https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=0c07586cc6e608442fa6d3cc97857b6e</a></p>



<a name="265050721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265050721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265050721">(Dec 15 2021 at 18:08)</a>:</h4>
<p>But yes according to THAT jerk we should in fact not document scatter as equivalent to a for loop of writes, even though afaict no processor implements a different behavior. <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="265051045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265051045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265051045">(Dec 15 2021 at 18:11)</a>:</h4>
<p>OH apparently RVV implements indexed-unordered AND index-ordered.</p>



<a name="265051055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265051055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265051055">(Dec 15 2021 at 18:11)</a>:</h4>
<p>Yeah, even if it's handled in one uop or whatever, it's still sequentially executed...</p>



<a name="265051306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265051306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265051306">(Dec 15 2021 at 18:12)</a>:</h4>
<p>But LLVM still has <code>llvm.masked.scatter</code> use the "AVX-y" reasoning.</p>



<a name="265055653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265055653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265055653">(Dec 15 2021 at 18:43)</a>:</h4>
<p>Not to go all "cut the baby in half" on you two, But I think that you're both mostly correct at the same time.</p>
<ul>
<li>The scatter rules should explain in one sentence that it works as if a series of individual pointer writes indivisibly happened (I'm very carefully not saying "atomic" here). The point of portable simd is to be consistent regardless of hardware so if that's the simple semantics (it is) and that's what LLVM offers (seems that way), then that's what we do</li>
<li><strong>next paragraph:</strong> that's right, this is one of those big multi-paragraph doc comments. After saying the semantic meaning of the function we give an example of using the function and explain why it works and so on.</li>
<li><strong>next paragraph:</strong> we finish out with the thing a lot of description documents do where we explain that the docs are intended to elaborate on how this function interacts with other rules, but that any divergence from the normal rules is fully accidental and unintentional.</li>
</ul>



<a name="265055988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265055988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265055988">(Dec 15 2021 at 18:45)</a>:</h4>
<p>i think we should include in the docs that the pointer written to comes from <code>wrapping_add</code>, cuz that allows setting the pointer to null and the index to a pointer casted to int</p>



<a name="265056454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265056454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265056454">(Dec 15 2021 at 18:49)</a>:</h4>
<p>oh, sure, precisely which method and if null is allowed i don't have much of an opinion on</p>



<a name="265056877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265056877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265056877">(Dec 15 2021 at 18:52)</a>:</h4>
<p>That is an implementation detail and likely to change.</p>



<a name="265058231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265058231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265058231">(Dec 15 2021 at 19:00)</a>:</h4>
<p>I very strongly want it to be guaranteed that setting ptr to null and index to a pointer casted to an int will work, so I think it shouldn't just be an implementation detail</p>



<a name="265058510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265058510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265058510">(Dec 15 2021 at 19:02)</a>:</h4>
<p>that would allow writing to null, which I am pretty sure is UB no matter what way we slice it.</p>



<a name="265058756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265058756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265058756">(Dec 15 2021 at 19:04)</a>:</h4>
<p>I actually looked through the LLVM docs and pointer provenance seems to see through bitcasts too, so I'm not 100% sure it's okay to do that</p>



<a name="265058807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265058807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265058807">(Dec 15 2021 at 19:04)</a>:</h4>
<p>Regarding adds etc</p>



<a name="265058860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265058860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265058860">(Dec 15 2021 at 19:05)</a>:</h4>
<p>yes, sometimes unsoundly, if memory serves.</p>



<a name="265058906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265058906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265058906">(Dec 15 2021 at 19:05)</a>:</h4>
<p>writing to null is always UB, <code>*null_mut().wrapping_add(&amp;mut a as *mut _ as isize) = 1</code>, is always defined</p>



<a name="265059387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265059387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265059387">(Dec 15 2021 at 19:09)</a>:</h4>
<p>This method is supposed to be a convenience for writing to a slice, basically, so while I won't stop you from using it improperly, I won't promise you I won't change it to bite your nose off later, esp. if that would allow picking up missing opts compared to <code>Simd&lt;*mut T&gt;</code></p>



<a name="265059905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265059905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265059905">(Dec 15 2021 at 19:12)</a>:</h4>
<p>i can't imagine why you'd want to offset from null to begin with</p>



<a name="265059964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265059964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265059964">(Dec 15 2021 at 19:13)</a>:</h4>
<p>cuz that lets you construct a poor-man's scatter to vector of pointers</p>



<a name="265059969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265059969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265059969">(Dec 15 2021 at 19:13)</a>:</h4>
<p>It would allow you to store your pointers as a Simd&lt;usize, N&gt;</p>



<a name="265060005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265060005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265060005">(Dec 15 2021 at 19:13)</a>:</h4>
<p>i think we should just... support that properly, the normal way</p>



<a name="265060029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265060029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265060029">(Dec 15 2021 at 19:13)</a>:</h4>
<p>Agreed</p>



<a name="265060037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265060037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265060037">(Dec 15 2021 at 19:13)</a>:</h4>
<p>yes, we will.</p>



<a name="265060256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265060256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265060256">(Dec 15 2021 at 19:15)</a>:</h4>
<p>though, now that i look at the ir, <code>&lt;*mut T&gt;::wrapping_add</code> won't do what I want, what I want is actually <code>(ptr as usize).wrapping_add(idx) as *mut T</code></p>



<a name="265060550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265060550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265060550">(Dec 15 2021 at 19:17)</a>:</h4>
<p>luckily Simd wrapping_add does what I want: <a href="https://github.com/rust-lang/portable-simd/blob/a8385522ade6f67853edac730b5bf164ddb298fd/crates/core_simd/src/vector/ptr.rs#L49">https://github.com/rust-lang/portable-simd/blob/a8385522ade6f67853edac730b5bf164ddb298fd/crates/core_simd/src/vector/ptr.rs#L49</a></p>



<a name="265060745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265060745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265060745">(Dec 15 2021 at 19:19)</a>:</h4>
<p>Yes, that's an impl detail, don't count on it lasting forever. :P<br>
I am okay with changing this fn to accept "a ptr to arbitrary slicelike data structures" for obviously legitimate reasons, but I might change it to use vector gep inbounds.</p>



<a name="265060774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265060774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265060774">(Dec 15 2021 at 19:19)</a>:</h4>
<p>but that requires adding vector gep to the compiler.</p>



<a name="265063274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265063274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265063274">(Dec 15 2021 at 19:37)</a>:</h4>
<p>hm, maybe this is the wrong interface. Scatter should probably be more like Write.</p>



<a name="265063506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265063506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265063506">(Dec 15 2021 at 19:39)</a>:</h4>
<p>Meaning?</p>



<a name="265064633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265064633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265064633">(Dec 15 2021 at 19:45)</a>:</h4>
<p>Not actually sure yet.</p>



<a name="265067586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265067586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265067586">(Dec 15 2021 at 20:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D/near/265060774">said</a>:</p>
<blockquote>
<p>but that requires adding vector gep to the compiler.</p>
</blockquote>
<p>llvm actually has that:<br>
<a href="https://llvm.org/docs/LangRef.html#getelementptr-instruction">https://llvm.org/docs/LangRef.html#getelementptr-instruction</a></p>
<div class="codehilite"><pre><span></span><code>&lt;result&gt; = getelementptr &lt;ty&gt;, &lt;ptr vector&gt; &lt;ptrval&gt;, [inrange] &lt;vector index type&gt; &lt;idx&gt;
</code></pre></div>



<a name="265075069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265075069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265075069">(Dec 15 2021 at 21:06)</a>:</h4>
<p>yeah, we just gotta emit it.</p>



<a name="265244186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265244186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265244186">(Dec 17 2021 at 01:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D/near/265063506">said</a>:</p>
<blockquote>
<p>Meaning?</p>
</blockquote>
<p>it means that it must start and end in the same allocated object (so the example using ptr::null_mut() would be ub)</p>



<a name="265360574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265360574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265360574">(Dec 17 2021 at 21:07)</a>:</h4>
<p>That may have been about my "maybe Scatter should be more like the Write trait..." thing.</p>



<a name="265362310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265362310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265362310">(Dec 17 2021 at 21:22)</a>:</h4>
<p>Yeah, that lol</p>



<a name="265362740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265362740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265362740">(Dec 17 2021 at 21:26)</a>:</h4>
<p>Basically what the whispering in my ear said is that Scatter should be a trait for various types and user-implementable, and basically be <code>std::simd::Write</code>, and that <code>std::simd</code> should offer a couple of low-level implementation primitives for implementing Scatter with.</p>



<a name="265362848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265362848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265362848">(Dec 17 2021 at 21:27)</a>:</h4>
<p>So that <code>container.scatter(indices, vector)</code> could correctly hit indices in like, B-Trees or linked lists.</p>



<a name="265363052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265363052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265363052">(Dec 17 2021 at 21:29)</a>:</h4>
<p>neat idea!</p>



<a name="265363952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265363952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265363952">(Dec 17 2021 at 21:37)</a>:</h4>
<p>And the implementation for slices would be incredibly obvious and we'd just <strong>do it</strong> for [T], [MaybeUninit&lt;T&gt;], etc.</p>



<a name="265364249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265364249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265364249">(Dec 17 2021 at 21:40)</a>:</h4>
<p>hmm, what would you do for scatter to vector of pointers? just have a separate method?</p>



<a name="265364299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265364299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265364299">(Dec 17 2021 at 21:41)</a>:</h4>
<p>hmm?</p>



<a name="265364473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265364473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265364473">(Dec 17 2021 at 21:43)</a>:</h4>
<p><code>impl&lt;...&gt; Simd&lt;*mut T, N&gt; { pub unsafe fn scatter(self, values: Simd&lt;T, N&gt;, mask: Mask&lt;isize, N&gt;) {...} }</code></p>



<a name="265364591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter%20to%20%5BMaybeUninit%3CT%3E%5D/near/265364591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.20to.20.5BMaybeUninit.3CT.3E.5D.html#265364591">(Dec 17 2021 at 21:44)</a>:</h4>
<p>would be the only exception, cuz it doesn't really fit into your fancy scatter trait</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>