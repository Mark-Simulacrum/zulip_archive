<html>
<head><meta charset="utf-8"><title>Unsafe/unchecked shifts · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html">Unsafe/unchecked shifts</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268931392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931392">(Jan 22 2022 at 02:47)</a>:</h4>
<p>Heya! I was wondering if there's any ideas/plans to make an unsafe/unchecked shift. I have a pretty dense loop with a lot of shifts and the overshift checks are adding a lot of branches. Sadly a lot of the variables are provably constrained to &lt;word size, but I can't convince the compiler about that. Was maybe thinking of adding an unsafe/unchecked shift which requires the user to constrain the inputs themselves?</p>



<a name="268931700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931700">(Jan 22 2022 at 02:54)</a>:</h4>
<p>It hasn't been synced to nightly yet, but soon shifts won't have any branches, and will instead wrap</p>



<a name="268931711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931711">(Jan 22 2022 at 02:54)</a>:</h4>
<p>So it won't be quite as fast as completely unchecked necessarily, but should be much better</p>



<a name="268931736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931736">(Jan 22 2022 at 02:55)</a>:</h4>
<p>I might like to have both wraps and overshifting. I know AVX-512 overshifts to zeros and I use some of those semantics.</p>



<a name="268931796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931796">(Jan 22 2022 at 02:56)</a>:</h4>
<p>I think the only way to do this would be to have a wrapping (&amp; WORD-1) and overshifting implementation that maybe are specialized to do the cheap version on hardware? Like in my case I know I'm only really going to run compute on AVX, but it's still _nice_ to be able to share/use my code on different machines</p>



<a name="268931810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931810">(Jan 22 2022 at 02:56)</a>:</h4>
<p>Idk if LLVM is smart enough to know that behavior and handle the specialization if you just write naive implementations for both</p>



<a name="268931825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931825">(Jan 22 2022 at 02:57)</a>:</h4>
<p>Yeah I haven't looked into it to that extent</p>



<a name="268931830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931830">(Jan 22 2022 at 02:57)</a>:</h4>
<p>Sadly the defined behavior varies so much by arch that without tuning I'd expect emulated wrapping on x86 would lead to an additional and for every single shift</p>



<a name="268931847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931847">(Jan 22 2022 at 02:57)</a>:</h4>
<p>We could likely add functions for both, but it's also confusing because they're negligibly different and I'm not sure which should be the default</p>



<a name="268931926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931926">(Jan 22 2022 at 02:59)</a>:</h4>
<p>Yeah, it's an additional and, which is at least an improvement over branching</p>



<a name="268931931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931931">(Jan 22 2022 at 02:59)</a>:</h4>
<p>Yeah, it's kinda tough. I'd just do whatever Rust has done as default for scalar things, make the other one an option. It's tough cause I have some really dense integer and bitwise logic that I'm really keeping my eyes on the codegen right now</p>



<a name="268931934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268931934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268931934">(Jan 22 2022 at 02:59)</a>:</h4>
<p>absolutely</p>



<a name="268932041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932041">(Jan 22 2022 at 03:00)</a>:</h4>
<p>I might just rearchitect my code such that LLVM sees the creation of the shift amount (and will provably know it's in bounds), but to get good code reuse I'd have to use macros for that</p>



<a name="268932085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932085">(Jan 22 2022 at 03:01)</a>:</h4>
<p>I'm really pushing the limits here with codegen, I'm replacing some pretty specialized handwritten asm and so far the LLVM code is generically better (eg. better use of complex instructions and pipelining) but has some warts with checking things that I know are provable as a developer</p>



<a name="268932168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932168">(Jan 22 2022 at 03:02)</a>:</h4>
<p>An assert before the loop might help hint to LLVM that it's within bounds too</p>



<a name="268932171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932171">(Jan 22 2022 at 03:02)</a>:</h4>
<p>stdsimd is just so huge for me because I target some pretty heavy AVX-512 compute, but it sucks that I can't share my code with people. So I'm really trying to keep both the perf, but also portability</p>



<a name="268932195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932195">(Jan 22 2022 at 03:02)</a>:</h4>
<p>Yeah, I wanted to do that but sadly the assert is then checked and adds the branch there. I really need like <code>unsafe_assert!()</code> that tells the compiler that the expression is true,</p>



<a name="268932215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932215">(Jan 22 2022 at 03:03)</a>:</h4>
<p>The problem is the shift amount is computed in a function, then cached in a <code>Guard</code> variable, and when laundered through memory LLVM believes it to be unconstrained</p>



<a name="268932277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932277">(Jan 22 2022 at 03:04)</a>:</h4>
<p>If you want to try something slightly silly,</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(u32)]</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">ShiftAmount32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_0</span><span class="p">,</span><span class="w"> </span><span class="n">_1</span><span class="p">,</span><span class="w"> </span><span class="n">_2</span><span class="p">,</span><span class="w"> </span><span class="n">_3</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">.,</span><span class="w"> </span><span class="n">_31</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Dunno if it'd work, but rustc will put range metadata on the <code>load</code>.</p>



<a name="268932311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932311">(Jan 22 2022 at 03:05)</a>:</h4>
<p>Actually yeah, this might work really well. Should have lossless conversion into this at store time since the compiler will know the constraints when the variable is stored</p>



<a name="268932434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932434">(Jan 22 2022 at 03:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="356799">Brandon Falk</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts/near/268932195">said</a>:</p>
<blockquote>
<p>I really need like <code>unsafe_assert!()</code> that tells the compiler that the expression is true,</p>
</blockquote>
<p>For experimentation you could try <code>std::intrinsics::assume</code> on nightly.</p>
<p>If that works, then you could consider <code>if !(whatever_you_expect) { unsafe { std::hint::unreachable_unchecked() } }</code> for <code>unsafe_assert!</code>.</p>



<a name="268932523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932523">(Jan 22 2022 at 03:08)</a>:</h4>
<p>For some reason I feel I remember that unreachable unchecked would sometimes throw in a ud2, but probably not in this case, I'll play with it<br>
Right now I'm usually okay with a 10x inflation of code to get away without <code>unsafe</code> so I'll probably try the enum first</p>



<a name="268932543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932543">(Jan 22 2022 at 03:09)</a>:</h4>
<p>I use <code>rg unsafe</code> when I audit my code, the fewer thigns to check during audits the better</p>



<a name="268932644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932644">(Jan 22 2022 at 03:11)</a>:</h4>
<p>For experimenting, <code>-Z trap-unreachable=no</code> will make it not put the <code>ud2</code>s.</p>



<a name="268932648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932648">(Jan 22 2022 at 03:11)</a>:</h4>
<p>TIL, thanks!</p>



<a name="268932995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268932995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268932995">(Jan 22 2022 at 03:18)</a>:</h4>
<p>But kudos for sticking to safe code.  It's impressive what LLVM can do these days.  (My favourite example recently is removing the manual vectorization in favour of safe code, and it actually being faster in <a href="https://github.com/rust-lang/rust/issues/90821">#90821</a> )</p>



<a name="268933020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268933020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268933020">(Jan 22 2022 at 03:19)</a>:</h4>
<p>Yeah, I've spent most of the past ~10 years of dev looking at the codegen, I've gotten weirdly good at coercing the compiler to do things. That's what I think safe code is, just making things computable enough for the compiler and holding it's hand a bit.</p>



<a name="268933074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268933074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268933074">(Jan 22 2022 at 03:20)</a>:</h4>
<p>I wrote a md5 implementation with stdsimd using naive bitwise operations and LLVM correctly generates the <code>ternlogd</code> constants for the ternary ops and it feels so good</p>



<a name="268933118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268933118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268933118">(Jan 22 2022 at 03:21)</a>:</h4>
<p>This new project is effectively a generic emulator in stdsimd where you specify <code>IL&lt;word size, lanes&gt;</code> and so far there have been some hiccups but it's been expressible. That being said, it's some extremely dense/hard code. I have to use a lot of macros to keep code reuse up since the bug risk is so high I can't duplicate code like I might in some situations</p>



<a name="268933179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268933179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268933179">(Jan 22 2022 at 03:22)</a>:</h4>
<p>Definitely a lot of fun! Just wrote the memory manager last night and replaced my naive (testing) implementation, scalar assembly implementation, and vector assembly implementation with a single stdsimd implementation that can be either scalar or vector, and has the upside of being safe code and much easier to test/fix than handwritten asm</p>



<a name="268933196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268933196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268933196">(Jan 22 2022 at 03:23)</a>:</h4>
<p>This is the brainchild of about 3 years of thinking, just finally putting pen to paper. The time to write this is not a concern to me, so I'm trying to pull out all the coding stops :D</p>



<a name="268934335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268934335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268934335">(Jan 22 2022 at 03:49)</a>:</h4>
<p>Whoa, it kind of works<br>
<a href="https://rust.godbolt.org/z/b5or3WGoh">https://rust.godbolt.org/z/b5or3WGoh</a></p>



<a name="268934355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268934355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268934355">(Jan 22 2022 at 03:49)</a>:</h4>
<p>Weirdly, going to a wider lane size or smaller element size leads to really bad code gen. <code>u8,8</code> produces scalar code with branches it's absolutely terrible hmm</p>



<a name="268934409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268934409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268934409">(Jan 22 2022 at 03:50)</a>:</h4>
<p>Feels like it's probably expanding inside LLVM, hitting an unroll limit, and collapsing. OH. I think I know what this is. This is the way the bounds are checked I think</p>



<a name="268934441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268934441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268934441">(Jan 22 2022 at 03:51)</a>:</h4>
<div class="codehilite" data-code-language="#"><pre><span></span><code>                    fn shl(self, rhs: Self) -&gt; Self::Output {
                        // TODO there is probably a better way of doing this
                        if rhs.as_array()
                            .iter()
                            .copied()
                            .any(invalid_shift_rhs)
                        {
                            panic!("attempt to shift left with overflow");
                        }
                        unsafe { intrinsics::simd_shl(self, rhs) }
                    }```
</code></pre></div>



<a name="268934453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268934453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268934453">(Jan 22 2022 at 03:52)</a>:</h4>
<p>Yeah, I'll look at the new code. The to_array() check I would imagine expands inside LLVM and probably puts some major pressure on some of the constant limits of unroll/optimization depths for certain things</p>



<a name="268934500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268934500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268934500">(Jan 22 2022 at 03:52)</a>:</h4>
<p>I'm surprised it can't do this for <code>u8, 8</code></p>



<a name="268934524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268934524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268934524">(Jan 22 2022 at 03:53)</a>:</h4>
<p><code>u16, 32</code> emits a call to core simd shift ops, oooof</p>



<a name="268934614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268934614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268934614">(Jan 22 2022 at 03:54)</a>:</h4>
<p>Oh wow yeah <code>u16, 32</code> is unusable codegen LOL</p>



<a name="268934625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268934625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268934625">(Jan 22 2022 at 03:54)</a>:</h4>
<div class="codehilite" data-code-language="example"><pre><span></span><code>        push    rbp
        mov     rbp, rsp
        push    rbx
        and     rsp, -64
        sub     rsp, 128
        mov     rbx, rdi
        vmovaps zmm0, zmmword ptr [rdx]
        movzx   eax, byte ptr [rsi]
        vpbroadcastw    zmm1, eax
        vmovdqa64       zmmword ptr [rsp], zmm1
        mov     rsi, rsp
        call    core::core_simd::ops::&lt;impl core::ops::bit::Shl for core::core_simd::vector::Simd&lt;u16,_&gt;&gt;::shl
        mov     rax, rbx
        lea     rsp, [rbp - 8]
        pop     rbx
        pop     rbp
        vzeroupper
        ret

core::core_simd::ops::&lt;impl core::ops::bit::Shl for core::core_simd::vector::Simd&lt;u16,_&gt;&gt;::shl:
        sub     rsp, 56
        cmp     word ptr [rsi], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 2], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 4], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 6], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 8], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 10], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 12], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 14], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 16], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 18], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 20], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 22], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 24], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 26], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 28], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 30], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 32], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 34], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 36], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 38], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 40], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 42], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 44], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 46], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 48], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 50], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 52], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 54], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 56], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 58], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 60], 15
        ja      .LBB4_33
        cmp     word ptr [rsi + 62], 15
        ja      .LBB4_33
        vpsllvw zmm0, zmm0, zmmword ptr [rsi]
        vmovdqa64       zmmword ptr [rdi], zmm0
        add     rsp, 56
        vzeroupper
        ret
.LBB4_33:
        lea     rax, [rip + .L__unnamed_1]
        mov     qword ptr [rsp + 8], rax
        mov     qword ptr [rsp + 16], 1
        mov     qword ptr [rsp + 24], 0
        lea     rax, [rip + .L__unnamed_2]
        mov     qword ptr [rsp + 40], rax
        mov     qword ptr [rsp + 48], 0
        lea     rsi, [rip + .L__unnamed_3]
        lea     rdi, [rsp + 8]
        vzeroupper
        call    qword ptr [rip + core::panicking::panic_fmt@GOTPCREL]
        ud2
</code></pre></div>



<a name="268937052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268937052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268937052">(Jan 22 2022 at 04:50)</a>:</h4>
<p>Looks like this is all fixed with the new semantics of masking with the git version of portable simd :D</p>



<a name="268937150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268937150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268937150">(Jan 22 2022 at 04:52)</a>:</h4>
<p>And gets removed with the <code>ShiftAmount</code> enum as well, so that's a reasonable workaround for removing the and</p>



<a name="268942648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268942648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268942648">(Jan 22 2022 at 07:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="356799">Brandon Falk</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts/near/268931736">said</a>:</p>
<blockquote>
<p>I might like to have both wraps and overshifting. I know AVX-512 overshifts to zeros and I use some of those semantics.</p>
</blockquote>
<p>Well "overshifting" for <code>simd_shl</code> is just UB unforch.</p>



<a name="268942724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268942724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268942724">(Jan 22 2022 at 07:11)</a>:</h4>
<p>We can offer unchecked shifts entirely, but those would be UB to shift also. There's no portable LLVM-level way to define the "overshift specifically with the x86/Arm dynamic shift semantics (and ignoring the one weird case Arm allows)".</p>



<a name="268943288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268943288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268943288">(Jan 22 2022 at 07:25)</a>:</h4>
<p>Yeah, this is a tough one. I might try to implement both in a way that LLVM can optimize one of them into the native behaviors or something.</p>



<a name="268943447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268943447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268943447">(Jan 22 2022 at 07:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="356799">Brandon Falk</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts/near/268931830">said</a>:</p>
<blockquote>
<p>Sadly the defined behavior varies so much by arch that without tuning I'd expect emulated wrapping on x86 would lead to an additional and for every single shift</p>
</blockquote>
<p>Our <strong>hope</strong> is at least that, in code with tight, repeated shifts, duplicate <code>AND</code>s get wiped away, and that in some cases, where the shift is constant, it actually guarantees the const folding into the assembly form with an immediate instead of the register operand.</p>



<a name="268943523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268943523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268943523">(Jan 22 2022 at 07:31)</a>:</h4>
<p>But we're not against an <code>unchecked_shl</code>, it just was clearly unacceptable for the default shifts to be panicking <strong>or</strong> unsafe.</p>



<a name="268943892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268943892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268943892">(Jan 22 2022 at 07:42)</a>:</h4>
<p>(also unrelated, is there a good way to go from <code>Simd&lt;u16, 32&gt;</code> to <code>Simd&lt;i16, 32&gt;</code> and vice versa)</p>



<a name="268944035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268944035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268944035">(Jan 22 2022 at 07:46)</a>:</h4>
<p><code>a.to_array().map(|x| x as Target).into()</code> seems to be acceptable</p>



<a name="268944725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268944725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268944725">(Jan 22 2022 at 08:02)</a>:</h4>
<p>if that's gonna compile to nothing, cool</p>



<a name="268945440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/268945440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#268945440">(Jan 22 2022 at 08:21)</a>:</h4>
<p>Oh we have real casts now, we should add those.</p>



<a name="269648195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269648195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269648195">(Jan 27 2022 at 22:15)</a>:</h4>
<p>Soon:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">uints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Simd</span>::<span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="o">&gt;</span>::<span class="n">splat</span><span class="p">(</span><span class="kt">u16</span>::<span class="n">MAX</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">ints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uints</span><span class="p">.</span><span class="n">cast</span>::<span class="o">&lt;</span><span class="kt">i16</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="fm">assert_eq!</span><span class="p">(</span><span class="n">ints</span><span class="p">,</span><span class="w"> </span><span class="n">Simd</span>::<span class="n">splat</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="fm">assert_eq!</span><span class="p">(</span><span class="n">uints</span><span class="p">,</span><span class="w"> </span><span class="n">ints</span><span class="p">.</span><span class="n">cast</span><span class="p">());</span><span class="w"></span>
</code></pre></div>
<p>It turns out the <code>map</code> version is OK but not always optimal when it's e.g. float conversions (which can be costly), As Expected, so <code>cast</code> should always be the best LLVM can do (within Rust-like semantics), and is much more succinct besides.</p>



<a name="269654169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269654169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269654169">(Jan 27 2022 at 23:05)</a>:</h4>
<p>(array::map is also sadly much less nice than it should be.  there's a bunch of codegen issues that currently LLVM can't remove.  hopefully we'll get through that eventually, but even once it's fixed it's good to have the cast API)</p>



<a name="269685392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269685392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269685392">(Jan 28 2022 at 04:32)</a>:</h4>
<p>so is <code>cast</code> like "as" in that it attempts to give an approximately similar numeric value?</p>



<a name="269685395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269685395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269685395">(Jan 28 2022 at 04:32)</a>:</h4>
<p>it's not a bit-preserving operation?</p>



<a name="269685467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269685467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269685467">(Jan 28 2022 at 04:34)</a>:</h4>
<p>It's identical to calling <code>as</code> on each lane</p>



<a name="269685482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269685482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269685482">(Jan 28 2022 at 04:34)</a>:</h4>
<p>then can we please not call it <code>cast</code></p>



<a name="269703610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269703610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269703610">(Jan 28 2022 at 08:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts/near/269685482">said</a>:</p>
<blockquote>
<p>then can we please not call it <code>cast</code></p>
</blockquote>
<p>Unfortunately Rust doesn't allow <code>as</code> for a method name.<br>
We really did beat that one around for a while and struggled to find a better name.</p>



<a name="269704141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269704141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269704141">(Jan 28 2022 at 08:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts/near/269685482">said</a>:</p>
<blockquote>
<p>then can we please not call it <code>cast</code></p>
</blockquote>
<p>i think cast is a good name tbh. why do you think its bad?</p>



<a name="269704793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269704793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269704793">(Jan 28 2022 at 08:57)</a>:</h4>
<p>It also <strong>is</strong> a bit-preserving operation between signed and unsigned integers of the same width.</p>



<a name="269758571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269758571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269758571">(Jan 28 2022 at 16:03)</a>:</h4>
<p>I actually already know about <code>as</code> not being allowed because I wanted to use it with <code>bytemuck</code> and then I unfortunately could not. Which is why I used <code>cast</code> there. That one is a pure bit-cast that can always be round-tripped. Also we have the pointer cast method, which can be round-tripped.</p>
<p>While it's true that int/uint preserves bits and thus always round-trips, the int/float path does not.</p>
<p>It's not a super big deal, but if there's any alternative word we could use (perhaps <code>convert</code>?) then I just feel that it would be better than cast.</p>



<a name="269765017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269765017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269765017">(Jan 28 2022 at 16:49)</a>:</h4>
<p>I... think bytemuck is probably the one in the wrong about using <code>cast</code> for a pure bitcast. In most other languages casting is like <code>as</code>, in that its potentially lossy (for floats and such).</p>



<a name="269769702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269769702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269769702">(Jan 28 2022 at 17:19)</a>:</h4>
<p>could be the case</p>



<a name="269786494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269786494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269786494">(Jan 28 2022 at 19:07)</a>:</h4>
<p><code>static_cast</code> in C++ is a terrible name, but <code>reinterpret_cast</code> for the "always just preserves bits" casts is a name I kinda like.</p>
<p>I could go for the safe transmute stuff being <code>mem::reinterpret</code> or something.</p>



<a name="269787722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269787722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269787722">(Jan 28 2022 at 19:15)</a>:</h4>
<p>reinterpret_cast is actually not bit-preserving for floats. bit_cast is the one that is.</p>



<a name="269787740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269787740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269787740">(Jan 28 2022 at 19:15)</a>:</h4>
<p>which is an example of the name being terrible again, yes.</p>



<a name="269787913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269787913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269787913">(Jan 28 2022 at 19:16)</a>:</h4>
<p>(reinterpret_cast is only actually reinterpretation for integers and pointers, but even then you're not actually allowed to look at the pointee bits after reinterpreting them. its just a bad scene)</p>



<a name="269788242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269788242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269788242">(Jan 28 2022 at 19:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts/near/269787722">said</a>:</p>
<blockquote>
<p>reinterpret_cast is actually not bit-preserving for floats. bit_cast is the one that is.</p>
</blockquote>
<p>Ah, C++.  Where even the new better things are still weird <span aria-label="cry" class="emoji emoji-1f622" role="img" title="cry">:cry:</span></p>



<a name="269799616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269799616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269799616">(Jan 28 2022 at 20:43)</a>:</h4>
<p>Personally, my only concern with the name <code>cast</code> is whether it'd conflict with the same transmute work or similar future replacements for <code>as</code>, yeah. And in theory, if safe transmute <em>did</em> want to use that name, we could just make that handle this case too.</p>



<a name="269812305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269812305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269812305">(Jan 28 2022 at 22:30)</a>:</h4>
<p>Mm, I'd rather split another method off for the saturating float conversions.</p>



<a name="269817354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269817354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick12 <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269817354">(Jan 28 2022 at 23:22)</a>:</h4>
<blockquote>
<p>with the same transmute work</p>
</blockquote>
<p>Is "same" here a typo for safe?</p>



<a name="269828410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/269828410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#269828410">(Jan 29 2022 at 01:39)</a>:</h4>
<p>since "safe transmute" was written later in the same post, i assume so</p>



<a name="271896016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Unsafe/unchecked%20shifts/near/271896016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts.html#271896016">(Feb 14 2022 at 22:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="356799">Brandon Falk</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Unsafe.2Funchecked.20shifts/near/268931392">said</a>:</p>
<blockquote>
<p>Heya! I was wondering if there's any ideas/plans to make an unsafe/unchecked shift. I have a pretty dense loop with a lot of shifts and the overshift checks are adding a lot of branches. Sadly a lot of the variables are provably constrained to &lt;word size, but I can't convince the compiler about that. Was maybe thinking of adding an unsafe/unchecked shift which requires the user to constrain the inputs themselves?</p>
</blockquote>
<p>Have these branches been addressed by the latest versions in <code>std</code>?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>