<html>
<head><meta charset="utf-8"><title>Hooray stdsimd! · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hooray.20stdsimd!.html">Hooray stdsimd!</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262915632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hooray%20stdsimd%21/near/262915632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hooray.20stdsimd!.html#262915632">(Nov 28 2021 at 07:48)</a>:</h4>
<p>Congrats all for getting this in nightly.  I used it in <a href="https://users.rust-lang.org/t/converting-a-bgra-u8-to-rgb-u8-n-for-images/67938/12?u=scottmcm">https://users.rust-lang.org/t/converting-a-bgra-u8-to-rgb-u8-n-for-images/67938/12?u=scottmcm</a> and it proved an excellent solution -- easily to write, and wonderfully adapted for different target-cpus.</p>
<p>(Well, great once I realized how to do a shuffle -- my first version used <code>scatter</code> and was <em>way</em> worse than the naïve scalar code.)</p>



<a name="262916216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hooray%20stdsimd%21/near/262916216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hooray.20stdsimd!.html#262916216">(Nov 28 2021 at 08:05)</a>:</h4>
<div class="codehilite" data-code-language="ActionScript"><pre><span></span><code><span class="nx">example</span><span class="o">::</span><span class="nx">convert_via_std_simd_swizzle</span><span class="o">:</span> <span class="o">;</span> <span class="nx">SSSE3</span>
        <span class="nx">movdqu</span>  <span class="nx">xmm0</span><span class="o">,</span> <span class="nx">xmmword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="nx">rdi</span><span class="p">]</span>
        <span class="nx">pshufb</span>  <span class="nx">xmm0</span><span class="o">,</span> <span class="nx">xmmword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="nx">rip</span> <span class="o">+</span> <span class="p">.</span><span class="nx">LCPI2_0</span><span class="p">]</span>
        <span class="nx">movq</span>    <span class="nx">rax</span><span class="o">,</span> <span class="nx">xmm0</span>
        <span class="nx">pshufd</span>  <span class="nx">xmm0</span><span class="o">,</span> <span class="nx">xmm0</span><span class="o">,</span> <span class="mi">238</span>
        <span class="nx">movq</span>    <span class="nx">rdx</span><span class="o">,</span> <span class="nx">xmm0</span>
        <span class="nx">ret</span>
</code></pre></div>
<div class="codehilite" data-code-language="ActionScript"><pre><span></span><code><span class="nx">example</span><span class="o">::</span><span class="nx">convert_via_std_simd_swizzle</span><span class="o">:</span> <span class="o">;</span><span class="nx">SSE4</span><span class="p">.</span><span class="mi">2</span>
        <span class="nx">movdqu</span>  <span class="nx">xmm0</span><span class="o">,</span> <span class="nx">xmmword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="nx">rdi</span><span class="p">]</span>
        <span class="nx">pshufb</span>  <span class="nx">xmm0</span><span class="o">,</span> <span class="nx">xmmword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="nx">rip</span> <span class="o">+</span> <span class="p">.</span><span class="nx">LCPI2_0</span><span class="p">]</span>
        <span class="nx">movq</span>    <span class="nx">rax</span><span class="o">,</span> <span class="nx">xmm0</span>
        <span class="nx">pextrq</span>  <span class="nx">rdx</span><span class="o">,</span> <span class="nx">xmm0</span><span class="o">,</span> <span class="mi">1</span>
        <span class="nx">ret</span>
</code></pre></div>
<div class="codehilite" data-code-language="ActionScript"><pre><span></span><code><span class="nx">example</span><span class="o">::</span><span class="nx">convert_via_std_simd_swizzle</span><span class="o">:</span> <span class="o">;</span> <span class="nx">AVX</span>
        <span class="nx">vmovdqu</span> <span class="nx">xmm0</span><span class="o">,</span> <span class="nx">xmmword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="nx">rdi</span><span class="p">]</span>
        <span class="nx">vpshufb</span> <span class="nx">xmm0</span><span class="o">,</span> <span class="nx">xmm0</span><span class="o">,</span> <span class="nx">xmmword</span> <span class="nx">ptr</span> <span class="p">[</span><span class="nx">rip</span> <span class="o">+</span> <span class="p">.</span><span class="nx">LCPI2_0</span><span class="p">]</span>
        <span class="nx">vmovq</span>   <span class="nx">rax</span><span class="o">,</span> <span class="nx">xmm0</span>
        <span class="nx">vpextrq</span> <span class="nx">rdx</span><span class="o">,</span> <span class="nx">xmm0</span><span class="o">,</span> <span class="mi">1</span>
        <span class="nx">ret</span>
</code></pre></div>
<p>bwahaha... but wait, there's more.</p>
<div class="codehilite" data-code-language="ActionScript"><pre><span></span><code><span class="nx">example</span><span class="o">::</span><span class="nx">convert_via_std_simd_swizzle</span><span class="o">:</span> <span class="o">;</span> <span class="nx">AArch64</span> <span class="nx">Neon</span>
        <span class="nx">adrp</span>    <span class="nx">x8</span><span class="o">,</span> <span class="p">.</span><span class="nx">LCPI2_0</span>
        <span class="nx">ldr</span>     <span class="nx">q0</span><span class="o">,</span> <span class="p">[</span><span class="nx">x0</span><span class="p">]</span>
        <span class="nx">ldr</span>     <span class="nx">q1</span><span class="o">,</span> <span class="p">[</span><span class="nx">x8</span><span class="o">,</span> <span class="o">:</span><span class="nx">lo12</span><span class="o">:</span><span class="p">.</span><span class="nx">LCPI2_0</span><span class="p">]</span>
        <span class="nx">tbl</span>     <span class="nx">v0</span><span class="p">.</span><span class="mi">16</span><span class="nx">b</span><span class="o">,</span> <span class="p">{</span> <span class="nx">v0</span><span class="p">.</span><span class="mi">16</span><span class="nx">b</span> <span class="p">}</span><span class="o">,</span> <span class="nx">v1</span><span class="p">.</span><span class="mi">16</span><span class="nx">b</span>
        <span class="nx">mov</span>     <span class="nx">x1</span><span class="o">,</span> <span class="nx">v0</span><span class="p">.</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nx">fmov</span>    <span class="nx">x0</span><span class="o">,</span> <span class="nx">d0</span>
        <span class="nx">ret</span>
</code></pre></div>



<a name="262916472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hooray%20stdsimd%21/near/262916472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hooray.20stdsimd!.html#262916472">(Nov 28 2021 at 08:13)</a>:</h4>
<p>all of those have the issue that the calling convention requires the returned array be in integer registers, requiring several more instructions just to move from vector to integer registers...most actual applications of the function, when inlined, would just compute directly in the vector registers and store the result directly, no <code>movq rax, xmm0</code> or equivalent necessary</p>



<a name="262916576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hooray%20stdsimd%21/near/262916576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hooray.20stdsimd!.html#262916576">(Nov 28 2021 at 08:16)</a>:</h4>
<p>true, it's pretty to look at all the vectors tho'.</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nl">example_convert_via_std_simd_swizzle:</span> <span class="c1">; PowerPC64 with Altivec and VSX</span>
        <span class="na">.quad</span>   <span class="no">.Lfunc_begin2</span>
        <span class="na">.quad</span>   <span class="no">.TOC.@tocbase</span>
        <span class="na">.quad</span>   <span class="mi">0</span>
<span class="nl">.Lfunc_begin2:</span>
        <span class="nf">li</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span>
        <span class="nf">lvsl</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span>
        <span class="nf">lvx</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
        <span class="nf">lvx</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span>
        <span class="nf">addis</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="no">.LCPI2_0@toc@ha</span>
        <span class="nf">addi</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="no">.LCPI2_0@toc@l</span>
        <span class="nf">vperm</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span>
        <span class="nf">lxvw4x</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span>
        <span class="nf">addi</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">-16</span>
        <span class="nf">vperm</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span>
        <span class="nf">stxvd2x</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span>
        <span class="nf">ld</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">-8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nf">ld</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">-16</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nf">rotldi</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">32</span>
        <span class="nf">rldimi</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span>
        <span class="nf">rldicl</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span>
        <span class="nf">blr</span>
        <span class="na">.long</span>   <span class="mi">0</span>
        <span class="na">.quad</span>   <span class="mi">0</span>
</code></pre></div>



<a name="262916962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hooray%20stdsimd%21/near/262916962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hooray.20stdsimd!.html#262916962">(Nov 28 2021 at 08:28)</a>:</h4>
<p>i'd expect that to shrink to 4 instructions with SimpleV: <code>setvli</code> to set the vector length, <code>sv.lbu</code> to load the byte vector, <code>sv.shufflei</code> shuffle with immediate, and <code>blr</code> return</p>



<a name="262922277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hooray%20stdsimd%21/near/262922277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hooray.20stdsimd!.html#262922277">(Nov 28 2021 at 10:59)</a>:</h4>
<p>I was particularly impressed that this base-x64-target monstrosity actually performed great in CAD97's benchmarking:</p>
<div class="codehilite" data-code-language="NASM"><pre><span></span><code><span class="nl">example:</span><span class="err">:</span><span class="nl">convert_via_std_simd_swizzle:</span>
        <span class="nf">movdqu</span>  <span class="nv">xmm0</span><span class="p">,</span> <span class="nv">xmmword</span> <span class="nv">ptr</span> <span class="p">[</span><span class="nb">rdi</span><span class="p">]</span>
        <span class="nf">pxor</span>    <span class="nv">xmm1</span><span class="p">,</span> <span class="nv">xmm1</span>
        <span class="nf">movdqa</span>  <span class="nv">xmm2</span><span class="p">,</span> <span class="nv">xmm0</span>
        <span class="nf">punpcklbw</span>       <span class="nv">xmm2</span><span class="p">,</span> <span class="nv">xmm1</span>
        <span class="nf">pshufd</span>  <span class="nv">xmm3</span><span class="p">,</span> <span class="nv">xmm2</span><span class="p">,</span> <span class="mi">212</span>
        <span class="nf">pshufhw</span> <span class="nv">xmm3</span><span class="p">,</span> <span class="nv">xmm3</span><span class="p">,</span> <span class="mi">237</span>
        <span class="nf">punpckhbw</span>       <span class="nv">xmm0</span><span class="p">,</span> <span class="nv">xmm1</span>
        <span class="nf">pshufd</span>  <span class="nv">xmm1</span><span class="p">,</span> <span class="nv">xmm0</span><span class="p">,</span> <span class="mi">108</span>
        <span class="nf">pshuflw</span> <span class="nv">xmm1</span><span class="p">,</span> <span class="nv">xmm1</span><span class="p">,</span> <span class="mi">232</span>
        <span class="nf">pshufd</span>  <span class="nv">xmm1</span><span class="p">,</span> <span class="nv">xmm1</span><span class="p">,</span> <span class="mi">216</span>
        <span class="nf">pshufhw</span> <span class="nv">xmm4</span><span class="p">,</span> <span class="nv">xmm1</span><span class="p">,</span> <span class="mi">116</span>
        <span class="nf">shufps</span>  <span class="nv">xmm3</span><span class="p">,</span> <span class="nv">xmm4</span><span class="p">,</span> <span class="mi">50</span>
        <span class="nf">pshuflw</span> <span class="nv">xmm1</span><span class="p">,</span> <span class="nv">xmm1</span><span class="p">,</span> <span class="mi">180</span>
        <span class="nf">shufps</span>  <span class="nv">xmm1</span><span class="p">,</span> <span class="nv">xmm3</span><span class="p">,</span> <span class="mi">132</span>
        <span class="nf">pshuflw</span> <span class="nv">xmm0</span><span class="p">,</span> <span class="nv">xmm0</span><span class="p">,</span> <span class="mi">230</span>
        <span class="nf">pshufhw</span> <span class="nv">xmm3</span><span class="p">,</span> <span class="nv">xmm2</span><span class="p">,</span> <span class="mi">225</span>
        <span class="nf">movsd</span>   <span class="nv">xmm3</span><span class="p">,</span> <span class="nv">xmm0</span>
        <span class="nf">pshufd</span>  <span class="nv">xmm0</span><span class="p">,</span> <span class="nv">xmm2</span><span class="p">,</span> <span class="mi">216</span>
        <span class="nf">pshufhw</span> <span class="nv">xmm0</span><span class="p">,</span> <span class="nv">xmm0</span><span class="p">,</span> <span class="mi">232</span>
        <span class="nf">pshufd</span>  <span class="nv">xmm0</span><span class="p">,</span> <span class="nv">xmm0</span><span class="p">,</span> <span class="mi">104</span>
        <span class="nf">pshuflw</span> <span class="nv">xmm0</span><span class="p">,</span> <span class="nv">xmm0</span><span class="p">,</span> <span class="mi">198</span>
        <span class="nf">shufps</span>  <span class="nv">xmm0</span><span class="p">,</span> <span class="nv">xmm3</span><span class="p">,</span> <span class="mi">36</span>
        <span class="nf">packuswb</span>        <span class="nv">xmm0</span><span class="p">,</span> <span class="nv">xmm0</span>
        <span class="nf">movq</span>    <span class="nb">rax</span><span class="p">,</span> <span class="nv">xmm0</span>
        <span class="nf">packuswb</span>        <span class="nv">xmm1</span><span class="p">,</span> <span class="nv">xmm1</span>
        <span class="nf">movq</span>    <span class="nb">rdx</span><span class="p">,</span> <span class="nv">xmm1</span>
        <span class="nf">ret</span>
</code></pre></div>



<a name="263060880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hooray%20stdsimd%21/near/263060880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hooray.20stdsimd!.html#263060880">(Nov 29 2021 at 20:02)</a>:</h4>
<p>Yeah, pshufb really simplifies it, because pshufb is the "dynamic" swizzle, but keeping everything in vector registers and doing a bunch of manipulations that look complex is still fast. It can be performant mostly because those are all immediates, so tracking the dependency is simple</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">reg0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pshuf_not_b</span><span class="p">(</span><span class="n">reg1</span><span class="p">,</span><span class="w"> </span><span class="n">CONST</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>with only shufps being</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">reg0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shufps</span><span class="p">(</span><span class="n">reg0</span><span class="p">,</span><span class="w"> </span><span class="n">reg1</span><span class="p">,</span><span class="w"> </span><span class="n">CONST</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>Which is why it often does two different sets of manipulations on different registers and then merges them using shufps, trying to keep a pattern like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">reg0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pshuf_</span><span class="o">?</span><span class="p">(</span><span class="n">reg0</span><span class="p">,</span><span class="w"> </span><span class="n">CONST0</span><span class="p">);</span><span class="w"></span>
<span class="n">reg1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pshuf_</span><span class="o">?</span><span class="p">(</span><span class="n">reg1</span><span class="p">,</span><span class="w"> </span><span class="n">CONST1</span><span class="p">);</span><span class="w"></span>
<span class="n">reg0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shufps</span><span class="p">(</span><span class="n">reg0</span><span class="p">,</span><span class="w"> </span><span class="n">reg1</span><span class="p">,</span><span class="w"> </span><span class="n">CONST2</span><span class="p">);</span><span class="w"></span>
<span class="n">reg2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pshuf_</span><span class="o">?</span><span class="p">(</span><span class="n">reg2</span><span class="p">,</span><span class="w"> </span><span class="n">CONST3</span><span class="p">);</span><span class="w"></span>
<span class="c1">// etc.</span>
</code></pre></div>
<p>because that way, since your processor is superscalar, most of these instructions get to go <strong>at the same time</strong>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>