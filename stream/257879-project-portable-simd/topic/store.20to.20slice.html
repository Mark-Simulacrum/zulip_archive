<html>
<head><meta charset="utf-8"><title>store to slice · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html">store to slice</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268901842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268901842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Pedraza <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268901842">(Jan 21 2022 at 20:54)</a>:</h4>
<p>How would I store a vector to a slice at some index i? Is something like <code>out.copy_from_slice(&amp;vec.to_array())</code> the best way? Did I miss something obvious in the docs?</p>



<a name="268909157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268909157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268909157">(Jan 21 2022 at 22:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="469380">Joel Pedraza</span> <a href="#narrow/stream/257879-project-portable-simd/topic/store.20to.20slice/near/268901842">said</a>:</p>
<blockquote>
<p>How would I store a vector to a slice at some index i? Is something like <code>out.copy_from_slice(&amp;vec.to_array())</code> the best way? Did I miss something obvious in the docs?</p>
</blockquote>
<p>Yes, that's the best way in safe Rust.</p>



<a name="268912693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268912693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Pedraza <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268912693">(Jan 21 2022 at 22:35)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> Thanks. I'll open an issue to request  a (copy|store)_to method for ergonmonics.</p>



<a name="268915299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268915299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268915299">(Jan 21 2022 at 23:03)</a>:</h4>
<p>Going via <code>to_array</code> seems quite reasonable to me?</p>
<p>The only thing that'd make it simpler is if a vector could just deref to its underlying array -- then it'd just be <code>.copy_from_slice(&amp;simd)</code> -- but I assume it's very intentional that such a <code>Deref</code> impl doesn't exist.</p>



<a name="268915527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268915527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268915527">(Jan 21 2022 at 23:06)</a>:</h4>
<p>we'd probably want to have a unaligned vector store function, rather than relying on llvm to convert the scalar memcpy into a vector store</p>



<a name="268915700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268915700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268915700">(Jan 21 2022 at 23:07)</a>:</h4>
<p><span class="user-mention" data-user-id="125270">@scottmcm</span> we avoided deref at the beginning, but I'm not sure we're necessarily against it so much as wanted to avoid any unexpected consequences</p>



<a name="268916264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268916264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268916264">(Jan 21 2022 at 23:13)</a>:</h4>
<p>imho <code>Deref</code> will make it waay too easy to accidentally generate scalar operations when you expected simd operations</p>



<a name="268916360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268916360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268916360">(Jan 21 2022 at 23:14)</a>:</h4>
<p>Yeah, that's the main concern</p>



<a name="268916470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268916470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268916470">(Jan 21 2022 at 23:16)</a>:</h4>
<p>Too bad copy_from_slice doesn't take Into&lt;[T]&gt;</p>



<a name="268918090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268918090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268918090">(Jan 21 2022 at 23:32)</a>:</h4>
<p>if we want to generate a store rather than a memcpy in llvm ir, <code>ptr::write_unaligned</code> appears to be better than <code>copy_to_slice</code>: <a href="https://rust.godbolt.org/z/dqjETsxz5">https://rust.godbolt.org/z/dqjETsxz5</a></p>



<a name="268918888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268918888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268918888">(Jan 21 2022 at 23:41)</a>:</h4>
<p><a href="https://gist.github.com/8405669f19a329f31f2c2258e2efe1b5">https://gist.github.com/8405669f19a329f31f2c2258e2efe1b5</a></p>



<a name="268918926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268918926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268918926">(Jan 21 2022 at 23:41)</a>:</h4>
<p>whoops</p>



<a name="268918940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268918940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268918940">(Jan 21 2022 at 23:41)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2021&amp;gist=117cc6b1245bae7bfd7ecb6ffb2db590">https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2021&amp;gist=117cc6b1245bae7bfd7ecb6ffb2db590</a></p>



<a name="268918954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268918954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268918954">(Jan 21 2022 at 23:41)</a>:</h4>
<p>they end up nearly the same though, fortunately</p>



<a name="268919145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268919145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268919145">(Jan 21 2022 at 23:44)</a>:</h4>
<p>they may be different on some platform...i checked aarch64, powerpc64le, and x86-64</p>



<a name="268919204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268919204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268919204">(Jan 21 2022 at 23:44)</a>:</h4>
<p>same assembly on all of those in release mode</p>



<a name="268919254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268919254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268919254">(Jan 21 2022 at 23:45)</a>:</h4>
<p>if there's some platform with different assembly, i expect the version with <code>store</code> to be more optimal</p>



<a name="268923240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268923240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268923240">(Jan 22 2022 at 00:35)</a>:</h4>
<p><code>write_unaligned</code> and <code>copy_to_slice</code> are both just <code>memcpy</code> under the hood, so I doubt that there's any real difference between the two.</p>
<p>(Or if there is, I think it's an LLVM bug, not a rust problem.)</p>



<a name="268923508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268923508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268923508">(Jan 22 2022 at 00:40)</a>:</h4>
<p>maybe the difference is that the <code>write_unaligned</code> code does the store at type <code>f32x16</code> whereas the other code had type <code>[f32]</code></p>



<a name="268926508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268926508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268926508">(Jan 22 2022 at 01:20)</a>:</h4>
<p>Hmm, I am broadly in favor of explicit implementations of things that arrays implement, I dislike Deref-to-array. I don't think we should directly expose "it's an array" except in terms of our implementation.</p>



<a name="268926610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268926610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268926610">(Jan 22 2022 at 01:22)</a>:</h4>
<p>i think we should expose "it's an array" but only through <code>as_array</code> and <code>as_ref</code> and maybe <code>borrow</code></p>



<a name="268930583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268930583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268930583">(Jan 22 2022 at 02:35)</a>:</h4>
<p>yeah if you're visibly calling a method it's fine. Similar to how an RNG or Iterator is probably Copy in terms of literal data but we generally keep it to Clone only so that it's clear on the page when you're doing the duplication.</p>



<a name="268932079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/store%20to%20slice/near/268932079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/store.20to.20slice.html#268932079">(Jan 22 2022 at 03:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/store.20to.20slice/near/268916470">said</a>:</p>
<blockquote>
<p>Too bad copy_from_slice doesn't take Into&lt;[T]&gt;</p>
</blockquote>
<p><code>Into</code> is wrong, but <code>AsRef&lt;[T]&gt;</code> might be interesting.  Probably not backwards-compatible, though :/</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>