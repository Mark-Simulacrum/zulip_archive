<html>
<head><meta charset="utf-8"><title>heart · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html">heart</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268941666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268941666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Pedraza <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268941666">(Jan 22 2022 at 06:48)</a>:</h4>
<p>Just wanted to say.</p>
<ol>
<li>This work is consistently impressive to me.</li>
<li>Congrats for making it into std on nightly.</li>
</ol>
<p>I've been implementing sorted array set operations (intersection, union, etc)<br>
The paper I referenced for intersection uses x86 PCMPISTRM instruction to do an all-against-all comparison of lanes in one instr</p>
<p>Decided to try and write it with std::simd and writing the all-against-all cmp using equality, rotate by 1, or the mask, repeat<br>
The runtime is the same, and it's portable.</p>
<p><span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span> for you all.</p>



<a name="268941887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268941887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Pedraza <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268941887">(Jan 22 2022 at 06:54)</a>:</h4>
<p>Given that PCMPISTRM was intended for string cmp, it only works for lane widths of 8 and 16. The authors of the the paper go out of their way to construct a hierarchical intersection mechanism for 32 bit ints.  Masking the high and lo 16 bits and using PCMPISTRM for cmp.  I wonder if they fell for the same trap that I did: assuming 1 inst will _obviously_  be faster than the 30 or so required to do the equivalent using more primitive instructions.</p>



<a name="268942886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268942886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268942886">(Jan 22 2022 at 07:14)</a>:</h4>
<p>A 1 to 30 ratio is a bit high, but it's true the latency for that instruction is (while not disastrous) a decent number of cycles.</p>



<a name="268944118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268944118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Pedraza <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268944118">(Jan 22 2022 at 07:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/heart/near/268942886">said</a>:</p>
<blockquote>
<p>A 1 to 30 ratio is a bit high, but it's true the latency for that instruction is (while not disastrous) a decent number of cycles.</p>
</blockquote>
<p>Thats fair, I've only benchmarked on my local machine. It could be that it's more or less stubbed out and is much faster on better hardware.</p>



<a name="268944335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268944335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Pedraza <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268944335">(Jan 22 2022 at 07:54)</a>:</h4>
<p>The authors also had to special case 0, in order for the instruction to not treat it like a NUL terminator. <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="268945515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268945515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268945515">(Jan 22 2022 at 08:23)</a>:</h4>
<p>If your local machine has AVX2 then that's probably about as good as it's gonna get.</p>



<a name="268948769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268948769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268948769">(Jan 22 2022 at 09:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="469380">Joel Pedraza</span> <a href="#narrow/stream/257879-project-portable-simd/topic/heart/near/268941887">said</a>:</p>
<blockquote>
<p>I wonder if they fell for the same trap that I did: assuming 1 inst will _obviously_  be faster than the 30 or so required to do the equivalent using more primitive instructions.</p>
</blockquote>
<p>I made the same mistake.  &lt;<a href="https://users.rust-lang.org/t/converting-a-bgra-u8-to-rgb-u8-n-for-images/67938/14?u=scottmcm">https://users.rust-lang.org/t/converting-a-bgra-u8-to-rgb-u8-n-for-images/67938/14?u=scottmcm</a>&gt; has a nice demo that the like 15 instructions it came up with to work around the lack of <code>vpshufb</code> turned out to still be super-fast.</p>
<p>So kudos to LLVM's cost models!</p>



<a name="268952431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268952431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Pedraza <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268952431">(Jan 22 2022 at 11:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/heart/near/268948769">said</a>:</p>
<blockquote>
<p>(Edit: oh, PCMPISTRM is latency 10 on skylake!)</p>
</blockquote>
<p>Yeah I guess if you want to compare every lane in A to every lane in B you still need to obey physics. Bummer.</p>



<a name="268967782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268967782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268967782">(Jan 22 2022 at 17:20)</a>:</h4>
<p>lmao</p>



<a name="268967816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268967816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268967816">(Jan 22 2022 at 17:21)</a>:</h4>
<p>Zen has lower latency I think but it's still like ~7 when I checked.</p>



<a name="268968010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268968010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268968010">(Jan 22 2022 at 17:25)</a>:</h4>
<p>It's a similar story for the dot product instructions: it sounds nice to have "one instruction" that covers something that is commonly done, but then you find out it really was only a performance gain some time ago, and nowadays everyone just spams FMAs.</p>



<a name="268973291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268973291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268973291">(Jan 22 2022 at 19:24)</a>:</h4>
<p>dot product instructions were pretty much never a perf gain, aside from a small amount of icache savings (due to the shorter instruction encoding compared to doing the dot product explicitly)</p>



<a name="268973304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268973304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268973304">(Jan 22 2022 at 19:24)</a>:</h4>
<p><code>pcmp*str*</code> can be a perf savings depending on the complexity of what you've programmed them to do. also, thye have pretty good throughput (but yeah, fairly shit latency on a lot of machines)</p>



<a name="268978009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268978009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268978009">(Jan 22 2022 at 20:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/257879-project-portable-simd/topic/heart/near/268973291">said</a>:</p>
<blockquote>
<p>dot product instructions were pretty much never a perf gain, aside from a small amount of icache savings (due to the shorter instruction encoding compared to doing the dot product explicitly)</p>
</blockquote>
<p>I went through the instruction tables when I sized up that issue and IIRC they were a slight gain basically within 1 generation of their introduction and then it all went flat.</p>



<a name="268978536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/heart/near/268978536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/heart.html#268978536">(Jan 22 2022 at 21:03)</a>:</h4>
<p>Basically "since Haswell, nada."</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>