<html>
<head><meta charset="utf-8"><title>clang gets simd bitvector mask support · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html">clang gets simd bitvector mask support</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276105840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276105840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276105840">(Mar 21 2022 at 20:01)</a>:</h4>
<p><a href="https://reviews.llvm.org/rG0aab34410403">https://reviews.llvm.org/rG0aab34410403</a></p>



<a name="276106085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276106085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276106085">(Mar 21 2022 at 20:03)</a>:</h4>
<p>Ooh</p>



<a name="276106274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276106274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276106274">(Mar 21 2022 at 20:04)</a>:</h4>
<p>So is this still an i1 vector in IR?</p>



<a name="276106860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276106860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276106860">(Mar 21 2022 at 20:09)</a>:</h4>
<p>It would be interesting to change repr(simd) to similarly accept bool but I think it would be exceptionally complicated since it's fundamentally an array in the type system</p>



<a name="276107845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276107845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276107845">(Mar 21 2022 at 20:18)</a>:</h4>
<p>yup, it's an i1 vector</p>



<a name="276108827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276108827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276108827">(Mar 21 2022 at 20:27)</a>:</h4>
<p>rustc could probably just replace the array type inside the <code>#[repr(simd)]</code> with an opaque blob type, maybe kinda like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// user's code</span>
<span class="cp">#[repr(simd)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Mask50</span><span class="p">(</span><span class="k">pub</span><span class="w"> </span><span class="p">[</span><span class="kt">bool</span><span class="p">;</span><span class="w"> </span><span class="mi">50</span><span class="p">]);</span><span class="w"></span>

<span class="c1">// compiler converts it to something like:</span>
<span class="cp">#[derive(SimdCompilerMagic)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Mask50</span><span class="p">(</span><span class="k">pub</span><span class="w"> </span><span class="n">Guts</span><span class="p">);</span><span class="w"></span>

<span class="c1">// opaque struct</span>
<span class="cp">#[repr(align(8)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Guts</span><span class="p">(</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">7</span><span class="p">]</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="276108923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276108923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276108923">(Mar 21 2022 at 20:28)</a>:</h4>
<p>It's possible definitely, I'm just not sure if it's useful</p>



<a name="276108980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276108980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276108980">(Mar 21 2022 at 20:28)</a>:</h4>
<p>Since masks are inherently pretty different anyway</p>



<a name="276109087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109087">(Mar 21 2022 at 20:29)</a>:</h4>
<p>imho we should probably wait till we get <code>sint::&lt;1&gt;</code> and just have it be a bit-packed array of <code>i1</code></p>



<a name="276109214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109214">(Mar 21 2022 at 20:30)</a>:</h4>
<p>then a bitmask would just simply be <code>Simd&lt;i1, N&gt;</code></p>



<a name="276109242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109242">(Mar 21 2022 at 20:31)</a>:</h4>
<p>That makes the assumption that arrays will be packed rather than each element being byte aligned minimum</p>



<a name="276109269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109269">(Mar 21 2022 at 20:31)</a>:</h4>
<p>That would completely break arrays since you wouldn't be able to aquire references to elements</p>



<a name="276109391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109391">(Mar 21 2022 at 20:32)</a>:</h4>
<p>that's what the bitpacked part does:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MyStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[repr(bitpacked)]</span><span class="w"></span>
<span class="w">    </span><span class="n">bits</span>: <span class="p">[</span><span class="n">i1</span><span class="p">;</span><span class="w"> </span><span class="mi">25</span><span class="p">],</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276109441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109441">(Mar 21 2022 at 20:32)</a>:</h4>
<p>clang doesn't support accessing elements of the bitvector</p>



<a name="276109474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109474">(Mar 21 2022 at 20:33)</a>:</h4>
<p>rustc could just support direct read/write, no references</p>



<a name="276109538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109538">(Mar 21 2022 at 20:33)</a>:</h4>
<p>or, maybe read into a temp var and return a reference to the temp var, then write back afterwards if it was a mut reference</p>



<a name="276109662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109662">(Mar 21 2022 at 20:34)</a>:</h4>
<p>this is very much like how a packed struct doesn't support references to fields</p>



<a name="276109766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109766">(Mar 21 2022 at 20:35)</a>:</h4>
<p>So what happens to AsRef&lt;[T]&gt; etc on vectors?</p>



<a name="276109853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109853">(Mar 21 2022 at 20:36)</a>:</h4>
<p>that only happens when <code>T</code> isn't an <code>i1</code>?</p>



<a name="276109941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109941">(Mar 21 2022 at 20:37)</a>:</h4>
<p>maybe we'd want another type anyway: <code>BitPackedSimd</code></p>



<a name="276109957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276109957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276109957">(Mar 21 2022 at 20:37)</a>:</h4>
<p>We already have that, it's called Mask lol</p>



<a name="276110037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276110037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276110037">(Mar 21 2022 at 20:38)</a>:</h4>
<p>it'd be useful for representing stuff like <code>BitPackedSimd&lt;i4, 25&gt;</code> too, not just masks</p>



<a name="276110055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276110055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276110055">(Mar 21 2022 at 20:38)</a>:</h4>
<p>nvidia gpus support simd on 4-bit elements</p>



<a name="276110319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276110319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276110319">(Mar 21 2022 at 20:40)</a>:</h4>
<p>imho arrays would still be byte (or more) aligned by default, bitpacked tells rustc that it should not use the default repr</p>



<a name="276110605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276110605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276110605">(Mar 21 2022 at 20:43)</a>:</h4>
<p>(this is all making me wish computers would operate on individual bits rather than requiring addresses be multiples of bytes, oh well, history didn't go that way... I blame C! (just cuz, C wasn't the first))</p>



<a name="276122492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276122492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276122492">(Mar 21 2022 at 22:34)</a>:</h4>
<p>Yeah, I don't think, from our perspective, it makes sense to have <code>bool; N</code> as a SIMD type.</p>



<a name="276269951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/clang%20gets%20simd%20bitvector%20mask%20support/near/276269951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/clang.20gets.20simd.20bitvector.20mask.20support.html#276269951">(Mar 22 2022 at 23:49)</a>:</h4>
<p>as far as anything like <code>Simd&lt;i4, 32&gt;</code>, I don't know that that really makes sense..? Like I know we've been adventurous about supporting niche mechanisms but I don't see <code>i4x32</code> compiling that well on any of our target platforms...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>