<html>
<head><meta charset="utf-8"><title>Masked&lt;_&gt; + llvm.vp.{s,u}{div,rem} · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html">Masked&lt;_&gt; + llvm.vp.{s,u}{div,rem}</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270603700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270603700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270603700">(Feb 03 2022 at 19:25)</a>:</h4>
<p>So, in Rust, we panic when we divide by zero. But in SIMD, we would like to <strong>not</strong> panic. Panics are hard to optimize out. Panics are <strong>a branch</strong>. So we would <strong>like</strong> to actually just <strong>not</strong> touch zero lanes at all. But why do we panic? </p>
<p>Well, the result is undefined, right? At least for integer division, there's no commonly accepted answer, and so there are multiple machine implementations as well.  So yes, in LLVM, division by zero taints the result: it produces <code>undef</code>, the "value that can be any value". In fact, it emits <code>undef</code> for the <strong>entire vector</strong>. This means we have to know what we are giving to LLVM when we divide, or else the rest of Rust gets miscompiled because of this error. We don't get to avoid touching the divided-by-zero lanes.</p>
<p>This has a very unfortunate effect. It means that on operations we would like to make Go Fast, we actually have to, at every step, perform a Rust-level <code>Mask::select</code> or other operation in order to adjust the vectors into something that would work, or we have to panic.<br>
...Right?</p>
<p>...Well, I have done some research and thought, and I believe we may in fact choose to not touch them at all. We can use the <code>llvm.vp.{s,u}{div,rem}</code> intrinsics, which predicate a vector operation. These operate differently than applying LLVM instructions like <code>sdiv</code> to a vector. They simply accept a mask and then make the lanes disabled by the mask <code>undef</code> in the result. This means that as long as we keep the mask paired with the vector (so we know what lanes we can look at later), we can avoid selecting more than once, at the end of a computation. So, we pass the mask around in a struct paired with the vector. Enter <code>Masked&lt;_&gt;</code>.</p>
<p>Seems easy enough, in theory. I wanted to ask to see if anyone can spot any obvious flaws in my plan. I also know that Jacob in particular is more familiar with the <code>vp</code> intrinsics than I am.</p>



<a name="270604577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270604577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270604577">(Feb 03 2022 at 19:31)</a>:</h4>
<p>My recollection is that division by zero is more weird than other things because it's a hard abort in the asm semantics, not something that "just" returns an unusable or unknown value.  Which is why LLVM still has <code>udiv</code> by zero as immediate UB, not just the <code>poison</code> that LLVM has been moving most of its operations to produce when called improperly.</p>
<p>Note that exposing an <code>undef</code> to safe code is unsound, so what's your plan to avoid that?</p>



<a name="270605406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270605406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270605406">(Feb 03 2022 at 19:37)</a>:</h4>
<p>exposing <code>undef</code> is sound if you wrap it in <code>MaybeUninit</code>...that said, i think the idea is that <code>Masked</code> is kinda like <code>Simd&lt;Option&lt;T&gt;, N&gt;</code>, implemented as <code>struct Masked&lt;T, const N: usize&gt;{value: Simd&lt;MaybeUninit&lt;T&gt;, N&gt;, mask: Mask&lt;&lt;T as SimdElement&gt;::Mask, N&gt;,}</code></p>



<a name="270605614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270605614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270605614">(Feb 03 2022 at 19:38)</a>:</h4>
<p>Ah, I see; I'd missed the detail of <code>Masked</code> to keep people from getting the <code>undef</code> in an <code>f32</code>.</p>



<a name="270605824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270605824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270605824">(Feb 03 2022 at 19:40)</a>:</h4>
<p>An alternative would be something like <code>fn div_or</code> on integers (since it doesn't apply to floats)</p>



<a name="270605866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270605866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270605866">(Feb 03 2022 at 19:40)</a>:</h4>
<p>That still implies potentially gratuitous numbers of selects.</p>



<a name="270605936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270605936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270605936">(Feb 03 2022 at 19:41)</a>:</h4>
<p><em>inserts a newline or two to give <code>Masked</code> proper attention</em></p>



<a name="270606119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270606119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270606119">(Feb 03 2022 at 19:42)</a>:</h4>
<p>Silly question: how much support for big vectorized integer divisions do chips really have?  I always think of <code>udiv</code> as super slow already, and thus wonder if there's really all that replicated enough for <code>/ Simd&lt;u64, 8&gt;</code> to even be useful...</p>



<a name="270606157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270606157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270606157">(Feb 03 2022 at 19:42)</a>:</h4>
<p>we'd still need logic in <code>Masked::div</code> to check unmasked lanes for zero/overflow and panic or mask them out, maybe we should only provide <code>checked_div</code></p>



<a name="270606230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270606230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270606230">(Feb 03 2022 at 19:43)</a>:</h4>
<p>There isn't really any support, we only provide it for consistency, because eventually someone will want to divide</p>



<a name="270606262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270606262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270606262">(Feb 03 2022 at 19:43)</a>:</h4>
<p>the cpu Libre-SOC is working on will likely support vectorized int division</p>



<a name="270606306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270606306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270606306">(Feb 03 2022 at 19:43)</a>:</h4>
<p>So there will be 1 CPU with it :)</p>



<a name="270606419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270606419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270606419">(Feb 03 2022 at 19:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D/near/270604577">said</a>:</p>
<blockquote>
<p>My recollection is that division by zero is more weird than other things because it's a hard abort in the asm semantics, not something that "just" returns an unusable or unknown value.  Which is why LLVM still has <code>udiv</code> by zero as immediate UB, not just the <code>poison</code> that LLVM has been moving most of its operations to produce when called improperly.</p>
<p>Note that exposing an <code>undef</code> to safe code is unsound, so what's your plan to avoid that?</p>
</blockquote>
<p>Well, actually: Arm doesn't trap at all on <code>sdiv</code>.</p>



<a name="270606568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270606568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270606568">(Feb 03 2022 at 19:45)</a>:</h4>
<p>Also you're right, it is immediate UB lol WHOOPS, my bad.</p>



<a name="270606685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270606685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270606685">(Feb 03 2022 at 19:46)</a>:</h4>
<p>risc-v and powerpc don't trap either, risc-v provides a specificly defined result, powerpc just has architecturally undefined results</p>



<a name="270606766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270606766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270606766">(Feb 03 2022 at 19:46)</a>:</h4>
<p>Yeah, what I want is specifically to allow a design which allows the compiler to lower this to scalar looping a <strong>well-defined div instruction</strong>.</p>



<a name="270606829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270606829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270606829">(Feb 03 2022 at 19:47)</a>:</h4>
<p>Because we promise not to read any of the naughty lanes that could be whatever.</p>



<a name="270606896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270606896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270606896">(Feb 03 2022 at 19:47)</a>:</h4>
<p>Libre-SOC's cpu basically needs fast fp div, and the fp div hw can also do int div (and fp sqrt)</p>



<a name="270607068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270607068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270607068">(Feb 03 2022 at 19:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D/near/270606119">said</a>:</p>
<blockquote>
<p>Silly question: how much support for big vectorized integer divisions do chips really have?  I always think of <code>udiv</code> as super slow already, and thus wonder if there's really all that replicated enough for <code>/ Simd&lt;u64, 8&gt;</code> to even be useful...</p>
</blockquote>
<p>Also I think that x86 actually does have weird fixpoint SIMD div instructions on some instruction sets???</p>



<a name="270608363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270608363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270608363">(Feb 03 2022 at 19:57)</a>:</h4>
<p>But yeah, I agree this may not actually prove that useful, but I believe that it's worth a shot. We'd basically be looking at offering an improvement to <code>i32x4.div(i32x4)</code>, and mostly on Arm, PowerPC, and RISCV, by letting the compiler simply lower to the scalar <code>sdiv</code>. Also, I think this kind of infrastructure may allow us to improve our NaN handling down the line, potentially, when paired with proposed constructs like <code>NonNan</code>.</p>



<a name="270609542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270609542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270609542">(Feb 03 2022 at 20:05)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CheckedDiv</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Masked</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">checked_div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Output</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">lane_eq_or</span><span class="p">(</span><span class="n">Simd</span>::<span class="n">splat</span><span class="p">(</span><span class="n">T</span>::<span class="n">ZERO</span><span class="p">),</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">lhs</span><span class="p">.</span><span class="n">mask</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">T</span>::<span class="n">SIGNED</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">lane_eq_or</span><span class="p">(</span><span class="n">Simd</span>::<span class="n">splat</span><span class="p">(</span><span class="n">T</span>::<span class="n">MIN</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">lane_eq_or</span><span class="p">(</span><span class="n">Simd</span>::<span class="n">splat</span><span class="p">(</span><span class="n">T</span>::<span class="n">NEG_ONE</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Masked</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">mask</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">simd_vp_div</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="270610238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270610238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270610238">(Feb 03 2022 at 20:10)</a>:</h4>
<p>even on arm, powerpc, and risc-v, div-by-zero may be very slow, so compilers may want to mask anyway, or just replace the divisor by <code>1</code> in masked out lanes</p>



<a name="270610258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270610258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270610258">(Feb 03 2022 at 20:10)</a>:</h4>
<p>Yeah.</p>



<a name="270610382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270610382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270610382">(Feb 03 2022 at 20:11)</a>:</h4>
<p>but that should be left to llvm imho, rustc should just emit <code>llvm.vp.udiv</code></p>



<a name="270610399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270610399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270610399">(Feb 03 2022 at 20:11)</a>:</h4>
<p>And the mask is right there in the <code>llvm.vp.{s,u}div</code> intrinsic if they want to do that.</p>



<a name="270613666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270613666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270613666">(Feb 03 2022 at 20:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D/near/270606119">said</a>:</p>
<blockquote>
<p>Silly question: how much support for big vectorized integer divisions do chips really have?  I always think of <code>udiv</code> as super slow already, and thus wonder if there's really all that replicated enough for <code>/ Simd&lt;u64, 8&gt;</code> to even be useful...</p>
</blockquote>
<p>Also also...<br>
Generally, it is the <strong>compilers</strong> that foot the "fast div implementation" side of things, because they have more knowledge of the surrounding context. So I believe this would make it easier to apply the common "reciprocal division" strategies on the compiler end, which use multiplication, or even a "cast to doubles, fdiv, truncate to to int" approach for smaller ints.</p>



<a name="270615065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270615065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270615065">(Feb 03 2022 at 20:45)</a>:</h4>
<p>RISC-V V supports vector division: <a href="https://llvm.godbolt.org/z/YGz4Gn7Yj">https://llvm.godbolt.org/z/YGz4Gn7Yj</a></p>



<a name="270617094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270617094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270617094">(Feb 03 2022 at 21:02)</a>:</h4>
<p>so does Arm SVE: <a href="https://llvm.godbolt.org/z/Wc7f7qM7v">https://llvm.godbolt.org/z/Wc7f7qM7v</a></p>



<a name="270617954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270617954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270617954">(Feb 03 2022 at 21:08)</a>:</h4>
<p>AH, so they got it by then.</p>



<a name="270633156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270633156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270633156">(Feb 03 2022 at 23:12)</a>:</h4>
<p>Hm, it seems LLVM is not terribly clever about division, alas: <a href="https://llvm.godbolt.org/z/3nrbejeMc">https://llvm.godbolt.org/z/3nrbejeMc</a></p>



<a name="270633959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270633959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270633959">(Feb 03 2022 at 23:19)</a>:</h4>
<p>how bad is does codegen get for something for testing if any members are 0, and if so doing a unlikely-hinted branching with a call to a inline(never) function with the panic -- i feel like that shouldn't be so bad...</p>



<a name="270633984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270633984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270633984">(Feb 03 2022 at 23:19)</a>:</h4>
<p>If the issue is llvm spilling all the simd regs because it gets spooked by the call, in theory coldcc is supposed to solve that (but IDT we have a way to use it easily)</p>



<a name="270634472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634472">(Feb 03 2022 at 23:24)</a>:</h4>
<p>This would probably mean we have worse information about the actual panic source when backtraces are off. that's unfortunate, but might be worth it if avoids bad codegen for simd. </p>
<p>Like, we made the tradeoff at some point that <code>unwrap()</code> having good error reporting is more important than it having good codegen, and so the compiler passes the caller's location info unto the unwrap, which makes the code somewhat worse in the call site. I think this was the right call there, but possibly the calculus is not the same for simd, which is entirely about performance.</p>



<a name="270634520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634520">(Feb 03 2022 at 23:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D/near/270633156">said</a>:</p>
<blockquote>
<p>Hm, it seems LLVM is not terribly clever about division, alas: <a href="https://llvm.godbolt.org/z/3nrbejeMc">https://llvm.godbolt.org/z/3nrbejeMc</a></p>
</blockquote>
<p>on the upside, there's no huge pessimization either (<strong>relatively</strong> speaking... the codegen is sufficiently bad it does not get enormously worse), so the question starts to be how it looks like when embedded in Rust's semantics.</p>



<a name="270634536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634536">(Feb 03 2022 at 23:24)</a>:</h4>
<p>doesn't marking something <code>#[cold]</code> change the abi to coldcc?</p>



<a name="270634590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634590">(Feb 03 2022 at 23:24)</a>:</h4>
<p>I don't think it does</p>



<a name="270634615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634615">(Feb 03 2022 at 23:24)</a>:</h4>
<p>maybe it should...</p>



<a name="270634616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634616">(Feb 03 2022 at 23:24)</a>:</h4>
<p>I think it's equivalent to the unlikely intrinsic?</p>



<a name="270634618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634618">(Feb 03 2022 at 23:24)</a>:</h4>
<p>no, it actually still uses fastcc</p>



<a name="270634649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634649">(Feb 03 2022 at 23:25)</a>:</h4>
<p>coldcc is really aggressively cold. i could see it being used for cold+noreturn</p>



<a name="270634703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634703">(Feb 03 2022 at 23:25)</a>:</h4>
<p>but people use cold for realloc branches in vectors and such</p>



<a name="270634779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634779">(Feb 03 2022 at 23:26)</a>:</h4>
<p>that sadi, putting fastcc on #[cold] functions is goofy and honestly bad</p>



<a name="270634903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634903">(Feb 03 2022 at 23:27)</a>:</h4>
<p>Oh, I mislabeled some of my own functions, heh.</p>



<a name="270634925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270634925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270634925">(Feb 03 2022 at 23:27)</a>:</h4>
<p>well, panic at least should be changed to coldcc</p>



<a name="270635240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270635240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270635240">(Feb 03 2022 at 23:30)</a>:</h4>
<p><a href="https://llvm.godbolt.org/z/4eo8jG733">https://llvm.godbolt.org/z/4eo8jG733</a><br>
Ah, I think that aligns all the function names.</p>



<a name="270635265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270635265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270635265">(Feb 03 2022 at 23:30)</a>:</h4>
<p>i did experimentation at one point on std::vec::Vec, and preservemostcc was really good for the cold functions there (concretely, it helped avoid that thing where you can look at a x86_64 asm and tell its rust by the fact that it pushes half a dozen registers at the start). tragically, its not stable.</p>



<a name="270635307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270635307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270635307">(Feb 03 2022 at 23:31)</a>:</h4>
<p>that said adding extern "C" actually had a similar benefit, but not as much -- i think "use fastcc on literally all functions" is probably not the ideal way to apply calling conventions.</p>



<a name="270635368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270635368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270635368">(Feb 03 2022 at 23:31)</a>:</h4>
<p>i meant to write this up and file an issue at one point but it felt pretty likely to just sink into rust-lang/rust/issues without ever getting a comment so i just made a mental note of it</p>



<a name="270635520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270635520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270635520">(Feb 03 2022 at 23:33)</a>:</h4>
<p>well, i've wanted to create a better abi that lets you return more than 2 <code>i64</code>s in registers...you should be able to return just as much stuff as will fit in call arguments</p>



<a name="270635558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270635558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270635558">(Feb 03 2022 at 23:34)</a>:</h4>
<p>(thoroughly off topic)</p>



<a name="270644854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270644854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270644854">(Feb 03 2022 at 23:44)</a>:</h4>
<p>hm.</p>



<a name="270650971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/270650971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#270650971">(Feb 04 2022 at 00:45)</a>:</h4>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="w">    </span><span class="nv">%neg1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">bitcast</span><span class="w"> </span><span class="kt">i128</span><span class="w"> </span><span class="m">-1</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="p">&lt;</span><span class="m">16</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">%pos1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">mul</span><span class="w"> </span><span class="p">&lt;</span><span class="m">16</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%neg1</span><span class="p">,</span><span class="w"> </span><span class="nv">%neg1</span><span class="w"></span>
<span class="w">    </span><span class="nv">%is_neg1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="p">&lt;</span><span class="m">16</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%b</span><span class="p">,</span><span class="w"> </span><span class="nv">%neg1</span><span class="w"></span>
<span class="w">    </span><span class="nv">%is_min</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">icmp</span><span class="w"> </span><span class="k">eq</span><span class="w"> </span><span class="p">&lt;</span><span class="m">16</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%b</span><span class="p">,</span><span class="w"> </span><span class="p">&lt;</span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-128</span><span class="p">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nv">%overflows</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">&lt;</span><span class="m">16</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i1</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%is_neg1</span><span class="p">,</span><span class="w"> </span><span class="nv">%is_min</span><span class="w"></span>
<span class="w">    </span><span class="nv">%divisor</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="p">&lt;</span><span class="m">16</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i1</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%overflows</span><span class="p">,</span><span class="w"> </span><span class="p">&lt;</span><span class="m">16</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%pos1</span><span class="p">,</span><span class="w"> </span><span class="p">&lt;</span><span class="m">16</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%b</span><span class="w"></span>
</code></pre></div>
<p>today I found out I will do <strong>almost</strong> anything to avoid having to write a literal vector for LLVM IR.</p>



<a name="271200871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Masked%3C_%3E%20%2B%20llvm.vp.%7Bs%2Cu%7D%7Bdiv%2Crem%7D/near/271200871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Masked.3C_.3E.20.2B.20llvm.2Evp.2E.7Bs.2Cu.7D.7Bdiv.2Crem.7D.html#271200871">(Feb 08 2022 at 22:28)</a>:</h4>
<p>Well, first I finished making <code>Simd&lt;T, N&gt;</code> into <code>Simd&lt;Wrapping&lt;T&gt;, N&gt;</code>: <a href="https://github.com/rust-lang/portable-simd/pull/243">https://github.com/rust-lang/portable-simd/pull/243</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>