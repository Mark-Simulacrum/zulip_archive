<html>
<head><meta charset="utf-8"><title>Hardware flexible vector support · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html">Hardware flexible vector support</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253478654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253478654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253478654">(Sep 15 2021 at 20:04)</a>:</h4>
<p>not quite...RVV supports vectors having their length dynamically adjusted...our current api doesn't</p>



<a name="253478732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253478732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253478732">(Sep 15 2021 at 20:05)</a>:</h4>
<p>What exactly do you mean by dynamic?</p>



<a name="253478816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253478816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253478816">(Sep 15 2021 at 20:05)</a>:</h4>
<p>Runtime specified? Or just resized</p>



<a name="253478845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253478845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253478845">(Sep 15 2021 at 20:05)</a>:</h4>
<p>runtime specified</p>



<a name="253478855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253478855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253478855">(Sep 15 2021 at 20:05)</a>:</h4>
<p>That's not necessary.</p>



<a name="253478941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253478941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253478941">(Sep 15 2021 at 20:06)</a>:</h4>
<p>Interesting. Yeah, that aspect is probably not portable.</p>



<a name="253478984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253478984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253478984">(Sep 15 2021 at 20:06)</a>:</h4>
<p>SimpleV also supports that</p>



<a name="253479014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479014">(Sep 15 2021 at 20:06)</a>:</h4>
<p>Supporting runtime-specified vector size is not required and not the point of what I am talking about.</p>



<a name="253479048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479048">(Sep 15 2021 at 20:06)</a>:</h4>
<p>I thought that's kind of what you meant at first</p>



<a name="253479062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479062">(Sep 15 2021 at 20:06)</a>:</h4>
<p>No.</p>



<a name="253479100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479100">(Sep 15 2021 at 20:07)</a>:</h4>
<p>I mean support of <strong>hardware</strong> flexible vectors.</p>



<a name="253479130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479130">(Sep 15 2021 at 20:07)</a>:</h4>
<p>So runtime specified size, but fixed</p>



<a name="253479143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479143">(Sep 15 2021 at 20:07)</a>:</h4>
<p>Like SVE</p>



<a name="253479175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479175">(Sep 15 2021 at 20:07)</a>:</h4>
<p>Arm SVE only has dynamic length in the sense that the same program will run on cpus with different lengths, where the length is runtime constant</p>



<a name="253479348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479348">(Sep 15 2021 at 20:08)</a>:</h4>
<p>Lighting up the SIMD units should not require an adjustment to our programming model, even if there are some marginal inefficiencies.<br>
I will continue this later, I do not have the time now.</p>



<a name="253479352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479352">(Sep 15 2021 at 20:08)</a>:</h4>
<p>non-RVV non-SimpleV can emulate dynamic vector lengths using masking</p>



<a name="253479425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479425">(Sep 15 2021 at 20:09)</a>:</h4>
<p>so it <em>is</em> portable</p>



<a name="253479443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479443">(Sep 15 2021 at 20:09)</a>:</h4>
<p>The only fundamental issue I see is that you must accept from the beginning that your vectors are either sized or unsized</p>



<a name="253479610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479610">(Sep 15 2021 at 20:10)</a>:</h4>
<p>you can have sized vectors where the operations use some dynamically selected smaller length</p>



<a name="253479633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479633">(Sep 15 2021 at 20:10)</a>:</h4>
<p>that's how SimpleV works</p>



<a name="253479660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479660">(Sep 15 2021 at 20:10)</a>:</h4>
<p>like an arrayvec</p>



<a name="253479731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479731">(Sep 15 2021 at 20:11)</a>:</h4>
<p>No.</p>



<a name="253479777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479777">(Sep 15 2021 at 20:11)</a>:</h4>
<p>I'll wait to hear Jubilees idea <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="253479788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479788">(Sep 15 2021 at 20:11)</a>:</h4>
<p>I mean doing some MATH in a fucking prologue, JFC.</p>



<a name="253479835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479835">(Sep 15 2021 at 20:11)</a>:</h4>
<p>JFC??</p>



<a name="253479891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253479891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253479891">(Sep 15 2021 at 20:12)</a>:</h4>
<p>idk what that means</p>



<a name="253480020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253480020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253480020">(Sep 15 2021 at 20:12)</a>:</h4>
<p>Yes, you don't know. Again, later.</p>



<a name="253498015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253498015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253498015">(Sep 15 2021 at 22:30)</a>:</h4>
<p>...Sorry, didn't mean to get snippy.</p>
<p>So, the thing is that if someone is using u8x16 to vectorize what would otherwise be something like an operation on the data hiding in some <code>data: Vec&lt;u8&gt;</code> field, and let's say it is at least 1KiB and ignore the alignment details atm (they don't really matter on Arm as long as we have min 16 byte alignment, so let's pretend we have at least that, e.g. by it being actually a u8x16 vector, and I forget the RVV rules), so it would be obviously beneficial to use a wider vector if we could.</p>
<p>afaict these allow us to grab the HW vector length at runtime, so we can load that into a GPR... the assembly might look vaguely like</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">call</span> <span class="no">data.len</span><span class="p">()</span>
<span class="nf">mov</span> <span class="no">gpr0</span><span class="p">,</span> <span class="no">data.len</span><span class="p">().</span><span class="no">retval.0</span>
<span class="nf">arch_vlen_get</span> <span class="no">gpr1</span> <span class="c1"># bytes of HW vector len</span>
<span class="nf">mov</span> <span class="no">gpr2</span><span class="p">,</span> <span class="mi">16</span> <span class="c1"># core::simd const len</span>
<span class="nf">div</span> <span class="no">gpr3</span><span class="p">,</span> <span class="no">gpr1</span><span class="err">/</span><span class="no">gpr2</span> <span class="c1"># multiple to use</span>
<span class="c1"># we now have all the values needed</span>
<span class="c1"># to parameterize the ensuing loop</span>
<span class="c1"># we operate some unknown positive N</span>
<span class="c1"># iterations on the data field</span>
</code></pre></div>
<p>so, this is a <strong>very</strong> abstract version. SVE provides specialized assembly instructions that enables this kind of explicit looping vector predication much more efficiently.</p>



<a name="253498293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253498293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253498293">(Sep 15 2021 at 22:33)</a>:</h4>
<p>No multiversioning required aside from the "is SVE go?" check at all. A single compilation should work.</p>



<a name="253498448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253498448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253498448">(Sep 15 2021 at 22:34)</a>:</h4>
<p>So, I agree that's something a user can do if they want to, but is that really something we want to do?  For example it would be relying heavily on loop fusion</p>



<a name="253498849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253498849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253498849">(Sep 15 2021 at 22:38)</a>:</h4>
<p>I think so, indeed I really haven't seen a good reason not to!</p>
<p>I think providing a dynamic vector length API that allows more directly handling these abstractly long data structures would be a good idea.</p>



<a name="253499157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253499157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253499157">(Sep 15 2021 at 22:41)</a>:</h4>
<p>However, I think aiming for having LLVM emit this kind of loop handling is a goal.</p>



<a name="253499332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253499332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253499332">(Sep 15 2021 at 22:42)</a>:</h4>
<p>Well, IMO relying on loop fusion is perhaps a reason not to (in std::simd at least, a crate like this might be super useful)</p>



<a name="253499426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253499426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253499426">(Sep 15 2021 at 22:43)</a>:</h4>
<p>I think the API would need to reflect performing things inside the loop</p>



<a name="253499469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253499469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253499469">(Sep 15 2021 at 22:44)</a>:</h4>
<p>I don't see how anyone downstream will manage to make this happen because it involves coaxing LLVM to emit certain prologues.</p>



<a name="253499642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253499642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253499642">(Sep 15 2021 at 22:45)</a>:</h4>
<p>Well, I mean doing the loops manually</p>



<a name="253499660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253499660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253499660">(Sep 15 2021 at 22:46)</a>:</h4>
<p>Does LLVM have anything like this already?</p>



<a name="253499753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253499753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253499753">(Sep 15 2021 at 22:46)</a>:</h4>
<p>I have been generally dissatisfied with both LLVM's and GCC's loop fusion optimizations</p>



<a name="253499995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253499995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253499995">(Sep 15 2021 at 22:49)</a>:</h4>
<p>llvm has support for manual looping like described...</p>



<a name="253500139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500139">(Sep 15 2021 at 22:50)</a>:</h4>
<p>LLVM has a lot of loop metadata we can be emitting hints to, and explicitly has instructions that allow you to push fixed width vectors into a scalable vector.</p>



<a name="253500322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500322">(Sep 15 2021 at 22:52)</a>:</h4>
<p>so it's really more saying "hello LLVM please take these fixed vectors and assemble them into scalable pieces danke schön."</p>



<a name="253500365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500365">(Sep 15 2021 at 22:52)</a>:</h4>
<p>and I just remembered I'm probably wrong about my previous statement that Arm SVE doesn't support dynamically selectable RVV-style vector lengths...icr, would have to check the docs for sure...i do remember that at least the SX Aurora gets faster if you tell it the length you want rather than relying on only masking .... icr if that's Arm SVE</p>



<a name="253500605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500605">(Sep 15 2021 at 22:55)</a>:</h4>
<p>SVE has vector length constraints but idk if it's an optimization to use it.</p>
<p>not seeing anything about Arm: <a href="https://en.m.wikipedia.org/wiki/NEC_SX-Aurora_TSUBASA">https://en.m.wikipedia.org/wiki/NEC_SX-Aurora_TSUBASA</a></p>



<a name="253500608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500608">(Sep 15 2021 at 22:55)</a>:</h4>
<p>llvm can take fixed-length vectors and generate rvv instructions from them, you do have to give it a guaranteed minimum supported length though</p>



<a name="253500722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500722">(Sep 15 2021 at 22:56)</a>:</h4>
<p>yes.</p>



<a name="253500778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500778">(Sep 15 2021 at 22:56)</a>:</h4>
<p>I think we should basically be Intel/Arm bigoted and say the minimum is 128 bits.</p>



<a name="253500830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500830">(Sep 15 2021 at 22:57)</a>:</h4>
<p>&lt;_&lt;</p>



<a name="253500847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500847">(Sep 15 2021 at 22:57)</a>:</h4>
<p>I think most other SIMD architectures have 128 bit vectors too</p>



<a name="253500858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500858">(Sep 15 2021 at 22:57)</a>:</h4>
<p>The less common ones</p>



<a name="253500861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500861">(Sep 15 2021 at 22:57)</a>:</h4>
<p>it actually will probably be target specific, but</p>



<a name="253500863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500863">(Sep 15 2021 at 22:57)</a>:</h4>
<p>llvm supports at the ir level all of fixed-length, scalable allocated inside fixed length (like ArrayVec), and scalable allocated inside scalable vectors...see the llvm.vp.* intrinsics</p>



<a name="253500972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253500972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253500972">(Sep 15 2021 at 22:59)</a>:</h4>
<p>some isas only have 32 or 64-bit vectors, such as some versions of risc-v's P extension</p>



<a name="253501004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501004">(Sep 15 2021 at 22:59)</a>:</h4>
<p>intended for microcontrollers where rvv is too heavy</p>



<a name="253501519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501519">(Sep 15 2021 at 23:03)</a>:</h4>
<p>Something that I think may be a compromise between the two, what about support for unsized vectors?  With SVE this would be a standard SVE vector, on AVX (hopefully) we could get it to compile to a standard AVX vector (but an unsized type), and then a user could use either of these to implement flexible vectors however they would like</p>



<a name="253501609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501609">(Sep 15 2021 at 23:04)</a>:</h4>
<p>That does not seem like less work.</p>



<a name="253501631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501631">(Sep 15 2021 at 23:04)</a>:</h4>
<p>I think we are getting a little confused here between scalable and flexible vectors</p>



<a name="253501641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501641">(Sep 15 2021 at 23:05)</a>:</h4>
<p>I don't think scalable vectors have anything to do with flexible vectors</p>



<a name="253501759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501759">(Sep 15 2021 at 23:06)</a>:</h4>
<p>Well, I'm not sure it's any more or less work.  clang already has support for SVE, we would need to extend <code>repr(simd)</code> or make a new repr to handle it</p>



<a name="253501762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501762">(Sep 15 2021 at 23:06)</a>:</h4>
<p>hmm, i never noticed the difference between scalable/flexible and used them mostly interchangeably...</p>



<a name="253501764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501764">(Sep 15 2021 at 23:06)</a>:</h4>
<p>I really was not intending to draw a line between them and I haven't seen any material that has a coherent definition separating them.</p>



<a name="253501803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501803">(Sep 15 2021 at 23:06)</a>:</h4>
<p>well, let me avoid terminology for a second</p>



<a name="253501885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501885">(Sep 15 2021 at 23:07)</a>:</h4>
<p>there are two independent things we can do with vectors:</p>
<ul>
<li>vectors that have size specified by hardware, but only determined at runtime</li>
<li>vectors that have unlimited(ish) size, defined by the user</li>
</ul>



<a name="253501956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501956">(Sep 15 2021 at 23:08)</a>:</h4>
<p>if we focus entirely on the first bullet, I don't think we need loops/prologs/epilogs at all?</p>



<a name="253501998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253501998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253501998">(Sep 15 2021 at 23:08)</a>:</h4>
<p>all procedure calls have a prologue and epilogue.</p>



<a name="253502022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502022">(Sep 15 2021 at 23:09)</a>:</h4>
<p>let me clarify what I mean</p>



<a name="253502048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502048">(Sep 15 2021 at 23:09)</a>:</h4>
<p>i think a good next step would to end up with an arrayvec-like vector -- that neatly avoids the unsized-stuff-on-stack problem while still benefiting from the SimpleV-style dynamic lengths</p>



<a name="253502204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502204">(Sep 15 2021 at 23:10)</a>:</h4>
<p>we can have struct <code>ScalableSimd</code> or whatever you want to call it, it would look nearly identical to what we currently have.  Calling <code>Add::add</code> on it would still result in just one instruction.  The only things that would be different is anything that touches memory (no <code>{from,to}_array</code>)</p>



<a name="253502257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502257">(Sep 15 2021 at 23:11)</a>:</h4>
<p>I'm personally extremely hesitant to rely so heavily on the optimizer to the extent of generating loops for every fn call</p>



<a name="253502299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502299">(Sep 15 2021 at 23:11)</a>:</h4>
<p>We are already relying on it performing inlining correctly.</p>



<a name="253502328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502328">(Sep 15 2021 at 23:11)</a>:</h4>
<p>llvm has <code>llvm.vp.*</code> intrinsics...no need for loop optimizations</p>



<a name="253502446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502446">(Sep 15 2021 at 23:12)</a>:</h4>
<p>and yes, I used a loop to introduce the idea but this is more about using simple math to address the problem.</p>



<a name="253502674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502674">(Sep 15 2021 at 23:14)</a>:</h4>
<p>The runtime value is a parameter we can work around. That's all. It doesn't need compile time multiversioning because it can be handled as intended: at runtime.</p>



<a name="253502677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502677">(Sep 15 2021 at 23:14)</a>:</h4>
<p>the issue with <code>ScalableSimd</code> is that there's two kinds...<code>ArrayVec</code> and truely unsized types</p>



<a name="253502859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502859">(Sep 15 2021 at 23:16)</a>:</h4>
<p>I think we should have the <code>ArrayVec</code> kind at first since it gives most the benefit without many compiler-level annoyances...owned unsized types can be tackled later</p>



<a name="253502909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502909">(Sep 15 2021 at 23:17)</a>:</h4>
<p>We can still have functions compile down to single instructions. The difference is that on AVX, we can't even emit a single instruction. It has to be multiversioned because vector length is a hard constant without parameterization, embedded in the function itself.</p>



<a name="253502988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253502988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253502988">(Sep 15 2021 at 23:18)</a>:</h4>
<p>for the <code>ArrayVec</code> types, we generate code based on the compile-time-determined max vector length</p>



<a name="253503036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503036">(Sep 15 2021 at 23:18)</a>:</h4>
<p>I agree we are relying on inlining, but that's a significantly less complex thing than loop fusion</p>



<a name="253503064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503064">(Sep 15 2021 at 23:18)</a>:</h4>
<p>so we can statically determine which AVX instructions to use without needing multiversioning</p>



<a name="253503104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503104">(Sep 15 2021 at 23:19)</a>:</h4>
<p>though multiversioning can still make it run faster, as expected</p>



<a name="253503107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503107">(Sep 15 2021 at 23:19)</a>:</h4>
<p>I'm confused--there is no way to create a portable binary that uses AVX without multiversioning</p>



<a name="253503120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503120">(Sep 15 2021 at 23:19)</a>:</h4>
<p>Exactly.</p>



<a name="253503135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503135">(Sep 15 2021 at 23:19)</a>:</h4>
<p>Ignore all that, we can just say "target features"</p>



<a name="253503146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503146">(Sep 15 2021 at 23:19)</a>:</h4>
<p>runtime or compile time specified, doesn't really matter</p>



<a name="253503191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503191">(Sep 15 2021 at 23:20)</a>:</h4>
<p>which is why bringing in the idea of using flexible vectors for AVX is irrelevant.</p>



<a name="253503223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503223">(Sep 15 2021 at 23:20)</a>:</h4>
<p>there is---AVX is just the minimum required -- <code>-C target-features=+avx2</code></p>



<a name="253503264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503264">(Sep 15 2021 at 23:20)</a>:</h4>
<p>Hmm maybe you misunderstood, I'm just saying that yes I agree you can implement any type of unsized vectors with fixed size vectors</p>



<a name="253503337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503337">(Sep 15 2021 at 23:21)</a>:</h4>
<p>flexible vectors for AVX is relevant because we want to emulate them for portability</p>



<a name="253503342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503342">(Sep 15 2021 at 23:21)</a>:</h4>
<p>No?</p>



<a name="253503375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503375">(Sep 15 2021 at 23:21)</a>:</h4>
<p>I'm confused <span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p>



<a name="253503388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503388">(Sep 15 2021 at 23:21)</a>:</h4>
<p>I don't understand what is being argued for</p>



<a name="253503478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503478">(Sep 15 2021 at 23:22)</a>:</h4>
<p>I simply don't trust LLVM to do loop fusion correctly, if it did, well that's my only qualm</p>



<a name="253503491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503491">(Sep 15 2021 at 23:22)</a>:</h4>
<p>it isn't about loop fusion.</p>



<a name="253503492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503492">(Sep 15 2021 at 23:22)</a>:</h4>
<p>several separate things are being argued for...hence the confusion</p>



<a name="253503513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503513">(Sep 15 2021 at 23:22)</a>:</h4>
<p>Okay let's back up</p>



<a name="253503544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503544">(Sep 15 2021 at 23:22)</a>:</h4>
<p>Completely putting aside how it's implemented in codegen</p>



<a name="253503578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503578">(Sep 15 2021 at 23:23)</a>:</h4>
<p>I have tried to focus on only one thing and I would appreciate it if we didn't bring up sidetracks.</p>



<a name="253503594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503594">(Sep 15 2021 at 23:23)</a>:</h4>
<p>sorry</p>



<a name="253503627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503627">(Sep 15 2021 at 23:23)</a>:</h4>
<p>Are we looking for an api that has something like:</p>
<div class="codehilite"><pre><span></span><code>impl FlexibleVector {
    fn splat(value: T, len: usize) -&gt; { ... }
}
</code></pre></div>



<a name="253503633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503633">(Sep 15 2021 at 23:23)</a>:</h4>
<p>or am I confused?</p>



<a name="253503682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503682">(Sep 15 2021 at 23:24)</a>:</h4>
<p>No, we are not.</p>



<a name="253503691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503691">(Sep 15 2021 at 23:24)</a>:</h4>
<p>I am not.</p>



<a name="253503709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503709">(Sep 15 2021 at 23:24)</a>:</h4>
<p>Okay, can you give me an example?  In rust, not codegen</p>



<a name="253503710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503710">(Sep 15 2021 at 23:24)</a>:</h4>
<p>Not yet. Someday, probably.</p>



<a name="253503716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503716">(Sep 15 2021 at 23:24)</a>:</h4>
<p>i'm thinking of an api very much like arrayvec</p>



<a name="253503752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503752">(Sep 15 2021 at 23:24)</a>:</h4>
<p>though that only covers one of the two flexible-vectors styles</p>



<a name="253503797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503797">(Sep 15 2021 at 23:25)</a>:</h4>
<p>My point is that our existing,<br>
const sized vector programming<br>
can be compiled in a way to exploit hardware vector lanes fully, possibly by doing a bit of math occasionally.</p>



<a name="253503822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503822">(Sep 15 2021 at 23:25)</a>:</h4>
<p>My point is exactly that nothing needs to change about the Rust.</p>



<a name="253503879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503879">(Sep 15 2021 at 23:26)</a>:</h4>
<p>Hmm.</p>



<a name="253503906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503906">(Sep 15 2021 at 23:26)</a>:</h4>
<p>Now, I expect this might not fully exploit the vector programming model SVE offers.</p>



<a name="253503941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503941">(Sep 15 2021 at 23:27)</a>:</h4>
<p>So if you have <code>Simd&lt;f32, 1024&gt;::add</code>, doesn't that need to generate a loop because the vector might be as small as 128?</p>



<a name="253503997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253503997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253503997">(Sep 15 2021 at 23:27)</a>:</h4>
<p>That was already an issue. :D</p>



<a name="253504010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504010">(Sep 15 2021 at 23:27)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">SimdVec</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">MAX_LEN</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">data</span>: <span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="n">MAX_LEN</span><span class="p">],</span><span class="w"> </span><span class="c1">// the vector's underlying storage, the part llvm sees as a vector</span>
<span class="w">    </span><span class="n">len</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="c1">// maybe passed in to methods instead of kept with data?</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="253504055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504055">(Sep 15 2021 at 23:28)</a>:</h4>
<p>Well, if you have fixed size vectors it doesn't create a loop!</p>



<a name="253504064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504064">(Sep 15 2021 at 23:28)</a>:</h4>
<p>Please no sidetracks.</p>



<a name="253504073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504073">(Sep 15 2021 at 23:28)</a>:</h4>
<p>Sure it does.</p>



<a name="253504122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504122">(Sep 15 2021 at 23:28)</a>:</h4>
<p>Is it actually ever represented in LLVM as a loop?</p>



<a name="253504132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504132">(Sep 15 2021 at 23:28)</a>:</h4>
<p>Yes, if the vector is bigger than the hardware can actually have, LLVM totally can compile it into a loop.</p>



<a name="253504147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504147">(Sep 15 2021 at 23:29)</a>:</h4>
<p>currently a <code>f32x1024</code> creates a bunch of duplicate instructions, never a loop (iirc)</p>



<a name="253504166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504166">(Sep 15 2021 at 23:29)</a>:</h4>
<p>Oh whatever. <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="253504180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504180">(Sep 15 2021 at 23:29)</a>:</h4>
<p>Yeah, I've never seen it create a loop.  I'm not saying it can't, but I think that falls out of an asm optimization, not lowering from IR</p>



<a name="253504199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504199">(Sep 15 2021 at 23:29)</a>:</h4>
<p>I literally do not care about the difference atm.</p>



<a name="253504288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504288">(Sep 15 2021 at 23:30)</a>:</h4>
<p>Okay but I do!! My point is that with a runtime factor you _must_ generate a loop, you cannot simply create duplicate instructions</p>



<a name="253504336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504336">(Sep 15 2021 at 23:30)</a>:</h4>
<p>the optimal selection between the same sequence of repeating instructions and a loop depends on the arch details and codegen size.</p>



<a name="253504358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504358">(Sep 15 2021 at 23:31)</a>:</h4>
<p>I agree with that--but that's not my point</p>



<a name="253504364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504364">(Sep 15 2021 at 23:31)</a>:</h4>
<p>duplicate instructions work because llvm compiles dynamic lengths into masks (for x86), not loop counters</p>



<a name="253504393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504393">(Sep 15 2021 at 23:31)</a>:</h4>
<p>that's cute.</p>



<a name="253504412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504412">(Sep 15 2021 at 23:31)</a>:</h4>
<p>LLVM lowers into duplicate instructions, which may then be optimized into a loop (I've never seen it done, but I suppose it could)</p>



<a name="253504475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504475">(Sep 15 2021 at 23:32)</a>:</h4>
<p>With a runtime factor, you must lower into a loop, and if you do that, you unavoidably run into loop fusion optimization</p>



<a name="253504501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504501">(Sep 15 2021 at 23:32)</a>:</h4>
<p>I mentioned a loop because both SVE and RVV have arch-optimized predicated loop instructions.</p>



<a name="253504553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504553">(Sep 15 2021 at 23:33)</a>:</h4>
<p>with a runtime factor, you <em>don't need</em> a loop, you can generate masks, which is what llvm does for non-flexible-vector-targets</p>



<a name="253504554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504554">(Sep 15 2021 at 23:33)</a>:</h4>
<p>I am suggesting that with SVE (without multiversioning) there is absolutely no way to not lower into a loop with vectors over a certain size</p>



<a name="253504653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504653">(Sep 15 2021 at 23:34)</a>:</h4>
<p>for SVE or RVV, idk what llvm does...it could just assert fail</p>



<a name="253504664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504664">(Sep 15 2021 at 23:34)</a>:</h4>
<p><span class="user-mention" data-user-id="229517">@Jacob Lifshay</span> I think you are focusing on smaller vectors, I am more concerned about larger vectors?</p>



<a name="253504716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504716">(Sep 15 2021 at 23:34)</a>:</h4>
<p>i was focusing on targeting an arch that doesn't natively have dynamic lengths</p>



<a name="253504752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504752">(Sep 15 2021 at 23:35)</a>:</h4>
<p>Yeah we aren't discussing that.</p>



<a name="253504774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504774">(Sep 15 2021 at 23:35)</a>:</h4>
<p>llvm assumes you'll use vectors small enough for overhead to be not absurd</p>



<a name="253504775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504775">(Sep 15 2021 at 23:35)</a>:</h4>
<p>Just to make sure we are on the same page <span class="user-mention" data-user-id="281757">@Jubilee</span>, do you see a way to do <code>Simd&lt;f32, 1024&gt;::add</code> without generating an actual test-index-and-jump loop?</p>



<a name="253504786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504786">(Sep 15 2021 at 23:35)</a>:</h4>
<p>(with SVE)</p>



<a name="253504976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253504976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253504976">(Sep 15 2021 at 23:37)</a>:</h4>
<p>for <code>Simd&lt;f32, 1024&gt;::add</code>, last I checked, llvm's rvv backend just crashes at compile-time if the native vectors aren't long enough</p>



<a name="253505098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253505098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253505098">(Sep 15 2021 at 23:38)</a>:</h4>
<p>though I did check a slightly different op...</p>



<a name="253505110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253505110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253505110">(Sep 15 2021 at 23:38)</a>:</h4>
<p>icr what</p>



<a name="253505228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253505228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253505228">(Sep 15 2021 at 23:39)</a>:</h4>
<p>So,<br>
I have not reviewed every single SVE instruction so I don't know,<br>
but I am gonna be honest with you,<br>
No one should be using vectors larger than a cache line, and we should not encourage users to use vectors that emit more than 64 bytes of code just to handle one of them.</p>



<a name="253505358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253505358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253505358">(Sep 15 2021 at 23:41)</a>:</h4>
<p>It's mathematically insane considering the constraints the hardware is under BEFORE we enter SIMD into the mix.</p>



<a name="253505455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253505455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253505455">(Sep 15 2021 at 23:42)</a>:</h4>
<p>Okay, lets say <code>Simd&lt;f32, 16&gt;</code> and keep it simple</p>



<a name="253505662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253505662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253505662">(Sep 15 2021 at 23:44)</a>:</h4>
<p>Are we expecting it to generate 4 instructions and then mask the vector size down to 128?</p>



<a name="253505741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253505741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253505741">(Sep 15 2021 at 23:45)</a>:</h4>
<p>I think you brought up a very good point re: what we should remain aware of! But it's a deeply degenerate case.</p>
<p>And in the presence of a known size where there are no iterations, SVE code can fall back on Neon.</p>



<a name="253505894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253505894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253505894">(Sep 15 2021 at 23:46)</a>:</h4>
<p>Okay, so in this case I think it's the same as running x86 without multiversioning--it would work but it's pretty lame compared to multiversioning for AVX-512</p>



<a name="253505966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253505966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253505966">(Sep 15 2021 at 23:47)</a>:</h4>
<p>SVE2 could constrain vector length to 256 bits tho', I think, and use two instructions. I think that's the minimum?</p>
<p>SVE2 is unavoidably specialized around parallelizing loop-shaped constructs.</p>



<a name="253506055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506055">(Sep 15 2021 at 23:48)</a>:</h4>
<p><code>Simd&lt;f32, 1024&gt;::add</code> on rvv with min hw vector len of 256-bits: <a href="https://gcc.godbolt.org/z/5b51Mh4xa">https://gcc.godbolt.org/z/5b51Mh4xa</a></p>



<a name="253506057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506057">(Sep 15 2021 at 23:48)</a>:</h4>
<p>I think in this case I would argue that we shouldn't have to do anything special, LLVM should handle regular fixed size vectors optimally when you have SVE?</p>



<a name="253506206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506206">(Sep 15 2021 at 23:50)</a>:</h4>
<p>Correct.<br>
I am merely saying, essentially,<br>
that telling people they GOTTA multiversion is likely incorrect.</p>



<a name="253506328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506328">(Sep 15 2021 at 23:52)</a>:</h4>
<p>for rvv, unless you tell llvm there's a min guaranteed hw vector len, fixed length vectors just generate scalar instructions and ignore rvv completely</p>



<a name="253506368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506368">(Sep 15 2021 at 23:52)</a>:</h4>
<p>lmao</p>



<a name="253506381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506381">(Sep 15 2021 at 23:52)</a>:</h4>
<p>So I tried enabling SVE, and it just generated 4 neon instructions</p>



<a name="253506408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506408">(Sep 15 2021 at 23:53)</a>:</h4>
<p>which I think is likely the more efficient way, anyway</p>



<a name="253506426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506426">(Sep 15 2021 at 23:53)</a>:</h4>
<p>so multiversioning on min supported vector len is a <em>very</em> good idea for rvv</p>



<a name="253506563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506563">(Sep 15 2021 at 23:54)</a>:</h4>
<p><span class="user-mention" data-user-id="312331">@Caleb Zulawski</span> you probably need a min vector len thing for sve too</p>



<a name="253506574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506574">(Sep 15 2021 at 23:54)</a>:</h4>
<p>well I am ignoring scalar vs. vector-enabled multiversioning.</p>



<a name="253506606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506606">(Sep 15 2021 at 23:54)</a>:</h4>
<p>If you do that then you're effectively setting a target feature!</p>



<a name="253506617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506617">(Sep 15 2021 at 23:55)</a>:</h4>
<p>yeah LLVM can be really dumb.</p>



<a name="253506644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506644">(Sep 15 2021 at 23:55)</a>:</h4>
<p>my point was, without llvm knowing a min supported length, it ignores rvv completely</p>



<a name="253506669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506669">(Sep 15 2021 at 23:55)</a>:</h4>
<p>A recent change now requires you to pass two args to LLVM to enable SSE4.2</p>



<a name="253506680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506680">(Sep 15 2021 at 23:55)</a>:</h4>
<p>(except for explicitly scalable ir)</p>



<a name="253506689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506689">(Sep 15 2021 at 23:55)</a>:</h4>
<p>hopefully that won't make it to 14.0 release</p>



<a name="253506761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506761">(Sep 15 2021 at 23:56)</a>:</h4>
<p>I think without determining a minimum vector length (at compile time or multiversioned) it will never be more efficient to generate SVE/RVV</p>



<a name="253506805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506805">(Sep 15 2021 at 23:56)</a>:</h4>
<p>Caleb.</p>



<a name="253506808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506808">(Sep 15 2021 at 23:56)</a>:</h4>
<p>well, maybe for extremely long vectors it would be, but like you said, nothing reasonable</p>



<a name="253506841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506841">(Sep 15 2021 at 23:57)</a>:</h4>
<p>I am pretty sure what Jacob is saying is that you need two args to enable generating SVE code at all</p>



<a name="253506862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506862">(Sep 15 2021 at 23:57)</a>:</h4>
<p>that second argument is the minimum vector length!</p>



<a name="253506873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506873">(Sep 15 2021 at 23:57)</a>:</h4>
<p>which produces non-portable code.</p>



<a name="253506888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506888">(Sep 15 2021 at 23:57)</a>:</h4>
<p>...</p>



<a name="253506954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506954">(Sep 15 2021 at 23:58)</a>:</h4>
<p>idk, i'm just guessing llvm's sve backend is like it's rvv backend, they could be quite different!</p>



<a name="253506989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253506989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253506989">(Sep 15 2021 at 23:58)</a>:</h4>
<p>sigh.</p>



<a name="253507030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253507030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253507030">(Sep 15 2021 at 23:59)</a>:</h4>
<p>yeah, sorry, I'm easily distracted</p>



<a name="253507312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253507312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253507312">(Sep 16 2021 at 00:01)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> so I'm still not exactly sure what you are getting at.  If you don't want to multiversion, there's no reason to prefer SVE over NEON, since you are going to have 128 bit vectors max either way</p>



<a name="253507315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253507315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253507315">(Sep 16 2021 at 00:01)</a>:</h4>
<p>now that i'm thinking of it, it could be the abi of passing vectors by value that's making sve get not used</p>



<a name="253507634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253507634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253507634">(Sep 16 2021 at 00:04)</a>:</h4>
<p>which flag did you use to enable sve?</p>



<a name="253507662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253507662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253507662">(Sep 16 2021 at 00:04)</a>:</h4>
<p><code>-march=armv8-a+sve</code></p>



<a name="253507676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253507676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253507676">(Sep 16 2021 at 00:05)</a>:</h4>
<p>thx!</p>



<a name="253509550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253509550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253509550">(Sep 16 2021 at 00:28)</a>:</h4>
<p>the micro case of the code it emits for a single vector add of a fat vector does not really matter because we are talking about programs which contain looping constructs. the design of the architecture revolves around reducing loops into predicates, controlling operations via <code>whilelt</code> and <code>whilelo</code>. of course if you pick something it isn't actually good at, i.e. improving performance in a minimal procedure, instead of a multistep procedure, it is bad. if there is no way for it to parallelize it, it doesn't.</p>
<p>I really have no idea why you are so fixated on avoiding a jump.</p>



<a name="253509751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253509751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253509751">(Sep 16 2021 at 00:31)</a>:</h4>
<p>you just defined loop fusion!!</p>



<a name="253509767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253509767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253509767">(Sep 16 2021 at 00:31)</a>:</h4>
<p>In my experience, it is not good at optimizing it, that is my concern.</p>



<a name="253509780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253509780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253509780">(Sep 16 2021 at 00:31)</a>:</h4>
<p>It is built into the architecture, Caleb.</p>



<a name="253509786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253509786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253509786">(Sep 16 2021 at 00:31)</a>:</h4>
<p>If it were good at it, I would have no problem with it</p>



<a name="253509798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253509798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253509798">(Sep 16 2021 at 00:31)</a>:</h4>
<p>It is built into the architecture, Caleb.</p>



<a name="253509860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253509860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253509860">(Sep 16 2021 at 00:32)</a>:</h4>
<p>Fusing the loops generated by multiple LLVM intrinsics is not.</p>



<a name="253509925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253509925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253509925">(Sep 16 2021 at 00:33)</a>:</h4>
<p>which is why if we emit... ARGH.<br>
this is what I am talking about.</p>
<p>I don't have any more energy for this today because I rather feel like you are taking out your hostility to loop fusion, LLVM, and gcc on me.</p>



<a name="253509957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253509957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253509957">(Sep 16 2021 at 00:33)</a>:</h4>
<p>I am not! I agree with you that, if it were able to merge those loops perfectly, the way to go</p>



<a name="253510053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253510053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253510053">(Sep 16 2021 at 00:34)</a>:</h4>
<p>we know what is happening and can influence the way that rustc emits LLIR so that it knows to elevate to scalable vectors.</p>



<a name="253510325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253510325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253510325">(Sep 16 2021 at 00:38)</a>:</h4>
<p>but since no one else sees the merit in doing that, because "loop fusion in LLVM is doomed", even though I am talking about potentially emitting an entirely different LLIR construct, I guess I won't bother.</p>



<a name="253510553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253510553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253510553">(Sep 16 2021 at 00:40)</a>:</h4>
<p>are you suggesting that, in the final asm (not the llvm abstraction) it is not looping?</p>



<a name="253510576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253510576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253510576">(Sep 16 2021 at 00:41)</a>:</h4>
<p>I'm also not saying it's doomed, I'm just suggesting that it likely won't work well in at least some circumstances</p>



<a name="253510583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253510583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253510583">(Sep 16 2021 at 00:41)</a>:</h4>
<p>what does it even matter at this point since it's not happening.</p>



<a name="253510591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253510591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253510591">(Sep 16 2021 at 00:41)</a>:</h4>
<p>yeah yeah I got it.</p>



<a name="253510606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253510606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253510606">(Sep 16 2021 at 00:41)</a>:</h4>
<p>trying is a waste of time.</p>



<a name="253512031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253512031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253512031">(Sep 16 2021 at 00:59)</a>:</h4>
<p>I'm looking at the LLVM lang ref</p>



<a name="253512037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253512037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253512037">(Sep 16 2021 at 00:59)</a>:</h4>
<p>which intrinsic are you suggesting using?</p>



<a name="253512715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253512715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253512715">(Sep 16 2021 at 01:07)</a>:</h4>
<p>why?</p>



<a name="253512737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253512737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253512737">(Sep 16 2021 at 01:07)</a>:</h4>
<p>for using sve</p>



<a name="253512859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253512859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253512859">(Sep 16 2021 at 01:09)</a>:</h4>
<p>no, I mean why continue?</p>



<a name="253512977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253512977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253512977">(Sep 16 2021 at 01:10)</a>:</h4>
<p>I'm curious to see which specific intrinsic you were looking at</p>



<a name="253514494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253514494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253514494">(Sep 16 2021 at 01:30)</a>:</h4>
<p>i'm suggesting llvm.vp.*</p>



<a name="253514549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253514549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253514549">(Sep 16 2021 at 01:31)</a>:</h4>
<p>which shouldn't generate a loop--it usually generates 1 or a few instructions</p>



<a name="253514597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253514597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253514597">(Sep 16 2021 at 01:31)</a>:</h4>
<p>maybe I'm confused but that seems to be the "shrinking vector case" which I don't think is what this conversation was supposed to be about?</p>



<a name="253514618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253514618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253514618">(Sep 16 2021 at 01:32)</a>:</h4>
<p>though I'm also not sure I'm reading what those intrinsics do correctly</p>



<a name="253514715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253514715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253514715">(Sep 16 2021 at 01:33)</a>:</h4>
<p>well, the llvm.vp instructions cover predication, vector length, scalable/not, and storage in scalable/not</p>



<a name="253514730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253514730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253514730">(Sep 16 2021 at 01:33)</a>:</h4>
<p>so, they basically cover everything</p>



<a name="253514799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253514799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253514799">(Sep 16 2021 at 01:34)</a>:</h4>
<p>I helped with designing them, they're specifically designed to cover everything</p>



<a name="253515321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253515321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253515321">(Sep 16 2021 at 01:40)</a>:</h4>
<p>(admittedly I didn't help a whole lot, mostly by just commenting on the email thread)</p>



<a name="253515348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253515348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253515348">(Sep 16 2021 at 01:40)</a>:</h4>
<p>a sorta-good intro to the llvm.vp instructions: <a href="https://llvm.org/docs/LangRef.html#vector-predication-intrinsics">https://llvm.org/docs/LangRef.html#vector-predication-intrinsics</a></p>



<a name="253515824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253515824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253515824">(Sep 16 2021 at 01:46)</a>:</h4>
<p>maybe a better spot to look is an old rfc: <a href="https://reviews.llvm.org/D57504">https://reviews.llvm.org/D57504</a></p>



<a name="253516066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Hardware%20flexible%20vector%20support/near/253516066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Hardware.20flexible.20vector.20support.html#253516066">(Sep 16 2021 at 01:49)</a>:</h4>
<p>see also <a href="https://github.com/llvm/llvm-project/blob/main/llvm/docs/Proposals/VectorPredication.rst">https://github.com/llvm/llvm-project/blob/main/llvm/docs/Proposals/VectorPredication.rst</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>