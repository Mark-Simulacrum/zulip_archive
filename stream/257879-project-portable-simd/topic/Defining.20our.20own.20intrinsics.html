<html>
<head><meta charset="utf-8"><title>Defining our own intrinsics · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html">Defining our own intrinsics</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270907063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270907063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270907063">(Feb 06 2022 at 19:28)</a>:</h4>
<p>I have reached the conclusion that where it is warranted, we should consider implementing things like <code>dyn_swizzle</code> by describing an intrinsic and then describing a custom lowering for it.</p>



<a name="270907136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270907136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270907136">(Feb 06 2022 at 19:30)</a>:</h4>
<p>The main issue with this is that we don't have access to the target features available during instruction lowering</p>



<a name="270907184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270907184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270907184">(Feb 06 2022 at 19:31)</a>:</h4>
<p>I think it would make more sense to move the wasm dynamic shuffle lowering logic to the relevant backends in LLVM</p>



<a name="270907191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270907191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270907191">(Feb 06 2022 at 19:31)</a>:</h4>
<p>(make them available outside of just wasm)</p>



<a name="270907328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270907328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270907328">(Feb 06 2022 at 19:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics/near/270907136">said</a>:</p>
<blockquote>
<p>The main issue with this is that we don't have access to the target features available during instruction lowering</p>
</blockquote>
<p>I am pretty sure we do if the feature is defined on the target-level basis like with <code>thumbv7neon</code>.</p>



<a name="270907338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270907338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270907338">(Feb 06 2022 at 19:35)</a>:</h4>
<p>( I cheerfully concede the rest, however. )</p>



<a name="270907546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270907546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270907546">(Feb 06 2022 at 19:39)</a>:</h4>
<p>My problem is, that I would cheerfully back such a proposal, except:<br>
I am great at Rust!<br>
I am good at Assembly.<br>
I am even decent at LLVMIR at this point.<br>
And I can manage C.<br>
...nontrivial C++ still has me go "what the devil is that?"<br>
So I try to avoid proposing things I know I would <strong>have</strong> to stick someone else with implementing, unfortunately. ^^;</p>



<a name="270908135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270908135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270908135">(Feb 06 2022 at 19:51)</a>:</h4>
<p>the annoying part is LLVM isn't even usual C++, they use tons of custom code in unusual ways, e.g. they totally replaced the run-time type information that C++ usually provides</p>



<a name="270908275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270908275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270908275">(Feb 06 2022 at 19:53)</a>:</h4>
<p>For some targets that would work, but x86-64 is presumably the most commonly used target and doesn't even have pshufb available with the base feature level and would need to use a scalar shuffle, basically defeating the purpose in the first place</p>



<a name="270908319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270908319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270908319">(Feb 06 2022 at 19:54)</a>:</h4>
<p>Yeah I'm quite familiar with C++ but have struggled to make changes in LLVM</p>



<a name="270908841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270908841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270908841">(Feb 06 2022 at 20:02)</a>:</h4>
<p>Anyway, my hypothesis is that by getting ahead of the game and defining it at the intrinsic level on our side, we can allow e.g. Cranelift to support it, since they almost certainly already do, and ideally just swap out the logic when LLVM improves.</p>



<a name="270909513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270909513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270909513">(Feb 06 2022 at 20:17)</a>:</h4>
<p>As far as x86:<br>
I think we should go back to pushing for an x86-64-v3 compiler target.</p>



<a name="270909579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270909579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270909579">(Feb 06 2022 at 20:18)</a>:</h4>
<p>That only helps people that can use that target, of course</p>



<a name="270909610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270909610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270909610">(Feb 06 2022 at 20:19)</a>:</h4>
<p>Yup.</p>



<a name="270909869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Defining%20our%20own%20intrinsics/near/270909869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Defining.20our.20own.20intrinsics.html#270909869">(Feb 06 2022 at 20:25)</a>:</h4>
<p>I have no answer to this other than:<br>
The world is fundamentally unjust.<br>
Woe to the conquered.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>