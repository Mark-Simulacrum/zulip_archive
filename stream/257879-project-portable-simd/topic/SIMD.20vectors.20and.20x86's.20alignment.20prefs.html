<html>
<head><meta charset="utf-8"><title>SIMD vectors and x86&#x27;s alignment prefs · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html">SIMD vectors and x86&#x27;s alignment prefs</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271765121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271765121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271765121">(Feb 13 2022 at 20:58)</a>:</h4>
<p>So, on x86, all vectors should be aligned to 16 at minimum.<br>
Currently, <code>Simd</code> aligns to 8 if it's a combination like <code>f32x2</code>.<br>
If we want <code>Simd</code> to always load into a vector register if available, which is what <a href="https://github.com/rust-lang/portable-simd/issues/94">https://github.com/rust-lang/portable-simd/issues/94</a> implies, and for it to be sound to emit <code>movaps</code> to do that,  etc., we should consider making its alignment always be at least 16 on x86. However, that has other problems, obviously, starting with "teaching Rust programmers how to use an architecture-dependent alignment".<br>
I think we can do this via <code>cfg_attr</code>, but even if we can't: compiler magic <strong>is</strong> available to us. We have already begun to  dictate the terms of <code>#[repr(simd)]</code>, so we should consider ourselves allowed to do that.<br>
Cue <span class="user-mention" data-user-id="229517">@Jacob Lifshay</span>'s remarks about alignment for SimpleV and other vector architectures. :^)</p>



<a name="271772118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271772118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271772118">(Feb 13 2022 at 23:35)</a>:</h4>
<p>imho we should at least define that power-of-2 sized vector types never have padding, because of the expectation that transmuting <code>[f32x2; 2]</code> to <code>f32x4</code> should work -- that doesn't work with <code>f32x2</code> being aligned to 16 bytes since you need 8 bytes of padding to get align 16. also, x86 has instructions for loading/storing <code>f32x2</code> out of a xmm register.</p>



<a name="271772139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271772139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271772139">(Feb 13 2022 at 23:35)</a>:</h4>
<p>this means all power-of-2 types always have <code>align&lt;=LANES*sizeof(element)</code></p>



<a name="271772217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271772217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271772217">(Feb 13 2022 at 23:37)</a>:</h4>
<p>I think I agree, at worst a load or store could be implemented with scalars</p>



<a name="271772283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271772283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271772283">(Feb 13 2022 at 23:38)</a>:</h4>
<p>If a user wants to explicitly pad for performance they could for example do loads as f32x8 and then swizzle to f32x7</p>



<a name="271772355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271772355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271772355">(Feb 13 2022 at 23:40)</a>:</h4>
<p>Jubilee and I discovered a while ago that Rust's vector alignments today are... arbitrary</p>



<a name="271772598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271772598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271772598">(Feb 13 2022 at 23:47)</a>:</h4>
<p>Does LLVM care what the alignment is?</p>



<a name="271773358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271773358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271773358">(Feb 14 2022 at 00:04)</a>:</h4>
<blockquote>
<p>Does LLVM care what the alignment is?</p>
</blockquote>
<p>afaict not really, basically anything that loads/stores vectors lets you set the alignment to any user-specified value</p>



<a name="271773522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271773522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271773522">(Feb 14 2022 at 00:08)</a>:</h4>
<p>I definitely want f32x4 to never have padding and for that to be a hard guarantee.</p>



<a name="271774427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271774427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271774427">(Feb 14 2022 at 00:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86's.20alignment.20prefs/near/271773358">said</a>:</p>
<blockquote>
<blockquote>
<p>Does LLVM care what the alignment is?</p>
</blockquote>
<p>afaict not really, basically anything that loads/stores vectors lets you set the alignment to any user-specified value</p>
</blockquote>
<p>I guess a better question might be "does LLVM care as in ruthlessly deoptimize your code if you break from this assumption?"</p>



<a name="271774504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271774504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271774504">(Feb 14 2022 at 00:30)</a>:</h4>
<p>Alignment should only affect optimization of loads and stores, which IMO is not the thing we should be optimizing</p>



<a name="271774514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271774514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271774514">(Feb 14 2022 at 00:31)</a>:</h4>
<p>Particularly for non-native vector sizes, I mean</p>



<a name="271774571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271774571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271774571">(Feb 14 2022 at 00:32)</a>:</h4>
<p>If f32x7 has the same alignment as f32x8 I could see that causing some unexpected behavior</p>



<a name="271783921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271783921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271783921">(Feb 14 2022 at 04:32)</a>:</h4>
<p>I would assume that doing any operations on <code>f32x7</code> would also hit the "ruthless deoptimization" stuff.</p>



<a name="271784081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271784081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271784081">(Feb 14 2022 at 04:37)</a>:</h4>
<p>How does it lower, on popular platforms?  <code>f32x8</code> with an <code>undef</code>, two <code>f32x4</code>s with overlap, <code>f32x4</code> + <code>f32x2</code> + <code>f32x1</code>?</p>



<a name="271785320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271785320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271785320">(Feb 14 2022 at 05:06)</a>:</h4>
<p>I've seen it do f32x8 with an undef lane</p>



<a name="271785496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271785496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271785496">(Feb 14 2022 at 05:10)</a>:</h4>
<p>hm, what does a dot product with f32x7s look like?</p>



<a name="271785511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271785511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271785511">(Feb 14 2022 at 05:10)</a>:</h4>
<p>I'm not sure why it would be much different than with 8 lanes?</p>



<a name="271785521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271785521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271785521">(Feb 14 2022 at 05:11)</a>:</h4>
<p>Oh, I know, but I am just wondering how it handles the trailing lane.</p>



<a name="271785540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271785540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271785540">(Feb 14 2022 at 05:11)</a>:</h4>
<p>I don't think it uses the hadd instruction on x86 anyway because it's too slow</p>



<a name="271785581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271785581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271785581">(Feb 14 2022 at 05:12)</a>:</h4>
<p>Oh yeah, that part is fine.</p>



<a name="271785589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271785589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271785589">(Feb 14 2022 at 05:12)</a>:</h4>
<p>Do you just mean the order?</p>



<a name="271785592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271785592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271785592">(Feb 14 2022 at 05:12)</a>:</h4>
<p>yes, basically.</p>



<a name="271787642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787642">(Feb 14 2022 at 06:00)</a>:</h4>
<p>I think we basically have two reasonable choices:</p>
<p>1) <code>sizeof(Simd&lt;T; N&gt;) == sizeof([T; N])</code>, and the alignment of the simd type is the highest possible value that divides the size evenly.  (<code>as_simd</code> wants this one, and it's pretty good for, say, N=24, but it's pretty poor for N=31.)</p>
<p>2) <code>sizeof(Simd&lt;T; N&gt;) == alignof(Simd&lt;T; N&gt;) == (sizeof(T)*N).next_power_of_two()</code> (which is basically the "stick <code>undef</code>s on the end" solution)</p>
<p>I think I lean towards (1), assuming that once they're in registers it doesn't matter, since one can always wrap them to get the padding version if so desired, but there's no way to remove it.  Of course, I guess the answer for avoiding storage could be to just store it as an array if you didn't want the possibility of padding off the end.</p>
<p>(Both choices lead to <code>size == align == some_power_of_two</code> for power-of-two numbers of lanes, as expected.)</p>



<a name="271787685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787685">(Feb 14 2022 at 06:01)</a>:</h4>
<p>I hadn't considered the GCF as an option.</p>



<a name="271787797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787797">(Feb 14 2022 at 06:04)</a>:</h4>
<p>I should mention that when LLVM sticks undefs on the end, that's only in register, I don't believe loads and stores assume there are extra lanes</p>



<a name="271787829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787829">(Feb 14 2022 at 06:05)</a>:</h4>
<p>Which should be compatible with 1</p>



<a name="271787830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787830">(Feb 14 2022 at 06:05)</a>:</h4>
<p>GCF was inspired by the idea that <code>Simd&lt;f32, 12&gt;</code>  might end up lowered to <code>Simd&lt;f32, 4&gt;</code> anyway, so align=16 for it might be totally fine.</p>



<a name="271787833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787833">(Feb 14 2022 at 06:05)</a>:</h4>
<p>on risc-v, SimpleV, and a few other architectures (SVE?), there's also option 3: <code>sizeof(Simd&lt;T, N&gt;) == N * sizeof(T)</code> <code>alignof(Simd&lt;T, N&gt;) == alignof(T)</code> aka. layout is exactly the same as <code>[T; N]</code></p>



<a name="271787887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787887">(Feb 14 2022 at 06:06)</a>:</h4>
<p>Yeah I was going to suggest the possibility of alignment being an implementation detail and we simply say it's a multiple of T but it's unspecified?</p>



<a name="271787892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787892">(Feb 14 2022 at 06:06)</a>:</h4>
<p>I imagine on different architectures it could be wildly different</p>



<a name="271787898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787898">(Feb 14 2022 at 06:07)</a>:</h4>
<p>imho we should pick option 1 on x86 and option 3 on risc-v and SimpleV, and 1 or 3 as needed on the other architectures</p>



<a name="271787913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787913">(Feb 14 2022 at 06:07)</a>:</h4>
<p>I kinda wish we could use const generics to let users specify the alignment exactly for whatever arcane reason but have a default.</p>



<a name="271787914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787914">(Feb 14 2022 at 06:07)</a>:</h4>
<p>We do already even have u64 having different possible alignments, so it's not without precedent.</p>



<a name="271787956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787956">(Feb 14 2022 at 06:08)</a>:</h4>
<p>Yeah, on 32-bit machines, u64 has align 4, right?</p>



<a name="271787964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787964">(Feb 14 2022 at 06:08)</a>:</h4>
<p>I didn't know that, I think it would be great justification for vectors having arbitrary alignments.</p>



<a name="271787970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787970">(Feb 14 2022 at 06:08)</a>:</h4>
<p>on i686 in particular...some other 32-bit archs have align 8 i64</p>



<a name="271787973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787973">(Feb 14 2022 at 06:08)</a>:</h4>
<p>Mmm.</p>



<a name="271787974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787974">(Feb 14 2022 at 06:08)</a>:</h4>
<p>It's really the same principle</p>



<a name="271787975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787975">(Feb 14 2022 at 06:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86's.20alignment.20prefs/near/271787956">said</a>:</p>
<blockquote>
<p>Yeah, on 32-bit machines, u64 has align 4, right?</p>
</blockquote>
<p>That's my recollection, yeah.</p>



<a name="271787985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787985">(Feb 14 2022 at 06:09)</a>:</h4>
<p>So then the question is just whether we want to say anything about <code>sizeof(Simd&lt;T, N&gt;)</code>?</p>



<a name="271787986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787986">(Feb 14 2022 at 06:09)</a>:</h4>
<p>do any of these answers complicate the world from the UCG point of view?</p>



<a name="271787996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271787996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271787996">(Feb 14 2022 at 06:09)</a>:</h4>
<p>I would prefer to specify the size is identical to that of an array</p>



<a name="271788033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788033">(Feb 14 2022 at 06:10)</a>:</h4>
<p>Currently we specify that the alignment is based on T and N in some unspecified way, if I remember the docs I just wrote.</p>



<a name="271788038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788038">(Feb 14 2022 at 06:10)</a>:</h4>
<p>imho <code>sizeof(Simd&lt;T, N&gt;)</code> should always be exactly <code>sizeof([T; N])</code></p>



<a name="271788047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788047">(Feb 14 2022 at 06:10)</a>:</h4>
<p>I think "is it possible that there's padding" is my far the most impactful choice, and it sounds like nobody wants that.</p>



<a name="271788062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788062">(Feb 14 2022 at 06:11)</a>:</h4>
<p><code>size_of</code> includes padding though.</p>



<a name="271788080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788080">(Feb 14 2022 at 06:11)</a>:</h4>
<p><a href="https://doc.rust-lang.org/stable/std/mem/fn.size_of.html">https://doc.rust-lang.org/stable/std/mem/fn.size_of.html</a> is this table wrong?</p>



<a name="271788127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788127">(Feb 14 2022 at 06:12)</a>:</h4>
<p>So it seems quite reasonable to me to just say</p>
<ul>
<li><code>sizeof(Simd&lt;T, N&gt;) == sizeof([T; N])</code> and</li>
<li><code>alignof(Simd&lt;T, N&gt;) &gt;= alignof([T; N])</code>.</li>
</ul>
<p>That allows <code>AsRef</code> as <code>as_simd</code>, but doesn't say anything more.  And thus it's compatible with (1) on x64 and (3) on risc-v</p>



<a name="271788128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788128">(Feb 14 2022 at 06:12)</a>:</h4>
<p>hm.</p>



<a name="271788130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788130">(Feb 14 2022 at 06:12)</a>:</h4>
<p>I think we're saying that vectors shouldn't have any padding</p>



<a name="271788156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788156">(Feb 14 2022 at 06:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86's.20alignment.20prefs/near/271788080">said</a>:</p>
<blockquote>
<p><a href="https://doc.rust-lang.org/stable/std/mem/fn.size_of.html">https://doc.rust-lang.org/stable/std/mem/fn.size_of.html</a> is this table wrong?</p>
</blockquote>
<p>No, but that's just size, not alignment.  (So I'm not sure what you mean by the reference.)</p>



<a name="271788157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788157">(Feb 14 2022 at 06:13)</a>:</h4>
<p>Ah.<br>
Hmm. Yeah, min align is definitely <code>[T; N]</code>.</p>



<a name="271788165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788165">(Feb 14 2022 at 06:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86's.20alignment.20prefs/near/271788156">said</a>:</p>
<blockquote>
<p>No, but that's just size, not alignment.  (So I'm not sure what you mean by the reference.)</p>
</blockquote>
<p>No idea tbh.</p>



<a name="271788225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788225">(Feb 14 2022 at 06:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86's.20alignment.20prefs/near/271787913">said</a>:</p>
<blockquote>
<p>I kinda wish we could use const generics to let users specify the alignment exactly for whatever arcane reason but have a default.</p>
</blockquote>
<p>Is there some reason that having it in the type itself would be better for codegen than just letting them wrap it in a newtype with <code>repr(align(whatever))</code> to over-align and add padding?</p>



<a name="271788228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788228">(Feb 14 2022 at 06:15)</a>:</h4>
<p>I'm reluctant to say vectors shouldn't have padding for the f32x3 case. I want to know more about some esoteric layout considerations in some existing machine APIs people want to program against first before committing to an answer.</p>



<a name="271788289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788289">(Feb 14 2022 at 06:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86's.20alignment.20prefs/near/271788225">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86's.20alignment.20prefs/near/271787913">said</a>:</p>
<blockquote>
<p>I kinda wish we could use const generics to let users specify the alignment exactly for whatever arcane reason but have a default.</p>
</blockquote>
<p>Is there some reason that having it in the type itself would be better for codegen than just letting them wrap it in a newtype with <code>repr(align(whatever))</code> to over-align and add padding?</p>
</blockquote>
<p>I mean mostly I just want layout details controllable like it's an associated constant instead of an attribute period.</p>



<a name="271788298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788298">(Feb 14 2022 at 06:16)</a>:</h4>
<p>Fwiw if you need some exotic layout I think you shouldn't be using vectors as your API then, you should load with your required layout and transmute those to vectors</p>



<a name="271788308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788308">(Feb 14 2022 at 06:16)</a>:</h4>
<p>Well I am thinking of things like Vec3s.</p>



<a name="271788310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788310">(Feb 14 2022 at 06:17)</a>:</h4>
<p>Vectors have the explicit purpose of doing vectory things and not memory things</p>



<a name="271788313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788313">(Feb 14 2022 at 06:17)</a>:</h4>
<p>which cause great amounts of gnashing and wailing of teeth.</p>



<a name="271788319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788319">(Feb 14 2022 at 06:17)</a>:</h4>
<p>I definitely would like a way to set align that's not an attribute but something that can come from a const generic, <span class="user-mention" data-user-id="281757">@Jubilee</span></p>



<a name="271788321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788321">(Feb 14 2022 at 06:17)</a>:</h4>
<p>...that's backwards but you get the idea.</p>



<a name="271788376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788376">(Feb 14 2022 at 06:18)</a>:</h4>
<p>Clearly we just need everyone to use homogeneous coordinates in their vectors everywhere, so they're just Vec4s ;)</p>



<a name="271788380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788380">(Feb 14 2022 at 06:18)</a>:</h4>
<p>lmao</p>



<a name="271788385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788385">(Feb 14 2022 at 06:18)</a>:</h4>
<p>I am definitely currently inclined to the GCF solution as our preferred default answer, though.</p>



<a name="271788392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788392">(Feb 14 2022 at 06:19)</a>:</h4>
<p>but...i want homogeneous coordinates in my 2D graphics...vec3</p>



<a name="271788393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788393">(Feb 14 2022 at 06:19)</a>:</h4>
<p>I'm okay with any solution really if we think it's okay to say it's unspecified (but compatible with arrays)</p>



<a name="271788459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788459">(Feb 14 2022 at 06:20)</a>:</h4>
<p>define "compatible with arrays"</p>



<a name="271788471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788471">(Feb 14 2022 at 06:20)</a>:</h4>
<p>As defined before I meant, same size and greater alignment</p>



<a name="271788474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788474">(Feb 14 2022 at 06:20)</a>:</h4>
<p>I feel like the guarantee that people will really want is things like "on x86, <code>Simd&lt;f32, 4&gt;</code> has the same size+align as <code>__m128</code>", which should be fine, because there's a limited set of those platform types.</p>



<a name="271788476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788476">(Feb 14 2022 at 06:20)</a>:</h4>
<p>Basically can implement AsRef</p>



<a name="271788498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788498">(Feb 14 2022 at 06:21)</a>:</h4>
<p>Yeah, I think we have some flexibility for non-vendor types</p>



<a name="271788501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788501">(Feb 14 2022 at 06:21)</a>:</h4>
<p>cuz <code>&amp;mut &amp;mut [f32; 35] -&gt; &amp;mut &amp;mut Simd&lt;f32, 35&gt;</code> being valid means align must be same as f32</p>



<a name="271788547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788547">(Feb 14 2022 at 06:22)</a>:</h4>
<p>Yeah I just meant compatible in the vector to array direction, not opposite of course</p>



<a name="271788556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788556">(Feb 14 2022 at 06:23)</a>:</h4>
<p>yeah, I think we should always cough politely at people trying to turn arrays into vectors without using a dedicated function or <code>read_unaligned</code>.</p>



<a name="271788610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788610">(Feb 14 2022 at 06:24)</a>:</h4>
<p>which means we will want to provide functions to make sure all those use cases can happen.</p>



<a name="271788619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788619">(Feb 14 2022 at 06:24)</a>:</h4>
<p>so, we want to guarantee <code>&amp;mut [Simd&lt;T, N&gt;; M] -&gt; &amp;mut [[T; N]; M]</code> is valid?</p>



<a name="271788631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788631">(Feb 14 2022 at 06:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86's.20alignment.20prefs/near/271787986">said</a>:</p>
<blockquote>
<p>do any of these answers complicate the world from the UCG point of view?</p>
</blockquote>
<p>I don't think so, since it's largely not talked about ABIs.</p>
<p>Different alignments and paddings just fall under the normal UCG rules, as far as I can foresee.</p>



<a name="271788711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788711">(Feb 14 2022 at 06:27)</a>:</h4>
<p><span class="user-mention" data-user-id="229517">@Jacob Lifshay</span> isn't that only possible if the vector alignment is that of T and no higher?</p>



<a name="271788713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788713">(Feb 14 2022 at 06:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86's.20alignment.20prefs/near/271788619">said</a>:</p>
<blockquote>
<p>so, we want to guarantee <code>&amp;mut [Simd&lt;T, N&gt;; M] -&gt; &amp;mut [[T; N]; M]</code> is valid?</p>
</blockquote>
<p>There's already <code>&amp;mut Simd&lt;T, N&gt; -&gt; &amp;mut [T; N]</code> via <code>AsMut</code>, and I don't think the extra level of arrays matter -- array layout is specified to have no padding, and there's things like <a href="https://doc.rust-lang.org/nightly/std/array/fn.from_mut.html">https://doc.rust-lang.org/nightly/std/array/fn.from_mut.html</a> for general <code>&amp;mut T -&gt; &amp;mut [T; 1]</code>.</p>



<a name="271788787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271788787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271788787">(Feb 14 2022 at 06:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86's.20alignment.20prefs/near/271788711">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> isn't that only possible if the vector alignment is that of T and no higher?</p>
</blockquote>
<p>I think that's why the previous example had <code>&amp;mut &amp;mut</code> -- just one is fine, but if you have two then things get complicated.</p>
<p>(<code>&amp;mut T -&gt; &amp;mut U</code> does not imply <code>&amp;mut &amp;mut T -&gt; &amp;mut &amp;mut U</code>.)</p>



<a name="271789125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271789125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271789125">(Feb 14 2022 at 06:36)</a>:</h4>
<blockquote>
<p>so, we want to guarantee <code>&amp;mut [Simd&lt;T, N&gt;; M] -&gt; &amp;mut [[T; N]; M]</code> is valid?</p>
</blockquote>
<p>that implies size is same as array, but align of Simd can be higher, so long as no padding is introduced. just <code>&amp;mut Simd&lt;T, N&gt; -&gt; &amp;mut [T; N]</code> doesn't guarantee Simd has no padding, the padding would just not be accessible through the array reference.</p>



<a name="271789828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271789828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271789828">(Feb 14 2022 at 06:52)</a>:</h4>
<p>damn, apparently there's already RVV designs that have VLEN = 16384 (bits).</p>



<a name="271789843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271789843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271789843">(Feb 14 2022 at 06:53)</a>:</h4>
<p>Just in case</p>



<a name="271790748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271790748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271790748">(Feb 14 2022 at 07:10)</a>:</h4>
<p>apparently the biggest permitted by RISC-V V is <code>Simd&lt;u8, 65536&gt;</code></p>



<a name="271790873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271790873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271790873">(Feb 14 2022 at 07:13)</a>:</h4>
<p>indeed.</p>



<a name="271858171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271858171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271858171">(Feb 14 2022 at 17:16)</a>:</h4>
<p>oh,<br>
<span class="user-mention" data-user-id="229517">@Jacob Lifshay</span> it's apparently actually 2^(XLEN-1)</p>



<a name="271864108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271864108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271864108">(Feb 14 2022 at 18:01)</a>:</h4>
<p>not according to the <a href="https://github.com/riscv/riscv-v-spec/blob/v1.0/v-spec.adoc#2-implementation-defined-constant-parameters">risc-v v spec v1.0</a>:</p>
<blockquote>
<p>The upper limit on VLEN allows software to know that indices will fit into 16 bits (largest VLMAX of 65,536 occurs for LMUL=8 and SEW=8 with VLEN=65,536). Any future extension beyond 64Kib per vector register will require new configuration instructions such that software using the old configuration instructions does not see greater vector lengths.</p>
</blockquote>



<a name="271864262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271864262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271864262">(Feb 14 2022 at 18:02)</a>:</h4>
<p>in other words the largest vector supported by a single instruction is 65536 elements</p>



<a name="271878120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271878120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271878120">(Feb 14 2022 at 19:40)</a>:</h4>
<p>hmm.</p>



<a name="271878187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271878187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271878187">(Feb 14 2022 at 19:41)</a>:</h4>
<p>Okay I spotted the 2^(XLEN-1) bit here: <a href="https://github.com/riscv/riscv-v-spec/blob/v1.0/v-spec.adoc#153-vfirst-find-first-set-mask-bit">https://github.com/riscv/riscv-v-spec/blob/v1.0/v-spec.adoc#153-vfirst-find-first-set-mask-bit</a></p>



<a name="271879039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271879039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271879039">(Feb 14 2022 at 19:47)</a>:</h4>
<blockquote>
<p>... as vector lengths will never exceed 2(XLEN-1) on any implementation.</p>
</blockquote>



<a name="271879109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271879109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271879109">(Feb 14 2022 at 19:48)</a>:</h4>
<p>65536 never exceeds <code>2^(XLEN-1)</code></p>



<a name="271879174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271879174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271879174">(Feb 14 2022 at 19:49)</a>:</h4>
<p>Truuuuueeeee but this is phrased in a needlessly pedantic way.</p>



<a name="271879215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271879215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271879215">(Feb 14 2022 at 19:49)</a>:</h4>
<p>:)</p>



<a name="271880081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271880081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271880081">(Feb 14 2022 at 19:56)</a>:</h4>
<p>Okay that phrasing came from this and predated the 64KiB limit. <a href="https://github.com/riscv/riscv-v-spec/issues/204">https://github.com/riscv/riscv-v-spec/issues/204</a></p>



<a name="271891911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271891911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271891911">(Feb 14 2022 at 21:33)</a>:</h4>
<p>Oh and speaking of eliminating padding:<br>
I presume, without thinking about it too hard, we're basically in agreement that if <code>int&lt;N&gt;</code> becomes available, that <code>Simd&lt;int&lt;N&gt;, M&gt;</code> has the constraint that <code>N: N.is_power_of_two()</code>? At the very least?</p>



<a name="271892138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271892138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271892138">(Feb 14 2022 at 21:35)</a>:</h4>
<p>uuh...it'd be very nice to have vectors of <code>i1</code> at least...other int types would likely be useful too</p>



<a name="271892176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271892176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271892176">(Feb 14 2022 at 21:36)</a>:</h4>
<p>i1 is a power of 2. it's 2^0. <span aria-label="relieved" class="emoji emoji-1f60c" role="img" title="relieved">:relieved:</span></p>



<a name="271892289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271892289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271892289">(Feb 14 2022 at 21:36)</a>:</h4>
<p>it'd be nice to include non-power-of-2 types at some point, but not for a while</p>



<a name="271892506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271892506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271892506">(Feb 14 2022 at 21:38)</a>:</h4>
<p>e.g. unpacking r10g10b10a2 pixels where you'd likely want <code>u10</code> and <code>u2</code></p>



<a name="271892719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271892719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271892719">(Feb 14 2022 at 21:38)</a>:</h4>
<p>or r12g12b12a12</p>



<a name="271892845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271892845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271892845">(Feb 14 2022 at 21:39)</a>:</h4>
<p>unpacking into u16s?</p>



<a name="271893197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271893197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271893197">(Feb 14 2022 at 21:40)</a>:</h4>
<p>maybe running through the sRGB transfer function to convert to f32</p>



<a name="271893239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271893239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271893239">(Feb 14 2022 at 21:40)</a>:</h4>
<p>Hmm, I could see potentially offering special functions for vector bit-packing and vector bit-unpacking instead.</p>



<a name="271893343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271893343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271893343">(Feb 14 2022 at 21:41)</a>:</h4>
<p>well...imho we shouldn't rule out weird bit sizes, but can definitely put them on the back burner</p>



<a name="271893491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271893491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271893491">(Feb 14 2022 at 21:43)</a>:</h4>
<p>llvm <em>does</em> have defined semantics for what a <code>Simd&lt;int&lt;12&gt;, 14&gt;</code> means exactly</p>



<a name="271893534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271893534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271893534">(Feb 14 2022 at 21:43)</a>:</h4>
<p>I wouldn't rule them out <strong>entirely</strong>, I just wanted to temperature check while I work on something in the back of my head.<br>
what lol seriously.</p>



<a name="271893772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271893772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271893772">(Feb 14 2022 at 21:45)</a>:</h4>
<blockquote>
<p>A bitcast from a vector type to a scalar integer type will see the elements being packed together (without padding). The order in which elements are inserted in the integer depends on endianess. For little endian element zero is put in the least significant bits of the integer, and for big endian element zero is put in the most significant bits.</p>
</blockquote>



<a name="271894314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271894314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271894314">(Feb 14 2022 at 21:50)</a>:</h4>
<blockquote>
<p>Using a vector such as <code>&lt;i4 1, i4 2, i4 3, i4 5&gt;</code> as an example, together with the analogy that we can replace a vector store by a bitcast followed by an integer store, we get this for big endian:</p>
</blockquote>
<blockquote>
<p>```<br>
%val = bitcast &lt;4 x i4&gt; &lt;i4 1, i4 2, i4 3, i4 5&gt; to i16</p>
<p>; Bitcasting from a vector to an integral type can be seen as<br>
; concatenating the values:<br>
;   %val now has the hexadecimal value 0x1235.</p>
<p>store i16 %val, i16* %ptr</p>
<p>; In memory the content will be (8-bit addressing):<br>
;<br>
;    [%ptr + 0]: 00010010  (0x12)<br>
;    [%ptr + 1]: 00110101  (0x35)<br>
```<br>
The same example for little endian:</p>
<p>```<br>
%val = bitcast &lt;4 x i4&gt; &lt;i4 1, i4 2, i4 3, i4 5&gt; to i16</p>
<p>; Bitcasting from a vector to an integral type can be seen as<br>
; concatenating the values:<br>
;   %val now has the hexadecimal value 0x5321.</p>
<p>store i16 %val, i16* %ptr</p>
<p>; In memory the content will be (8-bit addressing):<br>
;<br>
;    [%ptr + 0]: 01010011  (0x53)<br>
;    [%ptr + 1]: 00100001  (0x21)<br>
```</p>
</blockquote>



<a name="271894465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271894465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271894465">(Feb 14 2022 at 21:51)</a>:</h4>
<p>sadness...multi-line code blocks in quoted sections don't work</p>



<a name="271894499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271894499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271894499">(Feb 14 2022 at 21:51)</a>:</h4>
<p>you can use ````quote</p>



<a name="271895012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/271895012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#271895012">(Feb 14 2022 at 21:56)</a>:</h4>
<p>thanks! fixed</p>



<a name="272195221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20vectors%20and%20x86%27s%20alignment%20prefs/near/272195221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20vectors.20and.20x86&#x27;s.20alignment.20prefs.html#272195221">(Feb 16 2022 at 23:40)</a>:</h4>
<p>Mmm, I can't manipulate the labels in the <a href="https://github.com/rust-lang/project-portable-simd">https://github.com/rust-lang/project-portable-simd</a> repo.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>