<html>
<head><meta charset="utf-8"><title>Algorithms on SIMD registers · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html">Algorithms on SIMD registers</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272906448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272906448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272906448">(Feb 23 2022 at 05:27)</a>:</h4>
<p>Hi all, has there been any thought put into whether it'd be appropriate to provide out-of-the box algorithms on top of SIMD vector registers within <code>std::simd</code>?  Many of the algorithms in <code>Iterator</code> have equivalents on SIMD registers, and a native SIMD implementation can be more efficient than e.g. converting to an array and using the scalar equivalent.  To make this a bit more concrete, a specific algorithm that'd be generally useful is a vector <code>scan</code> or <code>prefix_sum</code> function, for example:</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>



<a name="272906526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272906526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272906526">(Feb 23 2022 at 05:29)</a>:</h4>
<p>In particular I'm wondering about such algorithms that aren't expected to map directly to a single or a well known set of instructions.</p>



<a name="272906565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272906565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272906565">(Feb 23 2022 at 05:30)</a>:</h4>
<p>(credit for the above algorithm goes to <a href="https://en.algorithmica.org/hpc/algorithms/prefix/">https://en.algorithmica.org/hpc/algorithms/prefix/</a> , I just translated it to std::simd)</p>



<a name="272906978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272906978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272906978">(Feb 23 2022 at 05:37)</a>:</h4>
<p>Another example is a sort function, perhaps bitonic</p>



<a name="272907302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272907302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272907302">(Feb 23 2022 at 05:43)</a>:</h4>
<p>well...SimpleV has instructions for prefix sum (where the op can be fadd, fmul, add, mul, and, or, xor...really any 3-argument scalar openpower instruction).</p>



<a name="272907517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272907517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272907517">(Feb 23 2022 at 05:47)</a>:</h4>
<p><span class="user-mention" data-user-id="229517">@Jacob Lifshay</span> interesting, I'm not familiar with that, do you have a link?  Does it work similar to above?  I assume if the set of ops is closed they probably don't require the identity value to be specified</p>



<a name="272908007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908007">(Feb 23 2022 at 05:57)</a>:</h4>
<p>nah, the set of ops is every 3-argument scalar instruction in the OpenPower ISA -- not a closed set due to extensions.</p>



<a name="272908014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908014">(Feb 23 2022 at 05:57)</a>:</h4>
<p><a href="https://libre-soc.org/openpower/sv/">https://libre-soc.org/openpower/sv/</a></p>



<a name="272908087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908087">(Feb 23 2022 at 05:58)</a>:</h4>
<p>another great algorithm could be some kind of sliding window - something that would make things like convolutions easier to write</p>



<a name="272908212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908212">(Feb 23 2022 at 06:00)</a>:</h4>
<p>it doesn't mention prefix-sum specifically, but it can be constructed by <code>sv.add r4.v, r3.v, r4.v</code>, which essentially translates to the loop:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">VL</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272908420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908420">(Feb 23 2022 at 06:03)</a>:</h4>
<p>serious APL vibes</p>



<a name="272908502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908502">(Feb 23 2022 at 06:05)</a>:</h4>
<p>(In the best possible way, in case that wasn't clear :) )</p>



<a name="272908509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908509">(Feb 23 2022 at 06:05)</a>:</h4>
<p>:)</p>



<a name="272908688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908688">(Feb 23 2022 at 06:08)</a>:</h4>
<p>Yeah so I guess the identity value is implicit there, it's just whatevers in <code>regs[3]</code>.  I was trying to think of a way to not have to provide it for the example I gave above, but I think it's necessary.  It appears to totally optimize away in the cases I tested for e.g. a prefix_sum wrapper</p>



<a name="272908740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908740">(Feb 23 2022 at 06:09)</a>:</h4>
<p>err... how the heck do they make that fast?  That definition of the algorithm is entirely sequential, the reason the identity is necessary in my case is it's doing things non sequentially</p>



<a name="272908828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908828">(Feb 23 2022 at 06:10)</a>:</h4>
<p>hmm, i'd define prefix sum such that the first vector element is <code>regs[3]</code> and it just sums 0 times for the first element.</p>



<a name="272908874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908874">(Feb 23 2022 at 06:11)</a>:</h4>
<p>we can make prefix sum fast by recognizing the pattern and (when it doesn't change the result -- mostly only non-fp) converting to a tree-pattern</p>



<a name="272908950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908950">(Feb 23 2022 at 06:12)</a>:</h4>
<p>iirc we were thinking about adding a way to do the tree pattern for fp ops too but didn't get around to it yet.</p>



<a name="272908965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272908965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272908965">(Feb 23 2022 at 06:13)</a>:</h4>
<p>(i'm one of the designers of SimpleV btw)</p>



<a name="272909085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909085">(Feb 23 2022 at 06:15)</a>:</h4>
<p>Yes I just noticed your name looking through the pages you linked :) .  This is a bit outside my domain so apologies for the probably basic questions.  I'm familiar with tree reductions and some of the fancier things from the parallel literature that comes out of the GPU camp, but that's a pretty different processing model than the CPU SIMD models I'm familiar with.  Is SimpleV more similar to GPUs with the ability to do many more memory accesses in parallel?</p>



<a name="272909182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909182">(Feb 23 2022 at 06:17)</a>:</h4>
<p>or it may be more accurate to think of it as the vector processor having threads or some kind of parallelism within it?  That's much more powerful than x86 simd</p>



<a name="272909187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909187">(Feb 23 2022 at 06:17)</a>:</h4>
<p>Ah, SIMD processors are more capable of tree reductions than they look.</p>



<a name="272909291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909291">(Feb 23 2022 at 06:19)</a>:</h4>
<p>are you referring to gather instructions, or something else?</p>



<a name="272909309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909309">(Feb 23 2022 at 06:19)</a>:</h4>
<p>Libre-SOC's cpu is designed to be a hybrid CPU/GPU, so it will be able to do many memory ops in parallel...that said, for the prefix sum op I mentioned, that happens entirely in cpu registers (of which it has 128 64-bit int and 128 64-bit fp registers)</p>



<a name="272909372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909372">(Feb 23 2022 at 06:20)</a>:</h4>
<p>In-register.<br>
More generally,<br>
Arm SVE and RISCV-V use the model of predicated vectors that AVX512 hints at,<br>
and thus have a very different model than x86.</p>



<a name="272909418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909418">(Feb 23 2022 at 06:21)</a>:</h4>
<p>SimpleV (and Arm SVE and RISC-V V) are all vector processor instruction sets</p>



<a name="272909506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909506">(Feb 23 2022 at 06:23)</a>:</h4>
<p>SimpleV is more of the approach of "just take everything, but vectorize it", whereas most other ISAs have separately defined vector/simd instructions that are missing many ops</p>



<a name="272909584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909584">(Feb 23 2022 at 06:24)</a>:</h4>
<p>tbh,<br>
everything since the Cray is still using packed registers in fact, afaict,<br>
and that becomes more or less obvious between each.<br>
They just expose a different AL abstraction.</p>



<a name="272909707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909707">(Feb 23 2022 at 06:26)</a>:</h4>
<p>Is it fair to say that std::simd is an abstraction over packed registers?  I imagine packed registers are very much the lowest common denominator, since vector ISAs are a generalization?</p>



<a name="272909729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909729">(Feb 23 2022 at 06:27)</a>:</h4>
<p><em>handwobbles</em></p>



<a name="272909824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909824">(Feb 23 2022 at 06:28)</a>:</h4>
<p>hmm...i'm expecting std::simd to eventually provide a dynamically variable-length vector API, like what Arm SVE, RISC-V V, and SimpleV do...</p>



<a name="272909928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909928">(Feb 23 2022 at 06:30)</a>:</h4>
<p>If you have user-visible, fixed-length limits on the vector length (dynamically settable within that range or not), then the differences get to be pretty ambiguous.</p>



<a name="272909942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909942">(Feb 23 2022 at 06:30)</a>:</h4>
<p>i guess in summary we don't have an exact definition of what constitutes simd...I know it when i see it</p>



<a name="272909988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272909988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272909988">(Feb 23 2022 at 06:31)</a>:</h4>
<p>well, Arm SVE has user visible non-settable length that varies between cpu designs...</p>



<a name="272910033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910033">(Feb 23 2022 at 06:32)</a>:</h4>
<p>Right.</p>



<a name="272910047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910047">(Feb 23 2022 at 06:32)</a>:</h4>
<p>One of the major differences touted between packed SWAR and vector processors is "within-register" reductions (because that actually <strong>isn't</strong> a straightforward "SIMD" instruction per se), but x86 has had that since ever.</p>



<a name="272910050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910050">(Feb 23 2022 at 06:32)</a>:</h4>
<p>RISC-V V and SimpleV have user-settable lengths</p>



<a name="272910066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910066">(Feb 23 2022 at 06:33)</a>:</h4>
<p>everything else can emulate length changes using predication</p>



<a name="272910123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910123">(Feb 23 2022 at 06:34)</a>:</h4>
<p>And there's nothing stopping Intel from publishing an SVE-like SIMD extension set tomorrow that does nothing to their actual hardware architecture but simply offers a different interface. :^)</p>



<a name="272910154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910154">(Feb 23 2022 at 06:35)</a>:</h4>
<p>length changes: (or be like early x86 SSE/MMX and just <del>cry</del> use scalar instructions)</p>



<a name="272910174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910174">(Feb 23 2022 at 06:35)</a>:</h4>
<p>This is very interesting ^.  One thing I just realized is that the original snippet I pasted is actually doing a tree reduction, but near the root of the tree it's shifting in the identity value in order to make the wide operation a no-op.  It could probably be re-implemented with masks or blending to not require an identity value.</p>



<a name="272910272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910272">(Feb 23 2022 at 06:37)</a>:</h4>
<p>simd tree reductions: <a href="https://github.com/rust-lang/portable-simd/issues/235">https://github.com/rust-lang/portable-simd/issues/235</a></p>



<a name="272910351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910351">(Feb 23 2022 at 06:38)</a>:</h4>
<p>for SimpleV, I specifically wanted it to convert parts of a reduction tree to moves to handle elements that are predicated off</p>



<a name="272910453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910453">(Feb 23 2022 at 06:40)</a>:</h4>
<p>Yes perhaps the snippet isn't a reduction, but it is using a tree to implement the prefix scan in logn steps instead of n</p>



<a name="272910466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910466">(Feb 23 2022 at 06:40)</a>:</h4>
<p>n is the vector length here so it's not large, but it is still a net win</p>



<a name="272910670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910670">(Feb 23 2022 at 06:46)</a>:</h4>
<p>tree prefix sum: <a href="https://en.wikipedia.org/wiki/Prefix_sum#Parallel_algorithms">https://en.wikipedia.org/wiki/Prefix_sum#Parallel_algorithms</a></p>



<a name="272910819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910819">(Feb 23 2022 at 06:48)</a>:</h4>
<p>yes, I believe the snippet is equivalent to Algorithm 1 in that link</p>



<a name="272910851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910851">(Feb 23 2022 at 06:49)</a>:</h4>
<p>So Simple-V is going to translate a vector add instruction into that kind of tree prefix sum?  That seems magical</p>



<a name="272910914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272910914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272910914">(Feb 23 2022 at 06:50)</a>:</h4>
<p>:)</p>



<a name="272911024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272911024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272911024">(Feb 23 2022 at 06:52)</a>:</h4>
<p>Here's a better version of the snippet that uses masking instead of requiring an identity:</p>
<div class="codehilite"><pre><span></span><code>fn scan&lt;T, const LANES: usize, Op&gt;(mut values: Simd&lt;T, LANES&gt;, mut op: Op) -&gt; Simd&lt;T, LANES&gt;
where
    T: SimdElement + Default + std::fmt::Debug,
    LaneCount&lt;LANES&gt;: SupportedLaneCount,
    Op: FnMut(Simd&lt;T, LANES&gt;, Simd&lt;T, LANES&gt;) -&gt; Simd&lt;T, LANES&gt;,
{
    let mut mask = [true; LANES];
    unroll! {
        for IDX in [1, 2, 4, 8, 16, 32] {
            if IDX &lt; LANES {
                mask[..IDX].fill(false);
                values = Mask::from(mask).select(
                    op(
                        values,
                        values.rotate_lanes_right::&lt;IDX&gt;(),
                    ),
                    values,
                )
            }
        }
    }

    values
}
</code></pre></div>



<a name="272911028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272911028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272911028">(Feb 23 2022 at 06:52)</a>:</h4>
<p>currently, SimpleV guarantees results equivalent to the serial prefix sum. we may add a prefix-sum guaranteed to match a specific tree's results. for both of those, a cpu can implement it however it sees fit, as long as the answer matches exactly.</p>



<a name="272911475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272911475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272911475">(Feb 23 2022 at 07:00)</a>:</h4>
<p>according to MCA that snippet is actually more efficient on icelake when LANES=32 compared to the native vector size of 16. Perhaps a good example of what y'all were talking about above</p>



<a name="272911495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272911495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272911495">(Feb 23 2022 at 07:01)</a>:</h4>
<p>or perhaps just a good example of the power of logarithms</p>



<a name="272911510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272911510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272911510">(Feb 23 2022 at 07:01)</a>:</h4>
<p>probably because of pipelining in the fadd units</p>



<a name="272911511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272911511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272911511">(Feb 23 2022 at 07:01)</a>:</h4>
<p>err well it's not really logarithmic above 16 lines</p>



<a name="272911513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272911513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272911513">(Feb 23 2022 at 07:02)</a>:</h4>
<p>yeah</p>



<a name="272911976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272911976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272911976">(Feb 23 2022 at 07:10)</a>:</h4>
<p>Toward the original question - are algorithms like this in scope of std::simd?  Would such a patch be accepted?</p>



<a name="272912137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272912137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272912137">(Feb 23 2022 at 07:13)</a>:</h4>
<p>imho prefix sum should be in std::simd because some cpus provide instructions for it. as for generic scan, i'm a little more iffy on that because, in my mind, std::simd is supposed to be a thin abstraction over a generic vector/simd instruction set</p>



<a name="272912234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272912234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272912234">(Feb 23 2022 at 07:15)</a>:</h4>
<p>i'll probably leave generic scan up to everyone else to decide</p>



<a name="272912472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Algorithms%20on%20SIMD%20registers/near/272912472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Burkert <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Algorithms.20on.20SIMD.20registers.html#272912472">(Feb 23 2022 at 07:19)</a>:</h4>
<p>Makes sense.  FWIW I'd probably reject such a patch at this point if I were in the maintainers shoes, but thought I'd offer it up in case there is appetite for this sort of thing.  There can always be an itertools-alike to house such things</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>