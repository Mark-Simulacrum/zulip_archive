<html>
<head><meta charset="utf-8"><title>how to select using masks · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html">how to select using masks</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270888470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270888470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270888470">(Feb 06 2022 at 12:52)</a>:</h4>
<p>Hi, given a slice <code>[i32; 8] = [0, 1, 2, 3, 4, 5, 6, 7]</code>, a mask <code>m8</code> <code>00000101u8</code> and a region <code>&amp;mut [i32]</code> with the correct number of entries (2 in this case), is there an API to write "[0, 2]" to it without iterating bit by bit? I.e. selecting the item at index <code>0</code> and <code>2</code> (because the bitmap is set for those).</p>



<a name="270893254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270893254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270893254">(Feb 06 2022 at 14:39)</a>:</h4>
<p>Is the mask constant, or that's just an example but unknown at runtime</p>



<a name="270893682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270893682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270893682">(Feb 06 2022 at 14:50)</a>:</h4>
<p>it is just an example. The general case is <code>values: &amp;[i32]</code> and <code>mask: &amp;[u8]</code> where <code>values.len() == mask.len() / 8</code> and we iterate over chunks of "lanes".</p>



<a name="270893686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270893686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270893686">(Feb 06 2022 at 14:50)</a>:</h4>
<p>I think the instruction is this one: <a href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#text=_pext_u64&amp;ig_expand=5394">https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#text=_pext_u64&amp;ig_expand=5394</a></p>



<a name="270893766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270893766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270893766">(Feb 06 2022 at 14:52)</a>:</h4>
<p>If you're specifically trying to load the bits that way you'd need to use <code>from_bitmask</code> (not on nightly for arrays, yet) and then pass that mask to <code>scatter</code> to choose which lanes you want to write out.</p>



<a name="270893795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270893795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270893795">(Feb 06 2022 at 14:53)</a>:</h4>
<p>Neither of those functions are necessarily fast on most architectures, though, so I'm not sure this is something that can or should be vectorized</p>



<a name="270893938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270893938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270893938">(Feb 06 2022 at 14:57)</a>:</h4>
<p>As far as I can tell, that particular instruction you linked transfers bits between values and doesn't help with selecting a wider type such as i32 in this case. Also I definitely don't think there's a portable way to implement that instruction except maybe with a string of bitwise operations</p>



<a name="270896466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270896466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270896466">(Feb 06 2022 at 15:55)</a>:</h4>
<p>iirc, llvm has a special intrinsic for what you wanted: <a href="https://llvm.org/docs/LangRef.html#llvm-masked-compressstore-intrinsics">https://llvm.org/docs/LangRef.html#llvm-masked-compressstore-intrinsics</a></p>



<a name="270896504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270896504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270896504">(Feb 06 2022 at 15:56)</a>:</h4>
<p>we don't expose it yet though</p>



<a name="270896522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270896522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270896522">(Feb 06 2022 at 15:56)</a>:</h4>
<p>there's also the reverse operation: <a href="https://llvm.org/docs/LangRef.html#llvm-masked-expandload-intrinsics">https://llvm.org/docs/LangRef.html#llvm-masked-expandload-intrinsics</a></p>



<a name="270897359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270897359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270897359">(Feb 06 2022 at 16:13)</a>:</h4>
<p>x86 supports it with avx512f: <a href="https://llvm.godbolt.org/z/zanqn8xd4">https://llvm.godbolt.org/z/zanqn8xd4</a></p>



<a name="270898271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270898271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270898271">(Feb 06 2022 at 16:34)</a>:</h4>
<p>Libre-SOC's SimpleV and RISC-V V also supports compress store and expand load, but by compressing/expanding in a register then loading/storing the compacted register</p>



<a name="270898353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270898353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270898353">(Feb 06 2022 at 16:36)</a>:</h4>
<p>icr for sure, but i think SimpleV may also support compress store and expanding load without going through a register</p>



<a name="270898421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270898421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270898421">(Feb 06 2022 at 16:38)</a>:</h4>
<p>ARM SVE also has compressing in a register</p>



<a name="270898432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270898432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270898432">(Feb 06 2022 at 16:38)</a>:</h4>
<p>tho afaict x86 is the only one wired up in llvm currently</p>



<a name="270899545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/how%20to%20select%20using%20masks/near/270899545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/how.20to.20select.20using.20masks.html#270899545">(Feb 06 2022 at 17:02)</a>:</h4>
<p>correct, I linked a wrong instruction for this. Yes, that is the one, <span class="user-mention" data-user-id="229517">@Jacob Lifshay</span>! Is it something that could make sense for portable-simd to support?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>