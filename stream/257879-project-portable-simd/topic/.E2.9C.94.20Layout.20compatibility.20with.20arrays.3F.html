<html>
<head><meta charset="utf-8"><title>✔ Layout compatibility with arrays? · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html">✔ Layout compatibility with arrays?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263518967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263518967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263518967">(Dec 03 2021 at 00:16)</a>:</h4>
<p>(I didn't see anything in the rustdocs about this)</p>
<p>Is it sound to convert a <code>&amp;mut Simd&lt;T, N&gt;</code> to <code>&amp;[T; N]</code>?  AKA is it guaranteed to have the same length and order of elements?</p>
<p>If it not <em>always</em> sound, is it sometimes sound?  Like is it sound so long as <code>sizeof(Simd&lt;T, N&gt;) == N * sizeof(T)</code>?</p>



<a name="263519105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263519105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263519105">(Dec 03 2021 at 00:17)</a>:</h4>
<p>i'd expect it to be sound, with the current implementation (icr if we used <code>#[repr(transparent)]</code> in the appropriate places).</p>



<a name="263519177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263519177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263519177">(Dec 03 2021 at 00:18)</a>:</h4>
<p>it isn't sound for <code>Mask</code> tho</p>



<a name="263519237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263519237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263519237">(Dec 03 2021 at 00:19)</a>:</h4>
<p>If the size matches then yes, which it will for non-mask simd types.</p>
<p>Note that the <em>other</em> direction isn't always allowed because a reference to an array might be under-aligned for the SIMD version of the reference</p>



<a name="263519260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263519260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263519260">(Dec 03 2021 at 00:20)</a>:</h4>
<p>I think in this situation you can use <code>as_array</code>?  But yes, that's a valid conversion.  The other way around not.</p>



<a name="263519565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263519565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263519565">(Dec 03 2021 at 00:23)</a>:</h4>
<p>Yeah, I was confident the other way was not ok.</p>
<p>I guess I was most unsure about <code>Simd&lt;T, 7&gt;</code>, but I suppose right now that doesn't even work, so meh.  Definitely makes sense that power-of-two sizes ought to be compatible like that.</p>



<a name="263519570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263519570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263519570">(Dec 03 2021 at 00:23)</a>:</h4>
<p>Thanks!</p>



<a name="263519573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263519573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263519573">(Dec 03 2021 at 00:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> has marked this topic as resolved.</p>



<a name="263519686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263519686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263519686">(Dec 03 2021 at 00:25)</a>:</h4>
<p>jackw please save us from these worries ;_;</p>



<a name="263519693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263519693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263519693">(Dec 03 2021 at 00:25)</a>:</h4>
<p><code>Simd&lt;T, 7&gt;</code> will work in the future...it's internally a 7-element llvm vector, which llvm guarantees is laid out exactly like a 7-element array -- in memory.</p>



<a name="263519717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263519717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263519717">(Dec 03 2021 at 00:25)</a>:</h4>
<p>Oh, I should have noticed the <code>Simd&lt;T, L&gt;: AsMut&lt;[T; L]&gt;</code>.  That's strong confirmation (edit: well, of the ordering at least).</p>



<a name="263520013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263520013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263520013">(Dec 03 2021 at 00:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> has marked this topic as resolved.</p>



<a name="263520498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263520498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263520498">(Dec 03 2021 at 00:36)</a>:</h4>
<p><a href="https://releases.llvm.org/13.0.0/docs/BigEndianNEON.html">https://releases.llvm.org/13.0.0/docs/BigEndianNEON.html</a> They go to <strong>considerable</strong> trouble to make sure this is valid even on Big Endian processors, though I am unsure/more concerned about how they handle it on PowerPC.</p>



<a name="263520590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263520590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263520590">(Dec 03 2021 at 00:37)</a>:</h4>
<p>powerpc's simd instructions automatically do endian swapping internally, so they match memory order</p>



<a name="263520663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263520663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263520663">(Dec 03 2021 at 00:38)</a>:</h4>
<p>libre-soc had a big argument over wether we needed the extra hw that does that...</p>



<a name="263520777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263520777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263520777">(Dec 03 2021 at 00:40)</a>:</h4>
<p>Ahhh okay, so what I was reading is that they follow big endian for the elements if the processor is in BE mode, so if you load [f32; 4] into a vector, it's laid out<br>
[0000, 1111, 2222, 3333] in memory<br>
but then the vector load warps it into <br>
[3333, 2222, 1111, 0000], right?<br>
like,<br>
the actual order is unimportant, just that you can't actually "see" the difference.</p>



<a name="263520883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263520883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263520883">(Dec 03 2021 at 00:41)</a>:</h4>
<p>not the vector load...that just copies bits. the actual arithmetic ops do endian swapping</p>



<a name="263520929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263520929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263520929">(Dec 03 2021 at 00:41)</a>:</h4>
<p>hm</p>



<a name="263521001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/%E2%9C%94%20Layout%20compatibility%20with%20arrays%3F/near/263521001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/.E2.9C.94.20Layout.20compatibility.20with.20arrays.3F.html#263521001">(Dec 03 2021 at 00:42)</a>:</h4>
<p>though there are different schemes for where the swapping is actually done internally...it has to look like the arithmetic ops do endian swapping from the programmers perspective</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>