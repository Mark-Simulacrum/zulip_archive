<html>
<head><meta charset="utf-8"><title>Casts i32-&gt;f64 · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html">Casts i32-&gt;f64</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269394678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269394678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Denis Golovan <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269394678">(Jan 26 2022 at 11:22)</a>:</h4>
<p>Hi all.<br>
I am trying to cast Simd&lt;i32, 4&gt; into Simd&lt;f64, 4&gt; using core_simd crate.<br>
Currently I can't see a clear path to do that.<br>
Could somebody help?</p>
<p>I am under latest nighly with PR <a href="https://github.com/rust-lang/rust/issues/92425">#92425</a> merged.</p>



<a name="269441792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269441792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269441792">(Jan 26 2022 at 16:41)</a>:</h4>
<p>A method that actually calls the internal implementation needs to be written/PR'd/etc</p>



<a name="269465442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269465442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Denis Golovan <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269465442">(Jan 26 2022 at 19:12)</a>:</h4>
<p>So it's not implemented yet?</p>



<a name="269465749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269465749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269465749">(Jan 26 2022 at 19:14)</a>:</h4>
<p>Can probably do <code>Simd::from_array(foo.to_array().map(|x| x as f64))</code> for now.</p>



<a name="269470457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269470457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Denis Golovan <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269470457">(Jan 26 2022 at 19:46)</a>:</h4>
<p>thanks. Works fine :)</p>



<a name="269488501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269488501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269488501">(Jan 26 2022 at 21:56)</a>:</h4>
<p>Hmm, interestingly it looks like it does emit a <code>sitofp &lt;4 x i32&gt; %6 to &lt;4 x double&gt;</code> in -O3, but the array stuff compiles weirdly: &lt;<a href="https://rust.godbolt.org/z/q6nYohs4e">https://rust.godbolt.org/z/q6nYohs4e</a>&gt;</p>



<a name="269502132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269502132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269502132">(Jan 27 2022 at 00:03)</a>:</h4>
<p>Apparently it compiles to the same machine code during machine lowering for Zen:<br>
<a href="https://rust.godbolt.org/z/crWYKe5z1">https://rust.godbolt.org/z/crWYKe5z1</a><br>
( It does have a better lowering for earlier x64 targets. )</p>



<a name="269511671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269511671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269511671">(Jan 27 2022 at 00:59)</a>:</h4>
<p>Drafted <code>Simd::cast</code>.</p>



<a name="269511890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269511890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269511890">(Jan 27 2022 at 01:01)</a>:</h4>
<p>Going to force myself to learn how this Titan key works I guess.</p>



<a name="269518302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269518302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269518302">(Jan 27 2022 at 02:33)</a>:</h4>
<p>Well, that was incredibly tedious.</p>



<a name="269527578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269527578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269527578">(Jan 27 2022 at 05:25)</a>:</h4>
<p>And tests and documentation and aaa.</p>



<a name="269610872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269610872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Goertzen <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269610872">(Jan 27 2022 at 17:52)</a>:</h4>
<p>I had the same need but for a different type so I wrote a generic converter that also autovectorizes (for i32-&gt;f64 at least). <a href="https://rust.godbolt.org/z/vn937Ysx6">https://rust.godbolt.org/z/vn937Ysx6</a></p>



<a name="269629520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269629520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269629520">(Jan 27 2022 at 20:01)</a>:</h4>
<p>Okay, slid it under the sync PR and hopefully that is OK by simulacrum.</p>



<a name="269631445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Casts%20i32-%3Ef64/near/269631445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64.html#269631445">(Jan 27 2022 at 20:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="474881">Daniel Goertzen</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Casts.20i32-.3Ef64/near/269610872">said</a>:</p>
<blockquote>
<p>I had the same need but for a different type so I wrote a generic converter that also autovectorizes (for i32-&gt;f64 at least). <a href="https://rust.godbolt.org/z/vn937Ysx6">https://rust.godbolt.org/z/vn937Ysx6</a></p>
</blockquote>
<p>Yeah, the main advantage is that the direct conversion for the vector, in this case, is a much tighter and more direct lowering, so it both doesn't have to spend a ton of time optimizing, and it doesn't ever miss the optimization, e.g. in the default SSE2 target:</p>
<div class="codehilite" data-code-language="NASM"><pre><span></span><code><span class="nl">example:demo:</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="nb">rdi</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="nb">rcx</span><span class="p">,</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rsi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nf">cvtdq2pd</span><span class="w">        </span><span class="nv">xmm0</span><span class="p">,</span><span class="w"> </span><span class="kt">qword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rsi</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nf">movq</span><span class="w">    </span><span class="nv">xmm1</span><span class="p">,</span><span class="w"> </span><span class="nb">rcx</span><span class="w"></span>
<span class="w">        </span><span class="nf">shr</span><span class="w">     </span><span class="nb">rcx</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="w"></span>
<span class="w">        </span><span class="nf">movq</span><span class="w">    </span><span class="nv">xmm2</span><span class="p">,</span><span class="w"> </span><span class="nb">rcx</span><span class="w"></span>
<span class="w">        </span><span class="nf">punpckldq</span><span class="w">       </span><span class="nv">xmm1</span><span class="p">,</span><span class="w"> </span><span class="nv">xmm2</span><span class="w"></span>
<span class="w">        </span><span class="nf">cvtdq2pd</span><span class="w">        </span><span class="nv">xmm1</span><span class="p">,</span><span class="w"> </span><span class="nv">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">movaps</span><span class="w">  </span><span class="nv">xmmword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rdi</span><span class="p">],</span><span class="w"> </span><span class="nv">xmm0</span><span class="w"></span>
<span class="w">        </span><span class="nf">movaps</span><span class="w">  </span><span class="nv">xmmword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rdi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="nv">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>

<span class="nl">example:intrin_demo:</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="nb">rdi</span><span class="w"></span>
<span class="w">        </span><span class="nf">movdqa</span><span class="w">  </span><span class="nv">xmm0</span><span class="p">,</span><span class="w"> </span><span class="nv">xmmword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rsi</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nf">pshufd</span><span class="w">  </span><span class="nv">xmm1</span><span class="p">,</span><span class="w"> </span><span class="nv">xmm0</span><span class="p">,</span><span class="w"> </span><span class="mi">238</span><span class="w"></span>
<span class="w">        </span><span class="nf">cvtdq2pd</span><span class="w">        </span><span class="nv">xmm1</span><span class="p">,</span><span class="w"> </span><span class="nv">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">cvtdq2pd</span><span class="w">        </span><span class="nv">xmm0</span><span class="p">,</span><span class="w"> </span><span class="nv">xmm0</span><span class="w"></span>
<span class="w">        </span><span class="nf">movaps</span><span class="w">  </span><span class="nv">xmmword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rdi</span><span class="p">],</span><span class="w"> </span><span class="nv">xmm0</span><span class="w"></span>
<span class="w">        </span><span class="nf">movaps</span><span class="w">  </span><span class="nv">xmmword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rdi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="nv">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>

<span class="nl">example:my_demo:</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="nb">rdi</span><span class="w"></span>
<span class="w">        </span><span class="nf">movaps</span><span class="w">  </span><span class="nv">xmm0</span><span class="p">,</span><span class="w"> </span><span class="nv">xmmword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rsi</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nf">movss</span><span class="w">   </span><span class="nv">xmm1</span><span class="p">,</span><span class="w"> </span><span class="kt">dword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rsi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nf">movss</span><span class="w">   </span><span class="nv">xmm2</span><span class="p">,</span><span class="w"> </span><span class="kt">dword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rsi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">12</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nf">shufps</span><span class="w">  </span><span class="nv">xmm2</span><span class="p">,</span><span class="w"> </span><span class="nv">xmm0</span><span class="p">,</span><span class="w"> </span><span class="mi">228</span><span class="w"></span>
<span class="w">        </span><span class="nf">shufps</span><span class="w">  </span><span class="nv">xmm2</span><span class="p">,</span><span class="w"> </span><span class="nv">xmm0</span><span class="p">,</span><span class="w"> </span><span class="mi">226</span><span class="w"></span>
<span class="w">        </span><span class="nf">unpcklps</span><span class="w">        </span><span class="nv">xmm0</span><span class="p">,</span><span class="w"> </span><span class="nv">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">cvtdq2pd</span><span class="w">        </span><span class="nv">xmm0</span><span class="p">,</span><span class="w"> </span><span class="nv">xmm0</span><span class="w"></span>
<span class="w">        </span><span class="nf">cvtdq2pd</span><span class="w">        </span><span class="nv">xmm1</span><span class="p">,</span><span class="w"> </span><span class="nv">xmm2</span><span class="w"></span>
<span class="w">        </span><span class="nf">movaps</span><span class="w">  </span><span class="nv">xmmword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rdi</span><span class="p">],</span><span class="w"> </span><span class="nv">xmm0</span><span class="w"></span>
<span class="w">        </span><span class="nf">movaps</span><span class="w">  </span><span class="nv">xmmword</span><span class="w"> </span><span class="nv">ptr</span><span class="w"> </span><span class="p">[</span><span class="nb">rdi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="nv">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>