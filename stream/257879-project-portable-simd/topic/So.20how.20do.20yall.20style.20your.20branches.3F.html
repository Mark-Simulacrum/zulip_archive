<html>
<head><meta charset="utf-8"><title>So how do yall style your branches? · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html">So how do yall style your branches?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265174966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265174966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265174966">(Dec 16 2021 at 15:47)</a>:</h4>
<p>Almost immediately yesterday I ended up being reminded of how verbose a simd branch/merge is. My "pattern" ended up being</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">yes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="n">mask</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">yes</span><span class="p">,</span><span class="w"> </span><span class="n">no</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Just now I threw together a little macro that seems to maybe pack it back down better:</p>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=ce1715a9ad94764ad7cd5f1584898a4f">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=ce1715a9ad94764ad7cd5f1584898a4f</a></p>
<p>Are there other tricks that work out well people have been using?</p>



<a name="265177269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265177269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265177269">(Dec 16 2021 at 16:02)</a>:</h4>
<p>That macro is an interesting idea, it's actually more verbose but it's a little easier to remember the order etc</p>



<a name="265180116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265180116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265180116">(Dec 16 2021 at 16:22)</a>:</h4>
<p>Yes, it makes  the data flow "normal" compared to how the eyes read <code>if</code> already.</p>



<a name="265180492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265180492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265180492">(Dec 16 2021 at 16:26)</a>:</h4>
<p>Much more limited since there's no pattern matching, but you could do one for <code>match</code> too</p>



<a name="265180539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265180539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265180539">(Dec 16 2021 at 16:26)</a>:</h4>
<p>oh wow an actual match would be so many branches</p>



<a name="265180558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265180558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265180558">(Dec 16 2021 at 16:26)</a>:</h4>
<p>Yeah lol</p>



<a name="265180623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265180623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265180623">(Dec 16 2021 at 16:27)</a>:</h4>
<p>You'd have to branch for each arm</p>



<a name="265183423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265183423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265183423">(Dec 16 2021 at 16:45)</a>:</h4>
<p>i think one for <em>specifically</em> branching on the fp_classification might be useful, but even then you can often write code that doesn't look at the class</p>



<a name="265231895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265231895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265231895">(Dec 16 2021 at 22:58)</a>:</h4>
<p>I have been considering a type that represents "a vector plus the mask that was just generated from it" which could be created or composed with ops that yield masks to get an API like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">vector</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">lane_lt</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="n">or</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>which would, for lanes less than 0, add 5, and give the value 1 for the lanes equal to or greater than 0.</p>



<a name="265232655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265232655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265232655">(Dec 16 2021 at 23:05)</a>:</h4>
<p>It might instead do a trick like <code>.and_then</code> tho', I haven't worked through all the implications.</p>



<a name="265233994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265233994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265233994">(Dec 16 2021 at 23:20)</a>:</h4>
<p>Such a e.g. <code>Masked&lt;f32, N&gt;</code> type would essentially allow treating Mask as mostly a low-level primitive, and I believe that, while it may introduce a little overhead on spills to memory, it would otherwise have the desirable effect of allowing optimizers to more easily see the control flow that inevitably leads to using the vector and its mask as operands to the final computation. This would allow BEs which can handle SVE and AVX512 to basically always "get it right".</p>



<a name="265234382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265234382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265234382">(Dec 16 2021 at 23:24)</a>:</h4>
<p>I doubt it would help the optimizer since the DAG is how the relationship is detected, but it might be useful for making a sort of SIMD Option</p>



<a name="265234462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265234462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265234462">(Dec 16 2021 at 23:25)</a>:</h4>
<p>I don't think masks are always used in that way vs a one-off select, but I'm sure there are situations where it makes sense</p>



<a name="265235004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265235004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265235004">(Dec 16 2021 at 23:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F/near/265234462">said</a>:</p>
<blockquote>
<p>I don't think masks are always used in that way vs a one-off select, but I'm sure there are situations where it makes sense</p>
</blockquote>
<p>My idea is that <code>v1.filter(clos).or(v2)</code> would work.</p>



<a name="265235115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/So%20how%20do%20yall%20style%20your%20branches%3F/near/265235115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F.html#265235115">(Dec 16 2021 at 23:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/So.20how.20do.20yall.20style.20your.20branches.3F/near/265234382">said</a>:</p>
<blockquote>
<p>I doubt it would help the optimizer since the DAG is how the relationship is detected, but it might be useful for making a sort of SIMD Option</p>
</blockquote>
<p>Yeah it would only just nudge people to chain things really tightly.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>