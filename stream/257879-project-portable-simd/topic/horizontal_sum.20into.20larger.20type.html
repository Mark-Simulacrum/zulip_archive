<html>
<head><meta charset="utf-8"><title>horizontal_sum into larger type · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html">horizontal_sum into larger type</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264424528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264424528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Koralewski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264424528">(Dec 10 2021 at 09:58)</a>:</h4>
<p>Hi, I've got a question. I have a Simd&lt;i8, 32&gt;  and want to <code>horizontal_sum</code> it into an i32. Seems like <code>horizontal_sum</code> only allows to add into the same type, i.e. an <code>i8</code> right now. Is this possible somehow/planned?</p>



<a name="264425934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264425934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264425934">(Dec 10 2021 at 10:11)</a>:</h4>
<p>All the horizontal instructions in LLVM are same-type, it looks like: <a href="https://llvm.org/docs/LangRef.html#vector-reduction-intrinsics">https://llvm.org/docs/LangRef.html#vector-reduction-intrinsics</a></p>
<p>All the intel <code>reduce_add</code> and <code>hadd</code> instructions are also homogeneous, from what I can find: <a href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#text=reduce">https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#text=reduce</a></p>
<p>So I would be somewhat surprised for mixed-type addition to be offered directly.</p>



<a name="264426246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264426246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264426246">(Dec 10 2021 at 10:14)</a>:</h4>
<p>That said, with only 32 items, you only need i16 to avoid overflow.  So you can probably find a way to expand the <code>Simd&lt;i8, 32&gt;</code> to a <code>Simd&lt;i16, 32&gt;</code>, then horizontally-sum that (then extend it to <code>i32</code> if you really need <code>i32</code>).</p>



<a name="264426454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264426454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Koralewski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264426454">(Dec 10 2021 at 10:16)</a>:</h4>
<p>I see, thanks!</p>



<a name="264426707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264426707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264426707">(Dec 10 2021 at 10:19)</a>:</h4>
<p>(Also, I'm a simd noob, so it's totally possible that someone will show up and point out something I missed.)</p>



<a name="264428101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264428101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264428101">(Dec 10 2021 at 10:33)</a>:</h4>
<p>Hmm, I spelunked through the intrinsics guide some more, and I think my guess is plausible.</p>
<p>It looks like <code>vpmovsxbw</code> does the <code>i8x16</code> -&gt; <code>i16x16</code> and <code>i8x32</code> -&gt; <code>i16x32</code> kinds of conversions (<a href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#text=cvtepi8_epi16&amp;ig_expand=1823">https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html#text=cvtepi8_epi16&amp;ig_expand=1823</a>)</p>
<p>That said, the <code>reduce_add</code> things in the intrinsics guide aren't actually instructions -- they're listed as "Sequence".  So the "best" way might not even involve using <code>horizontal_sum</code> at all, in the end.  (Or if it does, it might only be because that makes it obvious what you're trying to do to the LLVM optimizer, so it can emit it in a way that looks nothing like a horizontal sum.)</p>



<a name="264471257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264471257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264471257">(Dec 10 2021 at 16:25)</a>:</h4>
<p>if you want this you might want something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">simd_val</span><span class="p">.</span><span class="n">to_array</span><span class="p">().</span><span class="n">iter</span><span class="p">().</span><span class="n">copied</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="n">i</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">).</span><span class="n">sum</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
<p>which is not at all simd.</p>
<p>I don't know if the portable-simd api does the width changing conversions at the moment. If so they're maybe a good bet, they can at least speed up some of the process, if not all.</p>
<p>if not, there's always core::arch i guess</p>



<a name="264472397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264472397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264472397">(Dec 10 2021 at 16:34)</a>:</h4>
<p>I don't believe we have those conversions yet, we've been discussing them though.  Integer conversions are easy, the floats have held us back a bit</p>



<a name="264506242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264506242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264506242">(Dec 10 2021 at 20:51)</a>:</h4>
<p>Actually it's the other way around.<br>
Float conversions are easy,<br>
integers are hard,<br>
because our current intrinsics don't support isize/usize conversions.</p>



<a name="264507049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264507049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264507049">(Dec 10 2021 at 20:57)</a>:</h4>
<p>I was thinking more how we don't have any safe int-to-float intrinsic, either</p>



<a name="264507132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264507132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264507132">(Dec 10 2021 at 20:58)</a>:</h4>
<p>Maybe conversions are the next thing we should focus on...</p>



<a name="264513646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264513646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264513646">(Dec 10 2021 at 21:52)</a>:</h4>
<p>Why would isize / usize matter for the widening and narrowing ops on the fixed sized types?</p>



<a name="264516770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264516770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264516770">(Dec 10 2021 at 22:17)</a>:</h4>
<p>shrug, they all pipe through the same intrinsic at the moment.<br>
and atm the intrinsic just breaks on those.</p>



<a name="264520403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264520403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264520403">(Dec 10 2021 at 22:57)</a>:</h4>
<p>ah, so it might work for only fixed sized integers?</p>



<a name="264520621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/horizontal_sum%20into%20larger%20type/near/264520621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/horizontal_sum.20into.20larger.20type.html#264520621">(Dec 10 2021 at 22:59)</a>:</h4>
<p>yes.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>