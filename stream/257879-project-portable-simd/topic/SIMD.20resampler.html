<html>
<head><meta charset="utf-8"><title>SIMD resampler · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html">SIMD resampler</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266881026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/266881026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredemus <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#266881026">(Jan 04 2022 at 23:58)</a>:</h4>
<p>Hello, I'm trying to make my polynomial resampling code SIMD and I'm a bit stuck about how to handle this part, which involves using multiple indices based on values in a simd vector. Is this possible or am I going about it all wrong?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">pitches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32x4</span>::<span class="n">from_array</span><span class="p">([</span><span class="mf">1.01</span><span class="p">,</span><span class="mf">0.99</span><span class="p">,</span><span class="mf">1.02</span><span class="p">,</span><span class="mf">0.98</span><span class="p">]);</span><span class="w"></span>
<span class="c1">// phases is also f32x4</span>
<span class="kd">let</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phases</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">phases</span><span class="p">.</span><span class="n">floor</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w"></span>
<span class="c1">// the idx will likely be different for each value</span>
<span class="c1">// should be used to index the c_n coefficients</span>
<span class="c1">// can this be made usizex4 and used to index or something?</span>
<span class="kd">let</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phases</span><span class="p">.</span><span class="n">floor</span><span class="p">();</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">ratios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32x4</span>::<span class="n">splat</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">pitches</span><span class="p">;</span><span class="w"></span>
<span class="c1">// update the phases</span>
<span class="n">phases</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">phases</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ratios</span><span class="p">;</span><span class="w"></span>
<span class="c1">// return outputs of the polynomia summed</span>
<span class="k">return</span><span class="w"> </span><span class="p">(((</span><span class="n">c3</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c2</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c1</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c0</span><span class="p">[</span><span class="n">idx</span><span class="p">]).</span><span class="n">horizontal_sum</span><span class="p">();</span><span class="w"></span>
</code></pre></div>



<a name="267370337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267370337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267370337">(Jan 09 2022 at 18:18)</a>:</h4>
<p>Hi, I don't quite understand the problem, but usually I try to avoid indexing into SIMD vectors as much as possible because it's typically not very efficient</p>



<a name="267370352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267370352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267370352">(Jan 09 2022 at 18:19)</a>:</h4>
<p>You may be looking for something like <code>Mask::select</code> which can allow you to conditionally change the values in lanes</p>



<a name="267641302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267641302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredemus <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267641302">(Jan 11 2022 at 20:36)</a>:</h4>
<p>I'm not trying to index into a simd vector, I was wondering if it's possible to use a simd vector to index into an array. <br>
Something like </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">array</span>: <span class="p">[</span><span class="kt">f32</span><span class="p">;</span><span class="w"> </span><span class="mi">2048</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">1.</span><span class="p">;</span><span class="w"> </span><span class="mi">2048</span><span class="p">];</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usizex4</span>::<span class="n">from_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">chosen</span>: <span class="nc">f32x4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="n">indices</span><span class="p">];</span><span class="w"></span>
</code></pre></div>



<a name="267652816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267652816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267652816">(Jan 11 2022 at 22:07)</a>:</h4>
<p>Well, <code>Index</code> needs to return a reference, and there isn't an <code>f32x4</code> in memory anywhere to refer to, in general, so it's impossible with <code>[]</code> right now.</p>



<a name="267653259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267653259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267653259">(Jan 11 2022 at 22:11)</a>:</h4>
<p>Ah yes, that's a gather operation</p>



<a name="267653383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267653383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267653383">(Jan 11 2022 at 22:11)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nightly/std/simd/struct.Simd.html#method.gather_or">https://doc.rust-lang.org/nightly/std/simd/struct.Simd.html#method.gather_or</a></p>



<a name="267663332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267663332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267663332">(Jan 11 2022 at 23:43)</a>:</h4>
<p>if you can, it's best to avoid gather on x86/arm cuz it's often very slow (not really faster than a bunch of scalar loads).</p>



<a name="267673199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267673199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredemus <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267673199">(Jan 12 2022 at 01:49)</a>:</h4>
<p>Thanks! I can guarantee that the 4 indices will be next to each other, so from my research it should be possible to do <code>from_slice</code>, but I think this has to be unaligned, is that better performance wise?</p>



<a name="267673533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267673533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267673533">(Jan 12 2022 at 01:55)</a>:</h4>
<p>If the scalars are aligned, that's fine</p>



<a name="267673540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267673540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267673540">(Jan 12 2022 at 01:55)</a>:</h4>
<p>The slice doesn't need to be vector-aligned</p>



<a name="267676598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267676598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267676598">(Jan 12 2022 at 02:57)</a>:</h4>
<p>vector load, even if unaligned, is waay faster than gather on x86</p>



<a name="267676672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/SIMD%20resampler/near/267676672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/SIMD.20resampler.html#267676672">(Jan 12 2022 at 02:58)</a>:</h4>
<p>iirc aligned vector load might not be any faster than unaligned load if the actual address your loading from happens to be aligned</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>