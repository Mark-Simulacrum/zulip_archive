<html>
<head><meta charset="utf-8"><title>MaybeUninit vectors and UB · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html">MaybeUninit vectors and UB</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273757952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273757952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273757952">(Mar 02 2022 at 05:27)</a>:</h4>
<p>At the moment, we don't actually have anything that allows for partially initialized vectors without them being immediately UB. Nonetheless, it's not implausible for us to consider them, and <code>Simd&lt;MaybeUninit&lt;u8&gt;, N&gt;</code> actually raises a lot <strong>less</strong> questions than other extensions. It also is important to define what is UB so that e.g. Miri can actually detect it if we do mess it up, and also what could be safely done on e.g. a <code>MaybeUninit&lt;Simd&lt;u8, N&gt;&gt;</code> which one can definitely already write today, and "when can I read <code>[MaybeUninit&lt;T&gt;; N]</code> into <code>Simd&lt;T, N&gt;</code>?"</p>



<a name="273758222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758222">(Mar 02 2022 at 05:31)</a>:</h4>
<p>This also matters to the intrinsics we are using, as e.g. we basically just decided "it's UB to use <code>simd_bitmask</code> on a vector of values that aren't <code>simd::true</code> and <code>simd::false</code>." <a href="https://github.com/rust-lang/portable-simd/pull/250">https://github.com/rust-lang/portable-simd/pull/250</a></p>



<a name="273758242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758242">(Mar 02 2022 at 05:31)</a>:</h4>
<p>imho we definitely need <code>Simd&lt;MaybeUninit&lt;T&gt;, N&gt;</code></p>



<a name="273758331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758331">(Mar 02 2022 at 05:33)</a>:</h4>
<p>maybe also <code>MaybeUninitMask&lt;...&gt;</code> since we assume <code>Mask</code> is fully initialized/valid</p>



<a name="273758502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758502">(Mar 02 2022 at 05:36)</a>:</h4>
<p>Selecting on a Mask atm generally needs to be on an initialized mask, yes, or it risks exploding the operation in Rust terms, and a Mask will usually explode if you try to leave it uninit, so it can only <strong>really</strong> be fully init or fully maybeuninit, yes.</p>



<a name="273758539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758539">(Mar 02 2022 at 05:37)</a>:</h4>
<p>well...llvm supports uninit lanes in a bit vector</p>



<a name="273758558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758558">(Mar 02 2022 at 05:37)</a>:</h4>
<p>yes but I don't think Rust does. :^)</p>



<a name="273758573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758573">(Mar 02 2022 at 05:37)</a>:</h4>
<p>Yeah, we store it as an integer...</p>



<a name="273758636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758636">(Mar 02 2022 at 05:38)</a>:</h4>
<p>And currently we're leaning hard away from "partially init bytes".</p>



<a name="273758721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758721">(Mar 02 2022 at 05:39)</a>:</h4>
<p>However, I should say:<br>
I don't think that has to mean we aren't allowed to ever have a Mask that is ambiguously initialized on a bit by bit basis, it just means it has to be a bit weirder than a "standard" integer.</p>



<a name="273758738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758738">(Mar 02 2022 at 05:39)</a>:</h4>
<p>well...<code>MaybeUninitMask</code> is the compiler magic way to support uninit lanes in a bit vector. i'd expect that there will be optimizations that can only be done by llvm if some lanes are uninit</p>



<a name="273758754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758754">(Mar 02 2022 at 05:39)</a>:</h4>
<p>Yeah, in rust an integer cannot be partially-uninit.</p>
<p><code>MaybeUninit&lt;integer&gt;</code> being partial is ok, but apparently MIRI doesn't actually implement that right now, which I learned in <a href="https://github.com/rust-lang/rust/issues/94371">https://github.com/rust-lang/rust/issues/94371</a></p>



<a name="273758834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758834">(Mar 02 2022 at 05:40)</a>:</h4>
<p>Oh right, we can MaybeUninit the whole integer, didn't even think of that</p>



<a name="273758863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758863">(Mar 02 2022 at 05:41)</a>:</h4>
<p>yes.</p>



<a name="273758870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758870">(Mar 02 2022 at 05:41)</a>:</h4>
<p>I'd be curious what the LLVM rules even are these days -- integers used to be partially-uninit-safe, but now that more things are <code>poison</code> instead I don't really know how things work with that.</p>



<a name="273758871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758871">(Mar 02 2022 at 05:41)</a>:</h4>
<p>probably:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">MaybeUninitBitMask</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">uint</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;&gt;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="273758878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758878">(Mar 02 2022 at 05:41)</a>:</h4>
<p>yeah that looks about right.</p>



<a name="273758882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273758882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273758882">(Mar 02 2022 at 05:41)</a>:</h4>
<p>Very optimistic throwing the generic int around lol</p>



<a name="273759043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/MaybeUninit%20vectors%20and%20UB/near/273759043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/MaybeUninit.20vectors.20and.20UB.html#273759043">(Mar 02 2022 at 05:44)</a>:</h4>
<p>In general I think functionally for most purposes we should think of any kind of Mask type and any kind of Simd type as being cousins rather than siblings, in terms of types. It's fine if Masks behave more weirdly by comparison. They either have an invariant that normal integers don't have to maintain or they have a much different relationship to size.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>