<html>
<head><meta charset="utf-8"><title>Scatter/Gathers · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html">Scatter/Gathers</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="242482002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242482002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242482002">(Jun 13 2021 at 01:05)</a>:</h4>
<p>I know this a big one, but has there been talk on how to implement and handle scatter/gather instructions. I suspect with masks and selects that LLVM might already output them, but I don't know how much I would trust them.</p>



<a name="242482048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242482048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242482048">(Jun 13 2021 at 01:06)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> is in the process of putting together a PR for that!</p>



<a name="242482062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242482062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242482062">(Jun 13 2021 at 01:07)</a>:</h4>
<p>Awesome, probably the last thing I think I need to have direct control over to write pretty much anything. LLVM already trivially uses ternlog instructions and FMAs when it detects that pattern. Scatters and gathers will make this usable for all my SIMD code I think!</p>



<a name="242482104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242482104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242482104">(Jun 13 2021 at 01:08)</a>:</h4>
<p>Hmm, LLVM generates FMA?  I think more recent versions of nightly shouldn't since that was probably a bug.</p>



<a name="242482105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242482105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242482105">(Jun 13 2021 at 01:08)</a>:</h4>
<p>One thing that'll be kinda tricky is doing scatter/gathers on u16s and stuff, where you don't actually have usize indicies. But it'd also be nice to be able to somehow do scatter/gathers on SimdU16 values, but with usizes (where LLVM/Rust would break it down into the larger pieces, and then join the vectors back)</p>



<a name="242482109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242482109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242482109">(Jun 13 2021 at 01:09)</a>:</h4>
<p>Though we will have an FMA function eventually</p>



<a name="242482111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242482111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242482111">(Jun 13 2021 at 01:09)</a>:</h4>
<p>Hmmm, maybe it doesnt? I know it makes ternlog.</p>



<a name="242482174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242482174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242482174">(Jun 13 2021 at 01:10)</a>:</h4>
<p>That's good, I'd expect ternlog to be generated from selects</p>



<a name="242482200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242482200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242482200">(Jun 13 2021 at 01:12)</a>:</h4>
<p>Yeah, doesn't look like it generates FMA. What's the reason for that? The internal precision of FMA not matching explicit multiply and add?</p>



<a name="242482291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242482291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242482291">(Jun 13 2021 at 01:14)</a>:</h4>
<p>Yeah, we want every operation to be completely compliant with IEEE 754 (not just vector ops, but scalar too)</p>



<a name="242482349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242482349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242482349">(Jun 13 2021 at 01:16)</a>:</h4>
<p>Makes sense!</p>



<a name="242483990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242483990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242483990">(Jun 13 2021 at 02:03)</a>:</h4>
<p>Yeah, the ideal we've wound up angling for is to just have everything be in principle a properly-aligned version of [T; N] that has some syntax sugar and some special parallel ops.</p>



<a name="242484078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242484078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242484078">(Jun 13 2021 at 02:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="356799">Brandon Falk</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.2FGathers/near/242482105">said</a>:</p>
<blockquote>
<p>One thing that'll be kinda tricky is doing scatter/gathers on u16s and stuff, where you don't actually have usize indicies. But it'd also be nice to be able to somehow do scatter/gathers on SimdU16 values, but with usizes (where LLVM/Rust would break it down into the larger pieces, and then join the vectors back)</p>
</blockquote>
<p>I am... mildly perplexed by what you mean by "don't have usize indices" here?</p>



<a name="242484183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242484183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242484183">(Jun 13 2021 at 02:08)</a>:</h4>
<p>Internally, LLVM takes the stance that scatter/gather is a vector of pointers with a vector mask and a base vector (so it's always actually a <code>select + gather</code> or <code>select + scatter</code>).</p>



<a name="242484220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242484220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242484220">(Jun 13 2021 at 02:09)</a>:</h4>
<p>So unfortunately Rust's portable SIMD API pushes the limits of what rustc and LLVM are capable of understanding. If you wanted LLVM to use an instruction that doesn't use full pointer-width indices, then it might compile to that incidentally but we don't have a meaningful way of expressing that.</p>



<a name="242485296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242485296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242485296">(Jun 13 2021 at 02:36)</a>:</h4>
<p>Hmm yeah, this is tough. There's a <code>vpscatterdd</code> which is <code>*(base + [signextend(index32); 16])</code>. Which is strange, 64-bit base, 32-bit indicies. But for a lot of data (&lt;4 GiB) it's usually what you want, especially if you're working with <code>f32</code>s and <code>u32</code>s, which is kinda most of the time for some heavy compute loops</p>



<a name="242485566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242485566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242485566">(Jun 13 2021 at 02:42)</a>:</h4>
<p>And you can kinda work around some limitations as you can do <code>vpgatherdd zmm0, [rax + zmm1*8]</code>, where the scalar can be 1, 2, 4, or 8, so you can actually index beyond 4 GiB with a 32-bit int, which is often more than sufficient for indexing even a large data set, without having to break it into 2 instructions to use 64-bit indicies. It's definitely a bit strange</p>



<a name="242485802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242485802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242485802">(Jun 13 2021 at 02:46)</a>:</h4>
<p>The actual op for x86 scatter/gathers is <code>base + signextend(index) * scale</code>, where scale is <code>1, 2, 4, 8</code> and index may be 32-bit or 64-bit. There is also <code>dq</code> and <code>qd</code> variants which use 32-bit indicies and fill into 64-bit vectors, and the opposite (conversion + scatter/gather)<br>
<code>vpgatherdq</code></p>
<blockquote>
<p>Gather 64-bit integers from memory using 32-bit indices. 64-bit elements are loaded from addresses starting at base_addr and offset by each 32-bit element in vindex (each index is scaled by the factor in scale). Gathered elements are merged into dst. scale should be 1, 2, 4 or 8.</p>
</blockquote>
<p><code>vpgatherqd</code></p>
<blockquote>
<p>Gather 32-bit integers from memory using 64-bit indices. 32-bit elements are loaded from addresses starting at base_addr and offset by each 64-bit element in vindex (each index is scaled by the factor in scale). Gathered elements are merged into dst. scale should be 1, 2, 4 or 8.</p>
</blockquote>



<a name="242485818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242485818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242485818">(Jun 13 2021 at 02:47)</a>:</h4>
<p>Are they worth engineering around? Hard to say, but there are pretty valid uses for this, especially if you want to potentially eliminate two data sets and use one where the conversion is done in the instruction</p>



<a name="242490316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242490316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242490316">(Jun 13 2021 at 04:54)</a>:</h4>
<p>Mmm. If the SIMD gather/scatter using the portable intrinsics doesn't compile to using those instructions ever, then likely it'd be more productive to file a bug against upstream, honestly, because "base pointer + offsets" isn't so wild an idea.</p>



<a name="242493170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242493170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242493170">(Jun 13 2021 at 06:17)</a>:</h4>
<p>Is FMA just fused multiply add but in SIMD vectors?</p>



<a name="242493245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242493245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242493245">(Jun 13 2021 at 06:19)</a>:</h4>
<p>yes.</p>



<a name="242540259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242540259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242540259">(Jun 14 2021 at 00:51)</a>:</h4>
<p>Noice.</p>



<a name="242548832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242548832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242548832">(Jun 14 2021 at 03:57)</a>:</h4>
<p>Anyways the nuances of the AVX gather/scatter API being more apt to the base + offsets model is why I intend to only yield a scatter/gather implementation that tags a single slice per function. We can't <strong>make</strong> LLVM do the right thing, but we can gently... ah... peer pressure it.</p>



<a name="242548835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242548835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242548835">(Jun 14 2021 at 03:57)</a>:</h4>
<p>Hopefully deriving all the pointers from a base pointer will show it the light.</p>



<a name="242549119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242549119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242549119">(Jun 14 2021 at 04:02)</a>:</h4>
<p>I think it would probably be reasonable if that's the only API we exposed, and anything else would need vendor intrinsics</p>



<a name="242552664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242552664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242552664">(Jun 14 2021 at 05:01)</a>:</h4>
<p>I disagree...I think scatter/gather based on vectors of pointers should be the API that we provide -- it should not be relegated to using arch-specific intrinsics, which would be overoptimizing the API for Intel's ISA imho.</p>



<a name="242552822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242552822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242552822">(Jun 14 2021 at 05:05)</a>:</h4>
<p>I don't object to having a scatter/gather API based on array indexing, however I think we would be making a serious mistake to say that array-indexing API is sufficient with no need to add pointer-vector APIs.</p>



<a name="242552948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242552948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242552948">(Jun 14 2021 at 05:07)</a>:</h4>
<p>It's worth noting that SVE also uses a single pointer with type-width offsets</p>



<a name="242552967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242552967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242552967">(Jun 14 2021 at 05:07)</a>:</h4>
<p>It's definitely not Intel-specific</p>



<a name="242553022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242553022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242553022">(Jun 14 2021 at 05:08)</a>:</h4>
<p>I think vectors of pointers are likely not going to be portable or efficient</p>



<a name="242554820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242554820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242554820">(Jun 14 2021 at 05:46)</a>:</h4>
<p>Well, both Intel and Arm SVE support loading from vectors of pointers. One of the SVE gather instructions has 64-bit vector elements for the input vector register, it calculates the addresses by adding a shifted 5-bit immediate to the input 64-bit vector elements, then loads 32-bit words from those addresses and then writes them to the destination vector after zero-extending the loaded words to 64-bits: <a href="https://developer.arm.com/documentation/ddi0602/latest/SVE-Instructions/LD1W--vector-plus-immediate---Gather-load-unsigned-words-to-vector--immediate-index--?lang=en#iclass_64_elem">https://developer.arm.com/documentation/ddi0602/latest/SVE-Instructions/LD1W--vector-plus-immediate---Gather-load-unsigned-words-to-vector--immediate-index--?lang=en#iclass_64_elem</a></p>



<a name="242554843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242554843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242554843">(Jun 14 2021 at 05:47)</a>:</h4>
<p>that instruction is <em>totally</em> useless except for gathering from a vector of pointers</p>



<a name="242555238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242555238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242555238">(Jun 14 2021 at 05:54)</a>:</h4>
<p>since SVE's designers went <em>out of their way</em> to add a whole class of load/store instructions just for use with vectors of pointers (the load/store with vector+immediate address), and since many other architectures also support gather/scatter with vectors of pointers (AVX2, AVX512, Libre-SOC's SimpleV extension for OpenPower, RISC-V V, and more), I think that's sufficient motivation to add support for vectors of pointers.</p>



<a name="242555412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242555412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242555412">(Jun 14 2021 at 05:58)</a>:</h4>
<p>in fact, all gather/scatter ISAs that I'm aware of support vectors of pointers.</p>



<a name="242652542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242652542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242652542">(Jun 14 2021 at 20:07)</a>:</h4>
<p>As far as I am concerned the real issue is programming ergonomics, and manipulating pointers is tricky. A safe, slice-oriented API satisfies most needs here without tying us too tightly to implementation details, and it will hopefully compile in a reasonably efficient way.</p>
<p>As we encounter more exotic concerns, we can address those on a case-by-case basis, and eventually we may expose such an API as you propose, Jacob, but really... pointers have a lot of unsettled questions and we're already in Ralf's face every five seconds to ask questions about target feature and const eval related stuff. I want to give the man a chance to catch his breath before I bombard him with 128 bits every nanosecond of questions about SIMD and pointers.</p>



<a name="242798816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/242798816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#242798816">(Jun 15 2021 at 20:58)</a>:</h4>
<p>Okay, rebuilt my scatter/gather branch and somehow the way I redid it this time to "properly" add in pointers and scatter/gather and such causes "unused" errors to not be emitted in most cases. Go figure.</p>



<a name="254738991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254738991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254738991">(Sep 24 2021 at 17:12)</a>:</h4>
<p>I think based on the recent... uh... comments? we might add scatter/gather_unchecked as a <em>minimally unsafe</em> API extension.</p>



<a name="254739117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254739117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254739117">(Sep 24 2021 at 17:13)</a>:</h4>
<p>Hmm did we never add any unchecked variant?</p>



<a name="254739179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254739179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254739179">(Sep 24 2021 at 17:13)</a>:</h4>
<p>nah, I didn't want to bother heh.</p>



<a name="254739255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254739255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254739255">(Sep 24 2021 at 17:13)</a>:</h4>
<p>I think we can add an unchecked variant with a matching API, and eventually we can add the one that takes pointers</p>



<a name="254739984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254739984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254739984">(Sep 24 2021 at 17:17)</a>:</h4>
<p>oh, i definitely think we should have unsafe variations of stuff where the safety has a performance overhead.</p>



<a name="254739991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254739991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254739991">(Sep 24 2021 at 17:17)</a>:</h4>
<p>yeah, I am thinking adding it on only the <code>_select</code> variant too, so that it has the thinnest API layer to the underlying intrinsic, and also implicitly requires them to assert "yeah this is fine."</p>



<a name="254740083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740083">(Sep 24 2021 at 17:18)</a>:</h4>
<p>"yeah I want to read <strong>all of these indices</strong>".</p>



<a name="254740200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740200">(Sep 24 2021 at 17:19)</a>:</h4>
<p>Yeah, if you're doing it unchecked I think it should only be on the most explicit one</p>



<a name="254740250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740250">(Sep 24 2021 at 17:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.2FGathers/near/254739984">said</a>:</p>
<blockquote>
<p>oh, i definitely think we should have unsafe variations of stuff where the safety has a performance overhead.</p>
</blockquote>
<p>yeah the... recent thread on this was deeply confusing.</p>



<a name="254740307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740307">(Sep 24 2021 at 17:20)</a>:</h4>
<p>I always took your implementation to be the MVP</p>



<a name="254740389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740389">(Sep 24 2021 at 17:20)</a>:</h4>
<p>We always knew there was more to add, particularly vector-of-pointers</p>



<a name="254740403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740403">(Sep 24 2021 at 17:20)</a>:</h4>
<p>because it was making a complaint that... didn't make much sense to me? until at the end we found out it was actually about performance concerns due to the underlying function constructing a mask.</p>



<a name="254740538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740538">(Sep 24 2021 at 17:21)</a>:</h4>
<p>and then I was like "oh okay."</p>



<a name="254740629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740629">(Sep 24 2021 at 17:22)</a>:</h4>
<p>Wouldn't worry too much about that</p>



<a name="254740704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740704">(Sep 24 2021 at 17:22)</a>:</h4>
<p>It can be a bit much if you're doing it a lot in a hot loop.</p>



<a name="254740722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740722">(Sep 24 2021 at 17:22)</a>:</h4>
<p>also why are you using scatter/gather in a hot loop</p>



<a name="254740743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740743">(Sep 24 2021 at 17:22)</a>:</h4>
<p>but I digress</p>



<a name="254740850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254740850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254740850">(Sep 24 2021 at 17:23)</a>:</h4>
<p>The check is actually surprising efficient, but not nothing</p>



<a name="254742000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742000">(Sep 24 2021 at 17:31)</a>:</h4>
<p>imho <code>gather/scatter_unchecked</code> should allow setting a base ptr of null and having the vector of <code>usize</code> offsets be pointers</p>



<a name="254742079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742079">(Sep 24 2021 at 17:31)</a>:</h4>
<p>eek</p>



<a name="254742201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742201">(Sep 24 2021 at 17:32)</a>:</h4>
<p>it allows making a poor-man's pointer vector scatter/gather</p>



<a name="254742265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742265">(Sep 24 2021 at 17:33)</a>:</h4>
<p>It's invalid actually.</p>



<a name="254742284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742284">(Sep 24 2021 at 17:33)</a>:</h4>
<p>I think that's technically fine with the pointer manipulations we're doing?</p>



<a name="254742290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742290">(Sep 24 2021 at 17:33)</a>:</h4>
<p>It requires forging the nullptr into a slice.</p>



<a name="254742340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742340">(Sep 24 2021 at 17:33)</a>:</h4>
<p>Oh, not with our API, agreed wrt that</p>



<a name="254742442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742442">(Sep 24 2021 at 17:34)</a>:</h4>
<p>oh, <code>scatter/gather_unchecked</code> should just take a base ptr, no length imho</p>



<a name="254742633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742633">(Sep 24 2021 at 17:35)</a>:</h4>
<p>so <code>unsafe fn gather&lt;T, const N: usize&gt;(base: *const T, indexes: Simd&lt;isize, N&gt;) -&gt; Simd&lt;T, N&gt;</code></p>



<a name="254742670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742670">(Sep 24 2021 at 17:36)</a>:</h4>
<p><code>isize</code> allows indexing backwards</p>



<a name="254742737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742737">(Sep 24 2021 at 17:36)</a>:</h4>
<p>It depends if we need to enforce anything with provenance or not</p>



<a name="254742768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742768">(Sep 24 2021 at 17:36)</a>:</h4>
<p>I believe we do not in this case</p>



<a name="254742956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254742956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254742956">(Sep 24 2021 at 17:37)</a>:</h4>
<p>semantically it should be equivalent to <code>for i in 0..N { retval[i] = *((base as usize).wrapping_add(index[i] as usize) as *const T); }</code></p>



<a name="254743145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743145">(Sep 24 2021 at 17:38)</a>:</h4>
<p>terrifying.</p>



<a name="254743189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743189">(Sep 24 2021 at 17:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.2FGathers/near/254742737">said</a>:</p>
<blockquote>
<p>It depends if we need to enforce anything with provenance or not</p>
</blockquote>
<p>uhhhhh.</p>



<a name="254743346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743346">(Sep 24 2021 at 17:40)</a>:</h4>
<p>when I explained what happens in my code for the scatter/gather API, Ralf made a "that's correct but it should be illegal" noise.</p>



<a name="254743352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743352">(Sep 24 2021 at 17:40)</a>:</h4>
<p>oh, oops, did i forget a multiplication by sizeof T?</p>



<a name="254743467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743467">(Sep 24 2021 at 17:41)</a>:</h4>
<p>like</p>



<a name="254743498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743498">(Sep 24 2021 at 17:41)</a>:</h4>
<p>the impl as written may literally be invalidated in the future</p>



<a name="254743653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743653">(Sep 24 2021 at 17:42)</a>:</h4>
<p>Hmm. I thought I looked at LLVM docs and it seemed fine</p>



<a name="254743736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743736">(Sep 24 2021 at 17:42)</a>:</h4>
<p>should it be <code>unsafe fn gather_unchecked_byte_addressing&lt;T, const N: usize&gt;(base: *const (), byte_offsets: Simd&lt;isize, N&gt;) -&gt; Simd&lt;T, N&gt;</code></p>



<a name="254743800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743800">(Sep 24 2021 at 17:43)</a>:</h4>
<p>I don't think the type really matters</p>



<a name="254743882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743882">(Sep 24 2021 at 17:43)</a>:</h4>
<p>If you want to do something like that, just use u8 and cast it</p>



<a name="254743894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743894">(Sep 24 2021 at 17:43)</a>:</h4>
<p>Transmute it</p>



<a name="254743965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743965">(Sep 24 2021 at 17:44)</a>:</h4>
<p>Well</p>



<a name="254743988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254743988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254743988">(Sep 24 2021 at 17:44)</a>:</h4>
<p>well, <code>gather_unchecked_byte_addressing</code> skips the mul by <code>sizeof::&lt;T&gt;()</code>, allowing you to pass pointers</p>



<a name="254744037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254744037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254744037">(Sep 24 2021 at 17:44)</a>:</h4>
<p>I think the best place to start with an unchecked API is to just use vectors-of-pointers</p>



<a name="254744079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254744079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254744079">(Sep 24 2021 at 17:45)</a>:</h4>
<p>Deal with any in-between APIs later</p>



<a name="254744219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254744219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254744219">(Sep 24 2021 at 17:46)</a>:</h4>
<p>if there is the mul by <code>sizeof::&lt;T&gt;()</code> then you can only operate on <code>u8</code> vectors unless the pointers are multiples of <code>sizeof::&lt;T&gt;()</code> and you divide ahead of time</p>



<a name="254744254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254744254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254744254">(Sep 24 2021 at 17:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Scatter.2FGathers/near/254743653">said</a>:</p>
<blockquote>
<p>Hmm. I thought I looked at LLVM docs and it seemed fine</p>
</blockquote>
<p>It's subtly issue-laden.</p>



<a name="254744619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Scatter/Gathers/near/254744619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Scatter.2FGathers.html#254744619">(Sep 24 2021 at 17:49)</a>:</h4>
<p>well, the nice part is the llvm intinsics just take a vector of pointers and make you do the address calc yourself, so we could do <code>wrapping_add</code> if we want</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>