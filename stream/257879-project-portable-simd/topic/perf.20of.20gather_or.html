<html>
<head><meta charset="utf-8"><title>perf of gather_or · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html">perf of gather_or</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275137021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275137021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275137021">(Mar 13 2022 at 06:26)</a>:</h4>
<p>Any ideas how to make the performance of these two functions equivalent?</p>
<div class="codehilite"><pre><span></span><code>#![feature(portable_simd)]
use std::convert::TryInto;
use std::simd::*;

pub fn take_i32(values: &amp;[i32], indices: &amp;[usize]) -&gt; Vec&lt;i32&gt; {
    indices.iter().map(|index| values[*index]).collect()
}

pub fn take_i32_simd(values: &amp;[i32], indices: &amp;[usize]) -&gt; Vec&lt;i32&gt; {
    let chunks = indices.chunks_exact(8);

    let iter = chunks.map(|chunk| {
        let chunk: [usize; 8] = chunk.try_into().unwrap();
        let chunk = usizex8::from_array(chunk);
        Simd::gather_or_default(values, chunk)
    });
    let mut values = Vec::with_capacity(indices.len());
    for chunk in iter {
        values.extend_from_slice(chunk.as_array())
    }

    values
}
</code></pre></div>
<p>atm I am getting</p>
<div class="codehilite"><pre><span></span><code>core_simd_take 2^20 f32 time:   [1.9418 ms 1.9760 ms 2.0199 ms]
naive_take 2^20 f32     time:   [904.55 us 921.93 us 943.80 us]
</code></pre></div>
<p>which is quite a difference, unfortunately</p>



<a name="275137101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275137101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275137101">(Mar 13 2022 at 06:29)</a>:</h4>
<p>Gathers are not going to be performant on most CPUs (but they should at least be the optimal way of performing that SIMD load), but the problem here is those functions aren't really doing anything with SIMD at all</p>



<a name="275137161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275137161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275137161">(Mar 13 2022 at 06:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="399416">Jorge Leitao</span> <a href="#narrow/stream/257879-project-portable-simd/topic/perf.20of.20gather_or/near/275137021">said</a>:</p>
<blockquote>
<p>Any ideas how to make the performance of these two functions equivalent?</p>
<p>atm I am getting</p>
<div class="codehilite"><pre><span></span><code>core_simd_take 2^20 f32 time:   [1.9418 ms 1.9760 ms 2.0199 ms]
naive_take 2^20 f32     time:   [904.55 us 921.93 us 943.80 us]
</code></pre></div>
<p>which is quite a difference, unfortunately</p>
</blockquote>
<p>what architecture are you targeting?</p>



<a name="275137165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275137165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275137165">(Mar 13 2022 at 06:30)</a>:</h4>
<p>So in this particular case I don't think SIMD is an optimization except on perhaps a handful of CPUs</p>



<a name="275137478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275137478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275137478">(Mar 13 2022 at 06:40)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> , dammit, that was it - compiling for native (skylake-avx512) fixed it and made it 10% faster:</p>
<div class="codehilite"><pre><span></span><code>core_simd_take 2^20 f32 time:   [873.38 us 889.33 us 909.57 us]
naive_take 2^20 f32     time:   [956.56 us 974.87 us 996.98 us]
</code></pre></div>



<a name="275137520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275137520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275137520">(Mar 13 2022 at 06:40)</a>:</h4>
<p>ha.</p>



<a name="275137529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275137529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275137529">(Mar 13 2022 at 06:40)</a>:</h4>
<p>yeah it's not really going to be an optimization tbh on most architectures.</p>



<a name="275137532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275137532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275137532">(Mar 13 2022 at 06:40)</a>:</h4>
<p>It's actually disappointing how little of an optimization it is with avx-512</p>



<a name="275137536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275137536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275137536">(Mar 13 2022 at 06:41)</a>:</h4>
<p>right?</p>



<a name="275137541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275137541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275137541">(Mar 13 2022 at 06:41)</a>:</h4>
<p>Though I guess that proves it's doing something</p>



<a name="275137586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275137586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275137586">(Mar 13 2022 at 06:42)</a>:</h4>
<p>I made it a 10% faster by writing the chunks to the <code>Vec</code> in a different way:</p>
<div class="codehilite"><pre><span></span><code>core_simd_take 2^20 f32 time:   [763.22 us 772.10 us 782.71 us]
naive_take 2^20 f32     time:   [960.43 us 974.74 us 993.29 us]
</code></pre></div>
<div class="codehilite"><pre><span></span><code>    let mut values = Vec::with_capacity(indices.len());
    let mut dst = values.as_mut_ptr() as *mut Simd&lt;i32, 8&gt;;
    for chunk in iter {
        unsafe { dst.write_unaligned(chunk) };
        unsafe { dst = dst.add(1) };
    }
    unsafe { values.set_len(indices.len()) }
</code></pre></div>
<p>We could consider offer something like this, so that folks do not have to use <code>unsafe</code> to write simds to a vector of values?</p>



<a name="275138118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275138118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275138118">(Mar 13 2022 at 06:57)</a>:</h4>
<p>Unfortunately we don't actually know that the capacity is sufficient so it essentially requires <code>unsafe</code> code anyways.</p>



<a name="275138173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275138173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275138173">(Mar 13 2022 at 06:58)</a>:</h4>
<p>can't we do it via <a href="https://doc.rust-lang.org/std/iter/trait.TrustedLen.html">TrustedLen</a>?</p>



<a name="275138443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275138443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275138443">(Mar 13 2022 at 07:04)</a>:</h4>
<p>Oh I mean the capacity of the vector. This only works because you know your vector cap because you made it.</p>



<a name="275138608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275138608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275138608">(Mar 13 2022 at 07:09)</a>:</h4>
<p>something like this (with appropriate generics over lanes and types)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[inline]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">collect_vec</span><span class="o">&lt;</span><span class="n">I</span>: <span class="nc">TrustedLen</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Simd</span><span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">iter</span>: <span class="nc">I</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">LANES</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">size_hint</span><span class="p">().</span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">LANES</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="n">len</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">dst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Simd</span><span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">LANES</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dst</span><span class="p">.</span><span class="n">write_unaligned</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">dst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dst</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="n">set_len</span><span class="p">(</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">values</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275140799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275140799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275140799">(Mar 13 2022 at 08:10)</a>:</h4>
<p>tbh, I'd expect <code>.flat_map(|x| x.to_array()).collect()</code> to be pretty good for that, now, since <code>flat_map</code> is specialized for arrays to have a perfect <code>size_hint</code>.</p>



<a name="275140860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275140860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275140860">(Mar 13 2022 at 08:12)</a>:</h4>
<p>But what I really want is a <code>Vec&lt;[T; N]&gt; -&gt; Vec&lt;T&gt;</code> API, since I think that can be done in-place no problem, and it's infallible, unlike the other way.</p>
<p>Then you could <code>.map(|x| x.to_array()).collect_vec().flatten()</code>.</p>
<p>(Well, infallible for non-ZSTs)</p>



<a name="275141008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/perf%20of%20gather_or/near/275141008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/perf.20of.20gather_or.html#275141008">(Mar 13 2022 at 08:17)</a>:</h4>
<p>Thanks for the tip <span class="user-mention" data-user-id="125270">@scottmcm</span> - I confirm - <code>flat_map</code> is equivalent to the above performance-wise</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>