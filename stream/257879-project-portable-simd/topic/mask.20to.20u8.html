<html>
<head><meta charset="utf-8"><title>mask to u8 · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html">mask to u8</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267373598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267373598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267373598">(Jan 09 2022 at 19:35)</a>:</h4>
<p>Is there a way to safely convert <code>std::simd::Mask&lt;i8, 8_usize&gt;</code> to <code>u8</code>? I imagine that they have the same in-memory repr, but can't find a method for this</p>



<a name="267373919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267373919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267373919">(Jan 09 2022 at 19:42)</a>:</h4>
<p>yes, use <code>Mask::to_bitmask</code>. Also, <code>Mask</code> isn't necessarily a bitmask, on some architectures (such as x86 non-avx512 and arm neon) it is a vector of integers where each lane has all bits set/clear for true/false values.</p>



<a name="267374010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267374010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267374010">(Jan 09 2022 at 19:44)</a>:</h4>
<p>is that documented? In <a href="https://doc.rust-lang.org/nightly/std/simd/struct.Mask.html">https://doc.rust-lang.org/nightly/std/simd/struct.Mask.html</a> I can't find <code>to_bitmask</code></p>



<a name="267374016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267374016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267374016">(Jan 09 2022 at 19:44)</a>:</h4>
<p><a href="https://github.com/rust-lang/portable-simd/blob/65cb2c90a0688c110d983a2dbb9932900cd6b5d9/crates/core_simd/src/masks/full_masks.rs#L115">https://github.com/rust-lang/portable-simd/blob/65cb2c90a0688c110d983a2dbb9932900cd6b5d9/crates/core_simd/src/masks/full_masks.rs#L115</a></p>



<a name="267374037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267374037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267374037">(Jan 09 2022 at 19:45)</a>:</h4>
<p>it may need an additional feature enabled when building std, so it may not work by default</p>



<a name="267374173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267374173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267374173">(Jan 09 2022 at 19:49)</a>:</h4>
<p>to understand, when an additional feature is required, is there a way to activate it at the dependency level, or it basically requires re-compiling the std with that feature?</p>



<a name="267374245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267374245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267374245">(Jan 09 2022 at 19:50)</a>:</h4>
<p>idk, <span class="user-mention" data-user-id="312331">@Caleb Zulawski</span> may know since he's worked on the code more recently...</p>



<a name="267374279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267374279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267374279">(Jan 09 2022 at 19:51)</a>:</h4>
<p>wrt to the vector of integers in some archs: thanks for the info. I am porting an Apache Arrow implementation, and Apache Arrow uses bitmaps as its Vec&lt;bool&gt; container, so it is not an option to optimize for different arches - the format itself is designed to hit avx512 and other archs are penalized</p>



<a name="267374324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267374324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267374324">(Jan 09 2022 at 19:52)</a>:</h4>
<p>It's not available on std right now because it requires an incomplete feature</p>



<a name="267374359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267374359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267374359">(Jan 09 2022 at 19:53)</a>:</h4>
<p>I'm planning on adding conversion to basic ints to nightly without the incomplete feature</p>



<a name="267374415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267374415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267374415">(Jan 09 2022 at 19:54)</a>:</h4>
<p>The masks actually often do not have the same representation in memory</p>



<a name="267374913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267374913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267374913">(Jan 09 2022 at 20:03)</a>:</h4>
<p>got it. Yeah, the ability to convert to bitmask is a requirement for us (packed_simd supports it), so thanks a lot for taking it on.</p>
<p>For context, I am a maintainer of arrow2 and I am trying to port it to <code>std::simd</code> (<a href="https://github.com/jorgecarleitao/arrow2/pull/747">https://github.com/jorgecarleitao/arrow2/pull/747</a>). We make some use of packed_simd atm, so these are just questions coming from this exercise. I am trying to have a compiling code so that we can MIRI our tests against portable simd, which should provide useful data.</p>



<a name="267378657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267378657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267378657">(Jan 09 2022 at 21:28)</a>:</h4>
<p><span class="user-mention" data-user-id="229517">@Jacob Lifshay</span> I'm trying to figure out a good API for handling this, I think at a minimum we should support both conversions to an integer and a conversion to <code>[u8; N]</code></p>



<a name="267378685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267378685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267378685">(Jan 09 2022 at 21:29)</a>:</h4>
<p>Do you think it would be an oversimplification to only support conversion to <code>u64</code> for all masks with &lt;=64 lanes as far as integers go?</p>



<a name="267378782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267378782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267378782">(Jan 09 2022 at 21:31)</a>:</h4>
<p>We would still eventually support conversion to <code>[u8; N]</code>, in addition</p>



<a name="267378857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267378857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267378857">(Jan 09 2022 at 21:33)</a>:</h4>
<p>This would mean, for example, that a future <code>Mask&lt;_, 128&gt;</code> would not have conversion to <code>u128</code> without passing through an array of <code>[u8, 16]</code> first</p>



<a name="267379247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379247">(Jan 09 2022 at 21:42)</a>:</h4>
<p>hmm, i would have just picked changing it to:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// no #[cfg(feature)] needed cuz generic const expressions aren't needed when expressing it this way</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">to_bitmask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">LaneCount</span>::<span class="o">&lt;</span><span class="n">LANES</span><span class="o">&gt;</span>::<span class="n">BitMask</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="267379256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379256">(Jan 09 2022 at 21:43)</a>:</h4>
<p>where <code>BitMask</code> is <code>[u8; N]</code></p>



<a name="267379304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379304">(Jan 09 2022 at 21:44)</a>:</h4>
<p>I think enough people have been confused about something returning an integer that we should provide something that gives an integer directly</p>



<a name="267379316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379316">(Jan 09 2022 at 21:44)</a>:</h4>
<p>k, <code>to_int_bitmask</code></p>



<a name="267379318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379318">(Jan 09 2022 at 21:45)</a>:</h4>
<p>I was thinking <code>to_u64_bitmask</code>, but yeah</p>



<a name="267379385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379385">(Jan 09 2022 at 21:46)</a>:</h4>
<p>maybe just define it for <code>LANES &lt;= 64</code> and also have variants for <code>u8</code>, <code>u16</code>, <code>u32</code>, and <code>u128</code> with <code>LANES &lt;= 8/16/32/128</code></p>



<a name="267379398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379398">(Jan 09 2022 at 21:47)</a>:</h4>
<p>well, that's what I was really wondering, is it worth it to define the other variants?</p>



<a name="267379448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379448">(Jan 09 2022 at 21:48)</a>:</h4>
<p>you could always do <code>mask.to_u64_bitmask().into()</code>, which would support all of those except <code>u128</code>, but I'm less confident about <code>u128</code> ever being as optimal as the other integer sizes</p>



<a name="267379457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379457">(Jan 09 2022 at 21:48)</a>:</h4>
<p>imho yes, cuz we want users to think "oh, what happens when i want 128 or more lanes? will <code>u64</code> (or whatever) be big enough?"</p>



<a name="267379473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379473">(Jan 09 2022 at 21:49)</a>:</h4>
<p>I guess I'm looking at it as there are two different ways of using it, one converts to "normal" integers, and the other converts to an array that you can do whatever you want with</p>



<a name="267379480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379480">(Jan 09 2022 at 21:49)</a>:</h4>
<p>otherwise they'll just assume u64 must always be big enough and design inflexible code</p>



<a name="267379482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379482">(Jan 09 2022 at 21:49)</a>:</h4>
<p>I'm also trying to minimize the API a bit</p>



<a name="267379539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379539">(Jan 09 2022 at 21:50)</a>:</h4>
<p><code>fn to_int_bitmask(self) -&gt; LaneCount::&lt;LANES&gt;::BitMask</code> is definitely a lot more confusing than <code>fn to_u64_bitmask(self) -&gt; u64</code></p>



<a name="267379560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379560">(Jan 09 2022 at 21:51)</a>:</h4>
<p>also now that I think about it, it can't be on <code>LaneCount</code>, because it's only supported on 128 or smaller, and the max supported lane count in the future could be larger</p>



<a name="267379604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379604">(Jan 09 2022 at 21:52)</a>:</h4>
<p>yup, it's soo confusing that you were just now confused...<code>BitMask</code> is currently always an <code>[u8; N]</code></p>



<a name="267379616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379616">(Jan 09 2022 at 21:52)</a>:</h4>
<p>I thought that variable is gone now?</p>



<a name="267379621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379621">(Jan 09 2022 at 21:52)</a>:</h4>
<p>but yeah, lol</p>



<a name="267379641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379641">(Jan 09 2022 at 21:53)</a>:</h4>
<p>I'm just suggesting that if you're doing anything larger than 64, you'll have to pass through the array of <code>u8</code> instead of an integer, drawing a line at <code>u64</code> since that's the most "portable"</p>



<a name="267379698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379698">(Jan 09 2022 at 21:55)</a>:</h4>
<p>I meant more like <code>fn to_int_bitmask(self) -&gt; LaneCount::&lt;LANES&gt;::BitMaskInt</code> where <code>LANES &lt;= 8</code> gives <code>u8</code>, <code>8 &lt; LANES &lt;= 16</code> gives <code>u16</code>, etc.</p>



<a name="267379709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379709">(Jan 09 2022 at 21:55)</a>:</h4>
<p>and above u128 it gives what?</p>



<a name="267379750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379750">(Jan 09 2022 at 21:56)</a>:</h4>
<p>tho if we were ever to get generic int types, i'd want it to give <code>uint::&lt;LANES&gt;</code></p>



<a name="267379760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379760">(Jan 09 2022 at 21:56)</a>:</h4>
<p>idk, a library type?</p>



<a name="267379772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379772">(Jan 09 2022 at 21:57)</a>:</h4>
<p>fall back to <code>[u8; N]</code>?</p>



<a name="267379776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379776">(Jan 09 2022 at 21:57)</a>:</h4>
<p>still seems confusing to me, I think I'm just hoping to implement two functions with concrete types</p>



<a name="267379822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379822">(Jan 09 2022 at 21:58)</a>:</h4>
<div class="codehilite"><pre><span></span><code>fn to_u64_bitmask(self) -&gt; u64;
fn to_bitmask(self) -&gt; [u8; LaneCount::&lt;LANES&gt;::BITMASK_LEN];
</code></pre></div>



<a name="267379826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379826">(Jan 09 2022 at 21:58)</a>:</h4>
<p><code>to_bitmask</code> will still have the scaling API</p>



<a name="267379844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379844">(Jan 09 2022 at 21:59)</a>:</h4>
<p>how about just calling it <code>fn trunc_to_u64_bitmask(self) -&gt; u64</code>, if it has <code>trunc</code> in the name, then i think it's obvious enough that your code won't work with &gt; 64 lanes</p>



<a name="267379915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379915">(Jan 09 2022 at 22:00)</a>:</h4>
<p>or <code>wrapping</code>, tho <code>trunc</code> seems better to me</p>



<a name="267379966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379966">(Jan 09 2022 at 22:00)</a>:</h4>
<p>oh, I was going to only implement the function on masks with &lt;=64 lanes</p>



<a name="267379972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379972">(Jan 09 2022 at 22:01)</a>:</h4>
<p>we can reserve <code>to_int_bitmask</code> for the generic int version</p>



<a name="267379975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379975">(Jan 09 2022 at 22:01)</a>:</h4>
<p>so no truncation</p>



<a name="267379992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267379992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267379992">(Jan 09 2022 at 22:01)</a>:</h4>
<p><code>to_short_int</code>?</p>



<a name="267380035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380035">(Jan 09 2022 at 22:02)</a>:</h4>
<p>not sure what short means here?</p>



<a name="267380049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380049">(Jan 09 2022 at 22:02)</a>:</h4>
<p>short == only works when LANES &lt;= 64</p>



<a name="267380051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380051">(Jan 09 2022 at 22:02)</a>:</h4>
<p><code>short int</code> to me means <code>i16</code> :)</p>



<a name="267380062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380062">(Jan 09 2022 at 22:03)</a>:</h4>
<p>s/short/small/</p>



<a name="267380114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380114">(Jan 09 2022 at 22:04)</a>:</h4>
<p>limited?</p>



<a name="267380116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380116">(Jan 09 2022 at 22:04)</a>:</h4>
<p>also somewhat separate from the naming, I'm still not sure if we should or shouldn't be implementing <code>Into</code> instead?</p>



<a name="267380123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380123">(Jan 09 2022 at 22:04)</a>:</h4>
<p>I'm not sure if the conversion is self-explanatory or not?</p>



<a name="267380129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380129">(Jan 09 2022 at 22:05)</a>:</h4>
<p>imho we shouldn't implement <code>into</code> cuz conversion can be quite expensive</p>



<a name="267380142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380142">(Jan 09 2022 at 22:05)</a>:</h4>
<p>that's fair</p>



<a name="267380214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380214">(Jan 09 2022 at 22:06)</a>:</h4>
<p>another option I had considered is <code>trait ToBitMask&lt;T&gt;</code> which mirrors <code>Into</code>, which would allow us to implement it for whatever arbitrary types make sense for a mask</p>



<a name="267380244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380244">(Jan 09 2022 at 22:07)</a>:</h4>
<p>like if we ever got generic integers, just implement it over that</p>



<a name="267380292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380292">(Jan 09 2022 at 22:08)</a>:</h4>
<p>if we get better const generics, we can improve the trait impl for <code>[u8; N]</code></p>



<a name="267380293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380293">(Jan 09 2022 at 22:08)</a>:</h4>
<p>etc</p>



<a name="267380337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380337">(Jan 09 2022 at 22:09)</a>:</h4>
<p>then you could make a generic function that arbitrarily uses either an array or an integer too, just do <code>T: ToBitMask</code></p>



<a name="267380387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380387">(Jan 09 2022 at 22:10)</a>:</h4>
<p>hmm, that may be a good idea, tho i really wish we could just hold out for generic ints</p>



<a name="267380406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380406">(Jan 09 2022 at 22:11)</a>:</h4>
<p>actually, I just realized if we got generic ints we could just do <code>fn to_bitmask(self) -&gt; uint&lt;LANES&gt;</code> directly on masks, and deprecate the trait</p>



<a name="267380485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380485">(Jan 09 2022 at 22:13)</a>:</h4>
<p>how about having a <code>BitMask&lt;LANES&gt;</code> type that implements the appropriate <code>into</code> conversions from/to all integer types? just expose our existing bitmask type?</p>



<a name="267380548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380548">(Jan 09 2022 at 22:15)</a>:</h4>
<p>I think that type wouldn't have any methods, only conversions, so I'm not sure it would buy us anything</p>



<a name="267380625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380625">(Jan 09 2022 at 22:16)</a>:</h4>
<p>it would buy us having a centralized place for all bitmask-specific operations -- e.g. popcount and int conversions</p>



<a name="267380635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380635">(Jan 09 2022 at 22:17)</a>:</h4>
<p>and conversions to avx512 bitmask types</p>



<a name="267380650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380650">(Jan 09 2022 at 22:17)</a>:</h4>
<p>also it's useful if you want to store masks in memory and you want density over speed</p>



<a name="267380710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380710">(Jan 09 2022 at 22:19)</a>:</h4>
<p>I'm not sure it makes sense for popcount to exist on the bitmask, vs having a <code>count_set</code> fn on masks proper</p>



<a name="267380720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380720">(Jan 09 2022 at 22:19)</a>:</h4>
<p>which I'm sure could be implemented much better than a bitmask and popcount on most architectures</p>



<a name="267380734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380734">(Jan 09 2022 at 22:19)</a>:</h4>
<p>idk, just trying to think of something that would go...</p>



<a name="267380779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380779">(Jan 09 2022 at 22:20)</a>:</h4>
<p>lol</p>



<a name="267380781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380781">(Jan 09 2022 at 22:20)</a>:</h4>
<p>yeah it's possible</p>



<a name="267380782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380782">(Jan 09 2022 at 22:20)</a>:</h4>
<p>also, bitmask + popcount is the most efficient on a decent pile of archs</p>



<a name="267380790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380790">(Jan 09 2022 at 22:20)</a>:</h4>
<p>I guess I'm just thinking if you want to do anything with bitmasks, you manage it yourself as an integer or an array or whatever</p>



<a name="267380798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380798">(Jan 09 2022 at 22:20)</a>:</h4>
<p>x86, arm sve, risc-v, simplev</p>



<a name="267380863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380863">(Jan 09 2022 at 22:22)</a>:</h4>
<p>doesn't popcount take like 10+ cycles? wouldn't <code>mask.select(ones, zeros).horizontal_sum()</code> be faster even on x86?</p>



<a name="267380952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380952">(Jan 09 2022 at 22:24)</a>:</h4>
<p>nevermind, it's plenty fast on most cpus, but terrible on some</p>



<a name="267380965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267380965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267380965">(Jan 09 2022 at 22:25)</a>:</h4>
<p>anyway i think it would make more sense to put most functions on regular masks so you don't have to know how fast bitmasks are on your target</p>



<a name="267381026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381026">(Jan 09 2022 at 22:26)</a>:</h4>
<p>yeah, that may be a good idea, tho I still think exposing the <code>BitMask</code> type is a good idea</p>



<a name="267381085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381085">(Jan 09 2022 at 22:28)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// eventually</span>
<span class="cp">#[repr(transparent)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">BitMask</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">LANES</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="p">(</span><span class="k">pub</span><span class="w"> </span><span class="n">uint</span>::<span class="o">&lt;</span><span class="n">LANES</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="267381113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381113">(Jan 09 2022 at 22:29)</a>:</h4>
<p>I think fundamentally my problem with it is that it's not a simd type, and it doesn't have anything to do with simd at that point</p>



<a name="267381116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381116">(Jan 09 2022 at 22:29)</a>:</h4>
<p>like ints have popcount etc</p>



<a name="267381143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381143">(Jan 09 2022 at 22:30)</a>:</h4>
<p>it's simd cuz it can be used for bitmasks, and cuz it still works with LANES &gt; 128</p>



<a name="267381145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381145">(Jan 09 2022 at 22:30)</a>:</h4>
<p>unlike <code>u128/64</code></p>



<a name="267381146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381146">(Jan 09 2022 at 22:30)</a>:</h4>
<p>and it might trick you into thinking using <code>BitMask</code> is fast(er) and not look for <code>mask.all_set()</code> or whatever</p>



<a name="267381159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381159">(Jan 09 2022 at 22:30)</a>:</h4>
<p>yeah, that's why I was leaning for the trait instead though, still supporting all types that make sense</p>



<a name="267381179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381179">(Jan 09 2022 at 22:31)</a>:</h4>
<p>those'd be supported by <code>From/Into</code> impls on <code>BitMask</code></p>



<a name="267381239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381239">(Jan 09 2022 at 22:33)</a>:</h4>
<p>yeah at this point I think it's just confusing having a bitmask type, I still don't see anything that it offers over the regular mask type with conversions directly on that</p>



<a name="267381291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381291">(Jan 09 2022 at 22:34)</a>:</h4>
<p>also the bitmask type inherently wouldn't work without the incomplete rust feature, which is part of the benefit of the trait</p>



<a name="267381376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381376">(Jan 09 2022 at 22:36)</a>:</h4>
<p>uuh, it'd work just fine:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">BitMask</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">LANES</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">bytes</span>: <span class="nc">LaneCount</span>::<span class="o">&lt;</span><span class="n">LANES</span><span class="o">&gt;</span>::<span class="n">BitMask</span><span class="p">,</span><span class="w"> </span><span class="c1">// to be replaced with uint&lt;LANES&gt;</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="267381382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381382">(Jan 09 2022 at 22:36)</a>:</h4>
<p>hmmm</p>



<a name="267381398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381398">(Jan 09 2022 at 22:37)</a>:</h4>
<p>that's true</p>



<a name="267381403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381403">(Jan 09 2022 at 22:38)</a>:</h4>
<p>benefits include dense storage of masks even with &gt;128 lanes</p>



<a name="267381449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381449">(Jan 09 2022 at 22:38)</a>:</h4>
<p>any reason that couldn't just be a <code>[u8; _]</code>?</p>



<a name="267381454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381454">(Jan 09 2022 at 22:38)</a>:</h4>
<p>which would also be much more explicit</p>



<a name="267381482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381482">(Jan 09 2022 at 22:39)</a>:</h4>
<p>cuz we want to replace its guts with <code>uint&lt;LANES&gt;</code> later, you can't easily replace explicit <code>[u8; _]</code> API types as easily</p>



<a name="267381537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381537">(Jan 09 2022 at 22:40)</a>:</h4>
<p>well I was suggesting that if we ever actually got generic integers, we can just implement a function directly on <code>Mask</code>, which would be better than <code>BitMask</code> too</p>



<a name="267381551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381551">(Jan 09 2022 at 22:40)</a>:</h4>
<p>though I'm not particularly optimistic about ever getting generic ints</p>



<a name="267381616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381616">(Jan 09 2022 at 22:42)</a>:</h4>
<p>idk that I'd want to implement <code>select</code> directly on integer types, hence <code>BitMask</code></p>



<a name="267381624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381624">(Jan 09 2022 at 22:42)</a>:</h4>
<p>I didn't think we should implement <code>select</code> on <code>BitMask</code> either though?</p>



<a name="267381630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381630">(Jan 09 2022 at 22:43)</a>:</h4>
<p>why not?</p>



<a name="267381633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381633">(Jan 09 2022 at 22:43)</a>:</h4>
<p>well why would we?</p>



<a name="267381634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381634">(Jan 09 2022 at 22:43)</a>:</h4>
<p>it's implemented on <code>Mask</code></p>



<a name="267381647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381647">(Jan 09 2022 at 22:43)</a>:</h4>
<p>cuz you may want to <code>select</code> w/o conversion to a full-mask, e.g. on avx512</p>



<a name="267381691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381691">(Jan 09 2022 at 22:44)</a>:</h4>
<p>where we'd probably have to have Mask be full-width due to compat with &lt;= AVX2</p>



<a name="267381696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381696">(Jan 09 2022 at 22:44)</a>:</h4>
<p>on avx512 it actually optimizes to using the masked instructions, even with the full-width masks</p>



<a name="267381698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marmeladema <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381698">(Jan 09 2022 at 22:44)</a>:</h4>
<p>I am not simd expert, but people will need to have <em>some</em> form of to_bitmask with an array of u8 or a u8/u16/u32/u64 to make it practical.<br>
Otherwise there are a lot of algorithm you cannot implement with std::simd right now and it kind of defeats the purpose</p>



<a name="267381709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381709">(Jan 09 2022 at 22:45)</a>:</h4>
<p><span class="user-mention" data-user-id="281572">@marmeladema</span> we are definitely implementing it in some form, we're just bikeshedding the specifics</p>



<a name="267381715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381715">(Jan 09 2022 at 22:45)</a>:</h4>
<p>(it's implemented already in some way, but isn't usable on nightly yet)</p>



<a name="267381761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marmeladema <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381761">(Jan 09 2022 at 22:46)</a>:</h4>
<p>What I meant is that there can be multiple solution to this. and we don't have to implement the perfect solution right now. if we had at least int or array methods right now that'd be sufficient to let people experiment with it</p>



<a name="267381766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marmeladema <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381766">(Jan 09 2022 at 22:47)</a>:</h4>
<p>ie: available in nightly</p>



<a name="267381777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381777">(Jan 09 2022 at 22:47)</a>:</h4>
<p>yeah, the plan is to have at least the integer versions available asap</p>



<a name="267381779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marmeladema <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381779">(Jan 09 2022 at 22:47)</a>:</h4>
<p>because I don't believe there are any workarounds at the moment right?</p>



<a name="267381830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381830">(Jan 09 2022 at 22:48)</a>:</h4>
<p>at the moment, nope</p>



<a name="267381853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381853">(Jan 09 2022 at 22:49)</a>:</h4>
<p>call rustc's simd intrinsics directly?</p>



<a name="267381905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267381905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267381905">(Jan 09 2022 at 22:50)</a>:</h4>
<p>well, yeah, technically that, but no workarounds I would consider recommended...</p>



<a name="267396289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267396289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267396289">(Jan 10 2022 at 05:03)</a>:</h4>
<p>I finished the migration to portable simd, but I am getting some performance regressions (+950% in masks of 8 to u8, +25% in horizontal_sum). See <a href="https://github.com/jorgecarleitao/arrow2/pull/747">https://github.com/jorgecarleitao/arrow2/pull/747</a>. Could someone guide me into understanding what am I doing wrong?</p>



<a name="267396450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267396450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267396450">(Jan 10 2022 at 05:07)</a>:</h4>
<p>the bitmasks make sense, but I'm not sure why <code>horizontal_min</code> would be any different</p>



<a name="267396455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267396455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267396455">(Jan 10 2022 at 05:07)</a>:</h4>
<p>could that perhaps just be noise in the benchmark?</p>



<a name="267397169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267397169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267397169">(Jan 10 2022 at 05:23)</a>:</h4>
<p>after quickly scanning the code i only noticed 1 thing that looked weird, i left a comment on the PR</p>



<a name="267397214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267397214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267397214">(Jan 10 2022 at 05:24)</a>:</h4>
<p>(other than the stuff already covered in this thread, of course)</p>



<a name="267397467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267397467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267397467">(Jan 10 2022 at 05:31)</a>:</h4>
<p>idea for faster <code>to_bitmask</code> than what <span class="user-mention" data-user-id="399416">@Jorge Leitao</span> has:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">to_bitmask</span><span class="p">(</span><span class="n">m</span>: <span class="nc">mask8x8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u8</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">m</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">Simd</span>::<span class="n">from_array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="p">,</span><span class="w"> </span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x80</span><span class="p">]),</span><span class="w"> </span><span class="n">Simd</span>::<span class="n">splat</span><span class="p">(</span><span class="mi">0</span><span class="p">)).</span><span class="n">horizontal_or</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="267397518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267397518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267397518">(Jan 10 2022 at 05:32)</a>:</h4>
<p>tho it may generate the same assembly after all...</p>



<a name="267397938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267397938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267397938">(Jan 10 2022 at 05:42)</a>:</h4>
<p>apparently <code>horizontal_sum</code> is better on x86: <a href="https://rust.godbolt.org/z/75q1Yx3ba">https://rust.godbolt.org/z/75q1Yx3ba</a></p>



<a name="267399404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267399404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267399404">(Jan 10 2022 at 06:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/mask.20to.20u8/near/267396455">said</a>:</p>
<blockquote>
<p>could that perhaps just be noise in the benchmark?</p>
</blockquote>
<p>fwiw, I do not think it is noise in the bench. I can reproduce it systematically. There is something else going on as +25% is significant. Also, note that this is for f32; I will try to get an i32 bench, to see if there is any difference</p>



<a name="267400209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267400209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267400209">(Jan 10 2022 at 06:32)</a>:</h4>
<p>here's the <code>from/to_bitmask</code> implemented in terms of the rustc intrinsics, <span class="user-mention" data-user-id="399416">@Jorge Leitao</span> would you mind trying them out? <a href="https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2021&amp;gist=4b915815a3db64f49721f1979fff1c17">https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2021&amp;gist=4b915815a3db64f49721f1979fff1c17</a></p>



<a name="267400239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267400239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267400239">(Jan 10 2022 at 06:33)</a>:</h4>
<p>they should work with miri and be cross-platform (they're what portable-simd calls internally)</p>



<a name="267400466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267400466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267400466">(Jan 10 2022 at 06:38)</a>:</h4>
<p>Note that the 25% is on an horizontal min, which does not use the from/to_bitmask. The bitmask issue is +900%. For the bitmask issue, we need an implementation for <code>Mask&lt;T, 8&gt;</code> for <code>T: i8...i64,u8..u64,f32,f64</code> (which is a pain to write by hand, right?)</p>



<a name="267400537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267400537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267400537">(Jan 10 2022 at 06:40)</a>:</h4>
<p>portable-simd's <code>Mask&lt;T, N&gt;</code> should convert to all other <code>Mask&lt;U, N&gt;</code> using <code>into</code>, iirc</p>



<a name="267400552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267400552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267400552">(Jan 10 2022 at 06:40)</a>:</h4>
<p>llvm should be able to trivially optimize that out</p>



<a name="267400570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267400570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267400570">(Jan 10 2022 at 06:41)</a>:</h4>
<p>I will try to come up with a minimal example that reproduces the issue, so that we can get away from arrow2's code and just work our way out directly from std.</p>



<a name="267470525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267470525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267470525">(Jan 10 2022 at 17:23)</a>:</h4>
<p>for floats horizontal_min (min/max in any capacity, really) would be expected to be slower, sadly, due to our IEEE754-compatible handling of edge cases (NaN/-0), which requires a few more instructions. I've seen a ~1.5x slowdown from this, sadly, but it depends how critical it is to your loop ofc.</p>



<a name="267471422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267471422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267471422">(Jan 10 2022 at 17:30)</a>:</h4>
<p>(which is enough that I'll end up keeping separate x86 and std::simd routes for cases where I know it can't impact the output that use those operations heavily.... Thankfully, it should only be that way for float simd. Unfortunately, the most obvious fix, assume some kind of eventual "allow incorrect math optimizations" (a la -ffast-math) feature solves it, is tricky, as it would likely require some equivalent to the "finite math only" fast math flag, which is the... dangerous one, which we'll quite possibly never get stably)</p>



<a name="267472365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267472365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267472365">(Jan 10 2022 at 17:37)</a>:</h4>
<p>x86 also has different min/max behavior than ieee for signed zeros</p>



<a name="267473164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267473164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267473164">(Jan 10 2022 at 17:42)</a>:</h4>
<p>yeah</p>



<a name="267473274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267473274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267473274">(Jan 10 2022 at 17:43)</a>:</h4>
<p>wait, packed_simd is not compatible with IEEE754??</p>



<a name="267473522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267473522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267473522">(Jan 10 2022 at 17:45)</a>:</h4>
<p>x86 min/max with portable_simd: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2021&amp;gist=3978cd74b4ec1200bd3e69a8b2f3a35f">https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2021&amp;gist=3978cd74b4ec1200bd3e69a8b2f3a35f</a></p>



<a name="267473672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267473672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267473672">(Jan 10 2022 at 17:46)</a>:</h4>
<p>i'd expect packed_simd is ieee compatible for most ops, just not min/max cuz they're slower on x86</p>



<a name="267473701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267473701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267473701">(Jan 10 2022 at 17:46)</a>:</h4>
<p>tho i haven't checked for sure</p>



<a name="267473924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267473924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267473924">(Jan 10 2022 at 17:48)</a>:</h4>
<p>Maybe I'm wrong, but I'd expect packed_simd to use the same intrinsic as std::simd?</p>



<a name="267474144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267474144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267474144">(Jan 10 2022 at 17:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/257879-project-portable-simd/topic/mask.20to.20u8/near/267473672">said</a>:</p>
<blockquote>
<p>i'd expect packed_simd is ieee compatible for most ops, just not min/max cuz they're slower on x86</p>
</blockquote>
<p>sorry, yes, I meant for min/max</p>



<a name="267474968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267474968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267474968">(Jan 10 2022 at 17:55)</a>:</h4>
<p>ah, yeah, packed_simd seems to just call the rustc intrinsic...</p>



<a name="267475084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267475084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267475084">(Jan 10 2022 at 17:55)</a>:</h4>
<p>portable_simd tries to do ieee-compatible min/max, but misses signed zeros</p>



<a name="267477390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267477390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267477390">(Jan 10 2022 at 18:09)</a>:</h4>
<p>actually, they use minnum/maxnum which explicitly doesn't specify which signed zero is chosen, so portable-simd and packed_simd are ieee compatible</p>



<a name="267477509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267477509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267477509">(Jan 10 2022 at 18:10)</a>:</h4>
<p>i was thinking of minimum/maximum which specify <code>-0.0 &lt; 0.0</code></p>



<a name="267513648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267513648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267513648">(Jan 10 2022 at 22:56)</a>:</h4>
<p>comparing packed_simd to std::simd, both simply call the <code>simd_reduce_{min,max}</code> intrinsics, so I don't see any good reason why performance would change by 25%</p>



<a name="267513681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267513681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267513681">(Jan 10 2022 at 22:56)</a>:</h4>
<p>if it were an inlining issue, I'd expect the performance difference to be much more dramatic than that, so I expect them to be identical</p>



<a name="267513712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267513712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267513712">(Jan 10 2022 at 22:57)</a>:</h4>
<p>which is why i'm inclined towards it being a problem with the benchmark itself</p>



<a name="267906987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267906987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267906987">(Jan 13 2022 at 18:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/mask.20to.20u8/near/267513712">said</a>:</p>
<blockquote>
<p>which is why i'm inclined towards it being a problem with the benchmark itself</p>
</blockquote>
<p>I was able to reproduce it on a small setup and continue to see difference in perf:</p>
<div class="codehilite"><pre><span></span><code>core_simd_min 2^20 f32     [286.86 us 289.22 us 292.03 us]
packed_simd_min 2^20 f32   [230.50 us 234.12 us 238.86 us]
nonsimd_min 2^20 f32       [245.75 us 249.19 us 254.00 us]
naive_min 2^20 f32         [2.8560 ms 2.8721 ms 2.8885 ms]
</code></pre></div>
<p>i.e. it is faster to _not_ use std::simd than using std::simd atm. Code here: <a href="https://github.com/DataEngineeringLabs/simd-benches">https://github.com/DataEngineeringLabs/simd-benches</a> with the implementation of each of the functions here: <a href="https://github.com/DataEngineeringLabs/simd-benches/blob/main/src/min.rs#L12">https://github.com/DataEngineeringLabs/simd-benches/blob/main/src/min.rs#L12</a></p>



<a name="267909408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267909408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267909408">(Jan 13 2022 at 18:19)</a>:</h4>
<p>Okay, that's what I suspected, the difference here is certainly not on the horizontal minimum, but on the lanewise minimum</p>



<a name="267909582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267909582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267909582">(Jan 13 2022 at 18:20)</a>:</h4>
<p>The horizontal minimum in std::simd and packed_simd are identical, but the lanewise minimum in packed_simd does not account for NANs, while std::simd's does</p>



<a name="267909694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267909694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267909694">(Jan 13 2022 at 18:21)</a>:</h4>
<p>ok, so the difference is expected because they have different semantics?</p>



<a name="267909766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267909766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267909766">(Jan 13 2022 at 18:22)</a>:</h4>
<p>I am surprised that the SIMD and scalar implementations are nearly identical, but I suspect that's because of autovectorization since you're using native target features</p>



<a name="267909786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267909786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267909786">(Jan 13 2022 at 18:22)</a>:</h4>
<p>Yeah, I think that's expected.</p>



<a name="267909849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267909849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267909849">(Jan 13 2022 at 18:23)</a>:</h4>
<p>On architectures that already account for NANs (avx512, I think?) I believe there would be no difference in performance</p>



<a name="267909878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267909878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267909878">(Jan 13 2022 at 18:23)</a>:</h4>
<p>(and if there is, that's a bug)</p>



<a name="267911819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267911819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267911819">(Jan 13 2022 at 18:39)</a>:</h4>
<p>those results were not on native; on native we have:</p>
<div class="codehilite"><pre><span></span><code>core_simd_min 2^20 f32     [376.98 us 378.40 us 379.72 us]
packed_simd_min 2^20 f32   [181.77 us 182.95 us 185.05 us]
nonsimd_min 2^20 f32       [185.89 us 186.35 us 186.83 us]
naive_min 2^20 f32         [2.0208 ms 2.0274 ms 2.0341 ms]
</code></pre></div>
<p>which is even worse (and the computer has avx512 (it is sky something (lane, line?)))</p>



<a name="267913226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267913226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267913226">(Jan 13 2022 at 18:51)</a>:</h4>
<p>That's definitely unexpected, I'll have to look at the assembly</p>



<a name="267914046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267914046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267914046">(Jan 13 2022 at 18:57)</a>:</h4>
<p>thanks! I filled it here <a href="https://github.com/rust-lang/portable-simd/issues/222">https://github.com/rust-lang/portable-simd/issues/222</a> so that I can track it on github</p>



<a name="267916803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267916803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267916803">(Jan 13 2022 at 19:16)</a>:</h4>
<p>avx512 doesn't change <code>vmaxps</code>'s behavior around nans/zeros, so it still follows pre-existing x86 behavior, not <code>maxnum</code>, <code>maximum</code>, or any other ieee max function.</p>



<a name="267917050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267917050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267917050">(Jan 13 2022 at 19:18)</a>:</h4>
<p>unless avx512 added some other new max/min instructions (i'm not aware of any), x86 doesn't have ieee-compliant min/max, so it always needs emulation</p>



<a name="267917271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267917271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267917271">(Jan 13 2022 at 19:20)</a>:</h4>
<p>it is still unexpected imo because the nonsimd_min uses native Rust (i.e. just core), which has the same semantics (and it is 2x faster)</p>



<a name="267917530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267917530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267917530">(Jan 13 2022 at 19:22)</a>:</h4>
<p>It's just an issue of poor optimization: <a href="https://rust.godbolt.org/z/eqc46ao68">https://rust.godbolt.org/z/eqc46ao68</a></p>



<a name="267917599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267917599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267917599">(Jan 13 2022 at 19:22)</a>:</h4>
<p>We don't use min/max intrinsics (yet) but I assume that would solve it</p>



<a name="267917840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267917840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267917840">(Jan 13 2022 at 19:24)</a>:</h4>
<p>all the <code>min</code>s: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2021&amp;gist=67838ab49be7b267d10f2bd48aaae596">https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2021&amp;gist=67838ab49be7b267d10f2bd48aaae596</a></p>



<a name="267917869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267917869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267917869">(Jan 13 2022 at 19:25)</a>:</h4>
<p>look at x86 assembly</p>



<a name="267917887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267917887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267917887">(Jan 13 2022 at 19:25)</a>:</h4>
<p>The scalar vectorizes well because llvm is pretty good at widening intrinsics</p>



<a name="267917925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267917925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267917925">(Jan 13 2022 at 19:25)</a>:</h4>
<p>When I get a chance, I'll add min/max intrinsics... and probably do ieee754-2018 rounding since I think that's generally desirable</p>



<a name="267918058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267918058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267918058">(Jan 13 2022 at 19:26)</a>:</h4>
<p>Wait--is that indicating that <code>simd_fmin</code> does check NANs?</p>



<a name="267918081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267918081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267918081">(Jan 13 2022 at 19:26)</a>:</h4>
<p>also cuz scalar min uses the same llvm intrinsic as the simd_min intrinsic provided by rustc (that std::simd doesn't use, but packed_simd does)</p>



<a name="267918138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267918138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267918138">(Jan 13 2022 at 19:27)</a>:</h4>
<blockquote>
<p>Wait--is that indicating that <code>simd_fmin</code> does check NANs?</p>
</blockquote>
<p>yes</p>



<a name="267918143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267918143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267918143">(Jan 13 2022 at 19:27)</a>:</h4>
<p>My understanding was that <code>simd_fmin</code> didn't check NANs, but now that I think about it, that likely refers back to when rustc was broken and applying fast-math to all intrinsics.</p>



<a name="267918249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267918249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267918249">(Jan 13 2022 at 19:28)</a>:</h4>
<p>It looks like we can trivially use the <code>simd_fmin</code> intrinsic now</p>



<a name="267918427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267918427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267918427">(Jan 13 2022 at 19:29)</a>:</h4>
<p>I'll draft that PR later, it shouldn't be a big deal at all.  I need to finish up the one for improving bitmasks too.</p>



<a name="267918492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267918492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267918492">(Jan 13 2022 at 19:30)</a>:</h4>
<p>oh, and really sorry for writing <code>horizontal_min</code>. I am implementing an horizontal min, but the API is <code>min</code> :/</p>



<a name="267918533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267918533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267918533">(Jan 13 2022 at 19:30)</a>:</h4>
<p>No problem, it's good to dig into everything to make sure we're actually implementing everything right</p>



<a name="267919156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267919156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267919156">(Jan 13 2022 at 19:35)</a>:</h4>
<p>I have also filled <a href="https://github.com/rust-lang/portable-simd/issues/223">https://github.com/rust-lang/portable-simd/issues/223</a> to see if it is possible to re-write from_bitmap/to_bitmap without const generics expr, so they are generally available in <code>std::simd</code></p>



<a name="267920273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267920273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267920273">(Jan 13 2022 at 19:44)</a>:</h4>
<p>i think you mean bitmask, not bitmap?</p>



<a name="267920509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/mask%20to%20u8/near/267920509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jorge Leitao <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/mask.20to.20u8.html#267920509">(Jan 13 2022 at 19:46)</a>:</h4>
<p><span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span>  sorry yes</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>