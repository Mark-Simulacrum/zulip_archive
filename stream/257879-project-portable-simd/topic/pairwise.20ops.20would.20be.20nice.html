<html>
<head><meta charset="utf-8"><title>pairwise ops would be nice Â· project-portable-simd Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html">pairwise ops would be nice</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269982375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/269982375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#269982375">(Jan 31 2022 at 05:39)</a>:</h4>
<p>Though speaking of horizontal ops: If Rust defaulted to pairwise summation for summing iterators of floating point numbers it would be both more accurate and also vectorizable.</p>



<a name="269997903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/269997903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#269997903">(Jan 31 2022 at 08:55)</a>:</h4>
<p>It'd be really nice if core could guarantee O(Îµâˆšn) accuracy from <code>Iterator::sum</code> on floats.</p>
<p>I tried to do compensated summation in <code>sum</code> a while back, hoping that SIMDing could recover the perf from the extra operations, but didn't manage to pull it off.  That was pre-<code>stdsimd</code>, though, so it might be easier now.</p>
<p>Though a huge part of the problem was that I couldn't find a way that optimized well to get 4-item chunks from iterators -- even slice iterators everything I tried went poorly.</p>



<a name="270043754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270043754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Goertzen <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270043754">(Jan 31 2022 at 14:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/horizontal.20traits/near/269972538">said</a>:</p>
<blockquote>
<p>Note that traits for <code>min</code> and <code>sqrt</code> and such would also be useful for generic scalar code, but <code>core</code> doesn't have them.  So it's not obvious to me that traits for horizontal stuff would be accepted.<br>
...</p>
</blockquote>
<p>Good point.  The <code>num_traits</code> crate has many of these traits already and might be a good place to add simd support.</p>



<a name="270050571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270050571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270050571">(Jan 31 2022 at 15:37)</a>:</h4>
<p>Compensated summation is probably overkill, pairwise summation is <code>O(log n)</code>.</p>



<a name="270062736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270062736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270062736">(Jan 31 2022 at 16:43)</a>:</h4>
<p>Like that may sound like a big error margin but also our current error is <code>O(n)</code> and pairwise sums is apparently a good enough default for Julia and NumPy. You know. The highly technical language and the numerical library.</p>



<a name="270067044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270067044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270067044">(Jan 31 2022 at 17:08)</a>:</h4>
<p>I have also generated a Bad Opinion on how we would make sure it would optimize well: <a href="https://twitter.com/workingjubilee/status/1488189719464669186">https://twitter.com/workingjubilee/status/1488189719464669186</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/workingjubilee/status/1488189719464669186"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/b918d32b7ab0e274b678c4f5dfa1cb06074b0d52/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313335393238383834383733323138303438342f52675f333955665f5f6e6f726d616c2e6a7067"></a><p>this would be trivial to implement if we had
*presses lips to the mic*
tail call optimization</p><span>- hyperðŸ’‰ðŸ’‰ðŸ’‰jubilee (@workingjubilee)</span></div></div>



<a name="270073836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270073836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270073836">(Jan 31 2022 at 17:48)</a>:</h4>
<p>its tricky to implement pairwise summation on top of the iterator trait, but we could specialize for slices and such a version that did this.</p>



<a name="270076200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270076200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270076200">(Jan 31 2022 at 18:02)</a>:</h4>
<p>Yeah, I don't think that belongs as part of iterators</p>



<a name="270076660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270076660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270076660">(Jan 31 2022 at 18:05)</a>:</h4>
<p>I think it would be nice if slice.iter().sum::&lt;f64&gt;() and the like used non-naive summation.</p>



<a name="270077200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270077200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270077200">(Jan 31 2022 at 18:08)</a>:</h4>
<p>but it's a bit odd, and i don't think it matters that much. even pairwise or kahan isnt what you want if you really care about accuracy (i think we have a decent sum implementation in libtest somewhere)</p>



<a name="270077233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270077233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270077233">(Jan 31 2022 at 18:08)</a>:</h4>
<p>this is out of scope for simd group probably.</p>



<a name="270077335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270077335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270077335">(Jan 31 2022 at 18:08)</a>:</h4>
<p>I tend to agree, there are probably dozens of implementations suitable for different tasks</p>



<a name="270077340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270077340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270077340">(Jan 31 2022 at 18:09)</a>:</h4>
<p>Well, mostly I brought it up because apparently packed_simd was intending to define horizontal ops as pairwise.</p>



<a name="270077406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270077406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270077406">(Jan 31 2022 at 18:09)</a>:</h4>
<p>( the term used was "tree-reduction". )</p>



<a name="270077460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270077460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270077460">(Jan 31 2022 at 18:09)</a>:</h4>
<p>( this means the same thing, just depending on whether or not your head is tilted sideways. )</p>



<a name="270077669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270077669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270077669">(Jan 31 2022 at 18:11)</a>:</h4>
<p>I _think_ the most suitable default is ordered such that it's equivalent to scalar implementations of any width, and anything that isn't sequential is useful for specific tasks where you're aware it's doing something slightly different</p>



<a name="270077751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270077751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270077751">(Jan 31 2022 at 18:11)</a>:</h4>
<p>well...the problem is not all hardware has reduction ops that are tree-wise reduction...so I think we should leave it as unspecified order</p>



<a name="270077862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270077862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270077862">(Jan 31 2022 at 18:12)</a>:</h4>
<p>Well right now all of our reductions are specified to be sequential, not unspecified</p>



<a name="270077928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270077928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270077928">(Jan 31 2022 at 18:12)</a>:</h4>
<p>I think unspecified order is probably also out of scope since it's really a subset of fast math</p>



<a name="270078153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078153">(Jan 31 2022 at 18:14)</a>:</h4>
<p>For horizontal_min and horizontal_max, though, it shouldn't matter, right?</p>



<a name="270078161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078161">(Jan 31 2022 at 18:14)</a>:</h4>
<p>well...sequential is kinda the worst choice...it has terrible numeric properties and often terrible hardware performance</p>



<a name="270078230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078230">(Jan 31 2022 at 18:14)</a>:</h4>
<p>it also doesn't matter for integer ops cuz those are associative</p>



<a name="270078285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078285">(Jan 31 2022 at 18:15)</a>:</h4>
<p>Right, we're only really talking about horizontal sum and product.</p>



<a name="270078288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078288">(Jan 31 2022 at 18:15)</a>:</h4>
<p>Sequential is chosen because it's the easiest to define and understand imo</p>



<a name="270078374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078374">(Jan 31 2022 at 18:15)</a>:</h4>
<p>SimpleV defines all reductions to be tree reductions</p>



<a name="270078391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078391">(Jan 31 2022 at 18:15)</a>:</h4>
<p>There's nothing preventing you from doing anything else, and I think a future fast math extension would help you get the best version for your hardware</p>



<a name="270078506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078506">(Jan 31 2022 at 18:16)</a>:</h4>
<p>It sucks tho'.<br>
Sequential summation will always yield less accurate results than pairwise and isn't necessarily appreciably faster.</p>



<a name="270078711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078711">(Jan 31 2022 at 18:17)</a>:</h4>
<p>In fact, I am pretty sure it's less fast on most arches.</p>



<a name="270078851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078851">(Jan 31 2022 at 18:18)</a>:</h4>
<p>A simple answer is that LLVM simply doesn't support it right now</p>



<a name="270078882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078882">(Jan 31 2022 at 18:18)</a>:</h4>
<p>It has sequential, and unspecified</p>



<a name="270078952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078952">(Jan 31 2022 at 18:19)</a>:</h4>
<p>Well yes, but that doesn't actually stop us from coding it to use the pairwise version.</p>



<a name="270078989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270078989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270078989">(Jan 31 2022 at 18:19)</a>:</h4>
<p>now that i look again...simplev also has sequential reduction, but it's likely quite slow</p>



<a name="270079034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270079034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270079034">(Jan 31 2022 at 18:19)</a>:</h4>
<p>It would be possible yeah, but you do potentially lose optimization opportunities.</p>



<a name="270079162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270079162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270079162">(Jan 31 2022 at 18:20)</a>:</h4>
<p>And by not using an intrinsic you also lose the ability to use a future fast math feature if that ever happens</p>



<a name="270079259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270079259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270079259">(Jan 31 2022 at 18:21)</a>:</h4>
<p>And maybe gain others? We could still use vector math.<br>
I recommend we despecify the horizontal ops order for the moment, not as a commitment to a particular ordering or even to a lack of ordering, but simply because we actually want to leave our options open.</p>



<a name="270079494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270079494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270079494">(Jan 31 2022 at 18:22)</a>:</h4>
<p>I think by definition of being "portable" it needs to be specified</p>



<a name="270079589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270079589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270079589">(Jan 31 2022 at 18:23)</a>:</h4>
<p>We discovered that rustc was emitting fast-math incorrectly precisely because we compared it to the equivalent scalar form</p>



<a name="270079603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270079603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270079603">(Jan 31 2022 at 18:23)</a>:</h4>
<p>Well yes, I am only saying that we should de-order it long enough to investigate what's actually best.</p>



<a name="270079702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270079702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270079702">(Jan 31 2022 at 18:23)</a>:</h4>
<p>I would argue that we leave it specified and since it's an unstable feature we can change it in the future</p>



<a name="270079798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270079798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270079798">(Jan 31 2022 at 18:24)</a>:</h4>
<p>...Fair!</p>



<a name="270079814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270079814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270079814">(Jan 31 2022 at 18:24)</a>:</h4>
<p>the tree-reduction algorithm SimpleV uses: <a href="https://libre-soc.org/openpower/sv/svp64/appendix/#index13h1">https://libre-soc.org/openpower/sv/svp64/appendix/#index13h1</a></p>



<a name="270079994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270079994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270079994">(Jan 31 2022 at 18:25)</a>:</h4>
<p>Not that I'm totally against all reduction algorithms, but with both avx and neon it makes very little difference if you do it sequentially or pairwise, and I'm not yet convinced that all architectures that do it pairwise do it the exact same way</p>



<a name="270080002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270080002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270080002">(Jan 31 2022 at 18:25)</a>:</h4>
<p>I think we should avoid specifying it for the horizontal ops. It shouldn't be wide enough to really matter.</p>



<a name="270080101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270080101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270080101">(Jan 31 2022 at 18:26)</a>:</h4>
<p>If it's not specified I don't think it meets the criteria of being portable.</p>



<a name="270080213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270080213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270080213">(Jan 31 2022 at 18:27)</a>:</h4>
<p>f32::sin isn't specified to the last bit, but most would agree it's portable</p>



<a name="270080271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270080271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270080271">(Jan 31 2022 at 18:27)</a>:</h4>
<p>what measure a <del>man</del> portable function?</p>



<a name="270081638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270081638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270081638">(Jan 31 2022 at 18:36)</a>:</h4>
<p>I don't think things need to be specified exactly to be portable enough for 99+% of use cases, if I'm being honest.</p>



<a name="270081989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270081989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270081989">(Jan 31 2022 at 18:39)</a>:</h4>
<p>If it's just about performance, I think that's what fast-math would be suitable for</p>



<a name="270082191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270082191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270082191">(Jan 31 2022 at 18:40)</a>:</h4>
<p>Fast math has no RFC for it or anyone working on it tho'.</p>



<a name="270082214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270082214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270082214">(Jan 31 2022 at 18:40)</a>:</h4>
<p>Otherwise if you absolutely need a specific portable order you're mostly out of luck, because that's somewhat nontrivial to implement</p>



<a name="270082291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270082291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270082291">(Jan 31 2022 at 18:40)</a>:</h4>
<p>I know I have suggested waiting for seemingly outlandish things landing but most had actually made it to an RFC proposal and something resembling a partial implementation drafted.</p>



<a name="270082524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270082524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270082524">(Jan 31 2022 at 18:42)</a>:</h4>
<p>I don't think this one is very crazy though, it may end up being an <code>unordered_horizontal_sum</code> for all we know, but I don't think having unordered sums is a critical feature of _portable_ simd</p>



<a name="270082577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270082577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270082577">(Jan 31 2022 at 18:42)</a>:</h4>
<p>ew.</p>



<a name="270082658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270082658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270082658">(Jan 31 2022 at 18:43)</a>:</h4>
<p>If you want any particular type of sum there's nothing preventing you from writing it</p>



<a name="270083237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270083237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270083237">(Jan 31 2022 at 18:46)</a>:</h4>
<p>tru</p>



<a name="270083312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270083312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270083312">(Jan 31 2022 at 18:47)</a>:</h4>
<p>I think we should still at least explore if we can persuade LLVM to <strong>consistently</strong> emit horizontal tree reductions.</p>



<a name="270083501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270083501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270083501">(Jan 31 2022 at 18:48)</a>:</h4>
<p>Yeah, we can definitely explore that, but before making it a default I think we need to at least prove that there isn't any loss of performance on any architectures</p>



<a name="270083594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270083594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270083594">(Jan 31 2022 at 18:49)</a>:</h4>
<p>sequentially ordered reduction is twice as many instructions on avx2 for <code>f32x8</code>: <a href="https://llvm.godbolt.org/z/dhbdoeq4d">https://llvm.godbolt.org/z/dhbdoeq4d</a></p>



<a name="270083662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270083662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270083662">(Jan 31 2022 at 18:49)</a>:</h4>
<p>(deleted)</p>



<a name="270083718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270083718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270083718">(Jan 31 2022 at 18:49)</a>:</h4>
<p>Ah.<br>
Oh I should note:<br>
The IEEE754 <code>sum</code> function is actually specified to allow reassociation.</p>



<a name="270084084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270084084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270084084">(Jan 31 2022 at 18:51)</a>:</h4>
<p>So that's part of why my stance has shifted so far towards allowing reassociation of any kind instead of purely sequential ordering on this one.<br>
<strong>Kahan wills it.</strong></p>



<a name="270084394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270084394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz GuzmÃ¡n Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270084394">(Jan 31 2022 at 18:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/horizontal.20traits/near/270062736">said</a>:</p>
<blockquote>
<p>Like that may sound like a big error margin but also our current error is <code>O(n)</code> and pairwise sums is apparently a good enough default for Julia and NumPy. You know. The highly technical language and the numerical library.</p>
</blockquote>
<p>So there is a long and <a href="https://discourse.julialang.org/t/accurate-summation-algorithm/7163/22">legendary Julia thread</a> about Kahan (pairwise) summation and SIMD vectorizability and its history.<br>
TL;DR - no one's yet found a way to make pairwise summation fast enough, if someone ever needs the implementation it's an easy import away.</p>



<a name="270084627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270084627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270084627">(Jan 31 2022 at 18:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="246783">Miguel Raz GuzmÃ¡n Macedo</span> <a href="#narrow/stream/257879-project-portable-simd/topic/horizontal.20traits/near/270084394">said</a>:</p>
<blockquote>
<p>TL;DR - no one's yet found a way to make pairwise summation fast enough, if someone ever needs the implementation it's an easy import away.</p>
</blockquote>
<p>Wait, pairwise summation ISN'T fast enough?</p>



<a name="270085016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270085016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz GuzmÃ¡n Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270085016">(Jan 31 2022 at 18:54)</a>:</h4>
<p>Ah derp, I mixed up the names. If pairwise isn't accurate enough, people can reach for the compensated/Kahan algorithm easily.<br>
Rarely do people need it, and we'd know about it.</p>



<a name="270085029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270085029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270085029">(Jan 31 2022 at 18:54)</a>:</h4>
<p>Ohhhh okay!</p>



<a name="270085039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270085039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270085039">(Jan 31 2022 at 18:54)</a>:</h4>
<p>I checked because I was curious, you're right that IEEE 754 doesn't specify any orders of reductions</p>



<a name="270085081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270085081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270085081">(Jan 31 2022 at 18:55)</a>:</h4>
<p>Yeah it specifically specifies pro-reassociation in the 2008 version.</p>



<a name="270085286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270085286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270085286">(Jan 31 2022 at 18:56)</a>:</h4>
<p>in the 2019 version, it doesn't specify reassociation or not for scaledProd (the closest thing it has to product)</p>



<a name="270085941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270085941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270085941">(Jan 31 2022 at 19:00)</a>:</h4>
<p>I've SIMDed first-order kahan summation before. I just did 4 streams at a time, and then summed them at the end (with scalar kahan summation). I think this might lose some benefits, but it was possible and fast.</p>
<p>That said, I agree that there's so many techniques here that I think doing more than pairwise would be a bit overkill.</p>



<a name="270086086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270086086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz GuzmÃ¡n Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270086086">(Jan 31 2022 at 19:01)</a>:</h4>
<p>I mean you can always implement the <a href="https://arxiv.org/abs/1505.05571">superaccumulators paper</a>.</p>



<a name="270086139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270086139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270086139">(Jan 31 2022 at 19:01)</a>:</h4>
<p>avx512f reduction: <a href="https://llvm.godbolt.org/z/bPjcfvor8">https://llvm.godbolt.org/z/bPjcfvor8</a> sequential reduction is like 4x as many instructions -- there's no way that's fast</p>



<a name="270086324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270086324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270086324">(Jan 31 2022 at 19:02)</a>:</h4>
<p>I personally think there is no good reason to go with any specific ordering that isn't sequential--it should either be sequential for repeatability or unspecified for performance, anything in between is probably based on the user's domain</p>



<a name="270086535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270086535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270086535">(Jan 31 2022 at 19:04)</a>:</h4>
<p>i'd argue we should have a specific tree reduction for repeatability...it should be waay faster than sequential and fast enough on all archs that have decent swizzles</p>



<a name="270087011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270087011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270087011">(Jan 31 2022 at 19:07)</a>:</h4>
<p>Yeah, I only mentioned tree reductions because they <strong>do</strong> have a precise order, but are directly in the hardware (or easy to emulate), <strong>and</strong> are reasonably fast.</p>



<a name="270087282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270087282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270087282">(Jan 31 2022 at 19:08)</a>:</h4>
<p>Take vectors, deinterleave, add.</p>



<a name="270088117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270088117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270088117">(Jan 31 2022 at 19:13)</a>:</h4>
<p>Better than fast math is having the same transformation that fast math emits without allowing it to do "whatever, lol".</p>



<a name="270088508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270088508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270088508">(Jan 31 2022 at 19:16)</a>:</h4>
<p>That said I agree with Caleb that if we can't actually improve perf while staying consistent, then F it.</p>



<a name="270088721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270088721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270088721">(Jan 31 2022 at 19:17)</a>:</h4>
<p>Ideally we would have some sample programs to bench on that does a bunch of transformations on input float data and then does huge piles of summations and products.</p>



<a name="270089060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270089060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270089060">(Jan 31 2022 at 19:19)</a>:</h4>
<p>Fortunately I think horizontal operations are typically not expected to be blazing fast so much as "not terrible"</p>



<a name="270089167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270089167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270089167">(Jan 31 2022 at 19:20)</a>:</h4>
<p>So we likely have some leeway over what makes the most sense overall</p>



<a name="270089850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270089850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270089850">(Jan 31 2022 at 19:24)</a>:</h4>
<p>Yeah, we're more trying to do "okay" with these.</p>



<a name="270090470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270090470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270090470">(Jan 31 2022 at 19:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/257879-project-portable-simd/topic/horizontal.20traits/near/270085941">said</a>:</p>
<blockquote>
<p>I've SIMDed first-order kahan summation before. I just did 4 streams at a time, and then summed them at the end (with scalar kahan summation). I think this might lose some benefits, but it was possible and fast.</p>
</blockquote>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=c808f151daf3fd73282b779a69a17f59">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=c808f151daf3fd73282b779a69a17f59</a> is essentially what I did. (I'm not saying we should use this for anything, but I was curious if I would hit any issues with using std::simd for it)</p>



<a name="270090583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270090583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270090583">(Jan 31 2022 at 19:29)</a>:</h4>
<p>Unless AVX512 changes things, the only good horizontal ops on x86 are for small integers, where they're used for video codecs and such.</p>



<a name="270090670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270090670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270090670">(Jan 31 2022 at 19:30)</a>:</h4>
<p>So yeah, the ones for floats just need to be "not worse than doing it manually"</p>



<a name="270090737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270090737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270090737">(Jan 31 2022 at 19:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/257879-project-portable-simd/topic/horizontal.20traits/near/270090583">said</a>:</p>
<blockquote>
<p>Unless AVX512 changes things, the only good horizontal ops on x86 are for small integers, where they're used for video codecs and such.</p>
</blockquote>
<p>Ah okay!</p>



<a name="270090902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270090902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270090902">(Jan 31 2022 at 19:31)</a>:</h4>
<p>Opened an issue: <a href="https://github.com/rust-lang/portable-simd/issues/235">https://github.com/rust-lang/portable-simd/issues/235</a></p>



<a name="270092553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270092553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270092553">(Jan 31 2022 at 19:42)</a>:</h4>
<p>I'm definitely a fan of pairwise -- I even added <a href="https://docs.rs/itertools/latest/itertools/trait.Itertools.html#method.tree_fold1">https://docs.rs/itertools/latest/itertools/trait.Itertools.html#method.tree_fold1</a> to have it for iterators.</p>
<p>I think <code>Iterator::sum</code> should do a good thing (at least better than linear) for the same reason that <code>.sort()</code> is stable.  We should give something without footguns, and people can write <code>.reduce(Add::add)</code> if they want the naÃ¯ve one.</p>



<a name="270093192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270093192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270093192">(Jan 31 2022 at 19:47)</a>:</h4>
<p>By the way, vectors right now don't even implement IntoIterator, so I doubt it's likely that someone will accidentally go through iterators. You'd have to pretty explicitly convert to a slice or array</p>



<a name="270315967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270315967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270315967">(Feb 02 2022 at 00:58)</a>:</h4>
<p><span class="user-mention" data-user-id="229517">@Jacob Lifshay</span> <br>
Looks like your architect intends to support both "orientations". ^^;</p>
<blockquote>
<p>Luke Kenneth Casson Leighton 2022-02-02 00:44:46 GMT</p>
<p>there is already a "reverse gear" bit in SVP64</p>
</blockquote>



<a name="270316564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270316564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270316564">(Feb 02 2022 at 01:04)</a>:</h4>
<p><a href="https://bugs.libre-soc.org/show_bug.cgi?id=697#c4">https://bugs.libre-soc.org/show_bug.cgi?id=697#c4</a></p>



<a name="270316669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270316669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270316669">(Feb 02 2022 at 01:04)</a>:</h4>
<p>that reverse bit is for starting from the end and going to the beginning of a vector iirc</p>



<a name="270316717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270316717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270316717">(Feb 02 2022 at 01:05)</a>:</h4>
<p>for things where order matters like scatter-store</p>



<a name="270316735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270316735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270316735">(Feb 02 2022 at 01:05)</a>:</h4>
<p>ahhh.</p>



<a name="270316850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270316850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270316850">(Feb 02 2022 at 01:06)</a>:</h4>
<p>I mean, arguably the operation is the same "reversed" in that sense, right? so the reverse gear bit could control that? or is it on a machine level and not per-instruction?</p>



<a name="270317017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270317017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270317017">(Feb 02 2022 at 01:08)</a>:</h4>
<p>it's per instruction...it could control tree-reduce order, but we'd need to define it to do that and add the extra hardware paths to support both kinds of tree reduce efficiently</p>



<a name="270317053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270317053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270317053">(Feb 02 2022 at 01:08)</a>:</h4>
<p>that's true.</p>



<a name="270318073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270318073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270318073">(Feb 02 2022 at 01:18)</a>:</h4>
<p>(also, Luke isn't the only architect, it's a joint effort)</p>



<a name="270318291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270318291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270318291">(Feb 02 2022 at 01:20)</a>:</h4>
<p>tru, I just figured "we already have that tho'." would have been decisive, but maybe not~</p>



<a name="270319021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270319021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270319021">(Feb 02 2022 at 01:27)</a>:</h4>
<p><a href="https://developer.arm.com/documentation/ddi0602/2021-09/SVE-Instructions/FADDV--Floating-point-add-recursive-reduction-to-scalar-?lang=en">https://developer.arm.com/documentation/ddi0602/2021-09/SVE-Instructions/FADDV--Floating-point-add-recursive-reduction-to-scalar-?lang=en</a> can't quite tell if this has the same reduction pattern as <a href="https://developer.arm.com/documentation/ddi0602/2021-09/SIMD-FP-Instructions/FADDP--vector---Floating-point-Add-Pairwise--vector--?lang=en">https://developer.arm.com/documentation/ddi0602/2021-09/SIMD-FP-Instructions/FADDP--vector---Floating-point-Add-Pairwise--vector--?lang=en</a> at a glance...</p>



<a name="270319158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270319158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270319158">(Feb 02 2022 at 01:28)</a>:</h4>
<p>it would be very annoying if the answer was "no lol"</p>



<a name="270319791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270319791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270319791">(Feb 02 2022 at 01:36)</a>:</h4>
<p>currently checking...arm's website is a pain</p>



<a name="270320472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270320472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270320472">(Feb 02 2022 at 01:43)</a>:</h4>
<p>arm's reduce pseudocode:</p>
<div class="codehilite"><pre><span></span><code>// Reduce()
// ========

bits(esize) Reduce(ReduceOp op, bits(N) input, integer esize)
    boolean altfp = HaveAltFP() &amp;&amp; !UsingAArch32() &amp;&amp; FPCR.AH == &#39;1&#39;;
    return Reduce(op, input, esize, altfp);

// Reduce()
// ========
// Perform the operation &#39;op&#39; on pairs of elements from the input vector,
// reducing the vector to a scalar result. The &#39;altfp&#39; argument controls
// alternative floating-point behaviour.

bits(esize) Reduce(ReduceOp op, bits(N) input, integer esize, boolean altfp)
    integer half;
    bits(esize) hi;
    bits(esize) lo;
    bits(esize) result;

    if N == esize then
        return input&lt;esize-1:0&gt;;

    half = N DIV 2;
    hi = Reduce(op, input&lt;N-1:half&gt;, esize, altfp);
    lo = Reduce(op, input&lt;half-1:0&gt;, esize, altfp);

    case op of
        when ReduceOp_FMINNUM
            result = FPMinNum(lo, hi, FPCR[]);
        when ReduceOp_FMAXNUM
            result = FPMaxNum(lo, hi, FPCR[]);
        when ReduceOp_FMIN
            result = FPMin(lo, hi, FPCR[], altfp);
        when ReduceOp_FMAX
            result = FPMax(lo, hi, FPCR[], altfp);
        when ReduceOp_FADD
            result = FPAdd(lo, hi, FPCR[]);
        when ReduceOp_ADD
            result = lo + hi;

    return result;
</code></pre></div>



<a name="270321073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270321073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270321073">(Feb 02 2022 at 01:50)</a>:</h4>
<p>addp just does one step of a reduction...addv does a full reduction</p>



<a name="270321096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270321096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270321096">(Feb 02 2022 at 01:51)</a>:</h4>
<p>afaict addp matches the first step of addv</p>



<a name="270321468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270321468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270321468">(Feb 02 2022 at 01:55)</a>:</h4>
<p>idk what arm's designers were thinking...that reduction algorithm sounds like hell to implement in hardware</p>



<a name="270322467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270322467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270322467">(Feb 02 2022 at 02:06)</a>:</h4>
<p>Ah okay~</p>



<a name="270327793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270327793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270327793">(Feb 02 2022 at 03:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice/near/270321468">said</a>:</p>
<blockquote>
<p>idk what arm's designers were thinking...that reduction algorithm sounds like hell to implement in hardware</p>
</blockquote>
<p>possibly "this seems like it would be most extensible to longer lane counts"?</p>



<a name="270328035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270328035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270328035">(Feb 02 2022 at 03:24)</a>:</h4>
<p>the algorithm i picked for SimpleV handles all vector sizes, including non-power-of-2, and always does transfers aligned to power-of-2 offsets, greatly improving efficiency and reducing the number of wires necessary to implement it and simplifying offset calculations in hardware</p>



<a name="270328272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270328272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270328272">(Feb 02 2022 at 03:28)</a>:</h4>
<p>it seems like they just picked a random divide-and-conquer algorithm and put in arm-specific stuff, giving no thought to the difficulty of hardware implementation</p>



<a name="270328281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270328281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270328281">(Feb 02 2022 at 03:28)</a>:</h4>
<p>Maybe it's a lie lol.</p>



<a name="270328308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270328308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270328308">(Feb 02 2022 at 03:29)</a>:</h4>
<p>maybe they just have whatever in their pseudo-code and have a more reasonable hw implementation</p>



<a name="270328309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270328309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270328309">(Feb 02 2022 at 03:29)</a>:</h4>
<p>Oh you know<br>
Arm is designing entirely for software cores anyways, right?</p>



<a name="270328341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270328341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270328341">(Feb 02 2022 at 03:29)</a>:</h4>
<p>Like I know they actually get materialized as hardware but I wonder if it's not obvious in their builds... and yeah that's what I mean by "Maybe it's a lie lol".</p>



<a name="270328403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270328403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270328403">(Feb 02 2022 at 03:30)</a>:</h4>
<p>well...if that's the best they can do, i feel sorry for their hw division</p>



<a name="270328492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270328492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270328492">(Feb 02 2022 at 03:32)</a>:</h4>
<p>How do they diverge on hmm say f32x12 vectors?</p>



<a name="270328510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270328510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270328510">(Feb 02 2022 at 03:32)</a>:</h4>
<p>lemme make a diagram...</p>



<a name="270328528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270328528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270328528">(Feb 02 2022 at 03:33)</a>:</h4>
<p>since as you mentioned the diagram seems to be identical for f32x8 vectors.</p>



<a name="270330368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270330368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270330368">(Feb 02 2022 at 03:59)</a>:</h4>
<p>diagrams showing why arm's algorithm is bad for hardware</p>
<div class="codehilite"><pre><span></span><code>@ is fadd.

arm reduce f32x12:

0  1  2  3  4  5  6  7  8  9 10 11
|  |  |  |  |  |  |  |  |  |  |  |
|  @--/  |  @--/  |  @--/  |  @--/ &lt;- nonuniform
|  |  .  |  |  .  |  |  .  |  |
@--/  .  @--/  .  @--/  .  @--/
|  .  .  |  .  .  |  .  .  |
@--------/  .  .  @--------/
|  .  .  .  .  .  |
@-----------------/
|

arm reduce f32x13 (notice the new element
effectively gets inserted in index 10):

0  1  2  3  4  5  6  7  8  9 10 11 12
|  |  |  |  |  |  |  |  |  |  |  |  |
|  @--/  |  @--/  |  @--/  @--/  @--/ &lt;- nonuniform
|  |  .  |  |  .  |  |  .  |  .  |
@--/  .  @--/  .  @--/  .  @-----/
|  .  .  |  .  .  |  .  .  |
@--------/  .  .  @--------/
|  .  .  .  .  .  |
@-----------------/
|

SimpleV original reduce f32x12:

0  1  2  3  4  5  6  7  8  9 10 11
|  |  |  |  |  |  |  |  |  |  |  |
@--/  @--/  @--/  @--/  @--/  @--/ &lt;- uniform
|  .  |  .  |  .  |  .  |  .  |
@-----/  .  @-----/  .  @-----/
|  .  .  .  |  .  .  .  |
@-----------/  .  .  .  |
|  .  .  .  .  .  .  .  |
@-----------------------/
|

SimpleV original reduce f32x13 (new element
is always at end):

0  1  2  3  4  5  6  7  8  9 10 11 12
|  |  |  |  |  |  |  |  |  |  |  |  |
@--/  @--/  @--/  @--/  @--/  @--/  | &lt;- uniform
|  .  |  .  |  .  |  .  |  .  |  .  |
@-----/  .  @-----/  .  @-----/  .  |
|  .  .  .  |  .  .  .  |  .  .  .  |
@-----------/  .  .  .  @-----------/
|  .  .  .  .  .  .  .  |
@-----------------------/
|
</code></pre></div>



<a name="270330892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270330892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270330892">(Feb 02 2022 at 04:05)</a>:</h4>
<p>Ahhh, I don't think the f32x13 case can happen on Arm, can it?</p>



<a name="270330988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270330988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270330988">(Feb 02 2022 at 04:06)</a>:</h4>
<p>maybe? they definitely have similar issues on other non-power-of-2 lengths tho</p>



<a name="270331043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270331043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270331043">(Feb 02 2022 at 04:07)</a>:</h4>
<p>(Nice to see that the SimpleV one is <em>exactly</em> the order I drew in ascii art for <a href="https://docs.rs/itertools/latest/itertools/trait.Itertools.html#method.tree_fold1">https://docs.rs/itertools/latest/itertools/trait.Itertools.html#method.tree_fold1</a> , albeit formatted slightly differently.)</p>



<a name="270333031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270333031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270333031">(Feb 02 2022 at 04:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice/near/270330988">said</a>:</p>
<blockquote>
<p>maybe? they definitely have similar issues on other non-power-of-2 lengths tho</p>
</blockquote>
<p>Oh yeah, I am just saying that unless the mask changes things a lot instead of just being "add zero" (which is what I thought it was?), Arm SVE goes 128 bits at a time, so Arm f32 vectors have a factor of 4 going on.</p>



<a name="270333134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270333134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270333134">(Feb 02 2022 at 04:40)</a>:</h4>
<p>arm sve can still have vector lengths of 128bits*5 iirc</p>



<a name="270333183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270333183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270333183">(Feb 02 2022 at 04:41)</a>:</h4>
<p>I think jubilee meant there is always a factor of 4 from the 128 itself</p>



<a name="270333210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270333210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270333210">(Feb 02 2022 at 04:42)</a>:</h4>
<p>Yes, that's f32x(4 * 5).</p>



<a name="270334138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270334138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270334138">(Feb 02 2022 at 04:55)</a>:</h4>
<p>I wouldn't mind committing to the SimpleV pattern as it... obviously seems the most intuitive, given that both  Arm, SimpleV, and semi-random Rust programmers have come up with it? but it seems to optimize poorly for LLVM.</p>



<a name="270334384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270334384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270334384">(Feb 02 2022 at 04:58)</a>:</h4>
<p>maybe it's just the way I wrote it in that example that uses full-length vectors till the end, then takes the first element. llvm might do better if i rewrote it to delete unneeded elements</p>



<a name="270334439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270334439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270334439">(Feb 02 2022 at 04:59)</a>:</h4>
<p>Seems plausible. Probably generating a lot of dead weight for LLVM to try to peer through.<br>
It's a dragon, not a psychic, and it's a Western one so it probably doesn't have the ability to magically disperse fog.</p>



<a name="270337025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270337025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270337025">(Feb 02 2022 at 05:35)</a>:</h4>
<p>A fun fact about the SimpleV one: on item <code>i</code>, you call <code>f</code> exactly <code>i.trailing_ones()</code> times (except at the end when you need to collapse the remaining intermediaries).</p>



<a name="270338993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270338993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270338993">(Feb 02 2022 at 06:01)</a>:</h4>
<p>well, llvm isn't better on non-full-length vectors: <a href="https://rust.godbolt.org/z/fxYE3Yvzb">https://rust.godbolt.org/z/fxYE3Yvzb</a></p>



<a name="270339718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270339718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270339718">(Feb 02 2022 at 06:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice/near/270338993">said</a>:</p>
<blockquote>
<p>well, llvm isn't better on non-full-length vectors: <a href="https://rust.godbolt.org/z/fxYE3Yvzb">https://rust.godbolt.org/z/fxYE3Yvzb</a></p>
</blockquote>
<p>Ah, but that  is a much better optimization of the SimpleV pattern it seems.</p>



<a name="270339776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270339776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270339776">(Feb 02 2022 at 06:14)</a>:</h4>
<p>unless I am misreading?</p>



<a name="270340564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270340564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270340564">(Feb 02 2022 at 06:27)</a>:</h4>
<p>iirc it was shorter with full vectors on x86 and maybe arm</p>



<a name="270340584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270340584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270340584">(Feb 02 2022 at 06:27)</a>:</h4>
<p>shortening vector version of reduce with vector length 13 (and a few others): <a href="https://rust.godbolt.org/z/c51de7Gcq">https://rust.godbolt.org/z/c51de7Gcq</a></p>



<a name="270340669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270340669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270340669">(Feb 02 2022 at 06:29)</a>:</h4>
<p>when you reach for intrinsics cuz portable-simd doesn't let you do what you want :P</p>



<a name="270342920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/270342920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#270342920">(Feb 02 2022 at 07:07)</a>:</h4>
<p>It'd be nice if <code>.reduce.fadd</code> accepted a "tree" argument where "reassoc" goes.</p>



<a name="271018346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271018346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jed <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271018346">(Feb 07 2022 at 18:05)</a>:</h4>
<p>Just catching up, is the rationale for pairwise to have an algorithm for which bitwise results do not depend on optimization level or architecture? Because using several accumulators (native register length or small multiple) is faster and more accurate than sequential summation (and you get it automatically with <code>reassoc</code>). And working in blocks, you can be equivalent to pairwise summation modulo a permutation of the array entries.</p>



<a name="271018728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271018728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271018728">(Feb 07 2022 at 18:07)</a>:</h4>
<p>It's one of the considerations. Right now we use pretty much the worst case scenario (sequential).  I'm not sure we're necessarily leaning in any direction regarding if it needs to be identical on every architecture</p>



<a name="271018919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271018919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271018919">(Feb 07 2022 at 18:08)</a>:</h4>
<p>My understanding is that accumulators also are more pessimistic in performance on small reductions, as opposed to what is sometimes a built-in hardware operation. Am I wrong?</p>



<a name="271019607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271019607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jed <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271019607">(Feb 07 2022 at 18:13)</a>:</h4>
<p>Like if you have length 7, would it be optimized with <code>vhaddpd</code>? IIRC, the optimizer does a fine job with that if you allow <code>reassoc</code>. If you don't, then it'll depend on whether the associativity you choose maps to hardware.</p>



<a name="271019692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271019692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271019692">(Feb 07 2022 at 18:13)</a>:</h4>
<p>Ah, yes, our problem is we don't fully trust the LLVM optimizer. :^)</p>



<a name="271019761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271019761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jed <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271019761">(Feb 07 2022 at 18:14)</a>:</h4>
<p>Note that vhaddpd is latency 6/2 cycles-per-instruction on Icelake, while <code>vaddpd</code> is latency 4, 0.5 CPI.</p>



<a name="271019798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271019798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271019798">(Feb 07 2022 at 18:14)</a>:</h4>
<p><em>nods</em></p>



<a name="271019936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271019936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271019936">(Feb 07 2022 at 18:15)</a>:</h4>
<p>Yeah there might be more instructions but if LLVM is smart enough to remove data dependencies it can get more instructions per cycle</p>



<a name="271020131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271020131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jed <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271020131">(Feb 07 2022 at 18:17)</a>:</h4>
<p>Heh, that's fair. My experience has been that <code>#pragma omd simd reduce(+:sum)</code> or otherwise enabling <code>reassoc</code> (with C or Rust) gives good code on all architectures I've tested. It's more accurate than sequential summation, and good enough for my applications. It's not bitwise stable between platforms/optimization levels.</p>



<a name="271020279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271020279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271020279">(Feb 07 2022 at 18:18)</a>:</h4>
<p>Jubilee mentioned that IEEE specifies order to not matter so I'm personally leaning towards <code>reassoc</code> now</p>



<a name="271020341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271020341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271020341">(Feb 07 2022 at 18:18)</a>:</h4>
<p>If we do, we should remove the <code>horizontal</code> specifier, IMO.</p>



<a name="271020400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271020400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271020400">(Feb 07 2022 at 18:19)</a>:</h4>
<p>For yes just sum and product.</p>



<a name="271020434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271020434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271020434">(Feb 07 2022 at 18:19)</a>:</h4>
<p>That's an option, though potentially inconsistent with other names</p>



<a name="271021210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271021210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271021210">(Feb 07 2022 at 18:25)</a>:</h4>
<p>I have heard a concern that <code>reassoc</code> may allow other reassociations as well, not just in that intrinsic.</p>



<a name="271021505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271021505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271021505">(Feb 07 2022 at 18:27)</a>:</h4>
<p>If all it does is change input order I think that's allowable</p>



<a name="271024998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271024998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271024998">(Feb 07 2022 at 18:52)</a>:</h4>
<p>I think things with reassoc can be reassociated with other things with reassoc, rather than strictly allowing it to reassociate the operations within the single instruction. If it goes across expressions, I think it could in principal break stuff like kahan sum-likes, dekker's multiplication, etc (admittedly it's not 100% clear how you would build these out of <code>horizontal_sum</code>s)</p>
<p>it is possible that I am misreading <a href="https://llvm.org/docs/LangRef.html">https://llvm.org/docs/LangRef.html</a> though.</p>



<a name="271027126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271027126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271027126">(Feb 07 2022 at 19:06)</a>:</h4>
<p>Yeah, I am wary of bugs in LLVM at the very least around this that accidentally "promote" reassoc across everything in the context when running some specific opt pass.</p>
<p>I am still somewhat in favor of the tree reduction because it does have a specific semantics, and while it's true "whether or not it optimizes depends on whether the associativity maps to hardware", it appears to be relatively trivial to design one that does.</p>



<a name="271027205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271027205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271027205">(Feb 07 2022 at 19:07)</a>:</h4>
<p>At least, trivial compared to some of the other hills we have had to walk up both ways.</p>



<a name="271073695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271073695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271073695">(Feb 08 2022 at 02:41)</a>:</h4>
<p>Ahhhh I just realized what uses <code>horizontal_sum</code> all day.<br>
Matrix multiplication.</p>



<a name="271074037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271074037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271074037">(Feb 08 2022 at 02:46)</a>:</h4>
<p>typically you would permute the values in such a way that you don't do any horizontal reductions</p>



<a name="271074736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271074736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271074736">(Feb 08 2022 at 02:57)</a>:</h4>
<p>Typically!</p>



<a name="271082516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271082516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jed <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271082516">(Feb 08 2022 at 05:20)</a>:</h4>
<p>Yeah, for matrix-matrix multiplication, you're normally doing outer products with several packed registers of accumulators. <a href="/user_uploads/4715/PhSiub87k1u59WvigWiNqYAz/image.png">image.png</a> <br>
<a href="https://www.cs.utexas.edu/users/flame/pubs/TOMS-BLIS-Analytical.pdf">https://www.cs.utexas.edu/users/flame/pubs/TOMS-BLIS-Analytical.pdf</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/PhSiub87k1u59WvigWiNqYAz/image.png" title="image.png"><img src="/user_uploads/4715/PhSiub87k1u59WvigWiNqYAz/image.png"></a></div>



<a name="271082558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271082558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jed <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271082558">(Feb 08 2022 at 05:21)</a>:</h4>
<p><a href="/user_uploads/4715/dpGf3v5ZZVO5yps1ufdJ0Dxq/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/dpGf3v5ZZVO5yps1ufdJ0Dxq/image.png" title="image.png"><img src="/user_uploads/4715/dpGf3v5ZZVO5yps1ufdJ0Dxq/image.png"></a></div>



<a name="271083825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271083825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271083825">(Feb 08 2022 at 05:43)</a>:</h4>
<p>hmm, what sizes of matrices are those?</p>



<a name="271083910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271083910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271083910">(Feb 08 2022 at 05:45)</a>:</h4>
<p>from the way it worries about the cache hierarchy, i'd assume hundreds or more of rows and columns</p>



<a name="271084370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271084370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271084370">(Feb 08 2022 at 05:52)</a>:</h4>
<p>mmm, even if you maxed out the theoretical len for SVE2 it caps at f32x64</p>



<a name="271084412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271084412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271084412">(Feb 08 2022 at 05:53)</a>:</h4>
<p>I am thinking more "so small that we're hitting diminishing returns on chopping things up into submatrices."</p>



<a name="271084497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271084497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271084497">(Feb 08 2022 at 05:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="322310">Jed</span> <a href="#narrow/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice/near/271020131">said</a>:</p>
<blockquote>
<p>Heh, that's fair. My experience has been that <code>#pragma omd simd reduce(+:sum)</code> or otherwise enabling <code>reassoc</code> (with C or Rust) gives good code on all architectures I've tested. It's more accurate than sequential summation, and good enough for my applications. It's not bitwise stable between platforms/optimization levels.</p>
</blockquote>
<p>so here's a question: what lengths are you talking about here?</p>



<a name="271085022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271085022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271085022">(Feb 08 2022 at 06:03)</a>:</h4>
<p>Well that makes me think of something, an obvious benefit to using <code>reassoc</code> instead of specifying an order is if your vector is say 4x the native width it can simply do 4 adds and then only 1 shuffling reduction</p>



<a name="271085467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271085467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271085467">(Feb 08 2022 at 06:11)</a>:</h4>
<p>well, it can do that anyway with the reduction tree I proposed, because the part of the tree that operates on offsets &gt;= native vector size turns into native vector size adds anyway</p>



<a name="271086106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271086106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271086106">(Feb 08 2022 at 06:22)</a>:</h4>
<p>example with a bunch of <code>vaddps</code> before the shuffles: <a href="https://rust.godbolt.org/z/zavn8x3xe">https://rust.godbolt.org/z/zavn8x3xe</a></p>



<a name="271091149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271091149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271091149">(Feb 08 2022 at 07:46)</a>:</h4>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nl">example:</span><span class="err">:</span><span class="nl">tree_reduce_16:</span><span class="w"></span>
<span class="w">        </span><span class="nf">vmovaps</span><span class="w"> </span><span class="no">ymm0</span><span class="p">,</span><span class="w"> </span><span class="no">ymmword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nf">vaddps</span><span class="w">  </span><span class="no">ymm0</span><span class="p">,</span><span class="w"> </span><span class="no">ymm0</span><span class="p">,</span><span class="w"> </span><span class="no">ymmword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nf">vextractf128</span><span class="w">    </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">ymm0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="nf">vaddps</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">vpermilpd</span><span class="w">       </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="nf">vaddps</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">vmovshdup</span><span class="w">       </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">xmm0</span><span class="w"></span>
<span class="w">        </span><span class="nf">vaddss</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">vzeroupper</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>

<span class="nl">unordered:</span><span class="w">                              </span><span class="c1"># @unordered</span>
<span class="w">        </span><span class="nf">vextractf64x4</span><span class="w">   </span><span class="no">ymm1</span><span class="p">,</span><span class="w"> </span><span class="no">zmm0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="nf">vaddps</span><span class="w">  </span><span class="no">zmm0</span><span class="p">,</span><span class="w"> </span><span class="no">zmm0</span><span class="p">,</span><span class="w"> </span><span class="no">zmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">vextractf128</span><span class="w">    </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">ymm0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="nf">vaddps</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">vpermilpd</span><span class="w">       </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">           </span><span class="c1"># xmm1 = xmm0[1,0]</span>
<span class="w">        </span><span class="nf">vaddps</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">vmovshdup</span><span class="w">       </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">xmm0</span><span class="w">              </span><span class="c1"># xmm1 = xmm0[1,1,3,3]</span>
<span class="w">        </span><span class="nf">vaddss</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm1</span><span class="w"></span>
<span class="w">        </span><span class="nf">vzeroupper</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>
</code></pre></div>
<p>...lol the tree reduction is almost <strong>exactly</strong> the same as the unordered version.</p>



<a name="271091157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271091157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271091157">(Feb 08 2022 at 07:46)</a>:</h4>
<p>now that I look at it.</p>



<a name="271093262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271093262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271093262">(Feb 08 2022 at 08:13)</a>:</h4>
<p>This reminds me of the "implement pow by looking at the binary and squaring and multiplying" trick -- which IIRC is usually optimal, but not quite <em>always</em> optimal.</p>
<p>So maybe the <code>assoc</code> version just optimizes to the tree version usually, for the same reason.</p>



<a name="271094782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/271094782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#271094782">(Feb 08 2022 at 08:31)</a>:</h4>
<p>mhm</p>



<a name="276347793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276347793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276347793">(Mar 23 2022 at 15:10)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> lkcl asked me to ping you about this zulip topic, he has some comments: <a href="https://libre-soc.org/irclog/%23libre-soc.2022-03-23.log.html#t2022-03-23T12:01:04">https://libre-soc.org/irclog/%23libre-soc.2022-03-23.log.html#t2022-03-23T12:01:04</a></p>



<a name="276366035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276366035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276366035">(Mar 23 2022 at 16:57)</a>:</h4>
<p>huh.</p>



<a name="276397675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276397675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276397675">(Mar 23 2022 at 20:45)</a>:</h4>
<p>I am not sure what my takeaway should be.</p>



<a name="276397875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276397875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276397875">(Mar 23 2022 at 20:47)</a>:</h4>
<p>idk, it was mostly that he felt I had forgotten all about this topic but he wanted to continue the conversation...</p>



<a name="276398066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276398066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276398066">(Mar 23 2022 at 20:48)</a>:</h4>
<p>Looking back at this I feel like we should just use reassoc and let LLVM do whatever it feels like is optimal (and if it's not, fix that)</p>



<a name="276398367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276398367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276398367">(Mar 23 2022 at 20:51)</a>:</h4>
<p>imho we <em>need</em> something with reproducible results as an option, not just having the only option be llvm getting permission to mess up all the math however it likes</p>



<a name="276398648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276398648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276398648">(Mar 23 2022 at 20:53)</a>:</h4>
<p>otherwise inlining the same function in different places might cause llvm to have that function compute differing values</p>



<a name="276398822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276398822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276398822">(Mar 23 2022 at 20:54)</a>:</h4>
<p>I base that on the ieee spec (I think jubilee brought it up) which specifies order doesn't matter</p>



<a name="276398862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276398862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276398862">(Mar 23 2022 at 20:54)</a>:</h4>
<p>I think if we care about order for any reason then we should go so far as to order it sequentially as well</p>



<a name="276398893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276398893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276398893">(Mar 23 2022 at 20:54)</a>:</h4>
<p>(and provide both)</p>



<a name="276398971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276398971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276398971">(Mar 23 2022 at 20:55)</a>:</h4>
<p>If someone needs a particular consistent order that isn't sequential for whatever reason they can still write it with swizzle</p>



<a name="276399033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276399033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276399033">(Mar 23 2022 at 20:55)</a>:</h4>
<p>imho sequential is terrible...consistent results yes, but lets have consistent tree reduce as an option so we get consistent fast results</p>



<a name="276399307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276399307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276399307">(Mar 23 2022 at 20:57)</a>:</h4>
<p>My point is that there are potentially applications that care very strongly about the order, in which sequential matters. I'm having trouble thinking of an application that cares strongly about identical ordering on different architectures but doesn't care what that particular order is</p>



<a name="276399436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276399436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276399436">(Mar 23 2022 at 20:58)</a>:</h4>
<p>And if that application exists somewhere, they can implement their own very specific reduction</p>



<a name="276410326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276410326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276410326">(Mar 23 2022 at 22:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice/near/276399307">said</a>:</p>
<blockquote>
<p>I'm having trouble thinking of an application that cares strongly about identical ordering on different architectures but doesn't care what that particular order is</p>
</blockquote>
<p>Anything that needs reproducibility but doesn't really care about error, like an RTS game engine, probably falls under that.</p>



<a name="276411203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276411203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276411203">(Mar 23 2022 at 22:39)</a>:</h4>
<p>My concern is that it's based on a hypothetical application, in C++ it's been common to add something to the standard library only to deprecate it or make another variant of it because no real work application could actually make use of it due to incorrect assumptions</p>



<a name="276411551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276411551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276411551">(Mar 23 2022 at 22:41)</a>:</h4>
<p>In this case, I think reassoc has the least assumptions while being usable for most actual applications, and the remaining applications can build their own implementations with swizzle, and if one wins out it's a candidate to add to std</p>



<a name="276412746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276412746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276412746">(Mar 23 2022 at 22:54)</a>:</h4>
<p>but if we add a specific tree-reduce, then cpus such as libre-soc's can design their reduce to match, rather than leaving it up to every game programmer ever to come up with their own random reduction</p>



<a name="276412795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276412795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276412795">(Mar 23 2022 at 22:54)</a>:</h4>
<p>I think we should talk to LLVM about this.</p>



<a name="276412836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276412836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276412836">(Mar 23 2022 at 22:55)</a>:</h4>
<p>That would be nice, but I definitely don't have any delusions of grandeur that Intel is going to build the rust SIMD instruction set</p>



<a name="276412867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276412867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276412867">(Mar 23 2022 at 22:55)</a>:</h4>
<p>Yeah, I'd be curious if anyone from LLVM has any opinion</p>



<a name="276412920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276412920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276412920">(Mar 23 2022 at 22:56)</a>:</h4>
<p>if a particular tree-reduction is popular enough, intel may add it</p>



<a name="276412974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276412974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276412974">(Mar 23 2022 at 22:57)</a>:</h4>
<p>since they care about retaining gamers on their platform</p>



<a name="276413124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413124">(Mar 23 2022 at 22:58)</a>:</h4>
<p>So I think that's <strong>slightly</strong>... bluesky, but to be precise, I agree with Jacob that we should absolutely keep in mind programming languages can affect hardware.</p>



<a name="276413227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413227">(Mar 23 2022 at 22:59)</a>:</h4>
<p>I think IEEE not even committing to one is a good indication of who determines these things</p>



<a name="276413282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413282">(Mar 23 2022 at 23:00)</a>:</h4>
<p>yeaaah.</p>



<a name="276413310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413310">(Mar 23 2022 at 23:00)</a>:</h4>
<p>i think ieee cares about fast but not reproducible there...</p>



<a name="276413414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413414">(Mar 23 2022 at 23:01)</a>:</h4>
<p>Anyways, so, I think that basically, afaict<br>
"reassoc" is very close to "ordered tree reduce" on smaller vectors</p>



<a name="276413493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413493">(Mar 23 2022 at 23:01)</a>:</h4>
<p><span class="user-mention" data-user-id="132920">@gnzlbg</span> was counting on it being so, in fact, I think?</p>



<a name="276413525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413525">(Mar 23 2022 at 23:02)</a>:</h4>
<p>because until recently, x86-32 was popular enough that all your fp would give different results on different platforms so programmers assumed fp was non-reproducable in general</p>



<a name="276413634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413634">(Mar 23 2022 at 23:02)</a>:</h4>
<p>so it would be reasonable IMO to say, "hey, LLVM, can you canonize your existing behavior with a new tag?" and if they say yes, then basically everyone gets what they want.</p>



<a name="276413683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413683">(Mar 23 2022 at 23:03)</a>:</h4>
<p>I think that I agree somewhat with "we should be conservative about promises" though.</p>



<a name="276413684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413684">(Mar 23 2022 at 23:03)</a>:</h4>
<p>except llvm's behavior is different on different architectures</p>



<a name="276413702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413702">(Mar 23 2022 at 23:03)</a>:</h4>
<p>hmm.</p>



<a name="276413705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413705">(Mar 23 2022 at 23:03)</a>:</h4>
<p>Well, no, I'm still arguing I don't think we should commit to a particular ordering in std, until enough compelling real world uses come up</p>



<a name="276413726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413726">(Mar 23 2022 at 23:03)</a>:</h4>
<p>right.</p>



<a name="276413797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413797">(Mar 23 2022 at 23:04)</a>:</h4>
<p>I think we can be somewhat ambivalent towards ordering promises while still pursuing a stable one.</p>



<a name="276413814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413814">(Mar 23 2022 at 23:04)</a>:</h4>
<p>just a TODO: "make this a portable fast ordering? is that even possible?" thing.</p>



<a name="276413873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413873">(Mar 23 2022 at 23:05)</a>:</h4>
<p>The problem is all it takes is a single cpu to come out with an incompatible reduction and it's now pessimistic on that architecture</p>



<a name="276413883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413883">(Mar 23 2022 at 23:05)</a>:</h4>
<p>eh.</p>



<a name="276413912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413912">(Mar 23 2022 at 23:05)</a>:</h4>
<p>well...the earlier we decide, the more likely libre-soc won't pick something that doesn't match cuz we ran out of time and had to pick</p>



<a name="276413921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276413921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276413921">(Mar 23 2022 at 23:05)</a>:</h4>
<p>in practice these things tend to converge.</p>



<a name="276414077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414077">(Mar 23 2022 at 23:07)</a>:</h4>
<p>As much as I'm sympathetic to that, I'm not about to commit to an ordering strictly that libre soc picks the matching one, because we absolutely would retain the right to change that ordering at any point until the function is stable</p>



<a name="276414146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414146">(Mar 23 2022 at 23:07)</a>:</h4>
<p>maybe pick the arm sve2 order (much as i dislike it -- it's pretty terrible) since it's already out and specified?</p>



<a name="276414154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414154">(Mar 23 2022 at 23:07)</a>:</h4>
<p>I think that alone shows that it would be very easy for someone to come up with an ordering that doesn't match ours</p>



<a name="276414217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414217">(Mar 23 2022 at 23:08)</a>:</h4>
<p>If libresoc could do it, someone who isn't concerned at all with the rust project easily could</p>



<a name="276414229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414229">(Mar 23 2022 at 23:08)</a>:</h4>
<p>iirc risc-v doesn't specify</p>



<a name="276414252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414252">(Mar 23 2022 at 23:08)</a>:</h4>
<p>I thought they specified linear.</p>



<a name="276414307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414307">(Mar 23 2022 at 23:09)</a>:</h4>
<p>that's for the ordered one, which we all agree is slow and terrible...hence the need for tree-reduce</p>



<a name="276414323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414323">(Mar 23 2022 at 23:09)</a>:</h4>
<p>iirc riscv has 2 different reduce instructions, ordered and unordered</p>



<a name="276414355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414355">(Mar 23 2022 at 23:09)</a>:</h4>
<p>Fwiw I have worked on software that requires sequential reductions, never personally on anything that requires a particular tree reduction</p>



<a name="276414500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414500">(Mar 23 2022 at 23:11)</a>:</h4>
<p>i've written a physics engine...and i'm planning on writing a 100% reproducible physics engine</p>



<a name="276414606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414606">(Mar 23 2022 at 23:12)</a>:</h4>
<p>those (assuming they are explicitly simd-ified and optimized) would want tree-reductions since serial reductions are soo slow</p>



<a name="276414639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414639">(Mar 23 2022 at 23:13)</a>:</h4>
<p>Note I'm not suggesting sequential needs to be in std either, my point is that different software will have different requirements</p>



<a name="276414653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414653">(Mar 23 2022 at 23:13)</a>:</h4>
<p>reproducible is needed for consistency across networked computers</p>



<a name="276414795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414795">(Mar 23 2022 at 23:14)</a>:</h4>
<p>i agree different sw has different requirements, hence why i'm saying we should provide 3 reduce algorithms: serial, fast, and fast-enough-but-reproducible (specific tree reduce)</p>



<a name="276414946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276414946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276414946">(Mar 23 2022 at 23:16)</a>:</h4>
<p><code>reduce_ordered_*</code>, <code>reduce_*</code>, and <code>reduce_tree_*</code></p>



<a name="276415039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276415039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276415039">(Mar 23 2022 at 23:17)</a>:</h4>
<p>that is a lot of methods.</p>



<a name="276415213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276415213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276415213">(Mar 23 2022 at 23:19)</a>:</h4>
<p>Yeah. If 90%+ of users are happy with just the unordered one, it's probably a net negative on the API to include the rest</p>



<a name="276415245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276415245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276415245">(Mar 23 2022 at 23:20)</a>:</h4>
<p>associative ops such as xor would only need 1 since all such reduce algorithms always give the same result</p>



<a name="276415295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276415295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276415295">(Mar 23 2022 at 23:20)</a>:</h4>
<p>And if something is repeatedly requested, of course it can be added</p>



<a name="276415368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276415368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276415368">(Mar 23 2022 at 23:21)</a>:</h4>
<p>imho the tree reduction is probably "you didn't know you needed it till you saw it" kind of thing</p>



<a name="276415403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276415403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276415403">(Mar 23 2022 at 23:21)</a>:</h4>
<p>instead doing reduction with scalar ops or something</p>



<a name="276415538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276415538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276415538">(Mar 23 2022 at 23:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice/near/276410326">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice/near/276399307">said</a>:</p>
<blockquote>
<p>I'm having trouble thinking of an application that cares strongly about identical ordering on different architectures but doesn't care what that particular order is</p>
</blockquote>
<p>Anything that needs reproducibility but doesn't really care about error, like an RTS game engine, probably falls under that.</p>
</blockquote>
<p>also in practice game engines do care about reproducibility.</p>



<a name="276415679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276415679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276415679">(Mar 23 2022 at 23:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice/near/276415538">said</a>:</p>
<blockquote>
<p>also in practice game engines do care about reproducibility.</p>
</blockquote>
<p>Uh, yes?  That's what I intended to say.</p>
<p>(They don't care about Â½ULP <em>accuracy</em>, just about <em>consistency</em>.)</p>



<a name="276415898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276415898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276415898">(Mar 23 2022 at 23:27)</a>:</h4>
<p>ah.</p>



<a name="276415908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/pairwise%20ops%20would%20be%20nice/near/276415908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/pairwise.20ops.20would.20be.20nice.html#276415908">(Mar 23 2022 at 23:27)</a>:</h4>
<p>whoops.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>