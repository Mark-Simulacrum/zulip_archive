<html>
<head><meta charset="utf-8"><title>Swizzle API · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html">Swizzle API</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253354188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253354188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253354188">(Sep 15 2021 at 02:37)</a>:</h4>
<p>I found a _very_ interesting hack that we can use to make a generic swizzle API.  The problem that we originally ran into is that you can't do something like this:</p>
<div class="codehilite"><pre><span></span><code>fn swizzle&lt;const LANES: usize, const INDICES: [usize; LANES]&gt;(self) -&gt; Simd&lt;T, LANES&gt; { ... }
</code></pre></div>
<p>There is something we can do that does work though <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>
<div class="codehilite"><pre><span></span><code>trait Swizzle&lt;const LANES: usize&gt; {
    const INDICES: [usize; LANES];
}
...
fn swizzle&lt;const LANES: usize&gt;(self, indices: impl Swizzle&lt;LANES&gt;) -&gt; Simd&lt;T, LANES&gt; { ... }
</code></pre></div>



<a name="253354300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253354300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253354300">(Sep 15 2021 at 02:39)</a>:</h4>
<p>Basically, impl trait tricks the type system into allowing a dependently-sized const array, because it's not technically in the list of generic types!</p>



<a name="253360954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253360954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253360954">(Sep 15 2021 at 04:32)</a>:</h4>
<p>well, I have an almost perfect api, but eek:</p>
<div class="codehilite"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;called `Result::unwrap()` on an `Err` value: InterpErrorInfo(InterpErrorInfoInner { kind: the type `[u32; OUTPUT_LANES]` has an unknown layout, backtrace: None })&#39;, compiler/rustc_const_eval/src/const_eval/mod.rs:146:41
</code></pre></div>



<a name="253361201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253361201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253361201">(Sep 15 2021 at 04:36)</a>:</h4>
<div class="codehilite"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;called `Result::unwrap()` on an `Err` value: InterpErrorInfo(InterpErrorInfoInner { kind: the type `[u32; OUTPUT_LANES]` has an unknown layout, backtrace: None })&#39;, compiler/rustc_const_eval/src/const_eval/mod.rs:146:41
stack backtrace:
   0: rust_begin_unwind
   1: core::panicking::panic_fmt
   2: core::result::unwrap_failed
   3: rustc_const_eval::const_eval::destructure_const
   4: core::ops::function::FnOnce::call_once
   5: rustc_middle::dep_graph::&lt;impl rustc_query_system::dep_graph::DepKind for rustc_middle::dep_graph::dep_node::DepKind&gt;::with_deps
   6: rustc_query_system::dep_graph::graph::DepGraph&lt;K&gt;::with_task_impl
   7: rustc_data_structures::stack::ensure_sufficient_stack
   8: rustc_query_system::query::plumbing::get_query_impl
   9: rustc_query_system::query::plumbing::get_query
  10: &lt;rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine&gt;::destructure_const
  11: rustc_codegen_ssa::mir::constant::&lt;impl rustc_codegen_ssa::mir::FunctionCx&lt;Bx&gt;&gt;::simd_shuffle_indices
  12: &lt;core::iter::adapters::map::Map&lt;I,F&gt; as core::iter::traits::iterator::Iterator&gt;::fold
  13: &lt;alloc::vec::Vec&lt;T&gt; as alloc::vec::spec_from_iter::SpecFromIter&lt;T,I&gt;&gt;::from_iter
  14: rustc_codegen_ssa::mir::block::&lt;impl rustc_codegen_ssa::mir::FunctionCx&lt;Bx&gt;&gt;::codegen_terminator
  15: rustc_codegen_ssa::mir::codegen_mir
  16: rustc_codegen_ssa::base::codegen_instance
  17: &lt;rustc_middle::mir::mono::MonoItem as rustc_codegen_ssa::mono_item::MonoItemExt&gt;::define
  18: rustc_codegen_llvm::base::compile_codegen_unit::module_codegen
  19: rustc_middle::dep_graph::&lt;impl rustc_query_system::dep_graph::DepKind for rustc_middle::dep_graph::dep_node::DepKind&gt;::with_deps
  20: rustc_query_system::dep_graph::graph::DepGraph&lt;K&gt;::with_task
  21: rustc_codegen_llvm::base::compile_codegen_unit
  22: rustc_codegen_ssa::base::codegen_crate
  23: &lt;rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_ssa::traits::backend::CodegenBackend&gt;::codegen_crate
  24: rustc_session::utils::&lt;impl rustc_session::session::Session&gt;::time
  25: rustc_interface::passes::start_codegen
  26: rustc_interface::passes::QueryContext::enter
  27: rustc_interface::queries::Query&lt;T&gt;::compute
  28: rustc_interface::queries::Queries::ongoing_codegen
  29: rustc_interface::queries::&lt;impl rustc_interface::interface::Compiler&gt;::enter
  30: rustc_span::with_source_map
  31: rustc_interface::interface::create_compiler_and_run
  32: scoped_tls::ScopedKey&lt;T&gt;::set
</code></pre></div>



<a name="253361329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253361329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253361329">(Sep 15 2021 at 04:39)</a>:</h4>
<p>The offending line: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_ssa/src/mir/constant.rs#L64">https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_ssa/src/mir/constant.rs#L64</a></p>



<a name="253361404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253361404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253361404">(Sep 15 2021 at 04:40)</a>:</h4>
<p>my understanding is that <code>reveal_all</code> should prevent problems like this, since we're already up to codegen at this point, so I'm guessing maybe it's not injecting the ParamEnv properly wherever it's computing the layout</p>



<a name="253362173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362173">(Sep 15 2021 at 04:54)</a>:</h4>
<p>do you have code for repro the ICE</p>



<a name="253362194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362194">(Sep 15 2021 at 04:55)</a>:</h4>
<p>it's on a branch of rustc that hasn't been merged into master (yet)</p>



<a name="253362291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362291">(Sep 15 2021 at 04:56)</a>:</h4>
<p>link? seems like it might be fun to poke at the ICE</p>



<a name="253362393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362393">(Sep 15 2021 at 04:58)</a>:</h4>
<p>The branch is in <a href="https://github.com/rust-lang/rust/issues/88855">#88855</a></p>



<a name="253362403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362403">(Sep 15 2021 at 04:58)</a>:</h4>
<p>I'll push the code that causes it momentarily</p>



<a name="253362474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362474">(Sep 15 2021 at 04:59)</a>:</h4>
<p>okay, it's in the <code>feature/swizzle</code> branch of portable-simd.  just run <code>cargo test</code> with the compiler from that PR</p>



<a name="253362560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362560">(Sep 15 2021 at 05:00)</a>:</h4>
<p>a shot in the dark, I think it's this line: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_const_eval/src/interpret/operand.rs#L593">https://github.com/rust-lang/rust/blob/master/compiler/rustc_const_eval/src/interpret/operand.rs#L593</a></p>



<a name="253362714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362714">(Sep 15 2021 at 05:02)</a>:</h4>
<p>which I followed down from this line: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_const_eval/src/const_eval/mod.rs#L146">https://github.com/rust-lang/rust/blob/master/compiler/rustc_const_eval/src/const_eval/mod.rs#L146</a></p>



<a name="253362724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362724">(Sep 15 2021 at 05:02)</a>:</h4>
<p>which I believe is the unwrap that's panicking</p>



<a name="253362761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362761">(Sep 15 2021 at 05:03)</a>:</h4>
<p>I don't know enough about how consts are handled, but since we're in codegen maybe we can say "since we're in codegen, just take the entire param env"</p>



<a name="253362776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362776">(Sep 15 2021 at 05:03)</a>:</h4>
<p>though maybe it's something more complicated than that</p>



<a name="253362851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253362851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253362851">(Sep 15 2021 at 05:04)</a>:</h4>
<p>honestly who knows compiles are magic <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="253363007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253363007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253363007">(Sep 15 2021 at 05:06)</a>:</h4>
<p>now that I think about it, one of the problems is that the intrinsic is effectively a generic, but nothing actually ties the const value to it like an actual generic</p>



<a name="253363033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253363033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253363033">(Sep 15 2021 at 05:07)</a>:</h4>
<p>(this is true for all of the intrinsics, but so far we've only passed in vectors, not plain arrays)</p>



<a name="253363733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253363733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253363733">(Sep 15 2021 at 05:17)</a>:</h4>
<p>damn your repo builds way faster than rustc</p>



<a name="253363771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253363771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253363771">(Sep 15 2021 at 05:17)</a>:</h4>
<p>that's for sure</p>



<a name="253368136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253368136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253368136">(Sep 15 2021 at 06:23)</a>:</h4>
<p>ay fixed the ICE <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="253368137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253368137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253368137">(Sep 15 2021 at 06:23)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_ssa/src/mir/block.rs#L669">https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_ssa/src/mir/block.rs#L669</a></p>



<a name="253368145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253368145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253368145">(Sep 15 2021 at 06:23)</a>:</h4>
<p>I think you need to monomorphize the constant.ty() here or inside <code>simd_shuffle_indices</code> or somewhere</p>



<a name="253368216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253368216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253368216">(Sep 15 2021 at 06:24)</a>:</h4>
<p>we try calculating the layout of something like <code>[u32; N]</code> (where the constant is generic)</p>



<a name="253368228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253368228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253368228">(Sep 15 2021 at 06:24)</a>:</h4>
<p>despite the fact that we're codegen'ing  something where <code>N</code> has substs of a concrete thing</p>



<a name="253368280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253368280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253368280">(Sep 15 2021 at 06:25)</a>:</h4>
<p>Im not familiar with this code though so I dont know if:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                               </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">llval</span><span class="p">,</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">simd_shuffle_indices</span><span class="p">(</span><span class="w"></span>
<span class="w">                                    </span><span class="o">&amp;</span><span class="n">bx</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">constant</span><span class="p">.</span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="bp">self</span><span class="p">.</span><span class="n">monomorphize</span><span class="p">(</span><span class="n">constant</span><span class="p">.</span><span class="n">ty</span><span class="p">()),</span><span class="w"></span>
<span class="w">                                    </span><span class="n">c</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>is a correct fix here but it does fix it locally</p>



<a name="253399840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253399840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253399840">(Sep 15 2021 at 11:46)</a>:</h4>
<p>Oh wow, that makes sense, thanks!</p>



<a name="253399864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253399864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253399864">(Sep 15 2021 at 11:47)</a>:</h4>
<p>I'll dig into it and try to figure out where the right spot is</p>



<a name="253517751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253517751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253517751">(Sep 16 2021 at 02:10)</a>:</h4>
<p>Okay, looking through elsewhere in the compiler, I think that's the proper place to monomorphize it</p>



<a name="253517801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253517801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253517801">(Sep 16 2021 at 02:11)</a>:</h4>
<p>Since my PR was already approved, is it a no-no to make more changes to it?  Or can it just be reapproved...</p>



<a name="253518482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253518482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253518482">(Sep 16 2021 at 02:20)</a>:</h4>
<p>tell bors r-</p>



<a name="253518739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253518739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253518739">(Sep 16 2021 at 02:24)</a>:</h4>
<p>Hmm, I assume I'll have permissions to deapprove my own PR?</p>



<a name="253518766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253518766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253518766">(Sep 16 2021 at 02:24)</a>:</h4>
<p>either you do, or I will.</p>



<a name="253518777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253518777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253518777">(Sep 16 2021 at 02:24)</a>:</h4>
<p>well, I can try</p>



<a name="253518848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253518848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253518848">(Sep 16 2021 at 02:25)</a>:</h4>
<p>cool thanks, it does work</p>



<a name="253518930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253518930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253518930">(Sep 16 2021 at 02:26)</a>:</h4>
<p>Good. Best to comment on why, but now you can work on it.</p>



<a name="253868211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253868211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gonzalo Brito (gnzlbg) <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253868211">(Sep 18 2021 at 13:20)</a>:</h4>
<p>Hi, I used to help with SIMD things in the past, and would like to start helping again. Glad to see there are a lot of people involved.</p>



<a name="253868323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253868323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253868323">(Sep 18 2021 at 13:22)</a>:</h4>
<p>Hello and welcome back!  We do see your legacy all over the codebase <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="253899254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253899254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253899254">(Sep 18 2021 at 22:53)</a>:</h4>
<p>Do we think swizzles are rare enough that importing a trait to use them is acceptable?</p>



<a name="253899308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253899308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253899308">(Sep 18 2021 at 22:54)</a>:</h4>
<p>(you may be implementing this trait yourself sometimes, anyway)</p>



<a name="253907977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253907977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253907977">(Sep 19 2021 at 01:45)</a>:</h4>
<p>Probably.</p>



<a name="253908116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253908116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253908116">(Sep 19 2021 at 01:48)</a>:</h4>
<p>I decided to diff the crate first to make sure CI still passes with the requisite changes.</p>



<a name="253914316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253914316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253914316">(Sep 19 2021 at 03:48)</a>:</h4>
<p>Some good news--with the new swizzle API I was able to implement <code>rotate_{left,right}</code></p>



<a name="253993299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253993299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253993299">(Sep 20 2021 at 03:31)</a>:</h4>
<p>Swizzles (or shuffles, or whatever) are exceptionally common, I'm not sure I've written any simd code of moderate complexity that didn't have several in them.</p>
<p>Also, this isn't just importing a trait, this is importing a trait, defining a dummy struct, and implemnting that trait for the struct.</p>



<a name="253993307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253993307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253993307">(Sep 20 2021 at 03:31)</a>:</h4>
<p>I think this is example of mistaking the overly generic code you find in the stdlib implementation to be representative of the kinds of code users will be actually writing</p>



<a name="253993362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253993362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253993362">(Sep 20 2021 at 03:32)</a>:</h4>
<p>Did you see my latest comment on the PR? There is still room to provide the most common cases</p>



<a name="253993373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253993373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253993373">(Sep 20 2021 at 03:32)</a>:</h4>
<p>(within this framework)</p>



<a name="253993784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253993784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253993784">(Sep 20 2021 at 03:41)</a>:</h4>
<p>It's fine if it's importing a trait, that's light-weight.</p>
<p>People do a lot of io/fs code and have to write the imports for that.<br>
Defining an impl is a lot, however, yes.</p>



<a name="253997031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997031">(Sep 20 2021 at 04:44)</a>:</h4>
<p>So trait impls can have an associated const, but they don't work out if it's a const generic trait impl?</p>



<a name="253997110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997110">(Sep 20 2021 at 04:45)</a>:</h4>
<p>The impl itself can be generic (unless I'm misunderstanding what you mean)</p>



<a name="253997318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997318">(Sep 20 2021 at 04:50)</a>:</h4>
<p>i feel a lot less strongly if we keep an api for doing the N =&gt; N length-preserving shuffle/swizzle. (And I think this api is probably not in a state where we could stabilize it)</p>



<a name="253997341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997341">(Sep 20 2021 at 04:50)</a>:</h4>
<p>I'm thinking that it might be user friendly to have</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32x4</span>::<span class="n">swizzle_from</span>::<span class="o">&lt;</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>where it's like, <code>impl&lt;const generics A,B,C,D&gt; SwizzleFrom&lt;[A,B,C,D]&gt; for TargeType { .. }</code>, sorta like how <code>From</code> works</p>



<a name="253997355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997355">(Sep 20 2021 at 04:50)</a>:</h4>
<p>like Jubilee said: pulling in a trait isn't a huge ask, doing an impl is a huge ask</p>



<a name="253997462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997462">(Sep 20 2021 at 04:52)</a>:</h4>
<p>That sounds like an idea to tinker around with.</p>



<a name="253997469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997469">(Sep 20 2021 at 04:53)</a>:</h4>
<p>Well, to keep it consistent, that's why I suggested something like <code>Shuffle4</code>, rather than a separate function, but you could keep it</p>



<a name="253997546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997546">(Sep 20 2021 at 04:54)</a>:</h4>
<p>I'm concerned about _only_ providing those functions since you would be effectively preventing writing shuffles on generic code</p>



<a name="253997554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997554">(Sep 20 2021 at 04:54)</a>:</h4>
<p>I guess it'd be something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">SwizzleFrom</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">swizzle_from</span><span class="p">(</span><span class="n">a</span>: <span class="nc">A</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>but since we control both the trait and the type people can't add weird impls for it on their own, we don't really even need to seal this one.</p>



<a name="253997607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997607">(Sep 20 2021 at 04:55)</a>:</h4>
<p>but yeah it'd be rough for generics i guess</p>



<a name="253997695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997695">(Sep 20 2021 at 04:57)</a>:</h4>
<p>I definitely think there's room for making the common cases simpler, but I don't think there is any way to provide generic swizzles without an API like this</p>



<a name="253997761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997761">(Sep 20 2021 at 04:58)</a>:</h4>
<p>Something else we haven't even discussed that this addresses is swizzles that change the length of vectors, it's not common but both AVX and NEON have it</p>



<a name="253997802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997802">(Sep 20 2021 at 04:59)</a>:</h4>
<p>It's also useful when you're using rust vectors that are larger than your hardware vectors</p>



<a name="253997913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997913">(Sep 20 2021 at 05:00)</a>:</h4>
<p>I think we need some method of getting consts with generic types, and Caleb's method is good enough for nightly...we may want to extend the compiler to allow <code>&lt;const N: usize, const V: [usize; N]&gt;</code> before stabilizing though</p>



<a name="253997980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253997980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253997980">(Sep 20 2021 at 05:01)</a>:</h4>
<p>length-changing swizzles are likely the most common type for gpu code</p>



<a name="253998183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998183">(Sep 20 2021 at 05:04)</a>:</h4>
<p>yeah, we'll figure out how to make this work well one way or another.</p>



<a name="253998186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998186">(Sep 20 2021 at 05:04)</a>:</h4>
<p>I would completely be okay with that, but I don't think that's even on the radar with const generics.  I don't know enough to say if that's a reasonable thing to change in the compiler</p>



<a name="253998206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998206">(Sep 20 2021 at 05:04)</a>:</h4>
<p><code>const V: [usize; N]</code> is something that will probably happen</p>



<a name="253998238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998238">(Sep 20 2021 at 05:05)</a>:</h4>
<p>That's good to know, then it's a race <span aria-label="smiling devil" class="emoji emoji-1f608" role="img" title="smiling devil">:smiling_devil:</span></p>



<a name="253998299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998299">(Sep 20 2021 at 05:06)</a>:</h4>
<p>I'd declare const generics hobbled if we don't eventually get <code>const V: [usize; N]</code></p>



<a name="253998320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998320">(Sep 20 2021 at 05:06)</a>:</h4>
<p>so, we need const generic const generics :P</p>



<a name="253998327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998327">(Sep 20 2021 at 05:06)</a>:</h4>
<p><span class="user-mention" data-user-id="326176">@Boxy [she/her]</span> that's with N being a generic itself?</p>



<a name="253998329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998329">(Sep 20 2021 at 05:07)</a>:</h4>
<p>yea</p>



<a name="253998348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998348">(Sep 20 2021 at 05:07)</a>:</h4>
<p><code>feature(adt_const_params)</code> doesnt support generic const param types like <code>[usize; N]</code> but its something that's been talked about <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="253998371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998371">(Sep 20 2021 at 05:07)</a>:</h4>
<div class="codehilite"><pre><span></span><code>length-changing swizzles are likely the most common type for gpu code
</code></pre></div>
<p>hm, sure, but just to be clear: for CPU code, length-preserving is overwhelmingly the most common (IME anyway, but this is hard to debate since the APIs dont really provide much else, tbh. although I've also never missed it)</p>



<a name="253998467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998467">(Sep 20 2021 at 05:09)</a>:</h4>
<p>I think it's important to note that if you are using rust vectors larger than your hardware vectors, you can absolutely change the length in code without actually generating any special instructions</p>



<a name="253998469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998469">(Sep 20 2021 at 05:09)</a>:</h4>
<p>i think we should provide both, to be clear, but if length-changing swizzles need a dedicated impl, we should provide a way so that length-preserving ones don't, since i expect they'll be very common.</p>



<a name="253998488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998488">(Sep 20 2021 at 05:09)</a>:</h4>
<p>I think if we get the ability to make the array length generic it can all be one fn</p>



<a name="253998576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998576">(Sep 20 2021 at 05:11)</a>:</h4>
<p>The output len with these traits as well as the hypothetical fn is deduced from either the index array len or from the deducing the output type</p>



<a name="253998594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998594">(Sep 20 2021 at 05:11)</a>:</h4>
<p>gpu code makes length changing swizzles nearly trivial to do, and (ab)uses different length simd vectors for mathematical vectors, rgb/rgba colors, 2d texture coordinates, etc.</p>



<a name="253998806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998806">(Sep 20 2021 at 05:15)</a>:</h4>
<p>there was a reason the length-changing version I offered was getting 4 items out of an 8 item vector, a "realistic" CPU length-changing swizzle.</p>



<a name="253998825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253998825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253998825">(Sep 20 2021 at 05:15)</a>:</h4>
<p>having a separate length-preserving function is probably a good idea even if we get <code>&lt;const V: [usize; N]&gt;</code> since it will not need a type annotation (more of a problem with dynamic swizzles...)</p>



<a name="253999237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/253999237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#253999237">(Sep 20 2021 at 05:23)</a>:</h4>
<p>realistic cpu swizzles could be like mixing 7.1 surround sound to stereo, 8 lanes -&gt; 2 lanes</p>



<a name="254408838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254408838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254408838">(Sep 22 2021 at 17:48)</a>:</h4>
<p>I am checking on the swizzle PR regularly fwiw I am not just ignoring it, I am just waiting for the conversation to iterate to its fixed point.</p>



<a name="254437218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254437218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Miguel Raz Guzmán Macedo <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254437218">(Sep 22 2021 at 20:51)</a>:</h4>
<p>thanks for the ping <span class="user-mention" data-user-id="281757">@Jubilee</span> - I’ll see it latwr this afternoon. I finally finished moving and classes started, so things should be more mellow now. 😊</p>



<a name="254463334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254463334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254463334">(Sep 23 2021 at 00:55)</a>:</h4>
<p>Looking over the PR again, I think <span class="user-mention" data-user-id="229517">@Jacob Lifshay</span> caught most of the rough edges, those have been ironed out</p>



<a name="254463356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254463356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254463356">(Sep 23 2021 at 00:55)</a>:</h4>
<p>The only thing that bothers me is finding a better name for the <code>Which</code> enum, which I picked just so I could move on with the implementation</p>



<a name="254463486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254463486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254463486">(Sep 23 2021 at 00:57)</a>:</h4>
<p>I think I would prefer for it to have an equivalently short name, but maybe something a little more descriptive as to what it's doing</p>



<a name="254463820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254463820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254463820">(Sep 23 2021 at 01:00)</a>:</h4>
<p>VecOrdinal? i can't think of any decent names</p>



<a name="254464208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254464208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254464208">(Sep 23 2021 at 01:06)</a>:</h4>
<p>lmao <code>Nth</code></p>



<a name="254535097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254535097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254535097">(Sep 23 2021 at 13:31)</a>:</h4>
<p>It's unfortunate because <code>Select</code> is kind of the right word, but we already use that to mean something</p>



<a name="254535224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254535224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254535224">(Sep 23 2021 at 13:31)</a>:</h4>
<p>Since a swizzle is reconstituting a vector we could maybe use <code>Take</code></p>



<a name="254535299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254535299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254535299">(Sep 23 2021 at 13:32)</a>:</h4>
<p>Though that already has meaning elsewhere...</p>



<a name="254546589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254546589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254546589">(Sep 23 2021 at 14:41)</a>:</h4>
<p><code>SimdSrc</code></p>



<a name="254546989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Swizzle%20API/near/254546989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Swizzle.20API.html#254546989">(Sep 23 2021 at 14:43)</a>:</h4>
<p><code>Source</code> could work</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>