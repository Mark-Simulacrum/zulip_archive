<html>
<head><meta charset="utf-8"><title>Coersing LLVM to emit mulhi · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html">Coersing LLVM to emit mulhi</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259034735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259034735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259034735">(Oct 25 2021 at 23:40)</a>:</h4>
<p>Good evening cuties! I've been playing around with trying to get LLVM to emit <code>pmulhuw</code>, the 16-bit variant of multiply-high unsigned on x86. I'm having no luck and I'm curious if there's a more creative way I could write the code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">mulhi</span><span class="p">(</span><span class="n">a</span>: <span class="nc">Simd</span>::<span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">Simd</span>::<span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Simd</span>::<span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Simd</span>::<span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span>::<span class="n">from_array</span><span class="p">([</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">a</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">a</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">a</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">a</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">a</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">a</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">a</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">((</span><span class="n">a</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">as_array</span><span class="p">()[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">])</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>It's interesting that LLVM does actually emit a single <code>pmulhw</code>, but it's encaspulated in about ~40 lines of packing, unpacking, and shuffles.</p>



<a name="259036236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259036236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259036236">(Oct 26 2021 at 00:03)</a>:</h4>
<p>Ugh, yeah.<br>
<span class="user-mention" data-user-id="356799">@Brandon Falk</span> So like, a dead array here or there can be optimized out, but this is asking a lot when you pull out that many arrays.</p>



<a name="259036318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259036318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259036318">(Oct 26 2021 at 00:04)</a>:</h4>
<p>I bet this might work if you used... hm.</p>



<a name="259036341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259036341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259036341">(Oct 26 2021 at 00:04)</a>:</h4>
<p>I bet this needs <code>simd_cast</code>.</p>



<a name="259036572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259036572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259036572">(Oct 26 2021 at 00:08)</a>:</h4>
<p>Yeah I'm thinking: cast to u32, multiply, shr, cast back down</p>



<a name="259036591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259036591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259036591">(Oct 26 2021 at 00:09)</a>:</h4>
<p>Then it's 4 intrinsics, and hopefully it's a pattern LLVM recognizes in codegen</p>



<a name="259036695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259036695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259036695">(Oct 26 2021 at 00:10)</a>:</h4>
<p><span class="user-mention" data-user-id="356799">@Brandon Falk</span> Be our test dummy for a bit? Add <code>#![feature(platform_intrinsics)]</code> to your code for a second, and this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"platform-intrinsic"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">simd_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">simd_u16_to_u32</span><span class="p">(</span><span class="n">a</span>: <span class="nc">Simd</span>::<span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Simd</span>::<span class="o">&lt;</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">simd_cast</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">simd_u32_to_u16</span><span class="p">(</span><span class="n">a</span>: <span class="nc">Simd</span>::<span class="o">&lt;</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Simd</span>::<span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">simd_cast</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="259036741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259036741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259036741">(Oct 26 2021 at 00:11)</a>:</h4>
<p>Whatever you're working on is going to be a more realistic test of whether it uses <code>mulhi</code> correctly than the assembly in isolation.</p>



<a name="259037803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259037803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259037803">(Oct 26 2021 at 00:27)</a>:</h4>
<p>I'll try it when I get back home :3</p>



<a name="259038101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259038101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259038101">(Oct 26 2021 at 00:32)</a>:</h4>
<p>Excellent.<br>
If we see that working, then we can just drop the appropriate impls in. We dallied on some things because they weren't priority or we weren't sure how LLVM would optimize them in practice.</p>



<a name="259038128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259038128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259038128">(Oct 26 2021 at 00:32)</a>:</h4>
<p>Do we not have conversions like that yet? It totally slipped my mind</p>



<a name="259038167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259038167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259038167">(Oct 26 2021 at 00:33)</a>:</h4>
<p>Also I'm not exactly sure what happens if that narrowing cast is out of range</p>



<a name="259038188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259038188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259038188">(Oct 26 2021 at 00:33)</a>:</h4>
<p>(which it obviously can't be here, but more generally)</p>



<a name="259038521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259038521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259038521">(Oct 26 2021 at 00:38)</a>:</h4>
<p>Yes, we don't.</p>



<a name="259038535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259038535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259038535">(Oct 26 2021 at 00:39)</a>:</h4>
<p>and yes in this case I think the main blocker was "wait, exactly what failure mode do we want to offer?"</p>



<a name="259038541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259038541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259038541">(Oct 26 2021 at 00:39)</a>:</h4>
<p>it works: <a href="https://rust.godbolt.org/z/cKxncaW71">https://rust.godbolt.org/z/cKxncaW71</a></p>



<a name="259038553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259038553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259038553">(Oct 26 2021 at 00:39)</a>:</h4>
<p>neat!</p>



<a name="259038559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259038559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259038559">(Oct 26 2021 at 00:39)</a>:</h4>
<p>Awesome</p>



<a name="259038565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259038565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259038565">(Oct 26 2021 at 00:39)</a>:</h4>
<p>I am still curious what Brandon's version looks like in like... the middle of his actual code?</p>



<a name="259046773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259046773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259046773">(Oct 26 2021 at 03:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi/near/259038167">said</a>:</p>
<blockquote>
<p>Also I'm not exactly sure what happens if that narrowing cast is out of range</p>
</blockquote>
<p>I'd assume the narrowing cast follows llvm's usual <code>trunc</code> rules -- the answer for each lane is the same thing you'd get with <code>as</code></p>



<a name="259049210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259049210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259049210">(Oct 26 2021 at 03:55)</a>:</h4>
<p>Yep, this works perfect in my code, exactly what I was hoping for (vector casts)</p>



<a name="259050962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259050962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259050962">(Oct 26 2021 at 04:29)</a>:</h4>
<p>Excellent, then it's figuring out a name for it and writing it in.</p>



<a name="259051011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259051011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259051011">(Oct 26 2021 at 04:30)</a>:</h4>
<p><code>Simd::&lt;T, N&gt;::cast::&lt;U&gt;</code></p>



<a name="259051031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259051031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259051031">(Oct 26 2021 at 04:30)</a>:</h4>
<p>like <code>&lt;*const T&gt;::cast</code></p>



<a name="259051097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259051097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259051097">(Oct 26 2021 at 04:32)</a>:</h4>
<p>It's not a reinterpretation tho'.</p>



<a name="259052020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052020">(Oct 26 2021 at 04:53)</a>:</h4>
<p>Sign/zero extend kinda makes sense since that's what it's doing, but that'd be interpreted from the typing so it's kinda weird to have it be explicit</p>



<a name="259052031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052031">(Oct 26 2021 at 04:53)</a>:</h4>
<p>I'm so glad LLVM can turn this into a single instruction, it's so cool. x86 has so many wacky instructions and it'll be nice to be able to use them without breaking support for other arches</p>



<a name="259052266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052266">(Oct 26 2021 at 04:58)</a>:</h4>
<p>It's gotta be like... an <code>fn as_simd</code> with a very explicit annotation that it follows the semantics of <code>as</code> and a test for same.</p>



<a name="259052309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052309">(Oct 26 2021 at 04:59)</a>:</h4>
<p>Is there a big list of all the SIMD platform intrinsics? I might be curious to see if there's anything else that makes it possible to express complex operations</p>



<a name="259052368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052368">(Oct 26 2021 at 05:00)</a>:</h4>
<p>Has anyone tried emitting aesenc using portable simd? That would be _really_ cool</p>



<a name="259052448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052448">(Oct 26 2021 at 05:01)</a>:</h4>
<p>i highly doubt llvm will detect the portable bit-manipulation and table lookups and emit aes instructions...</p>



<a name="259052597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052597">(Oct 26 2021 at 05:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="356799">Brandon Falk</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi/near/259052309">said</a>:</p>
<blockquote>
<p>Is there a big list of all the SIMD platform intrinsics? I might be curious to see if there's anything else that makes it possible to express complex operations</p>
</blockquote>
<p>There is no publicly issued API for it. It is buried deep in the compiler. But the truth is "whatever we write."</p>



<a name="259052613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052613">(Oct 26 2021 at 05:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi/near/259051097">said</a>:</p>
<blockquote>
<p>It's not a reinterpretation tho'.</p>
</blockquote>
<p>yeah, but it follows <code>as</code>, just like <code>ptr::cast</code> is <code>x as *const U</code>. If it were reinterpret it would be named bitcast, transmute, or similar. imho the word cast is much closer to <code>as</code> in implied semantics</p>



<a name="259052698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052698">(Oct 26 2021 at 05:06)</a>:</h4>
<p>A <code>"platform-intrinsic"</code> is essentially issuing a direct command to the codegen backend.</p>



<a name="259052702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052702">(Oct 26 2021 at 05:06)</a>:</h4>
<p>another option could be <code>to</code></p>



<a name="259052720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052720">(Oct 26 2021 at 05:07)</a>:</h4>
<p>oh, i was thinking of the name for the user-visible API, not the intrinsic name</p>



<a name="259052739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052739">(Oct 26 2021 at 05:07)</a>:</h4>
<p>I was continuing my explanation to Brandon.</p>



<a name="259052779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259052779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259052779">(Oct 26 2021 at 05:08)</a>:</h4>
<p>ah, carry on</p>



<a name="259060275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259060275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259060275">(Oct 26 2021 at 07:25)</a>:</h4>
<p>Exploring using this to try to get better emission of non-usize based gathers yields an ICE, damn</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"platform-intrinsic"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">simd_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">simd_u16_to_usize</span><span class="p">(</span><span class="n">a</span>: <span class="nc">Simd</span>::<span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Simd</span>::<span class="o">&lt;</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">simd_cast</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">gather_good</span><span class="p">(</span><span class="n">data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u16</span><span class="p">],</span><span class="w"> </span><span class="n">idxs</span>: <span class="nc">Simd</span><span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Simd</span><span class="o">&lt;</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Simd</span>::<span class="n">gather_or_default</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">simd_u16_to_usize</span><span class="p">(</span><span class="n">idxs</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;called `Option::unwrap()` on a `None` value&#39;, compiler/rustc_codegen_llvm/src/intrinsic.rs:1684:62
stack backtrace:
   0: rust_begin_unwind
             at /rustc/00d5e42e776da900049fe19087bc9b0057ec70cd/library/std/src/panicking.rs:495:5
   1: core::panicking::panic_fmt
             at /rustc/00d5e42e776da900049fe19087bc9b0057ec70cd/library/core/src/panicking.rs:107:14
   2: core::panicking::panic
             at /rustc/00d5e42e776da900049fe19087bc9b0057ec70cd/library/core/src/panicking.rs:50:5
   3: rustc_codegen_llvm::intrinsic::generic_simd_intrinsic
   4: &lt;rustc_codegen_llvm::builder::Builder as rustc_codegen_ssa::traits::intrinsic::IntrinsicCallMethods&gt;::codegen_intrinsic_call
   5: &lt;rustc_codegen_ssa::mir::FunctionCx&lt;rustc_codegen_llvm::builder::Builder&gt;&gt;::codegen_intrinsic_call
   6: rustc_codegen_ssa::mir::codegen_mir::&lt;rustc_codegen_llvm::builder::Builder&gt;
   7: rustc_codegen_llvm::base::compile_codegen_unit::module_codegen
   8: &lt;rustc_query_system::dep_graph::graph::DepGraph&lt;rustc_middle::dep_graph::dep_node::DepKind&gt;&gt;::with_task::&lt;rustc_middle::ty::context::TyCtxt, rustc_span::symbol::Symbol, rustc_codegen_ssa::ModuleCodegen&lt;rustc_codegen_llvm::ModuleLlvm&gt;&gt;
   9: rustc_codegen_llvm::base::compile_codegen_unit
  10: rustc_codegen_ssa::base::codegen_crate::&lt;rustc_codegen_llvm::LlvmCodegenBackend&gt;
  11: &lt;rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_ssa::traits::backend::CodegenBackend&gt;::codegen_crate
  12: &lt;rustc_session::session::Session&gt;::time::&lt;alloc::boxed::Box&lt;dyn core::any::Any&gt;, rustc_interface::passes::start_codegen::{closure#0}&gt;
  13: &lt;rustc_interface::queries::Queries&gt;::ongoing_codegen
  14: &lt;rustc_interface::interface::Compiler&gt;::enter::&lt;rustc_driver::run_compiler::{closure#1}::{closure#2}, core::result::Result&lt;core::option::Option&lt;rustc_interface::queries::Linker&gt;, rustc_errors::ErrorReported&gt;&gt;
  15: rustc_span::with_source_map::&lt;core::result::Result&lt;(), rustc_errors::ErrorReported&gt;, rustc_interface::interface::create_compiler_and_run&lt;core::result::Result&lt;(), rustc_errors::ErrorReported&gt;, rustc_driver::run_compiler::{closure#1}&gt;::{closure#0}&gt;
  16: &lt;scoped_tls::ScopedKey&lt;rustc_span::SessionGlobals&gt;&gt;::set::&lt;rustc_interface::util::setup_callbacks_and_run_in_thread_pool_with_globals&lt;rustc_interface::interface::run_compiler&lt;core::result::Result&lt;(), rustc_errors::ErrorReported&gt;, rustc_driver::run_compiler::{closure#1}&gt;::{closure#0}, core::result::Result&lt;(), rustc_errors::ErrorReported&gt;&gt;::{closure#0}::{closure#0}, core::result::Result&lt;(), rustc_errors::ErrorReported&gt;&gt;
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
</code></pre></div>
<p>Gonna play around with this a bit, as using &lt;usize indicies would be huge, and I'd imagine if LLVM knows they were just zero-extended it will know it doesn't have to emit the <code>usize</code> logic</p>



<a name="259060464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259060464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259060464">(Oct 26 2021 at 07:26)</a>:</h4>
<p>I think this is like the very last thing I'm looking for from portable simd before everything I write should work in it. I use non-usize indicies _a lot_ and current code gen is pretty bad</p>



<a name="259060799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259060799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259060799">(Oct 26 2021 at 07:30)</a>:</h4>
<p>Ah, this seems to be specifically related to <code>usize</code>, casting to<code>u64</code> does work</p>



<a name="259061277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259061277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259061277">(Oct 26 2021 at 07:35)</a>:</h4>
<p>well...rustc's llvm backend expects that usize should have been caught earlier...but it isn't: <a href="https://github.com/rust-lang/rust/blob/17e13b549f5f83cd9ffca9a540090754eb95115c/compiler/rustc_codegen_llvm/src/intrinsic.rs#L1675">https://github.com/rust-lang/rust/blob/17e13b549f5f83cd9ffca9a540090754eb95115c/compiler/rustc_codegen_llvm/src/intrinsic.rs#L1675</a></p>



<a name="259061396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259061396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259061396">(Oct 26 2021 at 07:37)</a>:</h4>
<p>so, rustc probably needs to gain usize/isize support for simd_cast</p>



<a name="259062070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259062070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259062070">(Oct 26 2021 at 07:45)</a>:</h4>
<p>see also <a href="https://github.com/rust-lang/portable-simd/issues/116">portable-simd#116</a></p>



<a name="259145991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259145991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259145991">(Oct 26 2021 at 19:09)</a>:</h4>
<p><span class="user-mention" data-user-id="229517">@Jacob Lifshay</span>  I am thinking <code>into_simd</code> as our fn name for the "lanewise <code>as</code> cast".<br>
<code>to</code> doesn't seem right because it's not <em>always</em> going to be a high cost, but it's not necessarily free either.</p>



<a name="259146390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259146390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259146390">(Oct 26 2021 at 19:12)</a>:</h4>
<p>i'd consider it nearly free, it's not doing anything like calling an allocator and it's generally faster than a f32 division even if tons of swizzling is needed cuz the ISA design is borked.</p>



<a name="259146700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259146700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259146700">(Oct 26 2021 at 19:13)</a>:</h4>
<p>I'm guessing it's usually only twice as costly as a move, roughly</p>



<a name="259146753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259146753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259146753">(Oct 26 2021 at 19:13)</a>:</h4>
<p>At worst</p>



<a name="259146783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259146783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259146783">(Oct 26 2021 at 19:13)</a>:</h4>
<p>Right.<br>
My thinking is that <code>into_</code> is when it's nearly free but not always, basically, and <code>to_</code> is for "expensive" conversions.<br>
<code>as_</code> is, ironically, for basically "no really literally free".</p>



<a name="259146832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259146832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259146832">(Oct 26 2021 at 19:13)</a>:</h4>
<p>Also, is this effectively what this function is? <a href="https://doc.rust-lang.org/std/primitive.u64.html#method.widening_mul">https://doc.rust-lang.org/std/primitive.u64.html#method.widening_mul</a></p>



<a name="259146898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259146898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259146898">(Oct 26 2021 at 19:14)</a>:</h4>
<p>yes.</p>



<a name="259146903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259146903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259146903">(Oct 26 2021 at 19:14)</a>:</h4>
<p>Perhaps we should also implement it</p>



<a name="259146918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259146918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259146918">(Oct 26 2021 at 19:14)</a>:</h4>
<p>Yeah I am thinking we want that.</p>



<a name="259146960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259146960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259146960">(Oct 26 2021 at 19:14)</a>:</h4>
<p>I've personally never used it but seems useful if you're doing bigint stuff</p>



<a name="259146976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259146976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259146976">(Oct 26 2021 at 19:14)</a>:</h4>
<p><code>into_vec</code> for instance is often just basically attaching a capacity/len to a Box.</p>



<a name="259147022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147022">(Oct 26 2021 at 19:15)</a>:</h4>
<p>whereas <code>as_bytes</code> is pure reinterpretation.</p>



<a name="259147063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147063">(Oct 26 2021 at 19:15)</a>:</h4>
<p>int as float/float as int isn't literally free either though</p>



<a name="259147085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147085">(Oct 26 2021 at 19:15)</a>:</h4>
<p>that said i have 0 horse in this race</p>



<a name="259147134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147134">(Oct 26 2021 at 19:16)</a>:</h4>
<p>Yes, that's why it can't be <code>as_simd</code>. :'(</p>



<a name="259147138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147138">(Oct 26 2021 at 19:16)</a>:</h4>
<p>Especially now that it's saturating!</p>



<a name="259147150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147150">(Oct 26 2021 at 19:16)</a>:</h4>
<p>but it's actually surprisingly cheap.</p>



<a name="259147195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147195">(Oct 26 2021 at 19:16)</a>:</h4>
<p><code>to_vec</code> is usually for "copy the entire damn slice".</p>



<a name="259147278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147278">(Oct 26 2021 at 19:17)</a>:</h4>
<p>and basically <code>into_</code> is allowed to be as expensive as <code>to_</code> in theory but isn't necessarily.</p>



<a name="259147355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147355">(Oct 26 2021 at 19:18)</a>:</h4>
<p>So I don't think <code>into_</code> or <code>to_</code> are good names for this just because it's doing slightly different than most type conversions</p>



<a name="259147406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147406">(Oct 26 2021 at 19:18)</a>:</h4>
<p>into can be quite expensive...<code>let v: Arc&lt;str&gt; = "abcd".repeat(1 &lt;&lt; 18).into();</code> copies 1MB</p>



<a name="259147446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147446">(Oct 26 2021 at 19:19)</a>:</h4>
<p>as well as calling the allocator</p>



<a name="259147793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147793">(Oct 26 2021 at 19:22)</a>:</h4>
<p>if we wanted this to be super nice and consistent to use, <code>as</code> could do SIMD casts (<em>not</em> transmute)</p>



<a name="259147858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147858">(Oct 26 2021 at 19:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi/near/259147355">said</a>:</p>
<blockquote>
<p>So I don't think <code>into_</code> or <code>to_</code> are good names for this just because it's doing slightly different than most type conversions</p>
</blockquote>
<p>Oh?</p>



<a name="259147926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147926">(Oct 26 2021 at 19:23)</a>:</h4>
<p>Well, maybe with a very carefully selected name it would be okay</p>



<a name="259147978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259147978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259147978">(Oct 26 2021 at 19:23)</a>:</h4>
<p>But this isn't like <code>to_string</code> or anything like that at all</p>



<a name="259148062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148062">(Oct 26 2021 at 19:24)</a>:</h4>
<p>imho casting should be 100% identical to <code>as</code> for each lane, if we're doing something else then we should name it something else.</p>



<a name="259148140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148140">(Oct 26 2021 at 19:25)</a>:</h4>
<p>such as bitcast or transmute or <code>to_int_unchecked</code></p>



<a name="259148163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148163">(Oct 26 2021 at 19:25)</a>:</h4>
<p>Yeah, it's similar to <code>to_int</code></p>



<a name="259148205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148205">(Oct 26 2021 at 19:25)</a>:</h4>
<p>oh, <span class="user-mention" data-user-id="281757">@Jubilee</span> <code>to</code> is very light-weight there</p>



<a name="259148243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148243">(Oct 26 2021 at 19:25)</a>:</h4>
<p>even more than <code>as</code></p>



<a name="259148599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148599">(Oct 26 2021 at 19:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312331">Caleb Zulawski</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi/near/259148163">said</a>:</p>
<blockquote>
<p>Yeah, it's similar to <code>to_int</code></p>
</blockquote>
<p>I am confused now.</p>



<a name="259148611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148611">(Oct 26 2021 at 19:28)</a>:</h4>
<p>Oh, it's also worth noting I think we need to extend the compiler to do saturating int-to-float casts</p>



<a name="259148672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148672">(Oct 26 2021 at 19:29)</a>:</h4>
<p>and <code>usize</code>/<code>isize</code> casts too</p>



<a name="259148791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148791">(Oct 26 2021 at 19:30)</a>:</h4>
<p>you mean float-to-int? int-to-float is always rounding to nearest, ties to even</p>



<a name="259148800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148800">(Oct 26 2021 at 19:30)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> I guess I was thinking of it more like sext/zext</p>



<a name="259148830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148830">(Oct 26 2021 at 19:30)</a>:</h4>
<p>...that's a type transformation tho'.</p>



<a name="259148833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148833">(Oct 26 2021 at 19:30)</a>:</h4>
<p>Whoops, yeah float-to-int</p>



<a name="259148936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148936">(Oct 26 2021 at 19:31)</a>:</h4>
<p>Yeah, idk I'm not adamant on any naming</p>



<a name="259148982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Coersing%20LLVM%20to%20emit%20mulhi/near/259148982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Coersing.20LLVM.20to.20emit.20mulhi.html#259148982">(Oct 26 2021 at 19:31)</a>:</h4>
<p>I'm opposed to <code>to_simd</code> specifically though</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>