<html>
<head><meta charset="utf-8"><title>Cast lane size · project-portable-simd · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/index.html">project-portable-simd</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html">Cast lane size</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271756690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271756690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joost <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271756690">(Feb 13 2022 at 17:39)</a>:</h4>
<p>I've been reading some of the discussion around (safe) transmuting between different simd types, and is this what's currently the best option for f32x8 -&gt; f32x2 or is there a safe and nice alternative? (to_array -&gt; array_chunk -&gt; from_array is quite cumbersome)</p>
<div class="codehilite"><pre><span></span><code>unsafe { std::mem::transmute::&lt;f32x8, [f32x2; 4]&gt;(*x) }
</code></pre></div>
<p>combined with a <code>flat_map</code> it's a fairly ergonomic way to convert aside from the use of <code>unsafe</code>. Given that the f32x8 is aligned, then each f32x2 should also be aligned on a 64 bit machine?</p>



<a name="271756811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271756811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Zulawski <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271756811">(Feb 13 2022 at 17:42)</a>:</h4>
<p>A way to do something similar today would be to use <code>align_to</code> on slices, but that's not quite the same</p>



<a name="271757702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271757702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271757702">(Feb 13 2022 at 18:05)</a>:</h4>
<p>iirc the canonical method that llvm uses is swizzle...swizzle can have different sizes of inputs and outputs</p>



<a name="271757789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271757789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271757789">(Feb 13 2022 at 18:07)</a>:</h4>
<p>e.g. <code>simd_swizzle!(x, [0, 1])</code> gives you the first 2 lanes of <code>x</code> as <code>Simd&lt;T, 2&gt;</code></p>



<a name="271759632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271759632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271759632">(Feb 13 2022 at 18:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="478500">Joost</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Cast.20lane.20size/near/271756690">said</a>:</p>
<blockquote>
<p>I've been reading some of the discussion around (safe) transmuting between different simd types, and is this what's currently the best option for f32x8 -&gt; f32x2 or is there a safe and nice alternative? (to_array -&gt; array_chunk -&gt; from_array is quite cumbersome)</p>
<div class="codehilite"><pre><span></span><code>unsafe { std::mem::transmute::&lt;f32x8, [f32x2; 4]&gt;(*x) }
</code></pre></div>
<p>combined with a <code>flat_map</code> it's a fairly ergonomic way to convert aside from the use of <code>unsafe</code>. Given that the f32x8 is aligned, then each f32x2 should also be aligned on a 64 bit machine?</p>
</blockquote>
<p>The alignment of SIMD vectors does not depend on the normal datapath width.</p>



<a name="271759758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271759758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271759758">(Feb 13 2022 at 18:55)</a>:</h4>
<p>However, you should be wary of assuming it is safe to decrease the alignment of a vector below 16. Your example drops from 32 to 8. The example you gave is not UB, per se, but only because if the alignment winds up being borked then the vector may wind up being copied, which can wind up being a performance regression.</p>



<a name="271759813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271759813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271759813">(Feb 13 2022 at 18:56)</a>:</h4>
<p>Definitely do <strong>not</strong> combine this with aligned pointer reads.</p>



<a name="271759881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271759881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271759881">(Feb 13 2022 at 18:58)</a>:</h4>
<p>uuh...you seem to be confusing casting pointers (where alignment is an issue) with transmuting values (where alignment usually isn't an issue in terms of UB or not)</p>



<a name="271759887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271759887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271759887">(Feb 13 2022 at 18:58)</a>:</h4>
<p>Yes.</p>



<a name="271759895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271759895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271759895">(Feb 13 2022 at 18:58)</a>:</h4>
<p>Or rather, no, I am not confusing them, I am aware of the difference.<br>
I am saying the transmutation is fine,<br>
but that... agh.</p>



<a name="271760003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271760003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271760003">(Feb 13 2022 at 19:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/257879-project-portable-simd/topic/Cast.20lane.20size/near/271759881">said</a>:</p>
<blockquote>
<p>uuh...you seem to be confusing casting pointers (where alignment is an issue) with transmuting values (where alignment usually isn't an issue in terms of UB or not)</p>
</blockquote>
<p>A vector should obtain an alignment of 16 according to the x86 ABI, I am saying that an element aligned only to 8 in the x86 ABI that is read into a vector via pointer is a bad idea.</p>



<a name="271760013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271760013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271760013">(Feb 13 2022 at 19:00)</a>:</h4>
<p>I am saying there is another step which could be bad.</p>



<a name="271760023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271760023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271760023">(Feb 13 2022 at 19:00)</a>:</h4>
<p>well....anyway....if <code>Simd&lt;T, N&gt;</code> is always laid out like <code>[T; N]</code> in memory, then that transmute is fine. i don't know that we guarantee that though. llvm guarantees that, assuming <code>Simd&lt;T, N&gt;</code> is exactly a llvm vector</p>



<a name="271760096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271760096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271760096">(Feb 13 2022 at 19:02)</a>:</h4>
<p>We haven't exactly decided how we want to handle vectors on x86 which may obtain an alignment below 16. There are lots of possible answers and most of them are annoying to someone. Thus "the transmutation will handle them correctly regardless of whatever but please don't read those in an <code>unsafe</code> manner because things could get hilarious."</p>



<a name="271765717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/257879-project-portable-simd/topic/Cast%20lane%20size/near/271765717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/257879-project-portable-simd/topic/Cast.20lane.20size.html#271765717">(Feb 13 2022 at 21:11)</a>:</h4>
<p>If you want to go from f32x8 to f32x4 (or whatever lane change count) I'd transmute the vector into an array of the smaller vectors, then just index the part you want.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="p">[</span><span class="n">f32x4</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transmute</span><span class="p">(</span><span class="n">my_f32x8</span><span class="p">);</span><span class="w"> </span><span class="c1">// 4*2 == 8</span>
<span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>