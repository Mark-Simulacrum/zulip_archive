<html>
<head><meta charset="utf-8"><title>autoderef bug? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/autoderef.20bug.3F.html">autoderef bug?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265104118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/autoderef%20bug%3F/near/265104118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rafael Ávila de Espíndola <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/autoderef.20bug.3F.html#265104118">(Dec 16 2021 at 02:12)</a>:</h4>
<p>There is something odd about auto deref. The code in <a href="https://gist.github.com/espindola/4e3bccb61657c0f2ba388eeb8e25f3dc">https://gist.github.com/espindola/4e3bccb61657c0f2ba388eeb8e25f3dc</a> compiles with the auto deref but fails with an explicit call to deref_mut().<br>
Also, the code in <a href="https://gist.github.com/espindola/c3f2cb19a9a9715652d55bd9d71cf63a">https://gist.github.com/espindola/c3f2cb19a9a9715652d55bd9d71cf63a</a> uses auto deref. It works with std::boxed::Box, but fails with a custom type that implement DerefMut.<br>
Am I missing some trait that I have to implement? Is there any way to get the first example to compile without auto deref?</p>



<a name="265107265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/autoderef%20bug%3F/near/265107265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/autoderef.20bug.3F.html#265107265">(Dec 16 2021 at 03:09)</a>:</h4>
<p><code>Box</code> is special -- the compiler understands it similar to a local value, and that's what lets you take disparate borrows at the same time.</p>



<a name="265107290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/autoderef%20bug%3F/near/265107290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/autoderef.20bug.3F.html#265107290">(Dec 16 2021 at 03:09)</a>:</h4>
<p>It's not actually using its <code>DerefMut</code></p>



<a name="265107404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/autoderef%20bug%3F/near/265107404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/autoderef.20bug.3F.html#265107404">(Dec 16 2021 at 03:11)</a>:</h4>
<p>For custom types, you need to deref just once, and then take your multiple borrows from that</p>



<a name="265110521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/autoderef%20bug%3F/near/265110521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rafael Ávila de Espíndola <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/autoderef.20bug.3F.html#265110521">(Dec 16 2021 at 04:10)</a>:</h4>
<p>Yes, that is the hack I did locally. Do you happen to know where the special treatment of Box is? I took a quick look at the compiler, but couldn't find it. Thanks.</p>



<a name="265110994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/autoderef%20bug%3F/near/265110994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/autoderef.20bug.3F.html#265110994">(Dec 16 2021 at 04:21)</a>:</h4>
<p>I remember this post: <a href="https://manishearth.github.io/blog/2017/01/10/rust-tidbits-box-is-special/">https://manishearth.github.io/blog/2017/01/10/rust-tidbits-box-is-special/</a></p>



<a name="265111036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/autoderef%20bug%3F/near/265111036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/autoderef.20bug.3F.html#265111036">(Dec 16 2021 at 04:22)</a>:</h4>
<p>but I don't know exactly how the compiler handles that</p>



<a name="265111314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/autoderef%20bug%3F/near/265111314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rafael Ávila de Espíndola <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/autoderef.20bug.3F.html#265111314">(Dec 16 2021 at 04:29)</a>:</h4>
<p>thanks again</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>