<html>
<head><meta charset="utf-8"><title>Polymorphic Dyn over Send / Sync? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html">Polymorphic Dyn over Send / Sync?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249790540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249790540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249790540">(Aug 17 2021 at 23:09)</a>:</h4>
<p>I'm looking to create a function which boxes a type I have for dynamic dispatch- but I'm trying to avoid the BoxFuture / LocalBoxFuture scheme and make a <code>.boxed</code> that is polymorphic over Send / Sync status. Is there a way to be polymorphic over these traits, so I can just say "anything dyn, and matching the Send-ness or Sync-ness of the input"?</p>



<a name="249790652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249790652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249790652">(Aug 17 2021 at 23:10)</a>:</h4>
<p>i don't think so. often if i use generics its just to propagate send/sync.</p>



<a name="249790680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249790680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249790680">(Aug 17 2021 at 23:11)</a>:</h4>
<p>Oof. Okay, so there's currently no way to avoid distinguishing <code>.boxed()</code>, <code>.boxed_local()</code> paths?</p>



<a name="249790872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249790872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249790872">(Aug 17 2021 at 23:14)</a>:</h4>
<p>I'm thinking maaaybe there's a way to make a <code>Boxable</code> trait and where-<code>impl</code> such that it has an associated type for the result of Boxed... But that requires a !Send constraint to ensure the trait is allowed to be implemented without specialization</p>



<a name="249793450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249793450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249793450">(Aug 17 2021 at 23:56)</a>:</h4>
<p>Okay, I had an idea for how to do it but I'm stuck on something:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Boxable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">type</span> <span class="nc">Boxed</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">fn</span> <span class="nf">into_box</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Boxed</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This <em>almost</em> works, but when I try to implement it for a trait of mine which takes a generic, I don't know how to properly constrain the impl over that trait.</p>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=f93def82dce350fe7a6cb6cb269789da">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=f93def82dce350fe7a6cb6cb269789da</a></p>
<p>(<code>Client</code> normally has more content; I stripped it down a bit for this repro)</p>
<p>I run into:</p>
<div class="codehilite"><pre><span></span><code>error[E0207]: the type parameter `TStream` is not constrained by the impl trait, self type, or predicates
  --&gt; src/lib.rs:14:15
   |
14 | impl&lt;TClient, TStream&gt; Boxable for TClient
   |               ^^^^^^^ unconstrained type parameter
</code></pre></div>
<p>But TStream is the generic parameter to Client in TClient; is there a way I can avoid passing the generic parameter to Client at all, or a way to say <code>TClient: for&lt;TStream&gt; Client&lt;TStream&gt;</code>?</p>



<a name="249793778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249793778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249793778">(Aug 18 2021 at 00:01)</a>:</h4>
<p>Simplifying the question: If I have a generic trait and want to implement a trait over all instances of that trait, what do I provide to the generic to actually constrain it?</p>



<a name="249795281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249795281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249795281">(Aug 18 2021 at 00:25)</a>:</h4>
<p>Oof. Okay, working around that reduces to two other issues:</p>
<ul>
<li>Traits with GATs are not object-safe (Is there a plan to eventually change this?)</li>
<li>Traits with methods that have type parameters are not object-safe</li>
</ul>



<a name="249822855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249822855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249822855">(Aug 18 2021 at 08:54)</a>:</h4>
<p>I think you could do this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">IsSend</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">IS_SEND</span>: <span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="n">IsSend</span><span class="o">&lt;</span><span class="kc">false</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Send</span> <span class="o">+</span><span class="w"> </span><span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="n">IsSend</span><span class="o">&lt;</span><span class="kc">true</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">IsSendFuture</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">IS_SEND</span>: <span class="kt">bool</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="bp">Self</span>: <span class="nc">Future</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">IsSend</span><span class="o">&lt;</span><span class="n">IS_SEND</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">IS_SEND</span>: <span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">IsSendFuture</span><span class="o">&lt;</span><span class="n">IS_SEND</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="bp">Self</span>: <span class="nc">Future</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">IsSend</span><span class="o">&lt;</span><span class="n">IS_SEND</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">box_future</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">IS_SEND</span>: <span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">future</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">IsSendFuture</span><span class="o">&lt;</span><span class="n">IS_SEND</span><span class="p">,</span><span class="w"> </span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">F</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="o">&gt;&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">F</span>: <span class="o">'</span><span class="na">a</span> <span class="o">+</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">IsSend</span><span class="o">&lt;</span><span class="n">IS_SEND</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Box</span>::<span class="n">pin</span><span class="p">(</span><span class="n">future</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249823005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249823005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249823005">(Aug 18 2021 at 08:57)</a>:</h4>
<p>Ah, you would need some <code>unsafe</code> there because <code>T: IsSend&lt;true&gt;</code> doesn't imply <code>T: Send</code> to the compiler, even though you know that will always be the case</p>



<a name="249823027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249823027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249823027">(Aug 18 2021 at 08:57)</a>:</h4>
<p>so your containers might have to use a <code>unsafe impl Send for Container&lt;true&gt; {}</code></p>



<a name="249838869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249838869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249838869">(Aug 18 2021 at 12:04)</a>:</h4>
<p>Note, that definition would permit <code>T: Send+IsSend&lt;false&gt;</code>.</p>



<a name="249910473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249910473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249910473">(Aug 18 2021 at 20:56)</a>:</h4>
<p>I think that's desired, it's perfectly OK to box a Send future as a <code>LocalBoxFuture</code> after all.</p>



<a name="249970401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Polymorphic%20Dyn%20over%20Send%20/%20Sync%3F/near/249970401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Polymorphic.20Dyn.20over.20Send.20.2F.20Sync.3F.html#249970401">(Aug 19 2021 at 11:13)</a>:</h4>
<p>I've toyed with some such proptotypes here: <a href="https://docs.rs/stackbox/0.1.2/stackbox/dyn_traits/any/struct.StackBoxDynAny.html">https://docs.rs/stackbox/0.1.2/stackbox/dyn_traits/any/struct.StackBoxDynAny.html</a></p>
<p>Feel free to check the tests to see that it's always using <code>.into_dyn()</code>: <a href="https://github.dev/danielhenrymantilla/stackbox.rs/blob/v0.1.2/src/dyn_traits/tests.rs">https://github.dev/danielhenrymantilla/stackbox.rs/blob/v0.1.2/src/dyn_traits/tests.rs</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>