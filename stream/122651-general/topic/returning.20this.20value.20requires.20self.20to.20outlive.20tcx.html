<html>
<head><meta charset="utf-8"><title>returning this value requires self to outlive tcx · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html">returning this value requires self to outlive tcx</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="220186978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220186978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220186978">(Dec 16 2020 at 23:12)</a>:</h4>
<p>I don't understand this error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">lifetime</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">enough</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">librustdoc</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">format</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">1095</span>:<span class="mi">9</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="w"></span>
<span class="mi">1092</span><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="k">crate</span><span class="w"> </span><span class="k">fn</span> <span class="nf">print_with_space</span><span class="o">&lt;'</span><span class="na">tcx</span>: <span class="o">'</span><span class="na">input</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">input</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">input</span> <span class="nc">Self</span><span class="p">,</span><span class="w"> </span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">fmt</span>::<span class="n">Display</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">tcx</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="w">                                 </span><span class="o">----</span><span class="w">          </span><span class="o">------</span><span class="w"> </span><span class="n">lifetime</span><span class="w"> </span><span class="err">`</span><span class="o">'</span><span class="na">input</span><span class="err">`</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="w">                                 </span><span class="o">|</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="w">                                 </span><span class="n">lifetime</span><span class="w"> </span><span class="err">`</span><span class="o">'</span><span class="na">tcx</span><span class="err">`</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">1095</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="w">         </span><span class="n">display_fn</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">f</span><span class="o">|</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="o">*</span><span class="bp">self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="mi">1096</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">clean</span>::<span class="n">Public</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">write_str</span><span class="p">(</span><span class="s">"pub "</span><span class="p">),</span><span class="w"></span>
<span class="mi">1097</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">clean</span>::<span class="n">Inherited</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(()),</span><span class="w"></span>
<span class="mi">1098</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">clean</span>::<span class="n">Visibility</span>::<span class="n">Restricted</span><span class="p">(</span><span class="n">did</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">did</span><span class="p">.</span><span class="n">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CRATE_DEF_INDEX</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="mi">1118</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="p">}</span><span class="w"></span>
<span class="mi">1119</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="p">})</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="n">__________</span><span class="o">^</span><span class="w"> </span><span class="n">returning</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="err">`</span><span class="o">'</span><span class="na">input</span><span class="err">`</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">outlive</span><span class="w"> </span><span class="err">`</span><span class="o">'</span><span class="na">tcx</span><span class="err">`</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="w"></span>
<span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">help</span>: <span class="nc">consider</span><span class="w"> </span><span class="n">adding</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">bound</span>: <span class="err">`</span><span class="o">'</span><span class="na">input</span>: <span class="o">'</span><span class="na">tcx</span><span class="err">`</span><span class="w"></span>
</code></pre></div>
<p>Or rather, I understand what it's saying, but not why. What part of the closure requires that the input outlives <code>tcx</code>?</p>
<p>For reference, this is the closure: <a href="https://github.com/jyn514/rust/blob/visibility-on-demand/src/librustdoc/html/format.rs#L1095-L1119">https://github.com/jyn514/rust/blob/visibility-on-demand/src/librustdoc/html/format.rs#L1095-L1119</a></p>
<p>The reason I can't just use the suggestion is that the lifetimes with the suggestion are very clearly wrong and the compiler tells me so itself:</p>
<div class="codehilite"><pre><span></span><code>error: lifetime may not live long enough
    --&gt; src/librustdoc/html/render/mod.rs:4079:9
     |
4073 | fn item_foreign_type(w: &amp;mut Buffer, cx: &amp;Context&lt;&#39;_&gt;, it: &amp;clean::Item, cache: &amp;Cache) {
     |                                                   --       - let&#39;s call the lifetime of this reference `&#39;1`
     |                                                   |
     |                                                   let&#39;s call this `&#39;2`
...
4079 |         it.visibility.print_with_space(cx.tcx()),
     |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ argument requires that `&#39;1` must outlive `&#39;2`
</code></pre></div>
<p>The <code>Context</code> arena always outlives the borrow, because the borrow only lives for the lifetime of the function.</p>



<a name="220187166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220187166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220187166">(Dec 16 2020 at 23:14)</a>:</h4>
<p>well, in this case I fixed it by making <code>Self</code> Copy</p>



<a name="220187177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220187177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220187177">(Dec 16 2020 at 23:15)</a>:</h4>
<p>but it would be nice to know for next time</p>



<a name="220187471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220187471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220187471">(Dec 16 2020 at 23:18)</a>:</h4>
<p>You said <code>impl Display + 'tcx</code>, so any references in the value have to live for at least <code>'tcx</code>, and you moved a <code>&amp;'input Self</code>, namely <code>self</code>, into the closure</p>



<a name="220187483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220187483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220187483">(Dec 16 2020 at 23:18)</a>:</h4>
<p>ah hmm</p>



<a name="220187492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220187492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220187492">(Dec 16 2020 at 23:19)</a>:</h4>
<p>so here's what happens if I don't say <code>+ 'tcx</code></p>



<a name="220187518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220187518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220187518">(Dec 16 2020 at 23:19)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error: lifetime may not live long enough
    --&gt; src/librustdoc/html/format.rs:1099:9
     |
1092 |       crate fn print_with_space&lt;&#39;tcx, &#39;input&gt;(
     |                                 ----  ------ lifetime `&#39;input` defined here
     |                                 |
     |                                 lifetime `&#39;tcx` defined here
...
1099 | /         display_fn(move |f| match vis {
1100 | |             clean::Public =&gt; f.write_str(&quot;pub &quot;),
1101 | |             clean::Inherited =&gt; Ok(()),
1102 | |             clean::Visibility::Restricted(did) if did.index == CRATE_DEF_INDEX =&gt; {
...    |
1122 | |             }
1123 | |         })
     | |__________^ associated function was supposed to return data with lifetime `&#39;input` but it is returning data with lifetime `&#39;tcx`
</code></pre></div>



<a name="220187642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220187642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220187642">(Dec 16 2020 at 23:21)</a>:</h4>
<p>what if you use <code>+ 'input</code> instead?</p>



<a name="220187664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220187664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220187664">(Dec 16 2020 at 23:21)</a>:</h4>
<p>then I have to say 'tcx: 'input - let me try that</p>



<a name="220187689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220187689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220187689">(Dec 16 2020 at 23:21)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error[E0700]: hidden type for `impl Trait` captures lifetime that does not appear in bounds
    --&gt; src/librustdoc/html/format.rs:1095:10
     |
1095 |     ) -&gt; impl fmt::Display + &#39;input {
     |          ^^^^^^^^^^^^^^^^^^^^^^^^^^
     |
note: hidden type `impl std::fmt::Display` captures the lifetime `&#39;tcx` as defined on the method body at 1092:31
    --&gt; src/librustdoc/html/format.rs:1092:31
     |
1092 |     crate fn print_with_space&lt;&#39;tcx: &#39;input, &#39;input&gt;(
     |                               ^^^^
</code></pre></div>



<a name="220187950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220187950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220187950">(Dec 16 2020 at 23:24)</a>:</h4>
<p>Hm, I don't know what <code>impl Trait</code> does about hidden structs with multiple lifetime parameters. Does <code>impl Display + 'input + 'tcx</code> work? The syntax here seems insufficient</p>



<a name="220188054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220188054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220188054">(Dec 16 2020 at 23:25)</a>:</h4>
<p>I think the closure is actually <code>Closure&lt;'input, 'tcx: 'input&gt;</code></p>



<a name="220189738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220189738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220189738">(Dec 16 2020 at 23:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx/near/220187950">said</a>:</p>
<blockquote>
<p>Hm, I don't know what <code>impl Trait</code> does about hidden structs with multiple lifetime parameters. Does <code>impl Display + 'input + 'tcx</code> work? The syntax here seems insufficient</p>
</blockquote>
<p>surprisingly yes!</p>



<a name="220189754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220189754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220189754">(Dec 16 2020 at 23:47)</a>:</h4>
<p>oh wait that's because I made it copy lol</p>



<a name="220189756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220189756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220189756">(Dec 16 2020 at 23:47)</a>:</h4>
<p>one sec</p>



<a name="220189778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220189778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220189778">(Dec 16 2020 at 23:47)</a>:</h4>
<p>no, it doesn't help:</p>
<div class="codehilite"><pre><span></span><code>error: lifetime may not live long enough
    --&gt; src/librustdoc/html/format.rs:1098:9
     |
1092 |       crate fn print_with_space&lt;&#39;tcx: &#39;input, &#39;input&gt;(
     |                                 ----          ------ lifetime `&#39;input` defined here
     |                                 |
     |                                 lifetime `&#39;tcx` defined here
...
1098 | /         display_fn(move |f| match *self {
1099 | |             clean::Public =&gt; f.write_str(&quot;pub &quot;),
1100 | |             clean::Inherited =&gt; Ok(()),
1101 | |             clean::Visibility::Restricted(did) if did.index == CRATE_DEF_INDEX =&gt; {
...    |
1121 | |             }
1122 | |         })
     | |__________^ returning this value requires that `&#39;input` must outlive `&#39;tcx`
     |
     = help: consider adding the following bound: `&#39;input: &#39;tcx`
``
</code></pre></div>



<a name="220189830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220189830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220189830">(Dec 16 2020 at 23:48)</a>:</h4>
<p>which makes sense, I said the whole closure lives for <code>'tcx</code>, which means <code>'input</code> has to live for <code>'tcx</code></p>



<a name="220189856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220189856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220189856">(Dec 16 2020 at 23:48)</a>:</h4>
<p><a href="#narrow/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx/near/220187689">https://rust-lang.zulipchat.com/#narrow/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx/near/220187689</a> is very confusing though</p>



<a name="220190045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220190045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220190045">(Dec 16 2020 at 23:51)</a>:</h4>
<p>I wonder if it works with an explicit struct</p>



<a name="220190061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220190061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220190061">(Dec 16 2020 at 23:51)</a>:</h4>
<p>it might be hard to fit that in with the closures</p>



<a name="220190145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220190145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220190145">(Dec 16 2020 at 23:52)</a>:</h4>
<p>well if there's an explicit closure there's no point to using <code>display_fn</code> in the first place</p>



<a name="220190165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220190165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220190165">(Dec 16 2020 at 23:52)</a>:</h4>
<p>that's just a little wrapper to <code>impl Display</code> for you, kind of like lambdas in Java</p>



<a name="220190194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220190194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220190194">(Dec 16 2020 at 23:53)</a>:</h4>
<p>but yes I would expect that to work with an explicit struct</p>



<a name="220191185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220191185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220191185">(Dec 17 2020 at 00:04)</a>:</h4>
<p>Yeah, I don't really mean to use it, only to test what lifetime annotations are needed and whether impl trait will still like it</p>



<a name="220192941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220192941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220192941">(Dec 17 2020 at 00:26)</a>:</h4>
<p>Does <code>-&gt; impl fmt::Display + rustc_data_structures::captures::Captures&lt;'tcx&gt;</code> work by any chance? That's what I use when there's a lifetime that doesn't appear in bounds but the return type doesn't actually live for that lifetime</p>



<a name="220193943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220193943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220193943">(Dec 17 2020 at 00:40)</a>:</h4>
<p>It was suggested to me in a PR a long time ago, it saved my life many times since. That should probably be better documented</p>



<a name="220197921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220197921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Poliorcetics <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220197921">(Dec 17 2020 at 01:38)</a>:</h4>
<p>Knowing this a few days earlier would have saved me some hairs</p>



<a name="220199842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220199842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220199842">(Dec 17 2020 at 02:12)</a>:</h4>
<p>I've been there &gt;&lt;</p>



<a name="220199868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220199868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220199868">(Dec 17 2020 at 02:13)</a>:</h4>
<p>I think this should be in std and rustc should advise the use of <code>Captures</code> when it detects that "hidden type for captures lifetime that does not appear in bounds"</p>



<a name="220201230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220201230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220201230">(Dec 17 2020 at 02:39)</a>:</h4>
<p><span class="user-mention" data-user-id="245339">@Nadrieril</span> Open an issue? Always good to do so we don't lose it :)</p>



<a name="220301528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220301528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220301528">(Dec 17 2020 at 20:58)</a>:</h4>
<p>TIL</p>
<hr>
<p>The issue is nevertheless weird, and feels more like a workaround for a limitation of the compiler semantics: I suspect that replacing <code>impl</code> with <code>Box&lt;dyn</code> would, for instance, solve the problem. <code>impl ...</code> should represent an opaque type that meets the given bounds, and which captures, as needed, all the type and lifetime params in scope.</p>
<p>That is, given the minimal repro (for some type <code>S&lt;'_, '_&gt;</code> invariant over its second lifetime param):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">S</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="sd">/// 'c is the intersection of 'a and 'b</span>
<span class="k">fn</span> <span class="nf">_example</span><span class="o">&lt;'</span><span class="na">c</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="w"> </span>: <span class="o">'</span><span class="na">c</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">b</span><span class="w"> </span>: <span class="o">'</span><span class="na">c</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">it</span>: <span class="nc">S</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">b</span><span class="o">&gt;</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">c</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">it</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=dd505862a1d20766a8614fae769ec7a4">Playground</a></li>
</ul>
<p>Using the suggested hack does indeed solve the issue</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">C</span><span class="o">&lt;'</span><span class="na">lt</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">__</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">C</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-   -&gt; impl Trait + 'c</span>
<span class="gi">+   -&gt; impl Trait + 'c + C&lt;'b&gt;</span>
</code></pre></div>
<ul>
<li><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=46058be3b522d56197a3240e100eb2d4">Playground</a></li>
</ul>
<p>The workaround with <code>type_alias_impl_trait</code> that allows to circumvent the default unsugaring being to:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-   -&gt; impl Trait + 'c</span>
<span class="gi">+   -&gt; Existential&lt;'c, 'a, 'b&gt;</span>

<span class="gi">+ type Existential&lt;'c, 'a : 'c, 'b : 'c&gt; = impl Trait + 'c;</span>
</code></pre></div>
<p>(I have added the <code>'a</code> parameter explicitely even if it isn't needed)</p>
<ul>
<li><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=7d06a074ce4db280225c3b3ab14b8910">Playground</a></li>
</ul>
<p>And this is what I mean: one can add "excessive" lifetime parameters to these explicit existential parameters and it does not seem to be overly restrictive, quite the opposite! So what about unsugaring to that?</p>



<a name="220319103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220319103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220319103">(Dec 17 2020 at 23:43)</a>:</h4>
<p>Turns out there are issues mentioning the confusion already: <a href="https://github.com/rust-lang/rust/issues/66551">https://github.com/rust-lang/rust/issues/66551</a> <a href="https://github.com/rust-lang/rust/issues/61756">https://github.com/rust-lang/rust/issues/61756</a>, and the Captures trait was suggested there</p>



<a name="220364860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220364860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220364860">(Dec 18 2020 at 12:14)</a>:</h4>
<p>But what I'd like to know is if there would be drawbacks to fixing this. As I mentioned in my previous post, there are unsugarings of <code>-&gt; impl</code> that do not require these hacks, so why not use those? I'd like to know if an "overly lifetime-generic" abstract type would be too restrictive for some use cases; and I suspect it wouldn't.</p>



<a name="220365762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220365762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220365762">(Dec 18 2020 at 12:26)</a>:</h4>
<p>Also, found a smaller repro: <code>fn __&lt;'a, 'b&gt; (it: &amp;'a mut 'b ()) -&gt; impl Sized + 'a { it }</code></p>



<a name="220390660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220390660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220390660">(Dec 18 2020 at 16:07)</a>:</h4>
<p>The doc for Captures mentions this comment: <a href="https://github.com/rust-lang/rust/issues/34511#issuecomment-373423999">https://github.com/rust-lang/rust/issues/34511#issuecomment-373423999</a>. The PR that prevents what you want seems to be <a href="https://github.com/rust-lang/rust/pull/49041">https://github.com/rust-lang/rust/pull/49041</a>. Might be more info there</p>



<a name="220390973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220390973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220390973">(Dec 18 2020 at 16:09)</a>:</h4>
<p>I think the problem is linked to inferring variance in the overly generic case</p>



<a name="220392285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/returning%20this%20value%20requires%20self%20to%20outlive%20tcx/near/220392285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/returning.20this.20value.20requires.20self.20to.20outlive.20tcx.html#220392285">(Dec 18 2020 at 16:17)</a>:</h4>
<p>Though if Captures works, the compiler could just insert those Captures automatically when needed I dunno</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>