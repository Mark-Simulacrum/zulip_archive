<html>
<head><meta charset="utf-8"><title>GPU Slices · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html">GPU Slices</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268863936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268863936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268863936">(Jan 21 2022 at 16:09)</a>:</h4>
<p>Hello!</p>
<p>I am running into some issues which im not sure how to solve. As a background, <a href="https://docs.rs/cust/latest/cust/">cust</a>(CUDA Driver API wrapper) previously used <code>DeviceSlice([T])</code> which was definitely unsound because the inner <code>[T]</code> is not dereferenceable on the CPU. But switching away from this and using a proper pointer and length yields some issues that are a bit unwanted. The major one is that now <code>DeviceSlice&lt;T&gt;</code> is not a DST, which means it does not behave like an actual slice, <code>from_raw_parts</code> yields a <code>DeviceSlice&lt;T&gt;</code> not a <code>&amp;DeviceSlice&lt;T&gt;</code> because it cannot return a temporary value. Slices can easily get around this because of pointer metadata, but i cannot do this on stable myself. This also means i cannot keep indexing for GPU slices, which is very very helpful. Because i cannot index and return a reference, or i'd be returning a temporary value.</p>
<p>Anyone know of a possible fix for this kind of stuff?</p>



<a name="268868123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268868123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268868123">(Jan 21 2022 at 16:38)</a>:</h4>
<p>well if it's not dereferenceable it can't be a slice, that's for sure<br>
and a slice is basically the only dst that's even vaguely supported for newtyping, that's also true</p>
<p>Could you show maybe a sample usage of how you might be using the GPU thing? I'm only familiar with <code>glMapBuffer</code> which does allow the creation of a normal slice once the buffer is mapped properly.</p>



<a name="268872858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268872858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268872858">(Jan 21 2022 at 17:14)</a>:</h4>
<p><span class="user-mention" data-user-id="224471">@Lokathor</span> the device slice usually comes from a DeviceBuffer, such as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeviceBuffer</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>This data is on the GPU, it is not dereferenceable on the CPU. However, it is sometimes helpful to copy into only a part of the slice, such as</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">5</span><span class="p">].</span><span class="n">async_copy_to</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stream</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="268873294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268873294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268873294">(Jan 21 2022 at 17:18)</a>:</h4>
<p>i mean for that you'd be best served by accepting some slightly different than normal syntax and just using a method instead of indexing notation</p>



<a name="268873330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268873330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268873330">(Jan 21 2022 at 17:18)</a>:</h4>
<p>yeah, i just wanted to maybe avoid that, but if its not possible ill just do that</p>



<a name="268873382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268873382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268873382">(Jan 21 2022 at 17:18)</a>:</h4>
<p>technically you can tell cuda to map arbitrary memory as unified memory, which would make it dereferenceable on the cpu</p>



<a name="268873422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268873422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268873422">(Jan 21 2022 at 17:19)</a>:</h4>
<p>but i assume this has a cost, especially since normal unified memory has a cost</p>



<a name="268873436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268873436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268873436">(Jan 21 2022 at 17:19)</a>:</h4>
<p>When designing an API to work with volatile stuff I mostly ended up in the same boat. Normal Rust just isn't flexible enough to do this.</p>



<a name="268873760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268873760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268873760">(Jan 21 2022 at 17:21)</a>:</h4>
<p>i think the funniest part of this was the old struct (this is all from rustacuda, cust is a rustacuda fork with many changes) derived <code>Debug</code>, so if you tried to debug it it just segfaulted lol</p>



<a name="268902278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268902278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268902278">(Jan 21 2022 at 20:59)</a>:</h4>
<p>You could do the bitvec trick and do <code>struct DeviceSlice([()])</code></p>



<a name="268902495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268902495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268902495">(Jan 21 2022 at 21:00)</a>:</h4>
<p>I.e. <code>DeviceSlice</code> wraps a slice of zero-sized types</p>



<a name="268902594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268902594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268902594">(Jan 21 2022 at 21:01)</a>:</h4>
<p>Since it's zero-sized it's allowed to point basically anywhere, doesn't have to be valid memory there</p>



<a name="268902625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268902625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268902625">(Jan 21 2022 at 21:01)</a>:</h4>
<p>And it will also track the length</p>



<a name="268909187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268909187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268909187">(Jan 21 2022 at 22:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="306504">Tavian Barnes</span> <a href="#narrow/stream/122651-general/topic/GPU.20Slices/near/268902594">said</a>:</p>
<blockquote>
<p>Since it's zero-sized it's allowed to point basically anywhere, doesn't have to be valid memory there</p>
</blockquote>
<p>Though note that this way the pointer inside the reference will only be allowed to access the contents of <code>[()]</code>. I'm not sure how that interacts with GPU memory, but it's definitely not a good thing.</p>



<a name="268914889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/268914889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#268914889">(Jan 21 2022 at 22:59)</a>:</h4>
<p>yeah the allowed memory width is cut down if you make it a reference. that's also why we can't make an ffi compatible zero-terminated string type</p>



<a name="269032023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269032023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269032023">(Jan 23 2022 at 18:28)</a>:</h4>
<p><span class="user-mention" data-user-id="338379">@Giacomo Stevanato</span> Occasionally the slice must use the pointer to give it to the CUDA Driver API to issue memcpys, like allocating an intermediate vec, issuing a DtoH memcpy into the vec, then returning the vec</p>



<a name="269032037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269032037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269032037">(Jan 23 2022 at 18:28)</a>:</h4>
<p>but you cannot directly read data from the pointer, it doesn't make sense, you can use the pointer to issue a GPU copy to the CPU then read the CPU memory, sure</p>



<a name="269032059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269032059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269032059">(Jan 23 2022 at 18:29)</a>:</h4>
<p>But also, wouldn't i need phantom data to keep track of the actual type behind the slice? how do i do that if its a newtype of <code>[()]</code>?</p>



<a name="269032132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269032132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269032132">(Jan 23 2022 at 18:30)</a>:</h4>
<p>for example</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="n">T</span>::<span class="n">default</span><span class="p">();</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">len</span><span class="p">()];</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">copy_to</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="269032146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269032146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269032146">(Jan 23 2022 at 18:31)</a>:</h4>
<p>which then issues this call: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">.</span><span class="n">as_mut</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">val</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"></span>
<span class="w">            </span><span class="s">"destination and source slices have different lengths"</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">len</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">cuda</span>::<span class="n">cuMemcpyDtoH_v2</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">c_void</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="p">.</span><span class="n">to_result</span><span class="p">()</span><span class="o">?</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
</code></pre></div>



<a name="269032270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269032270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269032270">(Jan 23 2022 at 18:34)</a>:</h4>
<p>So basically, i need to be able to query the slice's pointer and length and make a new slice from an arbitrary pointer, thats my 2 restrictions</p>



<a name="269032272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269032272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269032272">(Jan 23 2022 at 18:34)</a>:</h4>
<p>and know the type behind the slice</p>



<a name="269032369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269032369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269032369">(Jan 23 2022 at 18:36)</a>:</h4>
<p>Oh bitvec also has phantom data along with the slice... cool</p>



<a name="269032371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269032371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269032371">(Jan 23 2022 at 18:36)</a>:</h4>
<p>i might give it a try then</p>



<a name="269032529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269032529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269032529">(Jan 23 2022 at 18:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="338379">Giacomo Stevanato</span> <a href="#narrow/stream/122651-general/topic/GPU.20Slices/near/268909187">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="306504">Tavian Barnes</span> <a href="#narrow/stream/122651-general/topic/GPU.20Slices/near/268902594">said</a>:</p>
<blockquote>
<p>Since it's zero-sized it's allowed to point basically anywhere, doesn't have to be valid memory there</p>
</blockquote>
<p>Though note that this way the pointer inside the reference will only be allowed to access the contents of <code>[()]</code>. I'm not sure how that interacts with GPU memory, but it's definitely not a good thing.</p>
</blockquote>
<p>Im not exactly sure what you mean, CUDA is usually 64 bit for the GPU side, and 64 bit for the CPU side too. Its basically unheard of to use 64 bit CUDA for GPU then 32-bit arches for the CPU side.</p>



<a name="269032709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269032709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269032709">(Jan 23 2022 at 18:44)</a>:</h4>
<p>I can make a panicking conversion too just to make sure the 64 bit gpu pointer doesnt wrap for 32 bit arches</p>



<a name="269036150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036150">(Jan 23 2022 at 19:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="338379">Giacomo Stevanato</span> <a href="#narrow/stream/122651-general/topic/GPU.20Slices/near/268909187">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="306504">Tavian Barnes</span> <a href="#narrow/stream/122651-general/topic/GPU.20Slices/near/268902594">said</a>:</p>
<blockquote>
<p>Since it's zero-sized it's allowed to point basically anywhere, doesn't have to be valid memory there</p>
</blockquote>
<p>Though note that this way the pointer inside the reference will only be allowed to access the contents of <code>[()]</code>. I'm not sure how that interacts with GPU memory, but it's definitely not a good thing.</p>
</blockquote>
<p>Wait really?  Are you saying that this is not permitted:</p>
<div class="codehilite"><pre><span></span><code>fn main() {
    let arr = [1, 2, 3, 4];
    let zst_ptr = &amp;arr as *const i32 as *const ();
    let zst_slice = unsafe { std::slice::from_raw_parts(zst_ptr, 4) };
    let new_ptr = zst_slice as *const [()] as *const i32;
    let new_slice = unsafe { std::slice::from_raw_parts(new_ptr, 4) };
    dbg!(new_slice);
}
</code></pre></div>
<p>Miri accepts it.</p>



<a name="269036175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036175">(Jan 23 2022 at 19:57)</a>:</h4>
<p>doesn't this violate provenance?</p>



<a name="269036295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036295">(Jan 23 2022 at 19:59)</a>:</h4>
<p>I mean, I would argue that it shouldn't.  I don't know the details of Stacked Borrows (or any other Rust provenance model) well enough to say</p>



<a name="269036351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036351">(Jan 23 2022 at 20:00)</a>:</h4>
<p>Does it with <code>-Zmiri-tag-raw-pointers</code>?</p>



<a name="269036412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036412">(Jan 23 2022 at 20:01)</a>:</h4>
<p>I believe zst pointers are allowed to point everywhere <em>except</em> deallocated allocations. This is an LLVM restriction we can't do anything about.</p>



<a name="269036428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036428">(Jan 23 2022 at 20:01)</a>:</h4>
<p>Well i mean technically i cant know if the gpu pointer overlaps with the same adress of a deallocated space in cpu memory</p>



<a name="269036495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036495">(Jan 23 2022 at 20:03)</a>:</h4>
<p>Right, ZST pointers are permissive enough, I guess the question is whether ZST <em>references</em> reduce the allowed memory range to nothing</p>



<a name="269036496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036496">(Jan 23 2022 at 20:03)</a>:</h4>
<p>but im never actually accessing anything from the pointer, only passing it to the very opaque cuda api</p>



<a name="269036543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036543">(Jan 23 2022 at 20:04)</a>:</h4>
<p>Right, I don't think that's a problem for memory that isn't CPU-addressable anyway, Rust doesn't care</p>



<a name="269036553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036553">(Jan 23 2022 at 20:04)</a>:</h4>
<p>But this is potentially a big deal for bitvec unless I'm missing something</p>



<a name="269036563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036563">(Jan 23 2022 at 20:04)</a>:</h4>
<p>Yeah rust isnt usually the problem, LL "pointers aint just numbers" VM is the problem</p>



<a name="269036650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036650">(Jan 23 2022 at 20:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/122651-general/topic/GPU.20Slices/near/269036351">said</a>:</p>
<blockquote>
<p>Does it with <code>-Zmiri-tag-raw-pointers</code>?</p>
</blockquote>
<p>Indeed that makes it fail :(</p>



<a name="269036664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036664">(Jan 23 2022 at 20:06)</a>:</h4>
<p>Well i cant imagine that packing a gpu pointer as a slice pointer would make rust or llvm mad, im just storing an arbitrary value in there, never accessing it as a cpu thing</p>



<a name="269036745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269036745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tavian Barnes <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269036745">(Jan 23 2022 at 20:08)</a>:</h4>
<p>Yes I think that's should be fine</p>



<a name="269060964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269060964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269060964">(Jan 24 2022 at 05:12)</a>:</h4>
<p>if it's not a pointer within the cpu address space might be better to just store a darn usize</p>



<a name="269061212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269061212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269061212">(Jan 24 2022 at 05:18)</a>:</h4>
<p>if it's not a pointer in the cpu address space, store a u64...a usize will likely give the false impression that gpu pointer size always == cpu pointer size when you can have 64-bit gpus on 32-bit cpus and vis versa; idk if that's the case for cuda but it's definitely the case for opencl/vulkan/etc.</p>



<a name="269061473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269061473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269061473">(Jan 24 2022 at 05:24)</a>:</h4>
<p>ah, fair point, a plain u64</p>



<a name="269061647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269061647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269061647">(Jan 24 2022 at 05:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/122651-general/topic/GPU.20Slices/near/269060964">said</a>:</p>
<blockquote>
<p>if it's not a pointer within the cpu address space might be better to just store a darn usize</p>
</blockquote>
<p>thats what i do for <code>DevicePointer&lt;T&gt;</code>, but thats not the issue, its how to pack that pointer and a length alongside so i can make proper gpu slices</p>



<a name="269061701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269061701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269061701">(Jan 24 2022 at 05:28)</a>:</h4>
<p>CUDA on 32 bit arches is exceedingly rare, i think its fine to pack it as a pointer and just panic if it doesnt fit</p>



<a name="269061986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269061986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269061986">(Jan 24 2022 at 05:35)</a>:</h4>
<p>besides, if ur on a 32 bit arch, u wont even be able to use the full 64 bits of the GPU because u can't copy data all at once lol</p>



<a name="269062275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269062275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269062275">(Jan 24 2022 at 05:42)</a>:</h4>
<p>if you can't read directly from the memory why do you want a slice to it though</p>



<a name="269062280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269062280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269062280">(Jan 24 2022 at 05:42)</a>:</h4>
<p>that seems to be what I'm missing</p>



<a name="269063568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269063568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269063568">(Jan 24 2022 at 06:08)</a>:</h4>
<p>sketch of what you could do instead of using <code>&amp;[T]</code>: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=0a34a48b4e4ccb2c58b1cce6531f0d8c">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=0a34a48b4e4ccb2c58b1cce6531f0d8c</a></p>



<a name="269063600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269063600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269063600">(Jan 24 2022 at 06:09)</a>:</h4>
<p>it uses <code>NonZeroU64</code> as the gpu ptr and <code>u64</code> as the length.</p>



<a name="269063679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269063679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269063679">(Jan 24 2022 at 06:10)</a>:</h4>
<p>though...idk if gpu apis guarantee that 0 is null</p>



<a name="269063711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269063711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269063711">(Jan 24 2022 at 06:11)</a>:</h4>
<p>i know some weird C compilers use a non-zero value as a null pointer</p>



<a name="269130113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269130113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269130113">(Jan 24 2022 at 16:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/122651-general/topic/GPU.20Slices/near/269062275">said</a>:</p>
<blockquote>
<p>if you can't read directly from the memory why do you want a slice to it though</p>
</blockquote>
<p>Same reason that you'd want slices on the CPU, except in this case, the data is not directly accessible without copying back to the CPU. It is often useful to borrow a piece of data on the GPU without owning it (because that means dropping it when done), and being able to only write to/from a specific area of a buffer.</p>



<a name="269130562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269130562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269130562">(Jan 24 2022 at 16:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/122651-general/topic/GPU.20Slices/near/269063568">said</a>:</p>
<blockquote>
<p>sketch of what you could do instead of using <code>&amp;[T]</code>: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=0a34a48b4e4ccb2c58b1cce6531f0d8c">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=0a34a48b4e4ccb2c58b1cce6531f0d8c</a></p>
</blockquote>
<p>The issue is that without a DST, its not possible to implement things like index because you cannot return</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&amp;</span><span class="n">DeviceSlice</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>That is the core issue here, with slices this is not a problem the slices encode the needed data in the actual ref</p>



<a name="269130601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269130601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269130601">(Jan 24 2022 at 16:24)</a>:</h4>
<p>Well the reason that I want a slice normally is because it's a simple way to keep all my references in one place</p>



<a name="269130645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269130645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269130645">(Jan 24 2022 at 16:25)</a>:</h4>
<p>So if there's no references possible, a slice becomes a not helpful thing</p>



<a name="269130677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269130677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269130677">(Jan 24 2022 at 16:25)</a>:</h4>
<p>but it <em>is</em> a reference, just not one you can directly read from</p>



<a name="269130691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269130691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269130691">(Jan 24 2022 at 16:25)</a>:</h4>
<p>that doesn't mean its not useful</p>



<a name="269130886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269130886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269130886">(Jan 24 2022 at 16:26)</a>:</h4>
<p>sorry, by "reference" i mean "rust reference that follows all the rules of rust references including being dereferenceable"</p>



<a name="269130980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269130980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269130980">(Jan 24 2022 at 16:27)</a>:</h4>
<p>Well in this case its not really a reference in the traditional sense, its a reference to some data on the gpu you can do stuff to. References to structures not on the CPU is not uncommon</p>



<a name="269131073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131073">(Jan 24 2022 at 16:28)</a>:</h4>
<p>I don't want <code>&amp;[T]</code>, i just want to be able to have my GPU slices behave like... slices, and the issue is <code>[T]</code> is basically the only supported DST</p>



<a name="269131158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131158">(Jan 24 2022 at 16:29)</a>:</h4>
<p>Right, Rust doesn't support your use case with the level of ergonomics/integration that you want. I absolutely agree on that point.</p>



<a name="269131174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131174">(Jan 24 2022 at 16:29)</a>:</h4>
<p>Yeah</p>



<a name="269131185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131185">(Jan 24 2022 at 16:29)</a>:</h4>
<p>So i need to hack around it to some degree</p>



<a name="269131267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131267">(Jan 24 2022 at 16:29)</a>:</h4>
<p>You can just make your own for most of this. All you lose is suger</p>



<a name="269131398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131398">(Jan 24 2022 at 16:30)</a>:</h4>
<p>I have: <a href="https://github.com/Rust-GPU/Rust-CUDA/blob/master/crates/cust/src/memory/device/device_slice.rs">https://github.com/Rust-GPU/Rust-CUDA/blob/master/crates/cust/src/memory/device/device_slice.rs</a><br>
But then i realized this makes it impossible to implement cool things like <code>Index</code> and <code>IndexMut</code></p>



<a name="269131466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131466">(Jan 24 2022 at 16:31)</a>:</h4>
<p>things that the previous impl of deviceslice had might i add*</p>



<a name="269131562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131562">(Jan 24 2022 at 16:31)</a>:</h4>
<p>Right, but you don't need those to begin with</p>



<a name="269131635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131635">(Jan 24 2022 at 16:32)</a>:</h4>
<p>Yes i do, writing to specific parts of a GPU buffer is incredibly common</p>



<a name="269131673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131673">(Jan 24 2022 at 16:32)</a>:</h4>
<p>but those traits are just sugar</p>



<a name="269131721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131721">(Jan 24 2022 at 16:32)</a>:</h4>
<p>just write your own method that has the slightly altered signature you need</p>



<a name="269131731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131731">(Jan 24 2022 at 16:32)</a>:</h4>
<p>Yes but sugar is good, its the expected way to be doing things</p>



<a name="269131982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269131982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269131982">(Jan 24 2022 at 16:34)</a>:</h4>
<p><a href="https://docs.rs/voladdress/latest/voladdress/struct.VolBlock.html#method.index">https://docs.rs/voladdress/latest/voladdress/struct.VolBlock.html#method.index</a></p>
<p>Eh, it's good i guess, but it's not really a big deal once you get used to just using a few methods instead though.</p>



<a name="269132256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269132256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269132256">(Jan 24 2022 at 16:36)</a>:</h4>
<p>I would also need to return an "owned" <code>DeviceSlice&lt;T&gt;</code> like i currently do, which is undesireable <a href="https://github.com/Rust-GPU/Rust-CUDA/blob/master/crates/cust/src/memory/device/device_slice.rs#L545">https://github.com/Rust-GPU/Rust-CUDA/blob/master/crates/cust/src/memory/device/device_slice.rs#L545</a></p>



<a name="269132897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GPU%20Slices/near/269132897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GPU.20Slices.html#269132897">(Jan 24 2022 at 16:40)</a>:</h4>
<p>just slap a lifetime on that thing or whatever and you're all set.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>