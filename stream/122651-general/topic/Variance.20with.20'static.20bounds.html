<html>
<head><meta charset="utf-8"><title>Variance with &#x27;static bounds · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html">Variance with &#x27;static bounds</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249478184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249478184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249478184">(Aug 14 2021 at 21:29)</a>:</h4>
<p>is there a way to get a struct holding a <code>PhantomData&lt;T&gt;</code> to be <code>'static</code>, even if <code>T</code> isn't <code>'static</code>? <code>PhantomData&lt;fn() -&gt; T&gt;</code> seems to work for bounds like <code>Send</code> (<code>struct Foo&lt;T&gt;(PhantomData&lt;fn() -&gt; T&gt;)</code> is <code>Send</code> even if <code>T</code> is not <code>Send</code>), but not <code>'static</code>. <code>T</code> shouldn't have to be static in my case, because it isn't stored, it's used as a function parameter, and I need the phantom data to constrain a blanket trait implementation.</p>



<a name="249478239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249478239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249478239">(Aug 14 2021 at 21:30)</a>:</h4>
<p>I don't understand variance very much, so I'm not sure if this should be possible.</p>



<a name="249478659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249478659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249478659">(Aug 14 2021 at 21:44)</a>:</h4>
<p>trying to get a smaller reproducible example, I realized the thing I'm trying to do is impossible <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="249479643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249479643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249479643">(Aug 14 2021 at 22:12)</a>:</h4>
<p>I don't think so. If you have <code>Foo&lt;&amp;'a T&gt;</code> thatvwill always require it to not outlive <code>'a</code>. Variance only affects coercions like <code>&amp;'static T</code>-&gt;<code>&amp;'a T</code> or <code>fn(&amp;'a T)</code>-&gt;<code>fn(&amp;'static T)</code> so at most you could make <code>Foo&lt;&amp;'a T&gt;</code> coercible to <code>Foo&lt;&amp;'static T&gt;</code>. You can't make <code>Foo&lt;&amp;'a T&gt;</code> itself <code>'static</code>.</p>



<a name="249485624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249485624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249485624">(Aug 15 2021 at 01:06)</a>:</h4>
<p>So, I have a <code>Handler</code> trait:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">handle</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">req</span>: <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And a ergonomic API that let's you pass any function that takes anything implementing <code>FromRequest</code> as a parameter (like rocket):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">FnHandler</span><span class="o">&lt;</span><span class="n">R</span>: <span class="nc">FromRequest</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="nc">R</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">F</span><span class="p">.</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FnHandler</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">F</span>: <span class="nb">Fn</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="p">,</span><span class="w"> </span><span class="n">R</span>: <span class="nc">FromRequest</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="nc">R</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">FromRequest</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">req</span>: <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249485636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249485636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249485636">(Aug 15 2021 at 01:07)</a>:</h4>
<p>Now, the issue is that I am storing a <code>Vec&lt;Box&lt;dyn Handler&lt;Request&gt;&gt;</code>, so I need a wrapper type around <code>FnHandler</code>'s that implements <code>Handler</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">FnHandlerWrapper</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">,</span><span class="w"> </span><span class="n">_r</span>: <span class="nc">PhantomData</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">FnHandlerWrapper</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">handle</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">req</span>: <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span>::<span class="n">from_request</span><span class="p">(</span><span class="n">req</span><span class="p">);</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">f</span><span class="p">)(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><code>FnHandlerWrapper</code> has to store a <code>PhantomData&lt;R&gt;</code>, otherwise it's unconstrained.</p>



<a name="249485642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249485642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249485642">(Aug 15 2021 at 01:07)</a>:</h4>
<p>And that means <code>FnHandlerWrapper</code> is only <code>'static</code> when <code>R: 'static, F: 'static</code></p>



<a name="249485682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249485682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249485682">(Aug 15 2021 at 01:08)</a>:</h4>
<p><code>F: 'static</code> is fine of course, but <code>R: 'static</code> means that <code>FromRequest</code> implementors cannot borrow from the request.</p>



<a name="249485687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249485687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249485687">(Aug 15 2021 at 01:08)</a>:</h4>
<p>Which sucks, because then I have to <code>Arc</code> application state that could otherwise be borrowed.</p>



<a name="249486109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249486109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249486109">(Aug 15 2021 at 01:22)</a>:</h4>
<p>Not that big of a deal, but I was wondering if it's possible</p>



<a name="249499667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249499667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249499667">(Aug 15 2021 at 08:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="432683">AI</span> <a href="#narrow/stream/122651-general/topic/Variance.20with.20'static.20bounds/near/249485682">said</a>:</p>
<blockquote>
<p><code>F: 'static</code> is fine of course, but <code>R: 'static</code> means that <code>FromRequest</code> implementors cannot borrow from the request.</p>
</blockquote>
<p>With the current definition of <code>FromRequest</code> implementors can't borrow from the request anyway  since the <code>'a</code> lifetime is not in scope when <code>Self</code> is defined</p>



<a name="249512564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249512564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249512564">(Aug 15 2021 at 13:28)</a>:</h4>
<p>Hm, you're right. It would have to be like this right?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">FromRequest</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">req</span>: <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249512604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249512604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249512604">(Aug 15 2021 at 13:28)</a>:</h4>
<p>But that still doesn't solve the main issue</p>



<a name="249513603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249513603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249513603">(Aug 15 2021 at 13:49)</a>:</h4>
<p>Is the solution here to restucture the way I'm doing this, or do I need something like <code>Box&lt;dyn Handler + 'self?&gt;</code></p>



<a name="249513615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249513615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249513615">(Aug 15 2021 at 13:49)</a>:</h4>
<p>Because due to the <code>PhantomData&lt;R&gt;</code>, the handlers borrow from the request state, stored in <code>self</code></p>



<a name="249513665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249513665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249513665">(Aug 15 2021 at 13:50)</a>:</h4>
<p>I was also wondering how I would do something like <code>struct App { state: RequestState, service: Box&lt;dyn Service&lt;Request&lt;'self?&gt;&gt; }</code></p>



<a name="249513700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249513700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249513700">(Aug 15 2021 at 13:50)</a>:</h4>
<p>But I ended up making my own <code>Handler</code> trait that only takes <code>Request</code> as a parameter, not a generic</p>



<a name="249513729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249513729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249513729">(Aug 15 2021 at 13:51)</a>:</h4>
<p>This is almost a self-referential struct problem, except it shouldn't be because the borrows aren't being stored <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="249513733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249513733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249513733">(Aug 15 2021 at 13:52)</a>:</h4>
<p>Is what I want impossible, and is there a good reason for it?</p>



<a name="249516414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249516414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249516414">(Aug 15 2021 at 14:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="432683">AI</span> <a href="#narrow/stream/122651-general/topic/Variance.20with.20'static.20bounds/near/249512564">said</a>:</p>
<blockquote>
<p>Hm, you're right. It would have to be like this right?</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">FromRequest</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">req</span>: <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>You also need to do the same thing with <code>Handler</code></p>



<a name="249516542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249516542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249516542">(Aug 15 2021 at 14:52)</a>:</h4>
<p>I think you might want something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Handler</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">handle</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">req</span>: <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">FromRequest</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">req</span>: <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">FnHandler</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="nc">R</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FnHandler</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">F</span>: <span class="nb">Fn</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">call</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="nc">R</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">FnHandlerWrapper</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">,</span><span class="w"> </span><span class="n">_r</span>: <span class="nc">PhantomData</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nc">FnHandler</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">R</span>: <span class="nc">FromRequest</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Handler</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">FnHandlerWrapper</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">handle</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">req</span>: <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">R</span>::<span class="n">from</span><span class="p">(</span><span class="n">req</span><span class="p">))</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Then you can have a <code>Box&lt;dyn for&lt;'a&gt; Handler&lt;'a&gt;&gt;</code>. <br>
This might be nicer with GATs though.</p>



<a name="249519795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249519795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249519795">(Aug 15 2021 at 16:11)</a>:</h4>
<p>Wait... <code>Box&lt;dyn for&lt;'a&gt; Handler&lt;'a&gt;&gt;</code> is legal syntax?</p>



<a name="249519811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249519811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249519811">(Aug 15 2021 at 16:11)</a>:</h4>
<p>I didn't know you can use hrtbs with <code>dyn</code>!</p>



<a name="249519868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249519868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249519868">(Aug 15 2021 at 16:12)</a>:</h4>
<p>That means I can do my original thing with <code>Box&lt;dyn for&lt;'a&gt; Handler&lt;Request&lt;'a&gt;&gt;</code></p>



<a name="249519869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249519869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249519869">(Aug 15 2021 at 16:12)</a>:</h4>
<p>wow, thanks!</p>



<a name="249519874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249519874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249519874">(Aug 15 2021 at 16:12)</a>:</h4>
<p>How would GATs fit in here?</p>



<a name="249520825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249520825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249520825">(Aug 15 2021 at 16:34)</a>:</h4>
<p>I think I would need GATs for returning futures, but I don't have any associated types right now.</p>



<a name="249521247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249521247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249521247">(Aug 15 2021 at 16:46)</a>:</h4>
<p>Hm.. this still doesn't seem to work <span class="user-mention" data-user-id="338379">@Giacomo Stevanato</span></p>



<a name="249521254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249521254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249521254">(Aug 15 2021 at 16:46)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">state</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Response</span><span class="p">;</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Handler</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">handle</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">req</span>: <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">FromRequest</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">from</span><span class="p">(</span><span class="n">req</span>: <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">FnHandler</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">call</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="nc">R</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FnHandler</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">F</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">F</span>: <span class="nb">Fn</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">call</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">r</span>: <span class="nc">R</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">FnHandlerWrapper</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">f</span>: <span class="nc">F</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">_r</span>: <span class="nc">PhantomData</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nc">FnHandler</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">R</span>: <span class="nc">FromRequest</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">Handler</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">FnHandlerWrapper</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">handle</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">req</span>: <span class="nc">Request</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">R</span>::<span class="n">from</span><span class="p">(</span><span class="n">req</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">routes</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Handler</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">App</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">route</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">F</span>: <span class="nb">Fn</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Response</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">R</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FromRequest</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">routes</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">FnHandlerWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">_r</span>: <span class="nc">PhantomData</span><span class="w"> </span><span class="p">}));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249521255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249521255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AI <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249521255">(Aug 15 2021 at 16:46)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error[E0310]: the parameter type `R` may not live long enough
  --&gt; src/main.rs:51:19
   |
45 |     pub fn route&lt;F, R&gt;(&amp;mut self, f: F)
   |                     - help: consider adding an explicit lifetime bound...: `R: &#39;static`
...
51 |             .push(Box::new(FnHandlerWrapper { f, _r: PhantomData }));
   |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ ...so that the type `FnHandlerWrapper&lt;F, R&gt;` will meet its required lifetime bounds
</code></pre></div>



<a name="249561083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249561083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249561083">(Aug 16 2021 at 08:22)</a>:</h4>
<p>Ugh, right, <code>R</code> brings the lifetime with it...</p>



<a name="249561116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249561116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249561116">(Aug 16 2021 at 08:22)</a>:</h4>
<p>Also, <code>R: for&lt;'a&gt; FromRequest&lt;'a&gt;</code> is not that ideal since it kinda implies <code>R</code> needs to be <code>'static</code> anyway</p>



<a name="249561903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/249561903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#249561903">(Aug 16 2021 at 08:33)</a>:</h4>
<p>Ok, here's the fixed version: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c4cd22b0debf76cc7565690a25a38a56">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=c4cd22b0debf76cc7565690a25a38a56</a><br>
<code>R</code> is now a constructor for the actual type that implements <code>FromRequest&lt;'a&gt;</code> so it can be <code>'static</code> even if the type implementing <code>FromRequest&lt;'a&gt;</code> isn't</p>
<p>With GATs: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=7a1d18a3ea615313e3665bb80d0add80">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=7a1d18a3ea615313e3665bb80d0add80</a></p>



<a name="252395150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252395150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252395150">(Sep 08 2021 at 01:50)</a>:</h4>
<p>Hmm.. that's an interesting work-around <span class="user-mention" data-user-id="338379">@Giacomo Stevanato</span> .</p>



<a name="252395158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252395158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252395158">(Sep 08 2021 at 01:51)</a>:</h4>
<p>I was looking into something similar.</p>



<a name="252395169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252395169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252395169">(Sep 08 2021 at 01:51)</a>:</h4>
<p>Could you get rid of the 'static bounds here?</p>



<a name="252395347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252395347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252395347">(Sep 08 2021 at 01:54)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=901f99acbdaf08518c42391945d150c6">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=901f99acbdaf08518c42391945d150c6</a></p>



<a name="252396015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252396015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252396015">(Sep 08 2021 at 02:04)</a>:</h4>
<p>Actually, even the original example does not work with async_trait.</p>



<a name="252396020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252396020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252396020">(Sep 08 2021 at 02:04)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ed6353b156442b82136c7fdc891e55c4">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ed6353b156442b82136c7fdc891e55c4</a></p>



<a name="252396029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252396029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252396029">(Sep 08 2021 at 02:04)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">implementation</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="err">`</span><span class="n">Handler</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">general</span><span class="w"> </span><span class="n">enough</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">tester</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">69</span>:<span class="mi">26</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">69</span><span class="w"> </span><span class="o">|</span><span class="w">           </span><span class="bp">self</span><span class="p">.</span><span class="n">routes</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">FnHandlerWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">  </span><span class="n">__________________________</span><span class="o">^</span><span class="w"></span>
<span class="mi">70</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">f</span><span class="p">,</span><span class="w"></span>
<span class="mi">71</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">_r</span>: <span class="nc">PhantomData</span>::<span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="mi">72</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="p">}));</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="n">__________</span><span class="o">^</span><span class="w"> </span><span class="n">implementation</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="err">`</span><span class="n">Handler</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">general</span><span class="w"> </span><span class="n">enough</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="err">`</span><span class="n">FnHandlerWrapper</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">implement</span><span class="w"> </span><span class="err">`</span><span class="n">Handler</span><span class="o">&lt;'</span><span class="mi">0</span><span class="o">&gt;</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">any</span><span class="w"> </span><span class="n">lifetime</span><span class="w"> </span><span class="err">`</span><span class="o">'</span><span class="mi">0</span><span class="err">`</span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="o">..</span><span class="p">.</span><span class="n">but</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">actually</span><span class="w"> </span><span class="n">implements</span><span class="w"> </span><span class="err">`</span><span class="n">Handler</span><span class="o">&lt;'</span><span class="mi">1</span><span class="o">&gt;</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">specific</span><span class="w"> </span><span class="n">lifetime</span><span class="w"> </span><span class="err">`</span><span class="o">'</span><span class="mi">1</span><span class="err">`</span><span class="w"></span>
</code></pre></div>



<a name="252396183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252396183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252396183">(Sep 08 2021 at 02:07)</a>:</h4>
<p>Also, I wonder if there is away you could do this without exposing <code>RConstructor</code> so publicly.</p>



<a name="252419719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252419719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252419719">(Sep 08 2021 at 07:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="363998">Ibraheem Ahmed</span> <a href="#narrow/stream/122651-general/topic/Variance.20with.20'static.20bounds/near/252395169">said</a>:</p>
<blockquote>
<p>Could you get rid of the 'static bounds here?</p>
</blockquote>
<p>You need to add a lifetime to <code>App</code><br>
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=7d8b2585e9c22c3b0b33f1fbe4a8e643">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=7d8b2585e9c22c3b0b33f1fbe4a8e643</a></p>



<a name="252420045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252420045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252420045">(Sep 08 2021 at 07:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="363998">Ibraheem Ahmed</span> <a href="#narrow/stream/122651-general/topic/Variance.20with.20'static.20bounds/near/252396020">said</a>:</p>
<blockquote>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ed6353b156442b82136c7fdc891e55c4">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ed6353b156442b82136c7fdc891e55c4</a></p>
</blockquote>
<p>I'm not quite sure about what's going on here, IMO it should compile, however the bounds look complicated enough that this may be the compiler not being able to infer that the implementation of <code>Handler</code> applies for any lifetime <code>'a</code></p>



<a name="252452725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252452725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252452725">(Sep 08 2021 at 12:44)</a>:</h4>
<p>Yeah, the trait solver is easily confused when higher-order lifetimes are involved. Consider:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;'</span><span class="na">lt</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">type</span> <span class="nc">Assoc</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">type</span> <span class="nc">Assoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">_check</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="nb">__</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;'</span><span class="nb">__</span><span class="p">,</span><span class="w"> </span><span class="n">Assoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// OK</span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">any</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;'</span><span class="na">any</span><span class="o">&gt;&gt;</span>::<span class="n">Assoc</span><span class="w"> </span>: <span class="nb">Copy</span> <span class="c1">// Error</span>
<span class="w">    </span><span class="p">,</span><span class="w"></span>
<span class="p">{}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_check</span>::<span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>which fails when it has to check the higher-order constraint of <code>Copy</code> for <code>&lt;T as Trait&lt;'lt&gt;&gt;::Assoc</code>.</p>
<p>Basically, the moment a non-equality constraint involves <code>&lt;SomeTy as SomeTrait&lt;'higher_order&gt;&gt;::Assoc</code>, the bound is currently doomed not to be met.</p>



<a name="252454392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252454392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252454392">(Sep 08 2021 at 12:57)</a>:</h4>
<p>Though this particular example seems to compile on nightly now that <a href="https://github.com/rust-lang/rust/issues/85499">#85499</a> has been merged</p>



<a name="252488150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252488150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252488150">(Sep 08 2021 at 16:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="338379">Giacomo Stevanato</span> <a href="#narrow/stream/122651-general/topic/Variance.20with.20'static.20bounds/near/252419719">said</a>:</p>
<blockquote>
<p>You need to add a lifetime to <code>App</code><br>
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=7d8b2585e9c22c3b0b33f1fbe4a8e643">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=7d8b2585e9c22c3b0b33f1fbe4a8e643</a></p>
</blockquote>
<p>Hmm.. is it not possible without doing that?</p>



<a name="252505918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252505918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252505918">(Sep 08 2021 at 18:04)</a>:</h4>
<p>I need the app to be static.</p>



<a name="252586352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252586352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252586352">(Sep 09 2021 at 08:03)</a>:</h4>
<p>If you want to store a non-<code>'static</code> handler then you need to introduce that lifetime, otherwise <code>App</code> may outlive the handler and lead to an use-after-free of stuff like that when it calls the handler</p>



<a name="252607801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252607801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252607801">(Sep 09 2021 at 11:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="338379">Giacomo Stevanato</span> <a href="#narrow/stream/122651-general/topic/Variance.20with.20'static.20bounds/near/252586352">said</a>:</p>
<blockquote>
<p>If you want to store a non-<code>'static</code> handler then you need to introduce that lifetime, otherwise <code>App</code> may outlive the handler and lead to an use-after-free of stuff like that when it calls the handler</p>
</blockquote>
<p>The handler functions themselves are <code>'static</code> though, I just don't want the<code>FromRequest</code> implementations to be.</p>



<a name="252607856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252607856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252607856">(Sep 09 2021 at 11:14)</a>:</h4>
<p>It's the same problem.</p>



<a name="252770811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252770811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252770811">(Sep 10 2021 at 11:24)</a>:</h4>
<p>The handlers themselves are just static functions.</p>



<a name="252770885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Variance%20with%20%27static%20bounds/near/252770885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Variance.20with.20&#x27;static.20bounds.html#252770885">(Sep 10 2021 at 11:24)</a>:</h4>
<p>I want to allow this <code>fn foo&lt;'r&gt;(something_from_request: SomethingFromRequest&lt;'r&gt;)</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>