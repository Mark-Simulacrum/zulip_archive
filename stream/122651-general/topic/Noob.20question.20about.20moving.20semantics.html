<html>
<head><meta charset="utf-8"><title>Noob question about moving semantics · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html">Noob question about moving semantics</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257855836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257855836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257855836">(Oct 16 2021 at 19:43)</a>:</h4>
<p>Just wondering if there is an issue or PR related to the following situation -&gt; <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=a88d2630a3c914460a4bed80bb77b7ce">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=a88d2630a3c914460a4bed80bb77b7ce</a></p>



<a name="257859172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257859172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257859172">(Oct 16 2021 at 20:31)</a>:</h4>
<p>Hmm, aside from the reborrowing, it's surprising to me that</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">bar</span><span class="p">(</span><span class="n">foo_mut</span><span class="p">);</span><span class="w"></span>
<span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span>::<span class="n">from</span><span class="p">(</span><span class="n">foo_mut</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>works, but</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span>::<span class="n">from</span><span class="p">(</span><span class="n">foo_mut</span><span class="p">);</span><span class="w"></span>
<span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span>::<span class="n">from</span><span class="p">(</span><span class="n">foo_mut</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>does not.</p>



<a name="257864585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257864585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257864585">(Oct 16 2021 at 21:56)</a>:</h4>
<p>Hmm, but it does work with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&lt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Foo</span><span class="o">&gt;&gt;</span>::<span class="n">from</span><span class="p">(</span><span class="n">foo_mut</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="257864688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257864688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257864688">(Oct 16 2021 at 21:58)</a>:</h4>
<p>Like the initial ambiguity of <em>which</em> <code>From&lt;_&gt; for ()</code> somehow prevents reborrowing</p>



<a name="257865382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257865382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257865382">(Oct 16 2021 at 22:09)</a>:</h4>
<p>That's really bizarre. It looks like <code>&lt;() as From&lt;&amp;mut Foo&gt;&gt;::from(from_mut)</code> triggers a reborrow of <code>from_mut</code>? Here's a code diff and then a diff of the resulting MIR.</p>
<h3>Code</h3>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/unqual.rs b/fqs.rs</span>
<span class="gh">index 819833a..11dafb8 100644</span>
<span class="gd">--- a/unqual.rs</span>
<span class="gi">+++ b/fqs.rs</span>
<span class="gu">@@ -10,6 +10,6 @@ fn main() {</span>
     let mut foo = Foo;
     let foo_mut = &amp;mut foo;

<span class="gd">-    &lt;()&gt;::from(foo_mut);</span>
<span class="gi">+    &lt;() as From&lt;&amp;mut Foo&gt;&gt;::from(foo_mut);</span>
     &lt;()&gt;::from(foo_mut);
 }
</code></pre></div>
<h3>MIR</h3>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/mir_dump-unqual/unqual.main.-------.mir_map.0.mir b/mir_dump-fqs/fqs.main.-------.mir_map.0.mir</span>
<span class="gh">index 6a55834..379a7f1 100644</span>
<span class="gd">--- a/mir_dump-unqual/unqual.main.-------.mir_map.0.mir</span>
<span class="gi">+++ b/mir_dump-fqs/fqs.main.-------.mir_map.0.mir</span>
<span class="gu">@@ -1,64 +1,64 @@</span>
 // MIR for `main` 0 mir_map

 | User Type Annotations
<span class="gd">-| 0: Canonical { max_universe: U0, variables: [CanonicalVarInfo { kind: Ty(General(U0)) }], value: TypeOf(DefId(2:2912 ~ core[f488]::convert::From::from), UserSubsts { substs: [(), ^0], user_self_ty: None }) } at unqual.rs:13:5: 13:15</span>
<span class="gd">-| 1: Canonical { max_universe: U0, variables: [CanonicalVarInfo { kind: Ty(General(U0)) }], value: TypeOf(DefId(2:2912 ~ core[f488]::convert::From::from), UserSubsts { substs: [(), ^0], user_self_ty: None }) } at unqual.rs:14:5: 14:15</span>
<span class="gi">+| 0: Canonical { max_universe: U0, variables: [CanonicalVarInfo { kind: Region(U0) }], value: TypeOf(DefId(2:2912 ~ core[f488]::convert::From::from), UserSubsts { substs: [(), &amp;mut Foo], user_self_ty: None }) } at fqs.rs:13:5: 13:33</span>
<span class="gi">+| 1: Canonical { max_universe: U0, variables: [CanonicalVarInfo { kind: Ty(General(U0)) }], value: TypeOf(DefId(2:2912 ~ core[f488]::convert::From::from), UserSubsts { substs: [(), ^0], user_self_ty: None }) } at fqs.rs:14:5: 14:15</span>
 |
 fn main() -&gt; () {
<span class="gd">-    let mut _0: ();                      // return place in scope 0 at unqual.rs:9:11: 9:11</span>
<span class="gd">-    let mut _1: Foo;                     // in scope 0 at unqual.rs:10:9: 10:16</span>
<span class="gd">-    let _3: ();                          // in scope 0 at unqual.rs:13:5: 13:24</span>
<span class="gd">-    let mut _4: &amp;mut Foo;                // in scope 0 at unqual.rs:13:16: 13:23</span>
<span class="gd">-    let _5: ();                          // in scope 0 at unqual.rs:14:5: 14:24</span>
<span class="gd">-    let mut _6: &amp;mut Foo;                // in scope 0 at unqual.rs:14:16: 14:23</span>
<span class="gi">+    let mut _0: ();                      // return place in scope 0 at fqs.rs:9:11: 9:11</span>
<span class="gi">+    let mut _1: Foo;                     // in scope 0 at fqs.rs:10:9: 10:16</span>
<span class="gi">+    let _3: ();                          // in scope 0 at fqs.rs:13:5: 13:42</span>
<span class="gi">+    let mut _4: &amp;mut Foo;                // in scope 0 at fqs.rs:13:34: 13:41</span>
<span class="gi">+    let _5: ();                          // in scope 0 at fqs.rs:14:5: 14:24</span>
<span class="gi">+    let mut _6: &amp;mut Foo;                // in scope 0 at fqs.rs:14:16: 14:23</span>
     scope 1 {
<span class="gd">-        debug foo =&gt; _1;                 // in scope 1 at unqual.rs:10:9: 10:16</span>
<span class="gd">-        let _2: &amp;mut Foo;                // in scope 1 at unqual.rs:11:9: 11:16</span>
<span class="gi">+        debug foo =&gt; _1;                 // in scope 1 at fqs.rs:10:9: 10:16</span>
<span class="gi">+        let _2: &amp;mut Foo;                // in scope 1 at fqs.rs:11:9: 11:16</span>
         scope 2 {
<span class="gd">-            debug foo_mut =&gt; _2;         // in scope 2 at unqual.rs:11:9: 11:16</span>
<span class="gi">+            debug foo_mut =&gt; _2;         // in scope 2 at fqs.rs:11:9: 11:16</span>
         }
     }

     bb0: {
<span class="gd">-        StorageLive(_1);                 // scope 0 at unqual.rs:10:9: 10:16</span>
<span class="gd">-        _1 = Foo;                        // scope 0 at unqual.rs:10:19: 10:22</span>
<span class="gd">-        FakeRead(ForLet(None), _1);      // scope 0 at unqual.rs:10:9: 10:16</span>
<span class="gd">-        StorageLive(_2);                 // scope 1 at unqual.rs:11:9: 11:16</span>
<span class="gd">-        _2 = &amp;mut _1;                    // scope 1 at unqual.rs:11:19: 11:27</span>
<span class="gd">-        FakeRead(ForLet(None), _2);      // scope 1 at unqual.rs:11:9: 11:16</span>
<span class="gd">-        StorageLive(_3);                 // scope 2 at unqual.rs:13:5: 13:24</span>
<span class="gd">-        StorageLive(_4);                 // scope 2 at unqual.rs:13:16: 13:23</span>
<span class="gd">-        _4 = move _2;                    // scope 2 at unqual.rs:13:16: 13:23</span>
<span class="gd">-        _3 = &lt;() as From&lt;&amp;mut Foo&gt;&gt;::from(move _4) -&gt; [return: bb1, unwind: bb3]; // scope 2 at unqual.rs:13:5: 13:24</span>
<span class="gi">+        StorageLive(_1);                 // scope 0 at fqs.rs:10:9: 10:16</span>
<span class="gi">+        _1 = Foo;                        // scope 0 at fqs.rs:10:19: 10:22</span>
<span class="gi">+        FakeRead(ForLet(None), _1);      // scope 0 at fqs.rs:10:9: 10:16</span>
<span class="gi">+        StorageLive(_2);                 // scope 1 at fqs.rs:11:9: 11:16</span>
<span class="gi">+        _2 = &amp;mut _1;                    // scope 1 at fqs.rs:11:19: 11:27</span>
<span class="gi">+        FakeRead(ForLet(None), _2);      // scope 1 at fqs.rs:11:9: 11:16</span>
<span class="gi">+        StorageLive(_3);                 // scope 2 at fqs.rs:13:5: 13:42</span>
<span class="gi">+        StorageLive(_4);                 // scope 2 at fqs.rs:13:34: 13:41</span>
<span class="gi">+        _4 = &amp;mut (*_2);                 // scope 2 at fqs.rs:13:34: 13:41</span>
<span class="gi">+        _3 = &lt;() as From&lt;&amp;mut Foo&gt;&gt;::from(move _4) -&gt; [return: bb1, unwind: bb3]; // scope 2 at fqs.rs:13:5: 13:42</span>
                                          // mir::Constant
<span class="gd">-                                         // + span: unqual.rs:13:5: 13:15</span>
<span class="gi">+                                         // + span: fqs.rs:13:5: 13:33</span>
                                          // + user_ty: UserType(0)
                                          // + literal: Const { ty: fn(&amp;mut Foo) {&lt;() as std::convert::From&lt;&amp;mut Foo&gt;&gt;::from}, val: Value(Scalar(&lt;ZST&gt;)) }
     }

     bb1: {
<span class="gd">-        StorageDead(_4);                 // scope 2 at unqual.rs:13:23: 13:24</span>
<span class="gd">-        StorageDead(_3);                 // scope 2 at unqual.rs:13:24: 13:25</span>
<span class="gd">-        StorageLive(_5);                 // scope 2 at unqual.rs:14:5: 14:24</span>
<span class="gd">-        StorageLive(_6);                 // scope 2 at unqual.rs:14:16: 14:23</span>
<span class="gd">-        _6 = move _2;                    // scope 2 at unqual.rs:14:16: 14:23</span>
<span class="gd">-        _5 = &lt;() as From&lt;&amp;mut Foo&gt;&gt;::from(move _6) -&gt; [return: bb2, unwind: bb3]; // scope 2 at unqual.rs:14:5: 14:24</span>
<span class="gi">+        StorageDead(_4);                 // scope 2 at fqs.rs:13:41: 13:42</span>
<span class="gi">+        StorageDead(_3);                 // scope 2 at fqs.rs:13:42: 13:43</span>
<span class="gi">+        StorageLive(_5);                 // scope 2 at fqs.rs:14:5: 14:24</span>
<span class="gi">+        StorageLive(_6);                 // scope 2 at fqs.rs:14:16: 14:23</span>
<span class="gi">+        _6 = move _2;                    // scope 2 at fqs.rs:14:16: 14:23</span>
<span class="gi">+        _5 = &lt;() as From&lt;&amp;mut Foo&gt;&gt;::from(move _6) -&gt; [return: bb2, unwind: bb3]; // scope 2 at fqs.rs:14:5: 14:24</span>
                                          // mir::Constant
<span class="gd">-                                         // + span: unqual.rs:14:5: 14:15</span>
<span class="gi">+                                         // + span: fqs.rs:14:5: 14:15</span>
                                          // + user_ty: UserType(1)
                                          // + literal: Const { ty: fn(&amp;mut Foo) {&lt;() as std::convert::From&lt;&amp;mut Foo&gt;&gt;::from}, val: Value(Scalar(&lt;ZST&gt;)) }
     }

     bb2: {
<span class="gd">-        StorageDead(_6);                 // scope 2 at unqual.rs:14:23: 14:24</span>
<span class="gd">-        StorageDead(_5);                 // scope 2 at unqual.rs:14:24: 14:25</span>
<span class="gd">-        _0 = const ();                   // scope 0 at unqual.rs:9:11: 15:2</span>
<span class="gd">-        StorageDead(_2);                 // scope 1 at unqual.rs:15:1: 15:2</span>
<span class="gd">-        StorageDead(_1);                 // scope 0 at unqual.rs:15:1: 15:2</span>
<span class="gd">-        return;                          // scope 0 at unqual.rs:15:2: 15:2</span>
<span class="gi">+        StorageDead(_6);                 // scope 2 at fqs.rs:14:23: 14:24</span>
<span class="gi">+        StorageDead(_5);                 // scope 2 at fqs.rs:14:24: 14:25</span>
<span class="gi">+        _0 = const ();                   // scope 0 at fqs.rs:9:11: 15:2</span>
<span class="gi">+        StorageDead(_2);                 // scope 1 at fqs.rs:15:1: 15:2</span>
<span class="gi">+        StorageDead(_1);                 // scope 0 at fqs.rs:15:1: 15:2</span>
<span class="gi">+        return;                          // scope 0 at fqs.rs:15:2: 15:2</span>
     }

     bb3 (cleanup): {
<span class="gd">-        resume;                          // scope 0 at unqual.rs:9:1: 15:2</span>
<span class="gi">+        resume;                          // scope 0 at fqs.rs:9:1: 15:2</span>
     }
 }
</code></pre></div>



<a name="257865477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257865477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257865477">(Oct 16 2021 at 22:10)</a>:</h4>
<p>Maybe it is worth creating an issue</p>



<a name="257865607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257865607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257865607">(Oct 16 2021 at 22:12)</a>:</h4>
<p>Yeah, I think that'd be a good idea, at least to be able to discuss this more easily. Do you want to open one?</p>



<a name="257865643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257865643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257865643">(Oct 16 2021 at 22:13)</a>:</h4>
<p>I can if no-one is willing to do so :P</p>



<a name="257865670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257865670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257865670">(Oct 16 2021 at 22:13)</a>:</h4>
<p>I can do it, but you first noticed this, so I thought you might want to :)</p>



<a name="257865773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257865773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257865773">(Oct 16 2021 at 22:14)</a>:</h4>
<p>Nah... I am fine... FWICT, this issue will be hanging forever until someone steps up to solve it</p>



<a name="257865805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257865805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257865805">(Oct 16 2021 at 22:15)</a>:</h4>
<p>Perhaps, but it's still worth tracking :)</p>
<p>I'll open an issue then.</p>



<a name="257866265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257866265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257866265">(Oct 16 2021 at 22:22)</a>:</h4>
<p>Well, type inference inhibits coercion</p>



<a name="257866289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257866289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257866289">(Oct 16 2021 at 22:22)</a>:</h4>
<p>And reborrowing is one kind of coercion</p>



<a name="257866420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Noob%20question%20about%20moving%20semantics/near/257866420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Noob.20question.20about.20moving.20semantics.html#257866420">(Oct 16 2021 at 22:24)</a>:</h4>
<p>Opened <a href="https://github.com/rust-lang/rust/issues/89966">#89966</a>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>