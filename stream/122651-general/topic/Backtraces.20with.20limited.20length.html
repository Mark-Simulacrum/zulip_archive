<html>
<head><meta charset="utf-8"><title>Backtraces with limited length · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Backtraces.20with.20limited.20length.html">Backtraces with limited length</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263247639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Backtraces%20with%20limited%20length/near/263247639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Backtraces.20with.20limited.20length.html#263247639">(Dec 01 2021 at 05:51)</a>:</h4>
<p>I would like to call <code>backtrace::Backtrace::new_unresolved()</code>, but limit it to a certain number of stack frames. AFAICT there is no easy way to do this. I can use <code>backtrace::trace</code> and stop after a certain number of frame, but parts of <code>Backtrace</code>'s internals aren't public, so I can't create a <code>Backtrace</code> myself.</p>
<p>So it seems like I'll need to create my own <code>ShortBacktrace</code> type. I think it's doable, but it'll require duplicating a bunch of <code>Backtrace's</code> internals for storing frames, resolving them later, printing them nicely, etc. Unless I'm overlooking something?</p>



<a name="263247911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Backtraces%20with%20limited%20length/near/263247911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Backtraces.20with.20limited.20length.html#263247911">(Dec 01 2021 at 05:57)</a>:</h4>
<p>(If you're wondering why I'm asking this, it's for <a href="https://github.com/nnethercote/dhat-rs/">https://github.com/nnethercote/dhat-rs/</a>. It gets <em>many</em> backtraces, which is the major source of overhead. But you never need to look past the top 10 or maybe 20 frames. Given that in big programs the stack can easily exceed 100 frames, limiting the depth will help speed a lot.)</p>



<a name="263257400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Backtraces%20with%20limited%20length/near/263257400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Backtraces.20with.20limited.20length.html#263257400">(Dec 01 2021 at 08:25)</a>:</h4>
<p>You can use BacktraceFmt to print the individual frames when using <code>trace</code>.</p>



<a name="263379602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Backtraces%20with%20limited%20length/near/263379602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Backtraces.20with.20limited.20length.html#263379602">(Dec 02 2021 at 00:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116015">@Alex Crichton</span> pointed me in the right direction: turns out <code>From&lt;Frame&gt; for BacktraceFrame</code> and <code>From&lt;Vec&lt;BacktraceFrame&gt;&gt; for Backtrace</code> exist in recent versions of <code>backtrace</code>, which makes it easy:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">fn</span> <span class="nf">new_unresolved</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">frames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">backtrace</span>::<span class="n">trace</span><span class="p">(</span><span class="o">|</span><span class="n">frame</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">frames</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">clone</span><span class="p">().</span><span class="n">into</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">frames</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="c1">// stop after this many frames</span>
<span class="w">        </span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="n">Backtrace</span><span class="p">(</span><span class="n">frames</span><span class="p">.</span><span class="n">into</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>