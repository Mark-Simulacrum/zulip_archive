<html>
<head><meta charset="utf-8"><title>Understanding intra-crate build times · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html">Understanding intra-crate build times</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254216008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254216008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254216008">(Sep 21 2021 at 14:27)</a>:</h4>
<p>I know that there's the great <code>cargo -Z timings</code> to understand how your build time is spent across crates, but how can I break down the build time <em>within</em> a crate.</p>
<p>My main crate takes 13s to build, which sure isn't the end of the world but could be better, and I'd like to understand where that time is going so I can do any low-hanging work</p>



<a name="254216141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254216141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254216141">(Sep 21 2021 at 14:28)</a>:</h4>
<p><a href="https://github.com/rust-lang/measureme/">https://github.com/rust-lang/measureme/</a> helps, but it's not always useful</p>



<a name="254216212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254216212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254216212">(Sep 21 2021 at 14:28)</a>:</h4>
<p>Is <code>cargo clean -p crate_name; cargo check</code> considerably faster? If yes, <code>self-profile</code> probably won't help much.</p>



<a name="254216632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254216632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254216632">(Sep 21 2021 at 14:31)</a>:</h4>
<p>Other tips are disabling/reducing debug info (but that's disabled on release) and using the <code>lld</code> linker, which is faster (especially when you have debug info enabled)</p>



<a name="254217006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254217006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254217006">(Sep 21 2021 at 14:33)</a>:</h4>
<p>So if <code>cargo check</code> is slow, it's probably something that <code>rustc</code> doesn't like and <code>self-profile</code> helps. If it's slow with debug info and fast without it, it's the debug info and/or the linker. If <code>cargo check</code> is fast and <code>cargo build</code> is slow even without debug info and with <code>lld</code>, it's probably spending time in LLVM, but <code>self-profile</code> won't tell you why.</p>



<a name="254217170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254217170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254217170">(Sep 21 2021 at 14:34)</a>:</h4>
<p><code>cargo-llvm-lines</code> and <code>cargo-bloat</code> can help too, they will pinpoint functions with a lot of LLVM IR or compiled code.</p>



<a name="254225116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254225116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254225116">(Sep 21 2021 at 15:20)</a>:</h4>
<p><span class="user-mention" data-user-id="203546">@Laurențiu</span> this is an amazing summary <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span> would you be interested in putting this in the rust performance book?<br>
<a href="https://nnethercote.github.io/perf-book/">https://nnethercote.github.io/perf-book/</a></p>



<a name="254225294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254225294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254225294">(Sep 21 2021 at 15:21)</a>:</h4>
<p>Maybe? But I think most of it is already in there, including <code>cargo-llvm-lines</code></p>



<a name="254233370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254233370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254233370">(Sep 21 2021 at 16:08)</a>:</h4>
<p>Is there anyway to get link times from rustc?</p>



<a name="254233484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254233484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254233484">(Sep 21 2021 at 16:08)</a>:</h4>
<p>I have a hunch it’s an issue since I’m linking a rustc driver which thus links against a bunch of large rustc cratea</p>



<a name="254233570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254233570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254233570">(Sep 21 2021 at 16:09)</a>:</h4>
<p>I suppose I can also just try lld on my Linux box</p>



<a name="254234975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254234975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254234975">(Sep 21 2021 at 16:18)</a>:</h4>
<p>Hmm, I'm not sure how linking shows up in <code>self-profile</code>. It probably does, but..</p>



<a name="254235434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254235434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254235434">(Sep 21 2021 at 16:21)</a>:</h4>
<p><span class="user-mention" data-user-id="203546">@Laurențiu</span> it does, not from queries but from miscellaneous interval tracking (that is, there is manual code somewhere around that part). you can see it show up on <a href="http://perf.rust-lang.org">perf.rust-lang.org</a> (alongside with various aspects of our use of LLVM) in the "query" view</p>



<a name="254235803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254235803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254235803">(Sep 21 2021 at 16:23)</a>:</h4>
<p>e.g. <a href="https://perf.rust-lang.org/detailed-query.html?commit=49c0861ed0fa1d95186d88df0cd4310103e70957&amp;base_commit=e7958d35ca2c898a223efe402481e0ecb854310a&amp;benchmark=unused-warnings-opt&amp;run_name=full">https://perf.rust-lang.org/detailed-query.html?commit=49c0861ed0fa1d95186d88df0cd4310103e70957&amp;base_commit=e7958d35ca2c898a223efe402481e0ecb854310a&amp;benchmark=unused-warnings-opt&amp;run_name=full</a></p>



<a name="254235816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254235816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254235816">(Sep 21 2021 at 16:23)</a>:</h4>
<p>you can see <code>run_linker</code> at the top</p>



<a name="254235912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254235912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254235912">(Sep 21 2021 at 16:24)</a>:</h4>
<p>(<code>expand_crate</code>, <code>parse_crate</code> etc. are also manual in the same sense, and not part of queries)</p>



<a name="254237307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254237307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254237307">(Sep 21 2021 at 16:33)</a>:</h4>
<p><a href="/user_uploads/4715/b3HglIheoM2-DBnSl9XLXZZ3/image.png">image.png</a>  Yeah, it's there.</p>
<div class="message_inline_image"><a href="/user_uploads/4715/b3HglIheoM2-DBnSl9XLXZZ3/image.png" title="image.png"><img src="/user_uploads/4715/b3HglIheoM2-DBnSl9XLXZZ3/image.png"></a></div>



<a name="254237593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254237593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254237593">(Sep 21 2021 at 16:35)</a>:</h4>
<p>You can also use <code>-Ztime-passes</code> and then grep for link_binary.</p>



<a name="254238431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254238431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254238431">(Sep 21 2021 at 16:40)</a>:</h4>
<p>Oh, that's nicer than running <code>crox</code> and starting Chrome</p>



<a name="254239496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254239496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254239496">(Sep 21 2021 at 16:46)</a>:</h4>
<p><code>-Zself-profile-events=llvm</code> also sounds nice, but <code>-Znew-llvm-pass-manager</code> <code>SIGSEGV</code>s on my machine</p>



<a name="254246513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Understanding%20intra-crate%20build%20times/near/254246513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Understanding.20intra-crate.20build.20times.html#254246513">(Sep 21 2021 at 17:31)</a>:</h4>
<p>you don't have to run crox and launch chrome btw, you can use <code>summarize</code> to display this data as a list of text, and can grep that as well. More info here <a href="https://github.com/rust-lang/measureme/blob/master/summarize/Readme.md">https://github.com/rust-lang/measureme/blob/master/summarize/Readme.md</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>