<html>
<head><meta charset="utf-8"><title>Surprising behaviour with #[path] and block scopes · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Surprising.20behaviour.20with.20.23.5Bpath.5D.20and.20block.20scopes.html">Surprising behaviour with #[path] and block scopes</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274989107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Surprising%20behaviour%20with%20%23%5Bpath%5D%20and%20block%20scopes/near/274989107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Surprising.20behaviour.20with.20.23.5Bpath.5D.20and.20block.20scopes.html#274989107">(Mar 11 2022 at 15:21)</a>:</h4>
<p>I managed to find a (at least to me) surprising behavior when combining modules, block scopes and the <code>#[path = ".."]</code> attribute.</p>
<p>It involves two files so no playground link but the gist is the following:</p>
<p>Given a <code>lib.rs</code> or <code>main.rs</code> with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span> <span class="nn">outline</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>With <code>outline.rs</code> defined as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">mod</span> <span class="nn">inline</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[path = </span><span class="s">"pathed.rs"</span><span class="cp">]</span><span class="w"></span>
<span class="w">        </span><span class="k">mod</span> <span class="nn">pathed</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>rust attempts to load <code>src/inline/pathed.rs</code> ( no <code>outline</code> in the path), which makes sense given that the module path doesn't leak outside the const's scope.</p>
<p>But with <code>outline.rs</code> defined as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span> <span class="nn">inline</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">mod</span> <span class="nn">inline</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cp">#[path = </span><span class="s">"pathed.rs"</span><span class="cp">]</span><span class="w"></span>
<span class="w">            </span><span class="k">mod</span> <span class="nn">pathed</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>rust suddently attempts to load <code>src/outline/inline/inline/pathed.rs</code>, though I would expect it to try to load <code>src/inline/inline/pathed.rs</code> instead. Note how having the const item inside of an inline module brings back the source files module into the path.</p>
<p>Is this expected and noted down somewhere? This looks like some rather inconsistent behavior making it sound like a bug to me.<br>
(Note that I am not attempting to use this mess in a code base, I was just trying to find the limits of rust's module system <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span>)</p>



<a name="274993065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Surprising%20behaviour%20with%20%23%5Bpath%5D%20and%20block%20scopes/near/274993065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Surprising.20behaviour.20with.20.23.5Bpath.5D.20and.20block.20scopes.html#274993065">(Mar 11 2022 at 15:55)</a>:</h4>
<p>I think the answer is that it is complicated.  When <code>#[path]</code> is used inside an inline module, it changes the behavior to include the module name (and in the inline names). And to make that more complicated, it depends on if it is a <code>mod.rs</code> file or a non-mod-rs.</p>
<p>What is interesting in your example is that it includes anonymous modules.  That does seem to be a bit surprising that they change the behavior that way.  I think one way to look at it is that the anonymous module is behaving similarly to a <code>mod.rs</code>, where it does not include the path of the module it is located in.</p>
<p>There is some documentation in the <a href="https://doc.rust-lang.org/nightly/reference/items/modules.html#the-path-attribute">path attribute docs</a>, but it does not discuss anonymous modules at all.  It might be good to extend that.</p>
<p>In general, I wish modules weren't allowed inside blocks.</p>



<a name="274994482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Surprising%20behaviour%20with%20%23%5Bpath%5D%20and%20block%20scopes/near/274994482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Surprising.20behaviour.20with.20.23.5Bpath.5D.20and.20block.20scopes.html#274994482">(Mar 11 2022 at 16:03)</a>:</h4>
<p>Ye the reference is what I used to source most of my information from, but it didn't state anything about how all of this works inside items with bodies.</p>
<p>Just wanted to bring it up in case this (my second snippet that is) sounds like a bug, which it at least does for me.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>