<html>
<head><meta charset="utf-8"><title>Vectorization not done for &quot;x in a&quot; · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Vectorization.20not.20done.20for.20.22x.20in.20a.22.html">Vectorization not done for &quot;x in a&quot;</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259801635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Vectorization%20not%20done%20for%20%22x%20in%20a%22/near/259801635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Vectorization.20not.20done.20for.20.22x.20in.20a.22.html#259801635">(Oct 31 2021 at 18:37)</a>:</h4>
<p>I have some simple code where vectorization works for <code>for i in 0..a.len() { let x = a[i] }</code> but not for <code>for x in a</code> (<a href="https://godbolt.org/z/Y8boc71oT">https://godbolt.org/z/Y8boc71oT</a>). Is there some difference between these two or is this just some weakness in the optimizer?</p>



<a name="259801721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Vectorization%20not%20done%20for%20%22x%20in%20a%22/near/259801721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Vectorization.20not.20done.20for.20.22x.20in.20a.22.html#259801721">(Oct 31 2021 at 18:39)</a>:</h4>
<p><code>for x in a</code> desugars into something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">into_iter</span><span class="p">();</span><span class="w"></span>
<span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>so it doesn't use indexing. That could be preventing LLVM from optimizing it.</p>



<a name="259801870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Vectorization%20not%20done%20for%20%22x%20in%20a%22/near/259801870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Vectorization.20not.20done.20for.20.22x.20in.20a.22.html#259801870">(Oct 31 2021 at 18:42)</a>:</h4>
<p>if you iterate by</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// &lt;--</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>then LLVM will use SIMD.</p>



<a name="259801894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Vectorization%20not%20done%20for%20%22x%20in%20a%22/near/259801894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Vectorization.20not.20done.20for.20.22x.20in.20a.22.html#259801894">(Oct 31 2021 at 18:43)</a>:</h4>
<p>so the issue is the optimizer cannot handle <code>array::IntoIter</code>.</p>



<a name="259801983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Vectorization%20not%20done%20for%20%22x%20in%20a%22/near/259801983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Vectorization.20not.20done.20for.20.22x.20in.20a.22.html#259801983">(Oct 31 2021 at 18:45)</a>:</h4>
<p>it also works if you do <code>a.into_iter().for_each(|x| ...)</code></p>



<a name="259802132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Vectorization%20not%20done%20for%20%22x%20in%20a%22/near/259802132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Vectorization.20not.20done.20for.20.22x.20in.20a.22.html#259802132">(Oct 31 2021 at 18:49)</a>:</h4>
<p>sadly that does some extra memcpy when using array::IntoIter instead of the slice iter. not sure why that's not optimized out.</p>



<a name="259802196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Vectorization%20not%20done%20for%20%22x%20in%20a%22/near/259802196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Vectorization.20not.20done.20for.20.22x.20in.20a.22.html#259802196">(Oct 31 2021 at 18:50)</a>:</h4>
<p>in that particular case <code>a.iter().sum()</code> would be more idiomatic anyway</p>



<a name="259816068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Vectorization%20not%20done%20for%20%22x%20in%20a%22/near/259816068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Vectorization.20not.20done.20for.20.22x.20in.20a.22.html#259816068">(Nov 01 2021 at 00:12)</a>:</h4>
<p><code>ManuallyDrop</code> and <code>MaybeUninit</code> aren't as invisible as we'd like -- your mention of extra <code>memcpy</code> makes me think &lt;<a href="https://github.com/rust-lang/rust/issues/79914">https://github.com/rust-lang/rust/issues/79914</a>&gt; -- so that might have something to do with it.</p>
<p>I also don't know if <code>array::IntoIter</code> has all the special marker traits that the slice ones do.  That might be worth checking.</p>



<a name="259816290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Vectorization%20not%20done%20for%20%22x%20in%20a%22/near/259816290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Vectorization.20not.20done.20for.20.22x.20in.20a.22.html#259816290">(Nov 01 2021 at 00:18)</a>:</h4>
<p>marker traits aren't used in the for loop desugaring</p>



<a name="259817056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Vectorization%20not%20done%20for%20%22x%20in%20a%22/near/259817056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Vectorization.20not.20done.20for.20.22x.20in.20a.22.html#259817056">(Nov 01 2021 at 00:38)</a>:</h4>
<p>Right, good point.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>