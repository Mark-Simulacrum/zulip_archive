<html>
<head><meta charset="utf-8"><title>Why do disjoint captures differ for refs and owned values? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html">Why do disjoint captures differ for refs and owned values?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278056652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278056652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278056652">(Apr 06 2022 at 17:15)</a>:</h4>
<p><a href="https://stackoverflow.com/q/71771005/155423">Why does moving a disjoint field capture into a closure differ when the type is a value vs a reference?</a></p>
<p>TL;DR:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Wrapper</span><span class="p">(</span><span class="kt">i32</span><span class="p">);</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">this_works</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">captured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Wrapper</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">value</span><span class="o">|</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">captured</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">why_doesnt_this</span><span class="p">(</span><span class="n">captured</span>: <span class="kp">&amp;</span><span class="nc">Wrapper</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">value</span><span class="o">|</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">captured</span><span class="p">.</span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278061032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278061032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278061032">(Apr 06 2022 at 17:49)</a>:</h4>
<p>I believe what happens is that the reference <code>captured</code> in the second example, the reference gets moved into the closure, which requires annotating the <code>impl FnOnce</code> with a lifetime to represent that reference.</p>
<p>There's a little information here: <a href="https://github.com/rust-lang/reference/blob/44f6e1e20f40dddf1b5e9aa002d5cd6e7a629663/src/types/closure.md#capturing-references-in-move-contexts">https://github.com/rust-lang/reference/blob/44f6e1e20f40dddf1b5e9aa002d5cd6e7a629663/src/types/closure.md#capturing-references-in-move-contexts</a></p>



<a name="278061638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278061638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278061638">(Apr 06 2022 at 17:54)</a>:</h4>
<blockquote>
<p>the reference gets moved into the closure</p>
</blockquote>
<p>Sure, but why? The <em>owned</em> value isn't moved into the closure — rather the point of the feature.</p>



<a name="278061869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278061869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278061869">(Apr 06 2022 at 17:56)</a>:</h4>
<p>Yea, I'm not sure why. It seems like it could just copy the field and not capture the reference.  I'm looking through the rfc 2229 notes, but I'm not seeing where this particular case is discussed.</p>



<a name="278062042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278062042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278062042">(Apr 06 2022 at 17:57)</a>:</h4>
<p><span class="user-mention" data-user-id="120518">@Eric Huss</span> </p>
<blockquote>
<p>This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.</p>
</blockquote>
<p>Is this from a PR?</p>



<a name="278062737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278062737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278062737">(Apr 06 2022 at 18:03)</a>:</h4>
<p><a href="https://github.com/rust-lang/reference/pull/1059">https://github.com/rust-lang/reference/pull/1059</a></p>



<a name="278066449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278066449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278066449">(Apr 06 2022 at 18:27)</a>:</h4>
<p>Thinking about it some more, I think it makes sense to capture the reference.  Otherwise you could have a situation like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Wrapper</span><span class="p">(</span><span class="mi">123</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">closure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">why_doesnt_this</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">456</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">closure</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>If it didn't capture the reference, then the closure would have an old copy of the field (123).  It seems like it could lead to some ambiguity in what the author intended.</p>



<a name="278069442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278069442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278069442">(Apr 06 2022 at 18:52)</a>:</h4>
<p>A SO answer proposes that since a reference is moved in, so should any field derived from a reference (my re-wording).</p>



<a name="278069587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278069587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278069587">(Apr 06 2022 at 18:53)</a>:</h4>
<p>e.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">drop</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="c1">// moves in the `&amp;i32`</span>
</code></pre></div>
<p>therefore</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Wrapper</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">drop</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// moves in the `&amp;i32`</span>
</code></pre></div>



<a name="278070405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278070405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278070405">(Apr 06 2022 at 19:00)</a>:</h4>
<p>I disagree with your example though, as it's not really compelling. You can have that behavior now</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">why_doesnt_this</span><span class="p">(</span><span class="n">captured</span>: <span class="kp">&amp;</span><span class="nc">Wrapper</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">captured</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">value</span><span class="o">|</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278174876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278174876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278174876">(Apr 07 2022 at 14:48)</a>:</h4>
<p>We really need <strong>fine-frained <code>move</code></strong> annotations, not the current situation with the compiler's best-effort heuristics, which just can't be good enough in some cases:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">why_doesnt_this</span><span class="p">(</span><span class="n">captured</span>: <span class="kp">&amp;</span><span class="nc">Wrapper</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">move</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">captured</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="n">value</span><span class="o">|</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="278175472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Why%20do%20disjoint%20captures%20differ%20for%20refs%20and%20owned%20values%3F/near/278175472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F.html#278175472">(Apr 07 2022 at 14:52)</a>:</h4>
<p>But yeah, the current heuristic, barring the new 2021-captures and its "place optimizations", is that the <code>move</code> modifier interacts with variable names <em>mentioned</em> inside the closure's body, "no matter how" (again, 2021 makes the situation even more complex). </p>
<p>This effectively leads to what <span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/122651-general/topic/Why.20do.20disjoint.20captures.20differ.20for.20refs.20and.20owned.20values.3F/near/278069587">said</a>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>