<html>
<head><meta charset="utf-8"><title>Slim Vec · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html">Slim Vec</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262020419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262020419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262020419">(Nov 19 2021 at 02:35)</a>:</h4>
<p><code>Vec</code> is three words: len, capacity, and a (possibly null) pointer to the heap-allocated elements.<br>
An alternative arrangement would be a single word, that is a possibly null pointer to a heap-allocated trio of (len, capacity, elements).<br>
This is potentially beneficial if you need a vector within a struct that you want to be as small as possible. (<code>rustc_ast::ast::Path</code>'s <code>segments</code> field is my motivation here.)<br>
Anyone know if such a type has been implemented?</p>



<a name="262020484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262020484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262020484">(Nov 19 2021 at 02:37)</a>:</h4>
<p>(I do know about <code>ThinVec</code> within rustc: <code>struct ThinVec&lt;T&gt;(Option&lt;Box&lt;Vec&lt;T&gt;&gt;&gt;);</code></p>



<a name="262020499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262020499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262020499">(Nov 19 2021 at 02:37)</a>:</h4>
<p>It is also just a single word, but if you have a non-zero number of elements it requires two allocations, so it's best for cases where zero elements is the common case.)</p>



<a name="262020582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262020582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262020582">(Nov 19 2021 at 02:39)</a>:</h4>
<p>There's a PR for ThinBox&lt;Dyn&gt; <a href="https://github.com/rust-lang/rust/issues/90066">#90066</a> which could also store slices.</p>



<a name="262020649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262020649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262020649">(Nov 19 2021 at 02:40)</a>:</h4>
<p>Would that allow the vec to grow and shrink if needed?</p>



<a name="262020726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262020726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262020726">(Nov 19 2021 at 02:42)</a>:</h4>
<p>(Similarly, a boxed slice gets you down to two elements, which is an improvement, but isn't suitable if the number of elements can change)</p>



<a name="262020847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262020847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262020847">(Nov 19 2021 at 02:44)</a>:</h4>
<p>I think you could put this inside the ThinBox</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">DstVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">len</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="n">elements</span>: <span class="p">[</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the dyn metadata would carry the capacity and the field the length.</p>



<a name="262020873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262020873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262020873">(Nov 19 2021 at 02:45)</a>:</h4>
<p>Not 100% sure if it would work since that's combining a bunch of exotic features.</p>



<a name="262020967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262020967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262020967">(Nov 19 2021 at 02:47)</a>:</h4>
<p>Might be easier just to implement what I described directly <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>  It would subsume <code>ThinVec</code></p>



<a name="262021174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262021174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262021174">(Nov 19 2021 at 02:52)</a>:</h4>
<p>the downside compared to thinvec is that converting it to a proper vec would be expensive in the general case. you could get lucky where the cap/length can be reinterpreted as some extra capacity.</p>



<a name="262021182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262021182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262021182">(Nov 19 2021 at 02:52)</a>:</h4>
<p>but even then it'd require moving stuff to the front</p>



<a name="262021221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262021221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262021221">(Nov 19 2021 at 02:53)</a>:</h4>
<p>hrrm, maybe not if you'd point to the end of the struct, then cap/len could sit at the end and be reinterpreted.</p>



<a name="262021268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262021268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262021268">(Nov 19 2021 at 02:54)</a>:</h4>
<p>and with some extra padding... yeah... this could work</p>



<a name="262021359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262021359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262021359">(Nov 19 2021 at 02:57)</a>:</h4>
<p>At least for the <code>Path</code> case, conversion to/from <code>Vec</code> isn't common</p>



<a name="262021423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262021423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262021423">(Nov 19 2021 at 02:58)</a>:</h4>
<p>if you have free conversion from/to vec then you can delegate IntoIterator and FromIterator to the Vec impls which are quite optimized.</p>



<a name="262056058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262056058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> panstromek <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262056058">(Nov 19 2021 at 11:43)</a>:</h4>
<p>There's a <code>thin_vec</code> crate,  have you seen that one? It seems to be implemented that way.</p>



<a name="262062573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262062573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> panstromek <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262062573">(Nov 19 2021 at 12:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/122651-general/topic/Slim.20Vec/near/262021221">said</a>:</p>
<blockquote>
<p>hrrm, maybe not if you'd point to the end of the struct, then cap/len could sit at the end and be reinterpreted.</p>
</blockquote>
<p>This seems like fun thing to try to implement. I tried to play around with it for a while and into_vec is pretty simple to do, but from_vec has quite a few edge cases, based on the alignment and how much eccesive capacity does the original vec have. In the worst case it has to relocate anyway.</p>



<a name="262106787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262106787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262106787">(Nov 19 2021 at 18:18)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> Seems like a good idea to me. If you're going to have an indirection anyway, though, it might make sense to store the elements inline at the destination, to avoid a second indirection.</p>



<a name="262106839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262106839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262106839">(Nov 19 2021 at 18:19)</a>:</h4>
<p>len, capacity, elem0, elem1, ...</p>



<a name="262115124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262115124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262115124">(Nov 19 2021 at 19:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="208862">panstromek</span> <a href="#narrow/stream/122651-general/topic/Slim.20Vec/near/262062573">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/122651-general/topic/Slim.20Vec/near/262021221">said</a>:</p>
<blockquote>
<p>hrrm, maybe not if you'd point to the end of the struct, then cap/len could sit at the end and be reinterpreted.</p>
</blockquote>
<p>This seems like fun thing to try to implement. I tried to play around with it for a while and into_vec is pretty simple to do, but from_vec has quite a few edge cases, based on the alignment and how much eccesive capacity does the original vec have. In the worst case it has to relocate anyway.</p>
</blockquote>
<p>Storing cap/length in an unaligned manner could get us a bit further. But that performance tradeoff may not be worth it.</p>



<a name="262138564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262138564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262138564">(Nov 19 2021 at 22:20)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I think what you described is exactly what I was intending. A non-empty SlimVec would have a single heap allocation</p>



<a name="262140230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Slim%20Vec/near/262140230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Slim.20Vec.html#262140230">(Nov 19 2021 at 22:34)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> Ah, I misunderstood then. When you said <code>(len, capacity, elements)</code>, I thought <code>elements</code> was a pointer.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>