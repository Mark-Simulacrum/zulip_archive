<html>
<head><meta charset="utf-8"><title>cargo clean · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html">cargo clean</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272808183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272808183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tejas Ravishankar <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272808183">(Feb 22 2022 at 14:16)</a>:</h4>
<p>Hey everyone, just released <a href="https://github.com/XtremeDevX/turbo-delete">https://github.com/XtremeDevX/turbo-delete</a> which can delete folders way faster than <code>cargo clean</code> on windows.</p>
<p>Would you be open to considering a PR to use this for <code>cargo clean</code> if I made it a crate?</p>
<p>Here's hyperfine benchmarks:<br>
<a href="/user_uploads/4715/4NvHsX5XOMs9LGQ-1LMe7E1M/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/4715/4NvHsX5XOMs9LGQ-1LMe7E1M/image.png" title="image.png"><img src="/user_uploads/4715/4NvHsX5XOMs9LGQ-1LMe7E1M/image.png"></a></div><blockquote>
<p>hyperfine 'td ./target' 'cargo clean' --prepare 'cargo check' --show-output<br>
That was the command I used to test it out!</p>
</blockquote>



<a name="272809290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272809290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272809290">(Feb 22 2022 at 14:24)</a>:</h4>
<p>you might try asking over in <a class="stream" data-stream-id="246057" href="/#narrow/stream/246057-t-cargo">#t-cargo</a>  as well</p>



<a name="272814083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272814083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272814083">(Feb 22 2022 at 14:58)</a>:</h4>
<p>How does it achieve the extra speed?</p>



<a name="272816582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272816582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272816582">(Feb 22 2022 at 15:16)</a>:</h4>
<p>looks like it's just doing the deletion on a thread pool</p>



<a name="272816663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272816663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272816663">(Feb 22 2022 at 15:17)</a>:</h4>
<p>Also looks like it follows links by default, which seems dangerous for a recursive delete?</p>



<a name="272821513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272821513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272821513">(Feb 22 2022 at 15:48)</a>:</h4>
<p>When not specifying any arguments <code>cargo clean</code> uses <code>std::fs::remove_dir_all</code> on the target directory: <a href="https://github.com/rust-lang/cargo/blob/06ee2296749120bdde747dd6d0ff076afb9b50f7/src/cargo/ops/cargo_clean.rs#L56">https://github.com/rust-lang/cargo/blob/06ee2296749120bdde747dd6d0ff076afb9b50f7/src/cargo/ops/cargo_clean.rs#L56</a></p>



<a name="272845487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272845487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272845487">(Feb 22 2022 at 18:22)</a>:</h4>
<p>On linux we could speed up recursive delete with io_uring, but... that's a lot just to speed up remove_dir_all. On windows I don't know of a better  option  than parallelism, with all the synchronous filter thingies (such as antivirus). As a user one could exempt the target dir from scanning.</p>



<a name="272850449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272850449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272850449">(Feb 22 2022 at 18:58)</a>:</h4>
<p>/me wonders why Windows can't just say "OK, deleted" while it's still processing the filters in the background. Windows would really benefit from the concept of "deleted but still has open handles".</p>



<a name="272850964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272850964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272850964">(Feb 22 2022 at 19:01)</a>:</h4>
<p>There is since windows 10. It is called <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntddk/ns-ntddk-_file_disposition_information_ex"><code>FILE_DISPOSITION_POSIX_SEMANTICS</code></a>.</p>



<a name="272851120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272851120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272851120">(Feb 22 2022 at 19:02)</a>:</h4>
<p>You would end up with a situation where a filter could read a file, as you have a handle, but it's parent directory does not exist because it's already been deleted.</p>



<a name="272851394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272851394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272851394">(Feb 22 2022 at 19:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/122651-general/topic/cargo.20clean/near/272850449">said</a>:</p>
<blockquote>
<p>/me wonders why Windows can't just say "OK, deleted" while it's still processing the filters in the background. Windows would really benefit from the concept of "deleted but still has open handles".</p>
</blockquote>
<p>Bypassing filters can result in inconsistencies. For example shadow volume copies are done using a filter that buffers actions while performing the copy I believe.</p>



<a name="272851424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272851424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272851424">(Feb 22 2022 at 19:04)</a>:</h4>
<p>We're already using it anway. <a href="https://github.com/rust-lang/rust/blob/9a5a961be97f405e751dd2cf966e1cdb80a612c2/library/std/src/sys/windows/fs.rs#L575">https://github.com/rust-lang/rust/blob/9a5a961be97f405e751dd2cf966e1cdb80a612c2/library/std/src/sys/windows/fs.rs#L575</a></p>



<a name="272851763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272851763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272851763">(Feb 22 2022 at 19:07)</a>:</h4>
<p>NTFS also has some bottlenecks around concurrent accesses. In addition disabling 8.3 dos compatibility names supposedly gives a huge perf boost for NTFS.</p>



<a name="272851997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272851997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272851997">(Feb 22 2022 at 19:08)</a>:</h4>
<p>Hmm, <code>rustup</code> also has custom logic for closing files to get around the windows slowness, right?</p>



<a name="272852626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272852626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272852626">(Feb 22 2022 at 19:12)</a>:</h4>
<p>Does windows have faster filesystems? On linux I have my project directory on an ext4 with some YOLO mount options while the rest of the system is on btrfs.</p>



<a name="272852958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272852958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Denton <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272852958">(Feb 22 2022 at 19:15)</a>:</h4>
<p>I'd highly recommend reading <a href="https://github.com/Microsoft/WSL/issues/873#issuecomment-425272829">this</a> and <a href="https://github.com/Microsoft/WSL/issues/873#issuecomment-427211871">this</a> for some background.</p>



<a name="272853761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272853761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272853761">(Feb 22 2022 at 19:21)</a>:</h4>
<p>Ah, too bad. Then obviously the best solution is to do windows development under wine in wsl2. <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<a name="272853897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272853897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272853897">(Feb 22 2022 at 19:22)</a>:</h4>
<p>Or use more threads.</p>



<a name="272854077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272854077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272854077">(Feb 22 2022 at 19:23)</a>:</h4>
<blockquote>
<p>particularly on the system volume (so if you have a D: drive or partition, I recommend using that instead, since it likely has fewer filters attached).</p>
</blockquote>
<p>This might be useful</p>



<a name="272862006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272862006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272862006">(Feb 22 2022 at 20:28)</a>:</h4>
<p>(possibly off-topic)</p>
<p>At the current time, I'm suspicious of using io_uring to speed up filesystem operations. I did a very crude version of <code>dirstat-rs</code> with the <code>io_uring</code> crate (just recursive <code>getdents</code> + <code>statx</code>). No matter how I tuned things, it was always slower but less parallel and used more total CPU time. The only thing I could gather from a profile is that most cycles were spent in a spinlock.</p>



<a name="272862438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272862438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272862438">(Feb 22 2022 at 20:32)</a>:</h4>
<p><span class="user-mention" data-user-id="120827">@Ben Kimock (Saethlin)</span> The maintainer of <code>io_uring</code> tends to be extremely interested in performance issues; if you sent your prototype upstream, they might be able to figure out a solution to optimize either your code or the kernel implementation to eliminate that problem.</p>



<a name="272862731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272862731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272862731">(Feb 22 2022 at 20:35)</a>:</h4>
<p>Hunh. I guess I just assumed the kernel stuff needed time to bake. Thanks, I'll raise this.</p>



<a name="272864717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272864717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272864717">(Feb 22 2022 at 20:52)</a>:</h4>
<p>The stuff that's already there should in theory be fairly solid. But it's <em>entirely</em> possible that you've hit some manner of scaling issue that hasn't previously been noticed.</p>



<a name="272864772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272864772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272864772">(Feb 22 2022 at 20:52)</a>:</h4>
<p>For instance, I can <em>imagine</em> that you might actually be one of the first to test a workload that's <em>just</em> getdents/statx.</p>



<a name="272866561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272866561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272866561">(Feb 22 2022 at 21:03)</a>:</h4>
<p>getdents is fairly new, so maybe it's not as optimized as some other IO paths</p>



<a name="272866815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272866815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272866815">(Feb 22 2022 at 21:05)</a>:</h4>
<p>I also guess there are lots of ways one can use it inefficiently, like doing io_uring_enter too often or not often enough so something gets starved and spins?</p>



<a name="272883765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272883765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272883765">(Feb 22 2022 at 23:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/122651-general/topic/cargo.20clean/near/272851997">said</a>:</p>
<blockquote>
<p>Hmm, <code>rustup</code> also has custom logic for closing files to get around the windows slowness, right?</p>
</blockquote>
<p>rustup does... extremely weird things to handle Windows, including for perf optimizations, yes.</p>



<a name="272884076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20clean/near/272884076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20clean.html#272884076">(Feb 22 2022 at 23:58)</a>:</h4>
<p>The major thing is, in fact, "don't just accept the story we are told about how NTFS is always slower, actually profile it".</p>
<p>...but also some extremely cursed code around the tail end of the self-update mechanism. &lt;_&lt;</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>