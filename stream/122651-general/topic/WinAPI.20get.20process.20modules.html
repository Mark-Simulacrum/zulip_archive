<html>
<head><meta charset="utf-8"><title>WinAPI get process modules · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/WinAPI.20get.20process.20modules.html">WinAPI get process modules</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254005385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/WinAPI%20get%20process%20modules/near/254005385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Si <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/WinAPI.20get.20process.20modules.html#254005385">(Sep 20 2021 at 06:59)</a>:</h4>
<p>I'm trying to get modules of a process using bindings from <a href="https://docs.rs/winapi/0.3.9/winapi/index.html">winapi</a> with the following code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cm">/* imports */</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Get process handle</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_QUERY_INFORMATION</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROCESS_VM_READ</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">process_id</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Make array for modules with size of 100</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buffer</span>: <span class="p">[</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">HMODULE</span><span class="p">;</span><span class="w"> </span><span class="mi">100</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">null_mut</span>::<span class="o">&lt;</span><span class="n">HMODULE</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="mi">100</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EnumProcessModules</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">handle</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">buffer</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">mem</span>::<span class="n">size_of_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">null_mut</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Modules: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">to_vec</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Which seems pretty easy to accomplish. <br>
The first problem is the first argument of <code>OpenProcess</code>, with desired access of <code>PROCESS_QUERY_INFORMATION | PROCESS_VM_READ</code> produces <code>ERROR_NOACCESS - Invalid access to memory location</code>. <br>
The second problem is even if the result of <code>OpenProcess</code> is not <code>NULL</code> then <code>EnumProcessModules</code> fails with <code>ERROR_ACCESS_DENIED - Access is denied.</code></p>
<p>P.S: I spent more than 4 hours on this problem and have no idea what could be done</p>



<a name="254008660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/WinAPI%20get%20process%20modules/near/254008660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/WinAPI.20get.20process.20modules.html#254008660">(Sep 20 2021 at 07:33)</a>:</h4>
<p>Does <code>buffer.as_mut_ptr()</code> instead of <code>*buffer.as_mut_ptr()</code> work?</p>



<a name="254009103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/WinAPI%20get%20process%20modules/near/254009103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Si <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/WinAPI.20get.20process.20modules.html#254009103">(Sep 20 2021 at 07:38)</a>:</h4>
<p>Only if i change <code>let mut buffer: [*mut HMODULE; 100] = [std::ptr::null_mut::&lt;HMODULE&gt;(); 100];</code> to <code>let mut buffer: [HMODULE; 100] = [0 as HMODULE; 100];</code> for example. But this won't fix anything</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>