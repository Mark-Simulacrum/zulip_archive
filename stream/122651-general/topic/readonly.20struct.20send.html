<html>
<head><meta charset="utf-8"><title>readonly struct send · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/readonly.20struct.20send.html">readonly struct send</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268814621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/readonly%20struct%20send/near/268814621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> regis portalez <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/readonly.20struct.20send.html#268814621">(Jan 21 2022 at 09:18)</a>:</h4>
<p>Hi, I need to implement Send for a structure which is not send. <br>
The struct should be readonly, so I don't really care if multiple threads access the same memory at the same time, but I don't find any appropriate way to express that. <br>
with 1.57, this implementation worked well</p>
<div class="codehilite"><pre><span></span><code>/// it is readonly so thread-safe
#[derive(Clone)]
pub struct ReadonlyDocument {
    /// the parsed document [select::document::Document]
    doc: Document
    /// the raw string content
    content: String,
}

unsafe impl Send for ReadonlyDocument {}
unsafe impl Sync for ReadonlyDocument {}
</code></pre></div>
<p>but rust clippy 1.58 panics saying a non-send field in a struct make is non send, what I find perfectly legit. <br>
I tried to wrap my field in a mutex/arc, and the same error occurs : </p>
<div class="codehilite"><pre><span></span><code>/// it is readonly so thread-safe
#[derive(Clone)]
pub struct ReadonlyDocument {
    /// the parsed document [select::document::Document]
    doc: std::sync::Arc&lt;std::sync::Mutex&lt;Document&gt;&gt;,
    /// the raw string content
    content: String,
}

unsafe impl Send for ReadonlyDocument {}
unsafe impl Sync for ReadonlyDocument {}
</code></pre></div>



<a name="268815664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/readonly%20struct%20send/near/268815664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/readonly.20struct.20send.html#268815664">(Jan 21 2022 at 09:28)</a>:</h4>
<ol>
<li>You can allow the clippy lint.</li>
<li>You shouldn't do this. The reason it doesn't implement Send is because it uses non-atomic reference counting internally, so cloning it from multiple threads causes a data race which is UB. <a href="https://docs.rs/tendril/0.4.2/src/tendril/tendril.rs.html#86">https://docs.rs/tendril/0.4.2/src/tendril/tendril.rs.html#86</a></li>
</ol>



<a name="268816963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/readonly%20struct%20send/near/268816963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> regis portalez <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/readonly.20struct.20send.html#268816963">(Jan 21 2022 at 09:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/122651-general/topic/readonly.20struct.20send/near/268815664">said</a>:</p>
<blockquote>
<ol>
<li>You can allow the clippy lint.</li>
<li>You shouldn't do this. The reason it doesn't implement Send is because it uses non-atomic reference counting internally, so cloning it from multiple threads causes a data race which is UB. <a href="https://docs.rs/tendril/0.4.2/src/tendril/tendril.rs.html#86">https://docs.rs/tendril/0.4.2/src/tendril/tendril.rs.html#86</a></li>
</ol>
</blockquote>
<p>hmmm apparently, rust 1.58.1 disables this clippy warning.</p>



<a name="268817952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/readonly%20struct%20send/near/268817952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/readonly.20struct.20send.html#268817952">(Jan 21 2022 at 09:47)</a>:</h4>
<p>that lint had too many false positives</p>



<a name="268818053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/readonly%20struct%20send/near/268818053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/readonly.20struct.20send.html#268818053">(Jan 21 2022 at 09:48)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust-clippy/issues/8045">https://github.com/rust-lang/rust-clippy/issues/8045</a></p>



<a name="268822251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/readonly%20struct%20send/near/268822251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Marc Brevoort <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/readonly.20struct.20send.html#268822251">(Jan 21 2022 at 10:23)</a>:</h4>
<p>Hello, I think I may have spotted a bug (cargo related) - what's the best place to raise it?<br>
I think it's checking the wrong directory for dependencies on cross-compiles (target/debug/deps rather than target/&lt;architecture&gt;/debug/deps)  resulting in unnecessarily rebuilding.</p>



<a name="268827605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/readonly%20struct%20send/near/268827605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/readonly.20struct.20send.html#268827605">(Jan 21 2022 at 11:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="436706">regis portalez</span> <a href="#narrow/stream/122651-general/topic/readonly.20struct.20send/near/268814621">said</a>:</p>
<blockquote>
<p>Hi, I need to implement Send for a structure which is not send. <br>
The struct should be readonly, so I don't really care if multiple threads access the same memory at the same time, </p>
</blockquote>
<p>"multiple threads access the same memory at the same time" is a property checked by being <code>Sync</code>, not <code>Send</code>. <code>Send</code> is about unique access to a type being able to be performed from a different thread where the instance was originally created. This limitation is most often caused by one of the following things:</p>
<ul>
<li>the instance is (potentially) a clone of a (shared) reference / handle to a non-<code>Sync</code> type (<em>e.g.</em>, <code>T = &amp;NotSync</code> or <code>T = Arc&lt;NotSync&gt;</code>). In that case sending (an owned) instance of <code>T</code> could lead to multi-threaded shared access to the <code>NonSync</code> type, which is not allowed.</li>
<li>the instance may involve (global) thread-local storage (this is, alas, a too common pattern in the C world, used to have different entities communicate / share state with one another). This means that if the entity changes, mid-life, of thread, then all this (global) thread-local state is suddenly not the one expected.</li>
</ul>
<p>So, <code>Sync</code> is the more "intuitive" thread-safety concept, and one which indeed can be tackled by <code>Mutex</code>-ing stuff (<code>Arc</code>, on the other hand, won't help make things <em>more thread-safe</em>; it just allows <em>sharing</em> without losing <code>: 'static</code>.</p>
<p><code>Send</code>, on the other hand, in the more general case, <strong>has no "cure"</strong>. If something is thread-bound, then you can't move it to another thread (in the case where you suspect that, <em>at runtime</em>, there will be no thread-crossing —<em>e.g.</em>, much like <code>RefCell</code> is a dynamic tool againt "overlapping <code>&amp;mut</code>"— there is <a href="https://docs.rs/send_wrapper">https://docs.rs/send_wrapper</a> as a dynamic tool to which you would assert that no thread-crossing ends up happening (betting a <code>panic!</code> in that regard); but the panic-on-misusage makes this tool a way worse idea than it may initially appear).</p>
<p><span class="user-mention silent" data-user-id="436706">regis portalez</span> <a href="#narrow/stream/122651-general/topic/readonly.20struct.20send/near/268814621">said</a>:</p>
<blockquote>
<p>but I don't find any appropriate way to express that. </p>
</blockquote>
<p>There is, however, one useful —albeit expensive— pattern: if you imagine an instance being thread-bound as an inmate being locked in a cell, then yeah, you can't have them escape the cell. But you can still "visit" them, <em>talk</em> to them. So there is this pattern of "create a jail" (start spinning a dedicated thread), where you shall lock the inmate (where you shall <em>create</em> the instance), so as to, later on, and from anywhere, <em>talk to it</em> (<a href="https://docs.rs/diplomatic-bag/0.2.0/diplomatic_bag/struct.DiplomaticBag.html#method.and_then">send "usage queries" (usage closures) to it</a>).</p>
<p>This pattern has already been written, and is thus available at:</p>
<ul>
<li><a href="https://docs.rs/diplomatic_bag">https://docs.rs/diplomatic_bag</a></li>
</ul>
<p>With it, you have a genuine "send wrapper" (the diplomatic bag), which is <code>Send</code> even if the inner value isn't, at the cost of having <a href="https://docs.rs/diplomatic-bag/0.2.0/diplomatic_bag/struct.DiplomaticBag.html#method.and_then">operations on the value take the form of a closure</a>, and, at runtime / implementation-wise, involve message-passing and synchronization with that dedicated thread.</p>
<p>My only criticism regarding that crate is that it doesn't currently use a thread pool: just the one thread. This means that if you have multiple <code>DiplomaticBag</code> instances, there will be unnecessary contention (back to our parallel: it's as if the jail only had <em>one</em> cell, and thus each "inmate visitor" requires exclusive access, preventing visits to "other inmates" from being done simultaneously. If it were me, I'd give that jail some funds so that they can get some extra cells! <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span>)</p>



<a name="268851177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/readonly%20struct%20send/near/268851177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> regis portalez <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/readonly.20struct.20send.html#268851177">(Jan 21 2022 at 14:41)</a>:</h4>
<p>thanks  everyone</p>



<a name="268854475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/readonly%20struct%20send/near/268854475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/readonly.20struct.20send.html#268854475">(Jan 21 2022 at 15:05)</a>:</h4>
<p><span class="user-mention" data-user-id="473259">@Marc Brevoort</span> you should create a new topic for that</p>



<a name="268872848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/readonly%20struct%20send/near/268872848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/readonly.20struct.20send.html#268872848">(Jan 21 2022 at 17:14)</a>:</h4>
<ol>
<li>You can allow the clippy lint.</li>
<li>You shouldn't do this. The reason it doesn't implement Send is because it uses non-atomic reference counting internally, so cloning it from multiple threads causes a data race which is UB. <a href="https://docs.rs/tendril/0.4.2/src/tendril/tendril.rs.html#86">https://docs.rs/tendril/0.4.2/src/tendril/tendril.rs.html#86</a></li>
</ol>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>