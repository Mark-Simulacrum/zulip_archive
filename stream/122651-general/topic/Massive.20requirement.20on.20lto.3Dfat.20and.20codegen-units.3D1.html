<html>
<head><meta charset="utf-8"><title>Massive requirement on lto=fat and codegen-units=1 · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html">Massive requirement on lto=fat and codegen-units=1</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268391610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268391610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268391610">(Jan 18 2022 at 13:40)</a>:</h4>
<p>Hi, I am working on a project and during optimization I found out that the project very heavily relies on</p>
<div class="codehilite"><pre><span></span><code>[profile.release]
lto = &quot;fat&quot;
codegen-units = 1
</code></pre></div>
<p>in order to have a decent performance.</p>
<p>The next best configuration I found (which is <code>lto="thin", codegen-units=1</code>) still has 40% worse performance!<br>
With the default profile settings I see slowdowns of factor x4-x5.</p>
<p>What could be the reason for this massive reliance on this particular profile?<br>
I'd really like the project to be well optimized under default profile settings since users usually forget to set them and they add tons of compile time overhead. I am asking here since usually I see performance improvements in the range of 10-15% with the aforementioned profile but not in the range of 400-500%.</p>
<p>The following Gist link shows all the data I collected under various profile settings and has a summary:<br>
<a href="https://gist.github.com/Robbepop/0644e9eb000bb1dad6a003a72534263a">https://gist.github.com/Robbepop/0644e9eb000bb1dad6a003a72534263a</a></p>



<a name="268392413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268392413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268392413">(Jan 18 2022 at 13:46)</a>:</h4>
<p>maybe there are some critical inlining decisions that llvm can only figure out while having the entire program in scope</p>



<a name="268392592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268392592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268392592">(Jan 18 2022 at 13:48)</a>:</h4>
<p>I also thought about this but I even tried adding <code>#[inline]</code> pervasively to all functions in the codebase and the speedup under all profiles was very similar than without those annotations.</p>



<a name="268427549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268427549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268427549">(Jan 18 2022 at 17:30)</a>:</h4>
<p>I used flamegraph and found some odd behavior under the settings that are causing the massive slowdowns.</p>
<p>What confuses me is that <code>execute_until_done</code> is shown there twice in the hierarchy, however, as far as I understand my own code there is absolutely no recursion going on that could cause <code>execute_until_done</code> to call itself again. Also in the fast run this "recursion" is shown to be optimized away.</p>
<p>Can anyone here tell me what this scenario is telling me? <a href="/user_uploads/4715/CiaQnQrXYcivkezeCMk8SDva/2022-01-18-180440_1259x666_scrot.png">2022-01-18-180440_1259x666_scrot.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/CiaQnQrXYcivkezeCMk8SDva/2022-01-18-180440_1259x666_scrot.png" title="2022-01-18-180440_1259x666_scrot.png"><img src="/user_uploads/4715/CiaQnQrXYcivkezeCMk8SDva/2022-01-18-180440_1259x666_scrot.png"></a></div>



<a name="268428449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268428449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268428449">(Jan 18 2022 at 17:37)</a>:</h4>
<p>Maybe it gets confused by inlining? Although in <code>perf report</code> inlined functions are usually shown properly as long as debug info is available.</p>



<a name="268428610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268428610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268428610">(Jan 18 2022 at 17:38)</a>:</h4>
<p>Have you tried PGO? Maybe LLVM can make better decision that way without having to resort to fat LTO</p>



<a name="268428950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268428950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268428950">(Jan 18 2022 at 17:40)</a>:</h4>
<p>I have never touched PGO, need to see how it works in Rust first.<br>
The things that confuses me most is that this slowdown happens to the rewrite of some Wasm execution engine that did not happen to the old version. On the good configurations the new engine is a lot faster &gt;30% and on default settings is is almost 400% slower due to this problem.</p>



<a name="268429080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268429080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268429080">(Jan 18 2022 at 17:41)</a>:</h4>
<p>I would not accept this for production usage until the default configs at least sanely optimize the new engine.</p>



<a name="268429792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268429792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268429792">(Jan 18 2022 at 17:46)</a>:</h4>
<p>You could try using <code>perf diff</code> or cachegrind diff and see which hot methods regress. Then do some code golfing to make the code more pleasing to the optimizer. Often it's bound checks or branches that don't get eliminated and then pessimizations cascade from there.</p>



<a name="268430030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268430030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268430030">(Jan 18 2022 at 17:48)</a>:</h4>
<p>You also should check if it's not a problem with your benchmark. With whole-program-optimization it just might be the case that something gets optimized away because the compiler sees that some result isn't used or the inputs are constant.</p>



<a name="268430226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268430226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268430226">(Jan 18 2022 at 17:50)</a>:</h4>
<p>In the flamegraph above I can see a very clear distinction that I cannot explain to myself.<br>
This is the seemingly recursive call of <code>execute_until_done</code> that does not exist in the better optimized (and super fast) run.<br>
I can upload a screenshot of the fast run.</p>



<a name="268430686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268430686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268430686">(Jan 18 2022 at 17:53)</a>:</h4>
<p>if the flamegraph isn't detailed enough run <code>perf report</code> and look at the assembly where it's spending cycles</p>



<a name="268431031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268431031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268431031">(Jan 18 2022 at 17:56)</a>:</h4>
<p><a href="/user_uploads/4715/SAy9bLnIFitzZyq0qTs1sv7D/2022-01-18-185551_2533x658_scrot.png">2022-01-18-185551_2533x658_scrot.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/SAy9bLnIFitzZyq0qTs1sv7D/2022-01-18-185551_2533x658_scrot.png" title="2022-01-18-185551_2533x658_scrot.png"><img src="/user_uploads/4715/SAy9bLnIFitzZyq0qTs1sv7D/2022-01-18-185551_2533x658_scrot.png"></a></div>



<a name="268431728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268431728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268431728">(Jan 18 2022 at 18:00)</a>:</h4>
<p>The <code>perf report</code> shows black only after loading. I guess I have to learn how to use it first.<br>
The 2nd screenshot shows the fast run and as you can see there is no "recursive" call to <code>execute_until_done</code> anymore and it looks more like what I expected the other to look like, too.</p>



<a name="268431853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268431853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268431853">(Jan 18 2022 at 18:01)</a>:</h4>
<p>It seems you are just profiling the wasmtime runtime. You need to profile the JITed functions as described here: <a href="https://docs.wasmtime.dev/examples-profiling-perf.html">https://docs.wasmtime.dev/examples-profiling-perf.html</a></p>



<a name="268431962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268431962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268431962">(Jan 18 2022 at 18:02)</a>:</h4>
<p>I am not trying to profile Wasmtime but the <code>wasmi</code> interpreter.</p>



<a name="268432330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268432330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268432330">(Jan 18 2022 at 18:04)</a>:</h4>
<p>In that case <code>perf</code> will not help you as it gives you no feedback which part of your WASM code the time is spent in.</p>



<a name="268432385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268432385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268432385">(Jan 18 2022 at 18:05)</a>:</h4>
<p>Well, flamegraphs are relative (unless there's more info on hover?) so it shows a larger fraction of time spent in <code>visit</code>, so to some extent it might be shuffling around code and the issue could be elsewhere. </p>
<p>You can use <a href="https://github.com/KDAB/hotspot">kdab hotspot</a> to navigate perf recordings a bit better. But it doesn't have the assembly view, so you have to juggle hotspot and <code>perf report</code>.</p>



<a name="268432482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268432482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268432482">(Jan 18 2022 at 18:05)</a>:</h4>
<p>I assume the goal is profiling the interpreter itself.</p>



<a name="268432561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268432561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268432561">(Jan 18 2022 at 18:06)</a>:</h4>
<p>I'd assume that there is some time spent in <code>visit_instruction</code> because the majority of the time spent in an interpreter is the dynamic dispatch of instructions which is displayed by <code>visit_instruction</code> taking a long time.</p>



<a name="268432646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268432646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268432646">(Jan 18 2022 at 18:07)</a>:</h4>
<p>Note though that the 2nd flamegraph I uploaded here shows the good run that yields very decent timings and does not need to be optimized further. However, the first graph shows the problematic duplication of the <code>execute_until_done</code> which I seriously cannot explain.</p>



<a name="268432719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268432719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268432719">(Jan 18 2022 at 18:07)</a>:</h4>
<p>We are talking about slowdowns between both graphs of 400-500%.</p>



<a name="268433977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268433977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268433977">(Jan 18 2022 at 18:17)</a>:</h4>
<p>Yeah, but when inlining changes then comparing the graphs can be very misleading. Some changes just redistribute instructions while the blowup lies elsewhere, usually closer to the leaf methods.</p>



<a name="268536922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Massive%20requirement%20on%20lto%3Dfat%20and%20codegen-units%3D1/near/268536922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hero Bird <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Massive.20requirement.20on.20lto.3Dfat.20and.20codegen-units.3D1.html#268536922">(Jan 19 2022 at 13:17)</a>:</h4>
<p>In this GitHub issue we collect all information about this strange missed optimization potential:<br>
<a href="https://github.com/paritytech/wasmi/issues/339">https://github.com/paritytech/wasmi/issues/339</a><br>
Thanks so far for the answers!<br>
I am trying to do some more research on this and will come back once I found some more details.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>