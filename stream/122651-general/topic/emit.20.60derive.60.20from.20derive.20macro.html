<html>
<head><meta charset="utf-8"><title>emit `derive` from derive macro · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html">emit `derive` from derive macro</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266872241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266872241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266872241">(Jan 04 2022 at 22:18)</a>:</h4>
<p>Is there any way to emit a <code>derive</code> from a derive macro? For example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Macro1)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Struct</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>turns into</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Macro2)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Struct</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>which then turns into the result.</p>



<a name="266872389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266872389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266872389">(Jan 04 2022 at 22:19)</a>:</h4>
<p>To avoid the X/Y problem, my reason for wanting to do this is so that <code>Macro1</code> can emit an <code>#[attribute(source = include_str!("some_file.txt"))]</code> that will be expanded (I hope) as an argument for <code>Macro2</code>.</p>
<p>And my ultimate reason for doing <em>that</em> is so that Spans exist for the included file for better error reporting.</p>



<a name="266872449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266872449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266872449">(Jan 04 2022 at 22:20)</a>:</h4>
<p>In context: <a href="https://github.com/rust-lang/rust/pull/92526#issuecomment-1005174013">https://github.com/rust-lang/rust/pull/92526#issuecomment-1005174013</a></p>



<a name="266872507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266872507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266872507">(Jan 04 2022 at 22:21)</a>:</h4>
<p>Feel free to suggest alternative, less hacky ways of accomplishing this.</p>



<a name="266872686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266872686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266872686">(Jan 04 2022 at 22:23)</a>:</h4>
<p>I tried a simple</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[proc_macro_derive(Template)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">derive_template</span><span class="p">(</span><span class="n">input</span>: <span class="nc">TokenStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">TokenStream</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">proc_macro</span>::<span class="n">quote</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[derive(::askama::Template__Inner)]</span><span class="w"></span>
<span class="w">        </span><span class="cp">$input</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>but that causes these errors:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0428</span><span class="p">]</span>: <span class="nc">the</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="err">`</span><span class="n">HelloTemplate</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="n">times</span><span class="w"></span>
<span class="w"> </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">6</span>:<span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">struct</span> <span class="nc">HelloTemplate</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="err">`</span><span class="n">HelloTemplate</span><span class="err">`</span><span class="w"> </span><span class="n">redefined</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="n">definition</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="n">HelloTemplate</span><span class="err">`</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="err">`</span><span class="n">HelloTemplate</span><span class="err">`</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">once</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">type</span> <span class="nc">namespace</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">module</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">cannot</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="err">`</span><span class="n">template</span><span class="err">`</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">scope</span><span class="w"></span>
<span class="w"> </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">4</span>:<span class="mi">3</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="cp">#[template(path = </span><span class="s">"hello.html"</span><span class="cp">)]</span><span class="w"> </span><span class="c1">// using the template in this path, relative</span>
<span class="w">  </span><span class="o">|</span><span class="w">   </span><span class="o">^^^^^^^^</span><span class="w"></span>
<span class="n">For</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="kr">try</span><span class="w"> </span><span class="err">`</span><span class="n">rustc</span><span class="w"> </span><span class="o">--</span><span class="n">explain</span><span class="w"> </span><span class="n">E0428</span><span class="err">`</span><span class="p">.</span><span class="w"></span>
</code></pre></div>



<a name="266872850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266872850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266872850">(Jan 04 2022 at 22:24)</a>:</h4>
<p><code>cargo expand</code> does show that the second macro's code is generated:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(prelude_import)]</span><span class="w"></span>
<span class="cp">#[prelude_import]</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">prelude</span>::<span class="n">rust_2021</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>
<span class="cp">#[macro_use]</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">std</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">askama</span>::<span class="n">Template</span><span class="p">;</span><span class="w"></span>
<span class="cp">#[template(path = </span><span class="s">"hello.html"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">HelloTemplate</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#[template(path = </span><span class="s">"hello.html"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">HelloTemplate</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span>::<span class="n">askama</span>::<span class="n">Template</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">HelloTemplate</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">render_into</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">writer</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">(</span><span class="k">impl</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Write</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">?</span><span class="nb">Sized</span><span class="p">))</span><span class="w"> </span>-&gt; ::<span class="n">askama</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">b"Hello, {{ name }}!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">writer</span><span class="p">.</span><span class="n">write_fmt</span><span class="p">(</span>::<span class="n">core</span>::<span class="n">fmt</span>::<span class="n">Arguments</span>::<span class="n">new_v1</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="p">[</span><span class="s">"Hello, "</span><span class="p">,</span><span class="w"> </span><span class="s">"!"</span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;&amp;</span>::<span class="n">askama</span>::<span class="n">MarkupDisplay</span>::<span class="n">new_unsafe</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">name</span><span class="p">),</span><span class="w"></span>
<span class="w">                </span>::<span class="n">askama</span>::<span class="n">Html</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">),)</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">_args</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">[</span>::<span class="n">core</span>::<span class="n">fmt</span>::<span class="n">ArgumentV1</span>::<span class="n">new</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">_args</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span>::<span class="n">core</span>::<span class="n">fmt</span>::<span class="n">Display</span>::<span class="n">fmt</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">)],</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="p">))</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">EXTENSION</span>: ::<span class="n">std</span>::<span class="n">option</span>::<span class="nb">Option</span><span class="o">&lt;&amp;'</span><span class="nb">static</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">primitive</span>::<span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="s">"html"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">SIZE_HINT</span>: ::<span class="n">std</span>::<span class="n">primitive</span>::<span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Display</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">HelloTemplate</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Formatter</span><span class="p">)</span><span class="w"> </span>-&gt; ::<span class="n">std</span>::<span class="n">fmt</span>::<span class="nb">Result</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span>::<span class="n">askama</span>::<span class="n">Template</span>::<span class="n">render_into</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">).</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span>::<span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Error</span><span class="w"> </span><span class="p">{})</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HelloTemplate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span>: <span class="s">"world"</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="s">"Hello, world!"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hello</span><span class="p">.</span><span class="n">render</span><span class="p">().</span><span class="n">unwrap</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">left_val</span><span class="p">,</span><span class="w"> </span><span class="n">right_val</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">left_val</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">*</span><span class="n">right_val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">panicking</span>::<span class="n">AssertKind</span>::<span class="nb">Eq</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span>::<span class="n">core</span>::<span class="n">panicking</span>::<span class="n">assert_failed</span><span class="p">(</span><span class="w"></span>
<span class="w">                        </span><span class="n">kind</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="o">&amp;*</span><span class="n">left_val</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="o">&amp;*</span><span class="n">right_val</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span>::<span class="n">core</span>::<span class="n">option</span>::<span class="nb">Option</span>::<span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="266872868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266872868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266872868">(Jan 04 2022 at 22:24)</a>:</h4>
<p>But the struct is duplicated for some reason.</p>



<a name="266872979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266872979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266872979">(Jan 04 2022 at 22:25)</a>:</h4>
<p>The output of a <code>derive</code> macro always gets parsed as a stream of <em>new</em> items</p>



<a name="266873033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266873033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266873033">(Jan 04 2022 at 22:26)</a>:</h4>
<p>you can't modify the original target in any way (which includes adding a new macro invocation applied to the original target)</p>



<a name="266873067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266873067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266873067">(Jan 04 2022 at 22:26)</a>:</h4>
<p>Could <code>Macro1</code> be an attribute macro instead?</p>



<a name="266873074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266873074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266873074">(Jan 04 2022 at 22:26)</a>:</h4>
<p>which then expands to whatever derives are needed?</p>



<a name="266873901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266873901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266873901">(Jan 04 2022 at 22:35)</a>:</h4>
<p>I see...</p>



<a name="266873965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266873965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266873965">(Jan 04 2022 at 22:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro/near/266873067">said</a>:</p>
<blockquote>
<p>Could <code>Macro1</code> be an attribute macro instead?</p>
</blockquote>
<p>The issue is that that would be a breaking change. It might be possible, but I'd rather avoid having to make API changes.</p>



<a name="266874167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874167">(Jan 04 2022 at 22:38)</a>:</h4>
<p>I suppose maybe <code>#[template]</code> could be made a freestanding attribute macro in addition to a <code>derive</code> attribute, and it would be responsible for replacing itself with something?</p>



<a name="266874333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874333">(Jan 04 2022 at 22:40)</a>:</h4>
<p>In other words, this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Template)]</span><span class="w"></span>
<span class="cp">#[template(path = </span><span class="s">"index.html"</span><span class="cp">, ...other arguments...)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Struct</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>would be turned into this by <code>#[template]</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Template)]</span><span class="w"></span>
<span class="cp">#[template(source = </span><span class="s">"index.html"</span><span class="cp">, ...other arguments...)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Struct</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>which would then be processed by the <code>Template</code> derive. Does that seem feasible?</p>



<a name="266874373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874373">(Jan 04 2022 at 22:40)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="226095">@Dirkjan Ochtman</span></p>



<a name="266874395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874395">(Jan 04 2022 at 22:40)</a>:</h4>
<p>You need a proc-macro to add new derives. That being said, there could be a language feature for your use case: being able to force-call a <code>derive</code> as a proc-macro attribute nonetheless. Say, through a <code>derive_only</code> compiler-builtin helper:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive_only(Foo)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Bar</span><span class="w"> </span><span class="err">…</span><span class="w"></span>
</code></pre></div>
<p>would act a <code>#[Foo] struct Bar …</code>, should that be allowed: it would result in calling <code>Foo</code> with the definition of <code>struct Bar …</code> <em>etc.</em>, which, as any derive, will assume the existence of such a definition, <strong>but it wouldn't (re)emit</strong> that definition, avoiding the repeated defs errors</p>



<a name="266874439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874439">(Jan 04 2022 at 22:41)</a>:</h4>
<p>Hmm, are you saying this is a language feature that could be added or that exists?</p>



<a name="266874454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874454">(Jan 04 2022 at 22:41)</a>:</h4>
<p>That could be added</p>



<a name="266874521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874521">(Jan 04 2022 at 22:42)</a>:</h4>
<p>Really, I feel like the most helpful (and cleanest) language feature that could be added would be for proc macros to be able to load other files into the SourceMap. Is there any reason that shouldn't be done (e.g., problems it could cause)?</p>



<a name="266874538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874538">(Jan 04 2022 at 22:42)</a>:</h4>
<p>That would avoid this whole double-macro dance.</p>



<a name="266874544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874544">(Jan 04 2022 at 22:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro/near/266874333">said</a>:</p>
<blockquote>
<p>Does that seem feasible?</p>
</blockquote>
<p>Yes, if you can go for that API then for all means do <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="266874560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874560">(Jan 04 2022 at 22:42)</a>:</h4>
<p>Ok, I'll try it :)</p>



<a name="266874614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874614">(Jan 04 2022 at 22:43)</a>:</h4>
<p>(if it happens too many times, you might hit macro recursion limits, that's the only caveat. I think it's around 128 by default?)</p>



<a name="266874778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266874778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266874778">(Jan 04 2022 at 22:45)</a>:</h4>
<p>Unless I introduce a bug, it should only happen once. No more recursion necessary :)</p>



<a name="266878760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266878760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266878760">(Jan 04 2022 at 23:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro/near/266874521">said</a>:</p>
<blockquote>
<p>Really, I feel like the most helpful (and cleanest) language feature that could be added would be for proc macros to be able to load other files into the SourceMap. Is there any reason that shouldn't be done (e.g., problems it could cause)?</p>
</blockquote>
<p>I've opened a feature-request for this: <a href="https://github.com/rust-lang/rust/issues/92565">#92565</a></p>



<a name="266879298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266879298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266879298">(Jan 04 2022 at 23:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro/near/266874333">said</a>:</p>
<blockquote>
<p>In other words, this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Template)]</span><span class="w"></span>
<span class="cp">#[template(path = </span><span class="s">"index.html"</span><span class="cp">, ...other arguments...)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Struct</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>would be turned into this by <code>#[template]</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Template)]</span><span class="w"></span>
<span class="cp">#[template(source = </span><span class="s">"index.html"</span><span class="cp">, ...other arguments...)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Struct</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>which would then be processed by the <code>Template</code> derive. Does that seem feasible?</p>
</blockquote>
<p>Hmm, this doesn't seem to be possible. rustc appears to expand <code>Template</code> first and then ignore <code>#[template]</code>.</p>



<a name="266879669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266879669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266879669">(Jan 04 2022 at 23:40)</a>:</h4>
<p>Is there any way to expand macros in a piece of AST from inside a proc macro?</p>



<a name="266926966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266926966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266926966">(Jan 05 2022 at 12:05)</a>:</h4>
<p>Ah sorry I misread the stuff: I interpreted <code>template</code> as a proc-macro, not as a helper for the derive. That being said, if the derive were made not to have a helper, and if you were to feature that proc-macro (technically a breaking change if they didn't have it in scope, but a rather small one if you were showcasing a prelude pattern) then it should work. But as a derive helper we'd be back to the aforementioned limitations of a derive</p>



<a name="266984142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266984142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266984142">(Jan 05 2022 at 20:06)</a>:</h4>
<p>What do you mean by "feature that proc-macro"?</p>



<a name="266984356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266984356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266984356">(Jan 05 2022 at 20:08)</a>:</h4>
<p>As you say, currently, <code>Template</code> is a derive macro, and <code>#[template]</code> is a helper. I tried changing <code>#[template]</code> to be its own attribute macro, but then it requires an import. Also, I'm not sure how to guarantee that <code>#[template]</code> runs first. I guess maybe a better approach would be to get rid of <code>Template</code> altogether and just have <code>#[template]</code>?</p>



<a name="266985821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266985821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266985821">(Jan 05 2022 at 20:20)</a>:</h4>
<p>Yeah at that point having <code>Template</code> around seems vestigial.</p>



<a name="266986026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266986026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266986026">(Jan 05 2022 at 20:22)</a>:</h4>
<p>(FWIW, I believe a proc-macro <code>#[template]</code> (which, yes, would require an import or a fully qualified path) written after a derive would either error or Just Work (run before the derives), but I don't think it could run afterwards)</p>



<a name="266989786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266989786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266989786">(Jan 05 2022 at 20:55)</a>:</h4>
<p>Ok, I tried making <code>#[template]</code> its own thing, and I got it working—but not quite. I got it to emit this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code>#<span class="w"> </span><span class="p">[</span>:: <span class="nc">askama</span><span class="w"> </span>:: <span class="nc">__template_private</span><span class="w"> </span><span class="p">(</span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">include_str</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="s">"hello.html"</span><span class="p">))]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">HelloTemplate</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="266989829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266989829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266989829">(Jan 05 2022 at 20:55)</a>:</h4>
<p>But for some reason the <code>include_str!</code> is not expanded before being passed to <code>__template_private</code>.</p>



<a name="266989840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266989840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266989840">(Jan 05 2022 at 20:56)</a>:</h4>
<p>How do I force eager-expansion here?</p>



<a name="266990016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266990016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266990016">(Jan 05 2022 at 20:57)</a>:</h4>
<p>I don't think we currently support any form of eager expansion</p>



<a name="266990134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266990134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266990134">(Jan 05 2022 at 20:58)</a>:</h4>
<p>Macro are expanded in inert attributes (e.g. <code>#[doc = include_str!(...)]</code>) but I don't think any macros can observe the result of that expansion</p>



<a name="266990550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266990550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266990550">(Jan 05 2022 at 21:01)</a>:</h4>
<p>Hmm, so stuff like <code>#[doc = include_str!(...)]</code> doesn't work for user-defined macros?</p>



<a name="266990724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266990724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266990724">(Jan 05 2022 at 21:03)</a>:</h4>
<p>Dang, I guess this workaround won't work then.</p>



<a name="266990838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266990838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266990838">(Jan 05 2022 at 21:04)</a>:</h4>
<p>I think it does</p>



<a name="266990859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266990859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266990859">(Jan 05 2022 at 21:04)</a>:</h4>
<p>I mean, using doc with user-defined macros</p>



<a name="266990905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266990905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266990905">(Jan 05 2022 at 21:04)</a>:</h4>
<p>I meant more that I want to use <code>include_str!</code> with a user-defined attribute macro</p>



<a name="266990916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266990916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266990916">(Jan 05 2022 at 21:05)</a>:</h4>
<p>But I don't think an outer macro will be able to see the result of that expansion - it will see the literal tokens <code>#[doc = some_macro!()]</code></p>



<a name="266991070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991070">(Jan 05 2022 at 21:06)</a>:</h4>
<p>I don't want to use <code>doc</code> at all; I was just using that as an example of how I wanted my attribute to behave</p>



<a name="266991108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991108">(Jan 05 2022 at 21:06)</a>:</h4>
<p>I.e., I want to generate <code>#[my_attr(source = include_str!(...))]</code> and have the string expanded before being passed to my macro</p>



<a name="266991140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991140">(Jan 05 2022 at 21:06)</a>:</h4>
<p>And the ultimate reason for this is to get spans for the contents of the external file</p>



<a name="266991258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991258">(Jan 05 2022 at 21:07)</a>:</h4>
<p>I think built-in inert attributes are handles specially when you use the syntax <code>#[builtin_attr = some_macro!()]</code></p>



<a name="266991320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991320">(Jan 05 2022 at 21:08)</a>:</h4>
<p>But nothing else gets that treatment</p>



<a name="266991330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991330">(Jan 05 2022 at 21:08)</a>:</h4>
<p>Let me see if I can find the docs</p>



<a name="266991416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991416">(Jan 05 2022 at 21:09)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/83366">https://github.com/rust-lang/rust/pull/83366</a></p>



<a name="266991613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991613">(Jan 05 2022 at 21:10)</a>:</h4>
<p>I believe there was a PR for a limited kind of eager expansion in proc macros</p>



<a name="266991649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991649">(Jan 05 2022 at 21:11)</a>:</h4>
<p>I mean, this whole eager-expansion thing I was hoping for as a workaround is a hack. I'd much rather have something like <a href="https://github.com/rust-lang/rust/issues/92565">#92565</a> or <a href="https://github.com/rust-lang/rfcs/issues/3200">RFC#3200</a>, which would be simpler to implement in Askama and cleaner.</p>



<a name="266991660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991660">(Jan 05 2022 at 21:11)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/87264">https://github.com/rust-lang/rust/pull/87264</a></p>



<a name="266991699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991699">(Jan 05 2022 at 21:11)</a>:</h4>
<p>Oh...</p>



<a name="266991763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266991763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266991763">(Jan 05 2022 at 21:12)</a>:</h4>
<p>Hmm, I guess I could try that</p>



<a name="266992529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266992529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266992529">(Jan 05 2022 at 21:19)</a>:</h4>
<p>That worked!</p>



<a name="266992550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266992550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266992550">(Jan 05 2022 at 21:19)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="125294">@Aaron Hill</span>!</p>



<a name="266993681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266993681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266993681">(Jan 05 2022 at 21:30)</a>:</h4>
<p>How do I get the contents of a <code>proc_macro::Literal</code> that's a string literal? I suppose I could just do <code>lit.to_string()</code> and then parse it using syn, but I was wondering if there's a less hacky way.</p>



<a name="266996357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266996357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266996357">(Jan 05 2022 at 21:51)</a>:</h4>
<p>Hmm, the Span returned from <code>lit.span()</code> after doing <code>expand_expr</code> is still for the macro call-site, not the file itself...</p>



<a name="266996367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266996367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266996367">(Jan 05 2022 at 21:51)</a>:</h4>
<p>Is that a bug?</p>



<a name="266996452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266996452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266996452">(Jan 05 2022 at 21:52)</a>:</h4>
<p>The context is different (call site is <code>#4</code> while lit is <code>#6</code>), but the source range is the same</p>



<a name="266996509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266996509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266996509">(Jan 05 2022 at 21:52)</a>:</h4>
<p>E.g., reporting an error at the literal's span shows this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">hello</span><span class="w"></span>
<span class="w"> </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">3</span>:<span class="mi">10</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="cp">#[derive(Template)]</span><span class="w"> </span><span class="c1">// this will generate the code...</span>
<span class="w">  </span><span class="o">|</span><span class="w">          </span><span class="o">^^^^^^^^</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">originates</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="err">`</span><span class="n">include_str</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="n">Nightly</span><span class="w"> </span><span class="n">builds</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">-</span><span class="n">Z</span><span class="w"> </span><span class="kr">macro</span><span class="o">-</span><span class="n">backtrace</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="266996736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266996736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266996736">(Jan 05 2022 at 21:54)</a>:</h4>
<p>Calling <code>.source()</code> yields the same result, except the "this error originates in the macro <code>include_str</code>" note is gone</p>



<a name="266996765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266996765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266996765">(Jan 05 2022 at 21:55)</a>:</h4>
<p>AFAIK <code>include_str!()</code> uses the macro location as span, not the included file.</p>



<a name="266996828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266996828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266996828">(Jan 05 2022 at 21:55)</a>:</h4>
<p>Really? That's strange... is there a way to get the included file's span?</p>



<a name="266997256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266997256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266997256">(Jan 05 2022 at 21:59)</a>:</h4>
<p>Not that I know of.</p>



<a name="266997383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266997383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266997383">(Jan 05 2022 at 22:00)</a>:</h4>
<p>Ugh... this all feels way harder than it should</p>



<a name="266997559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266997559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266997559">(Jan 05 2022 at 22:01)</a>:</h4>
<p>Maybe I could implement <a href="https://github.com/rust-lang/rust/issues/92565">#92565</a> as a nightly-only feature? Would that be acceptable?</p>



<a name="266999108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266999108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266999108">(Jan 05 2022 at 22:13)</a>:</h4>
<p>From a compiler team perspective, I think it would be great to have some form of that on nightly for experimentation. However, you'll also want to talk to petrochenkov, as well as t-libs, about the policy around landing things as unstable features without an accepted RFC/MCP</p>



<a name="266999193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266999193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266999193">(Jan 05 2022 at 22:14)</a>:</h4>
<p>As this is a relatively significant expansion of the abilities of proc-macros</p>



<a name="266999353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/266999353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#266999353">(Jan 05 2022 at 22:15)</a>:</h4>
<p>At some point, we'll probably also want to consider the interactions with sandboxing (e.g <a href="https://github.com/rust-lang/compiler-team/issues/475">https://github.com/rust-lang/compiler-team/issues/475</a>). What paths should proc-macros be able to open?</p>



<a name="267000697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/267000697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#267000697">(Jan 05 2022 at 22:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro/near/266999193">said</a>:</p>
<blockquote>
<p>As this is a relatively significant expansion of the abilities of proc-macros</p>
</blockquote>
<p>Though proc macros can already load external files; all this does is let them get spans for the files so they can report better errors.</p>



<a name="267000736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/267000736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#267000736">(Jan 05 2022 at 22:27)</a>:</h4>
<p>Like, today you can just do <code>fs::read_to_string</code> (which is what Askama does). This would just be that + a span</p>



<a name="267000879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/267000879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#267000879">(Jan 05 2022 at 22:28)</a>:</h4>
<p>That's true. I've been mentally grouping that under 'proc macros can currently have arbitrary side effects', though those side effects don't (generally) interact with the current compilation session</p>



<a name="267001132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/267001132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#267001132">(Jan 05 2022 at 22:30)</a>:</h4>
<p>I mean, proc macros can apparently <a href="https://github.com/m-ou-se/whichever-compiles">fork the compiler</a></p>



<a name="267001261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/267001261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#267001261">(Jan 05 2022 at 22:31)</a>:</h4>
<p>I don't think a proc-macro <code>include_str!</code> would really give proc-macros much more power. E.g., using <code>expand_expr</code> with the tokens <code>include_str!(...)</code> has the same effect, except the Span is "wrong" (for my use case)</p>



<a name="267001950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/267001950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#267001950">(Jan 05 2022 at 22:38)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span>: does implementing a function <code>proc_macro::include_str</code> (name could be bikeshedded later) that is callable by proc macros and returns <code>(String, Span)</code>, with the span being for the included file, sound reasonable to you?</p>



<a name="267003784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/267003784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#267003784">(Jan 05 2022 at 22:56)</a>:</h4>
<p>As an experiment, I tried changing <code>include_str!</code> to use the included file's span—but I instead got this pretty picture:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">hello</span><span class="w"></span>
<span class="w"> </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">3</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">askama</span>::<span class="n">Template</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="n">___________________</span><span class="o">^</span><span class="w"></span>
<span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="cp">#[derive(Template)]</span><span class="w"> </span><span class="c1">// this will generate the code...</span>
<span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="n">__________</span><span class="o">--------^</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">          </span><span class="o">|</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">          </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">derive</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">expansion</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">originates</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="err">`</span><span class="n">include_str</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="n">Nightly</span><span class="w"> </span><span class="n">builds</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">-</span><span class="n">Z</span><span class="w"> </span><span class="kr">macro</span><span class="o">-</span><span class="n">backtrace</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">info</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="267022663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/267022663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#267022663">(Jan 06 2022 at 03:49)</a>:</h4>
<p>I suggest implementing whatever the current RFC in flight (<a href="https://github.com/rust-lang/rfcs/pull/3200">https://github.com/rust-lang/rfcs/pull/3200</a>) suggests.<br>
It should help to move the RFC forward as well.</p>



<a name="267023026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emit%20%60derive%60%20from%20derive%20macro/near/267023026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emit.20.60derive.60.20from.20derive.20macro.html#267023026">(Jan 06 2022 at 03:57)</a>:</h4>
<p>The issue is that the current RFC doesn't solve my use case; its <code>include_str</code> doesn't return a Span.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>