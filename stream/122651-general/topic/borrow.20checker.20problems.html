<html>
<head><meta charset="utf-8"><title>borrow checker problems · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/borrow.20checker.20problems.html">borrow checker problems</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257514435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/borrow%20checker%20problems/near/257514435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BN <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/borrow.20checker.20problems.html#257514435">(Oct 14 2021 at 10:47)</a>:</h4>
<p>I don't understand why the borrow checker complains in the following example, can anybody help me with this, please?</p>
<div class="codehilite"><pre><span></span><code>use std::collections::HashMap;
use std::fmt::Debug;

#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
struct Key {
  index: usize,
}

struct Foo {
  key_map: HashMap&lt;Key, Key&gt;,
}

impl Foo {
  fn remove_key(&amp;mut self, key: &amp;Key) {
    println!(&quot;do something here with key {:?}&quot;, key);
  }

  fn reset_at(&amp;mut self, key: &amp;Key) {
    let mut key = key;
    let key_map = &amp;self.key_map;
    key = key_map.get(key).unwrap();

    self.remove_key(key);  // Why is the immutable borrow of `key_map` still live here?
  }
}

fn main() {}
</code></pre></div>
<p>results in the following error:</p>
<div class="codehilite"><pre><span></span><code>error[E0502]: cannot borrow `*self` as mutable because it is also borrowed as immutable
  --&gt; src/main.rs:23:5
   |
20 |     let key_map = &amp;self.key_map;
   |                   ------------- immutable borrow occurs here
...
23 |     self.remove_key(key);
   |     ^^^^^----------^^^^^
   |     |    |
   |     |    immutable borrow later used by call
   |     mutable borrow occurs here
</code></pre></div>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=9f4e7b89d978f9340bef268f298ec845">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=9f4e7b89d978f9340bef268f298ec845</a></p>



<a name="257524722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/borrow%20checker%20problems/near/257524722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/borrow.20checker.20problems.html#257524722">(Oct 14 2021 at 12:19)</a>:</h4>
<p><code>HashMap::get</code> borrows key_map, <code>key</code> keeps that borrow alive</p>



<a name="257524903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/borrow%20checker%20problems/near/257524903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/borrow.20checker.20problems.html#257524903">(Oct 14 2021 at 12:21)</a>:</h4>
<p>since Key is Copy you can end the borrow by derefing it</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>