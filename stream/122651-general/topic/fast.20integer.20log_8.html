<html>
<head><meta charset="utf-8"><title>fast integer log_8 · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html">fast integer log_8</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272013645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272013645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272013645">(Feb 15 2022 at 18:02)</a>:</h4>
<p>Hey!<br>
I just wanted to ask a math/optimization question for anyone familiar with math optimization. I need to compute log_8 of an integer very fast, currently i convert to float then do the log and convert back.  However, llvm doesn't seem to turn this into anything special, so i'd rather not go through the entire logf function. I tried searching but i could not find anything on optimizing log_8 into something else, does anyone know if there is a way to rewrite log_8 so it does not need an entire float pipeline?</p>



<a name="272014017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272014017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272014017">(Feb 15 2022 at 18:04)</a>:</h4>
<p>Maybe something along the lines of <code>T::bits() - val.leading_zeros() - 3</code>? I don't know if it is correct though.</p>



<a name="272014145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272014145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272014145">(Feb 15 2022 at 18:05)</a>:</h4>
<p>For context, i am trying to figure out if an insertion into a sparse voxel octree requires an octree resize (i.e. incrementing the depth of the octree), the octree level needed for an axis length can be computed as <code>log_8(length)</code>, since the inverse is used for computing max axis length from octree depth (<code>8^(octree_depth)</code>)</p>



<a name="272014396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272014396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272014396">(Feb 15 2022 at 18:07)</a>:</h4>
<p>You mean as in</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">leading_zeros</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>?<br>
if so, that does not seem to work, <code>512</code> yields <code>487</code>, but it should instead yield 3</p>



<a name="272014567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272014567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272014567">(Feb 15 2022 at 18:08)</a>:</h4>
<p>Hmm i could probably just precompute the values for <code>0..OCTREE_DEPTH</code> then do a range check in a loop</p>



<a name="272014680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272014680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272014680">(Feb 15 2022 at 18:09)</a>:</h4>
<p><code>log_8(u64::MAX)</code> is 21.3. You could probably list the points where it changes and do (binary) search pretty quickly.</p>



<a name="272014829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272014829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272014829">(Feb 15 2022 at 18:10)</a>:</h4>
<p>my octree has a max depth of 8 currently, though usually i choose 6 (encoded in a <code>OCTREE_DEPTH</code> const), so yeah i could probably just binary search an array very quickly</p>



<a name="272016388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272016388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272016388">(Feb 15 2022 at 18:21)</a>:</h4>
<p><code>(u32::BITS - a.leading_zeros() - 1) / 3</code></p>



<a name="272016521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272016521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272016521">(Feb 15 2022 at 18:22)</a>:</h4>
<p>try <code>(1u64.leading_bits() - v.leading_bits()) / 3</code></p>



<a name="272016771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272016771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272016771">(Feb 15 2022 at 18:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="229517">Jacob Lifshay</span> <a href="#narrow/stream/122651-general/topic/fast.20integer.20log_8/near/272016521">said</a>:</p>
<blockquote>
<p>try <code>(1u64.leading_bits() - v.leading_bits()) / 3</code></p>
</blockquote>
<p>This seems to yield zero</p>



<a name="272016840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272016840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272016840">(Feb 15 2022 at 18:25)</a>:</h4>
<p>though i did leading_ones since leading_bits isn't a thing, do you mean leading_zeros?</p>



<a name="272017020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272017020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272017020">(Feb 15 2022 at 18:26)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">log_8</span><span class="p">(</span><span class="n">a</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">((</span><span class="mi">1</span><span class="k">u32</span><span class="p">.</span><span class="n">leading_zeros</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">leading_zeros</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Seems to work in the one thing i tried, lemme see if it works in all cases</p>



<a name="272017234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272017234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272017234">(Feb 15 2022 at 18:27)</a>:</h4>
<p>Hmm nope, it fails for <code>16</code></p>



<a name="272017334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272017334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272017334">(Feb 15 2022 at 18:28)</a>:</h4>
<p>it yields 1 instead of 2</p>



<a name="272017457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272017457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272017457">(Feb 15 2022 at 18:29)</a>:</h4>
<p>It calculates <code>floor(log8(x))</code>, are you looking for <code>ceil(log8(x))</code>?</p>



<a name="272017521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272017521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272017521">(Feb 15 2022 at 18:29)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=e56da8b79b7021bd235e9c9b4ef5bbe0">https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=e56da8b79b7021bd235e9c9b4ef5bbe0</a></p>



<a name="272017613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272017613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272017613">(Feb 15 2022 at 18:30)</a>:</h4>
<p>Or what is the float-based function you're trying to optimize?</p>



<a name="272017686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20integer%20log_8/near/272017686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20integer.20log_8.html#272017686">(Feb 15 2022 at 18:31)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">depth_required_for_coordinate</span><span class="p">(</span><span class="n">coordinate</span>: <span class="nc">Vec3</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u8</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">coordinate</span><span class="p">.</span><span class="n">max_element</span><span class="p">().</span><span class="n">ceil</span><span class="p">().</span><span class="n">log</span><span class="p">(</span><span class="mf">8.0</span><span class="p">).</span><span class="n">ceil</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>