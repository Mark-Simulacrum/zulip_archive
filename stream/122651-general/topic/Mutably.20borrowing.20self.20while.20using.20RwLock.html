<html>
<head><meta charset="utf-8"><title>Mutably borrowing self while using RwLock · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Mutably.20borrowing.20self.20while.20using.20RwLock.html">Mutably borrowing self while using RwLock</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260396121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Mutably%20borrowing%20self%20while%20using%20RwLock/near/260396121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Marcin Mielniczuk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Mutably.20borrowing.20self.20while.20using.20RwLock.html#260396121">(Nov 05 2021 at 12:02)</a>:</h4>
<p>Hi,</p>
<p>In our code we have a <code>struct State</code>. Since the library we're using requires a cheap <code>Clone</code> implementation (so that the state can be given to multiple workers), we're using <code>Arc&lt;RwLock&lt;...&gt;&gt;</code> for the interior fields, like </p>
<div class="codehilite"><pre><span></span><code>struct State {
    user_data: Arc&lt;RwLock&lt;HashMap&lt;String, u64&gt;&gt;&gt;,
}
</code></pre></div>
<p>We also have convenience method for modifying the state, something like </p>
<div class="codehilite"><pre><span></span><code>impl State {
    pub async fn update_data(&amp;self, user: &amp;str) {
        let entry = self.user_data.write().await.entry();
        /* modify the entry */
    }
}
</code></pre></div>
<p>We currently disagree whether the methods should rather be </p>
<div class="codehilite"><pre><span></span><code>pub async fn update_data(&amp;mut self, user: &amp;str)
</code></pre></div>
<p>since the method clearly changes the interior state. On the other hand, many rust projects only require an immutable borrow of self whenever <code>RwLock</code>, for instance <a href="https://github.com/smallnest/rpcx-rs/blob/master/rpcx_client/src/discovery.rs">this one</a>. This probably stems from the fact that, once <code>RwLock</code> is employed, there are no memory safety issues coming from the use of <code>&amp;self</code>.</p>
<p>Which way is more preferable in Rust?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>