<html>
<head><meta charset="utf-8"><title>Simulating a custom &#x27;namespace&#x27; in rustc plugin · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html">Simulating a custom &#x27;namespace&#x27; in rustc plugin</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266668164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/266668164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#266668164">(Jan 03 2022 at 09:51)</a>:</h4>
<p>Does anyone have advice on how to simulate a custom 'namespace' for identifiers in a rustc plugin (on top of the existing value / macro / type namespaces)? </p>
<p>I'd like to simulate the presence of a namespace 'foo' so that I could have a definition of <code>len</code> in <code>foo</code> and one in <code>ValueNS</code> which can't collide. </p>
<p>My current approach is for a proc-macro to append a nonce to the end of <code>len</code> so i get an identifier like <code>len_______foo</code>, and rewrite relevant calls, but this generates poor error messages...</p>



<a name="266668208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/266668208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#266668208">(Jan 03 2022 at 09:51)</a>:</h4>
<p>I'd like see if there's some way I can generate nice error messages, but intuitively this would require somehow extending resolution...</p>



<a name="266879518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/266879518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#266879518">(Jan 04 2022 at 23:38)</a>:</h4>
<p>there's <code>#[tool::attribute]</code>s you can use</p>



<a name="266879528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/266879528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#266879528">(Jan 04 2022 at 23:38)</a>:</h4>
<p>those require using <code>#![feature(register_plugin)]</code> though</p>



<a name="268005752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268005752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268005752">(Jan 14 2022 at 12:15)</a>:</h4>
<p>sorry for the delayed respone. </p>
<p>I'm already using tool attributes (and attribute macros), but here hte issue is I'm trying to enable having two definitions with the same name co-existing:</p>
<div class="codehilite"><pre><span></span><code>#[custom_namespace]
fn len(..) -&gt; .. { }

fn len(..) -&gt; .. { }
</code></pre></div>
<p>and preserve the diagnostics so that Resolution talks about <code>len</code> and not <code>len_mangled</code></p>



<a name="268005806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268005806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268005806">(Jan 14 2022 at 12:16)</a>:</h4>
<p>The immediate issue is that <code>rustc</code> emits errors directly to stdout so I have no opportunity to intercept and modify them to my convenience</p>



<a name="268009696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268009696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268009696">(Jan 14 2022 at 12:58)</a>:</h4>
<p>You could use <code>rustc_driver::RunCompiler.set_emitter()</code> when invoking the rustc driver to intercept the location to write diagnostics too and then replace say <code>____custom_namespace__</code> with an empty string.</p>



<a name="268020849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268020849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268020849">(Jan 14 2022 at 14:31)</a>:</h4>
<p><span class="user-mention" data-user-id="312719">@Xavier Denis</span> isn't that something that <code>def_site()</code> hygiene already achieves?</p>
<ul>
<li><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=629f818fb073f073cfca235ec22777fb">Playground</a></li>
</ul>



<a name="268021592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268021592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268021592">(Jan 14 2022 at 14:38)</a>:</h4>
<p>first of all: wow amazing playground link. This seems awfully close to what I need but i need definitions to conflict <em>within</em> the custom namespace, ie: </p>
<div class="codehilite"><pre><span></span><code>#[custom_namespace]
fn foo ()
{}

#[custom_namespace]
fn foo ()
{}
</code></pre></div>
<p>should be an error since they are both <code>custom_namespace</code>.</p>



<a name="268021637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268021637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268021637">(Jan 14 2022 at 14:38)</a>:</h4>
<p>Also TIL we can have blocks on the RHS of an enum (i assume any const exp?)</p>



<a name="268021708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268021708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268021708">(Jan 14 2022 at 14:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/122651-general/topic/Simulating.20a.20custom.20'namespace'.20in.20rustc.20plugin/near/268009696">said</a>:</p>
<blockquote>
<p>You could use <code>rustc_driver::RunCompiler.set_emitter()</code> when invoking the rustc driver to intercept the location to write diagnostics too and then replace say <code>____custom_namespace__</code> with an empty string.</p>
</blockquote>
<p>that seems like it would do the trick!</p>



<a name="268021818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268021818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268021818">(Jan 14 2022 at 14:40)</a>:</h4>
<p>I was wondering about the double <code>custom_namespace</code> invocation, hence why I explicitly spelled out that case. (hidden) name mangling then seems more adequate indeed</p>



<a name="268021870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268021870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268021870">(Jan 14 2022 at 14:40)</a>:</h4>
<p>yea I'm truly trying to add a 4th namespace to rustc (on top of the existing value, macro and type ones)</p>



<a name="268021896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268021896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268021896">(Jan 14 2022 at 14:41)</a>:</h4>
<p>the secret use case is that it maps to 'logical functions' for my verification tool</p>



<a name="268021911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268021911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268021911">(Jan 14 2022 at 14:41)</a>:</h4>
<p>which cannot be called from program code nor can they call program code</p>



<a name="268022058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268022058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268022058">(Jan 14 2022 at 14:42)</a>:</h4>
<p>I'm trying to make rustc error when users accidentally write a call which crosses the boundary (it currently errors much later and less clear)</p>



<a name="268126226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268126226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268126226">(Jan 15 2022 at 13:38)</a>:</h4>
<p>Well, if calling the <code>macro</code> macro only once, so that it produces one special defsite-imbued span, then a helper macro can be defined which "captures" that. Here is a demo, this time simplified to <code>m! {}</code> expanding to <code>enum Foo {}</code>, and seeing whether it conflicts with itself and/or with an explicit <code>enum Foo {}</code>.<br>
Answer: it does the desired thing: it won't conflict with an explicit <code>enum Foo {}</code>, but conflicts with itself.</p>
<p>This could further be developed to define, atop <code>m!</code>, another macro, say <code>n!</code>, which also captured that same identifier, and which would thus be able to "back-resolve" a given name into your "namespace", by tainting it back with the hygiene of the captured token.</p>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=758a469a8f4f6285f0ea2840fa692728">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=758a469a8f4f6285f0ea2840fa692728</a></p>



<a name="268126374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268126374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268126374">(Jan 15 2022 at 13:43)</a>:</h4>
<p>Here is a snippet with no <code>#[macro_export]</code>: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=8027114ff856b770e5fa62b3dc2511c1">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=8027114ff856b770e5fa62b3dc2511c1</a>. While <code>private::m! {}</code> works, doing <code>use private::m; m! {}</code>, on the other hand, triggers an ICE <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="268193494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268193494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268193494">(Jan 16 2022 at 16:19)</a>:</h4>
<p>Oh wow this is some dark magic</p>



<a name="268193508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268193508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268193508">(Jan 16 2022 at 16:20)</a>:</h4>
<p>Unfortunately it doesn’t seem applicable to my use case at least I can’t see how I can twist it to work</p>



<a name="268193549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268193549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268193549">(Jan 16 2022 at 16:20)</a>:</h4>
<p>But it’s truly impressive</p>



<a name="268195116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268195116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268195116">(Jan 16 2022 at 16:55)</a>:</h4>
<p>I think you can let <code>macro_rules! $m</code> take an ident as argument and then make it expand to a proc macro call with this ident as argument and <code>Foo</code> as argument. The proc macro can change the span of the first argument to resolve at the span of <code>Foo</code>.</p>



<a name="268199354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268199354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268199354">(Jan 16 2022 at 18:20)</a>:</h4>
<p>Yep, that would be the way to generalize <span aria-label="100" class="emoji emoji-1f4af" role="img" title="100">:100:</span></p>



<a name="268240592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268240592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268240592">(Jan 17 2022 at 08:34)</a>:</h4>
<p>Yes but I need to expose that proc macro in a crate, and I can’t do that</p>



<a name="268240661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268240661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268240661">(Jan 17 2022 at 08:35)</a>:</h4>
<p>I’m using a lot of attribute macros</p>



<a name="268240862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268240862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268240862">(Jan 17 2022 at 08:36)</a>:</h4>
<p>There’s no way to wrap an attribute macro with a decl macro, is there?</p>



<a name="268245182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268245182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268245182">(Jan 17 2022 at 09:15)</a>:</h4>
<p>Just for clarity: the input looks like this currently:</p>
<p><a href="https://github.com/xldenis/creusot/blob/master/creusot/tests/should_succeed/vector/02_gnome.rs#L8-L18">https://github.com/xldenis/creusot/blob/master/creusot/tests/should_succeed/vector/02_gnome.rs#L8-L18</a></p>



<a name="268245254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268245254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268245254">(Jan 17 2022 at 09:16)</a>:</h4>
<div class="codehilite"><pre><span></span><code>#[predicate]
fn sorted_range&lt;T: Ord&gt;(s: Seq&lt;T&gt;, l: Int, u: Int) -&gt; bool {
    pearlite! {
        forall&lt;i : Int, j : Int&gt; l &lt;= i &amp;&amp; i &lt; j &amp;&amp; j &lt; u ==&gt; s[i] &lt;= s[j]
    }
}

#[predicate]
fn sorted&lt;T: Ord&gt;(s: Seq&lt;T&gt;) -&gt; bool {
    sorted_range(s, 0, s.len())
}
</code></pre></div>
<p>And I'm trying to make <code>#[predicate]</code> act like a standalone namespace</p>



<a name="268386475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268386475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268386475">(Jan 18 2022 at 12:56)</a>:</h4>
<p><a href="/user_uploads/4715/vqvGZ_R5H_CdBDpbbT4dEaKI/Screen-Shot-2022-01-18-at-13.54.31.png">Screen-Shot-2022-01-18-at-13.54.31.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/vqvGZ_R5H_CdBDpbbT4dEaKI/Screen-Shot-2022-01-18-at-13.54.31.png" title="Screen-Shot-2022-01-18-at-13.54.31.png"><img src="/user_uploads/4715/vqvGZ_R5H_CdBDpbbT4dEaKI/Screen-Shot-2022-01-18-at-13.54.31.png"></a></div><ul>
<li>
<p><a href="https://asciinema.org/a/oqW8Fmi8LQ4yWSDjlUTjyNJIJ">Demo</a></p>
</li>
<li>
<p>No compiler/rustc was tweaked/harmed during this recording, only proc-macro with <code>Span::def_site()</code> shenanigans <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>
</li>
</ul>



<a name="268387713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268387713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268387713">(Jan 18 2022 at 13:06)</a>:</h4>
<p>So, in your case, the <code>#[custom_namespace]</code> attribute of that crate, alone, ought to already suit you; and I've even demo'd being able to let users define even more namespaces.<br>
Regarding how it works,</p>
<ol>
<li><code>#[custom_namespace(something_interestingly_spanned)]</code> overrides the <code>resolve_at</code> span of the annotated item with that of the attribute arg;</li>
<li><code>with_unique_ident!</code> is a helper (proc-macro) which invokes the given (pseudo) "macro rule" with a "fresh" <code>def-site()</code> identifier: this allows repeating it within that scope (<em>e.g.</em>, <code>let $foo = 42; let x = $foo;</code> works), but a <code>$foo</code> from one invocation is seen as distinct from that from another invocation.</li>
<li>With both such tools, one can define their own "custom namespacer macro" by writing what I've written for <code>my_new_namespace</code> (basically use a <code>with_unique_ident!</code> scope (and thus, ident) to define a macro that calls <code>#[custom_namespace(that_ident)]</code> on its arg).</li>
<li>Finally, my crate does step <code>3.</code> on its own for some hidden macro, and then <code>#[custom_namespace]</code> (no args) defaults to calling that hidden macro</li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// in my crate</span>
<span class="n">with_unique_ident</span><span class="o">!</span><span class="w"> </span><span class="p">{(</span><span class="w"> </span><span class="cp">$my_ns</span>:<span class="nc">unique_ident</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[doc(hidden)]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[macro_export]</span><span class="w"></span>
<span class="w">    </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">__custom_namespaced__</span><span class="w"> </span><span class="p">{(</span><span class="w"> </span><span class="cp">$item</span>:<span class="nc">item</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[$crate::custom_namespace($my_ns)]</span><span class="w"></span>
<span class="w">        </span><span class="cp">$item</span><span class="w"></span>
<span class="w">    </span><span class="p">)}</span><span class="w"></span>
<span class="p">)}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// within the logic of `#[custom_namespace]`:</span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">namespace</span>: <span class="nc">Span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">it</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">namespace</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">quote</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span>::<span class="n">demo</span>::<span class="n">__custom_namespaced__</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>#<span class="n">input</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">));</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>and <em>voilà</em></p>



<a name="268388389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268388389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268388389">(Jan 18 2022 at 13:12)</a>:</h4>
<p>FWIW, <code>with_unique_ident</code> alone is quite powerful, and the most explicit one, if a bit verbose. It has a nifty feature, which is that the name of the <code>:unique_ident</code> metavariable is also the actual symbol picked for the specially-spanned parameter:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">with_unique_ident</span><span class="o">!</span><span class="w"> </span><span class="p">{(</span><span class="w"> </span><span class="cp">$Foo</span>:<span class="nc">unique_ident</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">enum</span> <span class="cp">$Foo</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// typename::&lt;$Foo&gt;() == "path::to::Foo"</span>
<span class="p">)}</span><span class="w"></span>
</code></pre></div>
<p>so this makes:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">with_unique_ident</span><span class="o">!</span><span class="w"> </span><span class="p">{(</span><span class="w"> </span><span class="cp">$ns</span>:<span class="nc">unique_ident</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[custom_namespace($ns)]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">bar</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">)}</span><span class="w"></span>
</code></pre></div>
<p>literally equivalent to:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">with_unique_ident</span><span class="o">!</span><span class="w"> </span><span class="p">{(</span><span class="w"> </span><span class="cp">$bar</span>:<span class="nc">unique_ident</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="cp">$bar</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">)}</span><span class="w"></span>
</code></pre></div>
<p>if that makes sense?</p>



<a name="268402143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268402143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268402143">(Jan 18 2022 at 14:54)</a>:</h4>
<p>Oh my god</p>



<a name="268402162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268402162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268402162">(Jan 18 2022 at 14:54)</a>:</h4>
<p>You’re incredible</p>



<a name="268402194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268402194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268402194">(Jan 18 2022 at 14:54)</a>:</h4>
<p>I’ll take 3 of you please, and thank you</p>



<a name="268402520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268402520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268402520">(Jan 18 2022 at 14:56)</a>:</h4>
<p>And I assume that once I modify the resolve_at span, that interacts with hygiene so you can see other methods defined in the same span?</p>



<a name="268402549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268402549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268402549">(Jan 18 2022 at 14:56)</a>:</h4>
<p>Hyyyyype</p>



<a name="268403018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268403018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268403018">(Jan 18 2022 at 14:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/122651-general/topic/Simulating.20a.20custom.20'namespace'.20in.20rustc.20plugin/near/268402520">said</a>:</p>
<blockquote>
<p>And I assume that once I modify the resolve_at span, that interacts with hygiene so you can see other methods defined in the same span?</p>
</blockquote>
<p>Yes, that's the part missing in my PoC: a macro to reverse the process <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="268403415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268403415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268403415">(Jan 18 2022 at 15:01)</a>:</h4>
<p>What do you mean, reverse?</p>



<a name="268403450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268403450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268403450">(Jan 18 2022 at 15:01)</a>:</h4>
<p>To allow items defined in the custom namespace to be accessible outside?</p>



<a name="268403464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268403464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268403464">(Jan 18 2022 at 15:01)</a>:</h4>
<p>Or accessible between each other</p>



<a name="268403669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268403669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268403669">(Jan 18 2022 at 15:02)</a>:</h4>
<p>I figured that if <code>à</code> and <code>b</code> have the same spans then they would be able to see each other (which is how the conflict would potentially occur)</p>



<a name="268435365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268435365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268435365">(Jan 18 2022 at 18:28)</a>:</h4>
<p>I mean something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[custom_namespace]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">bar</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="cp">#[custom_namespace]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">baz</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">();</span><span class="w"> </span><span class="c1">// &lt;- how do we make this work?</span>
<span class="w">    </span><span class="n">bar</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>We'd need a way to say that <code>foo()</code> call, there, has to resolve using the <code>custom_namespace</code>. So it's not "reverse" in that it's still about imbuing a given identifier with a custom namespace's span, but it's reverse in that it's used for a <em>use</em> / <em>call</em> rather than a <em>definition</em>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[custom_namespace]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">baz</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">custom_namespace</span><span class="o">!</span><span class="p">(</span><span class="n">foo</span><span class="p">)();</span><span class="w"> </span><span class="c1">// &lt;- works for simple cases (such as yours, I believe)</span>
<span class="w">    </span><span class="n">bar</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[custom_namespace]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span>: <span class="kt">i32</span> <span class="p">}</span><span class="w"></span>

<span class="n">custom_namespace</span><span class="o">!</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span>: <span class="kt">i32</span> <span class="p">}</span><span class="w"> </span><span class="c1">// wouldn't work because of Rust grammar</span>
</code></pre></div>



<a name="268437673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268437673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268437673">(Jan 18 2022 at 18:47)</a>:</h4>
<p>ah i thought that the whole body of <code>baz</code> would inherit the namespace</p>



<a name="268437731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268437731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268437731">(Jan 18 2022 at 18:47)</a>:</h4>
<p>because yea, that is reptty essential, to have <code>foo()</code> work but not<code>bar()</code></p>



<a name="268437732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268437732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268437732">(Jan 18 2022 at 18:47)</a>:</h4>
<p>It could, but then <code>bar()</code> wouldn't resolve, I suspect</p>



<a name="268437749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268437749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268437749">(Jan 18 2022 at 18:48)</a>:</h4>
<p>that's good</p>



<a name="268437806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268437806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268437806">(Jan 18 2022 at 18:48)</a>:</h4>
<p>these namespaces can't interact</p>



<a name="268437887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268437887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268437887">(Jan 18 2022 at 18:48)</a>:</h4>
<p>Oh, then yeah, it's quite easy to make my <code>#[custom_namespace]</code> macro override <em>everything</em>. This would allow not even depending on <code>syn</code>, then, since it wouldn't need to locate the function name</p>



<a name="268437917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268437917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268437917">(Jan 18 2022 at 18:49)</a>:</h4>
<p>Will soon publish this PoC so that you can directly toy with it <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="268437949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268437949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268437949">(Jan 18 2022 at 18:49)</a>:</h4>
<p>i already have syn for other reasons</p>



<a name="268437965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268437965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268437965">(Jan 18 2022 at 18:49)</a>:</h4>
<p>so that's no issue</p>



<a name="268438019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268438019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268438019">(Jan 18 2022 at 18:49)</a>:</h4>
<p>I'm already doing plenty of proc macro hackery, extending the syntax of 'rust' expressions etc...</p>



<a name="268438131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268438131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268438131">(Jan 18 2022 at 18:50)</a>:</h4>
<p>trying to fit a whole other language into rust is no easy feat</p>



<a name="268438163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268438163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268438163">(Jan 18 2022 at 18:50)</a>:</h4>
<p>But a satisfying one (I imagine)</p>



<a name="268438207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268438207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268438207">(Jan 18 2022 at 18:51)</a>:</h4>
<p>oh yes, nothing is more satisfying than finding some awful hack which <em>works</em></p>



<a name="268438264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268438264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268438264">(Jan 18 2022 at 18:51)</a>:</h4>
<p>it all works cross-crate too which is exciting for me</p>



<a name="268438309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268438309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268438309">(Jan 18 2022 at 18:51)</a>:</h4>
<p>it means you can export formally verified crates and use them in projects! seamlessly!</p>



<a name="268448219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268448219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268448219">(Jan 18 2022 at 20:06)</a>:</h4>
<p>did you actually implement <code>with_unique_ident</code>? seems like a pretty powerful / rich macro</p>



<a name="268448316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268448316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268448316">(Jan 18 2022 at 20:07)</a>:</h4>
<p>I was going to implement a simpler macro which just returned a random def_site identifier</p>



<a name="268467256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268467256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268467256">(Jan 18 2022 at 22:48)</a>:</h4>
<p>just realizing something, the <code>def_site</code> approach can't support modules, can it?</p>



<a name="268467299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268467299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268467299">(Jan 18 2022 at 22:49)</a>:</h4>
<p>ie: </p>
<div class="codehilite"><pre><span></span><code>#[custom_namespace]
fn f() { ... }
mod a {
  #[custom_namespace]
  fn f() { ... }
}
</code></pre></div>



<a name="268471309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268471309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268471309">(Jan 18 2022 at 23:26)</a>:</h4>
<p>I'm pretty sure that should work just fine. You got the custom span, but also a different defpath (<code>crate::a::f</code> vs <code>crate::f</code>).</p>



<a name="268531791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268531791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268531791">(Jan 19 2022 at 12:34)</a>:</h4>
<p>Sorry to bother you again after all your help, but I can't seem to get calls within the custom_namespace to work</p>



<a name="268531820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268531820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268531820">(Jan 19 2022 at 12:34)</a>:</h4>
<p>I've tried replacing the resolution span of all the tokens in the item</p>



<a name="268531833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268531833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268531833">(Jan 19 2022 at 12:34)</a>:</h4>
<p>but that doesn't seem to do the trick either</p>



<a name="268531907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268531907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268531907">(Jan 19 2022 at 12:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/122651-general/topic/Simulating.20a.20custom.20'namespace'.20in.20rustc.20plugin/near/268471309">said</a>:</p>
<blockquote>
<p>I'm pretty sure that should work just fine. You got the custom span, but also a different defpath (<code>crate::a::f</code> vs <code>crate::f</code>).</p>
</blockquote>
<p>yea I guess i still don't fully understand rust macro hygiene but this works</p>



<a name="268531959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268531959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268531959">(Jan 19 2022 at 12:35)</a>:</h4>
<p>I figured that setting the resolve span would have been the same as if we placed all the item tokens within a shared <code>mod</code></p>



<a name="268532468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268532468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268532468">(Jan 19 2022 at 12:40)</a>:</h4>
<p>Ah, seems like maybe <code>def_site</code> is not appropriate? I don't understand how the resolution process for <em>defintions</em> differs from the process for <em>uses</em></p>



<a name="268628278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268628278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268628278">(Jan 20 2022 at 01:19)</a>:</h4>
<p>Sorry, have been a bit busy, will resume these experiments and publish them this w-e, probably. Each <code>Span::def_site()</code> is <em>unique</em> per <em>invocation</em> of the proc-macro wherein the <code>Span::def_site()</code> call occurs. This is how I created the <code>with_unique_ident!</code> macro.<br>
Then the key idea is that once you get hold of one such span, you no longer call <code>Span::def_site()</code> (or <code>with_unique_ident!</code>) anymore, just that one time, at which point you "gift" that span to other macros to use (this is how <code>#[custom_namespace]</code> is defined).</p>
<p>So, in my PoC, all the <code>#[custom_namespace]</code> invocations use the one <code>Span::def_site()</code> that got instanced, and so, when performing look-ups, ought to be able to see each other. That being said, I haven't tested that part too much yet, and there may be some quirks in that regard (I've, for instance, noticed that a <code>macro_rules!</code> sometimes can't perform a fully hygienic lookup (even when given a defsite-imbued identifier, I mean), so maybe you've hit that situation).</p>
<p>More <span aria-label="detective" class="emoji emoji-1f575" role="img" title="detective">:detective:</span> this weekend</p>



<a name="268657815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268657815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268657815">(Jan 20 2022 at 08:30)</a>:</h4>
<p>I think that’s the issue I’m encountering because I wrote a macro which returns a macro-rules macro containing a def_site span</p>



<a name="268657873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268657873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268657873">(Jan 20 2022 at 08:31)</a>:</h4>
<p>Basically I wrote a macro which hard codes your invocation of with_unique_ident</p>



<a name="268658263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268658263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268658263">(Jan 20 2022 at 08:35)</a>:</h4>
<p>I’m fairly certain it’s all working as I can trigger conflicts within the custom namespace which are separate from the normal namespace</p>



<a name="268658323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268658323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268658323">(Jan 20 2022 at 08:35)</a>:</h4>
<p>But I’m still unable to resolve calls</p>



<a name="268708954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268708954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268708954">(Jan 20 2022 at 15:27)</a>:</h4>
<p>I have a sneaking suspicion that the generated <code>macro_rules!</code> ends up creating a new <code>Span</code> at each invocation, even though it should just be copying a single token...</p>
<p>Printing the token at each invocation of <code>custom_namespace</code> gives: </p>
<div class="codehilite"><pre><span></span><code>TokenStream [Ident { ident: &quot;__creusot__&quot;, span: #14 bytes(10935360..10935394) }]
TokenStream [Ident { ident: &quot;__creusot__&quot;, span: #23 bytes(10935360..10935394) }]
</code></pre></div>
<p>at the sametime the actual <em>definitions</em> can conflict so the spans must be overlapping at least for definition resolution...</p>



<a name="268828839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Simulating%20a%20custom%20%27namespace%27%20in%20rustc%20plugin/near/268828839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Simulating.20a.20custom.20&#x27;namespace&#x27;.20in.20rustc.20plugin.html#268828839">(Jan 21 2022 at 11:26)</a>:</h4>
<p>I'm sort of taking notes out-loud, anyone passing by should feel free to correct me.</p>
<p>I think i'm starting to get a better grasp of how proc macro and decl macro hygiene interacts, and also why that the current approach can't  resolve calls to other <code>custom_namespace</code> functions. </p>
<p>Each time a decl macro is invoked, it creates a new syntax context for all tokens, including any that were 'interestingly spanned'. Its within this context we end up declaring functions. However, that means that successive calls to the macro containing the 'def_site' token will continuously give it new contexts, with no relation between them. </p>
<p>What doesn't fit with my understanding of these contexts / spans is how function resolution can conflict? Shouldn't never conflict if they're within different contexts?</p>
<p>The crux of the issue will be finding a way to recover a span that has the same syntax context across invocations, yet is different from the root context <code>#0</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>