<html>
<head><meta charset="utf-8"><title>Dropping a raw slice that contains invalid values · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html">Dropping a raw slice that contains invalid values</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273049045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273049045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273049045">(Feb 24 2022 at 05:23)</a>:</h4>
<p>If a Vec-like struct has some heap memory allocated, but has already drained the values inside, what's the correct way to deallocate that memory (which is now in an invalid state)?</p>
<p>For example,</p>
<div class="codehilite"><pre><span></span><code>struct MyVec&lt;T&gt; {
    contents: *const T,
    capacity: usize,
    length: usize,
}

impl&lt;T&gt; Drop for MyVec&lt;T&gt; {
    fn drop(&amp;mut self) {
        // There&#39;s no easy way to deal with half-initialized arrays/slices.
        // To get a fully-uninitialized array, iterate over the contents,
        // dropping them.
        for _ in self.drain() {}
        unsafe {
            // Now that the contents have been dropped, drop the array memory
            // without interpreting it as initialized.
            let contents = self.contents as *mut MaybeUninit&lt;T&gt;;
            let raw_slice = slice::from_raw_parts_mut(contents, self.capacity);
            let _dropme = Box::from_raw(raw_slice);
        }
    }
}
</code></pre></div>
<p>Is there an easier way to drop a raw slice than casting it as a slice of <code>MaybeUninit</code>, then adopting it into a <code>Box&lt;[MaybeUninit&lt;T&gt;]</code>, then dropping the Box?</p>



<a name="273049914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273049914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273049914">(Feb 24 2022 at 05:41)</a>:</h4>
<p>Deallocate the memory without running any destructors of T. With Vec you could do that with <code>.set_len(0)</code> for example.</p>



<a name="273049967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273049967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273049967">(Feb 24 2022 at 05:42)</a>:</h4>
<p>Where are you getting the pointer from?</p>



<a name="273050008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273050008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273050008">(Feb 24 2022 at 05:43)</a>:</h4>
<p>This (and other things) are also answered by <a href="https://doc.rust-lang.org/nomicon/vec/vec.html">https://doc.rust-lang.org/nomicon/vec/vec.html</a></p>



<a name="273051712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273051712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273051712">(Feb 24 2022 at 06:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="433532">mejrs</span> <a href="#narrow/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values/near/273049967">said</a>:</p>
<blockquote>
<p>Where are you getting the pointer from?</p>
</blockquote>
<p>In my current code, the pointer and length began life as a <code>Box&lt;[T]&gt;</code>, though it's possible that they could have originated from a Vec as well. There's no FFI in the picture; I am just experimenting with my own Vec-like constructs.</p>



<a name="273051770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273051770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> LegionMammal978 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273051770">(Feb 24 2022 at 06:16)</a>:</h4>
<p>The comment mentions that the contents start "half-initialized". If the vector is not fully initialized, then <code>self.drain()</code> causes UB just from reading uninitialized memory, and dropping the values returned from it can cause further UB depending on <code>T</code>.</p>



<a name="273051792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273051792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> LegionMammal978 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273051792">(Feb 24 2022 at 06:16)</a>:</h4>
<p>If it is fully initialized, then the <code>drop</code> function is trivial:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">raw_slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slice</span>::<span class="n">from_raw_parts_mut</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">contents</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">capacity</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="nb">drop</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">raw_slice</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="273051806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273051806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273051806">(Feb 24 2022 at 06:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="429617">LegionMammal978</span> <a href="#narrow/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values/near/273051770">said</a>:</p>
<blockquote>
<p>The comment mentions that the contents start "half-initialized". If the vector is not fully initialized, then <code>self.drain()</code> causes UB just from reading uninitialized memory, and dropping the values returned from it can cause further UB depending on <code>T</code>.</p>
</blockquote>
<p>Sorry if the comment is misleading; the "half-initialized" state would result from a fully-initialized <code>MyVec</code> that has been partially drained.<br>
So what was once a 4-element array of valid values could now be e.g. a 4-element array containing 2 valid values and 2 invalid values. The call to drain() is meant to drop the remaining valid values to place the memory in a fully invalid state.</p>



<a name="273051957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273051957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273051957">(Feb 24 2022 at 06:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="433532">mejrs</span> <a href="#narrow/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values/near/273050008">said</a>:</p>
<blockquote>
<p>This (and other things) are also answered by <a href="https://doc.rust-lang.org/nomicon/vec/vec.html">https://doc.rust-lang.org/nomicon/vec/vec.html</a></p>
</blockquote>
<p>This looks quite useful, thanks! I wasn't familiar with this style of deallocation.</p>



<a name="273052319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273052319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> LegionMammal978 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273052319">(Feb 24 2022 at 06:28)</a>:</h4>
<p>Note that <code>std::alloc::dealloc</code> may eventually be deprecated; your current code is the most futureproof, since it doesn't depend on the <code>Box</code>'s underlying allocator.</p>



<a name="273053974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273053974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273053974">(Feb 24 2022 at 07:00)</a>:</h4>
<p>If you use something like box::from_raw to deallocate it, you can't use a pointer derived from vec</p>



<a name="273054206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273054206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273054206">(Feb 24 2022 at 07:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="383356">Eric Seppanen</span> <a href="#narrow/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values/near/273049045">said</a>:</p>
<blockquote>
<p>If a Vec-like struct has some heap memory allocated, but has already drained the values inside, what's the correct way to deallocate that memory (which is now in an invalid state)?</p>
<p>For example,</p>
<p><div class="codehilite"><pre><span></span><code>struct MyVec&lt;T&gt; {
    contents: *const T,
    capacity: usize,
    length: usize,
}
</code></pre></div><br>
</p>
</blockquote>
<p>Have you considered just storing that as</p>
<div class="codehilite"><pre><span></span><code>struct MyVec&lt;T, A = Global&gt; {
    buffer: Box&lt;[MaybeUninit&lt;T&gt;], A&gt;,
    length: usize,
}
</code></pre></div>
<p>instead?  Then the drop glue will correctly handle deallocating, so you can not worry about that part and will just need to deal with <code>drop_in_place</code>ing the initialized elements.</p>
<p>But in general, <code>.for_each(drop);</code> to run an iterator to the end is a great way to deal with the elements.</p>
<p><code>vec::Drain</code> has such a loop too: <a href="https://doc.rust-lang.org/1.58.0/src/alloc/vec/drain.rs.html#134-139">https://doc.rust-lang.org/1.58.0/src/alloc/vec/drain.rs.html#134-139</a></p>



<a name="273055163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273055163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273055163">(Feb 24 2022 at 07:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="433532">mejrs</span> <a href="#narrow/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values/near/273053974">said</a>:</p>
<blockquote>
<p>If you use something like box::from_raw to deallocate it, you can't use a pointer derived from vec</p>
</blockquote>
<p>Why is that?</p>



<a name="273056928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273056928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273056928">(Feb 24 2022 at 07:54)</a>:</h4>
<p>Short answer: because the documentation says so</p>



<a name="273057113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273057113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273057113">(Feb 24 2022 at 07:57)</a>:</h4>
<p>Can you point me toward the relevant documentation?</p>



<a name="273057193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273057193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273057193">(Feb 24 2022 at 07:58)</a>:</h4>
<p>Long answer: I'm not really qualified to explain, but these types can allocate in different ways, so you generally can only use from_raw types functions if they came from appropriate into_raw functions</p>



<a name="273057236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273057236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273057236">(Feb 24 2022 at 07:59)</a>:</h4>
<p><a href="https://doc.rust-lang.org/std/boxed/struct.Box.html#method.from_raw">https://doc.rust-lang.org/std/boxed/struct.Box.html#method.from_raw</a></p>



<a name="273057624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273057624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273057624">(Feb 24 2022 at 08:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="433532">mejrs</span> <a href="#narrow/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values/near/273057236">said</a>:</p>
<blockquote>
<p><a href="https://doc.rust-lang.org/std/boxed/struct.Box.html#method.from_raw">https://doc.rust-lang.org/std/boxed/struct.Box.html#method.from_raw</a></p>
</blockquote>
<p>I don't see any rules there about the origin of the pointer.</p>



<a name="273057704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273057704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273057704">(Feb 24 2022 at 08:05)</a>:</h4>
<p>Also, I don't understand how <code>Vec::into_boxed_slice</code> could work then, because it seems to do a very similar thing.</p>



<a name="273057963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273057963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273057963">(Feb 24 2022 at 08:09)</a>:</h4>
<p><code>Box::from_raw</code> requires the allocation to be exactly as big as the type says. A <code>Vec</code> often has extra capacity. <code>Vec::into_boxed_slice</code> reallocates to drop the extra capacity if any.</p>



<a name="273058092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273058092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273058092">(Feb 24 2022 at 08:11)</a>:</h4>
<p>imo </p>
<blockquote>
<p>For this to be safe, the memory must have been allocated in accordance with the memory layout used by Box .</p>
</blockquote>
<p>That and the Vec docs are vague enough. and I don't see it spelled out anywhere, so that's why i wouldn't recommend it</p>



<a name="273058175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273058175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273058175">(Feb 24 2022 at 08:12)</a>:</h4>
<p>Also looking at std's implementation details to see what is allowed is usually a bad idea, because they're... well, implementation details</p>



<a name="273058288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273058288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273058288">(Feb 24 2022 at 08:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values/near/273057963">said</a>:</p>
<blockquote>
<p><code>Box::from_raw</code> requires the allocation to be exactly as big as the type says. A <code>Vec</code> often has extra capacity. <code>Vec::into_boxed_slice</code> reallocates to drop the extra capacity if any.</p>
</blockquote>
<p>Here I'm assuming code (like that at the top) which is capable of tracking the spare capacity also. I think the question is whether the heap-allocated-bytes backing a Vec are compatible with the heap-allocated-bytes inside a boxed slice. Enough that converting one into the other and then deallocating that memory is safe.</p>



<a name="273058654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273058654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273058654">(Feb 24 2022 at 08:18)</a>:</h4>
<p><span class="user-mention" data-user-id="433532">@mejrs</span>  I would love to see more documentation of what you're describing.</p>
<p>The fact that std <code>Vec&lt;T&gt;</code> and <code>Box&lt;[T]&gt;</code> can be converted back and forth without reallocating (excluding the possible shrink_to_fit)  seems like a pretty strong signal that there's no magic "pointer provenance" violation there.</p>



<a name="273059344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273059344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273059344">(Feb 24 2022 at 08:27)</a>:</h4>
<p>The Vec and Box docs have documentation about what they guarantee</p>



<a name="273059690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273059690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273059690">(Feb 24 2022 at 08:31)</a>:</h4>
<p>Can you be more specific? I'm not seeing it.</p>



<a name="273059765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273059765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273059765">(Feb 24 2022 at 08:32)</a>:</h4>
<p><a href="https://doc.rust-lang.org/alloc/vec/struct.Vec.html#guarantees">https://doc.rust-lang.org/alloc/vec/struct.Vec.html#guarantees</a><br>
<a href="https://doc.rust-lang.org/alloc/boxed/index.html#memory-layout">https://doc.rust-lang.org/alloc/boxed/index.html#memory-layout</a></p>



<a name="273060429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273060429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273060429">(Feb 24 2022 at 08:39)</a>:</h4>
<p>I don't think those pages mean to say that Vec&lt;-&gt;Box by way of raw pointers is unsound by definition.</p>



<a name="273060960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273060960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273060960">(Feb 24 2022 at 08:45)</a>:</h4>
<p>Yeah that's my point - it doesn't say it's allowed, so I'm assuming it is just an implementation detail and not allowed</p>



<a name="273061021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273061021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273061021">(Feb 24 2022 at 08:46)</a>:</h4>
<p>The uninitialized space is pretty hazardous, and I would probably want to stay away from that.<br>
If I'm calling <code>into_boxed_slice</code>, then I would certainly hope that Box can deconstructed, later reassembled, and freed (as a <code>Box&lt;[T]&gt;</code>).</p>



<a name="273061086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273061086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273061086">(Feb 24 2022 at 08:47)</a>:</h4>
<p>That's why <span class="user-mention" data-user-id="125270">@scottmcm</span> 's solution uses <code>Box&lt;[MaybeUninit&lt;T&gt;], A&gt;</code></p>



<a name="273061475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273061475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273061475">(Feb 24 2022 at 08:52)</a>:</h4>
<p>(It makes it clear that the job of <em>this</em> type is just to track the initialized-ness of the slots in that storage.  Actually deallocating the space is <code>Box</code>'s problem.  And you can use something like <code>MaybeUninit::slice_assume_init_mut(&amp;mut self.buffer[..self.length])</code> in your <code>DerefMut</code> if you want to give out <code>&amp;mut [T]</code>s.)</p>



<a name="273061847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273061847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Seppanen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273061847">(Feb 24 2022 at 08:56)</a>:</h4>
<p>I like <span class="user-mention" data-user-id="125270">@scottmcm</span>'s code too. I don't think that has much to do with the argument whether pointers with Vec origin are unsound (when dropped as a boxed slice of <code>MaybeUninit&lt;T&gt;</code>).</p>



<a name="273084368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Dropping%20a%20raw%20slice%20that%20contains%20invalid%20values/near/273084368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values.html#273084368">(Feb 24 2022 at 12:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/122651-general/topic/Dropping.20a.20raw.20slice.20that.20contains.20invalid.20values/near/273054206">said</a>:</p>
<blockquote>
<p><code>vec::Drain</code> has such a loop too: <a href="https://doc.rust-lang.org/1.58.0/src/alloc/vec/drain.rs.html#134-139">https://doc.rust-lang.org/1.58.0/src/alloc/vec/drain.rs.html#134-139</a></p>
</blockquote>
<p>Had. <a href="https://doc.rust-lang.org/nightly/src/alloc/vec/drain.rs.html#106">https://doc.rust-lang.org/nightly/src/alloc/vec/drain.rs.html#106</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>