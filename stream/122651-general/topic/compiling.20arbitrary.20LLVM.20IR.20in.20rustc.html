<html>
<head><meta charset="utf-8"><title>compiling arbitrary LLVM IR in rustc · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20arbitrary.20LLVM.20IR.20in.20rustc.html">compiling arbitrary LLVM IR in rustc</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276766556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20arbitrary%20LLVM%20IR%20in%20rustc/near/276766556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stefan J. Wernli <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20arbitrary.20LLVM.20IR.20in.20rustc.html#276766556">(Mar 27 2022 at 05:14)</a>:</h4>
<p>Hi all, I'm curious to get feedback on an idea. I'd like to work on an addition to rustc that allows passing arbitrary LLVM IR or bitcode as additional modules during compilation. It's already possible to compile LLVM into a rust project by using something like the cc crate, but that requires clang as an external dependency. My interest is in providing a way to include bitcode without requiring dependencies outside of rustc, and it seems like it should be possible by including the user provided contents in the modules passed to LLVM after codegen. Do any plans for something like this already exist? Has such an idea already been discussed and rejected, and if so, why?</p>
<p>I may build a prototype just for the experience, but I'd like to understand if this is something that I should try to make an RFC. This is my first time on zulip, so happy to be redirected to a more appropriate place to ask this question!</p>



<a name="276777818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20arbitrary%20LLVM%20IR%20in%20rustc/near/276777818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20arbitrary.20LLVM.20IR.20in.20rustc.html#276777818">(Mar 27 2022 at 09:16)</a>:</h4>
<p>How would that interact with non-LLVM backends?</p>



<a name="276781513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20arbitrary%20LLVM%20IR%20in%20rustc/near/276781513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20arbitrary.20LLVM.20IR.20in.20rustc.html#276781513">(Mar 27 2022 at 10:41)</a>:</h4>
<p>Also what LLVM version will you generate bitcode for? While the officially distributed rustc uses a very recent LLVM version, distros often build it against an LLVM that is several versions older. While newer LLVM can load older bitcode, the opposite is not true. Even if it seems like it succeeded, you may have inadvertently introduced UB due to an attribute being ignored.</p>



<a name="276781581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20arbitrary%20LLVM%20IR%20in%20rustc/near/276781581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20arbitrary.20LLVM.20IR.20in.20rustc.html#276781581">(Mar 27 2022 at 10:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/122651-general/topic/compiling.20arbitrary.20LLVM.20IR.20in.20rustc/near/276777818">said</a>:</p>
<blockquote>
<p>How would that interact with non-LLVM backends?</p>
</blockquote>
<p>There are currently two such backends:</p>
<ul>
<li>rustc_codegen_gcc by <span class="user-mention silent" data-user-id="404242">antoyo</span> with a focus on portability</li>
<li>rustc_codegen_cranelift by me with a focus on compilation speed</li>
</ul>



<a name="276804036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20arbitrary%20LLVM%20IR%20in%20rustc/near/276804036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Stefan J. Wernli <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20arbitrary.20LLVM.20IR.20in.20rustc.html#276804036">(Mar 27 2022 at 19:39)</a>:</h4>
<p>Good questions. Unlike clang, which allows providing .bc or .ll files the same way as .c and .cpp files, I think these should be differentiated from .rs files by a special flag. Since the IR may come from any tools that can produce it as output, it would be treated as an external static dependency and treated as unsafe by default. So it would be more analogous to providing static libraries to satisfy extern declarations than a mechanism for including other rust code. If LLVM files are provided via this flag when compiling with non-LLVM codegen backends, it would be an error.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>