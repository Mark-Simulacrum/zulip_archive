<html>
<head><meta charset="utf-8"><title>HRTB and dyn · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html">HRTB and dyn</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271878297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271878297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luis Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271878297">(Feb 14 2022 at 19:42)</a>:</h4>
<p>TLDR: Where do I put the HRTB when using <code>dyn</code>?</p>
<p>I'm trying to use generators (which are currently unstable) for my project.<br>
I want to store a generator in a struct. Since generators are basically closures and therefore have unique types, I store a trait object<code>Pin&lt;Box&lt;dyn Generator&lt;...&gt;&gt;&gt;</code>.<br>
I have to specify the resume type, which is the same for generators as the argument type is for closures. I have a <code>Pin&lt;Box&lt;dyn Generator&lt;&amp;'a Foo, Yield = (), Return = ()&gt;&gt;&gt;</code>, where <code>&amp;'a Foo</code> is the resume type.<br>
The <code>Generator</code> trait suffers from the same problem as the <code>Fn</code> traits do: They require HRTB.<br>
If I were to use static dispatch instead of trait objects, I would specify it like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Bar</span><span class="o">&lt;</span><span class="n">G</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">G</span>: <span class="nc">Generator</span><span class="o">&lt;&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">Foo</span><span class="p">,</span><span class="w"> </span><span class="n">Yield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">Return</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">generator</span>: <span class="nc">G</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>But when using <code>dyn</code> I don't know where to put the <code>where</code> clause.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Bar</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">generator</span>: <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Generator</span><span class="o">&lt;&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">Foo</span><span class="p">,</span><span class="w"> </span><span class="n">Yield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">Return</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>What do I have to do?</p>



<a name="271880355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271880355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271880355">(Feb 14 2022 at 19:59)</a>:</h4>
<p><code>dyn for&lt;'a&gt; ...</code> works</p>



<a name="271884441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271884441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luis Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271884441">(Feb 14 2022 at 20:33)</a>:</h4>
<p>Oh, thanks! Should have thought of it myself...</p>



<a name="271886846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271886846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luis Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271886846">(Feb 14 2022 at 20:54)</a>:</h4>
<p>How do these errors make any sense?</p>
<div class="codehilite"><pre><span></span><code>error[E0308]: mismatched types
  --&gt; src/show/demo.rs:59:12
   |
59 |     Self { generator }
   |            ^^^^^^^^^ one type is more general than the other
   |
   = note: expected type `for&lt;&#39;a&gt; core::ops::Generator&lt;(&amp;&#39;a mut light::Lights, util::AsmDelay)&gt;`
              found type `core::ops::Generator&lt;(&amp;mut light::Lights, util::AsmDelay)&gt;`

error: implementation of `core::ops::Generator` is not general enough
  --&gt; src/show/demo.rs:59:12
   |
59 |     Self { generator }
   |            ^^^^^^^^^ implementation of `core::ops::Generator` is not general enough
   |
   = note: `[generator@src/show/demo.rs:26:21: 55:6]` must implement `core::ops::Generator&lt;(&amp;&#39;1 mut ligh
t::Lights, util::AsmDelay)&gt;`, for any lifetime `&#39;1`...
   = note: ...but it actually implements `core::ops::Generator&lt;(&amp;&#39;2 mut light::Lights, util::AsmDelay)&gt;`
, for some specific lifetime `&#39;2`
</code></pre></div>
<p>How are these different?<br>
<code>core::ops::Generator&lt;(&amp;'1 mut light::Lights, util::AsmDelay)&gt;</code>, for any lifetime <code>'1</code>...<br>
<code>core::ops::Generator&lt;(&amp;'2 mut light::Lights, util::AsmDelay)&gt;</code><br>
, for some specific lifetime <code>'2</code></p>



<a name="271888694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271888694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271888694">(Feb 14 2022 at 21:08)</a>:</h4>
<p>Don't suppose you can put a small example in the playground?</p>



<a name="271889355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271889355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luis Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271889355">(Feb 14 2022 at 21:14)</a>:</h4>
<p><span class="user-mention" data-user-id="116155">@Jake Goulding</span> <br>
<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=c64cff512dc6da885efdb08462f11de3">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=c64cff512dc6da885efdb08462f11de3</a></p>



<a name="271889678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271889678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271889678">(Feb 14 2022 at 21:16)</a>:</h4>
<p>Annoying that a normal generic lifetime allows it to work.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Bar</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">generator</span>: <span class="nc">Pin</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Generator</span><span class="o">&lt;&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">Foo</span><span class="p">,</span><span class="w"> </span><span class="n">Yield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">Return</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="271890634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271890634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luis Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271890634">(Feb 14 2022 at 21:24)</a>:</h4>
<p>This is at least a bad error message if not something worse.</p>



<a name="271890945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271890945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271890945">(Feb 14 2022 at 21:26)</a>:</h4>
<p>Yeah, it's not great, but it's also hard to word it better, IME.</p>



<a name="271891016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271891016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271891016">(Feb 14 2022 at 21:27)</a>:</h4>
<p>I <em>think</em> it's kind of like this has happened:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">generator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">foo</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">Foo</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>



<a name="271891078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271891078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271891078">(Feb 14 2022 at 21:27)</a>:</h4>
<p>And <a href="https://github.com/rust-lang/rfcs/pull/3216">Allow using <code>for&lt;'a&gt;</code> syntax when declaring closures </a> may be relevant</p>



<a name="271892067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271892067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271892067">(Feb 14 2022 at 21:34)</a>:</h4>
<p>It doesn't look like the conforming function trick works here though.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">conform</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">T</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Generator</span><span class="o">&lt;&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">Foo</span><span class="p">,</span><span class="w"> </span><span class="n">Yield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">Return</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">t</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="271893429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271893429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271893429">(Feb 14 2022 at 21:42)</a>:</h4>
<p>It's also possible this is a misfeature of generators, which are only half-baked, as you know.</p>



<a name="271893485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271893485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luis Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271893485">(Feb 14 2022 at 21:42)</a>:</h4>
<p>Interesting. Yes, I see how this RFC is related.</p>
<p>The conforming function trick is genius, but yeah doesn't work unfortunately.</p>



<a name="271893574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271893574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luis Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271893574">(Feb 14 2022 at 21:43)</a>:</h4>
<p>Yeah, could totally be generators.</p>



<a name="271895140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271895140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271895140">(Feb 14 2022 at 21:57)</a>:</h4>
<p>Yep, generator closures don't get to feature a higher-order resume arg yet, and there is no way to nudge it in the right direction, to my knowledge</p>



<a name="271895187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271895187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271895187">(Feb 14 2022 at 21:57)</a>:</h4>
<p>But you can write your own <code>Generators</code> that do, though, fwiw <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="271896015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271896015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luis Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271896015">(Feb 14 2022 at 22:04)</a>:</h4>
<p>Thanks for your help. I'm going to investigate alternatives, like <code>genawaiter</code> and <code>next_gen</code> or maybe I can't use generators at all...</p>



<a name="271896216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271896216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271896216">(Feb 14 2022 at 22:06)</a>:</h4>
<p><code>next-gen</code> doesn't support higher-order resume arg, at least for now.</p>



<a name="271896290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271896290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271896290">(Feb 14 2022 at 22:07)</a>:</h4>
<p>Fully supporting it would have required emulating HKTs, which would have been unwieldy, or using a lot of unsafe type erasure, which would make next-gen potentially UB-prone</p>



<a name="271896412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271896412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luis Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271896412">(Feb 14 2022 at 22:08)</a>:</h4>
<p>That's unfortunate. I just realized now, that you're the author <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="271904663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271904663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271904663">(Feb 14 2022 at 23:29)</a>:</h4>
<p>Yeah, I did think about that API a lot, and decided it wasn't worth the hassle for starters, hence that <code>: 'static</code> on the <code>ResumeArg</code>. That being said, <code>fn</code> pointer types are a nice and convenient way to get HKTs, so the "type erasure way" may not be as tough as it initially looked. I suspect I will need TAITs, though</p>



<a name="271904766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20dyn/near/271904766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20dyn.html#271904766">(Feb 14 2022 at 23:30)</a>:</h4>
<p>(cc hrtb and closure return)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>