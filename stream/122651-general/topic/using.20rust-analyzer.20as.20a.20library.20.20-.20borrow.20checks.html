<html>
<head><meta charset="utf-8"><title>using rust-analyzer as a library  - borrow checks · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks.html">using rust-analyzer as a library  - borrow checks</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259834853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/using%20rust-analyzer%20as%20a%20library%20%20-%20borrow%20checks/near/259834853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiran Gopinathan <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks.html#259834853">(Nov 01 2021 at 07:44)</a>:</h4>
<p>Hi! I've been playing around with using Rust-analyzer as a library and using it to analyze rust code programmatically - in particular, so far I've managed to get up to running <code>HirDatabase::infer</code> on some code and using the resulting typing map that rust-analyzer produces. Next I wanted to use rust-analyzer to find any borrow-checking errors in my code programatically, but I wasn't able to find any endpoints to do that.</p>
<p>Is it possible to get borrow-checking diagnostics back from the rust-analyzer api? If so, could someone point me to which functions would be suitable to do that?</p>



<a name="259835049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/using%20rust-analyzer%20as%20a%20library%20%20-%20borrow%20checks/near/259835049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks.html#259835049">(Nov 01 2021 at 07:48)</a>:</h4>
<p>No, not unless you go through diagnostics (ask it to run <code>cargo check</code> and show those errors).</p>



<a name="259835340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/using%20rust-analyzer%20as%20a%20library%20%20-%20borrow%20checks/near/259835340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiran Gopinathan <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks.html#259835340">(Nov 01 2021 at 07:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="203546">Laurențiu</span> <a href="#narrow/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks/near/259835049">said</a>:<br>
Ah, I see. Does the rust-analyzer-api provide a function to do that? and if it does, are the borrow-checking errors parsed into some kind of data structure by rust-analyzer (I am aware that the rust compiler can output it's diagnostic messages in json format), or will I have to parse/deserialize them myself?</p>



<a name="259844824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/using%20rust-analyzer%20as%20a%20library%20%20-%20borrow%20checks/near/259844824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks.html#259844824">(Nov 01 2021 at 09:58)</a>:</h4>
<p>I think they are, in order to be reported to the LSP client. This happens around the <code>flycheck</code> crate and in <code>rust_analyzer::diagnostics</code>. But they aren't just borrow checking errors, they're everything you get from <code>cargo check</code>.</p>



<a name="259845956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/using%20rust-analyzer%20as%20a%20library%20%20-%20borrow%20checks/near/259845956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks.html#259845956">(Nov 01 2021 at 10:08)</a>:</h4>
<p><span class="user-mention" data-user-id="454423">@Kiran Gopinathan</span> you probably want to build a custom rustc driver which can access the borrow checking results directly</p>



<a name="259846155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/using%20rust-analyzer%20as%20a%20library%20%20-%20borrow%20checks/near/259846155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks.html#259846155">(Nov 01 2021 at 10:10)</a>:</h4>
<p>Yeah, it depends on what you're planning to do with this. If you want perfect precision, going through rustc might be the better way.</p>



<a name="259846683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/using%20rust-analyzer%20as%20a%20library%20%20-%20borrow%20checks/near/259846683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiran Gopinathan <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks.html#259846683">(Nov 01 2021 at 10:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks/near/259845956">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="454423">Kiran Gopinathan</span> you probably want to build a custom rustc driver which can access the borrow checking results directly</p>
</blockquote>
<p>That's what I had begun to fear, so had started looking into the rust_driver api, but it seems like the borrow errors are serialized quite early in the pipeline - for example, the output of rust_borrowck already seems to serialize the borrow errors: <a href="https://github.com/rust-lang/rust/blob/ff0e14829e1806ca0d4226595f7fdf3e8658758f/compiler/rustc_borrowck/src/lib.rs#L331">https://github.com/rust-lang/rust/blob/ff0e14829e1806ca0d4226595f7fdf3e8658758f/compiler/rustc_borrowck/src/lib.rs#L331</a></p>
<p>In that case, the options seem to be between, vendoring a custom version of rust_borrowck, or just retrieving the json output and parsing it in a hacky-way</p>



<a name="259848384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/using%20rust-analyzer%20as%20a%20library%20%20-%20borrow%20checks/near/259848384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks.html#259848384">(Nov 01 2021 at 10:36)</a>:</h4>
<p>You can run the <code>MoveData</code> analysis yourself, which will give you those move errors. However you’re right that in general I don’t think it’s easy to recover borrow checking errors in the api</p>



<a name="259848397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/using%20rust-analyzer%20as%20a%20library%20%20-%20borrow%20checks/near/259848397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks.html#259848397">(Nov 01 2021 at 10:36)</a>:</h4>
<p>It’s one of the weakest spots of the api</p>



<a name="259849179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/using%20rust-analyzer%20as%20a%20library%20%20-%20borrow%20checks/near/259849179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiran Gopinathan <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/using.20rust-analyzer.20as.20a.20library.20.20-.20borrow.20checks.html#259849179">(Nov 01 2021 at 10:46)</a>:</h4>
<p>Ah, I see. Thanks for the advice! Will try my hand at writing a custom driver</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>