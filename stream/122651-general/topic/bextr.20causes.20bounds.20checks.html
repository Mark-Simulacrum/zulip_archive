<html>
<head><meta charset="utf-8"><title>bextr causes bounds checks · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/bextr.20causes.20bounds.20checks.html">bextr causes bounds checks</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252512722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/bextr%20causes%20bounds%20checks/near/252512722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/bextr.20causes.20bounds.20checks.html#252512722">(Sep 08 2021 at 18:49)</a>:</h4>
<p>Found a minor case of bad codegen</p>
<p><a href="https://rust.godbolt.org/z/hWqe7efrz">https://rust.godbolt.org/z/hWqe7efrz</a></p>
<p>Compiler cannot figure bextr returns uintN and inserts a redundant bounds check.</p>



<a name="252609883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/bextr%20causes%20bounds%20checks/near/252609883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/bextr.20causes.20bounds.20checks.html#252609883">(Sep 09 2021 at 11:34)</a>:</h4>
<p>why go through the intrinsic instead of using <code>i = (src &gt;&gt; 60) &amp; 3</code>?</p>



<a name="252611461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/bextr%20causes%20bounds%20checks/near/252611461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/bextr.20causes.20bounds.20checks.html#252611461">(Sep 09 2021 at 11:49)</a>:</h4>
<p>if you <em>need</em> to replace the <code>shr</code> &amp; <code>add</code> instructions by <code>mov</code> &amp; <code>bextr</code> you could use <code>-C target-cpu=skylake -C target-feature=+fast-bextr</code>.<br>
but <code>bextr</code> is not necessarily faster according to <a href="https://reviews.llvm.org/D52570">https://reviews.llvm.org/D52570</a>.</p>



<a name="252635949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/bextr%20causes%20bounds%20checks/near/252635949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/bextr.20causes.20bounds.20checks.html#252635949">(Sep 09 2021 at 14:33)</a>:</h4>
<p>I was Rewriting in Rust. By being explicit, I match the original and get better assembly.</p>



<a name="252636169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/bextr%20causes%20bounds%20checks/near/252636169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/bextr.20causes.20bounds.20checks.html#252636169">(Sep 09 2021 at 14:34)</a>:</h4>
<p>As for perf, I do have a BMI-free variant with shift+and for ancient cpus like znver2 (microcode pext is slooow). On newer µarchs like znver3 it's measurably slower because humans are still smarter than optimizers.</p>



<a name="252640387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/bextr%20causes%20bounds%20checks/near/252640387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/bextr.20causes.20bounds.20checks.html#252640387">(Sep 09 2021 at 14:57)</a>:</h4>
<blockquote>
<p>On newer µarchs like znver3 it's measurably slower because humans are still smarter than optimizers.</p>
</blockquote>
<p>if you set <code>-C target-cpu=znver3</code> it does produce <code>mov</code>+<code>bextr</code> for <code>(src &gt;&gt; 60) &amp; 3</code>.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">DUMMY_LUT</span>: <span class="p">[</span><span class="kt">i32</span><span class="p">;</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">8</span><span class="p">];</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">good_compiler</span><span class="p">(</span><span class="n">src</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">src</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">DUMMY_LUT</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nl">example:</span><span class="err">:</span><span class="nl">good_compiler:</span>
        <span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="mi">572</span>
        <span class="nf">lea</span>     <span class="no">rcx</span><span class="p">,</span> <span class="p">[</span><span class="no">rip</span> <span class="err">+</span> <span class="no">.L__unnamed_1</span><span class="p">]</span>
        <span class="nf">bextr</span>   <span class="no">rax</span><span class="p">,</span> <span class="no">rdi</span><span class="p">,</span> <span class="no">rax</span>
        <span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rcx</span> <span class="err">+</span> <span class="mi">4</span><span class="p">*</span><span class="no">rax</span><span class="p">]</span>
        <span class="nf">ret</span>

<span class="nl">.L__unnamed_1:</span>
        <span class="na">.ascii</span>  <span class="s">"\004\000\000\000\374\377\377\377\b\000\000\000\370\377\377\377"</span>
</code></pre></div>



<a name="252642797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/bextr%20causes%20bounds%20checks/near/252642797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/bextr.20causes.20bounds.20checks.html#252642797">(Sep 09 2021 at 15:11)</a>:</h4>
<p>you can also get the same optimization result on <code>znver3</code> if you replace that intrinsic (which the optimizer likely won't touch) with the manual implementation (which allows const propagation and stuff).</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[inline]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bextr</span><span class="p">(</span><span class="n">src</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">mask</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">src</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">mask</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xff</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">((</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">mask</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><a href="https://rust.godbolt.org/z/91x3bEbGP">https://rust.godbolt.org/z/91x3bEbGP</a></p>



<a name="252644042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/bextr%20causes%20bounds%20checks/near/252644042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/bextr.20causes.20bounds.20checks.html#252644042">(Sep 09 2021 at 15:19)</a>:</h4>
<p>( this won't produce a <code>bextr</code> instruction if the <code>mask</code> happens to be non-constant <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span> )</p>



<a name="252666202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/bextr%20causes%20bounds%20checks/near/252666202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/bextr.20causes.20bounds.20checks.html#252666202">(Sep 09 2021 at 17:46)</a>:</h4>
<p>Yeah, getting compiler to be consistent with detecting bextr seems to be bit of a hit-and-miss.</p>



<a name="252666304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/bextr%20causes%20bounds%20checks/near/252666304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bot+ <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/bextr.20causes.20bounds.20checks.html#252666304">(Sep 09 2021 at 17:47)</a>:</h4>
<p>To use a near-pointless base64 micro-optimization I did a while back as example,</p>
<p><a href="https://rust.godbolt.org/z/ov3aqofnK">https://rust.godbolt.org/z/ov3aqofnK</a></p>
<p>Opportunities for bextr are easy to spot, so the nice safe-ish Rust is almost as good as asm with SWAR.</p>
<p>Try something more complex, and I guess other optimizations will break the pattern.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>