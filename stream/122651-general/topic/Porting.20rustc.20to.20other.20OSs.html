<html>
<head><meta charset="utf-8"><title>Porting rustc to other OSs · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html">Porting rustc to other OSs</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252648197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252648197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lightspot21 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252648197">(Sep 09 2021 at 15:47)</a>:</h4>
<p>Hello,<br>
I would like to try my hand at porting rustc and its stdlib to another OS. As a first step, I want to make a barebones cross-compiling rustc targeting SerenityOS. </p>
<p>From my research till now I have gathered that I need for a "properly-done" target:</p>
<ul>
<li>A target definition json file (I am starting from x86_64-unknown-none-linuxkernel as it seemed to not rely on GNU userspace)</li>
<li>A port of the libc crate (not entirely sure as I found it on this article: <a href="https://iandouglasscott.com/2019/02/18/cross-compiling-rust-code-to-minix">https://iandouglasscott.com/2019/02/18/cross-compiling-rust-code-to-minix</a> and nowhere else, maybe it's out of date)?</li>
</ul>
<p>My questions are:</p>
<ul>
<li>Where can I find documentation on the target definition?</li>
<li>What is the general, least "hacky" flow to create a new target? </li>
<li>How does one port libstd? Do I actually need to port libc?</li>
</ul>
<p>Thank you in advance!</p>
<p>PS: Let me know if this is the wrong stream, I couldn't find one that was specific to ports, so I am asking here.</p>



<a name="252650353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252650353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252650353">(Sep 09 2021 at 15:59)</a>:</h4>
<p>There isn't much documentation for the target definition, the best reference is the comments in the code: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/spec/mod.rs#L978">https://github.com/rust-lang/rust/blob/master/compiler/rustc_target/src/spec/mod.rs#L978</a></p>



<a name="252650523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252650523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252650523">(Sep 09 2021 at 15:59)</a>:</h4>
<p>For a proper port, you wouldn't use a target json and would create a new built-in target. I'd suggest basing it off one of the examples in compiler/rustc_target/src/spec/.</p>



<a name="252650714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252650714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252650714">(Sep 09 2021 at 16:00)</a>:</h4>
<p>A libc port is only needed if your target actually uses it. For example, I don't think our windows target use libc, they use the win32 API directly.</p>



<a name="252652563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252652563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lightspot21 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252652563">(Sep 09 2021 at 16:12)</a>:</h4>
<blockquote>
<p>For example, I don't think our windows target use libc, they use the win32 API directly.</p>
</blockquote>
<p>Huh. Then, how are allocations working? On unix-likes malloc (for example) is defined inside libc, so I guess for the stdlib to work (e.g. Vec) I should also port libc, right?</p>



<a name="252652658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252652658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252652658">(Sep 09 2021 at 16:13)</a>:</h4>
<p>Yes, on unix-likes you need to port libc.</p>



<a name="252652873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252652873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lightspot21 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252652873">(Sep 09 2021 at 16:14)</a>:</h4>
<p>Got it. I'll start with creating a target then. Thanks for the help, both of you!</p>



<a name="252652921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252652921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252652921">(Sep 09 2021 at 16:14)</a>:</h4>
<p>Once you have ported libc, it may be a matter of adding serentity to the list at <a href="https://github.com/rust-lang/rust/blob/497ee321af3b8496eaccd7af7b437f18bab81abf/library/std/build.rs#L29">https://github.com/rust-lang/rust/blob/497ee321af3b8496eaccd7af7b437f18bab81abf/library/std/build.rs#L29</a></p>



<a name="252662561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252662561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252662561">(Sep 09 2021 at 17:20)</a>:</h4>
<p>You might need to add support to cc-rs as well.</p>



<a name="252662848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252662848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lightspot21 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252662848">(Sep 09 2021 at 17:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="143274">Amanieu</span> <a href="#narrow/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs/near/252662561">said</a>:</p>
<blockquote>
<p>You might need to add support to cc-rs as well.</p>
</blockquote>
<p>what's that? I suppose it's for those crates that bind to C source and compile it at the same time?</p>



<a name="252663144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252663144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252663144">(Sep 09 2021 at 17:24)</a>:</h4>
<p>yes, and it hard-codes a lot of target knowledge</p>



<a name="252663173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252663173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252663173">(Sep 09 2021 at 17:24)</a>:</h4>
<p>default flags, cross-compilation toolchain prefixes, etc.</p>



<a name="252688732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Porting%20rustc%20to%20other%20OSs/near/252688732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lightspot21 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Porting.20rustc.20to.20other.20OSs.html#252688732">(Sep 09 2021 at 20:20)</a>:</h4>
<p>Ok, I created the target files, and now I need to teach libc what it needs. My question is, how should I tell the compiler to use my own version and not one from <a href="http://crates.io">crates.io</a>? I saw something about <code>patch</code> in Cargo.toml but then I don't know which version rustc will use when building, so that I patch the correct one. Any ideas?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>