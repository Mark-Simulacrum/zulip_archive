<html>
<head><meta charset="utf-8"><title>#60822 · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html">#60822</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="184101929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184101929" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184101929">(Dec 23 2019 at 12:49)</a>:</h4>
<p><span class="user-mention" data-user-id="132920">@gnzlbg</span> I think a sync chat might be helpful -- I'm trying to understand your viewpoint on what exactly we should document.</p>
<p>You say: "In the context of this discussion, the question that needs to be properly answered somewhere in the reference is: If a call to Drop::drop fails, was the value dropped? If the answer is "no", then calling Drop::drop again isn't a "double-drop" because the value has not been dropped."</p>
<p>To me that's not really something we need to clarify, since <em>any</em> function which takes ownership can only be called once, even if it panics, right?</p>



<a name="184101931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184101931" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184101931">(Dec 23 2019 at 12:49)</a>:</h4>
<p>Like, there's nothing specific to Drop here.</p>



<a name="184101989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184101989" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184101989">(Dec 23 2019 at 12:50)</a>:</h4>
<p>Would you expect us to clarify this for all functions? Essentially we'd be saying "panic does not undo transfers of ownership"</p>



<a name="184101994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184101994" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184101994">(Dec 23 2019 at 12:50)</a>:</h4>
<p>but that seems like an odd statement to make (at least to me) because that seems somewhat... obvious, I guess?</p>



<a name="184102001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102001" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102001">(Dec 23 2019 at 12:51)</a>:</h4>
<p>Notice that <code>drop_in_place</code> drops without taking ownership</p>



<a name="184102002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102002" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102002">(Dec 23 2019 at 12:51)</a>:</h4>
<p>no, that's not true</p>



<a name="184102083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102083" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102083">(Dec 23 2019 at 12:52)</a>:</h4>
<p>drop_in_place explicitly notes: "using the pointed-to value after calling drop_in_place can cause undefined behavior"</p>
<p>any Drop is a transfer of ownership</p>



<a name="184102088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102088" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102088">(Dec 23 2019 at 12:52)</a>:</h4>
<p>"Can"</p>



<a name="184102094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102094" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102094">(Dec 23 2019 at 12:52)</a>:</h4>
<p>any Drop that succeeds, is definetely a transfer of ownership</p>



<a name="184102102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102102" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102102">(Dec 23 2019 at 12:53)</a>:</h4>
<p>but we are talking about, e.g., a call to <code>ptr::drop_in_place</code> that fails</p>



<a name="184102114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102114" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102114">(Dec 23 2019 at 12:53)</a>:</h4>
<p>You would agree that <code>std::mem::drop</code> cannot be called more than once, even if it panics, right?</p>



<a name="184102116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102116" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102116">(Dec 23 2019 at 12:53)</a>:</h4>
<p>(i.e., there's nothing to clarify there)</p>



<a name="184102119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102119" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102119">(Dec 23 2019 at 12:53)</a>:</h4>
<p>I'm not sure how you would be able to do that</p>



<a name="184102120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102120" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102120">(Dec 23 2019 at 12:53)</a>:</h4>
<p>well, I mean, obviously it's possible</p>



<a name="184102121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102121" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102121">(Dec 23 2019 at 12:53)</a>:</h4>
<p>the only way to run into these issues, is using <code>ptr::drop_in_place</code></p>



<a name="184102159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102159" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102159">(Dec 23 2019 at 12:54)</a>:</h4>
<p>the borrow checker doesn't let you call <code>mem::drop</code> twice</p>



<a name="184102171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102171" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102171">(Dec 23 2019 at 12:54)</a>:</h4>
<p>not even in unsafe code</p>



<a name="184102172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102172" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102172">(Dec 23 2019 at 12:54)</a>:</h4>
<p>That's just because it's easier to misuse</p>



<a name="184102175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102175" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102175">(Dec 23 2019 at 12:54)</a>:</h4>
<p>i.e., it only semantically takes ownership</p>



<a name="184102182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102182" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102182">(Dec 23 2019 at 12:54)</a>:</h4>
<p>no, i mean that it is literally impossible to call <code>mem::drop</code> on a value twice in Rust</p>



<a name="184102184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102184" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102184">(Dec 23 2019 at 12:54)</a>:</h4>
<p>Its docs even say "This is semantically equivalent to calling ptr::read and discarding the result"</p>



<a name="184102188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102188" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102188">(Dec 23 2019 at 12:54)</a>:</h4>
<p>okay, sure</p>



<a name="184102196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102196" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102196">(Dec 23 2019 at 12:54)</a>:</h4>
<p>but you can obviously resynthesize the value and re-pass it in if you wanted to</p>



<a name="184102207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102207" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102207">(Dec 23 2019 at 12:55)</a>:</h4>
<p>e.g., by <code>ptr::read</code>ing again</p>



<a name="184102218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102218" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102218">(Dec 23 2019 at 12:55)</a>:</h4>
<p>sure, but a <code>ptr::read</code> + <code>forget</code> doesn't do anything</p>



<a name="184102235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102235" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102235">(Dec 23 2019 at 12:55)</a>:</h4>
<p>as in, if I have some memory on the heap, and I call <code>ptr::read</code> and <code>forget</code> the result, the value on the heap "is still alive"</p>



<a name="184102239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102239" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102239">(Dec 23 2019 at 12:55)</a>:</h4>
<p>Okay, so I see that "discarding" as "std::mem::drop"</p>



<a name="184102243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102243" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102243">(Dec 23 2019 at 12:55)</a>:</h4>
<p>yes</p>



<a name="184102285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102285" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102285">(Dec 23 2019 at 12:56)</a>:</h4>
<p>i.e., drop_in_place is conceptually <code>std::mem::drop(ptr::read(ptr))</code></p>



<a name="184102297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102297" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102297">(Dec 23 2019 at 12:56)</a>:</h4>
<p>for me the clarification that should happen somewhere, is that when you try to drop something, it doesn't matter whether that succeeds or fails, that drops the value</p>



<a name="184102299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102299" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102299">(Dec 23 2019 at 12:56)</a>:</h4>
<p>and with that definition it of course can't be called twice, for the same reason that std::mem::drop can't be</p>



<a name="184102305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102305" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102305">(Dec 23 2019 at 12:56)</a>:</h4>
<p>but how is that different from <code>std::mem::drop(ptr::read(ptr))</code> panicking?</p>



<a name="184102308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102308" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102308">(Dec 23 2019 at 12:56)</a>:</h4>
<p>well, you are assuming that the <code>mem::drop</code> succeeds</p>



<a name="184102318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102318" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102318">(Dec 23 2019 at 12:57)</a>:</h4>
<blockquote>
<p>i.e., drop_in_place is conceptually <code>std::mem::drop(ptr::read(ptr))</code></p>
</blockquote>
<p>Except that <code>drop_in_place</code> doesn't move the value. (Important for pinning)</p>



<a name="184102325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102325" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102325">(Dec 23 2019 at 12:57)</a>:</h4>
<p>we don't say that <code>mem::drop</code> can't be called twice</p>



<a name="184102331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102331" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102331">(Dec 23 2019 at 12:57)</a>:</h4>
<p>we say that a value cannot be dropped twice</p>



<a name="184102337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102337" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102337">(Dec 23 2019 at 12:57)</a>:</h4>
<p>that double-drops are UB</p>



<a name="184102339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102339" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102339">(Dec 23 2019 at 12:57)</a>:</h4>
<p>the question is whether a <code>drop</code> that fails still drops or not</p>



<a name="184102347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102347" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102347">(Dec 23 2019 at 12:57)</a>:</h4>
<p>if a drop that fails does not drop, then <code>mem::drop(ptr::read(ptr)</code> did not drop anything</p>



<a name="184102420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102420" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102420">(Dec 23 2019 at 12:58)</a>:</h4>
<p>okay</p>



<a name="184102432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102432" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102432">(Dec 23 2019 at 12:59)</a>:</h4>
<p>So maybe what we need to clarify is whether "drop" is the act of actually running <code>Drop::drop</code> to "success", or the act of trying to run <code>Drop::drop</code></p>



<a name="184102442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102442" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102442">(Dec 23 2019 at 12:59)</a>:</h4>
<p>Right, to me it's "obviously" the latter</p>



<a name="184102447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102447" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102447">(Dec 23 2019 at 12:59)</a>:</h4>
<p>yeah, i think that's the consensus</p>



<a name="184102450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102450" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102450">(Dec 23 2019 at 12:59)</a>:</h4>
<p>But I guess that's not true for you, so we should document it somewhere</p>



<a name="184102463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102463" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102463">(Dec 23 2019 at 12:59)</a>:</h4>
<p>Since the confusion seems to center around drop_in_place, maybe adding a section there makes sense?</p>



<a name="184102514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102514" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102514">(Dec 23 2019 at 13:00)</a>:</h4>
<p>I was just wondering if we actually had written that somewhere, when I filled that issue, is because I actually wrote code that caught whether dropping a value failed, and if so, tried to re-drop again</p>



<a name="184102531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102531" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102531">(Dec 23 2019 at 13:00)</a>:</h4>
<p>I think it would be better to add this to wherever we define what "drop" is, e.g., maybe to <code>Drop::drop</code></p>



<a name="184102532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102532" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102532">(Dec 23 2019 at 13:00)</a>:</h4>
<p>or the <code>Drop</code> trait docs</p>



<a name="184102539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102539" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102539">(Dec 23 2019 at 13:01)</a>:</h4>
<p>hm, okay, I could see that I guess</p>



<a name="184102566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102566" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102566">(Dec 23 2019 at 13:01)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="nc">VecWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span>: <span class="nc">ManuallyDrop</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">VecWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ManuallyDrop</span>::<span class="n">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>would be unsound if <code>Vec&lt;u8&gt;::drop</code> could panic.</p>



<a name="184102615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102615" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102615">(Dec 23 2019 at 13:02)</a>:</h4>
<p>er, no, that's definitely sound?</p>



<a name="184102621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102621" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102621">(Dec 23 2019 at 13:02)</a>:</h4>
<blockquote>
<p><a href="https://doc.rust-lang.org/std/ops/trait.Drop.html" target="_blank" title="https://doc.rust-lang.org/std/ops/trait.Drop.html">https://doc.rust-lang.org/std/ops/trait.Drop.html</a></p>
</blockquote>



<a name="184102631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102631" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102631">(Dec 23 2019 at 13:02)</a>:</h4>
<p>I'm confused how that's unsound if it can panic</p>



<a name="184102635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102635" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102635">(Dec 23 2019 at 13:02)</a>:</h4>
<p>So there, maybe add a section explaining what happens when <code>Drop::drop</code> panics</p>



<a name="184102644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102644" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102644">(Dec 23 2019 at 13:02)</a>:</h4>
<p>that kind of ties to the issue in the rust-lang/reference about documenting that as well</p>



<a name="184102648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102648" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102648">(Dec 23 2019 at 13:02)</a>:</h4>
<p>It is unsound if dropping after a panic is allowed.</p>



<a name="184102656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102656" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102656">(Dec 23 2019 at 13:03)</a>:</h4>
<p>Should have been more clear</p>



<a name="184102667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102667" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102667">(Dec 23 2019 at 13:03)</a>:</h4>
<p>I don't follow</p>



<a name="184102681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102681" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102681">(Dec 23 2019 at 13:03)</a>:</h4>
<p>I don't follow either</p>



<a name="184102699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102699" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102699">(Dec 23 2019 at 13:03)</a>:</h4>
<p>Dropping <code>T</code> after <code>Drop::drop(&amp;mut T)</code> fails or succeeds is not allowed.</p>



<a name="184102743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102743" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102743">(Dec 23 2019 at 13:04)</a>:</h4>
<p>But that code looks safe in all cases?</p>



<a name="184102747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102747" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102747">(Dec 23 2019 at 13:04)</a>:</h4>
<p>Yes, it looks good to me as well</p>



<a name="184102751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102751" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102751">(Dec 23 2019 at 13:04)</a>:</h4>
<p>If dropping the vector panics, the fields of <code>VecWrapper</code> will still be dropped</p>



<a name="184102752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102752" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102752">(Dec 23 2019 at 13:04)</a>:</h4>
<p>but the <code>ManuallyDrop</code> field doesn't impl Drop</p>



<a name="184102754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102754" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102754">(Dec 23 2019 at 13:04)</a>:</h4>
<p>i.e., is no different than this safe code:</p>
<div class="codehilite"><pre><span></span>struct VecWrapper {
    x: Vec&lt;u8&gt;,
}
</pre></div>



<a name="184102773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102773" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102773">(Dec 23 2019 at 13:05)</a>:</h4>
<p>Better example:</p>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="nc">VecWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span>: <span class="nc">ManuallyDrop</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">VecWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ManuallyDrop</span>::<span class="n">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">rand_bool</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">panic</span><span class="o">!</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>If <code>VecWrapper</code> panics after the drop of <code>Vec&lt;u8&gt;</code>, then allowing redropping it would be unsound, as <code>Vec&lt;u8&gt;</code> would be dropped again.</p>



<a name="184102797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102797" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102797">(Dec 23 2019 at 13:05)</a>:</h4>
<p>Sure, yes, I think that's what we've agreed upon</p>



<a name="184102848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102848" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102848">(Dec 23 2019 at 13:06)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="nc">VecWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">VecWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">ptr</span>::<span class="n">drop_in_place</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="c1">// mem::forget(mem::swap(self.x, Vec::new()));</span>
<span class="w">         </span><span class="n">ptr</span>::<span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>is unsound.</p>



<a name="184102885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102885" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102885">(Dec 23 2019 at 13:06)</a>:</h4>
<p>That tries to drop the <code>Vec&lt;u8&gt;</code>, which can panic, and if it does, then the <code>x</code> field will be dropped again, which is a double drop.</p>



<a name="184102887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102887" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102887">(Dec 23 2019 at 13:06)</a>:</h4>
<p>Most likely yes, though you can do <code>ptr::write(&amp;mut self.x, Vec::new())</code>.</p>



<a name="184102904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102904" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102904">(Dec 23 2019 at 13:07)</a>:</h4>
<p>Ah yes, you can do that as well</p>



<a name="184102918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102918" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102918">(Dec 23 2019 at 13:07)</a>:</h4>
<p>though actually, no, that's still unsound</p>



<a name="184102922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102922" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102922">(Dec 23 2019 at 13:07)</a>:</h4>
<p>you can't ptr::drop_in_place inside a Drop impl ~ever pretty much</p>



<a name="184102926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102926" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102926">(Dec 23 2019 at 13:07)</a>:</h4>
<p>(on a field, at least)</p>



<a name="184102930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102930" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102930">(Dec 23 2019 at 13:07)</a>:</h4>
<p>oh, why not ?</p>



<a name="184102976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102976" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102976">(Dec 23 2019 at 13:08)</a>:</h4>
<p>Since Drop impls can't drop their fields</p>



<a name="184102981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102981" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102981">(Dec 23 2019 at 13:08)</a>:</h4>
<p>since they will be dropped after the drop impl</p>



<a name="184102989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102989" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102989">(Dec 23 2019 at 13:08)</a>:</h4>
<p>i.e., you need to "move out" of the field if you're going to drop it</p>



<a name="184102997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184102997" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184102997">(Dec 23 2019 at 13:08)</a>:</h4>
<p>otherwise every drop impl would need to drop all fields, even if you're e.g. closing a file or something</p>



<a name="184103006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103006" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103006">(Dec 23 2019 at 13:09)</a>:</h4>
<p>i'm not sure I follow, are you saying that this is not possible, because the compiler errors ?</p>



<a name="184103010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103010" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103010">(Dec 23 2019 at 13:09)</a>:</h4>
<p>no, I'm saying that the <code>ptr::drop_in_place</code> as written is not sound</p>



<a name="184103017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103017" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103017">(Dec 23 2019 at 13:09)</a>:</h4>
<p><em>even</em> if it doesn't panic</p>



<a name="184103019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103019" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103019">(Dec 23 2019 at 13:09)</a>:</h4>
<p>or that it is not possible, because it is unsound ? (e.g. because there is a live <code>&amp;mut self</code> reference, which implies there is a live <code>self</code>, and dropping the fields "invalidate" that</p>



<a name="184103022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103022" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103022">(Dec 23 2019 at 13:09)</a>:</h4>
<p>since you have a reference to a dropped value</p>



<a name="184103023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103023" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103023">(Dec 23 2019 at 13:09)</a>:</h4>
<p>not quite</p>



<a name="184103024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103024" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103024">(Dec 23 2019 at 13:09)</a>:</h4>
<p>that too</p>



<a name="184103062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103062" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103062">(Dec 23 2019 at 13:10)</a>:</h4>
<p>that's I guess the reasoning you can use</p>



<a name="184103075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103075" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103075">(Dec 23 2019 at 13:10)</a>:</h4>
<p>but also we'll essentially call drop_in_place again</p>



<a name="184103083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103083" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103083">(Dec 23 2019 at 13:10)</a>:</h4>
<p>i.e., the fields will be dropped after Drop::drop for some struct executes</p>



<a name="184103091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103091" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103091">(Dec 23 2019 at 13:10)</a>:</h4>
<p>sure, but when you do, after the <code>ptr::write</code> there will be a <code>Vec::new()</code> in that place, which can be dropped</p>



<a name="184103093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103093" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103093">(Dec 23 2019 at 13:10)</a>:</h4>
<p>and you cannot stop that</p>



<a name="184103108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103108" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103108">(Dec 23 2019 at 13:10)</a>:</h4>
<p>right, but if ptr::drop_in_place panics then you have a problem because it'll be dropped on the unwind edge I suspect</p>



<a name="184103120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103120" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103120">(Dec 23 2019 at 13:11)</a>:</h4>
<p>yes, that's the point i was trying to illustrate</p>



<a name="184103121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103121" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103121">(Dec 23 2019 at 13:11)</a>:</h4>
<p>(and per earlier, that's UB)</p>



<a name="184103134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103134" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103134">(Dec 23 2019 at 13:11)</a>:</h4>
<p>we do guarantee that the fields are dropped even if something within the <code>Drop::drop</code> panics</p>



<a name="184103137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103137" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103137">(Dec 23 2019 at 13:11)</a>:</h4>
<p>so there's ~no situation in which <code>ptr::drop_in_place(&amp;mut self.foo)</code> is safe in Drop</p>



<a name="184103146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103146" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103146">(Dec 23 2019 at 13:11)</a>:</h4>
<p>since it's guaranteed to be called twice</p>



<a name="184103148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103148" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103148">(Dec 23 2019 at 13:11)</a>:</h4>
<p>well, if you use ManuallyDrop, then you can</p>



<a name="184103161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103161" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103161">(Dec 23 2019 at 13:11)</a>:</h4>
<p>I think we agree and are just talking past each other</p>



<a name="184103166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103166" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103166">(Dec 23 2019 at 13:11)</a>:</h4>
<p>sure, but then it's not self.foo :)</p>



<a name="184103193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103193" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103193">(Dec 23 2019 at 13:12)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> example "works"</p>



<a name="184103227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103227" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103227">(Dec 23 2019 at 13:12)</a>:</h4>
<p>my example is one that would be unsound, precisely because <code>drop_in_place</code> can panic, and that means that some field will be dropped twice</p>



<a name="184103258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103258" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103258">(Dec 23 2019 at 13:13)</a>:</h4>
<p>sure, yes</p>



<a name="184103282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103282" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103282">(Dec 23 2019 at 13:13)</a>:</h4>
<p>it might also be unsound because we might invalidate the <code>&amp;mut self</code> , that's probably worth asking in the UCGs as well</p>



<a name="184103364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103364" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103364">(Dec 23 2019 at 13:14)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/67559" target="_blank" title="https://github.com/rust-lang/rust/pull/67559">https://github.com/rust-lang/rust/pull/67559</a></p>



<a name="184103481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103481" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103481">(Dec 23 2019 at 13:16)</a>:</h4>
<p><a href="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/invalidate.20through.20drop/near/184103427" title="#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/invalidate.20through.20drop/near/184103427">https://rust-lang.zulipchat.com/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/invalidate.20through.20drop/near/184103427</a></p>



<a name="184103619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2360822/near/184103619" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2360822.html#184103619">(Dec 23 2019 at 13:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> that LGTM, let's wait to see what the others say, but this is already how things work, so I'm pretty sure we can't document this in any other way.</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>