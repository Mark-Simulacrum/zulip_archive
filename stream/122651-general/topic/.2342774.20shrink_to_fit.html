<html>
<head><meta charset="utf-8"><title>#42774 shrink_to_fit · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html">#42774 shrink_to_fit</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="146855899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146855899" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146855899">(Nov 06 2018 at 10:04)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> are you online ?</p>



<a name="146856000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146856000" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146856000">(Nov 06 2018 at 10:06)</a>:</h4>
<p>yeah but i'm in a mtg right now; it should be over i think in 60min</p>



<a name="146857044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146857044" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146857044">(Nov 06 2018 at 10:32)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> let me know</p>



<a name="146857787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146857787" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146857787">(Nov 06 2018 at 10:53)</a>:</h4>
<p>okay mtg is over</p>



<a name="146857790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146857790" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146857790">(Nov 06 2018 at 10:53)</a>:</h4>
<p>lets update the topic to point to the issue where we've been talking</p>



<a name="146857822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146857822" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146857822">(Nov 06 2018 at 10:54)</a>:</h4>
<p>(oh, wait, I don't know if such links work for repos outside rust-lang/rust ...)</p>



<a name="146857873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146857873" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146857873">(Nov 06 2018 at 10:55)</a>:</h4>
<p>((they don't))</p>



<a name="146857878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146857878" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146857878">(Nov 06 2018 at 10:55)</a>:</h4>
<p>(((apart from polonius and chalk, according to <span class="user-mention" data-user-id="116107">@davidtwco</span> )))</p>



<a name="146858030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858030" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858030">(Nov 06 2018 at 10:58)</a>:</h4>
<p><span class="user-mention" data-user-id="132920">@gnzlbg</span> ^</p>



<a name="146858066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858066" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858066">(Nov 06 2018 at 10:59)</a>:</h4>
<p>I can at least point us at the Tracking issue for custom allocators; that is better than nothing. (Even though our dialogue thus far has instead been on <a href="https://github.com/alexcrichton/jemallocator/pull/64" target="_blank" title="https://github.com/alexcrichton/jemallocator/pull/64">https://github.com/alexcrichton/jemallocator/pull/64</a></p>



<a name="146858139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858139" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858139">(Nov 06 2018 at 11:00)</a>:</h4>
<p>so I think I see your point, and I am unsure whether you are right for jemalloc or not</p>



<a name="146858176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858176" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858176">(Nov 06 2018 at 11:00)</a>:</h4>
<p>but I see your point in general that a general allocator might want to error from shrink_to_fit, e.g., if it shrinks to a different size-class even if it doesn't move the allocation</p>



<a name="146858186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858186" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858186">(Nov 06 2018 at 11:01)</a>:</h4>
<p>Exactly</p>



<a name="146858192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858192" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858192">(Nov 06 2018 at 11:01)</a>:</h4>
<p>however, <code>xallocx</code> to the best of my knowledge never does that</p>



<a name="146858200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858200" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858200">(Nov 06 2018 at 11:01)</a>:</h4>
<p>(i've asked for clarification in jemalloc's gitter)</p>



<a name="146858206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858206" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858206">(Nov 06 2018 at 11:01)</a>:</h4>
<p>that is, <code>xallocx</code> never moves an allocation to a different size class when shrinking/growing in place</p>



<a name="146858254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858254" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858254">(Nov 06 2018 at 11:02)</a>:</h4>
<p>in particular, when shrinking, the returned size is always &gt;= new_size</p>



<a name="146858257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858257" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858257">(Nov 06 2018 at 11:02)</a>:</h4>
<p>right; it just returs the current size, right?</p>



<a name="146858259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858259" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858259">(Nov 06 2018 at 11:02)</a>:</h4>
<p>which means it never errors (errors are reported by returned a size smaller than the requested one)</p>



<a name="146858260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858260" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858260">(Nov 06 2018 at 11:02)</a>:</h4>
<p>my point is that that will subseuqently casue dealloc to fail</p>



<a name="146858263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858263" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858263">(Nov 06 2018 at 11:02)</a>:</h4>
<p>(where "fail" in this case means "leak")</p>



<a name="146858270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858270" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858270">(Nov 06 2018 at 11:02)</a>:</h4>
<p>no, it returns the usable_size, and that's the thing, dealloc must work for sizes in [requested, usable_size]</p>



<a name="146858271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858271" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858271">(Nov 06 2018 at 11:03)</a>:</h4>
<p>otherwise usable_size would be useless</p>



<a name="146858286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858286" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858286">(Nov 06 2018 at 11:03)</a>:</h4>
<p>that is, xallocx, when shrinking, always returns <code>&gt;= new_size</code>, and the size can be <code>&gt;= old_size</code> too, and all sizes in [new_size, usable_size] can be used with sdallocx</p>



<a name="146858327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858327" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858327">(Nov 06 2018 at 11:04)</a>:</h4>
<p>all sizes in <code>[new_size, usable_size]</code> can be used with sdallocx ?</p>



<a name="146858329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858329" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858329">(Nov 06 2018 at 11:04)</a>:</h4>
<p>this <code>[requested_sz, usable_size]</code> range for <code>Alloc::dealloc</code> is a guarantee of the <code>Alloc</code> trait too</p>



<a name="146858340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858340" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858340">(Nov 06 2018 at 11:04)</a>:</h4>
<p>what if <code>new_size</code> is in a different (smaller) size class?</p>



<a name="146858348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858348" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858348">(Nov 06 2018 at 11:04)</a>:</h4>
<p>that's the scenario that I thought was outlined in <a href="https://github.com/rust-lang/rfcs/pull/1398#issuecomment-164988117" target="_blank" title="https://github.com/rust-lang/rfcs/pull/1398#issuecomment-164988117">https://github.com/rust-lang/rfcs/pull/1398#issuecomment-164988117</a></p>



<a name="146858351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858351" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858351">(Nov 06 2018 at 11:04)</a>:</h4>
<p>that's a good question, it appears to work</p>



<a name="146858361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858361" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858361">(Nov 06 2018 at 11:05)</a>:</h4>
<p>"work" as in "does not assert-fail" ?</p>



<a name="146858364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858364" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858364">(Nov 06 2018 at 11:05)</a>:</h4>
<p>or "work" as in "does not leak memory" ?</p>



<a name="146858373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858373" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858373">(Nov 06 2018 at 11:05)</a>:</h4>
<p>wait, I'll send a PR with a test, so that you can see the code (it doesn't change anything in <code>shrink_to_fit</code>, just adds a test for it</p>



<a name="146858376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858376" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858376">(Nov 06 2018 at 11:05)</a>:</h4>
<p>i.e. the above linked issue comment said that such a scenario would have the deallocation require be silently ignored</p>



<a name="146858418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858418" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858418">(Nov 06 2018 at 11:06)</a>:</h4>
<p>... okay. But I'm not 100% sure we can readily check for memory leak scenarios</p>



<a name="146858424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858424" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858424">(Nov 06 2018 at 11:06)</a>:</h4>
<p>(we used to have valgrind tests that would catch leaks but I don't know if they are part of what bors requires for things to past)</p>



<a name="146858443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858443" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858443">(Nov 06 2018 at 11:07)</a>:</h4>
<p>In any case I definitely think that the documentation for <code>Alloc</code> trait needs some exposition on this detail</p>



<a name="146858584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858584" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858584">(Nov 06 2018 at 11:10)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> i've set valgrind in jemallocators CI, but only for memory errors, no leak detection I think, shouldn't be hard to add</p>



<a name="146858622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858622" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858622">(Nov 06 2018 at 11:11)</a>:</h4>
<p>i've asked in jemalloc upstream precisely for what happens in this case, whether we can dealloc with size <code>1</code> even if <code>xallocx</code> returns the original size</p>



<a name="146858625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146858625" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146858625">(Nov 06 2018 at 11:11)</a>:</h4>
<p><a href="https://github.com/alexcrichton/jemallocator/pull/92" target="_blank" title="https://github.com/alexcrichton/jemallocator/pull/92">https://github.com/alexcrichton/jemallocator/pull/92</a></p>



<a name="146860235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860235" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860235">(Nov 06 2018 at 11:53)</a>:</h4>
<p>maybe mark that PR as WIP for now?</p>



<a name="146860278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860278" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860278">(Nov 06 2018 at 11:54)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> it fails, so indepentendly of what happens upstream, the answer will be that we have to change shrink_in_place implementation</p>



<a name="146860288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860288" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860288">(Nov 06 2018 at 11:54)</a>:</h4>
<p>the correct way to do this is to say that an allocation shrinks only if its usable_size shrinks, and otherwise to error</p>



<a name="146860290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860290" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860290">(Nov 06 2018 at 11:54)</a>:</h4>
<p>okay. So I take that to mean that I was right to start asking questions here. <span class="emoji emoji-263a" title="smile">:smile:</span></p>



<a name="146860309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860309" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860309">(Nov 06 2018 at 11:55)</a>:</h4>
<blockquote>
<p>the correct way to do this is to say that an allocation shrinks only if its usable_size shrinks, and otherwise to error</p>
</blockquote>
<p>are you suggesting that the client should be forced to query <code>usable_size</code> after calling <code>shrink_to_fit</code>??  ... no, you're just saying that's a way to describe the <em>specification</em> of <code>shrink_to_fit</code>, right?</p>



<a name="146860418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860418" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860418">(Nov 06 2018 at 11:58)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> no, I think that we have to do two things:</p>
<ul>
<li>
<p>detect whether <code>new_size == Layout::size()</code> and return <code>Ok(())</code> early,</p>
</li>
<li>
<p>if the usable_size of the new allocation block is not smaller than the old size, return <code>Err</code></p>
</li>
</ul>



<a name="146860432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860432" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860432">(Nov 06 2018 at 11:58)</a>:</h4>
<p>okay. So those are changes to the implementation of the <code>Alloc</code> for jemalloc.</p>



<a name="146860447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860447" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860447">(Nov 06 2018 at 11:59)</a>:</h4>
<p>Do you think that the API for the <code>fn shrink_to_fit</code> in the <code>Alloc</code> trait needs changing, apart from clarifying its documentation?</p>



<a name="146860454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860454" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860454">(Nov 06 2018 at 11:59)</a>:</h4>
<p>yes, the docs of <code>shrink_in_place</code> already say that the <code>new_size</code> can be equal to <code>Layout::size()</code> - in the docs, we have to explain better what <code>CannotReallocInPlace</code> means.</p>



<a name="146860546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860546" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860546">(Nov 06 2018 at 12:00)</a>:</h4>
<p>For example, if you allocate some requested size, you can "grow"/"shrink" it in place as much as you want inside the same bin, at least for jemalloc, and <code>Alloc::usable_size()</code> lets you grow it.</p>



<a name="146860562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860562" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860562">(Nov 06 2018 at 12:01)</a>:</h4>
<p>however, when shrinking, while one could shrink inside the same bin, the allocation itself doesn't change, and we consider it an error</p>



<a name="146860576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860576" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860576">(Nov 06 2018 at 12:01)</a>:</h4>
<p>that is, grow_in_place inside the same bin returns success, but shrink_in_place inside the same bin returns error because the usable_size of the allocation did not change</p>



<a name="146860620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860620" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860620">(Nov 06 2018 at 12:02)</a>:</h4>
<p>And your point is that <code>shrink_in_place</code> inside the same bin should return <code>Ok</code>, right?</p>



<a name="146860626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860626" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860626">(Nov 06 2018 at 12:02)</a>:</h4>
<p>(as in, the subsequent <code>dealloc</code> call will work)</p>



<a name="146860630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860630" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860630">(Nov 06 2018 at 12:02)</a>:</h4>
<p>i don't know, we can't implement this efficiently with jemalloc, and <code>Alloc::</code> does not have a method to query the "minimum size of allocations inside this bin"</p>



<a name="146860644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860644" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860644">(Nov 06 2018 at 12:03)</a>:</h4>
<p>usable_size returns a lower bound doesn't it? That's meant to represent that minimum size of such allocations; that's why we added that lower bound.</p>



<a name="146860651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860651" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860651">(Nov 06 2018 at 12:03)</a>:</h4>
<p>(that is, <code>usable_size</code> returns <code>(l, h)</code>)</p>



<a name="146860662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860662" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860662">(Nov 06 2018 at 12:03)</a>:</h4>
<p>yeah, but it does not have to be accurate</p>



<a name="146860700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860700" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860700">(Nov 06 2018 at 12:04)</a>:</h4>
<p>...</p>



<a name="146860706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860706" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860706">(Nov 06 2018 at 12:04)</a>:</h4>
<p>as in, it is typically the requested size, and the largest size is computed e.g. via <code>nallocx</code></p>



<a name="146860710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860710" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860710">(Nov 06 2018 at 12:04)</a>:</h4>
<p>oh okay</p>



<a name="146860714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860714" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860714">(Nov 06 2018 at 12:04)</a>:</h4>
<p>sure, if the underlying allocator doesn't give a way to observe the lower bound, then you can't do anything about it. okay.</p>



<a name="146860781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860781" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860781">(Nov 06 2018 at 12:06)</a>:</h4>
<p>yeah, there is another fundamental problem with <code>shrink_in_place</code> that <code>grow_in_place</code> does not have</p>



<a name="146860803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860803" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860803">(Nov 06 2018 at 12:07)</a>:</h4>
<p><code>grow_in_place</code> lets you specify a size, and you get an allocation &gt;= than new_size, but with <code>shrink_in_place</code> you also get an allocation &gt;= new_size, but it can be much larger to the point of this not being useful</p>



<a name="146860861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860861" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860861">(Nov 06 2018 at 12:08)</a>:</h4>
<p>So the two ways I could imagine to address that are:</p>



<a name="146860871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860871" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860871">(Nov 06 2018 at 12:08)</a>:</h4>
<p>1. Change the API of <code>shrink_in_place</code> to include such info about the resulting size category for the "new" state  of the given block</p>



<a name="146860873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860873" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860873">(Nov 06 2018 at 12:08)</a>:</h4>
<p>or</p>



<a name="146860885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860885" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860885">(Nov 06 2018 at 12:09)</a>:</h4>
<p>2. Tell clients that they may want to query <code>usable_size</code> after calling <code>shrink_in_place</code> ...</p>



<a name="146860896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860896" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860896">(Nov 06 2018 at 12:09)</a>:</h4>
<p>(and accept that <code>usable_size</code> doesn't always provide the most precise answers)</p>



<a name="146860913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860913" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860913">(Nov 06 2018 at 12:09)</a>:</h4>
<p>((but it should <em>always</em> provide conservatively <em>correct</em> answers...))</p>



<a name="146860976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146860976" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146860976">(Nov 06 2018 at 12:10)</a>:</h4>
<p>in some sense, it is implied that if you can dealloc the new smaller allocation resulting from <code>shrink_in_place</code>, it will be in the same size class at leat - so this might not be as bad as I put it. </p>
<p>Note also that <code>xallocx</code> returns the <code>usable_size</code>, and that we could use this information in <code>RawVec</code> for example, so that we would have to add <code>shrink/grow_in_place_excess</code> methods as well. It might be worth it to just change the signatures of these to always return the <code>Excess</code>.</p>



<a name="146861080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861080" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861080">(Nov 06 2018 at 12:12)</a>:</h4>
<p>I implemented a new <code>mallocx</code>-like API in jemalloc that always returns Excess for a C++ paper that proposes sized allocation, and this has been merged in jemalloc upstream already - so the whole "should we have _excess variants of all methods" discussion might be worth revisiting once <code>jemallcator</code> supports this API (there is an open PR about bumping the jemalloc version to the dev branch again)</p>



<a name="146861154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861154" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861154">(Nov 06 2018 at 12:14)</a>:</h4>
<p>Cool! Can you provide a pointer to the jemalloc PR? just curious.</p>



<a name="146861325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861325" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861325">(Nov 06 2018 at 12:19)</a>:</h4>
<p><a href="https://github.com/jemalloc/jemalloc/pull/1270" target="_blank" title="https://github.com/jemalloc/jemalloc/pull/1270">https://github.com/jemalloc/jemalloc/pull/1270</a></p>



<a name="146861382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861382" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861382">(Nov 06 2018 at 12:20)</a>:</h4>
<p>i've pushed a commit to fix <code>shrink_in_place</code> to <a href="https://github.com/alexcrichton/jemallocator/pull/92" target="_blank" title="https://github.com/alexcrichton/jemallocator/pull/92">https://github.com/alexcrichton/jemallocator/pull/92</a></p>



<a name="146861384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861384" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861384">(Nov 06 2018 at 12:20)</a>:</h4>
<p>we'll see if tests pass everywhere now or not</p>



<a name="146861413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861413" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861413">(Nov 06 2018 at 12:21)</a>:</h4>
<p>FWIW, the general recommendation is that <code>Alloc::usable_size</code> is a bad idea and I think we should remove it.</p>



<a name="146861492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861492" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861492">(Nov 06 2018 at 12:23)</a>:</h4>
<p>It basically makes it impossible to gather statistics about memory requests. If someone wants to introspect this, <code>jemallocator::ffi::nallocx</code> and friends can be used, but it shouldn't be a "general purpose tool", and it should not be widely used</p>



<a name="146861560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861560" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861560">(Nov 06 2018 at 12:25)</a>:</h4>
<p>okay, reading over the comment you added to <a href="https://github.com/alexcrichton/jemallocator/pull/92" target="_blank" title="https://github.com/alexcrichton/jemallocator/pull/92">https://github.com/alexcrichton/jemallocator/pull/92</a>, I think I <em>finally</em> understand the scenario you are describing</p>



<a name="146861651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861651" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861651">(Nov 06 2018 at 12:27)</a>:</h4>
<p>I understand the drawback you describe, in terms of not being able to observe memory requests. My memory of the original motivation (for <code>Alloc::usable_size</code>) is that some people were concerned about being forced to round-trip requests through the allocator. Fundamentally I think that concern is inherently at odds with a desire to observe memory requests.</p>



<a name="146861663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861663" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861663">(Nov 06 2018 at 12:27)</a>:</h4>
<p>i've shared that with the jemalloc devs, maybe they have a better recommendation, but the underlying problem here is that <code>xallocx</code> is basically <code>realloc_in_place</code>, which is what we used to have and worked "as expected" for that API, however, when that got adapted to <code>grow</code>/<code>shrink_in_place</code>, things got messy</p>



<a name="146861743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861743" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861743">(Nov 06 2018 at 12:29)</a>:</h4>
<p>To be honest (and this may be obvious to you), I have not been driving the <code>trait Alloc</code> design for quite some time now; I'm not a stakeholder in whether it has <code>realloc_in_place</code> vs <code>grow/shrink_in_place</code>. I assume you've already read the comment threads discussing that split.</p>



<a name="146861758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861758" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861758">(Nov 06 2018 at 12:29)</a>:</h4>
<p>yes, the split was motivation is good: its possible to provide different paths for both, and <code>realloc_in_place</code> mixes them inside one function</p>



<a name="146861818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861818" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861818">(Nov 06 2018 at 12:30)</a>:</h4>
<p>now that we have some experience with <code>grow_in_place</code>/<code>shrink_in_place</code>, we have learned new things, and just because they don't work "perfectly" with <code>jemalloc</code> does not mean that's the fault of these APIs</p>



<a name="146861837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861837" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861837">(Nov 06 2018 at 12:31)</a>:</h4>
<p>Your mentioning of <code>_excess</code> methods above does lead me to wonder whether indeed adding the info about <code>Excess</code> to the <code>Result::Ok</code> of <code>shrink_in_place</code> could be a way to kill two birds with one stone here</p>



<a name="146861845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861845" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861845">(Nov 06 2018 at 12:31)</a>:</h4>
<p>if anything, the problem here is that <code>xallocx</code> returns <code>usable_size &lt; new_size</code> as error while growing, but <code>usable_size = original_size</code> as error while shrinking</p>



<a name="146861853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861853" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861853">(Nov 06 2018 at 12:32)</a>:</h4>
<p>and the error while shrinking is sometimes "success"</p>



<a name="146861916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861916" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861916">(Nov 06 2018 at 12:33)</a>:</h4>
<p>so just so I have this right: if I request a <code>new_size</code> where <code>new_size &lt; original_size</code>and it happens to be in the same size bin in as <code>original_size</code>, jemalloc is allowed to return <code>original_size</code> from <code>xallocx</code> ?</p>



<a name="146861924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861924" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861924">(Nov 06 2018 at 12:33)</a>:</h4>
<p>if original_size is the usable_size of the bin, then yes</p>



<a name="146861978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146861978" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146861978">(Nov 06 2018 at 12:34)</a>:</h4>
<p>I guess we could check that with  <code>original_bin_usable_size = nallocx(original_size)</code></p>



<a name="146862006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862006" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862006">(Nov 06 2018 at 12:35)</a>:</h4>
<p>but if we don't inline jemalloc into Rust, that could make things slightly more expensive (and in rare pathological cases way more expensive) for little win</p>



<a name="146862030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862030" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862030">(Nov 06 2018 at 12:35)</a>:</h4>
<p><code>nallocx</code> is computed at the beginning of <code>xallocx</code> to find the size class of the original allocation, so if we inline jemalloc into Rust, doing that becomes free</p>



<a name="146862093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862093" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862093">(Nov 06 2018 at 12:36)</a>:</h4>
<p>sorry to be pedantic here, but I just want to really make sure I understand</p>



<a name="146862098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862098" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862098">(Nov 06 2018 at 12:36)</a>:</h4>
<p>don't worry, what i mentioned might be slightly incorrect</p>



<a name="146862112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862112" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862112">(Nov 06 2018 at 12:37)</a>:</h4>
<p>if the original_size is the usable size of the bin, then this is always the case</p>



<a name="146862116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862116" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862116">(Nov 06 2018 at 12:37)</a>:</h4>
<p>if the original_size is not the usable_size of the bin, then I don't know what happens</p>



<a name="146862123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862123" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862123">(Nov 06 2018 at 12:37)</a>:</h4>
<p>if i request a <code>new_size</code> where <code>new_size &lt; original_size</code> and the resize attempt <em>fails</em>, it will <em>again</em> return <code>original_size</code>, right?</p>



<a name="146862128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862128" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862128">(Nov 06 2018 at 12:37)</a>:</h4>
<p>jemalloc's docs don't mention it, and I don't think all code paths do the same thing here</p>



<a name="146862133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862133" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862133">(Nov 06 2018 at 12:37)</a>:</h4>
<p>I suppose this is exactly what you said above</p>



<a name="146862188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862188" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862188">(Nov 06 2018 at 12:39)</a>:</h4>
<p>So what I take from this is that what <em>jemalloc</em> expects/wants us to do is to not expect to be able to request a size <code>S</code> and, on success, subsequently always be able to use <code>S</code> as the size in a subsequent <code>dealloc</code></p>



<a name="146862207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862207" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862207">(Nov 06 2018 at 12:39)</a>:</h4>
<p>let's put it 100% clear - if <code>new_size &lt; original_size</code> is requested and shrinking fails then what <code>xallocx</code> returns is not documented anywhere.  <code>xallocx</code> always returns an <code>usable_size</code> as far as I can tell from reading the code and the docs, but it might return the original_size here sometimes as well - obviously, if the original size is the usable size of the bin, then both match, but I don't know if both have to match</p>



<a name="146862213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862213" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862213">(Nov 06 2018 at 12:39)</a>:</h4>
<p>but instead, you can request a size <code>S1</code>, and <code>xmallocx</code> will return some size <code>S2</code> (where <code>S1 &lt;= S2 &lt;= original_size</code>), and you are expected to subsequently use <code>S2</code> for the dealloc</p>



<a name="146862258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862258" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862258">(Nov 06 2018 at 12:40)</a>:</h4>
<p>yes, that's correct</p>



<a name="146862261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862261" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862261">(Nov 06 2018 at 12:40)</a>:</h4>
<p>okay</p>



<a name="146862266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862266" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862266">(Nov 06 2018 at 12:40)</a>:</h4>
<p>but I don't know if this is intended, because this is the only api where it happens, and only when shrinking</p>



<a name="146862277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862277" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862277">(Nov 06 2018 at 12:40)</a>:</h4>
<p>Should we then consider changing the API of <code>shrink_in_place</code> to return that <code>S2</code> ?</p>



<a name="146862278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862278" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862278">(Nov 06 2018 at 12:40)</a>:</h4>
<p>in all other APIs, you can use the [requested, usable] range of sizes to deallocate</p>



<a name="146862306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862306" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862306">(Nov 06 2018 at 12:41)</a>:</h4>
<p>the problem is when shall we error</p>



<a name="146862354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862354" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862354">(Nov 06 2018 at 12:42)</a>:</h4>
<p>well other Allocators would then have the option of erroring</p>



<a name="146862359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862359" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862359">(Nov 06 2018 at 12:42)</a>:</h4>
<p>while jemaloc would now always succeed, as you originally suggested</p>



<a name="146862362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862362" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862362">(Nov 06 2018 at 12:42)</a>:</h4>
<p>that is, if we return the size that <code>xallocx</code> returns, when is that value "success" and when is it "error" ? we would just be pushing that to <code>Alloc</code> users</p>



<a name="146862365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862365" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862365">(Nov 06 2018 at 12:42)</a>:</h4>
<p>the crucial detail is the idea of returning the "new" size class to be used</p>



<a name="146862388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862388" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862388">(Nov 06 2018 at 12:43)</a>:</h4>
<p>yes, the error condition might not be important here</p>



<a name="146862394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862394" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862394">(Nov 06 2018 at 12:43)</a>:</h4>
<p>Indeed, it is pushing the obligation to call dealloc with the correct value (S2) onto the client, rather than letting them assume that S1 will always work</p>



<a name="146862395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862395" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862395">(Nov 06 2018 at 12:43)</a>:</h4>
<p>I mean, what can one do with the error of <code>grow</code>/<code>shrink</code> in place ?</p>



<a name="146862399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862399" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862399">(Nov 06 2018 at 12:43)</a>:</h4>
<p>give up and try a different value</p>



<a name="146862402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862402" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862402">(Nov 06 2018 at 12:44)</a>:</h4>
<p>or bubble the failure out</p>



<a name="146862448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862448" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862448">(Nov 06 2018 at 12:44)</a>:</h4>
<p>try a different value "in place" ?</p>



<a name="146862453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862453" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862453">(Nov 06 2018 at 12:44)</a>:</h4>
<p>sure</p>



<a name="146862460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862460" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862460">(Nov 06 2018 at 12:44)</a>:</h4>
<p>I'm just spit-balling here</p>



<a name="146862470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862470" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862470">(Nov 06 2018 at 12:44)</a>:</h4>
<p>I don't know what best practices would be</p>



<a name="146862472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862472" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862472">(Nov 06 2018 at 12:44)</a>:</h4>
<p>yeah, so I could imagine that if these fail, one moves to doing this out-of-place, but realloc works in place if it can</p>



<a name="146862482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862482" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862482">(Nov 06 2018 at 12:45)</a>:</h4>
<p>so that use case makes no sense</p>



<a name="146862559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862559" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862559">(Nov 06 2018 at 12:46)</a>:</h4>
<p>in the sense that if <code>shrink_in_place</code> always succeeds (for <em>jemalloc</em>) then realloc will behave in unexpected ways?</p>



<a name="146862572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862572" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862572">(Nov 06 2018 at 12:46)</a>:</h4>
<p>Its not like jemalloc couldn't override the implementation of <code>realloc</code> if that makes sense for jemalloc's impl of <code>Alloc</code> ...</p>



<a name="146862575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862575" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862575">(Nov 06 2018 at 12:46)</a>:</h4>
<p>nono, in the sense that if you want to shrink in place, but are ok with shrinking "out of place" if that fails, you can just use <code>realloc</code> directly instead since it will do exactly that</p>



<a name="146862587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862587" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862587">(Nov 06 2018 at 12:47)</a>:</h4>
<p>oh oh oh</p>



<a name="146862590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862590" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862590">(Nov 06 2018 at 12:47)</a>:</h4>
<p>no need to first call shrink_in_place, then realloc</p>



<a name="146862591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862591" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862591">(Nov 06 2018 at 12:47)</a>:</h4>
<p>yes you are right</p>



<a name="146862643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862643" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862643">(Nov 06 2018 at 12:48)</a>:</h4>
<p>but I'm not a good resource to ask about the use cases for this method</p>



<a name="146862649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862649" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862649">(Nov 06 2018 at 12:48)</a>:</h4>
<p>so i am going to wait till we clarify with upstream whether <code>xallocx</code> always returns the usable size of the original bin on failure - if that's the case, we can use <code>nallocx</code> to be "perfectly" accurate</p>



<a name="146862665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862665" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862665">(Nov 06 2018 at 12:48)</a>:</h4>
<p>and then we can fix things, and maybe jemalloc's dev suggest adding apis for these use cases or not, or maybe there is a better way to do all of this</p>



<a name="146862783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862783" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862783">(Nov 06 2018 at 12:50)</a>:</h4>
<p>in the sense that you would make <code>shrink_in_place</code> react to the return value of <code>original_size</code> by then checking if the requested size falls into the current size class (via <code>nallocx</code>), and if so, still return <code>Ok(())</code> (and if it doesn't fall into the current size class, <em>then</em> return <code>Err(_)</code> ?)</p>



<a name="146862854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862854" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862854">(Nov 06 2018 at 12:52)</a>:</h4>
<p>kind of, I'll update the PR right now under that assumption, because I am pretty confident that if <code>xallocx</code> does not always return the <code>usable_size</code> then that's a bug in jemalloc.</p>



<a name="146862855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862855" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862855">(Nov 06 2018 at 12:52)</a>:</h4>
<p>I ask because I originally thought you were suggesting that we call <code>nallocx</code> <em>first</em>, before <code>xallocx</code>, which would then mean you could always just treat a return value of the <code>orignal_size</code> as an error, and you wouldn't have to make any queries upstream.</p>



<a name="146862860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862860" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862860">(Nov 06 2018 at 12:52)</a>:</h4>
<p>but I'm guessing you don't want to add that overhead to the hot path?</p>



<a name="146862871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862871" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862871">(Nov 06 2018 at 12:53)</a>:</h4>
<p>(where its "only" overhead if the code to call <code>xallocx</code> isn't not inlined and then the two inlined calls to <code>nallocx</code> are CSE optimized into a single expression...)</p>



<a name="146862945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862945" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862945">(Nov 06 2018 at 12:54)</a>:</h4>
<p>Sorry; I really feel like I'm belaboring the same points you already laid out, but I just want to make sure I understand the plan</p>



<a name="146862959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146862959" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146862959">(Nov 06 2018 at 12:54)</a>:</h4>
<p>((which is strange because, as I said above, I'm really not one of the stakeholders here anymore))</p>



<a name="146863530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146863530" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146863530">(Nov 06 2018 at 13:06)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> i've pushed a commit that should make it accurate at the cost of an extra <code>nallocx</code> call in the case in which the allocation is not shrunk</p>



<a name="146863539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146863539" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146863539">(Nov 06 2018 at 13:06)</a>:</h4>
<p>cool thanks</p>



<a name="146863580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146863580" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146863580">(Nov 06 2018 at 13:08)</a>:</h4>
<p>It sounds to me like that should be both safe (in terms of ensuring the subsequent calls to dealloc will be correct) and nearly as fast as what we had before ... we'll just be paying, at most, in code size if the code is insufficiently inlined. Right?</p>



<a name="146863619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146863619" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146863619">(Nov 06 2018 at 13:08)</a>:</h4>
<p>(i mean, the internal cost of the extra <code>nallocx</code> call sounds negligible compared to the external cost of returning <code>Err</code> when <code>Ok</code> would have worked!)</p>



<a name="146863728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146863728" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146863728">(Nov 06 2018 at 13:10)</a>:</h4>
<p>probably, i'd rather just get this correct first, I think its not the first time these have been amended, but I also think that we regressed previous bug fixes here when the <code>GlobalAlloc</code> refactors were merged (things were fixed in jemallocator but not in rust-lang/rust and then rust-lang/rust code was copy-pasted back)</p>



<a name="146863755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146863755" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146863755">(Nov 06 2018 at 13:11)</a>:</h4>
<p>I agree, get it right first is the way to go</p>



<a name="146865138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146865138" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146865138">(Nov 06 2018 at 13:38)</a>:</h4>
<p>Wow I hadn't noticed that the original code used <code>size &gt;= new_layout.size() </code> instead of <code>size &gt; new_layout.size() </code>. That's pretty egregious.</p>



<a name="146872444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2342774%20shrink_to_fit/near/146872444" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gnzlbg <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.2342774.20shrink_to_fit.html#146872444">(Nov 06 2018 at 15:40)</a>:</h4>
<blockquote>
<p>Wow I hadn't noticed that the original code used size &gt;= new_layout.size()  instead of size &gt; new_layout.size() . That's pretty egregious.</p>
</blockquote>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> I think that the code using <code>realloc_in_place</code> back then might have been correct, but since the split was made both grow/shrink in place have always been at least partially broken. I've just merged a PR to fix <code>grow_in_place</code>. The <code>jemalloc</code> devs still have not commented about <code>shrink_in_place</code>.</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>