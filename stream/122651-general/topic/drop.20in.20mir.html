<html>
<head><meta charset="utf-8"><title>drop in mir · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/drop.20in.20mir.html">drop in mir</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263752095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/drop%20in%20mir/near/263752095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lengyijun <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/drop.20in.20mir.html#263752095">(Dec 05 2021 at 06:06)</a>:</h4>
<p>Based on <a href="https://rust-lang.github.io/rfcs/0320-nonzeroing-dynamic-drop.html">nonzeroing</a> and some experimental  code, I've such questions:</p>
<ol>
<li>Why a moved variable is dropped again in mir?</li>
<li>I didn't find stack-local drop flags in mir, what happens?</li>
</ol>



<a name="263753006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/drop%20in%20mir/near/263753006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/drop.20in.20mir.html#263753006">(Dec 05 2021 at 06:34)</a>:</h4>
<p>There's a MIR pass called <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_dataflow/src/elaborate_drops.rs">drop elaboration</a> that is responsible for adding drop flags to the MIR. There's some more <a href="https://rustc-dev-guide.rust-lang.org/mir/drop-elaboration.html">information here</a>, although it's incomplete.</p>
<p>Prior to drop elaboration, there won't be any drop flags and <code>Drop</code> terminators will exist whose targets are uninitialized. After drop elaboration the MIR should have drop flags (unless we can prove that a variable is always initialized or never initialized when it is dropped).</p>



<a name="263753100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/drop%20in%20mir/near/263753100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/drop.20in.20mir.html#263753100">(Dec 05 2021 at 06:37)</a>:</h4>
<p>Inferring from you questions, perhaps you are looking at the MIR prior to drop elaboration? That's a bit surprising, since <code>--emit=mir</code> should emit MIR that has gone through all the passes. You can run with <code>-Zdump-mir=MY_FUNCTION -Zdump-mir-graphviz</code> to dump CFGs for each phase in the MIR pipeline. That's how I usually debug MIR issues.</p>



<a name="263753552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/drop%20in%20mir/near/263753552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lengyijun <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/drop.20in.20mir.html#263753552">(Dec 05 2021 at 06:50)</a>:</h4>
<p>Thanks. I find it in <a href="http://main.elaborate-drops.after.dot">main.elaborate-drops.after.dot</a> <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
<p>By the way, where can I find the order of mir?<br>
For example, which is earlier: nll.0.mir or elaborate-drops.earlier.mir?</p>



<a name="263753751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/drop%20in%20mir/near/263753751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/drop.20in.20mir.html#263753751">(Dec 05 2021 at 06:57)</a>:</h4>
<p>There should numbers like 002-006 in the filename for each MIR dump. The passes run in increasing order.</p>



<a name="263753828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/drop%20in%20mir/near/263753828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/drop.20in.20mir.html#263753828">(Dec 05 2021 at 07:00)</a>:</h4>
<p>There are also some files with -------- instead of the six numbers. Those don't represent a transformation on the CFG. Usually they just gave some extra information</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>