<html>
<head><meta charset="utf-8"><title>Idiomatic: slices vs Iterators · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html">Idiomatic: slices vs Iterators</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264010348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264010348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264010348">(Dec 07 2021 at 14:41)</a>:</h4>
<p>I'm trying to figure out when should I use slices and when should I use Iterators,</p>
<p>Iterator pros:</p>
<ul>
<li>you can wrap and unwrap types without reallocating (using maps)</li>
<li>you can use non contiguous memory sources.</li>
</ul>
<p>Iterator cons:</p>
<ul>
<li>no random access.</li>
</ul>
<p>Slices pros:</p>
<ul>
<li>random access.</li>
<li>obvious memcpys (the compiler will probably do that with iterators too: <a href="https://godbolt.org/z/v8Kx3os8W">https://godbolt.org/z/v8Kx3os8W</a>)</li>
</ul>
<p>Slices cons:</p>
<ul>
<li>You have to reallocate if you want to wrap/unwrap types in safe rust.</li>
</ul>
<p>From this list it seems like as long as you don't need random access memory then you should use Iterators, that way you can convert a <code>impl Iterator&lt;Item=u8&gt;</code> to <code>impl Iterator&lt;Item=NonZeroU8&gt;</code> in safe rust without re-allocating.</p>
<p>But then I look at the standard library, and the <code>Write</code> trait is <code>fn write(&amp;mut self, buf: &amp;[u8]) -&gt; Result&lt;usize&gt;;</code> and not <code>fn write(&amp;mut self, buf: impl Iterator&lt;Item=u8&gt;) -&gt; Result&lt;usize&gt;;</code></p>
<p>What is the reason for that? And why are slices used all over the ecosystem and equivalent iterator APIs aren't so prevalent?</p>



<a name="264014368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264014368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264014368">(Dec 07 2021 at 15:12)</a>:</h4>
<p>Are you asking about slices/iterators of <code>u8</code> specifically or for any T?</p>



<a name="264014662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264014662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264014662">(Dec 07 2021 at 15:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators/near/264014368">said</a>:</p>
<blockquote>
<p>Are you asking for slices/iterators of <code>u8</code> specifically or for any T?</p>
</blockquote>
<p>Is there a meaningful difference here? I used <code>u8</code> here just because of the <code>Write</code> trait</p>



<a name="264014707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264014707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264014707">(Dec 07 2021 at 15:14)</a>:</h4>
<p>Yes, there's a meaningful difference.</p>



<a name="264019992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264019992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264019992">(Dec 07 2021 at 15:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators/near/264014707">said</a>:</p>
<blockquote>
<p>Yes, there's a meaningful difference.</p>
</blockquote>
<p>Would love to hear :) when should I use slices vs iterators in each of them?</p>



<a name="264026270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264026270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264026270">(Dec 07 2021 at 16:28)</a>:</h4>
<p>I'd say that slices are a better starting point, but iterators are a better working point. By that I mean that if someone is going to offer to let me look at a slice or an iterator, I'd rather the slice, because I can make an iterator from that if what I needed was an iterator, but I can't do the reverse. And that said, 95% of the time what I want is the iterator form, so I will end up doing that. However, sometimes I want to cast the slice's element type or split a chunk off the front or something that you can't do with the iterator.</p>



<a name="264032578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264032578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264032578">(Dec 07 2021 at 17:02)</a>:</h4>
<p><code>[u8]</code> are used for several reasons:</p>
<ul>
<li>OS APIs want a pointer and length, they don't understand language-specific iterator protocols</li>
<li>can be reused, avoiding allocations</li>
<li>you can do some zero-copy type punning, e.g. to <code>&amp;str</code> </li>
<li>also casting to SIMD types!</li>
<li>optimizing iterators over tiny types (<code>Iterator&lt;Item = u8&gt;</code> -&gt;  you only get 1 byte per step) is expensive. std goes to great lengths to make llvm understand those loops and optimize them, but you still pay for it in compile times and they don't always optimize perfectly</li>
<li>you're more likely to keep them in contiguous data structures anyway. it's not like you have a <code>HashMapM&lt;_, u8&gt;</code> and need an iterator over its values to build a byte stream from that, simply because it would be inefficient. At a minimum you would be dealing with an iterator of slices, maybe from some kind of rope data structure</li>
<li>shared views into raw data</li>
<li>sources that only generate one byte at a time aren't all that common</li>
</ul>
<p>And as <span class="user-mention" data-user-id="224471">@Lokathor</span>  says you can always make an iterator from a slice.</p>
<p>And for streaming large amounts of bytes there are the <code>Read</code> and <code>Write</code> traits that are often used to abstract over compressors, encryption and other byte-stream things.</p>
<p>For larger structs most of those things don't apply or do so less frequently. E.g. they may contain slice references, so they already function as a large batch of data for example.</p>



<a name="264032798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264032798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264032798">(Dec 07 2021 at 17:03)</a>:</h4>
<p>The biggest reason to use byte iterator is when the dagfrekkin spec demands that you iterate a byte at a time (sometimes less than that at a time)</p>



<a name="264045926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264045926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264045926">(Dec 07 2021 at 18:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="249222">Elichai Turkel</span> <a href="#narrow/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators/near/264014662">said</a>:</p>
<blockquote>
<p>I used <code>u8</code> here just because of the <code>Write</code> trait</p>
</blockquote>
<p>The big difference to me is that <code>u8</code> is extremely often not used as something that's individually-useful.  And if you need to read <em>multiple</em> at once, then slices (or <code>Read</code> or ...) tends to be better.</p>
<p>For comparison on the other end, I find it somewhat rare to strictly <em>need</em> a slice of <code>String</code>.  For them, handling them one at a time is often reasonable, and thus consuming them via iterators is more reasonable.</p>



<a name="264048391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264048391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264048391">(Dec 07 2021 at 18:25)</a>:</h4>
<p>Yeah that's a general theme. You don't <code>flatten</code> or <code>partition</code> individual bytes for example. Operations on raw bytes often look different compared to what you do to a collection of structs.<br>
E.g. when you're working on pixels then you reinterpret a bytes as rows and columns and apply kernels across multiple rows which wouldn't be possible with a dumb iterator examining a byte at a time.</p>



<a name="264056633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264056633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264056633">(Dec 07 2021 at 19:15)</a>:</h4>
<p>Part of me wishes that <code>byte</code> existed as a type distinct from <code>u8</code> or <code>i8</code> (albeit layout-equivalent).  Because what I do with bytes is generally so different from what I do with <em>numbers</em>.</p>



<a name="264067236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264067236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264067236">(Dec 07 2021 at 20:31)</a>:</h4>
<p>type alias? sure.<br>
distinct type where rustc tells me i'm wrong if i mix them up? no thanks.</p>
<p>but you can always newtype u8 as "byte" if you want in your own code ;3</p>



<a name="264073499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264073499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264073499">(Dec 07 2021 at 21:18)</a>:</h4>
<p>Yeah, that's the part of me that's overly-persnickety.  Same part that doesn't like <code>count_ones</code> on signed numbers.</p>
<p>Definitely not something I'd actually propose :P</p>



<a name="264169805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264169805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264169805">(Dec 08 2021 at 15:20)</a>:</h4>
<p>I don't understand why count_ones wouldn't be available on a signed value</p>



<a name="264195141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Idiomatic%3A%20slices%20vs%20Iterators/near/264195141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Idiomatic.3A.20slices.20vs.20Iterators.html#264195141">(Dec 08 2021 at 18:04)</a>:</h4>
<p>probably because it would be confusing whether the sign bit contributes to the count as well? you can just do <code>(-1i8 as u8).count_ones()</code> though.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>