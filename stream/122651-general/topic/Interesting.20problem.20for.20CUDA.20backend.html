<html>
<head><meta charset="utf-8"><title>Interesting problem for CUDA backend · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html">Interesting problem for CUDA backend</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253521547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253521547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253521547">(Sep 16 2021 at 03:04)</a>:</h4>
<p>I have a very odd issue with a codegen i am working on, this codegen targets the cuda libnvvm library to allow you to write gpu kernels in rust. I have been working on trying to get panics to spit out nice messages, but i am running into issues i am incredibly confused on and someone may be able to shed more light on. </p>
<p>For background, CUDA has both the ability to malloc memory on the gpu and the ability to print from it.<br>
The former is done by linking to <code>fn malloc(size: usize) -&gt; *mut u8;</code> as well as a free function, and the latter is the same but with a vprintf function that takes a format string and a var list. The printed data is put into a circular buffer of about 1mb, then this buffer is flushed on kernel launches, synchronization, module load/unloads, or context destruction. </p>
<p>Using these functions normally works great with no issues, but for some reason, they simply do not work when put inside of a panic handler, well, i am able to do <code>print!("a")</code> and malloc some memory manually, but for some odd reason, trying to format stuff into strings does not work, here is the full code to the panic handler: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=5fb2d772757b1da5b7146f56e8777cae">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=5fb2d772757b1da5b7146f56e8777cae</a></p>
<p>It results in an <code>InvalidAddress</code> error when the cuda stream tries to synchronize. Curiously, the first two things work great (the <code>thread_str</code> and <code>block_str</code>), printing that by itself works. But the locstr and overall msg does not work. But the thing that makes this really confusing, is that using <code>ManuallyDrop::new(loc.file().to_string())</code> does in fact work. But this makes no sense, format should have made a new buffer that does not reference the old stuff. So i see no reason why manuallydrop would make a difference. </p>
<p>I could not get <code>msg</code> to work in any way, no matter the amount of manuallydrops i put on that thing.</p>



<a name="253629793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253629793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253629793">(Sep 16 2021 at 18:40)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> Could you link to the implementation of <code>println!</code>?</p>



<a name="253630199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253630199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253630199">(Sep 16 2021 at 18:43)</a>:</h4>
<p><span class="user-mention" data-user-id="125294">@Aaron Hill</span> </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// CUDA syscalls implicitly defined by nvvm you can link to.</span>

<span class="w">    </span><span class="cp">#[doc(hidden)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">vprintf</span><span class="p">(</span><span class="n">format</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">valist</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">core</span>::<span class="n">ffi</span>::<span class="n">c_void</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cp">#[doc(hidden)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">__assertfail</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">message</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">file</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">line</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">function</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">char_size</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// Alternative to [`print!`](std::print) which works on CUDA. See [`print`](self) for more info.</span>
<span class="cp">#[macro_export]</span><span class="w"></span>
<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">print</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$($arg</span>:<span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>::<span class="n">alloc</span>::<span class="fm">format!</span><span class="p">(</span><span class="cp">$($arg</span><span class="p">)</span><span class="o">*</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="cp">$crate</span>::<span class="n">io</span>::<span class="n">vprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">ptr</span>::<span class="n">null_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// Alternative to [`println!`](std::println) which works on CUDA. See [`print`](self) for more info.</span>
<span class="cp">#[macro_export]</span><span class="w"></span>
<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">println</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="cp">$crate</span>::<span class="fm">print!</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$fmt</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="cp">$crate</span>::<span class="fm">print!</span><span class="p">(</span><span class="fm">concat!</span><span class="p">(</span><span class="cp">$fmt</span><span class="p">,</span><span class="w"> </span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$fmt</span>:<span class="nc">expr</span><span class="p">,</span><span class="w"> </span><span class="cp">$($arg</span>:<span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="cp">$crate</span>::<span class="fm">print!</span><span class="p">(</span><span class="fm">concat!</span><span class="p">(</span><span class="cp">$fmt</span><span class="p">,</span><span class="w"> </span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">),</span><span class="w"> </span><span class="cp">$($arg</span><span class="p">)</span><span class="o">*</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="253630230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253630230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253630230">(Sep 16 2021 at 18:43)</a>:</h4>
<p>Is this in a public repository?</p>



<a name="253630262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253630262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253630262">(Sep 16 2021 at 18:44)</a>:</h4>
<p>Not currently but i could</p>



<a name="253630321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253630321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253630321">(Sep 16 2021 at 18:44)</a>:</h4>
<p>That would be really helpful</p>



<a name="253630413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253630413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253630413">(Sep 16 2021 at 18:44)</a>:</h4>
<p>I could put the crate with the printing in a temp public repo, the whole thing has like 7+ crates ill release eventually</p>



<a name="253630445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253630445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253630445">(Sep 16 2021 at 18:45)</a>:</h4>
<p>but the other crates are mostly irrelevant</p>



<a name="253630533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253630533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253630533">(Sep 16 2021 at 18:45)</a>:</h4>
<p>Just give me about 15 min and ill go ahead and do it <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="253631012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631012">(Sep 16 2021 at 18:48)</a>:</h4>
<p>or actually, <span class="user-mention" data-user-id="125294">@Aaron Hill</span> the crate is pretty small, would u rather i just send it as a zip file?</p>



<a name="253631289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631289">(Sep 16 2021 at 18:50)</a>:</h4>
<p>A git repository would be easier for me, personally</p>



<a name="253631310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631310">(Sep 16 2021 at 18:50)</a>:</h4>
<p>Alright</p>



<a name="253631360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631360">(Sep 16 2021 at 18:51)</a>:</h4>
<p>The CUDA docs seem to imply that pointer arguments will get read from the host side: <a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#limitations">https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#limitations</a></p>



<a name="253631387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631387">(Sep 16 2021 at 18:51)</a>:</h4>
<p>"This means that the format string must be understood by the host-system's compiler and C library."</p>



<a name="253631418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631418">(Sep 16 2021 at 18:51)</a>:</h4>
<p>e.g. a  <code>%s</code> will get interpreted by the host libc, causing it to read a string from the provided pointer</p>



<a name="253631465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631465">(Sep 16 2021 at 18:52)</a>:</h4>
<p>which would explain why using <code>ManuallyDrop</code> fixes the issue</p>



<a name="253631508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631508">(Sep 16 2021 at 18:52)</a>:</h4>
<p>But that doesnt make sense because if that were true, then formatting, printing, then trapping in a kernel wouldnt work</p>



<a name="253631662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631662">(Sep 16 2021 at 18:53)</a>:</h4>
<p>and im pretty sure (but not certain) that cuda cleans up kernel allocated memory automatically when a kernel is finished</p>



<a name="253631807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631807">(Sep 16 2021 at 18:54)</a>:</h4>
<p>wouldn't the buffer get flushed (and processed?) by the trap?</p>



<a name="253631865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631865">(Sep 16 2021 at 18:54)</a>:</h4>
<p>i don't think trapping flushes the buffer, synchronizing on the cpu does flush it however</p>



<a name="253631873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631873">(Sep 16 2021 at 18:54)</a>:</h4>
<p>hmm</p>



<a name="253631995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631995">(Sep 16 2021 at 18:55)</a>:</h4>
<p>I mean i guess maybe i could preallocate a static global buffer then write into that? but that does not seem very practical or safe...</p>



<a name="253631999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253631999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253631999">(Sep 16 2021 at 18:55)</a>:</h4>
<p>well, we've reached the limit of my cuda knowledge :)</p>



<a name="253632053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253632053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253632053">(Sep 16 2021 at 18:55)</a>:</h4>
<p>However, I think the combination of the docs and the <code>ManuallyDrop</code> behavior strongly suggests that cuda is requiring the pointer to be valid beyond the actual end of the <code>vprintf</code> call</p>



<a name="253632149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253632149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253632149">(Sep 16 2021 at 18:56)</a>:</h4>
<p>Yeah that could be it, but im not sure how to solve that</p>



<a name="253632166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253632166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253632166">(Sep 16 2021 at 18:56)</a>:</h4>
<p>e.g. after <code>vprintf</code> returns, it's not necessarily safe to deallocate the memory used by any of the pointers you passed in as an argument</p>



<a name="253632216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253632216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253632216">(Sep 16 2021 at 18:56)</a>:</h4>
<p>but manuallydropping the formatted msg in the print macro does not fix it</p>



<a name="253632483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253632483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253632483">(Sep 16 2021 at 18:58)</a>:</h4>
<p>Have you tried running <code>cuda-memcheck</code>?</p>



<a name="253632530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253632530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253632530">(Sep 16 2021 at 18:58)</a>:</h4>
<p>i havent, that might be helpful</p>



<a name="253633078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253633078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253633078">(Sep 16 2021 at 19:01)</a>:</h4>
<p>hmmm no memcheck doesnt seem to give any insights :/</p>



<a name="253633115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253633115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253633115">(Sep 16 2021 at 19:01)</a>:</h4>
<p>because i presume this is a cpu-side fault</p>



<a name="253633357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253633357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253633357">(Sep 16 2021 at 19:02)</a>:</h4>
<p><a href="/user_uploads/4715/btvO2dU8ggUXwKR9Q8DQzA0o/Screenshot_375.png">Screenshot_375.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/btvO2dU8ggUXwKR9Q8DQzA0o/Screenshot_375.png" title="Screenshot_375.png"><img src="/user_uploads/4715/btvO2dU8ggUXwKR9Q8DQzA0o/Screenshot_375.png"></a></div>



<a name="253633620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253633620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253633620">(Sep 16 2021 at 19:04)</a>:</h4>
<p>the synchronization call yields <code>IllegalAddress</code></p>



<a name="253633811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253633811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253633811">(Sep 16 2021 at 19:05)</a>:</h4>
<p>and illegaladdress is</p>
<div class="codehilite"><pre><span></span><code>The device encountered a load or store instruction on an invalid memory address. This leaves the process in an inconsistent state and any further CUDA work will return the same error. To continue using CUDA, the process must be terminated and relaunched.
</code></pre></div>



<a name="253633867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253633867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253633867">(Sep 16 2021 at 19:05)</a>:</h4>
<p>but this implies its a gpu-side fault... <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="253634246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253634246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253634246">(Sep 16 2021 at 19:08)</a>:</h4>
<p>I wonder if you're missing a null terminator.</p>



<a name="253634328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253634328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253634328">(Sep 16 2021 at 19:08)</a>:</h4>
<p>oh my god if that is it i am going to cry</p>



<a name="253634335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253634335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253634335">(Sep 16 2021 at 19:08)</a>:</h4>
<p>you're passing String::as_ptr to a function that I presume accepts a C string.</p>



<a name="253634387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253634387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253634387">(Sep 16 2021 at 19:09)</a>:</h4>
<p>alloc::string::String isn't null-terminated.</p>



<a name="253634399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253634399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253634399">(Sep 16 2021 at 19:09)</a>:</h4>
<p>yeah</p>



<a name="253634684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253634684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253634684">(Sep 16 2021 at 19:11)</a>:</h4>
<p>hmm no that did not fix it :/</p>



<a name="253634841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253634841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253634841">(Sep 16 2021 at 19:12)</a>:</h4>
<p>I think CUDA knows how big every single memory allocation on the gpu is, thats why it can just take a pointer and free it</p>



<a name="253635289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253635289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253635289">(Sep 16 2021 at 19:15)</a>:</h4>
<p>the other thing i can think of is that maybe the data thats given in panicinfo is corrupted somehow</p>



<a name="253635359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253635359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253635359">(Sep 16 2021 at 19:15)</a>:</h4>
<p>If the nul terminator is missing, vprintf doesn't know where the format string ends.</p>



<a name="253635483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253635483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253635483">(Sep 16 2021 at 19:16)</a>:</h4>
<p>but then it wouldnt work when printing anything, it can print stuff like thread_str just fine</p>



<a name="253635568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253635568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253635568">(Sep 16 2021 at 19:17)</a>:</h4>
<p>It may be the case that there just so happens to be a null byte after the allocated memory in some cases.</p>



<a name="253635570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253635570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253635570">(Sep 16 2021 at 19:17)</a>:</h4>
<p>and the fact that cuda's <code>free()</code> only takes a pointer makes me think cuda automagically knows how big any allocated memory buffer is</p>



<a name="253635623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253635623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253635623">(Sep 16 2021 at 19:17)</a>:</h4>
<p>Yes, the allocator does, but vprintf doesn't.</p>



<a name="253635638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253635638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253635638">(Sep 16 2021 at 19:17)</a>:</h4>
<p>right</p>



<a name="253635658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253635658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253635658">(Sep 16 2021 at 19:17)</a>:</h4>
<p>although adding a nul to the format in vprintf doesnt seem to fix it</p>



<a name="253635804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253635804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253635804">(Sep 16 2021 at 19:18)</a>:</h4>
<p>even core doesnt add a nul in the example <a href="https://doc.rust-lang.org/core/arch/nvptx/fn.vprintf.html">https://doc.rust-lang.org/core/arch/nvptx/fn.vprintf.html</a></p>



<a name="253635834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253635834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253635834">(Sep 16 2021 at 19:19)</a>:</h4>
<p>Maybe try adding <code>core::mem::forget(msg)</code> after the vprintf?</p>



<a name="253636040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253636040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253636040">(Sep 16 2021 at 19:20)</a>:</h4>
<blockquote>
<p>even core doesnt add a nul in the example <a href="https://doc.rust-lang.org/core/arch/nvptx/fn.vprintf.html">https://doc.rust-lang.org/core/arch/nvptx/fn.vprintf.html</a></p>
</blockquote>
<p>That is probably a mistranslation of the nvidia docs. C implicitly adds the nul terminator, rust doesn't.</p>



<a name="253636082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253636082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253636082">(Sep 16 2021 at 19:20)</a>:</h4>
<p>yeah that could also happen</p>



<a name="253636109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253636109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253636109">(Sep 16 2021 at 19:20)</a>:</h4>
<p>no that did not seem to fix it</p>



<a name="253636166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253636166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253636166">(Sep 16 2021 at 19:21)</a>:</h4>
<p><span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p>



<a name="253636294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253636294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253636294">(Sep 16 2021 at 19:22)</a>:</h4>
<p>I am afraid I won't be able to help you with debugging this.</p>



<a name="253636339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253636339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253636339">(Sep 16 2021 at 19:22)</a>:</h4>
<p>yeah i think i might open a thread on the cuda forums because i'm pretty confused on this</p>



<a name="253636482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253636482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253636482">(Sep 16 2021 at 19:23)</a>:</h4>
<p>Lemme try something, ill allocate a buffer manually and get cuda to print it and see if it expects a nul</p>



<a name="253637070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253637070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253637070">(Sep 16 2021 at 19:27)</a>:</h4>
<p>actually, it seems like vprintf does in fact expect a nul</p>



<a name="253637156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253637156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253637156">(Sep 16 2021 at 19:28)</a>:</h4>
<p>because</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cuda_std</span>::<span class="n">mem</span>::<span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"abcdefgh</span><span class="se">\0</span><span class="s">u"</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">copy_nonoverlapping</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span><span class="w"> </span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">cuda_std</span>::<span class="n">io</span>::<span class="n">vprintf</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span><span class="w"> </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">null_mut</span><span class="p">());</span><span class="w"></span>
</code></pre></div>
<p>prints </p>
<div class="codehilite"><pre><span></span><code>abcdefgh
</code></pre></div>



<a name="253637231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253637231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253637231">(Sep 16 2021 at 19:28)</a>:</h4>
<p>so thats <em>one</em> of the issues, but it seems like stuff is failing before it even gets to the vprintf call</p>



<a name="253638358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253638358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253638358">(Sep 16 2021 at 19:36)</a>:</h4>
<p>Where does PanicInfo get allocated? is everything static or does it come from somewhere else?</p>



<a name="253641956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253641956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253641956">(Sep 16 2021 at 20:00)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/c5cbf7852a7692c7c51df64c09a59e7838b55202/library/core/src/panicking.rs#L93">https://github.com/rust-lang/rust/blob/c5cbf7852a7692c7c51df64c09a59e7838b55202/library/core/src/panicking.rs#L93</a></p>



<a name="253649360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Interesting%20problem%20for%20CUDA%20backend/near/253649360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Interesting.20problem.20for.20CUDA.20backend.html#253649360">(Sep 16 2021 at 20:53)</a>:</h4>
<p>hmm thats odd, ill just trap normally for now and try to figure it out in the future, gpus shouldnt really be panicking anyways</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>