<html>
<head><meta charset="utf-8"><title>Compile Time Checked Url · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Compile.20Time.20Checked.20Url.html">Compile Time Checked Url</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260731084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Compile%20Time%20Checked%20Url/near/260731084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blake Johnson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Compile.20Time.20Checked.20Url.html#260731084">(Nov 08 2021 at 22:58)</a>:</h4>
<p>Hi Folks,<br>
I have a use case where I need to embed a Url in a data structure. This Url is static. <a href="https://docs.rs/url/2.2.2/url/struct.Url.html#method.parse">Url::parse()</a> is fallible and not <code>const</code> so right now I'm performing the parse as part of a runtime call. Ideally I'd like this to fail at compile time if for some reason this Url starts to not parse for some reason. Does anyone know of options for this? My fallback idea was a unit test with an assert on a Url::parse() of the candidate Url stored as a const str.</p>



<a name="260806348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Compile%20Time%20Checked%20Url/near/260806348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antoine Martin <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Compile.20Time.20Checked.20Url.html#260806348">(Nov 09 2021 at 14:39)</a>:</h4>
<p>Big Bad Idea ahead: </p>
<p>a proc macro <code>const_url!(input)</code> that calls <code>Url::parse</code>, checks and displays eventual errors, then emits <code>Url::parse(input)</code> as the macro output (so the Url is still parsed at runtime, but was checked at compile time)</p>



<a name="260806485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Compile%20Time%20Checked%20Url/near/260806485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antoine Martin <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Compile.20Time.20Checked.20Url.html#260806485">(Nov 09 2021 at 14:40)</a>:</h4>
<p>(it's ugly and I don't think it's worth the additional compilation guarantees though <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span> )</p>



<a name="260820940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Compile%20Time%20Checked%20Url/near/260820940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Compile.20Time.20Checked.20Url.html#260820940">(Nov 09 2021 at 16:13)</a>:</h4>
<p>you could parse the URL in <code>build.rs</code> and panic if the URL doesn't parse, which would explode out into a compile error.</p>



<a name="260856325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Compile%20Time%20Checked%20Url/near/260856325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Compile.20Time.20Checked.20Url.html#260856325">(Nov 09 2021 at 20:31)</a>:</h4>
<p>The simplest approach here would be to auto-generate a (doc-)test that parses the Url. The more proper approach would be to submit a PR to <code>::url</code> with a <code>const fn</code> version of the parsing, or, if you don't want to go that far, to use a proc-macro to call <code>Url::parse()</code> at its runtime. Or a <code>build.rs</code>, where it's easier to write the code, but the call-sites would become way more cumbersome.</p>
<p>Here is an example of option 1, which can be implemented as simply as with just a <code>macro_rules!</code> macro:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">test_checked_url</span><span class="w"> </span><span class="p">{(</span><span class="w"> </span><span class="cp">$url</span>:<span class="nc">literal</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">({</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[doc = concat!(</span><span class="s">"```rust</span><span class="se">\n</span><span class="s">"</span><span class="cp">, stringify! {</span>
<span class="cp">        let _ = ::url::Url::parse($url).unwrap_or_else(|err| {</span>
<span class="cp">            panic!(</span><span class="s">"Failed to parse {:?} as a URL: {}"</span><span class="cp">, $url, err);</span>
<span class="cp">        });</span>
<span class="cp">    }, </span><span class="s">"</span><span class="se">\n</span><span class="s">```"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="w">    </span>::<span class="n">url</span>::<span class="n">Url</span>::<span class="n">parse</span><span class="p">(</span><span class="cp">$url</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="p">})}</span><span class="w"></span>
</code></pre></div>
<ul>
<li><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=43a7c53b70b9745821d8b1a9fa608766">Playground</a></li>
</ul>



<a name="260856862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Compile%20Time%20Checked%20Url/near/260856862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Compile.20Time.20Checked.20Url.html#260856862">(Nov 09 2021 at 20:35)</a>:</h4>
<p>Or if you want to go extra fancy: implement a custom lint pass (dylint) that would detect <code>Url::parse(&lt;incorrect literal&gt;)</code> invocations <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="260867465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Compile%20Time%20Checked%20Url/near/260867465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Compile.20Time.20Checked.20Url.html#260867465">(Nov 09 2021 at 21:55)</a>:</h4>
<p>sounds a lot like the old compile-time <code>regex!</code> macro</p>



<a name="261086175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Compile%20Time%20Checked%20Url/near/261086175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Blake Johnson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Compile.20Time.20Checked.20Url.html#261086175">(Nov 11 2021 at 02:39)</a>:</h4>
<p>thanks for the answers and ideas folks - wanted to add as well that I found an issue on the <code>url</code> crate that discusses why this is not functionality that it provides now <a href="https://github.com/servo/rust-url/issues/652">https://github.com/servo/rust-url/issues/652</a></p>



<a name="261091968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Compile%20Time%20Checked%20Url/near/261091968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathaniel <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Compile.20Time.20Checked.20Url.html#261091968">(Nov 11 2021 at 04:24)</a>:</h4>
<p>If anyone is curious — a main reason is that <code>Url</code>s contain the url string as a <code>String</code> inside them, so parsing requires allocation</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>