<html>
<head><meta charset="utf-8"><title>✔ https://github.com/rust-lang/rust/issues/83518 · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html">✔ https://github.com/rust-lang/rust/issues/83518</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277185537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277185537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277185537">(Mar 30 2022 at 18:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="459607">infrandomness</span> has marked this topic as resolved.</p>



<a name="277517296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277517296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> infrandomness <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277517296">(Apr 02 2022 at 09:07)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> I am willing to tackle the step :<br>
« reduce the noisiness (it's reported multiple times on different parts of an expression, but should only trigger on the innermost/first one) » and all of the other ones as well</p>



<a name="277523656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277523656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277523656">(Apr 02 2022 at 11:23)</a>:</h4>
<p>Cool!. I don't quite know yet what the best way tackle it is, but one way that could work is to add a field to MirNeighborCollector that is a <code>Vec&lt;Span&gt;</code> and check before emitting whether we've seen a span before that overlaps with the new one. When we emit, we add the span to the vec</p>



<a name="277525453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277525453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277525453">(Apr 02 2022 at 12:01)</a>:</h4>
<p>Shouldn't that be a <code>HashSet</code> or <code>BTreeSet</code>? <span aria-label="innocent" class="emoji emoji-1f607" role="img" title="innocent">:innocent:</span></p>



<a name="277543401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277543401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> infrandomness <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277543401">(Apr 02 2022 at 18:11)</a>:</h4>
<p>What is the difference between these 3?</p>



<a name="277544017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277544017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277544017">(Apr 02 2022 at 18:24)</a>:</h4>
<p>HashSet and BTreeSet mostly differ in performance characteristics and BTreeSet has an iterator method returning values in the order of the <code>PartialOrd</code> impl on the element type. For HashSet iterating results in a random order. Both HashSet and BTreeSet don't allow duplicate elements and allow checking if an element is present in logarithmic time, while Vec allows duplicates and requires checking if an element is present in linear time which is slower.</p>



<a name="277548131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277548131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277548131">(Apr 02 2022 at 19:50)</a>:</h4>
<p>A BTreeSet should allow finding overlapping/containing spans faster than the other two.</p>



<a name="277708918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277708918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> infrandomness <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277708918">(Apr 04 2022 at 10:07)</a>:</h4>
<p>So I've started working on this and I added a field to the <code>MirNeighborCollector</code>, but now all of the instances of that struct ask for the argument to be passed</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Index</span>: <span class="nc">compiler</span><span class="o">/</span><span class="n">rustc_monomorphize</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">collector</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="n">IDEA</span><span class="w"> </span><span class="n">additional</span><span class="w"> </span><span class="n">info</span>:
<span class="nc">Subsystem</span>: <span class="nc">com</span><span class="p">.</span><span class="n">intellij</span><span class="p">.</span><span class="n">openapi</span><span class="p">.</span><span class="n">diff</span><span class="p">.</span><span class="k">impl</span><span class="p">.</span><span class="n">patch</span><span class="p">.</span><span class="n">CharsetEP</span><span class="w"></span>
<span class="o">&lt;+&gt;</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="w"></span>
<span class="o">===================================================================</span><span class="w"></span>
<span class="n">diff</span><span class="w"> </span><span class="o">--</span><span class="n">git</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_monomorphize</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">collector</span><span class="p">.</span><span class="n">rs</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_monomorphize</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">collector</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="o">---</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_monomorphize</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">collector</span><span class="p">.</span><span class="n">rs</span><span class="w">  </span><span class="p">(</span><span class="n">revision</span><span class="w"> </span><span class="mi">2</span><span class="n">ad4eb207b369017f5140918b5e4b0d3650b46b0</span><span class="p">)</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_monomorphize</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">collector</span><span class="p">.</span><span class="n">rs</span><span class="w">  </span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="mi">1649066818484</span><span class="p">)</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">178</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">178</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="o">@@</span><span class="w"></span>
<span class="w"> </span><span class="sd">//! this is not implemented however: a mono item will be produced</span>
<span class="w"> </span><span class="sd">//! regardless of whether it is actually needed or not.</span>

<span class="o">+</span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="n">BTreeSet</span><span class="p">;</span><span class="w"></span>
<span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">rustc_data_structures</span>::<span class="n">fx</span>::<span class="p">{</span><span class="n">FxHashMap</span><span class="p">,</span><span class="w"> </span><span class="n">FxHashSet</span><span class="p">};</span><span class="w"></span>
<span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">rustc_data_structures</span>::<span class="n">sync</span>::<span class="p">{</span><span class="n">par_iter</span><span class="p">,</span><span class="w"> </span><span class="n">MTLock</span><span class="p">,</span><span class="w"> </span><span class="n">MTRef</span><span class="p">,</span><span class="w"> </span><span class="n">ParallelIterator</span><span class="p">};</span><span class="w"></span>
<span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">rustc_hir</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">hir</span><span class="p">;</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">605</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">606</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="o">@@</span><span class="w"></span>
<span class="w">     </span><span class="n">body</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">mir</span>::<span class="n">Body</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="n">output</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">mut</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Spanned</span><span class="o">&lt;</span><span class="n">MonoItem</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="n">instance</span>: <span class="nc">Instance</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">    </span><span class="n">large_assignment_lint</span>: <span class="nc">BTreeSet</span><span class="o">&lt;</span><span class="n">Span</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w"> </span><span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MirNeighborCollector</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">1386</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">1388</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="o">@@</span><span class="w"></span>
<span class="w">     </span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="n">instance</span>: <span class="nc">Instance</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="n">output</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Spanned</span><span class="o">&lt;</span><span class="n">MonoItem</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="o">+</span><span class="w">    </span><span class="n">large_assignment_lint</span>: <span class="nc">BTreeSet</span><span class="o">&lt;</span><span class="n">Span</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="s">"collect_neighbours: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">def_id</span><span class="p">());</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">instance_mir</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="n">def</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0061</span><span class="p">]</span>: <span class="nc">this</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">arguments</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">arguments</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">supplied</span><span class="w"></span>
<span class="w">    </span><span class="o">-</span>-&gt; <span class="nc">compiler</span><span class="o">/</span><span class="n">rustc_monomorphize</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">collector</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">424</span>:<span class="mi">17</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="w"></span>
<span class="mi">424</span><span class="w">  </span><span class="o">|</span><span class="w">                 </span><span class="n">collect_neighbours</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">neighbors</span><span class="p">);</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="w">                 </span><span class="o">^^^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="o">---</span><span class="w">  </span><span class="o">--------</span><span class="w">  </span><span class="o">--------------</span><span class="w"> </span><span class="n">supplied</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">arguments</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="w">                 </span><span class="n">expected</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">arguments</span><span class="w"></span>
<span class="w">     </span><span class="o">|</span><span class="w"></span>
</code></pre></div>
<p>the thing is, I don't know what to give to them, since the place I add elements to is in the function <code>visit_operand()</code></p>



<a name="277711196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277711196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> infrandomness <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277711196">(Apr 04 2022 at 10:30)</a>:</h4>
<p>There's something I'm missing here, what I've done is so ugly</p>



<a name="277712387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277712387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277712387">(Apr 04 2022 at 10:43)</a>:</h4>
<p>Just getting caught up on this; is it the intent of the design that this lint runs after optimizations? We have existing passes - NRVO and dest prop, the first of which is on by default - that eliminate these kinds of moves. This seems like it means we'd give different output on debug vs release mode, which feels not great</p>



<a name="277712413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277712413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277712413">(Apr 04 2022 at 10:43)</a>:</h4>
<p>Does it even make sense to emit this lint on debug mode at all?</p>



<a name="277712546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277712546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> infrandomness <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277712546">(Apr 04 2022 at 10:44)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I'll let oli answer that</p>



<a name="277863459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277863459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> infrandomness <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277863459">(Apr 05 2022 at 11:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518/near/277712413">said</a>:</p>
<blockquote>
<p>Does it even make sense to emit this lint on debug mode at all?</p>
</blockquote>
<p><span class="user-mention" data-user-id="124288">@oli</span></p>



<a name="277865352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277865352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277865352">(Apr 05 2022 at 11:55)</a>:</h4>
<p>Hmm... is the effect of release-only mir opts that strong on generator size?</p>



<a name="277865540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277865540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277865540">(Apr 05 2022 at 11:56)</a>:</h4>
<p>Not running in debug mode seems a bit weird, but having different results depending on opts is also not great.</p>



<a name="277867980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277867980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277867980">(Apr 05 2022 at 12:16)</a>:</h4>
<p>This is not just generator size. Optimizations can entirely eliminate large assignments.</p>



<a name="277882293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277882293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277882293">(Apr 05 2022 at 13:57)</a>:</h4>
<p>Speaking practically, I don't think "release-only" mir opts are really a thing. I looked through all the passes in rustc_transform and these are the only ones not gated on <code>-Zunsound-mir-opts</code> or <code>mir-opt-level &gt; 0</code>:</p>
<ul>
<li><code>const-goto</code>: mir-opt-level &gt;= 4</li>
<li><code>deduplicate-blocks</code>: mir-opt-level &gt;= 4</li>
<li><code>match-branches</code>: mir-opt-level &gt;= 3</li>
<li><code>multiple-return-terminators</code>: mir-opt-level &gt;= 4</li>
<li><code>normalize-array-len</code>: mir-opt-level &gt;= 4</li>
<li><code>separate-const-switch</code>: mir-opt-level &gt;= 4</li>
<li><code>unreachable-prop</code>: mir-opt-level &gt;= 4</li>
</ul>
<p>However, we only ever set <a href="https://github.com/rust-lang/rust/blob/634770c0a7f8598164ab825cfe419cc8b03c36e5/compiler/rustc_session/src/options.rs#L106">mir-opt-level = 1 | 2</a>. So effectively, we don't have any mir opts that run on a release build and not a debug build.</p>



<a name="277914730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/277914730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jak{e,ob} Degen <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#277914730">(Apr 05 2022 at 17:27)</a>:</h4>
<p>Yeah, I'm worried about the assignments going away, not shrinking. Wesley makes a good point though, which probably means this is more of a theoretical distinction than a practical one at this point - still, I feel that it might be worth it to have some kind of plan here for when that changes</p>



<a name="278219408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20https%3A//github.com/rust-lang/rust/issues/83518/near/278219408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> infrandomness <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518.html#278219408">(Apr 07 2022 at 20:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310518">Jak{e,ob} Degen</span> <a href="#narrow/stream/122651-general/topic/.E2.9C.94.20https.3A.2F.2Fgithub.2Ecom.2Frust-lang.2Frust.2Fissues.2F83518/near/277914730">said</a>:</p>
<blockquote>
<p>Yeah, I'm worried about the assignments going away, not shrinking. Wesley makes a good point though, which probably means this is more of a theoretical distinction than a practical one at this point - still, I feel that it might be worth it to have some kind of plan here for when that changes</p>
</blockquote>
<p>so what should I do ?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>