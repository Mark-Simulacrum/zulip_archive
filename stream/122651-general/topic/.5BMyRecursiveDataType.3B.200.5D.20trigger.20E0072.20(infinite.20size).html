<html>
<head><meta charset="utf-8"><title>[MyRecursiveDataType; 0] trigger E0072 (infinite size) · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html">[MyRecursiveDataType; 0] trigger E0072 (infinite size)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266963908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/266963908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#266963908">(Jan 05 2022 at 17:23)</a>:</h4>
<p>As can be seen in this <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=42e9cd668aceaced9c82401185c138c8">playground</a> the struct <code>ArrayZero</code> has a array of <code>Self</code> with size 0. I would expect this code to compile fine because the size == 0 but it doesn't.<br>
So why does <code>[T; 0]</code> with <code>T</code> being recursive over himself trigger E0072 (infinite size) ?</p>



<a name="266964095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/266964095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#266964095">(Jan 05 2022 at 17:24)</a>:</h4>
<p>This seems to me that the compiler is not checking if the size is zero but I may be missing something here.</p>



<a name="266964787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/266964787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#266964787">(Jan 05 2022 at 17:31)</a>:</h4>
<p>I suspect that the compiler is first calculating the size of the array element type, and then multiplying it by the array size</p>



<a name="266964912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/266964912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#266964912">(Jan 05 2022 at 17:32)</a>:</h4>
<p>instead of special-casing arrays with zero elements and skipping the calculation of the array element size</p>



<a name="266964947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/266964947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#266964947">(Jan 05 2022 at 17:32)</a>:</h4>
<p>Were you just curious, or do you have a specific use-case in mind?</p>



<a name="266965392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/266965392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#266965392">(Jan 05 2022 at 17:36)</a>:</h4>
<p>I do have a use case for it. I wanted to make <code>RawVec</code> const generic over a max stack size element (ie the maximum number of element than can be put on the stack) and give it a default to 0 so than it doesn't break existing code and handle recursive data type.</p>



<a name="266966348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/266966348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#266966348">(Jan 05 2022 at 17:44)</a>:</h4>
<p>Ah! <code>FIXME(#11924) Behavior undecided for zero-length vectors.</code> in <a href="https://github.com/rust-lang/rust/blob/181e91567c9f347e055b33b1d7e9894f769aafe3/compiler/rustc_ty_utils/src/representability.rs#L88">compiler/rustc_ty_utils/src/representability.rs</a></p>



<a name="267186621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/267186621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#267186621">(Jan 07 2022 at 13:08)</a>:</h4>
<p>I wonder how this interacts with const generics.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">ArrayZero</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">S</span>: <span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">field</span>: <span class="p">[</span><span class="bp">Self</span><span class="p">;</span><span class="w"> </span><span class="n">S</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>If we were to allow the example above, how do we emit errors when <code>S</code> isn't zero?</p>



<a name="267187678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/267187678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#267187678">(Jan 07 2022 at 13:19)</a>:</h4>
<p><span class="user-mention" data-user-id="361356">@fee1-dead</span> The <a href="https://github.com/rust-lang/rust/blob/181e91567c9f347e055b33b1d7e9894f769aafe3/compiler/rustc_ty_utils/src/representability.rs#L88">code</a> that checks the representability of an type can simply evaluate the count and check if the count is != 0, like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="n">ty</span>::<span class="n">Array</span><span class="p">(</span><span class="n">tya</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// A array of size 0 is always representable no matter what it contains</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">try_eval_usize</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">param_env</span><span class="p">(</span><span class="n">def_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Representability</span>::<span class="n">Representable</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">is_type_structurally_recursive</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">tcx</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">sp</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">def_id</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">seen</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">shadow_seen</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">representable_cache</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">tya</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">force_result</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
</code></pre></div>



<a name="267188045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/267188045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#267188045">(Jan 07 2022 at 13:23)</a>:</h4>
<p>Then it wouldn't be able to allow the const generics case. Such recursive errors could only be caught in post monomorphization if we were to allow const generics</p>



<a name="267188293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/267188293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#267188293">(Jan 07 2022 at 13:25)</a>:</h4>
<p>I have tested this change with <code>ArrayZero</code> and const generic and it works perfectly.</p>



<a name="267188322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/267188322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#267188322">(Jan 07 2022 at 13:26)</a>:</h4>
<p>If possible, I would make <code>[Self; S]</code> error when <code>S</code> is generic, even if it <em>could</em> be <code>0</code>, precisely for the reasons pointed out by <span class="user-mention" data-user-id="361356">@fee1-dead</span></p>



<a name="267188453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/267188453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#267188453">(Jan 07 2022 at 13:27)</a>:</h4>
<p>But for a hard-coded / non-generics-dependent <code>const</code> value then allowing things such as <code>[Self; 0]</code> or <code>[Self; A_CONST - ANOTHER]</code> seems very sensible <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="267188871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/267188871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#267188871">(Jan 07 2022 at 13:31)</a>:</h4>
<p>In my case this would defeat the all purpose of special casing it.<br>
The complete code that I want to allow is this one:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">ArrayZero</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">S</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">field</span>: <span class="p">[</span><span class="bp">Self</span><span class="p">;</span><span class="w"> </span><span class="n">S</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Which wouldn't be possible with your proposed restriction.</p>



<a name="267189220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/267189220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#267189220">(Jan 07 2022 at 13:34)</a>:</h4>
<p>What would be the alignment of <code>Foo</code> where <code>struct Foo([Foo; 0])</code>? Does it depend on the alignment of <code>Foo</code>?</p>



<a name="267189666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/267189666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#267189666">(Jan 07 2022 at 13:39)</a>:</h4>
<p>That a good question. Normally the alignment of <code>[Foo; 0]</code> is the alignment of <code>Foo</code> but in this case it's problematic because it will be an infinite recursion. I think that is what somewhat discuss in the tracking issue.</p>



<a name="267189828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/267189828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#267189828">(Jan 07 2022 at 13:41)</a>:</h4>
<p>Yah, just <a href="https://github.com/rust-lang/rust/issues/11924#issuecomment-298090502">here</a> by <span class="user-mention" data-user-id="119009">@eddyb</span></p>



<a name="267212923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%5BMyRecursiveDataType%3B%200%5D%20trigger%20E0072%20%28infinite%20size%29/near/267212923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.5BMyRecursiveDataType.3B.200.5D.20trigger.20E0072.20(infinite.20size).html#267212923">(Jan 07 2022 at 16:56)</a>:</h4>
<p>I don't see the issue here. This imposes a constraint that the alignment of Foo is at least the alignment of Foo, which is trivially satisfied. So the alignment would be the minimum alignment imposed by the other fields in the structure or the <code>#[align]</code> directive, else 1</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>