<html>
<head><meta charset="utf-8"><title>cargo build hangs, how to minimize · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html">cargo build hangs, how to minimize</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252922141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252922141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Emil Gardström <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252922141">(Sep 11 2021 at 17:00)</a>:</h4>
<p>Hi! I've found a regression in compilation introduced in <a href="https://github.com/rust-lang/rust/issues/85499">#85499</a>,</p>
<p>searched nightlies: from nightly-2021-08-17 to nightly-2021-09-10<br>
regressed nightly: nightly-2021-08-26<br>
searched commits: from <a href="https://github.com/rust-lang/rust/commit/b03ccace573bb91e27625c190a0f7807045a1012">https://github.com/rust-lang/rust/commit/b03ccace573bb91e27625c190a0f7807045a1012</a> to <a href="https://github.com/rust-lang/rust/commit/0afc20860eb98a29d9bbeea80f2acc5be38c6bf3">https://github.com/rust-lang/rust/commit/0afc20860eb98a29d9bbeea80f2acc5be38c6bf3</a><br>
regressed commit: <a href="https://github.com/rust-lang/rust/commit/0afc20860eb98a29d9bbeea80f2acc5be38c6bf3">https://github.com/rust-lang/rust/commit/0afc20860eb98a29d9bbeea80f2acc5be38c6bf3</a></p>
<p>&lt;details&gt;<br>
&lt;summary&gt;bisected with &lt;a href='<a href="https://github.com/rust-lang/cargo-bisect-rustc'&gt;cargo-bisect-rustc&lt;/a">https://github.com/rust-lang/cargo-bisect-rustc'&gt;cargo-bisect-rustc&lt;/a</a>&gt; v0.6.0&lt;/summary&gt;</p>
<p>Host triple: x86_64-pc-windows-msvc<br>
Reproduce with:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code># bisect-script.bat
pwsh.exe -noexit -Command "stop-job -Name cargobuild_bisect; if ((start-job -Name cargobuild_bisect { cargo build -p server 2&gt;&amp;1 } | wait-job -timeout 600).State -ne 'Completed') {receive-job -Name cargobuild_bisect; receive-job -Name cargobuild_bisect | remove-job -Force; exit 10} else {receive-job -Name cargobuild_bisect; receive-job -Name cargobuild_bisect | remove-job -Force; exit 0}"
</code></pre></div>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>cargo bisect-rustc --start<span class="o">=</span><span class="m">2021</span>-08-17 --script .<span class="se">\b</span>isect-script.bat
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>The issue is that compilation succeeds in a acceptable time before this change, but now it's seemingly taking forever, I have not tried this on linux, only windows so far. I'm not sure how I should report this because I'm not able to reproduce it outside my large workspace where I bisected this. Does anyone have an idea to what this could be or have a good way to figure out what the cause is?</p>
<p>some notable dependencies: actix-web, sqlx, serde, chrono, ring, tokio, tracing, reqwest,anyhow,eyre,async-trait and many more</p>
<p>I've tried</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">$ </span><span class="nb">export</span> <span class="nv">CARGO_LOG</span><span class="o">=</span><span class="s2">"info"</span>
<span class="gp">$ </span><span class="nb">export</span> <span class="nv">RUSTC_LOG</span><span class="o">=</span><span class="s2">"info"</span> <span class="c1"># to stop massive console spam I use this instead = "info,rustc_trait_selection=warn,rustc_codegen_ssa=warn,rustc_metadata=warn,rustc_mir=warn,rustc_query_system=warn,rustc_const_eval=warn"</span>
<span class="gp">$ </span>cargo build -p server
</code></pre></div>
<p>which outputs at the end</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>┐rustc_query_system::dep_graph::serialized::encode_node node=NodeInfo { node: variances_of(7b5e03ed597c3c33-573328205f4d7f81), fingerprint: Fingerprint(12749739837320991735, 10040035723298659737), edges: [2870] }
┘
┐rustc_query_system::dep_graph::serialized::encode_node node=NodeInfo { node: variances_of(7b5e03ed597c3c33-6f459134164ff719), fingerprint: Fingerprint(8361987967435134197, 5478714612052799554), edges: [2870] }
┘
[2021-09-11T16:54:37Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 0)
┐rustc_query_system::dep_graph::serialized::encode_node node=NodeInfo { node: variances_of(7b5e03ed597c3c33-82cb26faded76d4), fingerprint: Fingerprint(12749739837320991735, 10040035723298659737), edges: [2870] }
[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 1)
┘
[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 0)
┐rustc_query_system::dep_graph::serialized::encode_node node=NodeInfo { node: variances_of(7b5e03ed597c3c33-7c40a2b5f026df66), fingerprint: Fingerprint(12526569172406770563, 17126563881511896260), edges: [2870] }
[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 1)
┘
[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 0)
┐rustc_query_system::dep_graph::serialized::encode_node node=NodeInfo { node: variances_of(7b5e03ed597c3c33-c7d9e80976e93c5), fingerprint: Fingerprint(12526569172406770563, 17126563881511896260), edges: [2870] }
[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 1)
┘
[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 0)
    Building [=======================&gt; ] 445/446: server(bin)
</code></pre></div>
<p>and then just hangs. </p>
<p>How do I proceed?</p>



<a name="252922220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252922220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252922220">(Sep 11 2021 at 17:02)</a>:</h4>
<p><span class="user-mention" data-user-id="300380">@Emil Gardström</span> go ahead and open an issue so we don't lose track of it :)</p>



<a name="252922229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252922229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252922229">(Sep 11 2021 at 17:02)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="232957">@Jack Huey</span></p>



<a name="252922339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252922339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Emil Gardström <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252922339">(Sep 11 2021 at 17:04)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/88862">#88862</a></p>



<a name="252922358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252922358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252922358">(Sep 11 2021 at 17:04)</a>:</h4>
<p><span class="user-mention" data-user-id="300380">@Emil Gardström</span> can you do <code>RUSTC_LOG=rustc_trait_selection=debug</code> and post that?</p>



<a name="252922368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252922368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252922368">(Sep 11 2021 at 17:05)</a>:</h4>
<p>And it might be an infinite loop, so might grow large; you can truncate</p>



<a name="252922399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252922399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Emil Gardström <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252922399">(Sep 11 2021 at 17:06)</a>:</h4>
<p>on what commit do you want the rustc build?</p>



<a name="252922446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252922446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252922446">(Sep 11 2021 at 17:06)</a>:</h4>
<p>whatever nightly you're using</p>



<a name="252922460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252922460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Emil Gardström <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252922460">(Sep 11 2021 at 17:06)</a>:</h4>
<p>iirc debug is removed at compile in nightlies</p>



<a name="252922467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252922467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252922467">(Sep 11 2021 at 17:06)</a>:</h4>
<p>err, you're right</p>



<a name="252922565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252922565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252922565">(Sep 11 2021 at 17:08)</a>:</h4>
<p>I would say the best way forward is maybe some kind of minimization</p>



<a name="252923029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252923029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252923029">(Sep 11 2021 at 17:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="300380">Emil Gardström</span> <a href="#narrow/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize/near/252922460">said</a>:</p>
<blockquote>
<p>iirc debug is removed at compile in nightlies</p>
</blockquote>
<p>(opened <a href="https://github.com/rust-lang/rust/pull/88864">https://github.com/rust-lang/rust/pull/88864</a> and <a href="https://github.com/rust-lang/rust/pull/88863">https://github.com/rust-lang/rust/pull/88863</a> to see how hard this would be to change)</p>



<a name="252923104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252923104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252923104">(Sep 11 2021 at 17:18)</a>:</h4>
<p>reminder for myself: if those land, ping <span class="user-mention silent" data-user-id="120791">RalfJ</span> about changing the logging in miri to debug instead of info</p>



<a name="252933478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252933478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Emil Gardström <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252933478">(Sep 11 2021 at 20:32)</a>:</h4>
<p>The log as requested didn't pin point me anywhere (and it's 8GB), and I don't think it's going to be useful as there seems to be something that is causing something to become very deep, it is however not a loop (or atleast, no debug output after the same last line as in first log output). I've  managed to isolate the module where the halt occurs, so I think I can minimize it soon(tm)</p>



<a name="252967816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252967816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Emil Gardström <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252967816">(Sep 12 2021 at 07:46)</a>:</h4>
<p>I let the build run overnight with <code>info,rustc_trait_selection=debug</code> and it completed (with a stack failure)<br>
here's the log<br>
<a href="https://gist.github.com/Emilgardis/954c2aeefc0cca270a421a90ecc5067a#file-output-cargo-issue88862-log-L988">https://gist.github.com/Emilgardis/954c2aeefc0cca270a421a90ecc5067a#file-output-cargo-issue88862-log-L988</a> </p>
<p>seems it actually does build, just takes much longer time. Do we have some more modules I could enable debug on to see if they are the cause?</p>



<a name="252993883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/252993883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Emil Gardström <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#252993883">(Sep 12 2021 at 15:29)</a>:</h4>
<p>tried on linux now, limited to 2GB, the build fails with a sigkill on nightly &gt; 2021-08-26, but is successful on 2021-08-25. Trying to hook into rustc to debug a bit more.</p>



<a name="253011737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/cargo%20build%20hangs%2C%20how%20to%20minimize/near/253011737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Emil Gardström <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize.html#253011737">(Sep 12 2021 at 21:01)</a>:</h4>
<p>debugging rustc proved way to hard, instead I managed to minimize more and posted a gist in the issue</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>