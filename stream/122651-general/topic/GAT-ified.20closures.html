<html>
<head><meta charset="utf-8"><title>GAT-ified closures · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html">GAT-ified closures</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273693169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273693169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273693169">(Mar 01 2022 at 19:01)</a>:</h4>
<p>Is there an incantation that allows the concept of <code>FnMut(&amp;'a T) -&gt; K&lt;'a&gt;</code>, or does that require changing the <code>Fn*</code> traits?</p>



<a name="273694791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273694791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273694791">(Mar 01 2022 at 19:12)</a>:</h4>
<p>Wouldn't that be <code>for&lt;'a&gt; dyn FnMut(&amp;'a T) -&gt; K&lt;'a&gt;</code>?</p>



<a name="273695071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273695071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273695071">(Mar 01 2022 at 19:14)</a>:</h4>
<p>Sorry, my example wasn't fleshed out enough. I want <code>K</code> to be a generic type chosen by the caller. </p>
<p>The broader context is "what would it take to fix <a href="https://github.com/rust-lang/rust/issues/34162">slice::sort_by_key has more restrictions than slice::sort_by</a> in the contexts of GATs?". Super TL;DR:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span><span class="w"></span>
<span class="n">vec</span><span class="p">.</span><span class="n">sort_by_key</span><span class="p">(</span><span class="o">|</span><span class="n">k</span><span class="o">|</span><span class="w"> </span><span class="n">k</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="273695183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273695183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273695183">(Mar 01 2022 at 19:15)</a>:</h4>
<p>I think that will need a new trait.</p>



<a name="273695567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273695567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273695567">(Mar 01 2022 at 19:18)</a>:</h4>
<p>I <em>think</em> this thread goes into more details about this limitation: <a href="#narrow/stream/187312-wg-async/topic/async.20closures.3F/near/272461157">https://rust-lang.zulipchat.com/#narrow/stream/187312-wg-async/topic/async.20closures.3F/near/272461157</a></p>



<a name="273696831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273696831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273696831">(Mar 01 2022 at 19:27)</a>:</h4>
<p>Do you think I should add this on to <a href="https://github.com/rust-lang/generic-associated-types-initiative/issues/2">https://github.com/rust-lang/generic-associated-types-initiative/issues/2</a> ?</p>



<a name="273698340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273698340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273698340">(Mar 01 2022 at 19:38)</a>:</h4>
<p>I think these are slightly orthogonal issues? but I need to read that issue closer</p>



<a name="273702929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273702929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273702929">(Mar 01 2022 at 20:09)</a>:</h4>
<p>it's vaguely in the same realm: existing wide-spread trait could benefit from being GAT</p>



<a name="273703463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273703463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273703463">(Mar 01 2022 at 20:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/122651-general/topic/GAT-ified.20closures/near/273695071">said</a>:</p>
<blockquote>
<p>Sorry, my example wasn't fleshed out enough. I want <code>K</code> to be a generic type chosen by the caller. </p>
</blockquote>
<p>then you are asking for a HKT, which can be emulated with GATs, albeit quite cumbersomely:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">LifetimeGeneric</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">type</span> <span class="nc">T</span><span class="o">&lt;'</span><span class="na">lt</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and then</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">K</span><span class="w"> </span>: <span class="nc">LifetimeGeneric</span><span class="p">,</span><span class="w"></span>
<span class="n">F</span><span class="w"> </span>: <span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;'</span><span class="nb">_</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">K</span>::<span class="n">T</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>
<p>And the cumbersome part is that the caller needs to spell out a lot of stuff. <em>e.g.</em>, imagining <code>type K&lt;'_&gt; = &amp;'_ str;</code>, they'd have to write:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">LifetimeGeneric</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">str</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">T</span><span class="o">&lt;'</span><span class="na">lt</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">lt</span><span class="w"> </span><span class="kt">str</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>so that they can turbofish <code>&amp;str</code> for <code>K</code>. This, in a way, is hacky, since this <em>higher-order</em> type happens to take the same form as its image; the more proper way would be to use a separate type:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">StrRef</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">LifetimeGeneric</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">StrRef</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">T</span><span class="o">&lt;'</span><span class="na">lt</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">lt</span><span class="w"> </span><span class="kt">str</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="273703635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273703635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273703635">(Mar 01 2022 at 20:15)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> I know you like the pontificating — how would you fix "sort a slice by an item's key that contains a reference"?</p>



<a name="273704323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273704323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273704323">(Mar 01 2022 at 20:21)</a>:</h4>
<p>Something like: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=689f4ae92438d1892f94a9ee7d52ead0">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=689f4ae92438d1892f94a9ee7d52ead0</a></p>



<a name="273795595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273795595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273795595">(Mar 02 2022 at 11:59)</a>:</h4>
<p>Note that a similar "override generic parameter" kind of trick is featured in, for instance, <a href="https://doc.rust-lang.org/1.59.0/std/array/fn.try_from_fn.html"><code>core::array::try_from_fn()</code></a> notice that</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&lt;&lt;</span><span class="n">R</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Try</span><span class="o">&gt;</span>::<span class="n">Residual</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Residual</span><span class="o">&lt;</span><span class="p">[</span><span class="o">&lt;</span><span class="n">R</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Try</span><span class="o">&gt;</span>::<span class="n">Output</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">]</span><span class="o">&gt;&gt;</span>::<span class="n">TryType</span><span class="w"></span>
</code></pre></div>
<p>return type, which is basically a way to say:</p>
<ul>
<li><code>Result&lt;T&gt;</code> becomes <code>Result&lt;[T; N]&gt;</code></li>
<li><code>Option&lt;T&gt;</code> becomes <code>Option&lt;[T; N]&gt;</code></li>
</ul>
<p>That operation is thus kind of "replace <code>T</code> with <code>[T; N]</code>". You could then see the impl of the <code>LifetimeGeneric</code> helper trait for <code>&amp;'static str</code>. As a "<code>'static</code> can be replaced with any given lifetime", thus kind of expressing the <code>&amp;'_ str</code> type with a "placeholder lifetime".</p>



<a name="273795618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273795618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273795618">(Mar 02 2022 at 11:59)</a>:</h4>
<p>Maybe with some macros we can hide the pope under the rug <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="273796341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/GAT-ified%20closures/near/273796341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/GAT-ified.20closures.html#273796341">(Mar 02 2022 at 12:05)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[hkt]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">sort_by_key</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="w"> </span>: <span class="nc">hkt</span>::<span class="n">Generic</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">this</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="n">T</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="k">mut</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">K</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span>: <span class="nb">Ord</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">H</span><span class="w"> </span>: <span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;'</span><span class="nb">_</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">K</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">this</span><span class="p">.</span><span class="n">sort_by</span><span class="p">(</span><span class="o">|</span><span class="n">a</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">_</span> <span class="nc">T</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">_</span> <span class="nc">T</span><span class="o">|</span><span class="w"> </span><span class="o">&lt;</span><span class="n">K</span>::<span class="n">T</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;&gt;</span>::<span class="n">cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">)));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">define_hkt</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Str</span><span class="o">&lt;'</span><span class="na">lt</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">lt</span><span class="w"> </span><span class="kt">str</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">sort_by_key</span>::<span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">Str</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="cm">/* … */</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>