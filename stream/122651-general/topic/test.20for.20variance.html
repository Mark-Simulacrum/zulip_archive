<html>
<head><meta charset="utf-8"><title>test for variance · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html">test for variance</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275874584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275874584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ali MJ Al-Nasrawy <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275874584">(Mar 18 2022 at 23:27)</a>:</h4>
<p>Is there an easy way to test for the variance of a struct over one of its type or lifetime params?</p>



<a name="275880814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275880814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275880814">(Mar 19 2022 at 01:17)</a>:</h4>
<p>You could do something like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">marker</span>::<span class="n">PhantomData</span><span class="p">;</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Invariant</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="k">fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="p">())</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="p">()</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Covariant</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="k">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="p">()</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Contravariant</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="k">fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="p">())</span><span class="o">&gt;</span><span class="p">);</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">f</span><span class="o">&lt;'</span><span class="na">short</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// invariant</span>
<span class="w">    </span><span class="c1">// let _: Invariant&lt;'short&gt; = Invariant::&lt;'static&gt;(PhantomData);</span>
<span class="w">    </span><span class="c1">// let _: Invariant&lt;'static&gt; = Invariant::&lt;'short&gt;(PhantomData);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Invariant</span><span class="o">&lt;'</span><span class="na">short</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Invariant</span>::<span class="o">&lt;'</span><span class="na">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Invariant</span><span class="o">&lt;'</span><span class="nb">static</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Invariant</span>::<span class="o">&lt;'</span><span class="nb">static</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// covariant</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Covariant</span><span class="o">&lt;'</span><span class="na">short</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Covariant</span>::<span class="o">&lt;'</span><span class="nb">static</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// let _: Covariant&lt;'static&gt; = Covariant::&lt;'short&gt;(PhantomData);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Covariant</span><span class="o">&lt;'</span><span class="na">short</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Covariant</span>::<span class="o">&lt;'</span><span class="na">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Covariant</span><span class="o">&lt;'</span><span class="nb">static</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Covariant</span>::<span class="o">&lt;'</span><span class="nb">static</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// contravariant</span>
<span class="w">    </span><span class="c1">// let _: Contravariant&lt;'short&gt; = Contravariant::&lt;'static&gt;(PhantomData);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Contravariant</span><span class="o">&lt;'</span><span class="nb">static</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Contravariant</span>::<span class="o">&lt;'</span><span class="na">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Contravariant</span><span class="o">&lt;'</span><span class="na">short</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Contravariant</span>::<span class="o">&lt;'</span><span class="na">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Contravariant</span><span class="o">&lt;'</span><span class="nb">static</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Contravariant</span>::<span class="o">&lt;'</span><span class="nb">static</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PhantomData</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And change the type inside phantomdata to something else</p>



<a name="275881061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275881061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275881061">(Mar 19 2022 at 01:23)</a>:</h4>
<p>the invariant tests dont really test anything since those would work no matter what</p>



<a name="275883307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275883307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275883307">(Mar 19 2022 at 02:13)</a>:</h4>
<p>yeah</p>



<a name="275883321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275883321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275883321">(Mar 19 2022 at 02:14)</a>:</h4>
<p>perhaps something like an ui test that passes when compilation fails would work</p>



<a name="275883372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275883372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275883372">(Mar 19 2022 at 02:14)</a>:</h4>
<p>but that wouldn't be easy without using libraries</p>



<a name="275902117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275902117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ali MJ Al-Nasrawy <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275902117">(Mar 19 2022 at 10:09)</a>:</h4>
<p>Thanks! I also got some response on <a href="https://discord.com/channels/273534239310479360/274215136414400513/954528374263517275">discord</a>.</p>
<p>but both can't test for invariance. I'm curious if it is even possible?</p>



<a name="275902191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275902191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275902191">(Mar 19 2022 at 10:10)</a>:</h4>
<p>Would a compile fail test for the coercions that should fail work?</p>



<a name="275902487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275902487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ali MJ Al-Nasrawy <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275902487">(Mar 19 2022 at 10:18)</a>:</h4>
<p>I'm looking into somethting doable with libtest.</p>



<a name="275902576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275902576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275902576">(Mar 19 2022 at 10:20)</a>:</h4>
<p>Libtest is not meant for testing if something compiles or not. Rustc uses compiletest for that. Compiletest internally uses libtest for the test harness, but it also contains all code to invoke rustc and run resulting programs if applicable.</p>



<a name="275902710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275902710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ali MJ Al-Nasrawy <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275902710">(Mar 19 2022 at 10:24)</a>:</h4>
<p>Good to know! so, is compiletest is accessible outside rustc?</p>



<a name="275902815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275902815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ali MJ Al-Nasrawy <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275902815">(Mar 19 2022 at 10:27)</a>:</h4>
<p>Nevermind, I think should do it <a href="https://docs.rs/crate/compiletest_rs/0.2.4">https://docs.rs/crate/compiletest_rs/0.2.4</a></p>



<a name="275915542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/test%20for%20variance/near/275915542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/test.20for.20variance.html#275915542">(Mar 19 2022 at 15:30)</a>:</h4>
<p>You can also do it in a doctest marked <code>compile_fail</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>