<html>
<head><meta charset="utf-8"><title>FP atomics · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html">FP atomics</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252190635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252190635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252190635">(Sep 06 2021 at 15:21)</a>:</h4>
<p>Do we have floating point atomics somewhere ?</p>



<a name="252192716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252192716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252192716">(Sep 06 2021 at 15:39)</a>:</h4>
<p>No, but you can use <code>to_bits</code>/<code>from_bits</code> to losslessly convert it to an integer.</p>



<a name="252193166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252193166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252193166">(Sep 06 2021 at 15:43)</a>:</h4>
<p>That won't work for rmw operations like <code>fetch_add</code>, etc.</p>



<a name="252195342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252195342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252195342">(Sep 06 2021 at 16:03)</a>:</h4>
<p>you can always use the CAS loop (i.e. <a href="https://doc.rust-lang.org/core/sync/atomic/struct.AtomicU64.html#method.fetch_update"><code>fetch_update()</code></a>)</p>



<a name="252195624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252195624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252195624">(Sep 06 2021 at 16:07)</a>:</h4>
<p>there is also an <a href="https://docs.rs/atomic_float/0.1.0/atomic_float/"><code>atomic_float</code></a> package. (its <code>fetch_add</code> is implemented using <code>fetch_update</code>)</p>



<a name="252201212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252201212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252201212">(Sep 06 2021 at 17:04)</a>:</h4>
<p>that sounds horrible</p>



<a name="252201276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252201276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252201276">(Sep 06 2021 at 17:04)</a>:</h4>
<p>at least on hardware with floating point atomics support</p>



<a name="252202007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252202007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252202007">(Sep 06 2021 at 17:10)</a>:</h4>
<p>what ISA has atomic floating point instructions <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="252202271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252202271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252202271">(Sep 06 2021 at 17:13)</a>:</h4>
<p>There is no hardware that I know of with FP atomic support.</p>



<a name="252202461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252202461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252202461">(Sep 06 2021 at 17:15)</a>:</h4>
<p>all gpus in existence ?</p>



<a name="252202498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252202498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252202498">(Sep 06 2021 at 17:15)</a>:</h4>
<p>e.g. amdgpu has floating point atomics</p>



<a name="252202518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252202518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252202518">(Sep 06 2021 at 17:15)</a>:</h4>
<p>and have had this for as long as I can remember</p>



<a name="252202678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252202678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252202678">(Sep 06 2021 at 17:16)</a>:</h4>
<p>those targets can provide their own <code>core::arch</code> intrinsics. the wrapper types can then opt to use by <code>#[cfg]</code></p>



<a name="252202826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252202826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252202826">(Sep 06 2021 at 17:18)</a>:</h4>
<p>ah so the <code>AtomicF32</code> and <code>AtomicF64</code> are just not implemented yet for those targets, but it is ok to just add them ?</p>



<a name="252202834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252202834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252202834">(Sep 06 2021 at 17:18)</a>:</h4>
<p>I think you could do something like that using <code>asm!</code> as an addition to <code>atomic_float</code> package, if you can detect the configuration using <code>#[cfg]</code></p>



<a name="252202872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252202872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252202872">(Sep 06 2021 at 17:18)</a>:</h4>
<p>I'm not sure <code>asm!</code> is right for this, since you probably want to generate LLVM-IR to avoid blocking optimizations</p>



<a name="252202899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252202899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252202899">(Sep 06 2021 at 17:19)</a>:</h4>
<p>you could, if it's available, but that requires LLVM support</p>



<a name="252202949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252202949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252202949">(Sep 06 2021 at 17:19)</a>:</h4>
<p>yes llvm has supported these since forever</p>



<a name="252203946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252203946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252203946">(Sep 06 2021 at 17:28)</a>:</h4>
<p><a href="https://llvm.org/docs/LangRef.html#atomicrmw-instruction">https://llvm.org/docs/LangRef.html#atomicrmw-instruction</a></p>



<a name="252203978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252203978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252203978">(Sep 06 2021 at 17:29)</a>:</h4>
<p>Apparently atomic <code>fadd</code>/<code>fsub</code> is a thing, huh.</p>



<a name="252204244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252204244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252204244">(Sep 06 2021 at 17:31)</a>:</h4>
<p>I think it would be reasonable to add <code>AtomicF32</code>/<code>AtomicF64</code> types since it is natively supported in at least some hardware and we can always lower it to a cmpxchg loop otherwise.</p>



<a name="252206366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252206366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252206366">(Sep 06 2021 at 17:55)</a>:</h4>
<p>I'd rather only have these on platforms on which they make sense</p>



<a name="252206531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252206531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252206531">(Sep 06 2021 at 17:57)</a>:</h4>
<p>When using the atomics, getting a CAS loop generated isn't something I'd expect</p>



<a name="252206726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252206726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252206726">(Sep 06 2021 at 17:59)</a>:</h4>
<p>It changes the progress condition</p>



<a name="252206763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252206763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252206763">(Sep 06 2021 at 17:59)</a>:</h4>
<p>e.g. a "malevolent" scheduler can schedule all threads in a CAS loop such that the program deadlocks</p>



<a name="252206842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252206842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252206842">(Sep 06 2021 at 18:00)</a>:</h4>
<p>The whole point of the types is to allow portable code. If you want types that only exist on some architectures, they should exist elsewhere, like in <code>core::arch</code></p>



<a name="252206899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252206899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252206899">(Sep 06 2021 at 18:00)</a>:</h4>
<p>These types are already not portable, and only usable in archs that support them</p>



<a name="252206921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252206921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252206921">(Sep 06 2021 at 18:01)</a>:</h4>
<p>In particular, I don't think that the atomics make any wait freedom guarantees, specifically to allow CAS loop implementations</p>



<a name="252206948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252206948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252206948">(Sep 06 2021 at 18:01)</a>:</h4>
<p>We don't use locks and guarantee so much</p>



<a name="252206958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252206958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252206958">(Sep 06 2021 at 18:01)</a>:</h4>
<p>as opposed to, e.g., C++ atomics that can use locks internally</p>



<a name="252207052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207052">(Sep 06 2021 at 18:02)</a>:</h4>
<p>From the doc (emphasis mine):</p>
<blockquote>
<p>All atomic types in this module are guaranteed to be lock-free <em>if they’re available</em>.... Atomic types and operations are not guaranteed to be wait-free.</p>
</blockquote>



<a name="252207085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207085">(Sep 06 2021 at 18:02)</a>:</h4>
<blockquote>
<p>All atomic types in this module are guaranteed to be [lock-free] if they're<br>
available. This means they don't internally acquire a global mutex. Atomic<br>
types and operations are not guaranteed to be wait-free. This means that<br>
operations like <code>fetch_or</code> may be implemented with a compare-and-swap loop.</p>
<p>Atomic operations may be implemented at the instruction layer with<br>
larger-size atomics. For example some platforms use 4-byte atomic<br>
instructions to implement <code>AtomicI8</code>. Note that this emulation should not<br>
have an impact on correctness of code, it's just something to be aware of.</p>
<p>The atomic types in this module may not be available on all platforms. The<br>
atomic types here are all widely available, however, and can generally be<br>
relied upon existing. Some notable exceptions are:</p>
<ul>
<li>PowerPC and MIPS platforms with 32-bit pointers do not have <code>AtomicU64</code> or<br>
<code>AtomicI64</code> types.</li>
<li>ARM platforms like <code>armv5te</code> that aren't for Linux only provide <code>load</code><br>
  and <code>store</code> operations, and do not support Compare and Swap (CAS)<br>
  operations, such as <code>swap</code>, <code>fetch_add</code>, etc. Additionally on Linux,<br>
  these CAS operations are implemented via [operating system support], which<br>
  may come with a performance penalty.</li>
<li>ARM targets with <code>thumbv6m</code> only provide <code>load</code> and <code>store</code> operations,<br>
  and do not support Compare and Swap (CAS) operations, such as <code>swap</code>,<br>
<code>fetch_add</code>, etc.</li>
</ul>
<p>[operating system support]: <a href="https://www.kernel.org/doc/Documentation/arm/kernel_user_helpers.txt">https://www.kernel.org/doc/Documentation/arm/kernel_user_helpers.txt</a></p>
<p>Note that future platforms may be added that also do not have support for<br>
some atomic operations. Maximally portable code will want to be careful<br>
about which atomic types are used. <code>AtomicUsize</code> and <code>AtomicIsize</code> are<br>
generally the most portable, but even then they're not available everywhere.<br>
For reference, the <code>std</code> library requires pointer-sized atomics, although<br>
<code>core</code> does not.</p>
</blockquote>



<a name="252207112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207112">(Sep 06 2021 at 18:02)</a>:</h4>
<p>The docs already say that some operations may use a CAS loop.</p>



<a name="252207132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207132">(Sep 06 2021 at 18:03)</a>:</h4>
<p>And that they might not be available on all platforms.</p>



<a name="252207149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207149">(Sep 06 2021 at 18:03)</a>:</h4>
<p>Indeed, then nvm, these atomic types are useless to me. I need wait-free atomics.</p>



<a name="252207235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207235">(Sep 06 2021 at 18:04)</a>:</h4>
<p>The doc promise seems very reasonable to me: if you aren't getting wait-free atomics, then it is impossible to do so because the hardware doesn't support it</p>



<a name="252207259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207259">(Sep 06 2021 at 18:04)</a>:</h4>
<p>I'd rather use a lock, and design my algorithm differently, than a CAS loop.</p>



<a name="252207298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207298">(Sep 06 2021 at 18:05)</a>:</h4>
<p>So the atomics I need, need to fail to compile if there is no wait-free implementation.</p>



<a name="252207351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207351">(Sep 06 2021 at 18:05)</a>:</h4>
<p>I wonder if std could support that with a cfg flag.</p>



<a name="252207447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207447">(Sep 06 2021 at 18:06)</a>:</h4>
<p>I think having atomics that are not wait free, and or use locks internally, are abstractions that make sense.</p>



<a name="252207474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207474">(Sep 06 2021 at 18:07)</a>:</h4>
<p>Yes, but probably not in std.</p>



<a name="252207476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207476">(Sep 06 2021 at 18:07)</a>:</h4>
<p>You can build such abstractions on top of wait-free atomic memory ops, but you can't build wait-free atomic memory ops on top of such abstractions.</p>



<a name="252207594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207594">(Sep 06 2021 at 18:08)</a>:</h4>
<blockquote>
<p>Yes, but probably not in std.</p>
</blockquote>
<p>Maybe? It wouldn't be necessary, but it is a common enough thing to want.</p>



<a name="252207624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207624">(Sep 06 2021 at 18:08)</a>:</h4>
<p>I guess the "not in std" argument can be made about <code>AtomicI32</code> as well....</p>



<a name="252207642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207642">(Sep 06 2021 at 18:09)</a>:</h4>
<p>You can implement <code>AtomicI32</code> as a library if you had atomic memory operations...</p>



<a name="252207651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207651">(Sep 06 2021 at 18:09)</a>:</h4>
<p>but the other way around is not true...</p>



<a name="252207805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207805">(Sep 06 2021 at 18:11)</a>:</h4>
<p>Well, the current atomic types appeal to the majority of use cases.</p>



<a name="252207838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207838">(Sep 06 2021 at 18:11)</a>:</h4>
<p>And actually provide stronger guarantees than C++.</p>



<a name="252207859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252207859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252207859">(Sep 06 2021 at 18:11)</a>:</h4>
<p>Guaranteed wait-free atomics is a much less common requirement.</p>



<a name="252208269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252208269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252208269">(Sep 06 2021 at 18:16)</a>:</h4>
<blockquote>
<p>Well, the current atomic types appeal to the majority of use cases.</p>
</blockquote>
<p>Is there a poll of all programmers in the world about this somewhere? Most programers never use atomics, and most code using atomics that I see in the wild still uses <code>volatile</code> over atomics...</p>



<a name="252208319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252208319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252208319">(Sep 06 2021 at 18:16)</a>:</h4>
<blockquote>
<p>And actually provide stronger guarantees than C++.</p>
</blockquote>
<p>C++ <code>atomic_ref</code> provides more guarantees that Rust atomic types, is more flexible since it exposes memory operations, etc.</p>



<a name="252209126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252209126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252209126">(Sep 06 2021 at 18:25)</a>:</h4>
<blockquote>
<p>Is there a poll of all programmers in the world about this somewhere? </p>
</blockquote>
<p>Sorry, should have added a "probably" there.</p>



<a name="252209815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252209815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252209815">(Sep 06 2021 at 18:32)</a>:</h4>
<p>I recently learned that even <code>Atomic*::load</code> may be lowered to a CAS by llvm, I was very much surprised by that.</p>



<a name="252210931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252210931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252210931">(Sep 06 2021 at 18:44)</a>:</h4>
<p>It can be loaded to CAS, but not to a CAS loop</p>



<a name="252212369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252212369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kennytm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252212369">(Sep 06 2021 at 19:01)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="n">atomic</span>::<span class="p">{</span><span class="n">AtomicU64</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span><span class="p">};</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">atomic_min</span><span class="p">(</span><span class="n">a</span>: <span class="kp">&amp;</span><span class="nc">AtomicU64</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">fetch_min</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Relaxed</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>is compiled to <code>atomicrmw umin</code> in LLVM</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span> <span class="kt">i64</span> <span class="vg">@_ZN10playground10atomic_min17h4230d9a8926eda10E</span><span class="p">(</span><span class="nv">%"std::sync::atomic::AtomicU64"</span><span class="p">*</span> <span class="k">nocapture</span> <span class="k">align</span> <span class="m">8</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">8</span><span class="p">)</span> <span class="nv">%a</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%b</span><span class="p">)</span> <span class="k">unnamed_addr</span> <span class="vg">#0</span> <span class="p">{</span>
<span class="nl">start:</span>
  <span class="nv">%_5.i</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="nv">%"std::sync::atomic::AtomicU64"</span><span class="p">,</span> <span class="nv">%"std::sync::atomic::AtomicU64"</span><span class="p">*</span> <span class="nv">%a</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i64</span> <span class="m">0</span>
  <span class="nv nv-Anonymous">%0</span> <span class="p">=</span> <span class="k">atomicrmw</span> <span class="k">umin</span> <span class="kt">i64</span><span class="p">*</span> <span class="nv">%_5.i</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv">%b</span> <span class="k">monotonic</span>
  <span class="k">ret</span> <span class="kt">i64</span> <span class="nv nv-Anonymous">%0</span>
<span class="p">}</span>
</code></pre></div>
<p>which is compiled to a loop in x86_64.</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nl">playground:</span><span class="err">:</span><span class="nl">atomic_min:</span>
    <span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rdi</span><span class="p">]</span>

<span class="nl">.LBB0_1:</span>
    <span class="nf">cmp</span> <span class="no">rax</span><span class="p">,</span> <span class="no">rsi</span>
    <span class="nf">mov</span> <span class="no">rcx</span><span class="p">,</span> <span class="no">rsi</span>
    <span class="nf">cmovbe</span>  <span class="no">rcx</span><span class="p">,</span> <span class="no">rax</span>
    <span class="na">lock</span>        <span class="nf">cmpxchg</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rdi</span><span class="p">],</span> <span class="no">rcx</span>
    <span class="nf">jne</span> <span class="no">.LBB0_1</span>
    <span class="nf">ret</span>
</code></pre></div>



<a name="252212810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252212810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252212810">(Sep 06 2021 at 19:06)</a>:</h4>
<p>rmw obviosuly have to be lowered to CAS loop if they are not natively supported, but <span class="user-mention silent" data-user-id="330154">The 8472</span> is talking about load.</p>



<a name="252228103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252228103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252228103">(Sep 06 2021 at 22:16)</a>:</h4>
<p>AtomicU128 on AArch64 uses a loop for load: <a href="https://rust.godbolt.org/z/hWz5hWdbE">https://rust.godbolt.org/z/hWz5hWdbE</a></p>



<a name="252228332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252228332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252228332">(Sep 06 2021 at 22:20)</a>:</h4>
<p>Does this mean ldxp performs two atomic 64-bit reads instead of an atomic 128 bit read, so stxp is used to confirm that indeed nothing happens in between these two reads?</p>



<a name="252228845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252228845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252228845">(Sep 06 2021 at 22:29)</a>:</h4>
<p>Yes, essentially.</p>



<a name="252228873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252228873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252228873">(Sep 06 2021 at 22:29)</a>:</h4>
<p>Though on ARMv8.4 (not sure about the exact version) this is no longer needed and <code>ldp</code> (load pair) is guaranteed to be atomic.</p>



<a name="252261111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252261111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252261111">(Sep 07 2021 at 07:11)</a>:</h4>
<p>Right, but that's because AArch64 &lt; v8.4 (1) does not support 128-bit atomics properly, and (2) we work around it using something that can be super expensive and implicitly changes the progress guarantees of user programs when going from, e.g., x64 to aarch64 &lt; 8.4...</p>



<a name="252261299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252261299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252261299">(Sep 07 2021 at 07:13)</a>:</h4>
<p>If your algorithm requires wait-free atomics for correctness, and you test it on x64 and don't realize this, then on aarch64 your algorithm might "break" (probably not in a way that it introduces UB, but in a way that makes it useless for what it aimed to do).</p>



<a name="252261574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252261574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252261574">(Sep 07 2021 at 07:16)</a>:</h4>
<p>Most people don't reason about the progress guarantees of their algos, but rather just test them properly on the hardware they have available and hope for the best.</p>



<a name="252268280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252268280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252268280">(Sep 07 2021 at 08:20)</a>:</h4>
<p>AFAIK there is no algorithm that actually requires wait-free atomics for correctness. Lock-free is enough in all cases.</p>



<a name="252447348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/FP%20atomics/near/252447348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/FP.20atomics.html#252447348">(Sep 08 2021 at 12:00)</a>:</h4>
<p>right, <span class="user-mention" data-user-id="125254">@kennytm</span>  when doing a load, on some hardware you can emit both an atomic load instruction, but also a <code>old = CAS(val, val)</code> (a CAS that does not modify the source). </p>
<p>LLVM can generate CAS instead of load in some cases to improve, e.g., stack frame alignment, etc.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>