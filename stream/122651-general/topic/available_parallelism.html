<html>
<head><meta charset="utf-8"><title>available_parallelism Â· general Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html">available_parallelism</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273723791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273723791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273723791">(Mar 01 2022 at 22:53)</a>:</h4>
<p><a href="https://doc.rust-lang.org/stable/std/thread/fn.available_parallelism.html">These</a> docs and the API seem like they could be improved. I can't find other sources that refer to "parallelism" as a system resource in this way.</p>
<p>I also find it to be a grammatical issue because the returned NonZeroUsize represents individual items, not a collective quantity. It feels like a store saying "10 items or less" instead of "10 items or fewer"; the error, however common, makes the tone is a bit less professional. In explaining what this is, it even calls parallelism "a bound on the number of computations it can perform simultaneously", as opposed to "the amount of computation". You wouldn't ask someone "how much apple basket do you have?" You would ask, "how many apples are in your basket?" If the basket is parallelism, then the apples are threads, I suppose.</p>
<p>If the idea is to use this to spawn a reasonably optimal number of threads, can is be called <code>suggested_thread_count</code>? How the number is determined might depend on the system but in our Rust code a thread is a thread. We're talking about Rust's <code>std::thread</code> threads, not whatever number of cores (or other determining factors) might be on the system. That might forego the need to use the term "parallelism" at all, since it would just refer to Rust threads.</p>
<p>It's a good feature, though. It's nice to know there's an easy way to get a this value.</p>
<p>Also, is there a better place to bring this up? I probably should have asked that before I typed all of this.</p>



<a name="273724878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273724878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt ðŸ‡ºðŸ‡¦ <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273724878">(Mar 01 2022 at 23:00)</a>:</h4>
<p>The method is already stable, so the name can't be changed. Documentation can be improved if you think it needs it, though.</p>



<a name="273728340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273728340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273728340">(Mar 01 2022 at 23:32)</a>:</h4>
<blockquote>
<p>Also, is there a better place to bring this up? I probably should have asked that before I typed all of this.</p>
</blockquote>
<p>#t-libs</p>



<a name="273728506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273728506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273728506">(Mar 01 2022 at 23:34)</a>:</h4>
<p>Also, suggested_thread_count isn't much better since some thread pools don't want/need as many threads as you have hardware threads. E.g. IO pools.</p>



<a name="273728717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273728717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273728717">(Mar 01 2022 at 23:36)</a>:</h4>
<p>Is an alias out of the question? If I were looking for this feature, I do not think I could find it by its current name. I get that the grammar is not a priority.</p>



<a name="273728880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273728880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273728880">(Mar 01 2022 at 23:38)</a>:</h4>
<p>Only if there's a well-established name that someone might look for. Otherwise we would have to alias any of the other bike-shedded names (there were several).</p>



<a name="273729015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273729015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273729015">(Mar 01 2022 at 23:38)</a>:</h4>
<p><a href="https://std-dev-guide.rust-lang.org/documentation/doc-alias-policy.html">https://std-dev-guide.rust-lang.org/documentation/doc-alias-policy.html</a></p>



<a name="273729106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273729106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273729106">(Mar 01 2022 at 23:39)</a>:</h4>
<p>Even <code>available_threads</code> would be better, just to give an idea of what that number represents and reflect how I would personally think to search for it. I think others would find that more easily too, but that's an assumption.</p>



<a name="273729405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273729405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273729405">(Mar 01 2022 at 23:42)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/74480">https://github.com/rust-lang/rust/pull/74480</a> see the original PR proposing some names and then moving to <code>available_concurrency</code>, which was later changed to <code>available_parallelism</code> in another PR</p>



<a name="273729455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273729455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273729455">(Mar 01 2022 at 23:42)</a>:</h4>
<p><span aria-label="bike" class="emoji emoji-1f6b2" role="img" title="bike">:bike:</span> <span aria-label="derelict house" class="emoji emoji-1f3da" role="img" title="derelict house">:derelict_house:</span> <span aria-label="art" class="emoji emoji-1f3a8" role="img" title="art">:art:</span></p>



<a name="273730440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273730440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273730440">(Mar 01 2022 at 23:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="479357">Jeff</span> <a href="#narrow/stream/122651-general/topic/available_parallelism/near/273729106">said</a>:</p>
<blockquote>
<p>Even <code>available_threads</code> would be better, just to give an idea of what that number represents and reflect how I would personally think to search for it. I think others would find that more easily too, but that's an assumption.</p>
</blockquote>
<p>I do think such a name would work in many cases, but we got feedback that some systems might have concepts of parallelism that aren't based on hardware cores/threads. In particular, that name wouldn't convey that it also takes things like affinity and cgroups into account, as well as some kinds of virtual/sandbox systems.</p>



<a name="273732673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273732673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273732673">(Mar 02 2022 at 00:14)</a>:</h4>
<p>This is interesting. The discussion of this change may not have been as productive as it could have been. Interestingly, the specific action that was interpreted as "a demonstration of power, not equality" and led to the complaint made in <a href="https://github.com/rust-lang/rust/issues/74479#issuecomment-933345728">this comment</a> was made by <span class="user-mention" data-user-id="245610">@Jacob Pratt ðŸ‡ºðŸ‡¦</span> in this thread. I immediately knew that I was being waved off with the words "if you think it needs it", given how specific I was about what I think it needs. I hope we can continue to engage productively here despite this early hiccup.</p>
<p>In that thread, I see an explanation for <code>available_concurrency</code> but not an explanation for the change (but I'm getting sleepy at this point so it could be there). The term "concurrency" coming from C++ makes sense, and the C++ docs have a nice definition, </p>
<div class="codehilite"><pre><span></span><code>Returns the number of concurrent threads supported by the implementation. The value should be considered only a hint.
</code></pre></div>
<p>Compare that to </p>
<div class="codehilite"><pre><span></span><code>Returns an estimate of the default amount of parallelism a program should use.
</code></pre></div>
<p>The C++ docs provide a clear, non-circular, definition.</p>



<a name="273733220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273733220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273733220">(Mar 02 2022 at 00:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="479357">Jeff</span> <a href="#narrow/stream/122651-general/topic/available_parallelism/near/273732673">said</a>:</p>
<blockquote>
<p>In that thread, I see an explanation for <code>available_concurrency</code> but not an explanation for the change (but I'm getting sleepy at this point so it could be there). The term "concurrency" coming from C++ makes sense, and the C++ docs have a nice definition, </p>
<div class="codehilite"><pre><span></span><code>Returns the number of concurrent threads supported by the implementation. The value should be considered only a hint.
</code></pre></div>
<p>Compare that to </p>
<div class="codehilite"><pre><span></span><code>Returns an estimate of the default amount of parallelism a program should use.
</code></pre></div>
<p>The C++ docs provide a clear, non-circular, definition.</p>
</blockquote>
<p>Concurrency is not the same as parallelism, however. It actually is precisely because it is trying to gauge a system resource like threads that it says parallelism, because concurrency can be achieved via asynchronous multitasking. Instead, This function is instead intended to answer "okay how many tasks can I actually simultaneously start and execute over the same overlapping time, without any threads needing to idle?"</p>



<a name="273733411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273733411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273733411">(Mar 02 2022 at 00:22)</a>:</h4>
<p>It avoids saying "threads" because the intention was to offer an answer without having to address a deeper philosophical question:<br>
"What IS a thread, anyways?"</p>



<a name="273733543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273733543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273733543">(Mar 02 2022 at 00:23)</a>:</h4>
<div class="codehilite"><pre><span></span><code>we got feedback that some systems might have concepts of parallelism that aren&#39;t based on hardware cores/threads. In particular, that name wouldn&#39;t convey that it also takes things like affinity and cgroups into account
</code></pre></div>
<p>In the case of <code>suggested_thread_count</code> or <code>available_threads</code> I imagined "thread" referring strictly to <a href="https://doc.rust-lang.org/std/thread/struct.Thread.html"><code>Thread</code></a>, not anything outside of the standard library's own vocabulary. That would have to made clear, and that might suggest it's not as intuitive as I thought. But at least it would make it clear what we're supposed to do with that value.</p>



<a name="273733791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273733791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273733791">(Mar 02 2022 at 00:25)</a>:</h4>
<p>It is completely fair to say "clearly, it means <code>std::thread::Thread</code>" but that is in fact also circularly defined:</p>
<blockquote>
<p>An executing Rust program consists of a collection of native OS threads, each with their own stack and local state. Threads can be named, and provide some built-in support for low-level synchronization.</p>
</blockquote>



<a name="273733912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273733912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273733912">(Mar 02 2022 at 00:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/122651-general/topic/available_parallelism/near/273733791">said</a>:</p>
<blockquote>
<p>It is completely fair to say "clearly, it means <code>std::thread::Thread</code>" but that is in fact also circularly defined:</p>
<blockquote>
<p>An executing Rust program consists of a collection of native OS threads, each with their own stack and local state. Threads can be named, and provide some built-in support for low-level synchronization.</p>
</blockquote>
</blockquote>
<p>I don't think that's quite circular, it's just named after the thing it controls, like the <code>File</code> type.</p>



<a name="273734267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273734267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273734267">(Mar 02 2022 at 00:30)</a>:</h4>
<p>Hmm, that's fair, but a File is comprehensible as a blob of bytes <strong>somewhere</strong>. The notion of a "thread" is much more nebulous.</p>



<a name="273734411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273734411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273734411">(Mar 02 2022 at 00:32)</a>:</h4>
<p>People are lowering Rust to SPIRV and CUDA, and those get weird.</p>



<a name="273735165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273735165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273735165">(Mar 02 2022 at 00:40)</a>:</h4>
<p>Lotta people in the original conversation e.g. refer to individual cores as "CPUs", which is already a pretty telling sign that we're in a vague zone, because a single physical core can do SMT and thus execute multiple threads.</p>



<a name="273827854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273827854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt ðŸ‡ºðŸ‡¦ <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273827854">(Mar 02 2022 at 15:54)</a>:</h4>
<p><span class="user-mention" data-user-id="479357">@Jeff</span> My apologies; I did not intend to dismiss your concern in the slightest. My wording was solely to indicate that documentation doesn't get changed "just because", but rather because it needs an improvement. I haven't read the documentation for the method recently, which is why I said that. Documentation can almost always be improved, after all.</p>



<a name="273836950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273836950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jeff <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273836950">(Mar 02 2022 at 16:45)</a>:</h4>
<p>No problem, I will continue to try to improve my ability to document my own thoughts so that future discussions can be more substantial.</p>
<p>I still hope that a patient reading of my comments helps to explain why I find the documentation to be a circular definition, grammatically improvable and possibly why the function would be difficult to find (except maybe for C++ users who search for "available" or Rust people who search for "num_cpus"). I think the C++ docs for <code>available_concurrency</code> are perfect and while <span class="user-mention" data-user-id="281757">@Jubilee</span> makes a good point that "parallelism" is more correct, it seems like an unnecessary limitation to start with what the C++ library calls it and work backwards (though I can see how that came about, looking that the tracking issue).</p>
<p>From the <a href="https://std-dev-guide.rust-lang.org/documentation/doc-alias-policy.html">doc alias policy</a>:</p>
<blockquote>
<p>We must have a reasonable expectation that people might search for the term in the documentation search. Rust's documentation provides a name search, not a full-text search; as such, we expect that people may search for plausible names,</p>
</blockquote>
<p>...</p>
<blockquote>
<p>we don't expect that people are currently searching Rust documentation for language-specific names from arbitrary languages they're familiar with, and we don't want to add that as a new documentation search feature; please don't add aliases based on your favorite language. Those mappings should live in separate guides or references</p>
</blockquote>
<p>Hence the logic of keeping the name relevant to the standard library's own "vocabulary" or something unambiguous. Since being truly unambiguous is tough with regards to cpus, cores, virtual cores, etc. I see a use of <code>thread</code> (referring to the <code>Thread</code> type) as the most comprehensible option.</p>



<a name="273848440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273848440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273848440">(Mar 02 2022 at 17:51)</a>:</h4>
<p>One thought I have is that</p>
<blockquote>
<p>Returns the number of concurrent threads supported by the implementation. The value should be considered only a hint.</p>
</blockquote>
<p>and</p>
<blockquote>
<p>Returns an estimate of the default amount of parallelism a program should use.</p>
</blockquote>
<p>are just the first line. It is very desirable to read the actual documentation for this method to understand what it does, because it's actually pretty bad to just use it and then throw that number blindly into a threadpool spawner.</p>



<a name="273850358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273850358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273850358">(Mar 02 2022 at 18:01)</a>:</h4>
<p>My personal policy in documentation is that if the succinct documentation could be misleading, keep it vague and explain in full in the full documentation.</p>



<a name="273887433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/273887433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#273887433">(Mar 02 2022 at 22:28)</a>:</h4>
<p>Anyways, I do think any PRs to improve the documentation will be considered~</p>



<a name="274443781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/available_parallelism/near/274443781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/available_parallelism.html#274443781">(Mar 07 2022 at 19:20)</a>:</h4>
<blockquote>
<p>Returns the number of concurrent threads supported by the implementation.</p>
</blockquote>
<p>FWIW, my laptop "supports" thousands of concurrently running threads, even though it only has 8-way parallelism (4 cores and hyperthreading). So IMO <code>available_concurrency</code> is a misnomer.<br>
In other words, this function does <em>not</em> say how many (concurrent) <code>Thread</code>s you can actually have. It just says how many of them can run <em>in parallel</em>.</p>
<p>Concurrency and parallelism are technical terms (that are confused so often it's almost become a meme ;), and in this case "parallelism" is the more accurate one to use.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>