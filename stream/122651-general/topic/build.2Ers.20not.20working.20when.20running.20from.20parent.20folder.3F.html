<html>
<head><meta charset="utf-8"><title>build.rs not working when running from parent folder? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html">build.rs not working when running from parent folder?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254184975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254184975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> aodhneine [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254184975">(Sep 21 2021 at 10:28)</a>:</h4>
<p>I'm not sure if this the right place to ask this, but... I'm writing a small library for working with PDF files, and I need support for DEFLATE compression. I decided to write my own bindings for libdeflate: <a href="https://github.com/ebiggers/libdeflate">https://github.com/ebiggers/libdeflate</a>, and I put them in a <code>deflate-sys</code> crate, like so:</p>
<div class="codehilite"><pre><span></span><code>pdf-rs/
    src/
    Cargo.toml
    deflate-sys/
        ...
        build.rs
        third-party/libdeflate/
</code></pre></div>
<p>I keep libdeflate source code in the <code>third-party</code> folder, and expect it to be built and in that folder before running <code>cargo build</code>. Then, when running <code>cargo build</code> in the <code>deflate-sys</code> folder, everything works fine... but not when I try to build <code>pdf-rs</code>, when depending on <code>deflate-sys</code>. I instead get an error</p>
<div class="codehilite"><pre><span></span><code>error: could not find native static library `deflate`, perhaps an -L flag is missing?

error: could not compile `deflate-sys` due to previous error
warning: build failed, waiting for other jobs to finish...
error: build failed
</code></pre></div>
<p>This is how the <code>build.rs</code> file looks like in the <code>deflate-sys</code> folder</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"cargo:rustc-link-lib=static=deflate"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"cargo:rustc-link-search=./third-party/libdeflate"</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I'm not really sure what is going on?</p>



<a name="254185048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254185048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> aodhneine [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254185048">(Sep 21 2021 at 10:29)</a>:</h4>
<p>Just for the reference, these are the cargo and rustc versions I'm using</p>
<div class="codehilite"><pre><span></span><code>~/d/pdf-rs$ cargo --version
cargo 1.56.0-nightly (18751dd3f 2021-09-01)
~/d/pdf-rs$ rustc --version
rustc 1.57.0-nightly (97032a6df 2021-09-08)
</code></pre></div>



<a name="254185839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254185839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> aodhneine [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254185839">(Sep 21 2021 at 10:37)</a>:</h4>
<p>(Obviously, changing <code>rustc-link-search</code> to <code>./deflate-sys/third-party/libdeflate</code> works when compiling from <code>pdf-rs</code> folder. But that's not really useful, since then I can't test the <code>deflate-sys</code> library alone.)</p>



<a name="254193890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254193890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254193890">(Sep 21 2021 at 11:53)</a>:</h4>
<p>(deleted)</p>



<a name="254194559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254194559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254194559">(Sep 21 2021 at 11:59)</a>:</h4>
<ol>
<li>I think you should use an absolute path.</li>
<li>It is advised to build the library within <a href="http://build.rs">build.rs</a>. You need to build it in the location pointed to by the OUT_DIR env var. If you do it in the source directory cargo will refuse to upload it to <a href="http://crates.io">crates.io</a> if you want to do this.</li>
<li>There is already the flate2 crate you can use. It can use zlib or by default a pure-rust implementation.</li>
</ol>



<a name="254206391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254206391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> aodhneine [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254206391">(Sep 21 2021 at 13:27)</a>:</h4>
<blockquote>
<ol>
<li>I think you should use an absolute path.</li>
</ol>
</blockquote>
<p>I'm not really sure I understand what you mean, do you mean path like <code>/home/aodhnait/dev/pdf-rs/deflate-sys/third-party/libdeflate</code>? But then what if someone wanted to use it, they would have to change that path...</p>
<blockquote>
<ol start="2">
<li>It is advised to build the library within <a href="http://build.rs">build.rs</a>. You need to build it in the location pointed to by the OUT_DIR env var. If you do it in the source directory cargo will refuse to upload it to <a href="http://crates.io">crates.io</a> if you want to do this.</li>
</ol>
</blockquote>
<p>I wanted to avoid making the crate build process depend on the build system of libdeflate. I also wasn't really planning to publish it to <a href="http://crates.io">crates.io</a>, the idea being that if someone (on the very slim chance) wanted to use it, they would just clone it and adjust the path to it in their <code>Cargo.toml</code>.</p>
<blockquote>
<ol start="3">
<li>There is already the flate2 crate you can use. It can use zlib or by default a pure-rust implementation.</li>
</ol>
</blockquote>
<p>I don't want to use any dependencies, and libdeflate is much faster than zlib, that's why I wanted to write bindings to it (I also distrust turning my code into node_modules mess.)</p>



<a name="254206622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254206622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254206622">(Sep 21 2021 at 13:29)</a>:</h4>
<p>Published <code>libdeflate</code> bindings would be pretty nice though.</p>



<a name="254206643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254206643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254206643">(Sep 21 2021 at 13:29)</a>:</h4>
<ol>
<li>Yes. You can take the absolute path of the current working directory inside <a href="http://build.rs">build.rs</a> instead of hard-coding it.</li>
</ol>



<a name="254206779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254206779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> aodhneine [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254206779">(Sep 21 2021 at 13:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="203546">Laurențiu</span> <a href="#narrow/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F/near/254206622">said</a>:</p>
<blockquote>
<p>Published <code>libdeflate</code> bindings would be pretty nice though.</p>
</blockquote>
<p>There's already libdeflater which does that: <a href="https://github.com/adamkewley/libdeflater">https://github.com/adamkewley/libdeflater</a>.</p>



<a name="254206926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254206926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254206926">(Sep 21 2021 at 13:31)</a>:</h4>
<p>And there seems to be the libdeflate-sys crate with raw libdeflate bindings.</p>



<a name="254207144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254207144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254207144">(Sep 21 2021 at 13:32)</a>:</h4>
<p>And generally you don't have to interact much with the build system of the native library, see <a href="https://github.com/adamkewley/libdeflater/blob/master/libdeflate-sys/build.rs">https://github.com/adamkewley/libdeflater/blob/master/libdeflate-sys/build.rs</a>.</p>



<a name="254207224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254207224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> aodhneine [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254207224">(Sep 21 2021 at 13:33)</a>:</h4>
<blockquote>
<ol>
<li>Yes. You can take the absolute path of the current working directory inside <a href="http://build.rs">build.rs</a> instead of hard-coding it.</li>
</ol>
</blockquote>
<p>Does cargo expose any environmental variable for that?</p>



<a name="254207568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254207568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> aodhneine [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254207568">(Sep 21 2021 at 13:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="203546">Laurențiu</span> <a href="#narrow/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F/near/254207144">said</a>:</p>
<blockquote>
<p>And generally you don't have to interact much with the build system of the native library, see <a href="https://github.com/adamkewley/libdeflater/blob/master/libdeflate-sys/build.rs">https://github.com/adamkewley/libdeflater/blob/master/libdeflate-sys/build.rs</a>.</p>
</blockquote>
<p>That means that if libdeflate adds new source files, I have to update the <a href="http://build.rs">build.rs</a> script, which is what I wanted to avoid. I just want to expect that there is <code>libdeflate.a</code> in the <code>third-party/libdeflate</code> directory, regardless of where it came from, whether user built it themselves, copied it from somewhere, it's a symlink, whatever.</p>



<a name="254207936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254207936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254207936">(Sep 21 2021 at 13:38)</a>:</h4>
<p>Yeah, but your <code>-sys</code> crate would be building (or linking to) one specific version anyway. Of course, it's fine if you don't plan to publish it, but as a <code>-sys</code> crate user, I would very much prefer not having to manually build anything.</p>



<a name="254208099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254208099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> aodhneine [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254208099">(Sep 21 2021 at 13:39)</a>:</h4>
<blockquote>
<p>Does cargo expose any environmental variable for that?</p>
</blockquote>
<p>Found it! It's <code>CARGO_MANIFEST_DIR</code>, and using it in <code>build.rs</code> makes it work properly now, yay!</p>



<a name="254208450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254208450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> aodhneine [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254208450">(Sep 21 2021 at 13:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="203546">Laurențiu</span> <a href="#narrow/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F/near/254207936">said</a>:</p>
<blockquote>
<p>Yeah, but your <code>-sys</code> crate would be building (or linking to) one specific version anyway. Of course, it's fine if you don't plan to publish it, but as a <code>-sys</code> crate user, I would very much prefer not having to manually build anything.</p>
</blockquote>
<p>Yeah, understandable, I wasn't really planning on publishing it anyway... I have a very specific vision in mind, and can't really express it properly in words.</p>



<a name="254208681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254208681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> aodhneine [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254208681">(Sep 21 2021 at 13:43)</a>:</h4>
<p>Now my only question is why do I need to use <code>CARGO_MANIFEST_DIR</code> in the first place? Shouldn't relative path work just as fine, considering that (presumably) cargo just copies the entire crate? Then relative paths should still point to the same thing, shouldn't they?</p>



<a name="254209386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/build.rs%20not%20working%20when%20running%20from%20parent%20folder%3F/near/254209386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F.html#254209386">(Sep 21 2021 at 13:48)</a>:</h4>
<p>The path is relative to the current working directory of the rustc invocation that calls the linker as it cargo passes it verbatim to rustc and cargo doesn't resolve relative paths AFAIK. In this case the current working directory of the linking rustc is pdf-rs, so rustc will look in pdf-rs/third-party/libdeflate.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>