<html>
<head><meta charset="utf-8"><title>Invariant + Closure = GhostCell? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Invariant.20.2B.20Closure.20.3D.20GhostCell.3F.html">Invariant + Closure = GhostCell?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277552447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Invariant%20%2B%20Closure%20%3D%20GhostCell%3F/near/277552447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Invariant.20.2B.20Closure.20.3D.20GhostCell.3F.html#277552447">(Apr 02 2022 at 21:23)</a>:</h4>
<p>Heya! I've been in the weeds for a new data structure I'm making that uses the same "branding" idea from the GhostCell paper. It seems that the minimal implementation requires a <code>for&lt;'a&gt;</code> closure as well as an invariant reference. What's interesting to me is I "feel" like that invariant reference itself would be enough to use lifetimes for equality comparisons, I'm trying to wrap my head around what that's the case. The generic-lifetime closures seems to be a key here and I don't understand all of its properties. The only thing I can think of is something with the contravariance of closures? Is it because the closure is a "jail" that prevents values from leaving it?</p>



<a name="277599841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Invariant%20%2B%20Closure%20%3D%20GhostCell%3F/near/277599841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Invariant.20.2B.20Closure.20.3D.20GhostCell.3F.html#277599841">(Apr 03 2022 at 09:01)</a>:</h4>
<blockquote>
<p>I "feel" like that invariant reference itself would be enough to use lifetimes for equality comparisons</p>
</blockquote>
<p>It is enough for that, but you also want a way to produce lifetimes that can't be replicated, and this is generally not possible since they can be arbitrarily shortened before being "locked". Generic-lifetime closures (i.e. closures with <code>for&lt;'a&gt;</code> bounds, also called HRTB - Higher rank trait bounds) solve this by requiring the closure to be valid for any lifetime <code>'a</code>, and thus they can't assume that lifetime will be equal or longer than some other lifetime, thus effectively being "unique". AFAIK there's another way to solve this: by using macros that create short lived lifetimes that end before the user can even create other lifetimes, thus always being different.</p>



<a name="277658177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Invariant%20%2B%20Closure%20%3D%20GhostCell%3F/near/277658177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Invariant.20.2B.20Closure.20.3D.20GhostCell.3F.html#277658177">(Apr 03 2022 at 20:01)</a>:</h4>
<p>Oooh awesome. Thank you so much for this clarification, that makes a lot more sense!</p>



<a name="277763978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Invariant%20%2B%20Closure%20%3D%20GhostCell%3F/near/277763978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Invariant.20.2B.20Closure.20.3D.20GhostCell.3F.html#277763978">(Apr 04 2022 at 17:11)</a>:</h4>
<p>You can have an example of branding lifetimes implemented using a macro instead of a higher-order callback in <a href="https://crates.io/crates/generativity/1.0.0">https://crates.io/crates/generativity/1.0.0</a></p>



<a name="277783543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Invariant%20%2B%20Closure%20%3D%20GhostCell%3F/near/277783543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Invariant.20.2B.20Closure.20.3D.20GhostCell.3F.html#277783543">(Apr 04 2022 at 19:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/122651-general/topic/Invariant.20.2B.20Closure.20.3D.20GhostCell.3F/near/277763978">said</a>:</p>
<blockquote>
<p>You can have an example of branding lifetimes implemented using a macro instead of a higher-order callback in <a href="https://crates.io/crates/generativity/1.0.0">https://crates.io/crates/generativity/1.0.0</a></p>
</blockquote>
<p>Oh sweet this is awesome!</p>



<a name="277784591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Invariant%20%2B%20Closure%20%3D%20GhostCell%3F/near/277784591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Invariant.20.2B.20Closure.20.3D.20GhostCell.3F.html#277784591">(Apr 04 2022 at 19:52)</a>:</h4>
<p>Kinda uhh, spooky question, but is there a way to turn a <code>T: ?Sized + 'id</code> into a <code>T: ?Sized + 'static</code> at compile time? I'm looking to do <code>TypeId::of</code> and I think with branding it's actually acceptable to get the type ID in this case?</p>



<a name="277915203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Invariant%20%2B%20Closure%20%3D%20GhostCell%3F/near/277915203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Invariant.20.2B.20Closure.20.3D.20GhostCell.3F.html#277915203">(Apr 05 2022 at 17:30)</a>:</h4>
<p>Not really; but you could always provide you own helper trait:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">BrandedAny</span><span class="o">&lt;'</span><span class="na">id</span><span class="o">&gt;</span><span class="w"> </span>: <span class="o">'</span><span class="na">id</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">unbranded_type_id</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span>-&gt; <span class="nc">TypeId</span><span class="w"></span>
<span class="w">    </span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;'</span><span class="na">id</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BrandedAny</span><span class="o">&lt;'</span><span class="na">id</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyBrandedType</span><span class="o">&lt;'</span><span class="na">id</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">unbranded_type_id</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span>-&gt; <span class="nc">TypeId</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">TypeId</span>::<span class="n">of</span>::<span class="o">&lt;</span><span class="n">MyBrandedType</span><span class="o">&lt;'</span><span class="nb">static</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and so on</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>