<html>
<head><meta charset="utf-8"><title>How does the compilation model work concerning dependencies? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html">How does the compilation model work concerning dependencies?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250226258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250226258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Armin Kazmi <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250226258">(Aug 21 2021 at 16:43)</a>:</h4>
<p>Hello everyone, I'm not an compiler expert so forgive me when my question seems somewhat ignorant.<br>
I was wondering, in the overall topic "of compilation times" and rust general issues with that, how much effort is being done in compilation scope reduction, especially in the interaction across crates. I was pointed towards the query system for the general approach on how the compiler resolves dependent expressions, but how does this interact across module and crate borders?</p>
<p>More specifically, is the compilation bottom-up? Meaning, starting from e.g. a binary that uses several libraries, determing in a minimalistic way, what exact functions, types, etc. are required to compile the binary?</p>
<p>Preferrably I'd like to read up on the details of how that works, so any pointers would be greatly appreciated.</p>



<a name="250226329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250226329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250226329">(Aug 21 2021 at 16:45)</a>:</h4>
<p>The query system is not used across crates</p>



<a name="250226411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250226411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250226411">(Aug 21 2021 at 16:46)</a>:</h4>
<p>All library crates are compiled into rlib files that are required to build downstream crates, so the compilation model is fairly standard in that sense</p>



<a name="250226473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250226473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250226473">(Aug 21 2021 at 16:47)</a>:</h4>
<p>There is one optimization that we use: build pipelining. rustc can start compiling a downstream crate even before a dependency is <em>fully</em> compiled to an rlib, since only metadata emitted by the compiler is required to build downstream crates.</p>



<a name="250226558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250226558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250226558">(Aug 21 2021 at 16:49)</a>:</h4>
<p>So while rustc still optimizes and generates machine code for a library's functions, Cargo can already spawn another rustc that builds a downstream crate. Just linking won't work until all code has been generated.</p>



<a name="250226564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250226564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Armin Kazmi <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250226564">(Aug 21 2021 at 16:49)</a>:</h4>
<p>What kind of metadata?</p>



<a name="250226629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250226629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250226629">(Aug 21 2021 at 16:50)</a>:</h4>
<p>Metadata that describes the entire API surface of a crate, basically.</p>



<a name="250226709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250226709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Armin Kazmi <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250226709">(Aug 21 2021 at 16:52)</a>:</h4>
<p>But why is it designed in that way? I mean, wouldn't a bottom-up approach enable minimalisation that the current direction does not allow?<br>
If I understand you correctly, the metadata needs to be built. Thefore the crate needs to be <em>fully</em> built as well (with the exception of linking). At that stage, a lot of work is already wasted, because e.g. functions and code have been compiled that will never be consumed and used.</p>



<a name="250227144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250227144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Armin Kazmi <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250227144">(Aug 21 2021 at 17:01)</a>:</h4>
<p>Quoting from here: <a href="https://rustc-dev-guide.rust-lang.org/queries/query-evaluation-model-in-detail.html">https://rustc-dev-guide.rust-lang.org/queries/query-evaluation-model-in-detail.html</a></p>
<blockquote>
<p>As of January 2021, this input data consists mainly of the HIR map, upstream crate metadata, and the command-line options the compiler was invoked with; but in the future inputs will just consist of command-line options and a list of source files -- the HIR map will itself be provided by a query which processes these source files.</p>
</blockquote>
<p>Apaprently this already goes in the direction I mean, when that source file gathering happens across crates.</p>



<a name="250227187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250227187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250227187">(Aug 21 2021 at 17:02)</a>:</h4>
<p>It was designed that way because it is how most (all?) existing compilation models work. There has been some discussion on enabling multi-crate compilation sessions within the same rustc instance, which sounds like what you're suggesting, but that is a lot of work.</p>



<a name="250227319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250227319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250227319">(Aug 21 2021 at 17:05)</a>:</h4>
<p>That quote talks about end-to-end queries, not building multiple crates at once, I think</p>



<a name="250227385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250227385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250227385">(Aug 21 2021 at 17:06)</a>:</h4>
<p>Currently the query system is only used after HIR is built, the plan is to use it throughout the entire compiler</p>



<a name="250227387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20does%20the%20compilation%20model%20work%20concerning%20dependencies%3F/near/250227387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Armin Kazmi <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20does.20the.20compilation.20model.20work.20concerning.20dependencies.3F.html#250227387">(Aug 21 2021 at 17:06)</a>:</h4>
<p>It could mean that of course, but the 2nd listing removed "upstream crate metadata".</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>