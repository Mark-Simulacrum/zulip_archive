<html>
<head><meta charset="utf-8"><title>slices and MaybeUninit · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html">slices and MaybeUninit</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268418086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268418086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268418086">(Jan 18 2022 at 16:30)</a>:</h4>
<p>Is it safe to transmute <code>&amp;[T]</code> to <code>&amp;[MaybeUninit&lt;T&gt;]</code>? I feel like it should be since T has strictly stronger invariants, but MaybeUninit is tricksy.</p>



<a name="268418216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268418216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268418216">(Jan 18 2022 at 16:31)</a>:</h4>
<p>How about &amp;[&amp;[T]] to &amp;[&amp;[MaybeUninit&lt;T&gt;]] ? Unlike the one dimensional case, I don't see a way to make this conversion without transmuting</p>



<a name="268418924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268418924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268418924">(Jan 18 2022 at 16:35)</a>:</h4>
<p>I'm only actually interested in T = u8, but I doubt it makes a difference</p>



<a name="268419858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268419858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268419858">(Jan 18 2022 at 16:41)</a>:</h4>
<p>And you do specifically mean a <em>slice</em> not an <em>array</em>, right?</p>



<a name="268420101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268420101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268420101">(Jan 18 2022 at 16:43)</a>:</h4>
<p>yes</p>



<a name="268420109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268420109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268420109">(Jan 18 2022 at 16:43)</a>:</h4>
<p>Is there ever a time where you can't immediately "undo" a transmute? That is, if you go from <code>T</code> -&gt; <code>U</code>, you gotta be able to immediately go back to <code>U</code> -&gt; <code>T</code>.</p>



<a name="268420287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268420287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268420287">(Jan 18 2022 at 16:44)</a>:</h4>
<p>And since <a href="https://doc.rust-lang.org/std/mem/union.MaybeUninit.html#method.slice_assume_init_ref"><code>slice_assume_init_ref</code></a> exists, it seems like you can go back.</p>



<a name="268420308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268420308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268420308">(Jan 18 2022 at 16:44)</a>:</h4>
<p>Any time that the initial transmute itself is invalid (IE. <code>core::mem::transmute::&lt;u8,NonZeroU8&gt;(0)</code>)</p>



<a name="268420388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268420388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268420388">(Jan 18 2022 at 16:45)</a>:</h4>
<p>Ah, good point, I was implicitly assuming a valid initial transmute.</p>



<a name="268420484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268420484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268420484">(Jan 18 2022 at 16:46)</a>:</h4>
<p>Note that the implementation of <code>slice_assume_init_ref</code> is not a <code>transmute</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="p">(</span><span class="n">slice</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">[</span><span class="bp">Self</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">[</span><span class="n">T</span><span class="p">])</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="268420582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268420582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268420582">(Jan 18 2022 at 16:46)</a>:</h4>
<p>I'd be hesitant to use <code>transmute</code> itself on a slice as it's a fat pointer / <code>repr(Rust)</code>.</p>



<a name="268420940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268420940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268420940">(Jan 18 2022 at 16:49)</a>:</h4>
<p>Feels like you should be able to use <code>std::slice::from_raw_parts</code> to do the nested case though.</p>



<a name="268421102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268421102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268421102">(Jan 18 2022 at 16:50)</a>:</h4>
<p>If the transmute is bad, then the nested case, which also relies on the layout of <code>&amp;[MaybeUninit&lt;T&gt;]</code> matching <code>&amp;[T]</code>, is also bad.</p>



<a name="268421171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268421171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268421171">(Jan 18 2022 at 16:50)</a>:</h4>
<p>does repr(Rust) mean its unsound to transmute? Seems like it should be ok as long as the left and right side are both the same layout?</p>



<a name="268421284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268421284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268421284">(Jan 18 2022 at 16:51)</a>:</h4>
<p>It's ok in that case. What makes it unsound is that it is not guaranteed it will be.</p>



<a name="268421407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268421407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268421407">(Jan 18 2022 at 16:52)</a>:</h4>
<blockquote>
<p>When transmuting between different compound types, you have to make sure they are laid out the same way! If layouts differ, the wrong fields are going to get filled with the wrong data, which will make you unhappy and can also be UB (see above).</p>
<p>So how do you know if the layouts are the same? For repr(C) types and repr(transparent) types, layout is precisely defined. But for your run-of-the-mill repr(Rust), it is not. Even different instances of the same generic type can have wildly different layout. Vec&lt;i32&gt; and Vec&lt;u32&gt; might have their fields in the same order, or they might not. The details of what exactly is and is not guaranteed for data layout are still being worked out over at the UCG WG.</p>
</blockquote>
<ul>
<li><a href="https://doc.rust-lang.org/nomicon/transmutes.html">https://doc.rust-lang.org/nomicon/transmutes.html</a></li>
</ul>



<a name="268421595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268421595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268421595">(Jan 18 2022 at 16:53)</a>:</h4>
<p>TBH, slice pointers should at least be guaranteed to be layout-and-abi-compatible for abi-compatible types, because I don't see a reason not to, but they currently aren't.</p>



<a name="268421786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268421786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268421786">(Jan 18 2022 at 16:54)</a>:</h4>
<p>And <code>MaybeUninit</code> is <code>#[repr(transparent)]</code>, so that's a good step.</p>



<a name="268421885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268421885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268421885">(Jan 18 2022 at 16:55)</a>:</h4>
<p><code>struct Foo(u8, u8, u8)</code> and <code>struct Bar(u16, u8)</code> are both passed in a single register on x86_64 (with the systemv call conv), but they have a different alignment and thus aren't layout compatible.</p>



<a name="268422023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268422023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268422023">(Jan 18 2022 at 16:56)</a>:</h4>
<p>abi-compatible here implies layout-compatible.</p>



<a name="268422121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268422121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268422121">(Jan 18 2022 at 16:57)</a>:</h4>
<p>(So ig layout-and-abi-compatible is rundant)</p>



<a name="268422324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268422324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268422324">(Jan 18 2022 at 16:58)</a>:</h4>
<p>Yeah, in practice, I don't think the compiler will ever make &amp;[T] and &amp;[U] have different layouts if T and U have the same layouts.  Using from_raw_parts here seems like ceremony</p>



<a name="268422351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268422351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268422351">(Jan 18 2022 at 16:58)</a>:</h4>
<p>So <code>&amp;[T]</code> and <code>&amp;[Wrapper&lt;T&gt;]</code> (where <code>Wrapper&lt;T&gt;</code> is transparent over <code>T</code>) would be as-if they were <code>repr(transparent)</code> wrappers arround the same type basically.</p>



<a name="268422422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268422422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268422422">(Jan 18 2022 at 16:59)</a>:</h4>
<p><span class="user-mention" data-user-id="256841">@Nick Cameron</span> just make sure to put that assumption you just said into the <code>// SAFETY:</code> comment so you can recheck it in the future. :-)</p>



<a name="268422513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268422513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268422513">(Jan 18 2022 at 16:59)</a>:</h4>
<p>Yeah, I can't see that comment coming back to haunt me in the future, nope, not at all.</p>



<a name="268422910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268422910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268422910">(Jan 18 2022 at 17:01)</a>:</h4>
<p>Moving up a level, why do you want to do these transmutes in the first place?</p>



<a name="268423158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268423158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268423158">(Jan 18 2022 at 17:03)</a>:</h4>
<p>Implementing a buffer for vectored io where the internal repr is &amp;mut[&amp;mut [MaybeUninit&lt;u8&gt;]] and it can be initialised from &amp;mut[&amp;mut[u8]]</p>



<a name="268427751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268427751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268427751">(Jan 18 2022 at 17:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/122651-general/topic/slices.20and.20MaybeUninit/near/268421786">said</a>:</p>
<blockquote>
<p>And <code>MaybeUninit</code> is <code>#[repr(transparent)]</code>, so that's a good step.</p>
</blockquote>
<p>But its members are private, therefore you're not allowed to use the repr for reasoning. But you don't have to, the API contract already says</p>
<blockquote>
<p>MaybeUninit&lt;T&gt; is guaranteed to have the same size, alignment, and ABI as T:</p>
</blockquote>



<a name="268428366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268428366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268428366">(Jan 18 2022 at 17:36)</a>:</h4>
<p>If you're doing that, Nick, you probably should just use &lt;<a href="https://doc.rust-lang.org/nightly/std/mem/union.MaybeUninit.html#method.slice_assume_init_mut">https://doc.rust-lang.org/nightly/std/mem/union.MaybeUninit.html#method.slice_assume_init_mut</a>&gt;, and thus side-step any conversation about transmutes.  Hopefully more readable to have the method, too.</p>
<p>(And it sounds like you're only talking about <em>validity</em>, so you're doing the necessary checks, but here's the obligatory mention that both directions of <code>&amp;mut [MaybeUninit&lt;T&gt;]</code> &lt;-&gt; <code>&amp;mut [T]</code> in general is a violation of <em>safety</em> invariants.)</p>



<a name="268430127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268430127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268430127">(Jan 18 2022 at 17:49)</a>:</h4>
<p>slice_assume_init_mut is going the wrong way. I want to go from u8s to MaybeUninits</p>



<a name="268430247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268430247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268430247">(Jan 18 2022 at 17:50)</a>:</h4>
<p>Why does it violate safety invariants to go from &amp;mut [T] to &amp;mut [MaybeUninit&lt;T&gt;]</p>



<a name="268430256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268430256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268430256">(Jan 18 2022 at 17:50)</a>:</h4>
<p>?</p>



<a name="268430565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268430565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268430565">(Jan 18 2022 at 17:52)</a>:</h4>
<p>(Oh, I see.  Odd that we don't have methods for the other direction too.)</p>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/122651-general/topic/slices.20and.20MaybeUninit/near/268430247">said</a>:</p>
<blockquote>
<p>Why does it violate safety invariants to go from &amp;mut [T] to &amp;mut [MaybeUninit&lt;T&gt;]</p>
</blockquote>
<p>Because you can write an <code>uninit</code> into the array of supposed-to-be-initialized things.</p>



<a name="268430916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268430916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268430916">(Jan 18 2022 at 17:55)</a>:</h4>
<p>That only becomes a problem once you start accessing the <code>&amp;mut [T]</code> again, or is it insta-UB?</p>



<a name="268431872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268431872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268431872">(Jan 18 2022 at 18:01)</a>:</h4>
<p>Oh right of course, I forgot that we'll still have a reference to the original. I guess that is just a safety requirement on the use of that type rather than the transmute (this is already done in std)</p>



<a name="268433862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268433862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268433862">(Jan 18 2022 at 18:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/122651-general/topic/slices.20and.20MaybeUninit/near/268430916">said</a>:</p>
<blockquote>
<p>That only becomes a problem once you start accessing the <code>&amp;mut [T]</code> again, or is it insta-UB?</p>
</blockquote>
<p>I don't <em>think</em> it's insta-UB, because afaik the model doesn't have typed memory.  So all memory can be considered potentially-uninitializable.  (Well, except frozen statics, but there the problem is the write in the first place; the fact that it's uninit doesn't really matter.)</p>
<p>And right, Nick, just a safety invariant not a validity one.</p>



<a name="268435939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268435939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268435939">(Jan 18 2022 at 18:33)</a>:</h4>
<p><span class="user-mention" data-user-id="256841">@Nick Cameron</span>  see <a href="https://docs.rs/uninit/0.5.0/uninit/out_ref/struct.Out.html#method.as_uninit">https://docs.rs/uninit/0.5.0/uninit/out_ref/struct.Out.html#method.as_uninit</a> : it could be an issue if <code>T</code> has interior mutability and if <code>MaybeUninit</code> and <code>UnsafeCell</code> were allowed to commute</p>



<a name="268436642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268436642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268436642">(Jan 18 2022 at 18:39)</a>:</h4>
<p>But for <code>Freeze</code> types such as <code>u8</code>, the <em>conversion</em> is sound. Now, the conversion ought to favor using <code>slice_from_raw_parts()</code> since the layout of references to slices is <code>#[repr(Rust)]</code>, and thus allowed to change across choices of (modulo-regions-)distinct types</p>



<a name="268439338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/268439338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#268439338">(Jan 18 2022 at 18:59)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> Thanks all!</p>



<a name="270555960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/270555960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#270555960">(Feb 03 2022 at 14:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/122651-general/topic/slices.20and.20MaybeUninit/near/268435939">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span>  see <a href="https://docs.rs/uninit/0.5.0/uninit/out_ref/struct.Out.html#method.as_uninit">https://docs.rs/uninit/0.5.0/uninit/out_ref/struct.Out.html#method.as_uninit</a> : it could be an issue if <code>T</code> has interior mutability and if <code>MaybeUninit</code> and <code>UnsafeCell</code> were allowed to commute</p>
</blockquote>
<p>EDIT: given the safety invariants of <a href="https://doc.rust-lang.org/1.58.1/core/mem/union.MaybeUninit.html#safety-3"><code>MaybeUninit::assume_init_ref</code></a>, we can now positively say that <code>Cell</code> and <code>MaybeUninit</code> do not commute / it is <em>unsound</em> for them to do so, as proved by <span class="user-mention" data-user-id="210267">@Nemo157</span>'s snippet:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="p">{</span><span class="n">cell</span>::<span class="n">Cell</span><span class="p">,</span><span class="w"> </span><span class="n">mem</span>::<span class="n">MaybeUninit</span><span class="p">};</span><span class="w"></span>

<span class="sd">/// This is *unsound*, as showcased below.</span>
<span class="k">fn</span> <span class="nf">swap_mb_uninit_and_cell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">p</span>: <span class="kp">&amp;</span><span class="nc">MaybeUninit</span><span class="o">&lt;</span><span class="n">Cell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">Cell</span><span class="o">&lt;</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Safety: both `Cell` and `MaybeUninit` are `#[repr(transparent)]`</span>
<span class="w">        </span>::<span class="n">core</span>::<span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MaybeUninit</span>::<span class="n">new</span><span class="p">(</span><span class="n">Cell</span>::<span class="n">new</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Safety: we just constructed it initialized</span>
<span class="w">        </span><span class="n">a</span><span class="p">.</span><span class="n">assume_init_ref</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">swap_mb_uninit_and_cell</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">).</span><span class="n">set</span><span class="p">(</span><span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=044c8e074ccc54a04a6f14c5a230b63a">Playground</a> (run with miri top-right to check)</li>
</ul>
<p>cc <span class="user-mention" data-user-id="120791">@RalfJ</span></p>



<a name="270563679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/270563679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#270563679">(Feb 03 2022 at 15:08)</a>:</h4>
<p>I feel like this is fundamentally just a consequence of <code>Cell</code> being invariant over <code>T</code>.</p>



<a name="270711708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/270711708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#270711708">(Feb 04 2022 at 13:08)</a>:</h4>
<p>I share the feeling <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="270954615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/270954615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#270954615">(Feb 07 2022 at 09:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="338379">Giacomo Stevanato</span> <a href="#narrow/stream/122651-general/topic/slices.20and.20MaybeUninit/near/270563679">said</a>:</p>
<blockquote>
<p>I feel like this is fundamentally just a consequence of <code>Cell</code> being invariant over <code>T</code>.</p>
</blockquote>
<p>Out of curiosity, how does invariance play into this? Other invariant wrappers like <code>UnsafeCell</code> (requires <code>unsafe</code>) or <code>AtomicUsize</code> (can't set uninit bytes) don't seem to have this problem. I guess if there existed an <code>Atomic&lt;T&gt;</code> then it would have this issue, too, though!</p>



<a name="270989918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/270989918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#270989918">(Feb 07 2022 at 14:59)</a>:</h4>
<p>Cell is the only invariant type that:</p>
<ul>
<li>a)  Is transparent over its field, supplied by a type parameter, and</li>
<li>b) provides safe access</li>
</ul>
<p>I'd argue that it's likewise fundamentally unsound for <code>UnsafeCell</code>, but this unsoundness doesn't manifest outside of an unsafe api. That is, it's still unsound to transpose <code>UnsafeCell</code> and <code>MaybeUninit</code>, and it's perfectly valid to create a safe interface for <code>UnsafeCell</code> that assumes this (assuming other invariants are upheld).</p>



<a name="270990204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/270990204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#270990204">(Feb 07 2022 at 15:01)</a>:</h4>
<p>It's also unsound  for RefCell, but the unsoundness is more obvious given that a RefCell isn't just an UnsafeCell&lt;T&gt;, and is repr(Rust) (thus the layout of <code>MaybeUninit&lt;RefCell&lt;T&gt;&gt;</code> and <code>RefCell&lt;MaybeUninit&lt;T&gt;&gt;</code> can be different)</p>



<a name="271007054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/271007054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#271007054">(Feb 07 2022 at 16:49)</a>:</h4>
<p>That makes sense, thanks!</p>



<a name="271059277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/271059277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#271059277">(Feb 07 2022 at 23:33)</a>:</h4>
<blockquote>
<p>Out of curiosity, how does invariance play into this?</p>
</blockquote>
<p>Because converting a <code>&amp;Cell&lt;T&gt;</code> to a <code>&amp;Cell&lt;MaybeUninit&lt;T&gt;&gt;</code> has the same problem as converting from a <code>&amp;Cell&lt;&amp;'long T&gt;</code> to a <code>&amp;Cell&lt;&amp;'short T&gt;</code> (which invariance exist to prevent from): it allows you to write a value that has less invariants than what was originally expected. </p>
<blockquote>
<p>Other invariant wrappers like UnsafeCell (requires unsafe) or AtomicUsize (can't set uninit bytes) don't seem to have this problem.</p>
</blockquote>
<p><code>UnsafeCell</code> requires <code>unsafe</code> to write through a shared reference (and that's what triggers the problem, because otherwise you can only mutate through <code>&amp;mut UnsafeCell&lt;T&gt;</code> which is already invariant). <code>AtomicUsize</code> doesn't have any generic parameter, so variance is not a thing there.</p>



<a name="271090297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/271090297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#271090297">(Feb 08 2022 at 07:33)</a>:</h4>
<blockquote>
<p>it allows you to write a value that has less invariants than what was originally expected.</p>
</blockquote>
<p>Thanks! This is a really nice way of explaining it, that really clicked for me.</p>



<a name="271101093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/slices%20and%20MaybeUninit/near/271101093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/slices.20and.20MaybeUninit.html#271101093">(Feb 08 2022 at 09:28)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> interesting example. :D<br>
But this is not <em>too</em> surprising, after all, <code>Cell&lt;Option&lt;T&gt;&gt;</code> and <code>Option&lt;Cell&lt;T&gt;&gt;</code> are also very different types -- and <code>MaybeUninit</code> is basically <code>Option</code> but without runtime tracking of the <code>None</code> case.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>