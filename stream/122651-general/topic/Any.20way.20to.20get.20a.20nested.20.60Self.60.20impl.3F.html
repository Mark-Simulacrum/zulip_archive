<html>
<head><meta charset="utf-8"><title>Any way to get a nested `Self` impl? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Any.20way.20to.20get.20a.20nested.20.60Self.60.20impl.3F.html">Any way to get a nested `Self` impl?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258738653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Any%20way%20to%20get%20a%20nested%20%60Self%60%20impl%3F/near/258738653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Any.20way.20to.20get.20a.20nested.20.60Self.60.20impl.3F.html#258738653">(Oct 22 2021 at 16:45)</a>:</h4>
<p>Hi! In the context of a procedural macro, I'm trying to generate a nested method with a <code>self</code> receiver: essentially I'd like to generate code somewhat like the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">my_function</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">impl</span><span class="w"> </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">fn</span> <span class="nf">omg</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Here, I'd like to generate the bit that says <code>impl Self {...}</code>, but I get an error saying <code>cycle detected when computing type of </code>&lt;impl at src/lib.rs:3:1: 9:2&gt;::my_function::&lt;impl at src/lib.rs:5:9: 7:10&gt;`.<br>
Is there any trick I could use to work around this? </p>
<hr>
<p>Further context: </p>
<p>I have a proc macro (attribute) which needs to generate a bunch of methods with the same parameters as the method it is attached to. I can't just have it generate a top level method because we might be inside of a trait impl block, so I figured that nested functions could do the trick, but then I can't use <code>&amp;self</code>.</p>



<a name="258741003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Any%20way%20to%20get%20a%20nested%20%60Self%60%20impl%3F/near/258741003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Any.20way.20to.20get.20a.20nested.20.60Self.60.20impl.3F.html#258741003">(Oct 22 2021 at 17:01)</a>:</h4>
<p>(aside: even if this is not allowed, that error message could really use some work)</p>



<a name="258769654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Any%20way%20to%20get%20a%20nested%20%60Self%60%20impl%3F/near/258769654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Any.20way.20to.20get.20a.20nested.20.60Self.60.20impl.3F.html#258769654">(Oct 22 2021 at 20:27)</a>:</h4>
<p>The <code>Self</code> here refers to the SelfTy of <code>impl Self</code></p>



<a name="258769681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Any%20way%20to%20get%20a%20nested%20%60Self%60%20impl%3F/near/258769681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Any.20way.20to.20get.20a.20nested.20.60Self.60.20impl.3F.html#258769681">(Oct 22 2021 at 20:27)</a>:</h4>
<p>Which is not known, so is a cycle.</p>



<a name="258769740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Any%20way%20to%20get%20a%20nested%20%60Self%60%20impl%3F/near/258769740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Any.20way.20to.20get.20a.20nested.20.60Self.60.20impl.3F.html#258769740">(Oct 22 2021 at 20:27)</a>:</h4>
<p>You can write <code>impl Self {}</code> without wrapping block, and it produces the same error.</p>



<a name="258770151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Any%20way%20to%20get%20a%20nested%20%60Self%60%20impl%3F/near/258770151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Any.20way.20to.20get.20a.20nested.20.60Self.60.20impl.3F.html#258770151">(Oct 22 2021 at 20:31)</a>:</h4>
<p>It might seems weird that <code>Self</code> refers to the SelfTy of the impl block instead of the outer scope, but for trait impl it's legal to use <code>Self</code>, e.g. <code>impl&lt;T&gt; Trait&lt;Self&gt; for T {}</code>, so I think it's good to have the consistency in inherent impl blocks as well.</p>



<a name="258817087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Any%20way%20to%20get%20a%20nested%20%60Self%60%20impl%3F/near/258817087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Any.20way.20to.20get.20a.20nested.20.60Self.60.20impl.3F.html#258817087">(Oct 23 2021 at 10:53)</a>:</h4>
<p>ah, and you can't for example use <code>super::Self</code> either</p>



<a name="258827689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Any%20way%20to%20get%20a%20nested%20%60Self%60%20impl%3F/near/258827689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Any.20way.20to.20get.20a.20nested.20.60Self.60.20impl.3F.html#258827689">(Oct 23 2021 at 14:57)</a>:</h4>
<p>Nor any other type parameters of the surrounding scope.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>