<html>
<head><meta charset="utf-8"><title>fast math for simd? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20math.20for.20simd.3F.html">fast math for simd?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274097743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20math%20for%20simd%3F/near/274097743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20math.20for.20simd.3F.html#274097743">(Mar 04 2022 at 08:51)</a>:</h4>
<p>I was wondering if there will be any fast math planned for simd, because I noticed <code>std::simd</code> doesn't seem to have any fast math options. I think it would be beneficial since there are a variety of optimizations to pick from available in Intel's <em>Optimization Reference Manual</em> especially for AVX in chapter 15.</p>



<a name="274109406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20math%20for%20simd%3F/near/274109406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20math.20for.20simd.3F.html#274109406">(Mar 04 2022 at 10:30)</a>:</h4>
<p>Given that there's no "fast" math for <code>f32</code> scalars either, it's unclear what it should look like, and thus it's probably not actively planned.  Doing the same thing as <code>-ffast-math</code> would allow UB from safe code, which is absolutely not allowed, so it needs to be more nuanced.</p>
<p>Was there anything in particularly you were interested in?</p>



<a name="274115220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20math%20for%20simd%3F/near/274115220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20math.20for.20simd.3F.html#274115220">(Mar 04 2022 at 11:26)</a>:</h4>
<p>scalar math has some intrinsics for fast math like <code>std::intrinsics::fdiv_fast</code>, but this isn't the case for simd.<br>
I'm interesting in taking advantage of <code>rcpps</code>, and <code>rsqrtps</code> when possible, because sometimes low accuracy should be fine for certain tasks that don't require comparisons.</p>



<a name="274165586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20math%20for%20simd%3F/near/274165586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20math.20for.20simd.3F.html#274165586">(Mar 04 2022 at 17:57)</a>:</h4>
<p>I am reluctant to enable a path to a low-accuracy hardware instruction because that has in the past resulted in Intel and AMD not agreeing on how it should be implemented which results in actual bugs in actual programs:<br>
<a href="https://cookieplmonster.github.io/2020/07/19/silentpatch-mass-effect/">https://cookieplmonster.github.io/2020/07/19/silentpatch-mass-effect/</a><br>
<a href="https://robert.ocallahan.org/2021/09/rr-trace-portability-diverging-behavior.html">https://robert.ocallahan.org/2021/09/rr-trace-portability-diverging-behavior.html</a></p>



<a name="274165735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20math%20for%20simd%3F/near/274165735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20math.20for.20simd.3F.html#274165735">(Mar 04 2022 at 17:58)</a>:</h4>
<p>The problem isn't that the answer is wibbly, it's that two different CPUs for what's supposed to be the <strong>same damn target</strong> wibbling on the answer cause really wacky results. I don't want Rust to have to have <code>cfg(amd)</code> or <code>cfg(intel)</code>.</p>



<a name="274166118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20math%20for%20simd%3F/near/274166118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20math.20for.20simd.3F.html#274166118">(Mar 04 2022 at 18:00)</a>:</h4>
<p>The Rust vision of so-called "fast math" is going to look a lot less like "fast math in a general sense" and a lot more like "enabling specific compiler contracts in some code, like <code>fp_contract</code>"</p>



<a name="274252377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20math%20for%20simd%3F/near/274252377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20math.20for.20simd.3F.html#274252377">(Mar 05 2022 at 16:35)</a>:</h4>
<p>I was not aware that amd and intel had those stupid issues. I still hope we see simd fast math eventually, but without those architectural mistakes.</p>



<a name="274267014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/fast%20math%20for%20simd%3F/near/274267014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/fast.20math.20for.20simd.3F.html#274267014">(Mar 05 2022 at 21:57)</a>:</h4>
<p>We will definitely try to expose fast operations where uh, they don't explode things.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>