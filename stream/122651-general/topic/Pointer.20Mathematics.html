<html>
<head><meta charset="utf-8"><title>Pointer Mathematics · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html">Pointer Mathematics</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253139336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253139336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Larry Dewey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253139336">(Sep 13 2021 at 18:44)</a>:</h4>
<p>I have been experiencing some weird results from pointer mathematics. I know that they should be avoided when possible, but in my particular use-case it is necessary. When performing the following subtraction:</p>
<div class="codehilite"><pre><span></span><code>  0x7ffd2541f67e
- 0x00000000000e
</code></pre></div>
<p>I would expect the result to be <code>0x7ffd2541f670</code>. However, the result is sporadically different. Does the <code>.sub()</code> function for <code>*mut &lt;T&gt;</code> and <code>*const &lt;T&gt;</code> perform non-standard hexadecimal subtraction?</p>



<a name="253140207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253140207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253140207">(Sep 13 2021 at 18:50)</a>:</h4>
<p>Where do the pointer and offset come from? I don't think <code>sub</code> is doing anything non-standard.</p>



<a name="253140221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253140221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253140221">(Sep 13 2021 at 18:50)</a>:</h4>
<p>What does the code look like?</p>



<a name="253140894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253140894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253140894">(Sep 13 2021 at 18:54)</a>:</h4>
<p>Oh weird, I was <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=ab47b41ed911f6ae7586b4ed26d47b26">able to confim</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x7ffd2541f67e</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000000000e</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">off</span><span class="p">)</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:x?} - {:x?} = {:x?}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 0x7ffd2541f67e - e = 0x7ffd2541f67e</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="253141174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253141174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Larry Dewey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253141174">(Sep 13 2021 at 18:56)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=3f43b276ca9c20d9e14e9dc8cbdcd385">Example Code</a></p>



<a name="253141351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253141351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Larry Dewey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253141351">(Sep 13 2021 at 18:57)</a>:</h4>
<p>I know that dereferencing a pointer can caused UB, but in this case I know it will only be used against a specific architecture. I feel like this is less of a problem with UB as much as it is with the <code>.sub()</code> function.</p>



<a name="253141383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253141383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Larry Dewey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253141383">(Sep 13 2021 at 18:57)</a>:</h4>
<p>Like <span class="user-mention" data-user-id="271719">@Mario Carneiro</span> mentioned, it is reproducible outside of my particular example.</p>



<a name="253141627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253141627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253141627">(Sep 13 2021 at 18:59)</a>:</h4>
<blockquote>
<p>Both the starting and resulting pointer must be either in bounds or one byte past the end of the same allocated object</p>
</blockquote>
<p>I was skimming <a href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html">https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html</a>, but it's right there in the docs for <code>sub</code></p>



<a name="253141871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253141871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Larry Dewey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253141871">(Sep 13 2021 at 19:00)</a>:</h4>
<p>So I am getting undefined behavior because the memory is too far apart?</p>



<a name="253142019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142019">(Sep 13 2021 at 19:01)</a>:</h4>
<p>I don't know in your case. In <span class="user-mention" data-user-id="271719">@Mario Carneiro</span> that's UB because the code pulls a pointer out of the thin air</p>



<a name="253142034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142034">(Sep 13 2021 at 19:02)</a>:</h4>
<p><a href="https://kristerw.blogspot.com/2016/03/c-pointers-are-not-hardware-pointers.html">https://kristerw.blogspot.com/2016/03/c-pointers-are-not-hardware-pointers.html</a> is a good read</p>



<a name="253142091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142091">(Sep 13 2021 at 19:02)</a>:</h4>
<p>That's not UB if there is something there</p>



<a name="253142117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142117">(Sep 13 2021 at 19:02)</a>:</h4>
<p>and the compiler can't know that there isn't in this case</p>



<a name="253142152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142152">(Sep 13 2021 at 19:02)</a>:</h4>
<p>so I don't see how it can miscompile here</p>



<a name="253142239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Larry Dewey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142239">(Sep 13 2021 at 19:03)</a>:</h4>
<p><span class="user-mention" data-user-id="203546">@Laurențiu</span> There is a value at the location provided, so while a good read, I don't know that it directly relates to this.</p>



<a name="253142300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142300">(Sep 13 2021 at 19:04)</a>:</h4>
<blockquote>
<p>Similarly, subtraction of pointers are only allowed for array objects, and both pointers must point into the same array object (or the byte following the object).</p>
</blockquote>



<a name="253142353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142353">(Sep 13 2021 at 19:04)</a>:</h4>
<p>The crazy optimizations usually only happen when you use a pointer to <code>malloc</code> or a local or something, so that the compiler can reason about whether they are in fact in separate allocations</p>



<a name="253142358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142358">(Sep 13 2021 at 19:04)</a>:</h4>
<p>I assume it's similar in Rust</p>



<a name="253142413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142413">(Sep 13 2021 at 19:04)</a>:</h4>
<p>There very well might be an array object at the target location, the compiler can't know whether this is the case</p>



<a name="253142501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142501">(Sep 13 2021 at 19:05)</a>:</h4>
<p>By the way, that quote doesn't sound like Rust</p>



<a name="253142548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142548">(Sep 13 2021 at 19:06)</a>:</h4>
<p>in Rust you can do arbitrary arithmetic on pointers within the bounds of an allocation, there is no "typed memory" like in C/C++</p>



<a name="253142655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Larry Dewey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142655">(Sep 13 2021 at 19:06)</a>:</h4>
<p>That was my understanding, as well</p>



<a name="253142797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142797">(Sep 13 2021 at 19:07)</a>:</h4>
<p>But the value in the snippet above is not inside an allocation</p>



<a name="253142820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142820">(Sep 13 2021 at 19:07)</a>:</h4>
<p>how can you know that?</p>



<a name="253142863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142863">(Sep 13 2021 at 19:07)</a>:</h4>
<p>it might have been created in another thread</p>



<a name="253142936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142936">(Sep 13 2021 at 19:08)</a>:</h4>
<p>But it wasn't</p>



<a name="253142955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142955">(Sep 13 2021 at 19:08)</a>:</h4>
<p>I mean in the example that's obviously not the case but you get the point</p>



<a name="253142996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253142996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253142996">(Sep 13 2021 at 19:08)</a>:</h4>
<p>you would need global program analysis to determine it for sure</p>



<a name="253143044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253143044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253143044">(Sep 13 2021 at 19:09)</a>:</h4>
<p>Under normal conditions that analysis isn't even possible, so compilers have to be conservative</p>



<a name="253143056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253143056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253143056">(Sep 13 2021 at 19:09)</a>:</h4>
<blockquote>
<p>This kind of provenance also exists in C/C++, but Rust is more permissive by (a) providing a way to do pointer arithmetic across allocation boundaries without causing immediate UB (though, as we have seen, the resulting pointer still cannot be used for locations outside the allocation it originates), and (b) by allowing pointers to always be compared safely, even if their provenance differs.</p>
</blockquote>
<p>Interesting</p>



<a name="253143095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253143095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253143095">(Sep 13 2021 at 19:09)</a>:</h4>
<p>which means that "wild" pointers act basically like hardware pointers in C/C++/Rust</p>



<a name="253143256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253143256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Larry Dewey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253143256">(Sep 13 2021 at 19:10)</a>:</h4>
<p>Also, as an aside, performing the same task in C behaves as expected.</p>



<a name="253143327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253143327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253143327">(Sep 13 2021 at 19:11)</a>:</h4>
<p><a href="https://rust.godbolt.org/z/nT7M5W98E">https://rust.godbolt.org/z/nT7M5W98E</a> nice</p>



<a name="253143383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253143383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253143383">(Sep 13 2021 at 19:11)</a>:</h4>
<p>Note that <code>wrapping_sub</code> has fewer requirements than <code>sub</code>, so if there is a UB issue this might make a difference, but in this case it acts the same</p>



<a name="253143446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253143446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253143446">(Sep 13 2021 at 19:11)</a>:</h4>
<p>Oh <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="253143502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253143502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253143502">(Sep 13 2021 at 19:12)</a>:</h4>
<p><code>()</code> is a zst</p>



<a name="253143528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253143528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253143528">(Sep 13 2021 at 19:12)</a>:</h4>
<p>so offsetting adds a multiple of 0</p>



<a name="253143667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253143667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253143667">(Sep 13 2021 at 19:13)</a>:</h4>
<p>if you use <code>*const u8</code> it acts as expected</p>



<a name="253144153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253144153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253144153">(Sep 13 2021 at 19:17)</a>:</h4>
<p>The issue in your code <span class="user-mention" data-user-id="433828">@Larry Dewey</span> seems to be similar: you are using <code>*const u64</code> so the offset takes you 8 times further than expected</p>



<a name="253144433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253144433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253144433">(Sep 13 2021 at 19:19)</a>:</h4>
<p>By the way that <code>offsetof!</code> macro is UB</p>



<a name="253144467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253144467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Larry Dewey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253144467">(Sep 13 2021 at 19:20)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> Can you explain this a bit, or provide a link to some docs? I was under the impression that <code>e / 14</code> was the value regardless of type.</p>



<a name="253144535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253144535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253144535">(Sep 13 2021 at 19:20)</a>:</h4>
<p>It's like pointer arithmetic in C</p>



<a name="253144875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253144875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253144875">(Sep 13 2021 at 19:21)</a>:</h4>
<p>if you have <code>T* x</code> then <code>x + i</code> has a numerical value of <code>(size_t)x + i*sizeof(T)</code></p>



<a name="253145039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253145039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253145039">(Sep 13 2021 at 19:22)</a>:</h4>
<p>that is, <code>i</code> is actually some number of multiples of the size of the type</p>



<a name="253145149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253145149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253145149">(Sep 13 2021 at 19:22)</a>:</h4>
<p>so that the desugaring <code>&amp;x[i] = (&amp;x + i)</code> makes sense</p>



<a name="253145409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253145409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253145409">(Sep 13 2021 at 19:24)</a>:</h4>
<p>This is mentioned in the <a href="https://doc.rust-lang.org/std/primitive.pointer.html#method.sub">docs</a>:</p>
<blockquote>
<p>Calculates the offset from a pointer (convenience for <code>.offset((count as isize).wrapping_neg())</code>).</p>
<p><code>count</code> is in units of T; e.g., a <code>count</code> of 3 represents a pointer offset of <code>3 * size_of::&lt;T&gt;()</code> bytes.</p>
</blockquote>



<a name="253145752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253145752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Larry Dewey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253145752">(Sep 13 2021 at 19:26)</a>:</h4>
<p>Oh gotcha. That makes a lot more sense. I was using assuming <code>.sub()</code> was performing standards hex subtraction, not performing offset, as well.</p>



<a name="253146137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253146137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Larry Dewey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253146137">(Sep 13 2021 at 19:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/122651-general/topic/Pointer.20Mathematics/near/253144433">said</a>:</p>
<blockquote>
<p>By the way that <code>offsetof!</code> macro is UB</p>
</blockquote>
<p>I am aware of that, but it is the standard fallback for the Linux kernel. I am open to suggestions.</p>



<a name="253147174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Pointer%20Mathematics/near/253147174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Pointer.20Mathematics.html#253147174">(Sep 13 2021 at 19:36)</a>:</h4>
<p>I would suggest using the <a href="https://crates.io/crates/memoffset"><code>memoffset</code></a> crate, or its implementation, which uses a pointer to an unitialized stack local (relying on dead code elimination to remove it) instead of the null pointer</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>