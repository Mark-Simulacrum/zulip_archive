<html>
<head><meta charset="utf-8"><title>emscripten: Pointless wasm-to-js/js-to-wasm calls? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html">emscripten: Pointless wasm-to-js/js-to-wasm calls?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258088737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emscripten%3A%20Pointless%20wasm-to-js/js-to-wasm%20calls%3F/near/258088737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Chip Socket <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html#258088737">(Oct 18 2021 at 19:50)</a>:</h4>
<p>Hi, I'm trying to figure out what is causing reduced performance in my framework in emscripten - rendering seems to be 5x slower in the browser versus desktop. In the Chrome profiler I'm noticing heavy Self Time in wasm-to-js invoking invoke_vii invoking js-to-wasm, seemingly for no reason, in code that does not actually perform any external calls to JS as far as I can tell.</p>
<p><a href="/user_uploads/4715/oyR34OExD3c3yEaia4RZhjB3/2021-10-18-15_47_49-Keeshond-Doggymark-_-Space-to-spawn-doggos-_-S-Spawn-slowly-_-Delete-Despaw.png">2021-10-18-15_47_49-Keeshond-Doggymark-_-Space-to-spawn-doggos-_-S-Spawn-slowly-_-Delete-Despaw.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/oyR34OExD3c3yEaia4RZhjB3/2021-10-18-15_47_49-Keeshond-Doggymark-_-Space-to-spawn-doggos-_-S-Spawn-slowly-_-Delete-Despaw.png" title="2021-10-18-15_47_49-Keeshond-Doggymark-_-Space-to-spawn-doggos-_-S-Spawn-slowly-_-Delete-Despaw.png"><img src="/user_uploads/4715/oyR34OExD3c3yEaia4RZhjB3/2021-10-18-15_47_49-Keeshond-Doggymark-_-Space-to-spawn-doggos-_-S-Spawn-slowly-_-Delete-Despaw.png"></a></div><p>In my source code, <code>DoggyDrawer::draw()</code> calls directly into <code>draw_sprite()</code> so there should be no reason for the wasm-to-js and js-to-wasm roundabout calls. What would cause this?</p>
<p>I can provide generated wasm, source code, profiler data, etc. on request.</p>



<a name="258123877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emscripten%3A%20Pointless%20wasm-to-js/js-to-wasm%20calls%3F/near/258123877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Chip Socket <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html#258123877">(Oct 19 2021 at 00:37)</a>:</h4>
<p>Just tried this in Firefox too. The performance is even worse there. If anyone could point me in the direction of a developer or maintainer working on Rust wasm/emscripten I would very much appreciate it.</p>



<a name="258152198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emscripten%3A%20Pointless%20wasm-to-js/js-to-wasm%20calls%3F/near/258152198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html#258152198">(Oct 19 2021 at 07:19)</a>:</h4>
<p>That could be for handling unwinding. Try adding <code>panic = "abort"</code> under the <code>[profile.dev]</code> and <code>[profile.release]</code> sections in <code>Cargo.toml</code>.</p>



<a name="258242993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emscripten%3A%20Pointless%20wasm-to-js/js-to-wasm%20calls%3F/near/258242993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Chip Socket <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html#258242993">(Oct 19 2021 at 17:56)</a>:</h4>
<p>What do you know, it's over twice as fast now with <code>panic = "abort"</code>. I'm assuming that this is a current limitation of the stack unwinding? Any plans to improve this or is it a limitation of wasm?</p>



<a name="258244401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emscripten%3A%20Pointless%20wasm-to-js/js-to-wasm%20calls%3F/near/258244401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html#258244401">(Oct 19 2021 at 18:03)</a>:</h4>
<p>There is a proposal for native stack unwinding in wasm, but no implementations yet I think.</p>



<a name="258244585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emscripten%3A%20Pointless%20wasm-to-js/js-to-wasm%20calls%3F/near/258244585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Chip Socket <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html#258244585">(Oct 19 2021 at 18:04)</a>:</h4>
<p>Thank you for pointing out this workaround, it's saved me the embarrassment of making a new issue that would immediately get closed :)</p>



<a name="258245049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emscripten%3A%20Pointless%20wasm-to-js/js-to-wasm%20calls%3F/near/258245049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Chip Socket <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html#258245049">(Oct 19 2021 at 18:07)</a>:</h4>
<p>At this point it seems like the one big remaining bottleneck is doing the matrix multiplication for the drawing transforms. I take it wasm doesn't have a good way to accelerate this yet? Still, I'm up to 150k sprites now. While it's not the 390k I can get on desktop, and a bit shy of the ~200k that pixi.js achieves, it's still pretty good</p>



<a name="258276162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emscripten%3A%20Pointless%20wasm-to-js/js-to-wasm%20calls%3F/near/258276162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html#258276162">(Oct 19 2021 at 21:35)</a>:</h4>
<p>I think matrix multiplications benefit a lot from SIMD. For x86_64 SSE2 is enabled by default for 128bit vectors. For wasm the simd feature isn't enabled at all. To enable it you will need to use <code>RUSTFLAGS="-Ctarget-features=+simd"</code> I believe. As far as I know enabling it requires enabling it for all crates though, including the standard library. Rebuilding the standard library to enable simd for it requires nightly currently. On nightly you can pass <code>-Zbuild-std</code> to cargo.</p>



<a name="258286053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emscripten%3A%20Pointless%20wasm-to-js/js-to-wasm%20calls%3F/near/258286053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Chip Socket <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html#258286053">(Oct 19 2021 at 22:59)</a>:</h4>
<p>I ended up stumbling on the SIMD flag myself. Tried to enable it but I'm getting emscripten compiler errors related to unrecognized wasm SIMD instructions in emscripten 2.0.13... and later versions of emscripten don't seem to want to compile because of a missing symbol for <code>__cxa_is_pointer_type</code></p>



<a name="258289243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emscripten%3A%20Pointless%20wasm-to-js/js-to-wasm%20calls%3F/near/258289243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Chip Socket <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html#258289243">(Oct 19 2021 at 23:28)</a>:</h4>
<p>I was able to get it to compile with latest emscripten by issuing <code>-sDISABLE_EXCEPTION_CATCHING=0</code> in the linker flags</p>



<a name="258289475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/emscripten%3A%20Pointless%20wasm-to-js/js-to-wasm%20calls%3F/near/258289475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cosmic Chip Socket <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/emscripten.3A.20Pointless.20wasm-to-js.2Fjs-to-wasm.20calls.3F.html#258289475">(Oct 19 2021 at 23:31)</a>:</h4>
<p>Also according to this page <a href="https://v8.dev/features/simd">https://v8.dev/features/simd</a> the flags to send to rustc are actually <code>RUSTFLAGS="-C target-feature=+simd128"</code>. This doesn't seem to make a big difference in terms of performance though. I'm wondering if there's something else I need to enable as well... but I'm up to 170k sprites, so it's progress. Some of that I think might just be from upgrading to newer emscripten. Or maybe it's just placebo haha</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>