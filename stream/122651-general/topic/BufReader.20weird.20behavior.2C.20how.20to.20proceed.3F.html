<html>
<head><meta charset="utf-8"><title>BufReader weird behavior, how to proceed? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html">BufReader weird behavior, how to proceed?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262914621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262914621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luiz Gustavo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262914621">(Nov 28 2021 at 07:19)</a>:</h4>
<p>Hi, <br>
I found some weirdness on the way <a href="http://BufReader.read">BufReader.read</a> works and I don't know where to discuss it.<br>
The behavior is tested and expected <a href="https://github.com/rust-lang/rust/blob/4919988fe1765e51232558647f2260fff3544658/library/std/src/io/buffered/tests.rs#L47">here</a>.  The test is copied bellow:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[test]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">test_buffered_reader</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">inner</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BufReader</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">inner</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">nread</span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">buffer</span><span class="p">(),</span><span class="w"> </span><span class="p">[]);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">nread</span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">buffer</span><span class="p">(),</span><span class="w"> </span><span class="p">[]);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">nread</span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">buffer</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">nread</span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]);</span><span class="w">                 </span><span class="c1">//  &lt;--- why :(</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">buffer</span><span class="p">(),</span><span class="w"> </span><span class="p">[]);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">nread</span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">buffer</span><span class="p">(),</span><span class="w"> </span><span class="p">[]);</span><span class="w"></span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The issue is, at the annotated line, dest buffer has enough space to hold the remaining 2 bytes, but the read is limited by the remaining space on BufReader internal buffer, instead of the actual available data. This means that I can't simply change </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="n">some_path</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>to </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BufReader</span>::<span class="n">new</span><span class="p">(</span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="n">some_path</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
<p>without accounting for this behavior.<br>
So, is this intended? Where is the best place to discuss this? Should I open an issue? Create a PR?</p>
<p>Thanks in advance :)</p>



<a name="262914970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262914970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262914970">(Nov 28 2021 at 07:29)</a>:</h4>
<p>That's not ideal behavior, I think.</p>



<a name="262915651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262915651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262915651">(Nov 28 2021 at 07:49)</a>:</h4>
<p>Generally <a href="https://doc.rust-lang.org/std/io/trait.Read.html#tymethod.read"><code>Read::read(&amp;mut self, buf: &amp;mut [u8]) -&gt; Result&lt;usize&gt;</code></a> does not guarantee that all of <code>buf.len()</code> bytes are being read if they are available. That is true for <code>File::read()</code> as well. So your implementation needs to handle that in any case.</p>



<a name="262915709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262915709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262915709">(Nov 28 2021 at 07:51)</a>:</h4>
<p>Or, IIRC, the code reading the buffer should use <a href="https://doc.rust-lang.org/std/io/struct.BufReader.html#method.read_exact"><code>read_exact</code></a> instead of <code>read</code> if it needs the buffer filled.</p>



<a name="262915762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262915762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Khionu Sybiern <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262915762">(Nov 28 2021 at 07:53)</a>:</h4>
<p><code>read_exact</code>, though, blocks until there is enough bytes, right?</p>



<a name="262915777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262915777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Khionu Sybiern <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262915777">(Nov 28 2021 at 07:53)</a>:</h4>
<p>Docs don't actually say what the behaviour is</p>



<a name="262915902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262915902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262915902">(Nov 28 2021 at 07:56)</a>:</h4>
<p>Yeah, it will, and it'll error if there aren't enough.</p>



<a name="262932570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262932570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262932570">(Nov 28 2021 at 14:48)</a>:</h4>
<p>If you don't want to block, e.g. on a socket, then it's even more important to deal with short reads.</p>



<a name="262935261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262935261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262935261">(Nov 28 2021 at 15:51)</a>:</h4>
<blockquote>
<p>The issue is, at the annotated line, dest buffer has enough space to hold the remaining 2 bytes, but the read is limited by the remaining space on BufReader internal buffer, instead of the actual available data. </p>
</blockquote>
<p>BufReader cannot try to retrieve the remaining data from the underlying reader because that read could error even though there's still data in the buffer. To maintain error-transparency it first has to return all the data that has already been buffered up before performing an action that could return an error.</p>



<a name="262936509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262936509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luiz Gustavo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262936509">(Nov 28 2021 at 16:20)</a>:</h4>
<p><span class="user-mention" data-user-id="407656">@Hans Kratz</span> what I found annoying is that in this case it is an almost guaranteed short read  every time the buffer is filled. My first thought was that every short read should come from a short read on the underlying  <code>read</code>.<br>
But if I understand what <span class="user-mention" data-user-id="330154">@The 8472</span> pointed out, we might have previously successful read data lost due to an error occurred on a different read, which would be more than just annoying.<br>
It make sense now, thanks everyone.</p>



<a name="262936914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262936914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262936914">(Nov 28 2021 at 16:30)</a>:</h4>
<p>Also note that <code>File</code> can very much return short reads. While at least linux tries hard to fulfill the full read length for regular files it does not guarantee that either (e.g. consider FUSE filesystems) and one can always open non-regular files via <code>File::open</code> such as named pipes, unix sockets or arbitrary file descriptors via <code>/proc/&lt;pid&gt;/fd/</code>, which in turn is used by bash command substitution.</p>



<a name="262942445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262942445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262942445">(Nov 28 2021 at 18:47)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> On the other hand, if you're going to treat any read error as a fatal error and all the data read so far won't be useful anyway in that case, then it'd be nice to optimize and not have short reads.</p>



<a name="262942511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262942511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262942511">(Nov 28 2021 at 18:48)</a>:</h4>
<p>As an example, I have a BufRead wrapped around a reader that produces, alternating, large files and small headers. It'd be nice if every small header didn't result in a nine-byte read.</p>



<a name="262943407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262943407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262943407">(Nov 28 2021 at 19:08)</a>:</h4>
<p>Does the wrapped reader produce short reads?</p>



<a name="262943813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262943813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262943813">(Nov 28 2021 at 19:18)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BufReader</span>::<span class="n">new</span><span class="p">(</span><span class="n">futures_util</span>::<span class="n">TryStreamExt</span>::<span class="n">into_async_read</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">pin</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">futures_util</span>::<span class="n">stream</span>::<span class="n">try_unfold</span><span class="p">(</span><span class="w"></span>
</code></pre></div>



<a name="262943831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262943831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262943831">(Nov 28 2021 at 19:19)</a>:</h4>
<p>It's a <code>try_unfold</code> that produces, alternately, chunks of file data up to 4k, and per-file headers that are 9 bytes.</p>



<a name="262944663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262944663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262944663">(Nov 28 2021 at 19:40)</a>:</h4>
<p>Isn't that all async, i.e. not the std buf reader?</p>



<a name="262945153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262945153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262945153">(Nov 28 2021 at 19:54)</a>:</h4>
<p>Anyway, what I was going for is that if you don't care about the bytes before an error then the underlying reader could do the looping when BufReader tries to fill its buffer. Then the header will end up in the buffer at the end of the previous file.</p>



<a name="262950103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262950103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262950103">(Nov 28 2021 at 21:47)</a>:</h4>
<p>I'd like to avoid hand-coding that logic. I'm not writing a reader; I'm using <code>into_async_read</code> and a <code>try_unfold</code> closure.</p>



<a name="262950346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262950346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262950346">(Nov 28 2021 at 21:52)</a>:</h4>
<p>But that means you are using <a href="https://docs.rs/futures/0.3.18/futures/io/struct.BufReader.html"><code>futures::io::BufReader</code></a>, right?</p>



<a name="262954096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/BufReader%20weird%20behavior%2C%20how%20to%20proceed%3F/near/262954096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/BufReader.20weird.20behavior.2C.20how.20to.20proceed.3F.html#262954096">(Nov 28 2021 at 23:21)</a>:</h4>
<p>As re-exported from smol, but yeah.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>