<html>
<head><meta charset="utf-8"><title>Unaligned References · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html">Unaligned References</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276852183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276852183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Markus Grech <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276852183">(Mar 28 2022 at 10:15)</a>:</h4>
<p>Hi, I wanted to ask about an issue that concerns pointers/references to objects with non-default alignment. At present, accessing memory that is not sufficiently aligned is unsound, but if Rust had alignment specifiers as part of the type, the correct LLVM IR could be emitted to make this work. This came up in the context of references to fields of packed structs: <a href="https://github.com/rust-lang/rust/issues/27060">https://github.com/rust-lang/rust/issues/27060</a>, in particular <a href="https://github.com/rust-lang/rust/issues/27060#issuecomment-1079947107">https://github.com/rust-lang/rust/issues/27060#issuecomment-1079947107</a>. I was wondering what the Rust team's stance is on the issue and whether an RFC to add such a language feature would be welcomed.</p>



<a name="276878693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276878693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276878693">(Mar 28 2022 at 14:11)</a>:</h4>
<p>Well, one can use raw pointers, if necessary.</p>
<p>Can you say more about what "alignment as part of the type" means? What would the alignment of <code>&amp;T</code> be for some generic <code>T</code>?</p>



<a name="276886796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276886796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Markus Grech <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276886796">(Mar 28 2022 at 15:03)</a>:</h4>
<p>If you have a <code>#[repr(packed)] struct Foo { x: u8, y: u32 }</code>, the <code>y</code> is at an odd address and the reference to <code>y</code> would have a type like <code>&amp;align(1) u32</code>, which carries the information that <code>y</code> is not aligned properly</p>



<a name="276887661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276887661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Markus Grech <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276887661">(Mar 28 2022 at 15:09)</a>:</h4>
<p><code>&amp;T</code> is then just equivalent to <code>&amp;align(std::mem::align_of::&lt;T&gt;()) T</code></p>



<a name="276887727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276887727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276887727">(Mar 28 2022 at 15:09)</a>:</h4>
<p>That wouldn't really interact well with most of the rest of the rust universe, since it's a separate type. Most code would still only be for naturally aligned references</p>



<a name="276888488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276888488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Markus Grech <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276888488">(Mar 28 2022 at 15:14)</a>:</h4>
<p>That depends. If the alignment specifier is part of the reference then that's true, but it doesn't have to be.<br>
If it were part of the referencee type, then <code>&amp;T</code> can be unified with <code>&amp;align(N) U</code>.</p>



<a name="276888711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276888711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276888711">(Mar 28 2022 at 15:16)</a>:</h4>
<p>but <code>align(1)u32</code> is still also a separate type from <code>u32</code>, giving the same problem</p>



<a name="276888890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276888890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Markus Grech <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276888890">(Mar 28 2022 at 15:17)</a>:</h4>
<p>It is, but on the top-level the alignment specifier isn't really very meaningful since values are copied anyway. Do you have something in mind where this could be an issue?</p>



<a name="276889254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276889254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276889254">(Mar 28 2022 at 15:20)</a>:</h4>
<p>Well like you wouldn't be able to use += on a &amp;mut_align(1)u32 unless it was generated as a separate trait instance</p>



<a name="276889394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276889394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276889394">(Mar 28 2022 at 15:21)</a>:</h4>
<p>so that takes more compiler time and complexity to generate all these extra instances and functions as necessary.</p>



<a name="276889497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276889497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276889497">(Mar 28 2022 at 15:22)</a>:</h4>
<p>and any function that does <code>unsafe</code> stuff can't automatically have the variants because the unsafe might rely on the alignment, which limits how much you can do this quite a bit</p>



<a name="276889670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276889670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276889670">(Mar 28 2022 at 15:24)</a>:</h4>
<p>I really think the easiest solution is to just make a <code>read_unaligned!</code> macro that takes a field and then uses <code>addr_of!</code> and then reads the pointer unaligned. And similar for a <code>write_unaligned!</code> macro.</p>



<a name="276889854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276889854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Markus Grech <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276889854">(Mar 28 2022 at 15:25)</a>:</h4>
<p>Hmm, you are right that <code>+=</code> on a <code>&amp;mut align(1) u32</code> wouldn't work as is, though that can of course be fixed by making the code generic on alignment, but I agree that's not ideal<br>
Then again, I don't know why you would want to do that in the first place, since these underaligned values are meant mainly for use with packed structs, which usually aren't the data that you perform computation with</p>



<a name="276890004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276890004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Markus Grech <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276890004">(Mar 28 2022 at 15:26)</a>:</h4>
<p>It seems that Rust already has <a href="https://doc.rust-lang.org/std/ptr/fn.read_unaligned.html">https://doc.rust-lang.org/std/ptr/fn.read_unaligned.html</a></p>



<a name="276890728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276890728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276890728">(Mar 28 2022 at 15:31)</a>:</h4>
<p>Yes, the only complication is getting the pointer correctly, which addr_of does</p>



<a name="276890853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276890853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276890853">(Mar 28 2022 at 15:32)</a>:</h4>
<p>anyone can make the proposed <code>read_unaligned!</code> macro in normal library code using things the stdlib already provides</p>



<a name="276891146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276891146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276891146">(Mar 28 2022 at 15:34)</a>:</h4>
<p>adding a new reference type is a hard sell, especially when a macro will do</p>



<a name="276891286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276891286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276891286">(Mar 28 2022 at 15:35)</a>:</h4>
<p>note that when <code>addr_of!</code> was added it was done rather than stabilizing <code>&amp;raw</code></p>



<a name="276891332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276891332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Markus Grech <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276891332">(Mar 28 2022 at 15:35)</a>:</h4>
<p>Well like I said, I would not put the alignment on the reference, but on the referenced type, so that regular references work as is</p>



<a name="276891661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276891661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Markus Grech <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276891661">(Mar 28 2022 at 15:38)</a>:</h4>
<p>I suppose you could look at is as packed structs implicitly adding <code>align(1)</code> to the type of all fields</p>



<a name="276891879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276891879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276891879">(Mar 28 2022 at 15:39)</a>:</h4>
<p>But they'd be different types, right? You shouldn't be able to pass <code>&amp;align(1) u32</code> to a function that expects <code>&amp;u32</code>.</p>



<a name="276892445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276892445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Markus Grech <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276892445">(Mar 28 2022 at 15:44)</a>:</h4>
<p>That's correct, you couldn't pass a <code>&amp;align(1) u32</code> to a function expecting <code>&amp;u32</code>, but you could pass it to a generic function that expects <code>&amp;T</code>.</p>



<a name="276893019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276893019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mejrs <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276893019">(Mar 28 2022 at 15:48)</a>:</h4>
<p>Hmm I wonder whether that'd work. There's probably quite a bit of code out there relying on <code>T</code> being properly aligned</p>



<a name="276893285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276893285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276893285">(Mar 28 2022 at 15:50)</a>:</h4>
<p>I definitely expect &amp;T to have <code>align_of::&lt;T&gt;()</code> and have written unsafe code that would be broken if that failed to hold.</p>



<a name="276893339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276893339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276893339">(Mar 28 2022 at 15:51)</a>:</h4>
<p>I suppose in this case perhaps <code>T</code> is <code>align(1) u32</code> though?</p>



<a name="276893504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276893504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Markus Grech <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276893504">(Mar 28 2022 at 15:52)</a>:</h4>
<p>Oh yeah, I meant that in the case of passing <code>&amp;align(1) u32</code> to a generic function taking <code>&amp;T</code>, the <code>T</code> would take on the type <code>align(1) u32</code></p>



<a name="276893622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276893622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276893622">(Mar 28 2022 at 15:53)</a>:</h4>
<p>Having the alignment on the reference is the right place to do this.  It's like how <code>transmute&lt;[u8; 4], u32&gt;</code> is fine despite the different alignments, but <code>transmute&lt;&amp;[u8; 4], &amp;u32&gt;</code> isn't -- it's the indirection that makes the alignment relevant.</p>
<p>You could certainly imagine a world where there was even subtyping or coercions to allow you to pass an extra-aligned reference to something expecting a lower-aligned reference.  And then you could have <code>Simd::as_array</code> return an over-aligned reference to the <code>[T; N]</code>, for example.</p>
<p>But realistically, this isn't going to happen.  Just use a <code>&amp;Packed&lt;u32&gt;</code> with <code>#[repr(packed)] struct Packed(T);</code> if you really want that, or make a newtype around a pointer that has a const-generic alignment guarantee.</p>



<a name="276893678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276893678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276893678">(Mar 28 2022 at 15:53)</a>:</h4>
<p>Yeah this feels like it would be a huge addition to the language</p>



<a name="276893694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unaligned%20References/near/276893694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Unaligned.20References.html#276893694">(Mar 28 2022 at 15:53)</a>:</h4>
<p>that doesn't seem sufficiently motivated (since this kind of code is rare)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>