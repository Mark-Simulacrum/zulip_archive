<html>
<head><meta charset="utf-8"><title>Soundness of gpu fast math · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html">Soundness of gpu fast math</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269682655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269682655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269682655">(Jan 28 2022 at 03:43)</a>:</h4>
<p>So... i may have just realized one of my codegen flags may be unsound... oops<br>
I just wanted to ask though since its a pretty helpful flag. CUDA has approximate float instructions for things like recp, div, and sqrt, which can greatly speed up certain kernels. But im not sure if me adding support for that is sound, is it? I thought the problem was that the operations would not be applied globally, but in this case they <em>would</em>.</p>



<a name="269698012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269698012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269698012">(Jan 28 2022 at 07:50)</a>:</h4>
<p>Do we ever guarantee strict floating point arithmetic?</p>



<a name="269699042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269699042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269699042">(Jan 28 2022 at 08:01)</a>:</h4>
<p>A lot of the fast math flags introduce UB when a floating point number is eg NaN or Infinity.</p>



<a name="269713137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269713137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269713137">(Jan 28 2022 at 10:10)</a>:</h4>
<p>Hmm, for ½ULP things it's more sketchy to approximate them.</p>
<p><a class="stream" data-stream-id="257879" href="/#narrow/stream/257879-project-portable-simd">#project-portable-simd</a> is probably looking at how to expose the low-precision versions of these that come in SIMD, so maybe they'll set a precedent for special methods for these things?</p>
<p>It'd definitely make sense to me to have scalar <code>invsqrt_approx</code> and such methods...</p>



<a name="269750657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269750657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269750657">(Jan 28 2022 at 15:12)</a>:</h4>
<p>There has bean a lot of talk on internals about how to expose fast math <a href="https://internals.rust-lang.org/search?q=fast%20math">https://internals.rust-lang.org/search?q=fast%20math</a></p>



<a name="269801880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269801880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269801880">(Jan 28 2022 at 21:02)</a>:</h4>
<p>PTX approx instructions do not introduce UB for NaN/inf inputs AFAIK</p>



<a name="269801967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269801967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269801967">(Jan 28 2022 at 21:03)</a>:</h4>
<p>the effect is not really observable by llvm because it just replaces the normal stuff with <code>.approx</code> ptx instructions as far as i know</p>



<a name="269801986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269801986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269801986">(Jan 28 2022 at 21:03)</a>:</h4>
<p>so miscompilations can't happen i believe</p>



<a name="269802034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269802034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269802034">(Jan 28 2022 at 21:03)</a>:</h4>
<p>then you can probably introduce them as a codegen flag soundly. that said, i dont think a codegen flag is how we want this to work more broadly (i think <span class="user-mention" data-user-id="281757">@Jubilee</span> had a comment on IRLO that roughly mapped how i hope things will eventually work, although I'm having trouble locating it)</p>



<a name="269802144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269802144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269802144">(Jan 28 2022 at 21:04)</a>:</h4>
<p>but it also makes sense that this would be more important than average for a gpu backend.</p>



<a name="269802198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269802198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269802198">(Jan 28 2022 at 21:05)</a>:</h4>
<p>Yeah this is pretty important for gpus, since usually gpu programs contain millions of these sqrt/div ops</p>



<a name="269802215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269802215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269802215">(Jan 28 2022 at 21:05)</a>:</h4>
<p>and precise sqrt takes a lot of valuable registers</p>



<a name="269803151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269803151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269803151">(Jan 28 2022 at 21:13)</a>:</h4>
<p>yeah that makes sense</p>



<a name="269803614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269803614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269803614">(Jan 28 2022 at 21:16)</a>:</h4>
<p>testing my toy path tracer with fast div and fast sqrt, it seems to work fine without issues. Though obviously it is a small test case</p>



<a name="269803692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269803692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269803692">(Jan 28 2022 at 21:16)</a>:</h4>
<p>Isn't the main issue with fast-math the fact it touches unwanted things, like removing certain checks?</p>



<a name="269803726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269803726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269803726">(Jan 28 2022 at 21:17)</a>:</h4>
<p>with this flag it only affects the div and sqrt calculations</p>



<a name="269804351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269804351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269804351">(Jan 28 2022 at 21:22)</a>:</h4>
<p>if it uses <code>fast</code> &lt;<a href="https://llvm.org/docs/LangRef.html#fast-math-flags">https://llvm.org/docs/LangRef.html#fast-math-flags</a>&gt; it's unsound (because use of poison can produce UB) if it's passed a nan or an infinity, thought.</p>



<a name="269804634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269804634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269804634">(Jan 28 2022 at 21:24)</a>:</h4>
<p>It does not, it uses the fast_div and fast_sqrt libnvvm flags which replace some functions in <code>libdevice</code> (gpu libm) with <code>sqrt.approx</code> ptx instructions</p>



<a name="269841984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269841984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269841984">(Jan 29 2022 at 05:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math/near/269803692">said</a>:</p>
<blockquote>
<p>Isn't the main issue with fast-math the fact it touches unwanted things, like removing certain checks?</p>
</blockquote>
<p>Well part of the problem is that in the past it's been discussed as a <em>compiler flag</em>, as in a global flag which is applied to all units of the compilation, even units that aren't expecting an approximation will be applied to them. This can potentially make a library suddenly have issues.</p>
<p>If it's limited to particular alternate f32 methods (such as how fused multiply-add works) that would be one way to make things a lot easier to manage.</p>



<a name="269963027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269963027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269963027">(Jan 30 2022 at 22:55)</a>:</h4>
<p>What is the actual spec for the operations in question vs. when they are replaced?</p>



<a name="269963124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269963124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269963124">(Jan 30 2022 at 22:57)</a>:</h4>
<p>I am, broadly speaking, not that concerned about "the call stretches an ULP wider than expected".<br>
Though, maybe I should be for division.<br>
The question is, does it allow things like reassociation? It seems the answer is not? But what rules <strong>are</strong> these new ops bound by instead?</p>



<a name="269963139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269963139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269963139">(Jan 30 2022 at 22:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361356">fee1-dead</span> <a href="#narrow/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math/near/269698012">said</a>:</p>
<blockquote>
<p>Do we ever guarantee strict floating point arithmetic?</p>
</blockquote>
<p>We do, implicitly, by stating our floats are IEEE754-2008's <code>binary32</code> and <code>binary64</code>.</p>
<p>By actually including-by-reference IEEE754, we pretty much commit ourselves to a fairly strict interpretation of floating point operations. The rules of iEEE754 are somewhat more permissive than people think in places but can be pretty damn strict in a few places people whine the most about.</p>



<a name="269964452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269964452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269964452">(Jan 30 2022 at 23:24)</a>:</h4>
<p>To weigh in with my Mini-Kahan hat actually on:</p>
<p>Because square root is potentially lowered as a library function, I think it's reasonable to approximate it. However, I would really rather that it is <strong>consistent</strong>. If you are telling me that all CUDA GPUs will return the same result from <code>fast_sqrt</code> for a given value, it just is "sloppily" calculated (but in the same way every time) then actually I am pretty in favor. For instance, I am somewhat against using the x86-64 <code>rcpss</code> instruction because AMD and Intel differ on this.</p>



<a name="269964538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269964538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269964538">(Jan 30 2022 at 23:26)</a>:</h4>
<p>However, it's probably pretty bad to cheap out on division, unfortunately.</p>



<a name="269965012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269965012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269965012">(Jan 30 2022 at 23:37)</a>:</h4>
<p>But, in either case, I would like to know what actually we would be agreeing to, essentially.<br>
I think allowing this as an opt-in with a codegen flag would be OK, regardless, but I agree with Thom that we would ideally want to use a Proper approach. The catch is that I say this because a codegen flag is implicitly <code>unsafe</code>. I am not saying this is necessarily a good idea, I am saying that you are allowed to have codegen flags that give Rust programs UB!</p>
<p>And also because philosophically, "you should do this as precisely as you can afford, but you may offer an opt-in to a slightly faster or more imprecise version" is mentioned a few times in IEEE754's later versions.</p>



<a name="269979681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269979681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269979681">(Jan 31 2022 at 04:46)</a>:</h4>
<p><span class="user-mention" data-user-id="281757">@Jubilee</span> It is replaced when calling the libdevice functions provided by the libdevice llvm bitcode file. But only when you pass <code>-prec-sqrt</code> and <code>-prec-div</code> to libnvvm (i think thats what theyre called). You can technically call sqrt urself  by just using inline ptx assembly but realistically nobody will do that</p>



<a name="269979704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269979704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269979704">(Jan 31 2022 at 04:47)</a>:</h4>
<p>as for the spec of how it works, u can find more info <a href="https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#floating-point-instructions-sqrt">here</a></p>



<a name="269979724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269979724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269979724">(Jan 31 2022 at 04:47)</a>:</h4>
<p><a href="/user_uploads/4715/fPc9LzUdnCOF1MRbLNYRuGIU/Screenshot_576.png">Screenshot_576.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/fPc9LzUdnCOF1MRbLNYRuGIU/Screenshot_576.png" title="Screenshot_576.png"><img src="/user_uploads/4715/fPc9LzUdnCOF1MRbLNYRuGIU/Screenshot_576.png"></a></div>



<a name="269979803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269979803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269979803">(Jan 31 2022 at 04:48)</a>:</h4>
<p>and div: </p>
<div class="codehilite"><pre><span></span><code>div.approx.f32 implements a fast approximation to divide, computed as d = a * (1/b). For |b| in [2-126, 2126], the maximum ulp error is 2. For 2126 &lt; |b| &lt; 2128, if a is infinity, div.approx.f32 returns NaN, otherwise it returns 0.
div.full.f32 implements a relatively fast, full-range approximation that scales operands to achieve better accuracy, but is not fully IEEE 754 compliant and does not support rounding modifiers. The maximum ulp error is 2 across the full range of inputs.
Subnormal inputs and results are flushed to sign-preserving zero. Fast, approximate division by zero creates a value of infinity (with same sign as a).
</code></pre></div>



<a name="269979822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269979822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269979822">(Jan 31 2022 at 04:49)</a>:</h4>
<p>There seems to be nothing about UB on subnormal inputs, only that it returns NaN on subnormal inputs</p>



<a name="269979832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269979832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269979832">(Jan 31 2022 at 04:49)</a>:</h4>
<p>so it seems to be much saner than normal fast math, which is why i added it</p>



<a name="269979908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/269979908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#269979908">(Jan 31 2022 at 04:50)</a>:</h4>
<p>Oh and in particular, the codegen replaces calls to <code>libm</code> with calls to libdevice by default, so anything using libm will be using libdevice and therefore a fast approximation if fast_sqrt/div is turned on</p>



<a name="270102328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270102328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270102328">(Jan 31 2022 at 20:49)</a>:</h4>
<p><code>sqrt.approx.f32</code> returns a zero on subnormals, actually, that's much better.</p>



<a name="270102837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270102837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270102837">(Jan 31 2022 at 20:53)</a>:</h4>
<p>they don't specify the maximum absolute or relative error for <code>sqrt.approx</code>?</p>



<a name="270102873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270102873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270102873">(Jan 31 2022 at 20:53)</a>:</h4>
<p>Dont think so</p>



<a name="270103139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270103139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270103139">(Jan 31 2022 at 20:55)</a>:</h4>
<p>Annoying.<br>
And the div.approx.f32 and div.full.f32 have a 2ulp margin, at least, within a range for <code>approx</code>.</p>



<a name="270479652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270479652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270479652">(Feb 03 2022 at 00:08)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> I double-checked a few things and I don't think using <code>div.approx</code> is appropriate, unfortunately: according to their spec, it can give very wrong answers and actually generate <strong>more NaNs</strong> than otherwise, which is... usually not what programmers want. <code>div.full</code> doesn't give enough information to fairly judge it, either.</p>



<a name="270479685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270479685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270479685">(Feb 03 2022 at 00:08)</a>:</h4>
<p>I see</p>



<a name="270479699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270479699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270479699">(Feb 03 2022 at 00:08)</a>:</h4>
<p>Yeah approx div is much rarer than sqrt anyways</p>



<a name="270479722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270479722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270479722">(Feb 03 2022 at 00:09)</a>:</h4>
<p>Though i dont think approx div is <em>unsound</em> is it?</p>



<a name="270479750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270479750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270479750">(Feb 03 2022 at 00:09)</a>:</h4>
<p>That depends on what your definition of unsound is. :^)</p>



<a name="270479766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270479766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270479766">(Feb 03 2022 at 00:09)</a>:</h4>
<p>stuff goes kaboom in a not so fun way</p>



<a name="270479857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270479857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270479857">(Feb 03 2022 at 00:10)</a>:</h4>
<p>Shame that <span aria-label="boom" class="emoji emoji-1f4a5" role="img" title="boom">:boom:</span> was removed from I-unsound <span aria-label="pensive" class="emoji emoji-1f614" role="img" title="pensive">:pensive:</span></p>



<a name="270480632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270480632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270480632">(Feb 03 2022 at 00:19)</a>:</h4>
<p>Mmm.<br>
I would say "generates NaNs on an otherwise-valid division" is probably unsound then in that sense, yes.<br>
In a formal or Rust sense, "does it breach the  <code>unsafe</code> contract?" the answer is "probably not", but that is entirely because the way floating point works makes basically everything "well-defined". It makes it monstrously easier to commit logic errors, however.</p>



<a name="270481537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270481537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270481537">(Feb 03 2022 at 00:29)</a>:</h4>
<p>The <code>sqrt.approx</code> operation only has the quirk of the "denormals are zero"-like behavior, but that doesn't introduce any more NaNs, it just suppresses NaNs in the case of a negative subnormal input. I don't expect anyone actually cares about that.</p>



<a name="270482882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270482882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270482882">(Feb 03 2022 at 00:43)</a>:</h4>
<p>At the very least, adding more NaNs opens the door for programs that render images that look like this to the screen: <a href="/user_uploads/4715/zVmxE7NlahqNrLkmi-w4J_w4/lovely_nan_coloring.png">lovely_nan_coloring.png</a> <br>
which is kind of the opposite of what we would want~</p>
<div class="message_inline_image"><a href="/user_uploads/4715/zVmxE7NlahqNrLkmi-w4J_w4/lovely_nan_coloring.png" title="lovely_nan_coloring.png"><img src="/user_uploads/4715/zVmxE7NlahqNrLkmi-w4J_w4/lovely_nan_coloring.png"></a></div>



<a name="270496883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270496883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270496883">(Feb 03 2022 at 03:49)</a>:</h4>
<p>its not a bug its a feature</p>



<a name="270872090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270872090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270872090">(Feb 06 2022 at 05:55)</a>:</h4>
<p>Generally soundness in rust is about causing undefined behavior from safe code. But there are tons of ways you can pass dubious flags to compilers to get it to produce things that are not safe to run.</p>



<a name="270872245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270872245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270872245">(Feb 06 2022 at 05:59)</a>:</h4>
<p>for sure a few of the weirder -C ones are (llvm-args, passes, definitely anything involving linking, in some sense target-{cpu,feature}...), but <code>-Zsaturating-float-casts=no</code> is clearly unsound</p>



<a name="270872384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/270872384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#270872384">(Feb 06 2022 at 06:00)</a>:</h4>
<p>I think this seems fine though (so long as it doesnt migrate to other backends...)</p>



<a name="271040521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Soundness%20of%20gpu%20fast%20math/near/271040521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Soundness.20of.20gpu.20fast.20math.html#271040521">(Feb 07 2022 at 20:56)</a>:</h4>
<p>Yeah, that's why I drew the line the way I did, on "you <strong>probably</strong> shouldn't do the thing that <strong>adds</strong> NaNs if you want code to 'not go boom', but it probably wouldn't be """unsound""" in the technical sense."</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>