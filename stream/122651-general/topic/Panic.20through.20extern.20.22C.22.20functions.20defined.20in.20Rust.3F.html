<html>
<head><meta charset="utf-8"><title>Panic through extern &quot;C&quot; functions defined in Rust? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Panic.20through.20extern.20.22C.22.20functions.20defined.20in.20Rust.3F.html">Panic through extern &quot;C&quot; functions defined in Rust?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275803060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Panic%20through%20extern%20%22C%22%20functions%20defined%20in%20Rust%3F/near/275803060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Raekye <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Panic.20through.20extern.20.22C.22.20functions.20defined.20in.20Rust.3F.html#275803060">(Mar 18 2022 at 13:37)</a>:</h4>
<p>The documentation for <a href="https://doc.rust-lang.org/std/panic/fn.catch_unwind.html"><code>catch_unwind</code></a> says</p>
<blockquote>
<p>It is currently undefined behavior to unwind from Rust code into foreign code,</p>
</blockquote>
<p>In the latest update, issue <a href="https://github.com/rust-lang/rust/issues/52652">#52652</a> says that with <a href="https://github.com/rust-lang/rust/pull/76570">#76570</a> merged, panics through an <code>extern "C"</code> function defined in Rust should abort (also see <a href="https://github.com/rust-lang/rust/issues/52652#issuecomment-798920235">this comment</a> at the bottom of <a href="https://github.com/rust-lang/rust/issues/52652">#52652</a>). Otherwise it would be possible to have UB with only safe code</p>
<p>I tried to test it: <a href="https://rust.godbolt.org/z/4xvqrqdoh">Godbolt link</a>, but it doesn't match my understanding. In the assembly, <code>main</code> does call <code>foo</code> (not inlined as far as I can tell), which is defined as <code>extern "C"</code>. <code>foo</code> fails an assert in the execution, which I thought should abort the process when it tries to unwind past itself. But the drop message for the <code>_d: Dropper</code> in <code>main</code> still gets printed, presumably meaning <code>main</code> got unwound</p>
<p>What's going on here?</p>



<a name="275804685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Panic%20through%20extern%20%22C%22%20functions%20defined%20in%20Rust%3F/near/275804685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Panic.20through.20extern.20.22C.22.20functions.20defined.20in.20Rust.3F.html#275804685">(Mar 18 2022 at 13:49)</a>:</h4>
<p>This is technically undefined behaviour. I asked about it <a href="#narrow/stream/210922-project-ffi-unwind/topic/.60extern.22C.22.60.20and.20unwinding">in project-ffi-unwind</a>. And yes, this is a case of fundamental (language) unsoundness.</p>



<a name="275804821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Panic%20through%20extern%20%22C%22%20functions%20defined%20in%20Rust%3F/near/275804821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Panic.20through.20extern.20.22C.22.20functions.20defined.20in.20Rust.3F.html#275804821">(Mar 18 2022 at 13:50)</a>:</h4>
<p>I don't believe rustc does much of anything to unwinding <code>extern "C"</code> functions, though.</p>



<a name="275806162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Panic%20through%20extern%20%22C%22%20functions%20defined%20in%20Rust%3F/near/275806162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Panic.20through.20extern.20.22C.22.20functions.20defined.20in.20Rust.3F.html#275806162">(Mar 18 2022 at 14:00)</a>:</h4>
<p>Starting with PR <a href="https://github.com/rust-lang/rust/pull/86155">https://github.com/rust-lang/rust/pull/86155</a>, the "C" Abi is temporarily equivalent to the "C-unwind" Abi until the "C-unwind" is stabilized. See this <a href="https://github.com/rust-lang/rust/pull/86155#issuecomment-893498147">comment</a> for more informations.</p>



<a name="275807613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Panic%20through%20extern%20%22C%22%20functions%20defined%20in%20Rust%3F/near/275807613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Panic.20through.20extern.20.22C.22.20functions.20defined.20in.20Rust.3F.html#275807613">(Mar 18 2022 at 14:11)</a>:</h4>
<p>Oh that was implemented already? Nice.</p>



<a name="275846158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Panic%20through%20extern%20%22C%22%20functions%20defined%20in%20Rust%3F/near/275846158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Panic.20through.20extern.20.22C.22.20functions.20defined.20in.20Rust.3F.html#275846158">(Mar 18 2022 at 18:44)</a>:</h4>
<p>So what actually <em>happens</em> when you unwind through an <code>extern "C"</code> nowadays?</p>



<a name="275846495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Panic%20through%20extern%20%22C%22%20functions%20defined%20in%20Rust%3F/near/275846495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Panic.20through.20extern.20.22C.22.20functions.20defined.20in.20Rust.3F.html#275846495">(Mar 18 2022 at 18:47)</a>:</h4>
<p>With the c unwind feature gate disabled, it won't prevent unwinding but allows UB I believe. This is to avoid breaking existing crates that need it. With the c unwind feature gate enabled it aborts AFAIK.</p>



<a name="275861261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Panic%20through%20extern%20%22C%22%20functions%20defined%20in%20Rust%3F/near/275861261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Panic.20through.20extern.20.22C.22.20functions.20defined.20in.20Rust.3F.html#275861261">(Mar 18 2022 at 20:53)</a>:</h4>
<p>Then I don't understand the linked PR. </p>
<blockquote>
<p>Before this PR Rust has been unsound</p>
</blockquote>
<p>So, that's the UB. Presumably <em>after</em> the PR the soundness issue is fixed.</p>
<blockquote>
<p>The fix in this PR is somewhat nuanced. The blunt explanation is that rustc assumes that <code>extern "C"</code> can unwind for now, unlike before. This means that the <code>nounwind</code> attribute is not applied to the <code>foo</code> function above <strong>which means it works correctly</strong>. [emphasis mine]</p>
</blockquote>



<a name="275861326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Panic%20through%20extern%20%22C%22%20functions%20defined%20in%20Rust%3F/near/275861326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Panic.20through.20extern.20.22C.22.20functions.20defined.20in.20Rust.3F.html#275861326">(Mar 18 2022 at 20:54)</a>:</h4>
<p>I read that as "today's compiler won't cause UB" for </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="fm">panic!</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">foo</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>