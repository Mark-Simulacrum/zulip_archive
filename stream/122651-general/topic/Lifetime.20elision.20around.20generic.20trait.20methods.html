<html>
<head><meta charset="utf-8"><title>Lifetime elision around generic trait methods · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Lifetime.20elision.20around.20generic.20trait.20methods.html">Lifetime elision around generic trait methods</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268939566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Lifetime%20elision%20around%20generic%20trait%20methods/near/268939566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Hodge (Mutabah) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Lifetime.20elision.20around.20generic.20trait.20methods.html#268939566">(Jan 22 2022 at 05:52)</a>:</h4>
<p>I'm working on implementing lifetime annotations in mrustc, and using the nomicon as a reference to how lifetime elision works. Found an example that doesn't quite match the as-documented rules  (I asked this over on Discord, was directed here - considering also opening an issue on the nomicon repository)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">T</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Baz</span><span class="p">;</span><span class="w"></span>
<span class="c1">// Elision expands to `impl&lt;'a&gt; Foo&lt;&amp;'a i32&gt; for Baz`</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;&amp;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Baz</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Lifetime elision rules say that this should become:</span>
<span class="w">    </span><span class="c1">// `fn foo&lt;'s, 'b&gt;(&amp;'s self, _bar: &amp;'b i32)`</span>
<span class="w">    </span><span class="c1">// but looks like it becomes</span>
<span class="w">    </span><span class="c1">// `fn foo&lt;'s&gt;(&amp;'s self, _bar: &amp;'a i32)` (where `'a` is elided in impl header)</span>
<span class="w">    </span><span class="c1">// so that the function matches the signature.</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_bar</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="268943977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Lifetime%20elision%20around%20generic%20trait%20methods/near/268943977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Lifetime.20elision.20around.20generic.20trait.20methods.html#268943977">(Jan 22 2022 at 07:45)</a>:</h4>
<p>What gives you the impression that it uses the lifetime of the trait parameter?</p>
<p>Also, this compiles in rustc:<br>
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=4a60c17db1cdd81a88e8b66f9d05ece8">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=4a60c17db1cdd81a88e8b66f9d05ece8</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="nc">T</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Baz</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;&amp;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Baz</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;'</span><span class="na">x</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">y</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">x</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_bar</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">y</span> <span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>My guess for why this works is that methods in implementations can be more permissive than in the trait.</p>



<a name="268944096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Lifetime%20elision%20around%20generic%20trait%20methods/near/268944096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Hodge (Mutabah) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Lifetime.20elision.20around.20generic.20trait.20methods.html#268944096">(Jan 22 2022 at 07:48)</a>:</h4>
<p>Hmm... I was assuming that the trait signature had to match exactly.</p>



<a name="268944309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Lifetime%20elision%20around%20generic%20trait%20methods/near/268944309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Lifetime.20elision.20around.20generic.20trait.20methods.html#268944309">(Jan 22 2022 at 07:54)</a>:</h4>
<p>you can have the impl be more permissive but i dont think it does anything(?) ^^'</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Baz</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;'</span><span class="na">x</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">y</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">x</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_bar</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">y</span> <span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">blah</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10_</span><span class="k">i32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Baz</span><span class="p">.</span><span class="n">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blah</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>errors saying <code>blah</code> doesnt live for <code>'static</code></p>



<a name="268944382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Lifetime%20elision%20around%20generic%20trait%20methods/near/268944382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Hodge (Mutabah) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Lifetime.20elision.20around.20generic.20trait.20methods.html#268944382">(Jan 22 2022 at 07:55)</a>:</h4>
<p>Current mrustc impl (hacked up since the original message) just copies the lifetime annotations from the trait (after checking that everything else matches).<br>
Maybe rustc does the same (or something very similar)</p>



<a name="268948076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Lifetime%20elision%20around%20generic%20trait%20methods/near/268948076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Lifetime.20elision.20around.20generic.20trait.20methods.html#268948076">(Jan 22 2022 at 09:25)</a>:</h4>
<p>You're allowed to <code>impl</code> a trait with more-permissive lifetimes than the trait.  So if the method has an unconstrained lifetime parameter, that's ok for a parameter even if it's not forced to match some other lifetime.</p>



<a name="268948129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Lifetime%20elision%20around%20generic%20trait%20methods/near/268948129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Lifetime.20elision.20around.20generic.20trait.20methods.html#268948129">(Jan 22 2022 at 09:26)</a>:</h4>
<p>I bet if you change the trait method to return <code>Self</code> too then <code>-&gt; &amp;i32</code> in the impl will stop working.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>