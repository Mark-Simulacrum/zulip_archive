<html>
<head><meta charset="utf-8"><title>*mut Foo([u8]) to *mut u8 without ref · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html">*mut Foo([u8]) to *mut u8 without ref</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277659089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277659089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277659089">(Apr 03 2022 at 20:22)</a>:</h4>
<p>Heya. I have a <code>MaybeUninit&lt;UnsafeCell&lt;Foo&gt;&gt;</code> where <code>Foo([u8; N])</code>, and I'm trying to go from a <code>*mut Foo</code> to a <code>*mut u8</code>, is there a good way to do this, I don't want to create an intermediate reference</p>



<a name="277659191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277659191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277659191">(Apr 03 2022 at 20:24)</a>:</h4>
<p>Is <code>Foo</code> marked <code>#[repr(transparent)]</code>?</p>



<a name="277659211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277659211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277659211">(Apr 03 2022 at 20:24)</a>:</h4>
<p>Sadly I need <code>align(4096)</code> on it, it's why I'm using the wrapper structure in the first place. Unless there's a better way to have a strictly aligned <code>[u8; N]</code></p>



<a name="277660052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277660052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277660052">(Apr 03 2022 at 20:44)</a>:</h4>
<p>I assume that <code>core::ptr::addr_of!((*foo).0)</code> to get the pointer to the <code>.0</code> field is UB if <code>foo</code> is uninit?</p>



<a name="277660123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277660123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277660123">(Apr 03 2022 at 20:46)</a>:</h4>
<p>I don't fully understand the temporary semantics of <code>addr_of!</code>, but given it cannot take an address of a temporary value it might be right here?</p>



<a name="277660218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277660218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277660218">(Apr 03 2022 at 20:49)</a>:</h4>
<p>Ah, example <a href="https://github.com/rust-lang/rust/issues/2">#2</a> under <code>addr_of_mut!</code> is doing exactly what I want, awesome</p>



<a name="277661482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277661482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277661482">(Apr 03 2022 at 21:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="356799">Brandon Falk</span> <a href="#narrow/stream/122651-general/topic/*mut.20Foo.28.5Bu8.5D.29.20to.20*mut.20u8.20without.20ref/near/277660052">said</a>:</p>
<blockquote>
<p>I assume that <code>core::ptr::addr_of!((*foo).0)</code> to get the pointer to the <code>.0</code> field is UB if <code>foo</code> is uninit?</p>
</blockquote>
<p>It should be valid as long as <code>foo</code> is a valid pointer</p>



<a name="277661487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277661487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277661487">(Apr 03 2022 at 21:14)</a>:</h4>
<p>Btw you can mix <code>C</code> and <code>align</code> <code>repr</code>s</p>



<a name="277661502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277661502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277661502">(Apr 03 2022 at 21:15)</a>:</h4>
<p>Yeah, I have it <code>repr(C)</code> but I still kinda don't like the weird casting, nevertheless</p>



<a name="277661506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277661506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277661506">(Apr 03 2022 at 21:15)</a>:</h4>
<p><a href="https://doc.rust-lang.org/stable/std/ptr/macro.addr_of_mut.html">https://doc.rust-lang.org/stable/std/ptr/macro.addr_of_mut.html</a><br>
Documented example <a href="https://github.com/rust-lang/rust/issues/2">#2</a> "Creating a pointer to uninitialized data" is exactly this case</p>



<a name="277661552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277661552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277661552">(Apr 03 2022 at 21:16)</a>:</h4>
<p>I wish the documentation on <code>addr_of_mut</code> was maybe a bit more clear, but this example shows exactly what I'm doing. Looks like it's fine as the deref never happens, nor does an intermediate reference, and a pointer to uninit data is allowed</p>



<a name="277811890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277811890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277811890">(Apr 05 2022 at 00:24)</a>:</h4>
<p>if it's repr C you can just plain cast the pointer</p>



<a name="277811981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%2Amut%20Foo%28%5Bu8%5D%29%20to%20%2Amut%20u8%20without%20ref/near/277811981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/*mut.20Foo(.5Bu8.5D).20to.20*mut.20u8.20without.20ref.html#277811981">(Apr 05 2022 at 00:25)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">MaybeUninit</span>::<span class="n">as_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">).</span><span class="n">cast</span>::<span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">]</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>