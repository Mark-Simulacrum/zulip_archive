<html>
<head><meta charset="utf-8"><title>compiling rustc with LTO · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html">compiling rustc with LTO</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276419739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276419739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276419739">(Mar 24 2022 at 00:18)</a>:</h4>
<p>I looked through <code>config.toml.example</code> and <code>Cargo.toml</code> to try to find where I can configure LTO for a rustc build, but couldn't find anything besides the LLVM LTO setting.</p>
<p>So two questions:</p>
<ol>
<li>How can I compile rustc with LTO (thin or fat)?</li>
<li>Is compiling rustc with LTO (thin or fat) even advisable? Are the crates structured in such a way that LTO likely wouldn't provide that much benefit?</li>
</ol>



<a name="276420587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276420587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276420587">(Mar 24 2022 at 00:32)</a>:</h4>
<p>not sure the answer to either question, but I see this comment in <a href="http://compile.rs">compile.rs</a> which makes me think it's possible:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="c1">// By default, rustc uses `-Cembed-bitcode=yes`, and Cargo overrides that</span>
<span class="w">    </span><span class="c1">// with `-Cembed-bitcode=no` for non-LTO builds. However, libstd must be</span>
<span class="w">    </span><span class="c1">// built with bitcode so that the produced rlibs can be used for both LTO</span>
<span class="w">    </span><span class="c1">// builds (which use bitcode) and non-LTO builds (which use object code).</span>
<span class="w">    </span><span class="c1">// So we override the override here!</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// But we don't bother for the stage 0 compiler because it's never used</span>
<span class="w">    </span><span class="c1">// with LTO.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">cargo</span><span class="p">.</span><span class="n">rustflag</span><span class="p">(</span><span class="s">"-Cembed-bitcode=yes"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276420889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276420889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276420889">(Mar 24 2022 at 00:39)</a>:</h4>
<p>I am curious as to why you want to do this, as the rustc that is shipped via rustup is already compiled with extensive tuning re: LTO and PGO.</p>



<a name="276420989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276420989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276420989">(Mar 24 2022 at 00:40)</a>:</h4>
<p>I'm trying to think of ways to squeeze every last bit of performance out of rustc.</p>
<blockquote>
<p>rustc is already compiled with extensive tuning re: LTO and PGO</p>
</blockquote>
<p>Can you point me to where I can learn more about this? I know a tiny bit about the PGO that is done in CI, but nothing about "tuning" for LTO</p>



<a name="276421018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276421018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276421018">(Mar 24 2022 at 00:41)</a>:</h4>
<p>I am referring to that activity itself as tuning.</p>



<a name="276421075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276421075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276421075">(Mar 24 2022 at 00:42)</a>:</h4>
<p>which activity exactly? i don't follow</p>



<a name="276421119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276421119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276421119">(Mar 24 2022 at 00:43)</a>:</h4>
<blockquote>
<p>I'm trying to think of ways to squeeze every last bit of performance out of rustc.</p>
</blockquote>



<a name="276421430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276421430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276421430">(Mar 24 2022 at 00:48)</a>:</h4>
<p>We compile rustc from source at work so I'd like to at least achieve the same performance as the rustc from rustup</p>



<a name="276421454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276421454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276421454">(Mar 24 2022 at 00:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276420989">said</a>:</p>
<blockquote>
<p>I'm trying to think of ways to squeeze every last bit of performance out of rustc.</p>
<blockquote>
<p>rustc is already compiled with extensive tuning re: LTO and PGO</p>
</blockquote>
<p>Can you point me to where I can learn more about this? I know a tiny bit about the PGO that is done in CI, but nothing about "tuning" for LTO</p>
</blockquote>
<p>don't know if it's documented anywhere, but the code is in <a href="https://github.com/rust-lang/rust/blob/master/src/ci/pgo.sh">https://github.com/rust-lang/rust/blob/master/src/ci/pgo.sh</a></p>



<a name="276421591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276421591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276421591">(Mar 24 2022 at 00:50)</a>:</h4>
<p>Cool, that covers the PGO side of things, but still leaves me wondering what is done regarding LTO for rustup builds</p>



<a name="276421636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276421636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276421636">(Mar 24 2022 at 00:51)</a>:</h4>
<p>Or maybe there's some lapse in my understanding, like LTO automatically happens when you're compiling with PGO data or something</p>



<a name="276421638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276421638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276421638">(Mar 24 2022 at 00:51)</a>:</h4>
<p>yeah, not sure. maybe LTO is unconditionally on?</p>



<a name="276421718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276421718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276421718">(Mar 24 2022 at 00:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> would know for sure - we're trying to figure how to enable LTO / under what conditions it's enabled</p>



<a name="276421759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276421759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276421759">(Mar 24 2022 at 00:53)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/beb480d908f091e7c42c866e13641f26b2ee230b/src/bootstrap/compile.rs#L656">https://github.com/rust-lang/rust/blob/beb480d908f091e7c42c866e13641f26b2ee230b/src/bootstrap/compile.rs#L656</a> looks relevant</p>



<a name="276421779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276421779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276421779">(Mar 24 2022 at 00:53)</a>:</h4>
<p>don't see LTO mentioned there though</p>



<a name="276422258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422258">(Mar 24 2022 at 01:01)</a>:</h4>
<p>I believe thinlto is default enabled (per crate) and we don't do anything beyond that for rustup distributed builds.</p>



<a name="276422287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422287">(Mar 24 2022 at 01:01)</a>:</h4>
<p>But we don't do whole crate graph lto (thin or fat) in CI today.</p>



<a name="276422353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422353">(Mar 24 2022 at 01:02)</a>:</h4>
<p>Do you alter the thread count for building the distributed rustc?</p>



<a name="276422356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422356">(Mar 24 2022 at 01:02)</a>:</h4>
<p>might be nice to add eventually :)</p>



<a name="276422385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422385">(Mar 24 2022 at 01:03)</a>:</h4>
<p>(note that "distributed rustc" is exactly the same as "rustc built in CI" - the release process just uplifts the most recent build to nightly)</p>



<a name="276422388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422388">(Mar 24 2022 at 01:03)</a>:</h4>
<p>I don't know what you mean by altering thread count.</p>



<a name="276422393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422393">(Mar 24 2022 at 01:03)</a>:</h4>
<p>Cool, thanks for chiming in Mark. Can you clarify how "thinlto per crate" would differ from "whole crate graph thinlto"? I guess what I don't understand is how any LTO happens in a single crate</p>



<a name="276422461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422461">(Mar 24 2022 at 01:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276422388">said</a>:</p>
<blockquote>
<p>I don't know what you mean by altering thread count.</p>
</blockquote>
<p>Err, I mean whether it's built with multiple jobs or not, since that tends to affect things.</p>



<a name="276422478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422478">(Mar 24 2022 at 01:04)</a>:</h4>
<p>rustc defaults to splitting up a crate's codegen into 16 units, and those each are optimized independently by LLVM; we then merge them with ThinLTO. But that means that there's no intercrate lto.</p>



<a name="276422483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422483">(Mar 24 2022 at 01:04)</a>:</h4>
<p>ahhh.</p>



<a name="276422509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422509">(Mar 24 2022 at 01:05)</a>:</h4>
<p>Parallelism shouldn't matter; the CGU count will. We build std/core etc in CI with just one CGU.</p>



<a name="276422514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422514">(Mar 24 2022 at 01:05)</a>:</h4>
<p>Ohh okay.</p>



<a name="276422575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422575">(Mar 24 2022 at 01:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276422509">said</a>:</p>
<blockquote>
<p>Parallelism shouldn't matter; the CGU count will. We build std/core etc in CI with just one CGU.</p>
</blockquote>
<p>Should I be doing this too then? I'm starting to feel like there's quite a few "perf polish" things done in CI that aren't well communicated to from-source users.</p>



<a name="276422578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422578">(Mar 24 2022 at 01:06)</a>:</h4>
<p>In practice compile times are dominated by linking, so if you want to cut compile times, uhhh a lot of people like using mold?</p>



<a name="276422592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422592">(Mar 24 2022 at 01:06)</a>:</h4>
<p>that is a <em>very</em> broad statement lol</p>



<a name="276422632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422632">(Mar 24 2022 at 01:07)</a>:</h4>
<p>We compile all crates as dylibs for debug builds, so actual compile time should be our bottleneck for edit-build-debug loops.</p>



<a name="276422639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422639">(Mar 24 2022 at 01:07)</a>:</h4>
<p>oh okay.</p>



<a name="276422640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422640">(Mar 24 2022 at 01:07)</a>:</h4>
<p>You can try just setting <code>lto='thin'</code> in the root <code>Cargo.toml</code> profile.  Give it a shot and see what happens.  I'd be impressed if it works.</p>



<a name="276422654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422654">(Mar 24 2022 at 01:07)</a>:</h4>
<p>I'm curious if anybody has any "gut feel" for whether whole crate graph LTO (thin or fat) would yield decent benefit.</p>



<a name="276422707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422707">(Mar 24 2022 at 01:08)</a>:</h4>
<p>I would expect it to have an impact, yeah. Shouldn't be terribly hard to test Eric's idea though</p>



<a name="276422724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422724">(Mar 24 2022 at 01:08)</a>:</h4>
<p>on it</p>



<a name="276422729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422729">(Mar 24 2022 at 01:08)</a>:</h4>
<p>src/CI/run.sh, src/CI/pgo.sh, and src/CI/docker/host-x86_64/dist-x86_64-linux are the three files you most likely need to read to get a sense of what we configure, though it requires a bit of undocumented (though somewhat obvious imo) knowledge to know what specifically is being run from <a href="http://run.sh">run.sh</a></p>



<a name="276422732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422732">(Mar 24 2022 at 01:09)</a>:</h4>
<p>(I may have slightly mangled paths: on mobile).</p>



<a name="276422749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422749">(Mar 24 2022 at 01:09)</a>:</h4>
<p>Yeah, I think so.<br>
You can't build all the rustc bits and statically link them together in practice, but the bits you can't statically link are ones you generally don't want to try to statically link anyways.</p>



<a name="276422755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422755">(Mar 24 2022 at 01:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120518">Eric Huss</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276422640">said</a>:</p>
<blockquote>
<p>You can try just setting <code>lto='thin'</code> in the root <code>Cargo.toml</code> profile.  Give it a shot and see what happens.  I'd be impressed if it works.</p>
</blockquote>
<p>Under <code>[profile.dev]</code>?</p>



<a name="276422766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422766">(Mar 24 2022 at 01:09)</a>:</h4>
<p>whichever you want to have LTO :) probably <code>profile.release</code></p>



<a name="276422857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422857">(Mar 24 2022 at 01:11)</a>:</h4>
<p>Yea, <code>[profile.release]</code></p>



<a name="276422937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422937">(Mar 24 2022 at 01:13)</a>:</h4>
<p>i actually have never compiled release using <code>x.py</code>. <code>build --help</code> doesn't seem to reveal how to do that</p>



<a name="276422942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422942">(Mar 24 2022 at 01:13)</a>:</h4>
<p>release is the default</p>



<a name="276422944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422944">(Mar 24 2022 at 01:13)</a>:</h4>
<p>swag</p>



<a name="276422945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422945">(Mar 24 2022 at 01:13)</a>:</h4>
<p>Oh, I forgot dylibs don't support LTO. <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="276422957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276422957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276422957">(Mar 24 2022 at 01:13)</a>:</h4>
<p>cargo's dev profile is <code>optimize = false</code> I think, which isn't really supported</p>



<a name="276423005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423005">(Mar 24 2022 at 01:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120518">Eric Huss</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276422945">said</a>:</p>
<blockquote>
<p>Oh, I forgot dylibs don't support LTO. <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>
</blockquote>
<p>oh oof :( why is that? couldn't LLVM do LTO on the dylib itself, even if it doesn't have access to other libraries it will be linked with?</p>



<a name="276423035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423035">(Mar 24 2022 at 01:14)</a>:</h4>
<p>well lto is inherently incompatible with dynamic linking.. no?</p>
<p>ah sorry u said within the dylib itself</p>



<a name="276423052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423052">(Mar 24 2022 at 01:15)</a>:</h4>
<p>I'm suggesting you could optimize <em>just</em> <a href="http://rustc_driver.so">rustc_driver.so</a> on its own - that would still get you more optimizations that looking at individual .rlibs</p>



<a name="276423066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423066">(Mar 24 2022 at 01:15)</a>:</h4>
<p>oh i didn't realize rustc_driver got compiled to a dylib</p>



<a name="276423127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423127">(Mar 24 2022 at 01:16)</a>:</h4>
<p>I'm not sure how feasible that would be.  I don't remember why that limitation is there.</p>



<a name="276423142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423142">(Mar 24 2022 at 01:17)</a>:</h4>
<p>Is rustc not statically linked in the end?</p>



<a name="276423144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423144">(Mar 24 2022 at 01:17)</a>:</h4>
<p>no</p>



<a name="276423152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423152">(Mar 24 2022 at 01:17)</a>:</h4>
<p>rustc_driver is dynamically linked, for <code>rustc_private</code> and also to avoid duplicating it between rustdoc / clippy / rustfmt</p>



<a name="276423159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423159">(Mar 24 2022 at 01:17)</a>:</h4>
<p>(also maybe proc macros are related? don't remember)</p>



<a name="276423210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423210">(Mar 24 2022 at 01:18)</a>:</h4>
<p>Yes, proc macros are dylibs.</p>



<a name="276423220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423220">(Mar 24 2022 at 01:18)</a>:</h4>
<p>Ok. So I suppose it makes sense why no whole-program LTO is performed on rustc today.</p>



<a name="276423239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423239">(Mar 24 2022 at 01:19)</a>:</h4>
<p>Seems like looking into the idea of "LTO within the big chunky dylib" is the best next step</p>



<a name="276423260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423260">(Mar 24 2022 at 01:20)</a>:</h4>
<p>the first thing I would try is <code>lto = true</code> in rustc_driver/Cargo.toml, which does fat LTO instead of thin, see if that has any impact at all</p>



<a name="276423322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423322">(Mar 24 2022 at 01:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276422724">said</a>:</p>
<blockquote>
<p>on it</p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">rustc_interface</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">0.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">ben</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">Rust</span><span class="o">/</span><span class="n">rust</span><span class="o">-</span><span class="n">lang</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_interface</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">rustc_driver</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">0.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">ben</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">Rust</span><span class="o">/</span><span class="n">rust</span><span class="o">-</span><span class="n">lang</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_driver</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="n">Compiling</span><span class="w"> </span><span class="n">rustc</span><span class="o">-</span><span class="n">main</span><span class="w"> </span><span class="n">v0</span><span class="p">.</span><span class="mf">0.0</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">ben</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">Rust</span><span class="o">/</span><span class="n">rust</span><span class="o">-</span><span class="n">lang</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc</span><span class="p">)</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">cannot</span><span class="w"> </span><span class="n">prefer</span><span class="w"> </span><span class="n">dynamic</span><span class="w"> </span><span class="n">linking</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">performing</span><span class="w"> </span><span class="n">LTO</span><span class="w"></span>

<span class="n">note</span>: <span class="nc">only</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="na">lib</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">bin</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="o">'</span><span class="na">cdylib</span><span class="o">'</span><span class="w"> </span><span class="n">outputs</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">supported</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">LTO</span><span class="w"></span>
</code></pre></div>



<a name="276423337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423337">(Mar 24 2022 at 01:21)</a>:</h4>
<p>That was on root Cargo.toml, I can try on rustc_driver</p>



<a name="276423362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423362">(Mar 24 2022 at 01:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276423260">said</a>:</p>
<blockquote>
<p>the first thing I would try is <code>lto = true</code> in rustc_driver/Cargo.toml, which does fat LTO instead of thin, see if that has any impact at all</p>
</blockquote>
<p>Is <code>lto = "fat"</code> not a thing? Seems more explicit <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<a name="276423539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423539">(Mar 24 2022 at 01:25)</a>:</h4>
<p>oh. build succeeded with rustc_driver being <code>lto = "fat"</code> <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>



<a name="276423542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423542">(Mar 24 2022 at 01:25)</a>:</h4>
<p>seems to.. contradict the wording of the above error?</p>



<a name="276423605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423605">(Mar 24 2022 at 01:26)</a>:</h4>
<p>wait.. is this even doing anything? I changed it to <code>lto = "unknown"</code> and it didn't recompile anything</p>



<a name="276423613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423613">(Mar 24 2022 at 01:26)</a>:</h4>
<p>uhh can you paste your diff?</p>



<a name="276423621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423621">(Mar 24 2022 at 01:26)</a>:</h4>
<p>also are you seeing any warnings?</p>



<a name="276423640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423640">(Mar 24 2022 at 01:27)</a>:</h4>
<p>ah<br>
<code>warning: profiles for the non root package will be ignored, specify profiles at the workspace root:</code></p>



<a name="276423703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423703">(Mar 24 2022 at 01:28)</a>:</h4>
<p>Do I need to do something like <code>[profile.release.package.rustc_driver]</code> in the workspace Cargo.toml?</p>



<a name="276423816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423816">(Mar 24 2022 at 01:30)</a>:</h4>
<p>hm that doesn't work:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Building</span><span class="w"> </span><span class="n">rustbuild</span><span class="w"></span>
<span class="n">error</span>: <span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">parse</span><span class="w"> </span><span class="n">manifest</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="err">`</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">ben</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">Rust</span><span class="o">/</span><span class="n">rust</span><span class="o">-</span><span class="n">lang</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span><span class="err">`</span><span class="w"></span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span>:
  <span class="err">`</span><span class="n">lto</span><span class="err">`</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">specified</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="err">`</span><span class="n">package</span><span class="err">`</span><span class="w"> </span><span class="n">profile</span><span class="w"></span>
</code></pre></div>
<p>my cargo-fu isn't up to snuff</p>



<a name="276423941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423941">(Mar 24 2022 at 01:32)</a>:</h4>
<p>oh oof cargo might just not have a button for "optimize this dynamic library"</p>



<a name="276423948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423948">(Mar 24 2022 at 01:33)</a>:</h4>
<p><span class="user-mention" data-user-id="120518">@Eric Huss</span> would know for sure</p>



<a name="276423949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276423949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276423949">(Mar 24 2022 at 01:33)</a>:</h4>
<p>hehe <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="276428943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276428943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shuo Li <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276428943">(Mar 24 2022 at 03:24)</a>:</h4>
<p>btw, would compile with <code>native-cpu</code> helps? I think this is something public distributed rustc not able to do.</p>



<a name="276431971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276431971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276431971">(Mar 24 2022 at 04:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="484782">Shuo Li</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276428943">said</a>:</p>
<blockquote>
<p>btw, would compile with <code>native-cpu</code> helps? I think this is something public distributed rustc not able to do.</p>
</blockquote>
<p>Ooh, good thinking, though I don't know if that will work for us either. We compile rustc once and distribute it to all developer machines in our office. I'm not confident that all the machines are built with the same cpus.</p>



<a name="276442946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276442946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276442946">(Mar 24 2022 at 08:16)</a>:</h4>
<p>You might still be able to pick a higher baseline than the default, e.g. <code>x86_64_v2</code></p>



<a name="276486430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276486430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276486430">(Mar 24 2022 at 14:49)</a>:</h4>
<p>It was not a large win historically - I think if you look there's some PRs trying it out.</p>



<a name="276505957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276505957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276505957">(Mar 24 2022 at 16:53)</a>:</h4>
<p>I tried it in <a href="https://github.com/rust-lang/rust/issues/90440">#90440</a> - <a href="https://perf.rust-lang.org/compare.html?start=dca3f1b786efd27be3b325ed1e01e247aa589c3b&amp;end=039f38df1e7d4ce1f8eb3115af67107239b9173d">results</a></p>



<a name="276519425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276519425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276519425">(Mar 24 2022 at 18:19)</a>:</h4>
<p>I dunno, that looks pretty good honestly.</p>



<a name="276521738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276521738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276521738">(Mar 24 2022 at 18:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276431971">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="484782">Shuo Li</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276428943">said</a>:</p>
<blockquote>
<p>btw, would compile with <code>native-cpu</code> helps? I think this is something public distributed rustc not able to do.</p>
</blockquote>
<p>Ooh, good thinking, though I don't know if that will work for us either. We compile rustc once and distribute it to all developer machines in our office. I'm not confident that all the machines are built with the same cpus.</p>
</blockquote>
<p>They almost certainly don't, but they probably all are x86 machines bought within the past 10 years. If so, then <code>-Ctarget-cpu=x86_64_v3</code> is an option (roughly equivalent to <code>-Ctarget-cpu=Haswell</code>).</p>



<a name="276750537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276750537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276750537">(Mar 26 2022 at 22:57)</a>:</h4>
<p>It's not <em>bad</em>, but IMO not worth us shipping 2-3x the number of binaries and targets and managing the complexity of appropriate CPU feature detection and either using a not-v3 std or otherwise complicating that.</p>



<a name="276755194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/276755194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#276755194">(Mar 27 2022 at 00:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276750537">said</a>:</p>
<blockquote>
<p>It's not <em>bad</em>, but IMO not worth us shipping 2-3x the number of binaries and targets and managing the complexity of appropriate CPU feature detection and either using a not-v3 std or otherwise complicating that.</p>
</blockquote>
<p>oh, I can agree with that while also implicitly suggesting that it's actually entirely fine for a source user to do it. :3</p>



<a name="277052766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/compiling%20rustc%20with%20LTO/near/277052766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/compiling.20rustc.20with.20LTO.html#277052766">(Mar 29 2022 at 19:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/122651-general/topic/compiling.20rustc.20with.20LTO/near/276442946">said</a>:</p>
<blockquote>
<p>You might still be able to pick a higher baseline than the default, e.g. <code>x86_64_v2</code></p>
</blockquote>
<p>btw I tried v2 in <a href="https://github.com/rust-lang/rust/issues/95302">#95302</a> if someone wants to take a look at the results (and took the opportunity to have more recent results for v3 in that PR), it's understandably less interesting than v3, but you never know.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>