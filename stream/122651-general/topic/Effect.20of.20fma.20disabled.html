<html>
<head><meta charset="utf-8"><title>Effect of fma disabled Â· general Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html">Effect of fma disabled</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274077715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274077715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274077715">(Mar 04 2022 at 04:03)</a>:</h4>
<p>When the <code>target_feature(enable="fma")</code> is not enabled the code gen from <code>mul_add</code> is less than adequate.<br>
This issue is present on both scalar(e.g. <code>f32</code>) and <code>Simd::mul_add</code>.</p>



<a name="274077732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274077732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274077732">(Mar 04 2022 at 04:04)</a>:</h4>
<p>That just came up in this week's library team meeting.</p>



<a name="274078596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274078596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274078596">(Mar 04 2022 at 04:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="457304">Jonathan</span> <a href="#narrow/stream/122651-general/topic/Effect.20of.20fma.20disabled/near/274077715">said</a>:</p>
<blockquote>
<p>When the <code>target_feature(enable="fma")</code> is not enabled the code gen from <code>mul_add</code> is less than adequate.<br>
This issue is present on both scalar(e.g. <code>f32</code>) and <code>Simd::mul_add</code>.</p>
</blockquote>
<p>What would be your preferred codegen result, btw? Or rather...<br>
I <strong>know</strong> it's bad, having done an extensive study of it myself, but what were you expecting the compiler to emit?</p>



<a name="274078841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274078841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274078841">(Mar 04 2022 at 04:24)</a>:</h4>
<p>I was expecting the compiler to emit <code>mulss</code> and <code>addss</code> as if the compiler instead saw <code>(a * b) + c</code>.<br>
wherever I use <code>mul_add</code> I end up having to use a <code>cfg!</code> macro like such:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"fma"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">mul_add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>
<p>With a drop in replacement like this it produces predictable results and decent code gen.</p>



<a name="274079055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274079055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274079055">(Mar 04 2022 at 04:28)</a>:</h4>
<p><em>nods</em></p>



<a name="274155460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274155460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274155460">(Mar 04 2022 at 16:44)</a>:</h4>
<p>yeah ive done this a ton too. i pretty much never want mul_add to call libm::fmaf or whatever.</p>



<a name="274168845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274168845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274168845">(Mar 04 2022 at 18:22)</a>:</h4>
<p>running an extremely informal poll here: <a href="https://twitter.com/workingjubilee/status/1499804915438215168">https://twitter.com/workingjubilee/status/1499804915438215168</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/workingjubilee/status/1499804915438215168"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/b918d32b7ab0e274b678c4f5dfa1cb06074b0d52/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313335393238383834383733323138303438342f52675f333955665f5f6e6f726d616c2e6a7067"></a><p>If you use Rust's f32::mul_add, do you expect the codegen to look like (in the absence of a known hardware FMA instruction):</p><span>- hyperðŸ’‰ðŸ’‰ðŸ’‰jubilee (@workingjubilee)</span></div></div>



<a name="274174764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274174764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Simmons <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274174764">(Mar 04 2022 at 19:05)</a>:</h4>
<p>I'm not sure if people understand that it'll give different results? If you want the precision of mul_add you need the complex slow version, if you want the gotta go fast aspect, it'd be better not to compile at all and you can do the dynamic dispatch fast fma path yourself.</p>



<a name="274175176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274175176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274175176">(Mar 04 2022 at 19:09)</a>:</h4>
<p>I actually think that people do understand that it is results-changing, I just think people expect the function itself to be "allow this result-changing operation".</p>



<a name="274175488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274175488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Simmons <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274175488">(Mar 04 2022 at 19:11)</a>:</h4>
<p>time for a <code>f32::mul_add_yolo()</code> :')</p>
<p>my argument would be that it's easy to fix a performance problem where all your multiplies are suddenly calling into libc, but hard to track down a correctness issue where some platforms subtly break the guarantees. (because either way <em>somebody</em> is going to want the other version)</p>



<a name="274177253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274177253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274177253">(Mar 04 2022 at 19:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330867">Josh Simmons</span> <a href="#narrow/stream/122651-general/topic/Effect.20of.20fma.20disabled/near/274175488">said</a>:</p>
<blockquote>
<p>time for a <code>f32::mul_add_yolo()</code> :')</p>
</blockquote>
<p>I think this is especially the better answer because <code>mul_add</code> is <em>documented</em> today to be only one rounding, and thus it's entirely reasonable for someone to be relying on that fact.  That that's the case regardless of how many people would prefer the yolo semantics.</p>
<p>If it wasn't then maybe we could get away with it, but even then I think the default being strict is the right answer.  The same way we have <code>sort</code> (stable) and <code>sort_unstable</code>, rather than the C++ way of <code>stable_sort</code> and <code>sort</code> (unstable), regardless of how often people want a stable sort.</p>
<p>I'm also not certain that the function call is the right way to express the goal.  I feel like someone wanting that would also want operations to <code>contract</code> in other scenarios, so a type where the optimizer just does it for <code>a * b + c</code> <em>without</em> needing to write the method might be the better answer.  (The same way people might want reassociation in <code>Iterator::sum</code> some times.)</p>



<a name="274179331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274179331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274179331">(Mar 04 2022 at 19:43)</a>:</h4>
<p>tbh, I think we should have both <code>fma</code> with the "always 1 rounding" and <code>mul_add</code> with the "1 or 2 roundings" semantics for the same reason LLVM has <code>fma</code> and <code>fmuladd</code> with those semantics, and historically Rust trying to fight the common name intuition has gone extremely poorly. :^)</p>
<p>The docs are probably wrong to call it more accurate, though. It's more precise, which is not the same.</p>
<p><code>mul_add_fast</code> doesn't work if the semantics are cfg-time because it's not actually faster to do a mul then add if FMA would be faster, and dynamic dispatch is not necessarily faster on the first few calls.</p>
<p>I have actually seen quite a few programmers who have done extensive professional work writing math algorithms expect <code>mul_add</code> to mean something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"fma"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">mul_add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>



<a name="274179691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274179691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Simmons <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274179691">(Mar 04 2022 at 19:46)</a>:</h4>
<p>There's another thing, which is that fma instructions aren't necessarily any faster than regular mul + add anyway, it depends on the actual workload and uarch whether the latency penalty is worth the better throughput. So I'm not really sure how valuable the yolo fma is if you're not doing a higher level feature / cpu dispatch.</p>



<a name="274179802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274179802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274179802">(Mar 04 2022 at 19:47)</a>:</h4>
<p>I think we can at least trust LLVM to do an okay job of isel, but yes, I feel really reluctant to attach a speed-related claim to anything.</p>



<a name="274183980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274183980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274183980">(Mar 04 2022 at 20:23)</a>:</h4>
<p>IDK that this is a <em>good</em> api (its actually pretty jank IMO, altho it's growing on me), but do const generic defaults work for stuff like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mul_add</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">ROUNDING</span>: <span class="nc">MulAddRounding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MulAddRounding</span>::<span class="n">Strict</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="nc">Self</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"></span>
</code></pre></div>



<a name="274184572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274184572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274184572">(Mar 04 2022 at 20:29)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> is this laughable or nah?</p>



<a name="274185236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274185236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274185236">(Mar 04 2022 at 20:35)</a>:</h4>
<p>But like, <a href="https://docs.julialang.org/en/v1/base/math/#Base.fma">https://docs.julialang.org/en/v1/base/math/#Base.fma</a><br>
<a href="https://docs.julialang.org/en/v1/base/math/#Base.muladd">https://docs.julialang.org/en/v1/base/math/#Base.muladd</a><br>
It's extremely bad to have the wrong name on a function everyone else agrees on the behavior of, tbh.</p>



<a name="274185630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274185630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274185630">(Mar 04 2022 at 20:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/122651-general/topic/Effect.20of.20fma.20disabled/near/274183980">said</a>:</p>
<blockquote>
<p>IDK that this is a <em>good</em> api (its actually pretty jank IMO, altho it's growing on me), but do const generic defaults work for stuff like</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mul_add</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">ROUNDING</span>: <span class="nc">MulAddRounding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MulAddRounding</span>::<span class="n">Strict</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="nc">Self</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>no and neither do type defaults work in fns</p>



<a name="274185891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274185891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274185891">(Mar 04 2022 at 20:42)</a>:</h4>
<p><em>nods</em></p>



<a name="274185899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274185899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274185899">(Mar 04 2022 at 20:42)</a>:</h4>
<p>swhat I thought.</p>



<a name="274192498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274192498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274192498">(Mar 04 2022 at 21:43)</a>:</h4>
<p>imho if we're thinking of relaxing the guarantees of <code>mul_add</code>, we should instead replace <code>mul_add</code> with <code>fma</code> for accuracy and <code>mul_add_fast</code> (or similar) for speed, and just deprecate <code>mul_add</code>.</p>



<a name="274192786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274192786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274192786">(Mar 04 2022 at 21:45)</a>:</h4>
<p>It's not obvious to me that we should not have <code>mul_add</code> refer to one or the other of those.</p>



<a name="274197408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274197408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274197408">(Mar 04 2022 at 22:30)</a>:</h4>
<p>it would be fma, but deprecated because of the confusing naming. imho having mul_add be the fast variant is a breaking change that we shouldn't have, and would break some of my code (simple-soft-float's tests iirc), probably a bunch of other people's code too</p>



<a name="274197620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274197620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274197620">(Mar 04 2022 at 22:33)</a>:</h4>
<p><em>clearly going utterly mad</em> change it over an edition!</p>



<a name="274197646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274197646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274197646">(Mar 04 2022 at 22:33)</a>:</h4>
<p>have two symbols and</p>



<a name="274198736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274198736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274198736">(Mar 04 2022 at 22:44)</a>:</h4>
<p>oh hey, <a href="https://github.com/rust-lang/rfcs/pull/3240">https://github.com/rust-lang/rfcs/pull/3240</a></p>



<a name="274199133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274199133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274199133">(Mar 04 2022 at 22:48)</a>:</h4>
<p>Symbol versioning is <em>fun</em>.</p>



<a name="274199236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274199236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274199236">(Mar 04 2022 at 22:49)</a>:</h4>
<blockquote>
<p><em>clearly going utterly mad</em> change it over an edition!</p>
</blockquote>
<p>that's not such a bad idea imho...Rust should gain a way to do something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">fma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">factor</span>: <span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="n">term</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm_fma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">factor</span><span class="p">,</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mul_add</span><span class="cp">$</span><span class="mi">2021</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">factor</span>: <span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="n">term</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">fma</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mul_add</span><span class="cp">$</span><span class="mi">2024</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">factor</span>: <span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="n">term</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">llvm_mul_add_f64</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">factor</span><span class="p">,</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>when you access a symbol without specifying which edition to use, rust just picks the nearest option.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// in edition 2015, 2018, and 2021</span>
<span class="k">const</span><span class="w"> </span><span class="n">FMA</span>: <span class="nc">fn</span><span class="p">(</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="o">=</span><span class="w"> </span><span class="kt">f64</span>::<span class="n">mul_add</span><span class="p">;</span><span class="w"></span>
<span class="c1">// in edition 2024 and later</span>
<span class="k">const</span><span class="w"> </span><span class="n">LLVM_MUL_ADD</span>: <span class="nc">fn</span><span class="p">(</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="o">=</span><span class="w"> </span><span class="kt">f64</span>::<span class="n">mul_add</span><span class="p">;</span><span class="w"></span>
<span class="c1">// any edition</span>
<span class="k">const</span><span class="w"> </span><span class="n">FMA</span>: <span class="nc">fn</span><span class="p">(</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="o">=</span><span class="w"> </span><span class="kt">f64</span>::<span class="n">mul_add</span><span class="cp">$</span><span class="mi">2021</span><span class="p">;</span><span class="w"></span>
<span class="c1">// any edition</span>
<span class="k">const</span><span class="w"> </span><span class="n">LLVM_MUL_ADD</span>: <span class="nc">fn</span><span class="p">(</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="o">=</span><span class="w"> </span><span class="kt">f64</span>::<span class="n">mul_add</span><span class="cp">$</span><span class="mi">2024</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="274201250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274201250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bstrie <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274201250">(Mar 04 2022 at 23:09)</a>:</h4>
<p>this is one of the listed rationales for reserving prefixed identifiers: instead of <code>mul_add$2021</code> we can do <code>e2021#mul_add</code></p>



<a name="274201707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274201707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274201707">(Mar 04 2022 at 23:13)</a>:</h4>
<p>extremely cute.</p>



<a name="274201892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274201892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274201892">(Mar 04 2022 at 23:15)</a>:</h4>
<p>see also the C++ <code>abi_tag</code>, <a href="https://developers.redhat.com/blog/2015/02/05/gcc5-and-the-c11-abi">https://developers.redhat.com/blog/2015/02/05/gcc5-and-the-c11-abi</a></p>



<a name="274202406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274202406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274202406">(Mar 04 2022 at 23:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256342">bstrie</span> <a href="#narrow/stream/122651-general/topic/Effect.20of.20fma.20disabled/near/274201250">said</a>:</p>
<blockquote>
<p>this is one of the listed rationales for reserving prefixed identifiers: instead of <code>mul_add$2021</code> we can do <code>e2021#mul_add</code></p>
</blockquote>
<p>ah, yeah, i forgot that.</p>



<a name="274202467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274202467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274202467">(Mar 04 2022 at 23:22)</a>:</h4>
<p>I might be misunderstanding the problem here but I don't think the feature proposed in <a href="https://github.com/rust-lang/rfcs/pull/3240">https://github.com/rust-lang/rfcs/pull/3240</a> would help with an edition based change of behavior for <code>mul_add</code>. It's only meant to affect inference to add one edition based fallback not change method dispatch in general across editions.</p>



<a name="274202545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274202545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274202545">(Mar 04 2022 at 23:22)</a>:</h4>
<p>The edition based case it allows to compile in the edition a method is introduced in would only go so far as to become a hard error in the next edition, not change the method being selected.</p>



<a name="274203134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274203134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274203134">(Mar 04 2022 at 23:28)</a>:</h4>
<p>I know, I am just amused to observe it at the same time.</p>



<a name="274220526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274220526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonathan <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274220526">(Mar 05 2022 at 05:02)</a>:</h4>
<p>I don't think a "fast" version of <code>mul_add</code> implemented by itself would be worth it tbh since it wouldn't be fast at all (at least not for scalar). I like the idea of a generic implementation that Thom suggested since the semantics can be adjusted without breaking backwards compatibility.</p>



<a name="274267413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274267413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274267413">(Mar 05 2022 at 22:04)</a>:</h4>
<p>doesn't really work.</p>



<a name="274591297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/274591297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#274591297">(Mar 08 2022 at 19:14)</a>:</h4>
<p>I did say the poll is unscientific but I feel like I should note its results anyways: <br>
people really do expect it to be "mul, then add".<br>
<a href="https://twitter.com/workingjubilee/status/1499804915438215168">https://twitter.com/workingjubilee/status/1499804915438215168</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/workingjubilee/status/1499804915438215168"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/b918d32b7ab0e274b678c4f5dfa1cb06074b0d52/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313335393238383834383733323138303438342f52675f333955665f5f6e6f726d616c2e6a7067"></a><p>If you use Rust's f32::mul_add, do you expect the codegen to look like (in the absence of a known hardware FMA instruction):</p><span>- hyperðŸ’‰ðŸ’‰ðŸ’‰jubilee (@workingjubilee)</span></div></div>



<a name="275191203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/275191203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#275191203">(Mar 14 2022 at 03:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/122651-general/topic/Effect.20of.20fma.20disabled/near/274183980">said</a>:</p>
<blockquote>
<p>IDK that this is a <em>good</em> api (its actually pretty jank IMO, altho it's growing on me), but do const generic defaults work for stuff like</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mul_add</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">ROUNDING</span>: <span class="nc">MulAddRounding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MulAddRounding</span>::<span class="n">Strict</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">a</span>: <span class="nc">Self</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>I personally would rather have default/named arguments instead of this. This probably makes inference harder, but I can't think of an example rn.</p>



<a name="275264265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Effect%20of%20fma%20disabled/near/275264265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Effect.20of.20fma.20disabled.html#275264265">(Mar 14 2022 at 16:44)</a>:</h4>
<p>It's definitely a way to hack around the lack of default arguments. Thing is, default arguments seem like a harder sell given that we already have default generic parameters &gt;_&gt;.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>