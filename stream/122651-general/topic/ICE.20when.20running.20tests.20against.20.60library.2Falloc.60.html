<html>
<head><meta charset="utf-8"><title>ICE when running tests against `library/alloc` · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html">ICE when running tests against `library/alloc`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256946159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/256946159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael de Silva <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#256946159">(Oct 10 2021 at 11:00)</a>:</h4>
<p>I was able to get the tests to pass with <code>./x.py test library/alloc/ --stage 1</code> though.  Any idea as to why this works?</p>



<a name="256957110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/256957110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#256957110">(Oct 10 2021 at 13:57)</a>:</h4>
<p>One should be very careful when using <code>--keep-stage</code>. There is a warning that should have been printed (albeit somewhat hidden in the long output): <code>Warning: Using a potentially old libstd. This may not behave well.</code>  There's also some docs at <a href="https://rustc-dev-guide.rust-lang.org/building/suggested.html#incremental-builds-with---keep-stage">https://rustc-dev-guide.rust-lang.org/building/suggested.html#incremental-builds-with---keep-stage</a> which mention the hazards of using it.</p>
<p>From a completely fresh checkout, it should have displayed an error about stage1 being missing.  So there was likely an outdated copy of stage1 std.  The compiler and std are pretty intimately intertwined, so they need to be very closely in sync.</p>



<a name="257048658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257048658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael de Silva <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257048658">(Oct 11 2021 at 11:14)</a>:</h4>
<p>See <a href="https://rustc-dev-guide.rust-lang.org/getting-started.html#building-and-testing-rustc">https://rustc-dev-guide.rust-lang.org/getting-started.html#building-and-testing-rustc</a>. I think this needs a bit more polish in that regard.</p>



<a name="257048957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257048957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael de Silva <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257048957">(Oct 11 2021 at 11:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120518">Eric Huss</span> <a href="#narrow/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60/near/256957110">said</a>:</p>
<blockquote>
<p>One should be very careful when using <code>--keep-stage</code>. There is a warning that should have been printed (albeit somewhat hidden in the long output): <code>Warning: Using a potentially old libstd. This may not behave well.</code>  There's also some docs at <a href="https://rustc-dev-guide.rust-lang.org/building/suggested.html#incremental-builds-with---keep-stage">https://rustc-dev-guide.rust-lang.org/building/suggested.html#incremental-builds-with---keep-stage</a> which mention the hazards of using it.</p>
<p>From a completely fresh checkout, it should have displayed an error about stage1 being missing.  So there was likely an outdated copy of stage1 std.  The compiler and std are pretty intimately intertwined, so they need to be very closely in sync.</p>
</blockquote>
<p>This fails with the same ICE error <code>./x.py test library/alloc</code></p>



<a name="257051923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257051923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257051923">(Oct 11 2021 at 11:45)</a>:</h4>
<p>I got a similar error when running stage 0 doc tests instead of keep-stage. <a href="https://github.com/rust-lang/rust/issues/89564">#89564</a></p>



<a name="257088914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257088914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257088914">(Oct 11 2021 at 16:40)</a>:</h4>
<p>Hm, I'm guessing maybe you have the <code>library</code> profile?  It looks like that defaults to <code>test-stage=0</code>.  I'm not a big fan of that, since it can cause issues like this.  However, I understand that people want faster and easier build and test cycles.</p>
<p>I'm sure the people who work on rustc-dev-guide would be happy to have some help to polish the docs.  There's a channel here at <a class="stream" data-stream-id="196385" href="/#narrow/stream/196385-t-compiler.2Fwg-rustc-dev-guide">#t-compiler/wg-rustc-dev-guide</a> where they hang out.</p>
<p>I tried digging through some of the recent changes to that file and issues reporting errors with <code>trimmed_def_paths</code>, but none of them seem to resolve the issue.</p>



<a name="257089857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257089857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael de Silva <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257089857">(Oct 11 2021 at 16:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120518">Eric Huss</span> <a href="#narrow/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60/near/257088914">said</a>:</p>
<blockquote>
<p>Hm, I'm guessing maybe you have the <code>library</code> profile?  It looks like that defaults to <code>test-stage=0</code>.  I'm not a big fan of that, since it can cause issues like this.  However, I understand that people want faster and easier build and test cycles.</p>
<p>I'm sure the people who work on rustc-dev-guide would be happy to have some help to polish the docs.  There's a channel here at <a class="stream" data-stream-id="196385" href="/#narrow/stream/196385-t-compiler.2Fwg-rustc-dev-guide">#t-compiler/wg-rustc-dev-guide</a> where they hang out.</p>
<p>I tried digging through some of the recent changes to that file and issues reporting errors with <code>trimmed_def_paths</code>, but none of them seem to resolve the issue.</p>
</blockquote>
<p>Hi Eric. What do you mean by library profile? Have I missed a local Config?  You’re right, mine sticks to stage 0 for whatever reason. Thanks.</p>



<a name="257090161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257090161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257090161">(Oct 11 2021 at 16:50)</a>:</h4>
<p>In <code>config.toml</code> there is a <code>profile = "..."</code> setting that sets up some defaults.  The "library" setting is intended for people working on the standard library, and it disables building the compiler and instead using the beta compiler. Normally if you don't set the profile, the default is <code>--stage=1</code> which means to build the local compiler.</p>



<a name="257090613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257090613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael de Silva <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257090613">(Oct 11 2021 at 16:55)</a>:</h4>
<p>Thanks I’ll check that.</p>



<a name="257090861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257090861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257090861">(Oct 11 2021 at 16:57)</a>:</h4>
<p>That's a beta compiler compiling and testing the nightly standard library. Since the compiler itself isn't linked against the nightly standard library (right?), so an ICE is somewhat unexpected. A test failing would be a different story but that's usually handled by adding a <code>cfg(bootstrap)</code>.</p>



<a name="257091709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257091709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257091709">(Oct 11 2021 at 17:04)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> which compiler do you mean? All compilers except for the beta compiler are linked against nightly</p>



<a name="257091760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257091760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257091760">(Oct 11 2021 at 17:05)</a>:</h4>
<p>But yeah I agree I don't see how stages are relevant here</p>



<a name="257091990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257091990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257091990">(Oct 11 2021 at 17:06)</a>:</h4>
<p>The compiler used to build the tests in <code>./x.py test library/alloc --stage 0</code>. Aiui that uses the beta compiler linked against beta standard library and only builds the nightly standard library as an external crate, i.e. it's not a mismatch between compiler and stdlib that could be causing the ICE.</p>



<a name="257092816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257092816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257092816">(Oct 11 2021 at 17:13)</a>:</h4>
<p>For reference, this is the failing doc test. I guess beta isn't handling the compile error properly</p>
<div class="codehilite"><pre><span></span><code>/// ```compile_fail,E0277
/// trait TraitExample {}
///
/// impl&lt;&#39;a&gt; TraitExample for &amp;&#39;a str {}
///
/// fn example_func&lt;A: TraitExample&gt;(example_arg: A) {}
///
/// let example_string = String::from(&quot;example_string&quot;);
/// example_func(&amp;example_string);
/// ```
</code></pre></div>



<a name="257092817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257092817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257092817">(Oct 11 2021 at 17:13)</a>:</h4>
<p>Yea, I don't think it is a mismatch issue.  I thought for sure it would be one of <a href="https://github.com/rust-lang/rust/issues/89126">#89126</a>, <a href="https://github.com/rust-lang/rust/issues/89408">#89408</a>, <a href="https://github.com/rust-lang/rust/issues/88719">#88719</a> or <a href="https://github.com/rust-lang/rust/issues/88546">#88546</a>, which all are recent PRs dealing with trimmed_def_paths and <code>error_reporting/suggestions.rs</code>, but none of them fixed it.</p>



<a name="257092904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257092904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257092904">(Oct 11 2021 at 17:14)</a>:</h4>
<p>(That is, applying those to the stage0 compiler.)</p>



<a name="257100063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257100063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257100063">(Oct 11 2021 at 18:21)</a>:</h4>
<p>Another one, this time with check instead of tests. <a href="https://github.com/rust-lang/rust/issues/89775">#89775</a></p>



<a name="257100506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257100506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257100506">(Oct 11 2021 at 18:25)</a>:</h4>
<p>I've hit this yesterday as well</p>



<a name="257109910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/ICE%20when%20running%20tests%20against%20%60library/alloc%60/near/257109910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/ICE.20when.20running.20tests.20against.20.60library.2Falloc.60.html#257109910">(Oct 11 2021 at 19:58)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/89785">#89785</a> should fix it.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>