<html>
<head><meta charset="utf-8"><title>u64 == usize crate-dependent type inference · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html">u64 == usize crate-dependent type inference</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259490991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259490991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259490991">(Oct 29 2021 at 07:29)</a>:</h4>
<p>I have a crate <code>foo</code> which is a dependency of <code>bar</code>. In <code>foo</code> there is a function like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="k">u64</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="k">usize</span><span class="p">.</span><span class="n">try_into</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Compiling <code>foo</code> shows no errors, and I can even build and <code>cargo test</code> it. However, when compiling <code>bar</code> with cargo, <code>foo</code> is compiled and during the compilation this line is flagged like so:</p>
<div class="codehilite"><pre><span></span><code>    Checking foo v0.1.0 (bar/components/foo)
error[E0283]: type annotations needed
   --&gt; components/foo/lib.rs:2:18
    |
2   |     let _ = 0u64 == 0usize.try_into().unwrap();
    |                  ^^ ----------------- this method call resolves to `Result&lt;T, &lt;Self as TryInto&lt;T&gt;&gt;::Error&gt;`
    |                  |
    |                  cannot infer type
    |
    = note: cannot satisfy `u64: PartialEq&lt;_&gt;`

For more information about this error, try `rustc --explain E0283`.
error: could not compile `mmcc` due to previous error
</code></pre></div>
<p>Does anyone know how this can happen? Is being in a different crate affecting the trait resolution rules somehow so as to make this <code>PartialEq</code> implementation ambiguous?</p>



<a name="259494598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259494598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259494598">(Oct 29 2021 at 08:15)</a>:</h4>
<p>The only thing I can think of is there being an <code>impl std::cmp::PartialEq&lt;Baz&gt; for u64</code> in <code>bar</code><br>
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=dbbe359f52c11ad81c6531bff3e76b13">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=dbbe359f52c11ad81c6531bff3e76b13</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Baz</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">std</span>::<span class="n">cmp</span>::<span class="nb">PartialEq</span><span class="o">&lt;</span><span class="n">Baz</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">eq</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="kp">&amp;</span><span class="nc">Baz</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kc">false</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="k">u64</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="k">usize</span><span class="p">.</span><span class="n">try_into</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>this compiles if you remove the <code>PartialEq</code> impl.</p>



<a name="259506663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259506663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259506663">(Oct 29 2021 at 10:33)</a>:</h4>
<p>It reminds me of this wonderful crate of yours, <span class="user-mention" data-user-id="138909">@matt1992</span>: <a href="https://docs.rs/break_array">https://docs.rs/break_array</a></p>



<a name="259522013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259522013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259522013">(Oct 29 2021 at 13:14)</a>:</h4>
<p>This makes sense if the code of <code>foo()</code> was replicated or macro-inserted in <code>bar</code>, but the weird thing is that it's actually erroring before it even gets to <code>bar</code>, it's the exact same line of code in <code>foo()</code> which is a regular non-generic function. The only difference is that in one case I'm compiling <code>foo</code> directly and in the other case cargo is compiling <code>foo</code> as a dependency of <code>bar</code> (so e.g. <code>--cap-lints</code> is on)</p>



<a name="259522078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259522078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259522078">(Oct 29 2021 at 13:15)</a>:</h4>
<p>I will see if I can make a self contained example</p>



<a name="259541227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259541227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259541227">(Oct 29 2021 at 15:32)</a>:</h4>
<p>Maybe a mutual dependency has a feature that's only enabled via <code>bar</code>?</p>



<a name="259543714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259543714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259543714">(Oct 29 2021 at 15:49)</a>:</h4>
<p>Yes, I just managed to track it down, and indeed the reason it compiles differently is because of a feature in a mutual dependency. However, I think there is a genuine rust bug underneath; I've managed to minimize it to the following:</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[dependencies]</span>
<span class="n">lsp-types</span> <span class="o">=</span> <span class="s">"0.91"</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">"2.0.0"</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">lsp_types</span>::<span class="n">Url</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// comment this out and it works</span>
<span class="c1">// impl Foo for url::Url {} // replacing it with this line also works</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="k">u64</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="k">usize</span><span class="p">.</span><span class="n">try_into</span><span class="p">().</span><span class="n">unwrap</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="259549399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259549399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259549399">(Oct 29 2021 at 16:26)</a>:</h4>
<p>Aha: <a href="https://github.com/serde-rs/json/blob/master/src/value/partial_eq.rs#L69-L73">https://github.com/serde-rs/json/blob/master/src/value/partial_eq.rs#L69-L73</a></p>



<a name="259549727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259549727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259549727">(Oct 29 2021 at 16:28)</a>:</h4>
<p>Hm, is this something that should be fixed in serde-json? It was certainly surprising to find something like that so deep in a transitive dependency when I'm not even dealing with anything to do with json and have no serde or json related traits open</p>



<a name="259552750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259552750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259552750">(Oct 29 2021 at 16:52)</a>:</h4>
<p>I think there's an issue about it on rust-lang/rust (at least seeking better diagnostics)</p>



<a name="259557894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259557894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259557894">(Oct 29 2021 at 17:33)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/46257">https://github.com/rust-lang/rust/issues/46257</a></p>



<a name="259558211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259558211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259558211">(Oct 29 2021 at 17:35)</a>:</h4>
<p>I would be nice if the compiler said "I think this could be X, Y, or T:Foo ..."</p>



<a name="259560567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259560567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259560567">(Oct 29 2021 at 17:53)</a>:</h4>
<p>also related: <a href="https://github.com/rust-lang/rust/issues/71538">https://github.com/rust-lang/rust/issues/71538</a></p>



<a name="259561291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259561291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259561291">(Oct 29 2021 at 17:58)</a>:</h4>
<p>yikes, I always get worried about those 2.0 wishlist issues because I know that 2.0 is about as likely for these crates as rust 2.0</p>



<a name="259564198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/u64%20%3D%3D%20usize%20crate-dependent%20type%20inference/near/259564198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference.html#259564198">(Oct 29 2021 at 18:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/122651-general/topic/u64.20.3D.3D.20usize.20crate-dependent.20type.20inference/near/259506663">said</a>:</p>
<blockquote>
<p>It reminds me of this wonderful crate of yours, <span class="user-mention silent" data-user-id="138909">matt1992</span>: <a href="https://docs.rs/break_array">https://docs.rs/break_array</a></p>
</blockquote>
<p>FWIW, this was fixed in 1.50 by <a href="https://github.com/rust-lang/rust/pull/74989">https://github.com/rust-lang/rust/pull/74989</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>