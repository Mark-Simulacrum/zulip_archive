<html>
<head><meta charset="utf-8"><title>Unwind tables are strictly required on Windows and Android · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html">Unwind tables are strictly required on Windows and Android</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="231167016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231167016" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231167016">(Mar 20 2021 at 19:40)</a>:</h4>
<p>I noticed that on <a href="https://github.com/rust-lang/rust/blob/41b315a470d583f6446599984ff9ad3bd61012b2/compiler/rustc_target/src/spec/windows_msvc_base.rs#L19">Windows</a> and <a href="https://github.com/rust-lang/rust/blob/41b315a470d583f6446599984ff9ad3bd61012b2/compiler/rustc_target/src/spec/android_base.rs#L15">Android</a>, unwind tables are <em><a href="https://github.com/rust-lang/rust/pull/69984#discussion_r392411195">strictly</a></em> required, and <a href="https://github.com/rust-lang/rust/blob/41b315a470d583f6446599984ff9ad3bd61012b2/src/test/ui/panic-runtime/unwind-tables-target-required.rs#L8">it's not possible not to force LLVM generating them via <code>-C force-unwind-tables=no</code></a>. However, the only reason I found that makes them required is because <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1302078">Breakpad</a> and <a href="https://github.com/rust-lang/rust/issues/49867">Gecko profiler</a> are using unwind tables on Windows and Android repesctively, as mentioned in <a href="https://github.com/rust-lang/rust/issues/50093">#50093</a> and <a href="https://github.com/rust-lang/rust/issues/40549">#40549</a>.<br>
It seems that if I don't use libraries/programs that depends on unwind tables, don't need to set up an asynchronous exception handler, and use <code>panic = "abort"</code> (of course) on Windows, they are not really required. Is there a reason that they are <em>strictly</em> required? (They may also even not required to be generated by default when <code>panic = "abort"</code>, as now <a href="https://github.com/rust-lang/rust/pull/69984"><code>-C force-unwind-tables</code></a> exists, maybe <a href="https://github.com/rust-lang/rust/issues/49867#issuecomment-380485548">using that for custom unwind tables usages</a> is preferable.)</p>



<a name="231169199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231169199" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231169199">(Mar 20 2021 at 20:21)</a>:</h4>
<p>On windows unwinding is baked into the standard library and OS (caveats in wording precision)</p>



<a name="231169212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231169212" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231169212">(Mar 20 2021 at 20:21)</a>:</h4>
<p>So even if your app does not rely on it windows itself does</p>



<a name="231169445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231169445" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231169445">(Mar 20 2021 at 20:26)</a>:</h4>
<p>But what could happen if there's no unwind table? How does it <em>rely</em> on it?</p>



<a name="231170185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231170185" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231170185">(Mar 20 2021 at 20:40)</a>:</h4>
<p>For hardware exception (SIGILL,SIGFPE,SIGSEGV,... on Unix), unlike on Unix with it's signal handlers, Windows uses SEH to unwind your code until it hits a function that catches the hardware exception.</p>



<a name="231170215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231170215" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231170215">(Mar 20 2021 at 20:41)</a>:</h4>
<p>SEH is also baked into the kernel, unlike unwinding on Unix, as on Windows the kernel may call into user code. This requires an unwinding aware kernel to be able to unwind through the kernel.</p>



<a name="231170488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231170488" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231170488">(Mar 20 2021 at 20:46)</a>:</h4>
<p>^</p>



<a name="231170609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231170609" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231170609">(Mar 20 2021 at 20:48)</a>:</h4>
<p>IIRC processes can send an exception to other processes too (via TerminateProcess) I believe. Which then in turn also kicks off such a SEH exception.</p>



<a name="231170623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231170623" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231170623">(Mar 20 2021 at 20:48)</a>:</h4>
<p>If a hardware exception is raised, I'm happy to let it crash my program <em>directly</em>, just like the default behaviour on Unix. I don't need "a function that catches the hardware exception"?</p>



<a name="231170723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231170723" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231170723">(Mar 20 2021 at 20:50)</a>:</h4>
<p>Its not just hardware faults.</p>



<a name="231170839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231170839" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231170839">(Mar 20 2021 at 20:53)</a>:</h4>
<p>Even if the exception is triggered programmatically, I still don't want to handle it and am happy to let it crash my program.</p>



<a name="231170901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231170901" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231170901">(Mar 20 2021 at 20:54)</a>:</h4>
<p>IIRC programs might just not work at all without correct uwtables in the first place – as in not launch. I did try to set up uwtables for segmented stacks in <code>psm</code> (against all the advices to not do so) and had gotten it to a working degree on my local machine, only to witness my tests immediately faulting on a CI machine.</p>



<a name="231170956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231170956" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231170956">(Mar 20 2021 at 20:55)</a>:</h4>
<p>And so LLVM does not support (AFAIK) not emitting precise uwtables on Windows because its a maintenance burden for an use-case that almost nobody has.</p>



<a name="231171026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231171026" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231171026">(Mar 20 2021 at 20:56)</a>:</h4>
<p>Much like with many other things LLVM, people with rare use-cases are expected to implement code to support them by themselves.</p>



<a name="231171161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231171161" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231171161">(Mar 20 2021 at 20:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android/near/231170956">said</a>:</p>
<blockquote>
<p>And so LLVM does not support (AFAIK) not emitting precise uwtables</p>
</blockquote>
<p>Then what did <a href="https://github.com/rust-lang/rust/issues/40549">#40549</a> do and why it had effects on Gecko?</p>



<a name="231171292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231171292" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231171292">(Mar 20 2021 at 21:01)</a>:</h4>
<p>Or before <a href="https://github.com/rust-lang/rust/issues/40549">#40549</a> Windows targets were broken with <code>panic = "abort"</code>? (If so, that's surprising and scary to me.)</p>



<a name="231173657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231173657" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231173657">(Mar 20 2021 at 21:46)</a>:</h4>
<p>Hm, I might be wrong then about LLVM not having the support for this, I could've sworn that I've seen emission of SEH directives without checking if uwtable is enabled, but looking at it again, it seems that they are all inside ifs.</p>



<a name="231204472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231204472" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231204472">(Mar 21 2021 at 09:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android/near/231173657">said</a>:</p>
<blockquote>
<p>Hm, I might be wrong then about LLVM not having the support for this, I could've sworn that I've seen emission of SEH directives without checking if uwtable is enabled, but looking at it again, it seems that they are all inside ifs.</p>
</blockquote>
<p>Interesting. Could you point me to where did you look at? Maybe <code>git blame</code> could provide some useful informations.</p>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android/near/231170723">said</a>:</p>
<blockquote>
<p>Its not just hardware faults.</p>
</blockquote>
<p>I don't feel like doing something other than aborting the program or displaying a bug report window when an exception occurs would be a good idea, per the "Important" section in <a href="https://docs.microsoft.com/en-us/cpp/build/reference/eh-exception-handling-model?view=msvc-160#structured-and-standard-c-exception-handling">https://docs.microsoft.com/en-us/cpp/build/reference/eh-exception-handling-model?view=msvc-160#structured-and-standard-c-exception-handling</a>:</p>
<blockquote>
<p>In most cases, asynchronous exceptions are unrecoverable and should be considered fatal. Catching them and proceeding can cause process corruption and lead to bugs that are hard to find and fix.</p>
</blockquote>
<p>(That's why I'm happy to let any exception crash my program, if I don't use something like Breakpad.)</p>



<a name="231233142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231233142" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231233142">(Mar 21 2021 at 18:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="374396">hyd-dev</span> <a href="#narrow/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android/near/231204472">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android/near/231173657">said</a>:</p>
<blockquote>
<p>Hm, I might be wrong then about LLVM not having the support for this, I could've sworn that I've seen emission of SEH directives without checking if uwtable is enabled, but looking at it again, it seems that they are all inside ifs.</p>
</blockquote>
<p>Interesting. Could you point me to where did you look at? Maybe <code>git blame</code> could provide some useful informations.</p>
</blockquote>
<p>Is it <a href="https://github.com/llvm/llvm-project/blob/d11d5d1c5f5a8bafc28be98f43c15a3452abb98b/llvm/lib/Target/X86/X86FrameLowering.cpp#L1313">https://github.com/llvm/llvm-project/blob/d11d5d1c5f5a8bafc28be98f43c15a3452abb98b/llvm/lib/Target/X86/X86FrameLowering.cpp#L1313</a>?</p>



<a name="231233845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231233845" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231233845">(Mar 21 2021 at 18:50)</a>:</h4>
<p>Looks like those <code>.seh</code>s are gated behind <code>if</code>s since <a href="https://reviews.llvm.org/D4081">https://reviews.llvm.org/D4081</a>, which looks like the initial implementation of SEH unwind info, if I'm not looking at the wrong place...</p>



<a name="231281874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231281874" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231281874">(Mar 22 2021 at 09:27)</a>:</h4>
<p>/me decides to create a PR to stop enforcing unwind tables on those targets, and will welcome feedback there.</p>



<a name="231320114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231320114" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231320114">(Mar 22 2021 at 14:35)</a>:</h4>
<p>I want to test after my change, <code>uwtable</code> is still emitted by default on Windows and Android, in order not to break things like Gecko. I think I should add a  test in <code>src/test/codegen</code>, but how do I make it only run on Windows and Android? (Is <code>// only-windows // only-android</code> correct or it will make the test always ignored? Or do I need to write a bunch of <code>// ignore-...</code>s?)</p>



<a name="231320484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231320484" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231320484">(Mar 22 2021 at 14:38)</a>:</h4>
<p><code>// only-windows</code> sounds correct</p>



<a name="231320526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231320526" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231320526">(Mar 22 2021 at 14:38)</a>:</h4>
<p>But what about Android?</p>



<a name="231320675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231320675" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231320675">(Mar 22 2021 at 14:39)</a>:</h4>
<p><a href="https://rustc-dev-guide.rust-lang.org/tests/adding.html?highlight=Ui%20test#ignoring-tests">https://rustc-dev-guide.rust-lang.org/tests/adding.html?highlight=Ui%20test#ignoring-tests</a></p>



<a name="231322157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231322157" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231322157">(Mar 22 2021 at 14:48)</a>:</h4>
<p><code>// only-windows</code> and <code>// only-android</code> can be put in the <em>same</em> file at the same time?</p>



<a name="231322808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231322808" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231322808">(Mar 22 2021 at 14:52)</a>:</h4>
<p>A bunch of ignores or multiple tests is unfortunately the only option, unless you have some time to reimplement <code>only-*</code> directives properly.</p>



<a name="231323555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231323555" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231323555">(Mar 22 2021 at 14:56)</a>:</h4>
<p>Oh... <span aria-label="sweat" class="emoji emoji-1f613" role="img" title="sweat">:sweat:</span> Thanks!</p>



<a name="231323771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231323771" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231323771">(Mar 22 2021 at 14:57)</a>:</h4>
<p>if your tests are <code>#[no_core]</code> you can use revisions.</p>



<a name="231323974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231323974" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231323974">(Mar 22 2021 at 14:58)</a>:</h4>
<p>with <code>--target=anything</code> for each revision you're testing and <code>// needs-llvm-components</code> for the architectures you're using in the test.</p>



<a name="231324060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231324060" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231324060">(Mar 22 2021 at 14:59)</a>:</h4>
<p>I'll have a try. Thanks!</p>



<a name="231324079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231324079" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231324079">(Mar 22 2021 at 14:59)</a>:</h4>
<p>src/test/codegen/target-feature-overrides.rs is a close example of this.</p>



<a name="231350247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231350247" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231350247">(Mar 22 2021 at 17:20)</a>:</h4>
<p>Wait... Maybe Windows really requires unwind tables: <a href="https://github.com/rust-lang/rust/pull/69984#issuecomment-609448581">https://github.com/rust-lang/rust/pull/69984#issuecomment-609448581</a> (In particular, <a href="https://stackoverflow.com/questions/45333326/under-what-conditions-do-i-need-to-set-up-seh-unwind-info-for-an-x86-64-assembly/45333553#comment-77629593">this comment</a> in the linked Stack Overflow question:)</p>
<blockquote>
<p>The results are now undefined because you are operating with garbage data. </p>
</blockquote>
<p>It's scary that before  <a href="https://github.com/rust-lang/rust/issues/40549">#40549</a> Windows targets with <code>panic = "abort"</code> seems really broken (and it's strange that LLVM supports not emitting them / initially does not support emitting them).<br>
I'll defer the Windows change, but it should be safe to skip emitting <code>uwtable</code> on Android?</p>



<a name="231350587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231350587" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231350587">(Mar 22 2021 at 17:22)</a>:</h4>
<p>If android walks the stacks for the same purposes as windows, then it'll face all the same issues.</p>



<a name="231350851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231350851" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231350851">(Mar 22 2021 at 17:24)</a>:</h4>
<p>Worth noting that the stack overflow answer did not really say anything new – you may get exceptions thrown at any time by anybody and the stack unwinding algorithm can't work without data that it requires to operate.</p>



<a name="231350937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231350937" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231350937">(Mar 22 2021 at 17:25)</a>:</h4>
<p>this is true on plain gnu linux too, if there is no unwinding information somewhere in the call stack, of if its incorrect, you can see almost anything happening.</p>



<a name="231351295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231351295" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231351295">(Mar 22 2021 at 17:27)</a>:</h4>
<p>Yes, I understand and agree with that, thanks for your explanation. But neither GNU/Linux nor Android unwind the stack "at any time" if I don't explicit (call another function to) throw an exception?</p>



<a name="231351860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231351860" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231351860">(Mar 22 2021 at 17:30)</a>:</h4>
<p>The Android one was added for a profiler. It seems off by default in other compilers as well? <a href="https://github.com/rust-lang/rust/issues/49867#issuecomment-380485548">https://github.com/rust-lang/rust/issues/49867#issuecomment-380485548</a></p>



<a name="231352094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231352094" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231352094">(Mar 22 2021 at 17:32)</a>:</h4>
<p>Right, that's mostly correct, if you don't care about use of debuggers/<code>Backtrace</code> or similar utilities with your library or program.</p>



<a name="231352220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231352220" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231352220">(Mar 22 2021 at 17:33)</a>:</h4>
<p>Ultimately the kernels or OSs outside of Windows (AFAIK) doesn't really care about missing uwtables otherwise and can operate fine without them.</p>



<a name="231352888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231352888" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231352888">(Mar 22 2021 at 17:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="374396">hyd-dev</span> <a href="#narrow/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android/near/231350247">said</a>:</p>
<blockquote>
<p>Wait... Maybe Windows really requires unwind tables: <a href="https://github.com/rust-lang/rust/pull/69984#issuecomment-609448581">https://github.com/rust-lang/rust/pull/69984#issuecomment-609448581</a> (In particular, <a href="https://stackoverflow.com/questions/45333326/under-what-conditions-do-i-need-to-set-up-seh-unwind-info-for-an-x86-64-assembly/45333553#comment-77629593">this comment</a> in the linked Stack Overflow question:)</p>
<blockquote>
<p>The results are now undefined because you are operating with garbage data. </p>
</blockquote>
<p>It's scary that before  <a href="https://github.com/rust-lang/rust/issues/40549">#40549</a> Windows targets with <code>panic = "abort"</code> seems really broken (and it's strange that LLVM supports not emitting them / initially does not support emitting them).<br>
I'll defer the Windows change, but it should be safe to skip emitting <code>uwtable</code> on Android?</p>
</blockquote>
<p><a href="https://stackoverflow.com/questions/45333326/under-what-conditions-do-i-need-to-set-up-seh-unwind-info-for-an-x86-64-assembly/45333553#comment77641422_45337258">https://stackoverflow.com/questions/45333326/under-what-conditions-do-i-need-to-set-up-seh-unwind-info-for-an-x86-64-assembly/45333553#comment77641422_45337258</a> is also interesting:</p>
<blockquote>
<p>There are various types of exceptions that are handled and continued by the default top-level exception filter, such as stack guard page exceptions and Win32 resource copy-on-write. Clients likely would not be happy if they blew up when the stack was too close to a 4KB boundary, or when they passed a pointer to copy-on-write resources or to a memory-mapped file that encounters an I/O error.</p>
</blockquote>



<a name="231354053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231354053" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231354053">(Mar 22 2021 at 17:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android/near/231352220">said</a>:</p>
<blockquote>
<p>Ultimately the kernels or OSs outside of Windows (AFAIK) doesn't really care about missing uwtables otherwise and can operate fine without them.</p>
</blockquote>
<p>Alright. I'll go ahead with a PR, but for Android only. (If that is wrong, I hope an Android expert can come and stop me!)</p>



<a name="231356030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231356030" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231356030">(Mar 22 2021 at 17:57)</a>:</h4>
<p>Should I change <code>requires_uwtable</code> to <code>false</code> for Android directly or implement a "default" <code>uwtable</code> setting? Setting it to <code>false</code> directly is consistent with other targets, but could be (?) breaking if someone is using a debugger/profiler or trying to get a backtrace from unwind tables.</p>



<a name="231356214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231356214" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231356214">(Mar 22 2021 at 17:58)</a>:</h4>
<p>the behaviour without any flags should remain the same, probably the only thing that should happen is that you can specify the <code>-Cforce-unwind-tables=no</code> or something.</p>



<a name="231356255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231356255" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231356255">(Mar 22 2021 at 17:58)</a>:</h4>
<p>(which makes me think, this flag should really be <code>-Cforce-unwind-tables=yes/no (default)/off</code></p>



<a name="231356331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231356331" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231356331">(Mar 22 2021 at 17:59)</a>:</h4>
<p>If nothing else keeping the same default behaviour will make landing your change significantly easier.</p>



<a name="231375358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231375358" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231375358">(Mar 22 2021 at 19:59)</a>:</h4>
<p>/me opened a PR for Android just now: <a href="https://github.com/rust-lang/rust/issues/83391">#83391</a></p>



<a name="231377429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Unwind%20tables%20are%20strictly%20required%20on%20Windows%20and%20Android/near/231377429" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/Unwind.20tables.20are.20strictly.20required.20on.20Windows.20and.20Android.html#231377429">(Mar 22 2021 at 20:14)</a>:</h4>
<p>Also I have a related question: why <code>-C force-unwind-tables=no</code> is not allowed with <code>-C panic=unwind</code>? To my understanding, LLVM will <em>still</em> generate unwind tables even the function does not have <code>uwtable</code> unless the function is <code>nounwind</code>: <a href="https://github.com/llvm/llvm-project/blob/c21016715f0ee4a36affdf7150ac135ca98b0eae/llvm/include/llvm/IR/Function.h#L666">https://github.com/llvm/llvm-project/blob/c21016715f0ee4a36affdf7150ac135ca98b0eae/llvm/include/llvm/IR/Function.h#L666</a></p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>