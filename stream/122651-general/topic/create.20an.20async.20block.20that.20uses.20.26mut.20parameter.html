<html>
<head><meta charset="utf-8"><title>create an async block that uses &amp;mut parameter · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html">create an async block that uses &amp;mut parameter</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275861010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275861010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275861010">(Mar 18 2022 at 20:51)</a>:</h4>
<p>I know the general recommendation here is "ask in discord" but I've asked and it's slow today :P and also this might be an interesting problem for people here.</p>
<p>I'm getting an error I don't quite understand. My code looks like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">get_as_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_with_retries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">conn</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">conn</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">})</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_with_retries</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Fut</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">create_get_fut</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">Fut</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">io</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Protocol</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Fut</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// ... this bit compiles fine</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and the error I see is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">lifetime</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="n">enough</span><span class="w"></span>
<span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">memcached</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">107</span>:<span class="mi">13</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="mi">106</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_with_retries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">conn</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                                                       </span><span class="o">-</span><span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">type</span> <span class="nc">of</span><span class="w"> </span><span class="n">closure</span><span class="w"> </span><span class="err">`</span><span class="k">impl</span><span class="w"> </span><span class="n">futures</span>::<span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">result</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="err">`</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">lifetime</span><span class="w"> </span><span class="err">`</span><span class="o">'</span><span class="mi">2</span><span class="err">`</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                                                       </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">                                                       </span><span class="kd">let</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">lifetime</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">reference</span><span class="w"> </span><span class="err">`</span><span class="o">'</span><span class="mi">1</span><span class="err">`</span><span class="w"></span>
<span class="mi">107</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">conn</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w">             </span><span class="o">^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">returning</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">requires</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="err">`</span><span class="o">'</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">outlive</span><span class="w"> </span><span class="err">`</span><span class="o">'</span><span class="mi">2</span><span class="err">`</span><span class="w"></span>
</code></pre></div>
<p>I think the issue here is that <code>conn</code> is tied to the lifetime of the future? Is there a way to let the compiler know that it's ok for <code>conn</code> to be unusable in the parent until I call <code>await</code> on the future?</p>
<p>What I really want is something like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_with_retries</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Fut</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">create_get_fut</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">Fut</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span>: <span class="o">'</span><span class="na">a</span> <span class="o">+</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">io</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">F</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">Protocol</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Fut</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>but that's invalid syntax.</p>



<a name="275861246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275861246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275861246">(Mar 18 2022 at 20:53)</a>:</h4>
<p>the reason I'm using a closure is because I do actually use the <code>Protocol</code> variable later in <code>get_with_retries</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">is_connection_error</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">retries</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                        </span><span class="n">warn</span><span class="o">!</span><span class="p">(</span><span class="s">"retrying memcached connection failure: {} (during {})"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="n">retries</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">                        </span><span class="o">*</span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Protocol</span>::<span class="n">new</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">connector</span><span class="p">)().</span><span class="k">await</span><span class="o">?</span><span class="p">);</span><span class="w"></span>
<span class="w">                        </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and so it's not sufficient to just call <code>self.conn.lock()</code> in the parent, because then it will deadlock when trying to retry the connection.</p>



<a name="275861417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275861417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275861417">(Mar 18 2022 at 20:54)</a>:</h4>
<p><del>have you tried asking on Discord</del> /s</p>



<a name="275861604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275861604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275861604">(Mar 18 2022 at 20:56)</a>:</h4>
<p>More usefully, I'd suggest making a MRE. Lowering the activation energy for someone to play with the code often helps.</p>



<a name="275861662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275861662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275861662">(Mar 18 2022 at 20:57)</a>:</h4>
<p>For example, I have 4 minutes to try and help, but would probably use that up trying to make the code make the error in the playground, so instead I'm blabbing here.</p>



<a name="275861866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275861866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275861866">(Mar 18 2022 at 20:58)</a>:</h4>
<p>If you are lucky, you'll be graced by a visit from <strong>Daniel Henry-Mantilla</strong> themselves <span aria-label="angel" class="emoji emoji-1f47c" role="img" title="angel">:angel:</span></p>



<a name="275861961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275861961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275861961">(Mar 18 2022 at 21:00)</a>:</h4>
<p>Wild suggestion, change <code>move |conn: &amp;mut _|</code> to <code>move |conn|</code>.</p>



<a name="275862088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275862088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275862088">(Mar 18 2022 at 21:00)</a>:</h4>
<p>doesn't help unfortunately</p>



<a name="275862148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275862148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275862148">(Mar 18 2022 at 21:01)</a>:</h4>
<p>And maybe look at some of the workarounds mentioned in <a href="https://github.com/rust-lang/rfcs/pull/3216">https://github.com/rust-lang/rfcs/pull/3216</a></p>



<a name="275862530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275862530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275862530">(Mar 18 2022 at 21:04)</a>:</h4>
<p>mcve: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=96674160a310f8ff0a931e5b03ac6cde">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=96674160a310f8ff0a931e5b03ac6cde</a></p>



<a name="275862978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275862978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275862978">(Mar 18 2022 at 21:08)</a>:</h4>
<p>ok, if it helps I removed all the closures and used functions instead, and the errors are <em>more</em> confusing now: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=01b79335bae7d609e708c2b666dcebd5">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=01b79335bae7d609e708c2b666dcebd5</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0308</span><span class="p">]</span>: <span class="nc">mismatched</span><span class="w"> </span><span class="n">types</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">32</span>:<span class="mi">11</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="k">match</span><span class="w"> </span><span class="n">get_with_retries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">get</span><span class="p">).</span><span class="k">await</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">           </span><span class="o">^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">lifetime</span><span class="w"> </span><span class="n">mismatch</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">expected</span><span class="w"> </span><span class="n">associated</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="o">&lt;</span><span class="k">for</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Connection</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="n">get_as_bytes</span>::<span class="p">{</span><span class="n">closure</span>#<span class="mi">0</span><span class="p">}</span>::<span class="n">get</span><span class="p">}</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Connection</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="o">&gt;&gt;</span>::<span class="n">Output</span><span class="err">`</span><span class="w"></span>
<span class="w">              </span><span class="n">found</span><span class="w"> </span><span class="n">associated</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="o">&lt;</span><span class="k">for</span><span class="o">&lt;'</span><span class="nb">_</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Connection</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="n">get_as_bytes</span>::<span class="p">{</span><span class="n">closure</span>#<span class="mi">0</span><span class="p">}</span>::<span class="n">get</span><span class="p">}</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Connection</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="o">&gt;&gt;</span>::<span class="n">Output</span><span class="err">`</span><span class="w"></span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">the</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="n">lifetime</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">necessarily</span><span class="w"> </span><span class="n">outlive</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="n">lifetime</span><span class="w"></span>
<span class="n">note</span>: <span class="nc">the</span><span class="w"> </span><span class="n">lifetime</span><span class="w"> </span><span class="n">requirement</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">introduced</span><span class="w"> </span><span class="n">here</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">13</span>:<span class="mi">44</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">13</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">Connection</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Fut</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                                            </span><span class="o">^^^</span><span class="w"></span>
</code></pre></div>



<a name="275864141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275864141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275864141">(Mar 18 2022 at 21:17)</a>:</h4>
<p>@kpreid on discord suggests that FnMut isn't flexible enough because it doesn't allow the output Future to borrow from the input, and that I should write my own trait</p>



<a name="275866006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275866006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275866006">(Mar 18 2022 at 21:37)</a>:</h4>
<p>ended up having to box the future but it works now :) <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=dc29246e9bca8dae6a2ee7dc64826453">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=dc29246e9bca8dae6a2ee7dc64826453</a></p>



<a name="275869944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275869944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275869944">(Mar 18 2022 at 22:24)</a>:</h4>
<p>Try passing -Zverbose to rustc. That will among other things show the internal representation of placeholder lifetimes, which can help disambiguating them.</p>



<a name="275904456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275904456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ali MJ Al-Nasrawy <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275904456">(Mar 19 2022 at 11:06)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">check</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">Fut</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">F</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="p">())</span><span class="w"> </span>-&gt; <span class="nc">Fut</span><span class="p">,</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>My understanding is this bound doesn't (and shouldn't) allow <code>Fut</code>to borrow from <code>'a</code> , since it is a single type variable that applies forall&lt;'a&gt;.<br>
You probably want to write instead:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">check</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">F</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Fn</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="p">(),)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">Fn</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="p">(),)</span><span class="o">&gt;</span>::<span class="n">Output</span>: <span class="nc">Future</span><span class="p">,</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>but unboxed_closures is unstable and and hrtb on projections is buggy. For this reason,  an new trait with a blanket impl is  necessary:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">AsyncFnMut</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Future</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Output</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Future</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">Fut</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AsyncFnMut</span><span class="o">&lt;</span><span class="p">(</span><span class="n">A</span><span class="p">,)</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Fut</span><span class="p">,</span><span class="w"> </span><span class="n">Fut</span>: <span class="nc">Future</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fut</span>::<span class="n">Output</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fut</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">arg1</span><span class="p">,)</span>: <span class="p">(</span><span class="n">A</span><span class="p">,))</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Future</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="275904548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275904548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ali MJ Al-Nasrawy <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275904548">(Mar 19 2022 at 11:09)</a>:</h4>
<p>then  the bound can be expressed as </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">check</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">F</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AsyncFnMut</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="p">(),),</span><span class="w"> </span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="275929850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275929850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275929850">(Mar 19 2022 at 21:10)</a>:</h4>
<p>Heh, saw the post on Discord before this one, so I answered <a href="https://discord.com/channels/273534239310479360/616791170340880404/954731648270893127">over Discord</a> <span aria-label="see no evil" class="emoji emoji-1f648" role="img" title="see no evil">:see_no_evil:</span> :</p>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="https://discord.com/channels/273534239310479360/616791170340880404/954731648270893127">said</a>:</p>
<blockquote>
<ul>
<li>
<p>Removing the last clone but passing <code>key</code>:<br>
   &lt;<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=7d2297ce9579f838a6af048685d4c55b">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=7d2297ce9579f838a6af048685d4c55b</a>&gt;</p>
</li>
<li>
<p>Removing it and not passing it:<br>
   &lt;<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=4ee34e322e7161f85581da26e5b43782">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=4ee34e322e7161f85581da26e5b43782</a>&gt;</p>
</li>
</ul>
<p>(see <a href="https://users.rust-lang.org/t/argument-requires-that-is-borrowed-for-static/66503/2?u=yandros">https://users.rust-lang.org/t/argument-requires-that-is-borrowed-for-static/66503/2?u=yandros</a> for more info about it)</p>
<p>Basically you don't need to pass <code>key</code>, but you need to pass some lifetime parameter, such as the <code>'key</code> in <code>&amp;'key</code>, to act as an upper-bound on the universal quantification of <code>for&lt;&gt;</code>, so that it does convey <code>for&lt;'local&gt;</code> semantics only, and not also the <code>for&lt;'a which could also be 'static&gt;</code> default semantics</p>
</blockquote>



<a name="275929876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275929876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275929876">(Mar 19 2022 at 21:11)</a>:</h4>
<p>(We need <code>where</code> clauses inside <code>for</code> quantifications so badly <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span>)</p>



<a name="275929947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/create%20an%20async%20block%20that%20uses%20%26mut%20parameter/near/275929947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/create.20an.20async.20block.20that.20uses.20.26mut.20parameter.html#275929947">(Mar 19 2022 at 21:13)</a>:</h4>
<p>(with those your fix would just be:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- for&lt;'any&gt; F : Fn...</span><span class="w"></span>
<span class="gi">+ for&lt;'local where 'upper_bounded : 'local&gt; F : Fn...</span><span class="w"></span>
</code></pre></div>
<p>)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>