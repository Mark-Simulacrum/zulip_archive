<html>
<head><meta charset="utf-8"><title>Thread locals on the gpu · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Thread.20locals.20on.20the.20gpu.html">Thread locals on the gpu</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267360289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Thread%20locals%20on%20the%20gpu/near/267360289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Thread.20locals.20on.20the.20gpu.html#267360289">(Jan 09 2022 at 14:19)</a>:</h4>
<p>I just realized something, couldn't thread locals be codegenned on the GPU (CUDA) just fine by making a static in the local addrspace? Local memory is per-thread cache (well, in reality its global memory with interleaved addressing but...) which every thread has access to.  When storing/loading to it, cuda will manage the "giving each thread the correct spot" part. I cannot think of any major soundness concerns but i have also like never used thread locals before so i wanted other people's opinions <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="267360688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Thread%20locals%20on%20the%20gpu/near/267360688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Thread.20locals.20on.20the.20gpu.html#267360688">(Jan 09 2022 at 14:29)</a>:</h4>
<p>Can one thread pass a pointer to it's local memory to another thread? Thread locals allow this.</p>



<a name="267360941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Thread%20locals%20on%20the%20gpu/near/267360941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Thread.20locals.20on.20the.20gpu.html#267360941">(Jan 09 2022 at 14:35)</a>:</h4>
<p>I am honestly not sure, threads can pass stuff to eachother using shared mem but idk if trying getting the address of a thread local static will yield different or same pointers in cuda</p>



<a name="267361173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Thread%20locals%20on%20the%20gpu/near/267361173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Thread.20locals.20on.20the.20gpu.html#267361173">(Jan 09 2022 at 14:41)</a>:</h4>
<p>local memory is kind of weird, because CUDA C++ has no way of declaring a local global AFAIK, the local addrspace is kind of a thing that isn't really used. But in theory because NVVM IR accepts the local addrspace for globals, it should work fine</p>



<a name="267361176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Thread%20locals%20on%20the%20gpu/near/267361176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Thread.20locals.20on.20the.20gpu.html#267361176">(Jan 09 2022 at 14:41)</a>:</h4>
<p>I can actually try it right now, let's see</p>



<a name="267361324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Thread%20locals%20on%20the%20gpu/near/267361324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Thread.20locals.20on.20the.20gpu.html#267361324">(Jan 09 2022 at 14:45)</a>:</h4>
<p>haha ok no libnvvm does not like this </p>
<div class="codehilite"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;Malformed NVVM IR program rejected by libnvvm, dumping verifier log:

  Error: : Global Variable `_ZN7add_gpu3FOO17h35bdd6f189b7dcd8E&#39;:
    context: @_ZN7add_gpu3FOO17h35bdd6f189b7dcd8E = internal addrspace(5) global &lt;{ [4 x i8] }&gt; &lt;{ [4 x i8] c&quot;\05\00\00\00&quot; }&gt;, align 4
    Invalid address space for global variable
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>