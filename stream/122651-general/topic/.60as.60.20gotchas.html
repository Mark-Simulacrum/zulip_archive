<html>
<head><meta charset="utf-8"><title>`as` gotchas · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html">`as` gotchas</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="218040065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218040065" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218040065">(Nov 26 2020 at 21:36)</a>:</h4>
<p>I don't feel like I understand the keyword <code>as</code>. Its primary purpose seems to be for casting between primitive types, but it will happily truncate without letting you know, which I find very confusing. I also don't feel like I know whether and when I should use <code>as</code> or <code>try_into</code>.</p>
<p>I've been meaning to ask about this for a while, but <a href="https://github.com/rust-lang/rust/issues/79447">#79447</a> is what got me to do it now.</p>



<a name="218040712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218040712" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218040712">(Nov 26 2020 at 21:49)</a>:</h4>
<p>you should use <code>as</code> if you just want to truncate. use <code>try_into</code> if you want to handle the case that the source does not fit in the dest.</p>



<a name="218040814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218040814" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218040814">(Nov 26 2020 at 21:52)</a>:</h4>
<p>Yeah, try_into is when you need custom overflow handling. Often it's just used as <code>.try_into().unwrap()</code> to panic on overflow.</p>



<a name="218043256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218043256" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218043256">(Nov 26 2020 at 22:44)</a>:</h4>
<p>Ah, so <code>as</code> should not be used if I'm, say, casting a <code>usize</code> to a <code>u32</code>?</p>



<a name="218043276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218043276" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218043276">(Nov 26 2020 at 22:45)</a>:</h4>
<p>I feel like the <code>as</code> keyword doesn't have the best design: I wouldn't immediately think that it can change the underlying value.</p>



<a name="218043282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218043282" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218043282">(Nov 26 2020 at 22:45)</a>:</h4>
<p>We probably can't/shouldn't change it at this point though <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="218043925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218043925" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Poliorcetics <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218043925">(Nov 26 2020 at 23:00)</a>:</h4>
<p>The docs are being improved to help with this: <a href="https://github.com/rust-lang/rust/pull/78086">https://github.com/rust-lang/rust/pull/78086</a></p>



<a name="218043931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218043931" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Poliorcetics <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218043931">(Nov 26 2020 at 23:01)</a>:</h4>
<p>Oh, you reviewed this so you obviously know <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="218044072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044072" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044072">(Nov 26 2020 at 23:04)</a>:</h4>
<p>Yeah, the problem for me is that it's not apparent from the code that it truncates. Rust is generally very safe (that's one of the primary selling points, after all!), so <code>as</code> potentially truncating feels surprising to me.</p>



<a name="218044083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044083" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Poliorcetics <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044083">(Nov 26 2020 at 23:04)</a>:</h4>
<p>I find it apparent: there is an <code>as &lt;something&gt;</code></p>



<a name="218044089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044089" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044089">(Nov 26 2020 at 23:04)</a>:</h4>
<p>I'm not sure what you mean</p>



<a name="218044114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044114" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044114">(Nov 26 2020 at 23:05)</a>:</h4>
<p>The issue for me is I would assume that <code>as</code> won't lose any data. I think <code>300.truncate_into::&lt;u8&gt;()</code> would be much clearer</p>



<a name="218044155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044155" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044155">(Nov 26 2020 at 23:06)</a>:</h4>
<p>cc <a href="#narrow/stream/122651-general/topic/Alternative.20to.20.60as.60.20for.20truncation.3F">https://rust-lang.zulipchat.com/#narrow/stream/122651-general/topic/Alternative.20to.20.60as.60.20for.20truncation.3F</a></p>



<a name="218044168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044168" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044168">(Nov 26 2020 at 23:06)</a>:</h4>
<p><code>as</code> is one of those things that you write "don't use it unless you are absolutely sure you want it" in your style guidelines ^^</p>



<a name="218044169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044169" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Poliorcetics <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044169">(Nov 26 2020 at 23:06)</a>:</h4>
<p><code>my_variable as u8</code> is (to me) something <code>unsafe</code> so I always review it more thoroughly (I view it a little like a cast in C)</p>



<a name="218044188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044188" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044188">(Nov 26 2020 at 23:07)</a>:</h4>
<p>That's what I'm saying: I think <code>as</code> should be either unsafe or shouldn't exist and be replaced by a clearer operation/function</p>



<a name="218044199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044199" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044199">(Nov 26 2020 at 23:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218044168">said</a>:</p>
<blockquote>
<p><code>as</code> is one of those things that you write "don't use it unless you are absolutely sure you want it" in your style guidelines ^^</p>
</blockquote>
<p>Yeah, I just wish it were apparent in the code :)</p>



<a name="218044207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044207" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Poliorcetics <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044207">(Nov 26 2020 at 23:07)</a>:</h4>
<p>Too late though I think</p>



<a name="218044212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044212" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Poliorcetics <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044212">(Nov 26 2020 at 23:07)</a>:</h4>
<p>or at least without an edition</p>



<a name="218044287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044287" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044287">(Nov 26 2020 at 23:09)</a>:</h4>
<blockquote>
<p>I think as should be either unsafe </p>
</blockquote>
<p>I've heard this before and as someone who writes a lot of unsafe please no. Harmless unsafe is the enemy of easy reviews.</p>



<a name="218044449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218044449" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218044449">(Nov 26 2020 at 23:13)</a>:</h4>
<p>cf. <a href="https://doc.rust-lang.org/reference/behavior-not-considered-unsafe.html">behaviour considered not unsafe</a>.</p>



<a name="218059099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218059099" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oliver <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218059099">(Nov 27 2020 at 06:02)</a>:</h4>
<p>I'm sure that I would suspect <code>as</code> to lose data</p>



<a name="218066116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218066116" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oliver <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218066116">(Nov 27 2020 at 08:22)</a>:</h4>
<p>like the way <code>bstr</code> handles invalid UTF-8</p>



<a name="218080136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218080136" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218080136">(Nov 27 2020 at 11:10)</a>:</h4>
<p>Agreed<br>
<a href="https://github.com/rust-lang/rfcs/issues/2784">https://github.com/rust-lang/rfcs/issues/2784</a></p>



<a name="218084462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218084462" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218084462">(Nov 27 2020 at 12:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307289">Poliorcetics</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218044169">said</a>:</p>
<blockquote>
<p><code>my_variable as u8</code> is (to me) something <code>unsafe</code> so I always review it more thoroughly (I view it a little like a cast in C)</p>
</blockquote>
<p>Rather than marking it as UB-inducing memory-<code>unsafe</code>, which it is not (on its own),  you can <code>#![deny(…)]</code> <a href="https://rust-lang.github.io/rust-clippy/master/#cast">the associated <code>clippy</code> lints</a>, and if an <code>as</code> cast is direly needed, then an <em>ad-hoc</em> <code>#[allow(…)] { … }</code> block can be used instead of <code>unsafe</code>. Similar amount of "code noise" to capture the reviewer eye, while not diluting the meaning of <code>unsafe</code> <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="218085387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218085387" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Þórhallur Sverrisson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218085387">(Nov 27 2020 at 12:16)</a>:</h4>
<p>I know this would require an edition change ,but I see no problem with upcasting (eg u8 -&gt; u32), but any case that potentially loses data or changes the meaning should not compile, or require unsafe.  There could also be a truncate_into (if it doesn't already exist) that would just perform the downcast.</p>
<p>u8 as u32 -&gt; compiles<br>
u32 as u8 -&gt; does not compile, suggests try_into<br>
i32 as u32 -&gt; does not compile ,suggests try_into</p>



<a name="218085493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218085493" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218085493">(Nov 27 2020 at 12:18)</a>:</h4>
<p>this should not be <code>unsafe</code>, <code>unsafe</code> means something very different</p>



<a name="218085799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218085799" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Þórhallur Sverrisson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218085799">(Nov 27 2020 at 12:22)</a>:</h4>
<p>True, I would rather it just does not compile.  If you want a downcast that potentially loses data, be explicit.</p>



<a name="218085942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218085942" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218085942">(Nov 27 2020 at 12:24)</a>:</h4>
<p><code>try_into</code> does not easily allow replicating the old behavior, so that is not a reasonable suggestion for existing code</p>



<a name="218085997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218085997" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Poliorcetics <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218085997">(Nov 27 2020 at 12:25)</a>:</h4>
<blockquote>
<p>Rather than marking it as UB-inducing memory-<code>unsafe</code>, which it is not (on its own),  you can <code>#[deny(…)]</code> <a href="https://rust-lang.github.io/rust-clippy/master/#cast">the associated <code>clippy</code> lints</a>, and if an <code>as</code> cast is direly needed, then an <em>ad-hoc</em> <code>#[allow(…)] { … }</code> block can be used instead of <code>unsafe</code>. Similar amount of "code noise" to capture the reviewer eye, while not diluting the meaning of <code>unsafe</code> <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>
</blockquote>
<p>I wasn’t advocating for <code>unsafe</code> around <code>as</code>, just for the need to review it a little more closely than normal safe rust <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>. I didn’t know the solution of deny+allow blocks, I’ll use it in the future !</p>



<a name="218086942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218086942" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Þórhallur Sverrisson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218086942">(Nov 27 2020 at 12:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211727">Jonas Schievink</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218085942">said</a>:</p>
<blockquote>
<p><code>try_into</code> does not easily allow replicating the old behavior, so that is not a reasonable suggestion for existing code</p>
</blockquote>
<p>but truncate_into could, while being more explicit.  Don't get me wrong, I come from a C background so losing data on downcasting is nothing new but has bitten me quite a bit in the past, especially when refactoring and changing data types.  'as' could also be changed to generate a warning on possible data loss, not sure if that would require a new edition.</p>



<a name="218087278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218087278" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218087278">(Nov 27 2020 at 12:39)</a>:</h4>
<p>Yeah, I'd be in favor of adding explicit truncation methods too, but we can only suggest them once they exist (and are stable)</p>



<a name="218126587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218126587" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218126587">(Nov 27 2020 at 20:20)</a>:</h4>
<p>Writing a proposal right now</p>



<a name="218127249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218127249" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218127249">(Nov 27 2020 at 20:32)</a>:</h4>
<p>Opened <a href="https://github.com/rust-lang/rust/issues/79477">#79477</a></p>



<a name="218131627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218131627" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218131627">(Nov 27 2020 at 21:52)</a>:</h4>
<p>I think this needs to be an RFC tbh, not just an issue. There's already one <a href="https://github.com/rust-lang/rfcs/pull/2484">https://github.com/rust-lang/rfcs/pull/2484</a>, even</p>



<a name="218134109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218134109" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218134109">(Nov 27 2020 at 22:38)</a>:</h4>
<p>I didn't realize there was an RFC and I don't feel like I'm ready to do an RFC yet though</p>



<a name="218134112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218134112" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218134112">(Nov 27 2020 at 22:38)</a>:</h4>
<p>Probably will just merge the conversation into the other RFC or something</p>



<a name="218151036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218151036" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218151036">(Nov 28 2020 at 06:33)</a>:</h4>
<p>Using <code>as</code> is plenty explicit. And you can already get a warning on possible data loss if you just use clippy.</p>
<p>So just uplift that one clippy lint (allow by default please) and you should be good</p>



<a name="218154958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218154958" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> isHavvy <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218154958">(Nov 28 2020 at 08:45)</a>:</h4>
<p>I think the myriad uses of <code>as</code> all thrown into a single operator was a bad decision, and having its myriad uses all covered by specific functions (that can just be <code>x as y</code> in implementation would be better for readability and also easier to document.</p>



<a name="218183057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218183057" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218183057">(Nov 28 2020 at 21:57)</a>:</h4>
<p>I would definitely like the short thing -- <code>as</code> -- to eventually stop doing some of the weirder things, like <code>*const</code> to <code>*mut</code> casts.</p>



<a name="218183096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218183096" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218183096">(Nov 28 2020 at 21:58)</a>:</h4>
<p><span class="user-mention" data-user-id="307537">@Camelid</span> I think I prefer the <code>WrappingInto</code> from &lt;<a href="https://github.com/rust-lang/rfcs/pull/2484">https://github.com/rust-lang/rfcs/pull/2484</a>&gt; because it also works for sign conversions.  (<code>i16</code> &lt;-&gt; <code>u8</code> isn't quite truncation, to me, but works fine as wrapping.)</p>



<a name="218183146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218183146" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218183146">(Nov 28 2020 at 21:58)</a>:</h4>
<p>Would be great to pull the non-floating-point parts of that out and hopefully make progress on it.</p>



<a name="218183171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218183171" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218183171">(Nov 28 2020 at 21:59)</a>:</h4>
<p>Since <code>as</code> definitely can't change without the alternatives having been around for ages.</p>



<a name="218196937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218196937" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218196937">(Nov 29 2020 at 05:19)</a>:</h4>
<p>Question: If you use <code>mem::transmute::&lt;&amp;T, &amp;U&gt;(x)</code>, clippy's <code>transmute_ptr_to_ptr</code> lint will suggest something involving an <code>as</code> cast, namely <code>&amp;*(x as *const T as *const U)</code>. Is this actually better? Do we have an alternative that doesn't use <code>as</code>?</p>



<a name="218197148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218197148" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> isHavvy <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218197148">(Nov 29 2020 at 05:26)</a>:</h4>
<p>Again, just my opinion, but instead of changing <code>as</code>, just make all of its operations functions, document how they work without mentioning <code>as</code>, and then de-emphasize <code>as</code> in all documentation (except the reference unfortunately; though we can point at the functions there too). It'd be mentioned only for completeness. Maybe even make it a contextual keyword so we could made <code>as</code> a method if we've determined one of the use cases is better suited with such a short name.</p>
<p>Of course, at that point, you could add a lint with a machine fix and maybe someday just remove the operator (like a decade from now) in favor of intrinsics,</p>



<a name="218198451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218198451" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218198451">(Nov 29 2020 at 06:09)</a>:</h4>
<p>Is it an option to stabilize <code>u16::truncate_u8</code>, <code>u32::truncate_i8</code> and so on without stabilizing the traits yet (which are open ended and so need additional design work beyond just the functionality itself)? That seems easier, although perhaps people will object that it's polluting the namespace of the type with lots and lots of functions (which I don't think is a real problem). You can't use <code>as</code> generically anyway so it's no loss.</p>



<a name="218233148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233148" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233148">(Nov 29 2020 at 22:06)</a>:</h4>
<p>Even if we don't remove <code>as</code>, once we have replacement functions for all of its uses we can have various compiler lints (note: I think compiler lints are better than clippy for <code>as</code>) that 'soft-deprecate' it (warn on usage) and then we can 'hard-deprecate' (error on usage, but it will be a lint so deps don't break) it. I'm not sure if we can ever remove it completely (maybe in Rust 2.0 if that ever happens?)</p>



<a name="218233150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233150" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233150">(Nov 29 2020 at 22:06)</a>:</h4>
<p>Ugh, stability is so hard!</p>



<a name="218233165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233165" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233165">(Nov 29 2020 at 22:07)</a>:</h4>
<blockquote>
<p>we can 'hard-deprecate' (error on usage, but it will be a lint so deps don't break) it</p>
</blockquote>
<p>(the term for this is 'deny-by-default')</p>



<a name="218233167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233167" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233167">(Nov 29 2020 at 22:07)</a>:</h4>
<p>Yeah, I forgot about that term :)</p>



<a name="218233205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233205" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233205">(Nov 29 2020 at 22:08)</a>:</h4>
<p><code>as</code> itself is not just used for numeric conversions</p>



<a name="218233207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233207" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233207">(Nov 29 2020 at 22:08)</a>:</h4>
<p>I think we can have warn-by-default without a new edition, but deny-by-default would require one – perhaps in Rust 2023 (or whatever comes after 2021)</p>



<a name="218233208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233208" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233208">(Nov 29 2020 at 22:08)</a>:</h4>
<p>I know</p>



<a name="218233213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233213" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233213">(Nov 29 2020 at 22:08)</a>:</h4>
<p><code>Box::new(vec![]) as Box&lt;dyn Debug&gt;</code> should not ever be a warning IMO</p>



<a name="218233214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233214" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233214">(Nov 29 2020 at 22:08)</a>:</h4>
<p>even if there is a new way to do it</p>



<a name="218233224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233224" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233224">(Nov 29 2020 at 22:09)</a>:</h4>
<p>and I think warn-by-default for numeric conversions is still very aggressive considering the number of codebases using it</p>



<a name="218233225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233225" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233225">(Nov 29 2020 at 22:09)</a>:</h4>
<p>That's the problem; it's so overloaded:</p>
<ul>
<li>Exact numeric conversions</li>
<li>Lossy numeric conversions</li>
<li><code>*const</code> to <code>*mut</code> -- this one is scary!</li>
<li>etc.</li>
</ul>



<a name="218233232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233232" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233232">(Nov 29 2020 at 22:09)</a>:</h4>
<p>Perhaps only warn-by-default for lossy conversions?</p>



<a name="218233237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233237" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233237">(Nov 29 2020 at 22:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Camelid</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218233232">said</a>:</p>
<blockquote>
<p>Perhaps only warn-by-default for lossy conversions?</p>
</blockquote>
<p>sure, but I still think that's better as a clippy lint</p>



<a name="218233240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233240" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233240">(Nov 29 2020 at 22:09)</a>:</h4>
<p>You can only warn against something if there's an alternative way of doing it</p>



<a name="218233258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233258" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233258">(Nov 29 2020 at 22:10)</a>:</h4>
<p>it's not <em>incorrect</em> code, it's code that could be written bettter</p>



<a name="218233287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233287" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233287">(Nov 29 2020 at 22:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218233213">said</a>:</p>
<blockquote>
<p><code>Box::new(vec![]) as Box&lt;dyn Debug&gt;</code> should not ever be a warning IMO</p>
</blockquote>
<p>I didn't even know that was a thing! I agree, since that's a purely type-based cast.</p>



<a name="218233295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233295" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233295">(Nov 29 2020 at 22:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211727">Jonas Schievink</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218233240">said</a>:</p>
<blockquote>
<p>You can only warn against something if there's an alternative way of doing it</p>
</blockquote>
<p>Yes, this would be <em>after</em> alternatives have been around for a while</p>



<a name="218233298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233298" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233298">(Nov 29 2020 at 22:10)</a>:</h4>
<blockquote>
<p>*const to *mut -- this one is scary!</p>
</blockquote>
<p>FWIW I don't find this particularly scary, <code>cast()</code> is <em>better</em> but that's still a clippy sort of lint</p>



<a name="218233313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233313" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233313">(Nov 29 2020 at 22:11)</a>:</h4>
<p>When I first started doing Rust, I was doing some FFI stuff and didn't understand that <code>const</code> and <code>mut</code> are just annotations for pointers -- they don't actually enforce anything, unlike <code>&amp;</code> vs <code>&amp;mut</code></p>



<a name="218233320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233320" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233320">(Nov 29 2020 at 22:11)</a>:</h4>
<p>So it's very confusing when you can suddenly treat something that's const as mut without <code>unsafe</code> and without something explicit</p>



<a name="218233329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233329" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233329">(Nov 29 2020 at 22:12)</a>:</h4>
<p>that seems like a reason to make const/mut conversions <em>less</em> scary and document this better</p>



<a name="218233346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233346" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233346">(Nov 29 2020 at 22:12)</a>:</h4>
<p>Likewise, only recently did I realize that <code>300 as u8</code> will truncate</p>



<a name="218233368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233368" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233368">(Nov 29 2020 at 22:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218233329">said</a>:</p>
<blockquote>
<p>that seems like a reason to make const/mut conversions <em>less</em> scary and document this better</p>
</blockquote>
<p>What do you mean?</p>



<a name="218233373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233373" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233373">(Nov 29 2020 at 22:12)</a>:</h4>
<p><code>&amp;x as *const as *mut</code> is not unreasonable code, I've written it</p>



<a name="218233375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233375" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233375">(Nov 29 2020 at 22:12)</a>:</h4>
<p>it happens a lot when you use C libraries that don't use <code>const</code> annotations</p>



<a name="218233388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233388" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233388">(Nov 29 2020 at 22:13)</a>:</h4>
<p>I'm not saying it should be barred, just that it should be more explicit</p>



<a name="218233393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233393" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233393">(Nov 29 2020 at 22:13)</a>:</h4>
<p>it's already unsafe to pass it to the function or dereference it, I don't htink we need to make the cast itself another layer of warnings</p>



<a name="218233398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233398" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233398">(Nov 29 2020 at 22:13)</a>:</h4>
<p>it seems pretty explicit to me</p>



<a name="218233445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233445" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233445">(Nov 29 2020 at 22:14)</a>:</h4>
<p>I don't feel that documentation is a good solution -- I only look at docs if I don't think I understand something. Generally Rust guarantees that the compiler will tell you if something is wrong, so it's surprising when a truncating cast is not explicit</p>



<a name="218233457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233457" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233457">(Nov 29 2020 at 22:14)</a>:</h4>
<p><a href="https://internals.rust-lang.org/t/not-explicit/6430">https://internals.rust-lang.org/t/not-explicit/6430</a></p>



<a name="218233463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233463" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233463">(Nov 29 2020 at 22:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218233398">said</a>:</p>
<blockquote>
<p>it seems pretty explicit to me</p>
</blockquote>
<p>It's explicit in the case you said, but if the <code>*const</code> is coming from somewhere far away in the code, it may not be immediately apparent that you're changing a const to a mut</p>



<a name="218233468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233468" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233468">(Nov 29 2020 at 22:15)</a>:</h4>
<p>that's any property of unsafe code, though</p>



<a name="218233471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233471" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233471">(Nov 29 2020 at 22:15)</a>:</h4>
<p>why should this one be singled out?</p>



<a name="218233520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233520" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233520">(Nov 29 2020 at 22:16)</a>:</h4>
<p>I would think that casting const to mut is unsafe -- but I don't write much unsafe code, so maybe this is not an issue in practice</p>



<a name="218233536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233536" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233536">(Nov 29 2020 at 22:17)</a>:</h4>
<p>no, casting *const to *mut can never cause UB</p>



<a name="218233548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233548" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233548">(Nov 29 2020 at 22:17)</a>:</h4>
<p>it's only dereferencing the pointer that's an issue, and that's already unsafe</p>



<a name="218233553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233553" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233553">(Nov 29 2020 at 22:17)</a>:</h4>
<p>What's the point of const and mut on pointers then?</p>



<a name="218233560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233560" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233560">(Nov 29 2020 at 22:17)</a>:</h4>
<p>not much really - they're annotations to the reader more than anything else</p>



<a name="218233561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233561" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233561">(Nov 29 2020 at 22:17)</a>:</h4>
<p><code>*const T</code> is covariant, <code>*mut T</code> is invariant</p>



<a name="218233604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233604" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233604">(Nov 29 2020 at 22:18)</a>:</h4>
<p>This mirrors <code>&amp;T</code> vs. <code>&amp;mut T</code></p>



<a name="218233607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233607" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233607">(Nov 29 2020 at 22:18)</a>:</h4>
<p>But other than that it's mostly a lint</p>



<a name="218233616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233616" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233616">(Nov 29 2020 at 22:18)</a>:</h4>
<p>What does variance mean in practice?</p>



<a name="218233620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233620" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233620">(Nov 29 2020 at 22:18)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nomicon/subtyping.html#variance">https://doc.rust-lang.org/nomicon/subtyping.html#variance</a></p>



<a name="218233654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233654" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233654">(Nov 29 2020 at 22:20)</a>:</h4>
<p>I'm looking at that</p>



<a name="218233746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233746" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233746">(Nov 29 2020 at 22:22)</a>:</h4>
<p>I think I'll have to read that section in-depth before I truly understand *const vs *mut. Anyway, it seems that (at least for now) keeping <code>*const as *mut</code> is okay</p>



<a name="218233753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233753" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233753">(Nov 29 2020 at 22:22)</a>:</h4>
<p>The main thing I would like to discourage use of is <code>300 as u8</code> (once we have a suitable alternative)</p>



<a name="218233817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218233817" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218233817">(Nov 29 2020 at 22:24)</a>:</h4>
<p>Yeah that just needs a scheme for generic truncation</p>



<a name="218235859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218235859" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Poliorcetics <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218235859">(Nov 29 2020 at 23:23)</a>:</h4>
<p>I’ve read explanations on variance I think at least once a month since I use Rust and I still have trouble remembering the differences. It just doesn’t matter to me the vast majority of the time, it’s either my code compiled and the tests showed it worked or not ^^</p>



<a name="218241897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218241897" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Quy Nguyen <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218241897">(Nov 30 2020 at 01:58)</a>:</h4>
<p>The problem with as being overloaded is that you can convert a const to a mut when you just want to do type punning, and now that's a potential vector of UB that's pretty difficult to audit.</p>



<a name="218242866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218242866" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218242866">(Nov 30 2020 at 02:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307289">Poliorcetics</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218235859">said</a>:</p>
<blockquote>
<p>It just doesn’t matter to me the vast majority of the time, it’s either my code compiled and the tests showed it worked or not ^^</p>
</blockquote>
<p>It basically only matters for structs with lifetimes or references in them. e.g. <code>Vec&lt;Foo&lt;'a&gt;&gt;</code> would be more annoying to use if <code>Vec&lt;T&gt;</code> had gotten the wrong variance on <code>T</code>. Ditto for <code>Vec&lt;&amp;Foo&gt;</code>.</p>



<a name="218245562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218245562" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218245562">(Nov 30 2020 at 03:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Camelid</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218233287">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218233213">said</a>:</p>
<blockquote>
<p><code>Box::new(vec![]) as Box&lt;dyn Debug&gt;</code> should not ever be a warning IMO</p>
</blockquote>
<p>I didn't even know that was a thing! I agree, since that's a purely type-based cast.</p>
</blockquote>
<p>We should have type ascription for that</p>



<a name="218245592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218245592" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218245592">(Nov 30 2020 at 03:39)</a>:</h4>
<p>I really don't care what the syntax is, but it's a travesty that rust doesn't have type ascription</p>



<a name="218245613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218245613" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218245613">(Nov 30 2020 at 03:40)</a>:</h4>
<p>is there a macro for this? It probably can't be done outside the compiler with all the details of lvalues etc</p>



<a name="218246150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218246150" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> isHavvy <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218246150">(Nov 30 2020 at 03:50)</a>:</h4>
<p>That's not type ascription. That is actually a cast. I'd also like a function for that.</p>



<a name="218247093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218247093" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218247093">(Nov 30 2020 at 04:11)</a>:</h4>
<p>Oh, I thought the cast happens inside the argument to <code>Box::new</code></p>



<a name="218247142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218247142" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218247142">(Nov 30 2020 at 04:12)</a>:</h4>
<p>i.e. that is really <code>Box::&lt;dyn Debug&gt;::new(vec![])</code></p>



<a name="218247152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218247152" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218247152">(Nov 30 2020 at 04:12)</a>:</h4>
<p>TBH unsizing casts are a bit magic to me</p>



<a name="218250145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218250145" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> isHavvy <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218250145">(Nov 30 2020 at 05:27)</a>:</h4>
<p>Actually, a function wouldn't work since you can't pass in a trait as a parameter.</p>



<a name="218260932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218260932" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218260932">(Nov 30 2020 at 08:53)</a>:</h4>
<p>The main thing that would eliminate the vast majority of calls to <code>as</code> for me is a way to assert "no, really, I'm on a platform where usize is 64-bit, let me convert losslessly between usize and u64 without any possibility of error".</p>



<a name="218261972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218261972" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218261972">(Nov 30 2020 at 09:05)</a>:</h4>
<p>you could write a function to do that</p>



<a name="218342320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218342320" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218342320">(Nov 30 2020 at 20:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218196937">said</a>:</p>
<blockquote>
<p>Question: If you use <code>mem::transmute::&lt;&amp;T, &amp;U&gt;(x)</code>, clippy's <code>transmute_ptr_to_ptr</code> lint will suggest something involving an <code>as</code> cast, namely <code>&amp;*(x as *const T as *const U)</code>. Is this actually better? Do we have an alternative that doesn't use <code>as</code>?</p>
</blockquote>
<p>There's <a href="https://doc.rust-lang.org/std/primitive.pointer.html#method.cast">https://doc.rust-lang.org/std/primitive.pointer.html#method.cast</a>, at least.  Though really it's safe-transmute that will be the solution eventually, in many cases.</p>



<a name="218342434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218342434" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218342434">(Nov 30 2020 at 20:37)</a>:</h4>
<blockquote>
<p>If you use mem::transmute::&lt;&amp;T, &amp;U&gt;(x), clippy's transmute_ptr_to_ptr lint will suggest something involving an as cast, namely &amp;*(x as *const T as *const U). Is this actually better?</p>
</blockquote>
<p>this is what transmute always does, no?</p>



<a name="218342459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218342459" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218342459">(Nov 30 2020 at 20:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218233536">said</a>:</p>
<blockquote>
<p>no, casting *const to *mut can never cause UB</p>
</blockquote>
<p>While that's true, it's also a really, really easy footgun -- see this soundness mistake in <code>core</code> that a warning about this would have helped catch: <a href="https://blog.rust-lang.org/2017/02/09/Rust-1.15.1.html#whats-in-1151-stable">https://blog.rust-lang.org/2017/02/09/Rust-1.15.1.html#whats-in-1151-stable</a></p>



<a name="218342483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218342483" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218342483">(Nov 30 2020 at 20:37)</a>:</h4>
<p>oh I see you don't take a reference to <code>x</code> inside the parentheses</p>



<a name="218342650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218342650" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steven Fackler <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218342650">(Nov 30 2020 at 20:38)</a>:</h4>
<p>the 1.15.1 issue wasn't a *const to *mut cast, it was an *mut accessed through a &amp;self</p>



<a name="218342694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218342694" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218342694">(Nov 30 2020 at 20:39)</a>:</h4>
<p><span class="user-mention" data-user-id="243558">@Steven Fackler</span> <code>self.ptr</code> is a <code>*const</code>, no?</p>



<a name="218342720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218342720" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steven Fackler <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218342720">(Nov 30 2020 at 20:39)</a>:</h4>
<p>oh yeah I guess that's right</p>



<a name="218342778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218342778" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218342778">(Nov 30 2020 at 20:39)</a>:</h4>
<p><code>as</code> casts on raw ptrs are pretty dangerous IMO -- when the surrounding code changes, what is being cast can change drastically</p>



<a name="218342846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218342846" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218342846">(Nov 30 2020 at 20:40)</a>:</h4>
<p>also this can silently cast immutable to mutable pointers, accidentally</p>



<a name="218342966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218342966" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218342966">(Nov 30 2020 at 20:41)</a>:</h4>
<p>so I agree with the general stanza voiced above -- <code>as</code> should be avoided</p>



<a name="218343039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218343039" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steven Fackler <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218343039">(Nov 30 2020 at 20:41)</a>:</h4>
<p>it seems like we should add <code>cast_mut</code> and <code>cast_const</code> methods to <code>*mut</code> and <code>*const</code> to help with that</p>



<a name="218343160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218343160" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218343160">(Nov 30 2020 at 20:42)</a>:</h4>
<p>that, and <code>cast</code> that does <em>not</em> change mutability</p>



<a name="218343393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60as%60%20gotchas/near/218343393" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://rust-lang.github.io/zulip_archive/stream/122651-general/topic/.60as.60.20gotchas.html#218343393">(Nov 30 2020 at 20:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/122651-general/topic/.60as.60.20gotchas/near/218233213">said</a>:</p>
<blockquote>
<p><code>Box::new(vec![]) as Box&lt;dyn Debug&gt;</code> should not ever be a warning IMO</p>
</blockquote>
<p>Agreed.  If we eventually do start warning on specific <code>as</code> instances, it would be for the sketchier ones, not the ones that are also coercions.</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>