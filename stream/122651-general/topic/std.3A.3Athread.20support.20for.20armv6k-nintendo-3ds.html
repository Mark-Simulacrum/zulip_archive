<html>
<head><meta charset="utf-8"><title>std::thread support for armv6k-nintendo-3ds · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html">std::thread support for armv6k-nintendo-3ds</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271654826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/std%3A%3Athread%20support%20for%20armv6k-nintendo-3ds/near/271654826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian Chamberlain <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html#271654826">(Feb 11 2022 at 23:56)</a>:</h4>
<p>Hi everyone, I have been working with a small group of people to add  <code>std</code> support for the recently added <code>armv6k-nintendo-3ds</code> target (<a href="https://github.com/rust-lang/rust/pull/88529">https://github.com/rust-lang/rust/pull/88529</a>) . A lot of the changes have just been adding <code>#[cfg]</code> where needed to enable std, but we have found some places where <code>std</code> doesn't provide as much of an API as we'd like.</p>
<p>Specifically in this case <code>std::thread</code> does not seem to provide any API for setting CPU affinity or priority, which are usually required on the 3DS due to its cooperative threading model. So, we have a model with an extension trait that lives in <code>std::os::horizon</code> (OS-specific module), but it would require some code changes to other <code>sys::thread</code> modules in order to function properly.</p>
<p>So, I basically have two questions:</p>
<ol>
<li>For the best chance of upstreaming the changes for <code>std</code> working on our target, how should we approach PRs to mainline? All the work is in a fork for now and requires some special linking with other crates and <code>-Zbuild-std</code> to work, but the majority of the code changes to <code>std</code> are fairly minimal. It does seem preferred to avoid a huge PR all at once to merge support, though...</li>
<li>For larger changes like adding an OS-specific extension trait to <code>std::thread::ThreadBuilder</code>, would we need to create an RFC  or MCP ? This is not something that would impact any other OS users, and is mostly an implementation detail within <code>sys::thread::ThreadBuilder</code>, but it does include some public surface area, so we wanted to make sure adding something like this wouldn't prevent a merge upstream. </li>
</ol>
<p>Thanks in advance for your help. Any advice from maintainers / other <code>std</code> hackers appreciated.</p>
<p>CC <span class="user-mention" data-user-id="452421">@Meziu</span>  <span class="user-mention" data-user-id="218805">@Mark Drobnak</span></p>



<a name="271656858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/std%3A%3Athread%20support%20for%20armv6k-nintendo-3ds/near/271656858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html#271656858">(Feb 12 2022 at 00:25)</a>:</h4>
<p>ThreadBuilder? Is setting the priority after it has been created not an option?</p>



<a name="271656936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/std%3A%3Athread%20support%20for%20armv6k-nintendo-3ds/near/271656936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html#271656936">(Feb 12 2022 at 00:27)</a>:</h4>
<blockquote>
<p>but it does include some public surface area</p>
</blockquote>
<p>This probably is the most critical part. OS-specific extension traits are less of an issue.</p>



<a name="271658213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/std%3A%3Athread%20support%20for%20armv6k-nintendo-3ds/near/271658213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Drobnak <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html#271658213">(Feb 12 2022 at 00:48)</a>:</h4>
<p>It doesn't actually include any public interface changes besides the extension trait</p>



<a name="271658313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/std%3A%3Athread%20support%20for%20armv6k-nintendo-3ds/near/271658313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Drobnak <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html#271658313">(Feb 12 2022 at 00:50)</a>:</h4>
<p>The thing we're most concerned about is some changes to the internal <code>sys::thread</code> interface that abstracts platform implementation details, which is needed to make this extension trait work.</p>
<p>The details are here if you're interested: <a href="https://github.com/Meziu/rust-horizon/pull/10">https://github.com/Meziu/rust-horizon/pull/10</a></p>



<a name="271658408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/std%3A%3Athread%20support%20for%20armv6k-nintendo-3ds/near/271658408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian Chamberlain <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html#271658408">(Feb 12 2022 at 00:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds/near/271656858">said</a>:</p>
<blockquote>
<p>ThreadBuilder? Is setting the priority after it has been created not an option?</p>
</blockquote>
<p>I'm not sure if this is possible with the APIs we have available for affinity + priority, but if so I wonder if we could just use the existing <a href="https://doc.rust-lang.org/std/os/unix/thread/trait.JoinHandleExt.html"><code>JoinHandleExt::as_pthread_t()</code></a> and use the same APIs on that, in user code rather than in <code>std</code> itself...</p>



<a name="271658433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/std%3A%3Athread%20support%20for%20armv6k-nintendo-3ds/near/271658433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Drobnak <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html#271658433">(Feb 12 2022 at 00:51)</a>:</h4>
<p>More important is CPU affinity, which should be set at thread creation</p>



<a name="271659556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/std%3A%3Athread%20support%20for%20armv6k-nintendo-3ds/near/271659556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mark Drobnak <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html#271659556">(Feb 12 2022 at 01:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="352170">Ian Chamberlain</span> <a href="#narrow/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds/near/271658408">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds/near/271656858">said</a>:</p>
<blockquote>
<p>ThreadBuilder? Is setting the priority after it has been created not an option?</p>
</blockquote>
<p>I'm not sure if this is possible with the APIs we have available for affinity + priority, but if so I wonder if we could just use the existing <a href="https://doc.rust-lang.org/std/os/unix/thread/trait.JoinHandleExt.html"><code>JoinHandleExt::as_pthread_t()</code></a> and use the same APIs on that, in user code rather than in <code>std</code> itself...</p>
</blockquote>
<p>The closest thing I found is <a href="https://github.com/devkitPro/libctru/blob/4815537048b3143dd677584f37cf09fb3caa737d/libctru/include/3ds/svc.h#L886"><code>svcSetThreadAffinityMask</code></a>, but not sure if that's actually related. There's not much docs on it.</p>
<p>Either way setting the affinity after the fact makes it hard to spawn threads from the system core (can only have one of those).</p>



<a name="271661539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/std%3A%3Athread%20support%20for%20armv6k-nintendo-3ds/near/271661539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html#271661539">(Feb 12 2022 at 01:44)</a>:</h4>
<p>I would definitely advise making the entire thread thing, or at least the part that adds new public API, a separate PR into std if at all possible, based on what this sounds like. Remember, as a tier 3 target, it's fine if a std API is only <code>todo!()</code></p>



<a name="271661973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/std%3A%3Athread%20support%20for%20armv6k-nintendo-3ds/near/271661973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html#271661973">(Feb 12 2022 at 01:53)</a>:</h4>
<p>Think of it as shipping a vertical slice. <span aria-label="relieved" class="emoji emoji-1f60c" role="img" title="relieved">:relieved:</span></p>



<a name="271673298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/std%3A%3Athread%20support%20for%20armv6k-nintendo-3ds/near/271673298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/std.3A.3Athread.20support.20for.20armv6k-nintendo-3ds.html#271673298">(Feb 12 2022 at 06:35)</a>:</h4>
<p>It doesn't seem unacceptable to pass the builder in on thread creation but yeah it should be its own PR</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>