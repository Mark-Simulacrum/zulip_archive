<html>
<head><meta charset="utf-8"><title>✔ match on slice pattern with &amp;str · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html">✔ match on slice pattern with &amp;str</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262317304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262317304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262317304">(Nov 22 2021 at 13:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="368654">AstOhm</span> has marked this topic as resolved.</p>



<a name="262424449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262424449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262424449">(Nov 23 2021 at 08:18)</a>:</h4>
<p>If the range is <code>A</code> to <code>Z</code> and you return <code>0</code> as default, this can be done with much fewer instructions (three plus constant generation):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">opt2</span><span class="p">(</span><span class="n">v</span>: <span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x659e00001dd77f4</span><span class="k">u64</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">63</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">t</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">63</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">15</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="262483258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262483258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262483258">(Nov 23 2021 at 17:01)</a>:</h4>
<p><span class="user-mention" data-user-id="437892">@Falk Hüffner</span> Interesting approach. A double-shift-LUT. Mind elaborating how you derived the result and why it cannot set the default to 1?</p>



<a name="262484061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262484061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262484061">(Nov 23 2021 at 17:07)</a>:</h4>
<p>The <code>v &amp; 63</code> aligning the A-Z to 1-26 is a nice observation there. If you make that <code>v &amp; 0x1f</code>, it becomes case insensitive. If we range only A-Za-z, this is perfect. But this mask has a cost, unlike the <code>&amp; 63</code>.</p>



<a name="262484188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262484188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262484188">(Nov 23 2021 at 17:08)</a>:</h4>
<p>I used my superoptimizer which is based on z3 (<a href="https://github.com/falk-hueffner/sematrope">https://github.com/falk-hueffner/sematrope</a>) plus some playing around. It doesn't work with 1 because, intuitively, producing 0 is easier in that it can be achieved with either a large shift count or long stretches of zeroes in the input (and more precisely because z3 does not find any 64 bit constant that would work).</p>



<a name="262484280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262484280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262484280">(Nov 23 2021 at 17:09)</a>:</h4>
<p>Ah a solver, nice cheat. :D</p>



<a name="262484372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262484372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262484372">(Nov 23 2021 at 17:09)</a>:</h4>
<p>TODO: play with z3. :)</p>



<a name="262485060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262485060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262485060">(Nov 23 2021 at 17:15)</a>:</h4>
<p>You did try with signed right shift, yes?</p>



<a name="262487940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262487940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262487940">(Nov 23 2021 at 17:35)</a>:</h4>
<p>Guess that wouldn't really help due to the rest of the ones being unwanted. Nice result either way. I wonder how efficient a dedicated derivation tool could be.</p>



<a name="262489698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262489698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262489698">(Nov 23 2021 at 17:46)</a>:</h4>
<p><span class="user-mention" data-user-id="437892">@Falk Hüffner</span> Huh. Looking at the assembly, I see the costs of building your larger LUT outweigh it, so at least instruction count-wise you only save one instruction because it is case sensitive. If you replace the 63 with 0x1f, then you get the same number of instructions. (But I won't benchmark them or compare the dataflows)</p>
<p><a href="https://godbolt.org/z/qqGeWYvW5">https://godbolt.org/z/qqGeWYvW5</a></p>
<p>Your larger LUT would win at least if we called the function multiple times and could reuse the constant stored in registers. Could probably also save more instructions by using more registers to construct the constant.</p>



<a name="262489968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262489968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262489968">(Nov 23 2021 at 17:48)</a>:</h4>
<p>Which would in turn yield better performance, especially on optimized cores.</p>



<a name="262491882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262491882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262491882">(Nov 23 2021 at 18:01)</a>:</h4>
<p>At least normally when optimizing match cases like this; we have low enum variant numbers. Not 26 cases. So would have a lot more freedom.</p>
<p>Another trick I recently used, with a nice emergent (ironic?) relationship. The rotation of a u8 describing the 4-point unit circle, rotates the circle. <code>0b11100100u8.rotate_right(2)</code> where the low 2 bits describe the current direction.</p>



<a name="262492137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262492137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262492137">(Nov 23 2021 at 18:03)</a>:</h4>
<p>It seems generating constants is just super inefficient on RISC-V with clang (7 instructions??). Gcc just loads it from memory...</p>



<a name="262492755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262492755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262492755">(Nov 23 2021 at 18:08)</a>:</h4>
<p>Ah, yes, gcc does that. Probably better for real world hardware.</p>



<a name="262493112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262493112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262493112">(Nov 23 2021 at 18:11)</a>:</h4>
<p>After analyzing your solution. I'm pretty sure you can take the approach to a 32-bit constant. Might try to handwrite a constant tomorrow. o/</p>



<a name="262493663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262493663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Falk Hüffner <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262493663">(Nov 23 2021 at 18:16)</a>:</h4>
<p>It would be quite interesting to find a non-solver based way of finding constant for various mappings, but it seems hard... Please let me know if you find anything :-)</p>



<a name="262494583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%E2%9C%94%20match%20on%20slice%20pattern%20with%20%26str/near/262494583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sofia <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.E2.9C.94.20match.20on.20slice.20pattern.20with.20.26str.html#262494583">(Nov 23 2021 at 18:24)</a>:</h4>
<p>Likewise :D</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>