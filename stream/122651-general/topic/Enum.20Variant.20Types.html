<html>
<head><meta charset="utf-8"><title>Enum Variant Types ¬∑ general ¬∑ Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html">Enum Variant Types</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256334568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256334568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zhamlin <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256334568">(Oct 05 2021 at 23:23)</a>:</h4>
<p>I have made some progress towards implementing enum variant types (<a href="https://github.com/rust-lang/rfcs/pull/2593">https://github.com/rust-lang/rfcs/pull/2593</a>), but before I continue I was wondering what the best path forward would be?</p>
<p>My initial plan was to get it a bit further along and clean up the branch, but I saw<br>
the RFC PR was closed. Want to make sure I'm not doing anything that won't be accepted or is based on outdated assumptions.</p>



<a name="256371045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256371045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256371045">(Oct 06 2021 at 07:43)</a>:</h4>
<p>It was closed as "postpone", not "close".</p>



<a name="256371104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256371104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256371104">(Oct 06 2021 at 07:44)</a>:</h4>
<p>I don't think folks are opposed in principle.</p>



<a name="256371152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256371152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256371152">(Oct 06 2021 at 07:44)</a>:</h4>
<p>I do think we would need a revived proposal, and I don't think you should do too much work before getting a design approval.</p>



<a name="256412218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256412218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zhamlin <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256412218">(Oct 06 2021 at 13:37)</a>:</h4>
<p>Where is the place to start a revised proposal?<br>
I'm not sure I'd have much to add as I'm still fairly new to rust, but would love to help get things moving along.</p>



<a name="256425722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256425722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256425722">(Oct 06 2021 at 15:00)</a>:</h4>
<p>So, new efforts similar to this should probably use an MCP, but in this case with an RFC already written, I think it would work to just pick that up and update it based on the thread.</p>



<a name="256489473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256489473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zhamlin <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256489473">(Oct 06 2021 at 21:42)</a>:</h4>
<p>After looking over the RFC and the github thread I don't think I have anything to add or change really. The implementation I have is roughly aligned with the RFC.</p>
<p>The biggest question I have is what the next step is?<br>
Is there more discussion needed, or does there need to be a working prototype first, etc?</p>



<a name="256492590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256492590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256492590">(Oct 06 2021 at 22:10)</a>:</h4>
<p>Btw I'm actually super excited for this feature. I can't guarantee I'll be tons of help, but feel free to ping me at any point.</p>



<a name="256493102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256493102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256493102">(Oct 06 2021 at 22:14)</a>:</h4>
<p>Since this is kind of both a language and compiler heavy change, it's probably good to file both a <a href="https://github.com/rust-lang/lang-team/issues/new?assignees=&amp;labels=major-change%2C+T-lang&amp;template=initiative_proposal.md&amp;title=%28My+initiative+proposal%29">lang team initiative proposal</a> and a <a href="https://github.com/rust-lang/compiler-team/issues/new?assignees=&amp;labels=major-change%2C+T-compiler&amp;template=major_change.md&amp;title=%28My+major+change+proposal%29">compiler MCP</a>. The initiative will probably be more about what the feature is, why it's important, what ergonomic issues it solves. This will probably be pretty close to the RFC.  The MCP will probably be more of the technical "how is this implemented". In either case, I don't think there would be anything wrong with opening a draft PR to get feedback (but certainly not required).</p>



<a name="256792818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256792818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256792818">(Oct 08 2021 at 19:27)</a>:</h4>
<p><span class="user-mention" data-user-id="400323">@zhamlin</span> for your implementation, what would something like this (likely not-exactly-correct) code report?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Alpha</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">One</span><span class="p">([</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">1024</span><span class="p">]),</span><span class="w"></span>
<span class="w">    </span><span class="n">Two</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">example</span><span class="p">(</span><span class="n">a</span>: <span class="nc">Alpha</span>::<span class="n">Two</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="256832066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256832066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zhamlin <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256832066">(Oct 09 2021 at 02:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/122651-general/topic/Enum.20Variant.20Types/near/256792818">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="400323">zhamlin</span> for your implementation, what would something like this (likely not-exactly-correct) code report?</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Alpha</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">One</span><span class="p">([</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">1024</span><span class="p">]),</span><span class="w"></span>
<span class="w">    </span><span class="n">Two</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">example</span><span class="p">(</span><span class="n">a</span>: <span class="nc">Alpha</span>::<span class="n">Two</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">size_of_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>1025</p>



<a name="256862320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256862320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256862320">(Oct 09 2021 at 11:18)</a>:</h4>
<p>Gotcha. That means it‚Äôs not really a solution for the cases that I hoped to use it in. Thanks!</p>



<a name="256890745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256890745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256890745">(Oct 09 2021 at 18:54)</a>:</h4>
<p>Although it's likely that <code>Alpha::Two</code> could become a ZST in the future, once the core feature works.</p>



<a name="256894265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256894265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256894265">(Oct 09 2021 at 19:49)</a>:</h4>
<p>I'm torn on this. It definitely saves space if <code>Alpha::Two</code> is a ZST, but that will mean that <code>Box&lt;Alpha::Two&gt;</code> cannot be converted to <code>Box&lt;Alpha&gt;</code>.</p>



<a name="256894651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256894651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256894651">(Oct 09 2021 at 19:55)</a>:</h4>
<p>We probably don't want a separate variance rules for variant type subtyping. If we use existing rules then the fact that <code>Alpha::Two &lt;: Alpha</code> and that <code>Box&lt;T&gt;</code> is covariant over <code>T</code> indicates that <code>Box&lt;Alpha::Two&gt;</code> to <code>Box&lt;Alpha&gt;</code> conversion needs to work.</p>



<a name="256894924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/256894924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#256894924">(Oct 09 2021 at 20:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/122651-general/topic/Enum.20Variant.20Types/near/256894265">said</a>:</p>
<blockquote>
<p>I'm torn on this. It definitely saves space if <code>Alpha::Two</code> is a ZST, but that will mean that <code>Box&lt;Alpha::Two&gt;</code> cannot be converted to <code>Box&lt;Alpha&gt;</code>.</p>
</blockquote>
<p>Hmm, that's a good point.</p>



<a name="257027250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/257027250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#257027250">(Oct 11 2021 at 08:01)</a>:</h4>
<p>I think it'd be alright if that conversion wasn't trivial.</p>



<a name="257027271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/257027271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#257027271">(Oct 11 2021 at 08:01)</a>:</h4>
<p>I like the idea of not using more memory than the variant needs.</p>



<a name="257027323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/257027323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#257027323">(Oct 11 2021 at 08:01)</a>:</h4>
<p>That would mean you can pull out a small variant of a large enum and pass it around more cheaply.</p>



<a name="257027449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/257027449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#257027449">(Oct 11 2021 at 08:02)</a>:</h4>
<p>Perhaps we could supply a From?</p>



<a name="257027956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/257027956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#257027956">(Oct 11 2021 at 08:07)</a>:</h4>
<p>having the conversion between <code>Enum::Variant</code> and <code>Enum</code> be trivial seems extremely important if we want to allow turning <code>&amp;Enum::Variant</code> to <code>&amp;Enum</code></p>



<a name="257028336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/257028336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#257028336">(Oct 11 2021 at 08:11)</a>:</h4>
<p>given that you could already accomplish "make each of these variants be structs" with a proc macro it seems more useful as a langauge feature if "enum variant types" is more like a limited form of refinement typing (i.e. <code>Enum::Variant</code> as a type being sugar for <code>Enum is Enum::Variant(..)</code>)</p>



<a name="257054004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/257054004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#257054004">(Oct 11 2021 at 12:04)</a>:</h4>
<p>I think this discussion needs to also touch on the ‚Äúenums where you can‚Äôt take a reference to the internals‚Äù idea that pops up sometimes. I think they are highly related.</p>



<a name="257054758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/257054758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#257054758">(Oct 11 2021 at 12:11)</a>:</h4>
<p>Is there any links to prior discussion about that? I've not come across it before</p>



<a name="257055159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/257055159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#257055159">(Oct 11 2021 at 12:14)</a>:</h4>
<p>There <em>are</em> links, but I‚Äôm on mobile and can‚Äôt find them quickly üòÖ</p>



<a name="257056766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/257056766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#257056766">(Oct 11 2021 at 12:28)</a>:</h4>
<blockquote>
<p>if we want to allow turning <code>&amp;Enum::Variant</code> to <code>&amp;Enum</code></p>
</blockquote>
<p>It basically allows people to opt out of that, and of references to any fields of an enum. It‚Äôs similar to <code>repr(packed)</code>. It would allow more aggressive usage of niches. </p>
<p>I‚Äôm sure there are downsides to it that I‚Äôm unaware of.</p>



<a name="257796231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/257796231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#257796231">(Oct 16 2021 at 03:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="326176">Boxy [she/her]</span> <a href="#narrow/stream/122651-general/topic/Enum.20Variant.20Types/near/257054758">said</a>:</p>
<blockquote>
<p>Is there any links to prior discussion about that? I've not come across it before</p>
</blockquote>
<p>Here's one I remember from a few months ago: <a href="https://internals.rust-lang.org/t/towards-even-smaller-structs/14686/3?u=scottmcm">https://internals.rust-lang.org/t/towards-even-smaller-structs/14686/3?u=scottmcm</a></p>
<p>I'd love to see someone work on this.  There's a ton of things that people expect to get optimized but that can't without this.  And for <code>Copy</code> fields the downsides are pretty slim.</p>
<p>One problem that jumps out to me: for fields that aren't <code>Copy</code>, how do you <code>mem::replace</code> them to get a field out?</p>



<a name="258818032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/258818032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#258818032">(Oct 23 2021 at 11:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/122651-general/topic/Enum.20Variant.20Types/near/257056766">said</a>:</p>
<blockquote>
<p>It basically allows people to opt out of that, and of references to any fields of an enum. It‚Äôs similar to <code>repr(packed)</code>. It would allow more aggressive usage of niches. </p>
</blockquote>
<p>Is this what you've talked about: <a href="https://github.com/rust-lang/rfcs/issues/3166">https://github.com/rust-lang/rfcs/issues/3166</a>?</p>



<a name="258818454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/258818454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#258818454">(Oct 23 2021 at 11:26)</a>:</h4>
<p>From the text of the <a href="https://github.com/rust-lang/lang-team/issues/122">proposal</a>:</p>
<blockquote>
<p>Variant types, unlike most user-defined types are subject to the following restriction:</p>
<ul>
<li>Variant types may not have inherent impls, or implemented traits. That means <code>impl Enum::Variant</code><br>
and <code>impl Trait for Enum::Variant</code> are forbidden. This dissuades inclinations to implement<br>
abstraction using behaviour-switching on enums (for example, by simulating inheritance-based<br>
subtyping, with the enum type as the parent and each variant as children), rather than using traits<br>
as is natural in Rust.</li>
</ul>
</blockquote>
<p>This, on its own, doesn't prohibit "implementing abstraction using behaviour-switching on enums" because you can use <code>Unrelated: Trait&lt;T&gt;</code> bounds:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">EnumVariantName</span><span class="o">&lt;</span><span class="n">This</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">NAME</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">enum</span> <span class="nc">Either</span><span class="o">&lt;</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Left</span><span class="p">(</span><span class="n">L</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">Right</span><span class="p">(</span><span class="n">R</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EnumVariantName</span><span class="o">&lt;</span><span class="n">Either</span>::<span class="o">&lt;</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span>::<span class="n">Left</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">NAME</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">"left"</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EnumVariantName</span><span class="o">&lt;</span><span class="n">Either</span>::<span class="o">&lt;</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span>::<span class="n">Right</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">NAME</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">"right"</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">variant_name</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="kt">str</span>
<span class="nc">where</span><span class="w"></span>
<span class="w">    </span><span class="p">()</span>: <span class="nc">EnumVariantName</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">&lt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">EnumVariantName</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span>::<span class="n">NAME</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258819215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Enum%20Variant%20Types/near/258819215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Enum.20Variant.20Types.html#258819215">(Oct 23 2021 at 11:50)</a>:</h4>
<p>Another question about this restriction is whatever the traits implemented for "outer type" are also implemented for the "inner types"?</p>
<p>This is especially interesting, considering some build-in traits:</p>
<h1><code>Copy</code></h1>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Copy, Clone)]</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">AB</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="n">a</span>: <span class="nc">AB</span>::<span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AB</span>::<span class="n">A</span><span class="p">;</span><span class="w"></span>

<span class="c1">// Q0: does this work?</span>
<span class="c1">// Q2: what type is a2? AB::A or AB?</span>
<span class="c1">// Q3: what about a.clone()?</span>
<span class="kd">let</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*&amp;</span><span class="n">a</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<h1><code>Send</code>/<code>Sync</code></h1>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Hmm</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Zst</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Shared</span><span class="p">(</span><span class="n">MutexGuard</span><span class="o">&lt;'</span><span class="nb">static</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">),</span><span class="w"> </span><span class="c1">// !Send + Sync</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Q4: Is this !Send + !Sync (no traits), !Send + Sync (inherited) or Send + Sync (ZST default)</span>
<span class="kd">let</span><span class="w"> </span><span class="n">zst</span>: <span class="nc">Hmm</span>::<span class="n">Zst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Hmm</span>::<span class="n">Zst</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<h1><code>Drop</code></h1>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Defer</span><span class="o">&lt;</span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">D</span><span class="p">(</span><span class="n">F</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">E</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Defer</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Running deferred function"</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Defer</span>::<span class="n">D</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span>::<span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">Defer</span>::<span class="n">E</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">f</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Q5: does this coerce Defer::E -&gt; Defer and run Defer::drop?</span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Defer</span>::<span class="o">&lt;</span><span class="k">fn</span><span class="p">()</span><span class="o">&gt;</span>::<span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Defer</span>::<span class="n">E</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>