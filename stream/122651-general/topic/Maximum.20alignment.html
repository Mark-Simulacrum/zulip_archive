<html>
<head><meta charset="utf-8"><title>Maximum alignment · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html">Maximum alignment</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263106936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263106936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263106936">(Nov 30 2021 at 06:44)</a>:</h4>
<p>What's the maximum alignment of a Rust type? I don't know of any type with an alignment of greater than 8...</p>



<a name="263106939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263106939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263106939">(Nov 30 2021 at 06:45)</a>:</h4>
<p>(I'm not planning to assume anything based on this, just curious)</p>



<a name="263106957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263106957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263106957">(Nov 30 2021 at 06:45)</a>:</h4>
<p>Are there some SIMD types with alignment of 16 or higher?</p>



<a name="263106962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263106962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263106962">(Nov 30 2021 at 06:45)</a>:</h4>
<p>Maximum allowed alignment, or maximum default alignment if you <em>don't</em> change it with an align attribute?</p>



<a name="263107123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263107123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263107123">(Nov 30 2021 at 06:48)</a>:</h4>
<p>For the former, I think the answer is 4096; I think I remember us defining that as the maximum allowed alignment a while back.</p>



<a name="263107920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263107920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263107920">(Nov 30 2021 at 07:06)</a>:</h4>
<p>well this builds</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(align(8192))]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Foo</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>i think llvm allows up to <code>1 &lt;&lt; 32</code>, but i think that rust doesn't want to try and provide this because it's not very portable and if you go over the alignment limit that a platform supports then sometimes the value can just not actually be aligned and it becomes UB.</p>



<a name="263108204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263108204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263108204">(Nov 30 2021 at 07:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/122651-general/topic/Maximum.20alignment/near/263106957">said</a>:</p>
<blockquote>
<p>Are there some SIMD types with alignment of 16 or higher?</p>
</blockquote>
<p>I believe that the 256-bit and 512-bit types are aligned to an equivalent number of bits.</p>



<a name="263110009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263110009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263110009">(Nov 30 2021 at 07:46)</a>:</h4>
<p><span class="user-mention" data-user-id="224471">@Lokathor</span> I think you may be right, we might not have actually restricted repr(align).</p>



<a name="263110016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263110016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263110016">(Nov 30 2021 at 07:46)</a>:</h4>
<p>The release notes mention us restricting it to 2^29 a few years ago.</p>



<a name="263110019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263110019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263110019">(Nov 30 2021 at 07:46)</a>:</h4>
<p>I thought we did more, but perhaps we didn't.</p>



<a name="263116332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263116332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> panstromek <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263116332">(Nov 30 2021 at 09:05)</a>:</h4>
<p>There's also this <a href="https://github.com/rust-lang/rust/issues/70022">https://github.com/rust-lang/rust/issues/70022</a> and a few similar issues around big alignments. Seems problematic on windows</p>



<a name="263117048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263117048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263117048">(Nov 30 2021 at 09:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/122651-general/topic/Maximum.20alignment/near/263110016">said</a>:</p>
<blockquote>
<p>The release notes mention us restricting it to 2^29 a few years ago.</p>
</blockquote>
<p><a href="https://llvm.org/docs/LangRef.html#global-variables">https://llvm.org/docs/LangRef.html#global-variables</a> confirms their restriction is <code>1 &lt;&lt; 32</code> now.  But I also remember there being a limit -- which I thought was also in LLVM -- of <code>1 &lt;&lt; 27</code> at one point.</p>
<p>But +1 that it's probably best to avoid anything over 512, and definitely avoid anything over 4096.</p>



<a name="263210220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263210220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263210220">(Nov 30 2021 at 21:18)</a>:</h4>
<p>Ah, <code>repr(align)</code> will be useful, thanks!</p>



<a name="263210300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263210300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263210300">(Nov 30 2021 at 21:19)</a>:</h4>
<p>I'm asking because I'm thinking again about redoing <code>ThinVec</code> to be a single word to a heap allocation of the form <code>[len, cap, elem1, elem2, ...]</code> and this is relevant to the positioning of <code>elem1</code>.</p>



<a name="263224468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263224468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263224468">(Nov 30 2021 at 23:36)</a>:</h4>
<p>You can have <code>cap</code> and <code>len</code> at a negative offset from the pointer.</p>



<a name="263224484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263224484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263224484">(Nov 30 2021 at 23:36)</a>:</h4>
<p>The only tricky part is reconstructing the original pointer for deallocation.</p>



<a name="263235444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263235444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263235444">(Dec 01 2021 at 01:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/122651-general/topic/Maximum.20alignment/near/263106957">said</a>:</p>
<blockquote>
<p>Are there some SIMD types with alignment of 16 or higher?</p>
</blockquote>
<p>Verifying what Lokathor said: yes. <code>__mm256</code> and <code>__mm512</code> are in fact aligned to 32 and 64 bytes.</p>
<p>Other architectures, including ones with even bigger vectors(!), align their vectors to ~16 bytes or <em>less</em>, oddly, so I am not aware of any data types with more.</p>



<a name="263240032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263240032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263240032">(Dec 01 2021 at 03:24)</a>:</h4>
<p>I've heard of some people using 4096 bytes on some types to help ensure that they line up with OS pages, but that's kinda out there.</p>



<a name="263242397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Maximum%20alignment/near/263242397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Maximum.20alignment.html#263242397">(Dec 01 2021 at 04:10)</a>:</h4>
<p>Ah yeah, you can force that. Implicit qualif "natural datatype" to the ABI.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>