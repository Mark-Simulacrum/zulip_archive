<html>
<head><meta charset="utf-8"><title>How to use MADV_DONTNEED · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html">How to use MADV_DONTNEED</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266145705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266145705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pure White <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266145705">(Dec 27 2021 at 04:41)</a>:</h4>
<p>Hi, all</p>
<p>I've encountered high memory usage(looks like "memory leak") in production environment(container in k8s), and want to check if it's because of the "MADV_FREE" behaviour.</p>
<p>Is there a way to change to use MADV_DONTNEED instead of MADV_FREE in rust?</p>
<p>Thanks!</p>



<a name="266145763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266145763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266145763">(Dec 27 2021 at 04:43)</a>:</h4>
<p>Are you explicitly setting a global allocator in Rust? If not, then it should be using the system allocator</p>



<a name="266145826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266145826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266145826">(Dec 27 2021 at 04:44)</a>:</h4>
<p>in which case it's probably either an "ordinary" memory leak (some code isn't dropping a Vec/Box/Arc/etc), or just the system allocator deciding not to release memory back (independent of Rust)</p>



<a name="266145904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266145904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pure White <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266145904">(Dec 27 2021 at 04:47)</a>:</h4>
<p>Thanks for your reply!</p>
<p>I've tried multiple allocators, including the system allocator, mimalloc and jemallocator, though their growing curves are different(mimalloc &gt; system allocator &gt; jemallocator), they all results in a memory continuously growing and caused OOM(in containers with memory limit) in the end.</p>



<a name="266146058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266146058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266146058">(Dec 27 2021 at 04:51)</a>:</h4>
<p>That sounds like it's something specific to your application</p>



<a name="266146068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266146068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pure White <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266146068">(Dec 27 2021 at 04:51)</a>:</h4>
<p>I've tried to use asan, and asan didn't report any error. I've also reviewed code with my colleagues several times, and we didn't find anything which may lead to memory leak.</p>
<p>I've used Go before and this problem is very much similar to the problem in Go when Go defaults to use MADV_FREE.</p>



<a name="266146131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266146131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266146131">(Dec 27 2021 at 04:53)</a>:</h4>
<p>It's possible that the memory is getting correctly freed on shutdown, so asan is missing it</p>



<a name="266146147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266146147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266146147">(Dec 27 2021 at 04:53)</a>:</h4>
<p>I would recommend using a heap profiler like heaptrack: <a href="https://github.com/KDE/heaptrack">https://github.com/KDE/heaptrack</a></p>



<a name="266146152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266146152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pure White <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266146152">(Dec 27 2021 at 04:53)</a>:</h4>
<p>So I want to ask the allocator to use MADV_DONTNEED instead of MADV_FREE to check if it's cause by MADV_FREE.</p>



<a name="266146157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266146157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pure White <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266146157">(Dec 27 2021 at 04:54)</a>:</h4>
<p>Thanks! I'll try it!</p>



<a name="266146201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266146201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266146201">(Dec 27 2021 at 04:54)</a>:</h4>
<p>I'm not sure if there's a way to do that - if there is, I think it would be the same way as a C program would do it</p>



<a name="266146278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266146278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266146278">(Dec 27 2021 at 04:57)</a>:</h4>
<p>If you're hitting an OOM, then I strongly suspect that MADV_FREE isn't the problem - the kernel should be reclaiming those pages before triggering an OOM</p>



<a name="266147278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266147278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266147278">(Dec 27 2021 at 05:20)</a>:</h4>
<p>Allocators have some tuning functions where you can tell them to retain more or less memory instead of immediately returning it to the OS. But considering that you already tried multiple allocators it's unlikely to be that.</p>



<a name="266148608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266148608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pure White <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266148608">(Dec 27 2021 at 05:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED/near/266146278">said</a>:</p>
<blockquote>
<p>If you're hitting an OOM, then I strongly suspect that MADV_FREE isn't the problem - the kernel should be reclaiming those pages before triggering an OOM</p>
</blockquote>
<p>No, because it's in container, containers will not reclaiming those pages.</p>



<a name="266155576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266155576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Weimer <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266155576">(Dec 27 2021 at 08:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="445531">Pure White</span> <a href="#narrow/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED/near/266146152">said</a>:</p>
<blockquote>
<p>So I want to ask the allocator to use MADV_DONTNEED instead of MADV_FREE to check if it's cause by MADV_FREE.</p>
</blockquote>
<p>glibc's malloc does this automatically if the system is in <code>vm.overcommit_memory=2</code> mode.</p>



<a name="266169508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266169508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266169508">(Dec 27 2021 at 12:39)</a>:</h4>
<p>you could check with <code>strace -e brk,mmap,munmap,madvise</code> which calls are getting used</p>



<a name="266295219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/How%20to%20use%20MADV_DONTNEED/near/266295219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Xu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED.html#266295219">(Dec 28 2021 at 21:46)</a>:</h4>
<p>Kernel is usually able to reclaim pages from a container as long as you don’t set memory.low or memory.min (or if your usage is above those limits). It would be unusual for your container to have those set.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>