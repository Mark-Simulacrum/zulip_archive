<html>
<head><meta charset="utf-8"><title>`unsafe` as an API hardening escape hatch · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html">`unsafe` as an API hardening escape hatch</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252344546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252344546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252344546">(Sep 07 2021 at 17:51)</a>:</h4>
<p>Would it be reasonable for library authors to mark functions as <code>unsafe</code> to signal that failing to uphold certain preconditions could lead to undesirable behavior, even if that undesirable behavior doesn't include memory safety violations?</p>



<a name="252345069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252345069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252345069">(Sep 07 2021 at 17:55)</a>:</h4>
<p>I believe the (partial) consensus is that we don't want to overload unsafe for all kinds of undesirable behavior and want to focus it to just memory safety.</p>



<a name="252345119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252345119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252345119">(Sep 07 2021 at 17:55)</a>:</h4>
<p>The example I have in mind is e.g. a cryptography library exposing a "safe" API that's difficult to misuse, while exposing some of its internals (e.g. a function that accepts a user-provided nonce) as <code>unsafe</code>. (These <code>unsafe</code> functions require special care because e.g. reusing a nonce could lead to security problems.) Another example would be a SQL library requiring <code>unsafe</code> to execute a query that isn't a compile-time constant.</p>



<a name="252345344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252345344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252345344">(Sep 07 2021 at 17:56)</a>:</h4>
<p>I agree that this could lead to people becoming desensitized to "unsafe" blocks, though.</p>



<a name="252347537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252347537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teddy Katz <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252347537">(Sep 07 2021 at 18:11)</a>:</h4>
<p>Are there other recommended practices for indicating that APIs are dangerous to use (outside of not exposing them)? I guess I could put <code>_DANGER_DANGER</code> at the end of the function name, but that seems a bit silly. (Cargo features are another option, but they don't have the same level of encapsulation.)</p>
<p>Basically, I think <code>unsafe</code> blocks provide a useful auditing and encapsulation signal, since they indicate pieces of code that might need special scrutiny. It would be nice to have a similarly standardized auditing signal for security concerns beyond memory safety. Not sure what the best way to do that is, though.</p>



<a name="252350501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252350501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252350501">(Sep 07 2021 at 18:31)</a>:</h4>
<p>You could create a token type, e.g. <code>Unsecure</code>, and then require it for those functions</p>



<a name="252350912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252350912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252350912">(Sep 07 2021 at 18:34)</a>:</h4>
<p>E.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span> <span class="nn">unsecure</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Unsecure</span><span class="p">(());</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">unsecure</span><span class="o">&lt;</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Unsecure</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">f</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Unsecure</span><span class="p">(()))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">unsecure</span>::<span class="o">*</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">not_so_secure_fn</span><span class="p">(</span><span class="n">_u</span>: <span class="kp">&amp;</span><span class="nc">Unsecure</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">unsecure</span><span class="p">(</span><span class="o">|</span><span class="n">u</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">not_so_secure_fn</span><span class="p">(</span><span class="n">u</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="252352063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252352063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252352063">(Sep 07 2021 at 18:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="392468">Teddy Katz</span> <a href="#narrow/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch/near/252347537">said</a>:</p>
<blockquote>
<p>Are there other recommended practices for indicating that APIs are dangerous to use (outside of not exposing them)? I guess I could put <code>_DANGER_DANGER</code> at the end of the function name, but that seems a bit silly. (Cargo features are another option, but they don't have the same level of encapsulation.)</p>
</blockquote>
<p>I think putting it in a different module (e.g. <code>yourcrate::raw_crypto::func</code>) would help. I also think, within reason, giving that module a dangerous-sounding name would be appropriate.</p>



<a name="252352120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252352120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252352120">(Sep 07 2021 at 18:42)</a>:</h4>
<p>(To the extent <code>raw_crypto</code> doesn't already sound dangerous.)</p>



<a name="252352262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252352262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252352262">(Sep 07 2021 at 18:43)</a>:</h4>
<p>API will always be misused if there are no proper enforcement</p>



<a name="252352408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252352408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252352408">(Sep 07 2021 at 18:44)</a>:</h4>
<p>Clippy has a way to deny usage of certain functions.</p>



<a name="252352828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252352828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252352828">(Sep 07 2021 at 18:47)</a>:</h4>
<p>It could deny individual functions, but if there are many functions I think it'll be hard to manage</p>



<a name="252352918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252352918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252352918">(Sep 07 2021 at 18:47)</a>:</h4>
<p>If, e.g. the unsecure token approach is used, then when auditing you'll only need to disallow "unsecure" fn.</p>



<a name="252357563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252357563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252357563">(Sep 07 2021 at 19:15)</a>:</h4>
<p><code>_unchecked</code> is commonly used for memory safe but dangerous functions, as well as outright unsafe functions.</p>



<a name="252361571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60unsafe%60%20as%20an%20API%20hardening%20escape%20hatch/near/252361571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60unsafe.60.20as.20an.20API.20hardening.20escape.20hatch.html#252361571">(Sep 07 2021 at 19:46)</a>:</h4>
<p>you could put the raw API into a module and gate that on a non-default feature of the crate</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>