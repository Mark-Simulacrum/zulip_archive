<html>
<head><meta charset="utf-8"><title>Types for passing raw pointers across threads · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html">Types for passing raw pointers across threads</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251780036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/251780036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#251780036">(Sep 02 2021 at 20:19)</a>:</h4>
<p>Do we have any types / APIs for passing raw pointers across threads "less unsafely" ?</p>
<p>We used to have <code>core::ptr::{Unique, Shared}</code> to communicate variance, but those were replaced with <code>NonNull</code> which does not have any <code>Send</code> or <code>Sync</code> impls.</p>



<a name="251781216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/251781216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#251781216">(Sep 02 2021 at 20:28)</a>:</h4>
<p>Do we have any documentation about this ?</p>



<a name="251784393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/251784393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#251784393">(Sep 02 2021 at 20:51)</a>:</h4>
<p>You can create a wrapper type for the raw pointer and then implement Send for it.</p>



<a name="251863564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/251863564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#251863564">(Sep 03 2021 at 11:13)</a>:</h4>
<p>Since I have to opt into doing this, and implementing Send and Sync is unsafe, what do I have to worry about when doing so ? </p>
<p>I guess subtyping and variance ? Ownership? To be honest I just want to send raw pointers from a function that I implement to a different function in the same module. There is no "API" contract for these two functions.</p>



<a name="251962159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/251962159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#251962159">(Sep 04 2021 at 01:27)</a>:</h4>
<p>I guess you could cast them to <code>usize</code> and back...</p>



<a name="251985613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/251985613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#251985613">(Sep 04 2021 at 08:56)</a>:</h4>
<p>Please don't cast to <code>usize</code> for a reason like that. <span class="user-mention silent" data-user-id="133247">bjorn3</span> 's suggestion is much better, but it's a good question what exactly you are committing to by the <code>unsafe impl</code>. Assuming you do nothing at all with the pointers at the receiving end (or at least, not reading or writing), it's totally fine to impl Send and Sync for a wrapped pointer type. They are "just bytes" after all, and the lack of Send + Sync impls is really meant to be a "think twice" situation because you are almost certainly using the pointer for something on the receiving end...</p>
<p>Which leads to the question: what if you are using the pointer on sending and receiving end, when can it be send? This is hard to say in general, because this basically means you are sharing resources in some way and whether the data structure you are implementing can handle the resource sharing pattern. The types in <code>std::sync</code> implement different kinds of sharing strategies with different properties.</p>
<p><span class="user-mention" data-user-id="409057">@hannahE2</span></p>



<a name="252148430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252148430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252148430">(Sep 06 2021 at 09:14)</a>:</h4>
<blockquote>
<p>hat if you are using the pointer on sending and receiving end, when can it be send? This is hard to say in general, </p>
</blockquote>
<p>I'm using the pointers in the receiving end to read and write through them using multiple threads</p>



<a name="252182077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252182077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252182077">(Sep 06 2021 at 14:19)</a>:</h4>
<p><span class="user-mention" data-user-id="409057">@hannahE2</span>  I expected as much. Unfortunately, without more information about how the accesses are coordinated that's just plain <del>unsafe</del> <em>unsound</em>, and will cause data races and corruption if you are unlucky</p>



<a name="252183878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252183878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252183878">(Sep 06 2021 at 14:33)</a>:</h4>
<blockquote>
<p>I expected as much. Unfortunately, without more information about how the accesses are coordinated that's just plain unsafe unsound,</p>
</blockquote>
<p>That's only unsound if the accesses cause a data-race but my program does not have data races.</p>



<a name="252183926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252183926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252183926">(Sep 06 2021 at 14:33)</a>:</h4>
<p>Right, so why doesn't your access pattern cause data races?</p>



<a name="252184001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184001">(Sep 06 2021 at 14:34)</a>:</h4>
<p>what property of the access pattern ensures that this is impossible?</p>



<a name="252184050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184050">(Sep 06 2021 at 14:34)</a>:</h4>
<p>The barriers and mutexes i have in between.</p>



<a name="252184064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184064">(Sep 06 2021 at 14:34)</a>:</h4>
<p>These are recycled for the different groups of pointers I have.</p>



<a name="252184121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184121">(Sep 06 2021 at 14:35)</a>:</h4>
<p>And it does not have data-races because my theorem prover says it doesn't.</p>



<a name="252184183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184183">(Sep 06 2021 at 14:35)</a>:</h4>
<p>It says that the way I am doing synchronization is sound.</p>



<a name="252184321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184321">(Sep 06 2021 at 14:36)</a>:</h4>
<p>It's probably still not going to be a safe interface, but you can put the barriers and the pointers behind newtypes and make it required to have the barrier to access the pointer</p>



<a name="252184377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184377">(Sep 06 2021 at 14:37)</a>:</h4>
<p>For a safe interface you might be able to use some trick like <code>GhostCell</code></p>



<a name="252184547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184547">(Sep 06 2021 at 14:38)</a>:</h4>
<p>having some cut down API will at least make it clear where you are relying on the safety properties</p>



<a name="252184586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184586">(Sep 06 2021 at 14:38)</a>:</h4>
<p>and then you can <code>unsafe impl Send</code> and/or <code>Sync</code> on the wrapper</p>



<a name="252184630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184630">(Sep 06 2021 at 14:38)</a>:</h4>
<blockquote>
<p>It's probably still not going to be a safe interface</p>
</blockquote>
<p>This is all unsafe code</p>



<a name="252184650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184650">(Sep 06 2021 at 14:39)</a>:</h4>
<p>I don't want a safe interface here</p>



<a name="252184677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184677">(Sep 06 2021 at 14:39)</a>:</h4>
<p>I have unsafe code that launches threads that execute unsafe functions</p>



<a name="252184698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184698">(Sep 06 2021 at 14:39)</a>:</h4>
<p>I mean that the user still has proof obligations</p>



<a name="252184720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184720">(Sep 06 2021 at 14:39)</a>:</h4>
<p>and I can't pass raw pointers to these threads, so I am trying to figure out what to pass instead</p>



<a name="252184730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184730">(Sep 06 2021 at 14:39)</a>:</h4>
<p>even though the unsafety is "encapsulated"</p>



<a name="252184783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184783">(Sep 06 2021 at 14:40)</a>:</h4>
<p>no, that's wrong, a safe API has no proof obligations</p>



<a name="252184815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184815">(Sep 06 2021 at 14:40)</a>:</h4>
<p>because, for instance, you could use the wrong mutex to lock a pointer access</p>



<a name="252184838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184838">(Sep 06 2021 at 14:40)</a>:</h4>
<p>right, but these are unsafe APIs</p>



<a name="252184856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184856">(Sep 06 2021 at 14:40)</a>:</h4>
<p>right, that's why I say it wouldn't be a safe API</p>



<a name="252184862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184862">(Sep 06 2021 at 14:40)</a>:</h4>
<p>and the proof obligations are uphold</p>



<a name="252184974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252184974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252184974">(Sep 06 2021 at 14:41)</a>:</h4>
<p>the proof obligations are "you can either read/write to one element behind this pointer, as long as no other thread reads/writes to it,  or read to all of them as long as no thread writes, across each barrier phase"</p>



<a name="252185143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185143">(Sep 06 2021 at 14:42)</a>:</h4>
<p>and at each barrier phase, each thread can decide to write to a different element, as long as that's upheld, because the barrier synchronizes-with</p>



<a name="252185206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185206">(Sep 06 2021 at 14:43)</a>:</h4>
<p>the barrier is not part of the pointer, cause there are many and the only thing that matters is that one is used consistently for each phase</p>



<a name="252185213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185213">(Sep 06 2021 at 14:43)</a>:</h4>
<p>That sounds like it could be a safe interface, if you make "barrier phase for reading" and "barrier phase for reading/writing" ZSTs</p>



<a name="252185264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185264">(Sep 06 2021 at 14:43)</a>:</h4>
<p>it could, but i don' know of a primitve that exposes this to users without including a huge performance cost</p>



<a name="252185273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185273">(Sep 06 2021 at 14:43)</a>:</h4>
<p>so it's a token that you use to access the pointer</p>



<a name="252185300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185300">(Sep 06 2021 at 14:43)</a>:</h4>
<p>the token changes dynamically, but it must have zero runtime size</p>



<a name="252185360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185360">(Sep 06 2021 at 14:44)</a>:</h4>
<p>i don't know how to express that</p>



<a name="252185370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185370">(Sep 06 2021 at 14:44)</a>:</h4>
<p>That's what ZSTs are for</p>



<a name="252185403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185403">(Sep 06 2021 at 14:44)</a>:</h4>
<p>ZSTs only have one value</p>



<a name="252185425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185425">(Sep 06 2021 at 14:44)</a>:</h4>
<p>Not ZST's with phantom data</p>



<a name="252185445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185445">(Sep 06 2021 at 14:45)</a>:</h4>
<p>they can carry lifetime arguments</p>



<a name="252185475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185475">(Sep 06 2021 at 14:45)</a>:</h4>
<p>different lifetime makes them different types by definition</p>



<a name="252185493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185493">(Sep 06 2021 at 14:45)</a>:</h4>
<p>a lifetime kind is a "kind"</p>



<a name="252185516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185516">(Sep 06 2021 at 14:45)</a>:</h4>
<p>plus, even if they only have one value they can still be unforgeable</p>



<a name="252185563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185563">(Sep 06 2021 at 14:45)</a>:</h4>
<p>you can make them not copy</p>



<a name="252185576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185576">(Sep 06 2021 at 14:45)</a>:</h4>
<p>this is all useless and you are not helping</p>



<a name="252185654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185654">(Sep 06 2021 at 14:46)</a>:</h4>
<p>i can't even do this with unsafe code, and your answer is "build a safe abstraction on top of ????" instead</p>



<a name="252185695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185695">(Sep 06 2021 at 14:46)</a>:</h4>
<p>what's <code>????</code> here?</p>



<a name="252185703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185703">(Sep 06 2021 at 14:46)</a>:</h4>
<p>If you don't care about safety, just <code>unsafe impl Send for MyWrapper</code> and call it a day</p>



<a name="252185812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185812">(Sep 06 2021 at 14:47)</a>:</h4>
<p>the docs need to be more clear about this, they strongly suggest that there are other invariants to uphold</p>



<a name="252185843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185843">(Sep 06 2021 at 14:47)</a>:</h4>
<p>There are, but you don't want to talk about them</p>



<a name="252185859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185859">(Sep 06 2021 at 14:47)</a>:</h4>
<p>what are those ?</p>



<a name="252185901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185901">(Sep 06 2021 at 14:48)</a>:</h4>
<p>You shouldn't cause data races by mutating shared state</p>



<a name="252185948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185948">(Sep 06 2021 at 14:48)</a>:</h4>
<p>I think you know this already though</p>



<a name="252185985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252185985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252185985">(Sep 06 2021 at 14:48)</a>:</h4>
<p>the passing of pointers itself is safe, it is the subsequent use that is not</p>



<a name="252186000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186000">(Sep 06 2021 at 14:48)</a>:</h4>
<p>that invariant is already ensured by the <code>unsafe</code> required to dereference a raw pointer</p>



<a name="252186095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186095">(Sep 06 2021 at 14:49)</a>:</h4>
<p>not sure what <code>Send</code> has to do with this, and why the docs suggest using wrappers with more semantic meaning like the old <code>ptr::{Unique, Shared}</code>, and what one has to take care about here</p>



<a name="252186140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186140">(Sep 06 2021 at 14:49)</a>:</h4>
<p>for all these wrapper pointer types, the dereference is still <code>unsafe { *ptr }</code></p>



<a name="252186146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186146">(Sep 06 2021 at 14:49)</a>:</h4>
<p>And, as mentioned in an earlier thread, the reason <code>*const T</code> is not marked Send or Sync is because doing what you are doing would normally result in unsound code</p>



<a name="252186274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186274">(Sep 06 2021 at 14:50)</a>:</h4>
<p>I don't think that's possible, i am pretty sure that requires using <code>unsafe</code> to dereference the raw pointers</p>



<a name="252186277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186277">(Sep 06 2021 at 14:50)</a>:</h4>
<p>you have to pay close attention to the invariants to make sure you don't slip up. If you are doing that, then good, have a stamp of approval and <code>unsafe impl</code></p>



<a name="252186361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186361">(Sep 06 2021 at 14:51)</a>:</h4>
<p>You can use a wrapper called <code>Shared</code> or <code>Unique</code> that tries to emulate some variance, and then still screw everything up when doing the <code>unsafe { *ptr }</code> dereference</p>



<a name="252186414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186414">(Sep 06 2021 at 14:51)</a>:</h4>
<p>so I am really having a lot of trouble understanding what these wrappers need to account for</p>



<a name="252186540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186540">(Sep 06 2021 at 14:52)</a>:</h4>
<p>It would be technically correct for <code>*const T</code> and <code>*mut T</code> to impl Send and Sync, because of the reasons you have already said</p>



<a name="252186563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186563">(Sep 06 2021 at 14:52)</a>:</h4>
<p>it is not so because this is a footgun</p>



<a name="252186581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186581">(Sep 06 2021 at 14:52)</a>:</h4>
<p>and auto traits</p>



<a name="252186617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186617">(Sep 06 2021 at 14:52)</a>:</h4>
<p>but why do i need to handle variance in any way what so ever when writing a wrapper ?</p>



<a name="252186657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186657">(Sep 06 2021 at 14:52)</a>:</h4>
<p>or why do people care about the variance of these wrappers ?</p>



<a name="252186688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186688">(Sep 06 2021 at 14:53)</a>:</h4>
<p>because the variance of your type affects the variance of their type</p>



<a name="252186741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186741">(Sep 06 2021 at 14:53)</a>:</h4>
<p>so it is just in case they want to use my type as their field ?</p>



<a name="252186780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186780">(Sep 06 2021 at 14:53)</a>:</h4>
<p>my type is private, so that can't happen, so any wrapper would do for me then i think</p>



<a name="252186791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186791">(Sep 06 2021 at 14:53)</a>:</h4>
<p>If your <code>MyWrapper&lt;T&gt;</code> type is invariant in <code>T</code>, then if they have some bigger <code>Foo&lt;T&gt;</code> containing a <code>MyWrapper&lt;T&gt;</code> then <code>Foo&lt;T&gt;</code> will also be invariant in <code>T</code></p>



<a name="252186867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186867">(Sep 06 2021 at 14:54)</a>:</h4>
<p>ok this makes sense</p>



<a name="252186891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186891">(Sep 06 2021 at 14:54)</a>:</h4>
<p>i think it would make sense to update the nomicon with this info</p>



<a name="252186957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252186957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252186957">(Sep 06 2021 at 14:54)</a>:</h4>
<p>i was superconfused about what exactly these wrapper types need to upheld</p>



<a name="252187037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187037">(Sep 06 2021 at 14:55)</a>:</h4>
<p>Unfortunately I don't think there is a <code>struct MyWrapper&lt;#[unsafe covariant] T&gt;</code> syntax</p>



<a name="252187089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187089">(Sep 06 2021 at 14:55)</a>:</h4>
<p>so you have to use one of the library types if you want a different variance</p>



<a name="252187185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187185">(Sep 06 2021 at 14:56)</a>:</h4>
<p><code>struct S&lt;T&gt;(*const T)</code> is covariant in <code>T</code></p>



<a name="252187249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187249">(Sep 06 2021 at 14:56)</a>:</h4>
<p>if I want a different variance, I can just use <code>PhantomData</code> with a particular type that implies that variance I guess</p>



<a name="252187351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187351">(Sep 06 2021 at 14:57)</a>:</h4>
<p>Yes, you could have <code>struct S&lt;T&gt;(*const (), PhantomData&lt;fn(T)&gt;)</code> or something if you want a contravariant pointer</p>



<a name="252187390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187390">(Sep 06 2021 at 14:57)</a>:</h4>
<p>yes</p>



<a name="252187495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187495">(Sep 06 2021 at 14:58)</a>:</h4>
<p>what i am not sure of is how variance relates here to <code>Unique</code>/<code>Shared</code> , it does not look to me that they relate at all</p>



<a name="252187568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187568">(Sep 06 2021 at 14:58)</a>:</h4>
<p>maybe <code>unique</code> / <code>shared</code> are just "nullable" <code>&amp;mut T</code>, <code>&amp;T</code> ?! (from this POV it would make sense for them to have the same variance)</p>



<a name="252187584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187584">(Sep 06 2021 at 14:58)</a>:</h4>
<p>but have the same permissions otherwise ?</p>



<a name="252187673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187673">(Sep 06 2021 at 14:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="409057">hannahE2</span> <a href="#narrow/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads/near/252187568">said</a>:</p>
<blockquote>
<p>maybe <code>unique</code> / <code>shared</code> are just "nullable" <code>&amp;mut T</code>, <code>&amp;T</code> ?! (from this POV it would make sense for them to have the same variance)</p>
</blockquote>
<p>Well no, they are just as unsafe as pointers</p>



<a name="252187774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187774">(Sep 06 2021 at 15:00)</a>:</h4>
<p>also <code>Unique</code> is not nullable, it has a niche that you can use with <code>Option</code></p>



<a name="252187894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252187894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252187894">(Sep 06 2021 at 15:00)</a>:</h4>
<p>that sounds like <code>NonNull</code>, how does <code>Unique</code> differ from it ?</p>



<a name="252188128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188128">(Sep 06 2021 at 15:02)</a>:</h4>
<p><code>Unique&lt;T&gt;</code> is defined as <code>struct Unique&lt;T&gt;(NonNull&lt;T&gt;, PhantomData&lt;T&gt;)</code></p>



<a name="252188190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188190">(Sep 06 2021 at 15:02)</a>:</h4>
<p>so it has the same variance as <code>T</code></p>



<a name="252188204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188204">(Sep 06 2021 at 15:02)</a>:</h4>
<p>the comment says the phantom data is there to deal with dropck, which also looks at struct definitions</p>



<a name="252188233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188233">(Sep 06 2021 at 15:03)</a>:</h4>
<p>what's the variance of <code>NonNull&lt;T&gt;</code> over <code>T</code>?</p>



<a name="252188247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188247">(Sep 06 2021 at 15:03)</a>:</h4>
<p>both are covarinat</p>



<a name="252188306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188306">(Sep 06 2021 at 15:03)</a>:</h4>
<p>i need to read about <code>dropck</code></p>



<a name="252188538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188538">(Sep 06 2021 at 15:05)</a>:</h4>
<p>I think it has to do with being able to drop a <code>Box&lt;Foo&lt;'a&gt;&gt;</code> where <code>'a</code> is already expired at the point of the box destructor</p>



<a name="252188637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188637">(Sep 06 2021 at 15:05)</a>:</h4>
<p>so the <code>drop</code> impl has to not touch any <code>Foo&lt;'a&gt;</code> instances because they are invalid</p>



<a name="252188704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188704">(Sep 06 2021 at 15:06)</a>:</h4>
<p>hm</p>



<a name="252188741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188741">(Sep 06 2021 at 15:06)</a>:</h4>
<p>There is some mechanism for automatically inferring when this happens, and a <code>dropck_eyepatch</code> to fix the cases where it gets the wrong answer</p>



<a name="252188791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188791">(Sep 06 2021 at 15:07)</a>:</h4>
<p>do you know if there is a good intro to this?</p>



<a name="252188807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188807">(Sep 06 2021 at 15:07)</a>:</h4>
<p>I'll check in the nomicon, but hopefully there is something gentler</p>



<a name="252188873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188873">(Sep 06 2021 at 15:07)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nomicon/dropck.html#an-escape-hatch">https://doc.rust-lang.org/nomicon/dropck.html#an-escape-hatch</a> is that what you mean?</p>



<a name="252188884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188884">(Sep 06 2021 at 15:07)</a>:</h4>
<p>Yes</p>



<a name="252188963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252188963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252188963">(Sep 06 2021 at 15:08)</a>:</h4>
<p>ok i have not read that yet, thanks, maybe that clarifies all of this</p>



<a name="252189037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252189037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252189037">(Sep 06 2021 at 15:08)</a>:</h4>
<p>If you like videos I also suggest this one: <a href="https://www.youtube.com/watch?v=TJOFSMpJdzg">https://www.youtube.com/watch?v=TJOFSMpJdzg</a></p>
<div class="youtube-video message_inline_image"><a data-id="TJOFSMpJdzg" href="https://www.youtube.com/watch?v=TJOFSMpJdzg"><img src="https://uploads.zulipusercontent.net/589e35b876ad27163232055f703d4d3634eb00cd/68747470733a2f2f692e7974696d672e636f6d2f76692f544a4f46534d704a647a672f64656661756c742e6a7067"></a></div>



<a name="252189662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Types%20for%20passing%20raw%20pointers%20across%20threads/near/252189662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Types.20for.20passing.20raw.20pointers.20across.20threads.html#252189662">(Sep 06 2021 at 15:14)</a>:</h4>
<p>thanks!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>