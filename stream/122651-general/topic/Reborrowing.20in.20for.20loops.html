<html>
<head><meta charset="utf-8"><title>Reborrowing in for loops · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Reborrowing.20in.20for.20loops.html">Reborrowing in for loops</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259763915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Reborrowing%20in%20for%20loops/near/259763915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Reborrowing.20in.20for.20loops.html#259763915">(Oct 31 2021 at 02:33)</a>:</h4>
<p>A friend of mine who has been learning rust just stumbled on this surprising behavior:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// doesn't move x</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// doesn't move x</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span>::<span class="n">into_iter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// doesn't move x</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// moves x</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// fail</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(My friend is pretty new to rust and lifetimes, so the concept of consuming a <code>&amp;mut T</code> is all sorts of weird.) What is the reason for suppressing the reborrow when it is used as an argument to a for loop?</p>



<a name="259773771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Reborrowing%20in%20for%20loops/near/259773771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Reborrowing.20in.20for.20loops.html#259773771">(Oct 31 2021 at 07:19)</a>:</h4>
<p>Wow, this is really subtle.  If I take out that type annotation, the third loop starts being a move:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// doesn't move x</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// doesn't move x</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span>::<span class="n">into_iter</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// now this actually moves x</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">_i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// fail</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>&lt;<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=7ae16f7c030377c7254412eab4a8df0e">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=7ae16f7c030377c7254412eab4a8df0e</a>&gt;</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>error[E0382]: use of moved value: `x`
   --&gt; src/main.rs:6:15
    |
2   |     let x = &amp;mut vec![1];
    |         - move occurs because `x` has type `&amp;mut Vec&lt;i32&gt;`, which does not implement the `Copy` trait
...
5   |     for _i in &lt;_&gt;::into_iter(x) {} // now this actually moves x
    |               ----------------- `x` moved due to this method call
6   |     for _i in x {} // fail
    |               ^ value used here after move
</code></pre></div>



<a name="259774037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Reborrowing%20in%20for%20loops/near/259774037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Reborrowing.20in.20for.20loops.html#259774037">(Oct 31 2021 at 07:23)</a>:</h4>
<p>The actual desugar is to <code>IntoIterator::into_iter(...)</code>: <a href="https://github.com/rust-lang/rust/blob/0a09858b05bb0d92e87077c76fcb0648d32d44db/compiler/rustc_ast_lowering/src/expr.rs#L1446-L1453">https://github.com/rust-lang/rust/blob/0a09858b05bb0d92e87077c76fcb0648d32d44db/compiler/rustc_ast_lowering/src/expr.rs#L1446-L1453</a></p>



<a name="259792799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Reborrowing%20in%20for%20loops/near/259792799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Reborrowing.20in.20for.20loops.html#259792799">(Oct 31 2021 at 15:28)</a>:</h4>
<p>I think this is another instance of <a href="https://github.com/rust-lang/rust/issues/89966">https://github.com/rust-lang/rust/issues/89966</a>, just more hidden</p>



<a name="259800050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Reborrowing%20in%20for%20loops/near/259800050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Reborrowing.20in.20for.20loops.html#259800050">(Oct 31 2021 at 18:02)</a>:</h4>
<p>This is yet another case for the good old "type inference inhibits coercion"</p>



<a name="259800150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Reborrowing%20in%20for%20loops/near/259800150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Reborrowing.20in.20for.20loops.html#259800150">(Oct 31 2021 at 18:05)</a>:</h4>
<p>This is pretty intended much behaviour, but we should surely have better documentation: <a href="https://github.com/rust-lang/reference/issues/788">rust-lang/reference#788</a></p>



<a name="259800385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Reborrowing%20in%20for%20loops/near/259800385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Reborrowing.20in.20for.20loops.html#259800385">(Oct 31 2021 at 18:11)</a>:</h4>
<p>Note that <code>&amp;'a mut T</code> to <code>&amp;'b mut T</code> (if a != b) are different types. So when type inference happens no coercion can be performed. Coercion happens when both the expression type and the expected type are known. Reborrowing is essentially a subtyping coercion.</p>



<a name="259801515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Reborrowing%20in%20for%20loops/near/259801515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Reborrowing.20in.20for.20loops.html#259801515">(Oct 31 2021 at 18:34)</a>:</h4>
<p>From a teaching perspective, I don't think it helps to say that this is a consequence of the interaction between type inference and coercion. Is this a <em>desired</em> behavior, and if not what can be done to fix it? One solution that comes to mind is to postprocess the elaborated expression and insert reborrows on every term of type <code>&amp;mut T</code>, so as to ensure the property that every source level term of type &amp;mut T is reborrowed. Are there undesirable consequences of a transformation like this?</p>



<a name="259801524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Reborrowing%20in%20for%20loops/near/259801524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Reborrowing.20in.20for.20loops.html#259801524">(Oct 31 2021 at 18:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="338379">Giacomo Stevanato</span> <a href="#narrow/stream/122651-general/topic/Reborrowing.20in.20for.20loops/near/259792799">said</a>:</p>
<blockquote>
<p>I think this is another instance of <a href="https://github.com/rust-lang/rust/issues/89966">https://github.com/rust-lang/rust/issues/89966</a>, just more hidden</p>
</blockquote>
<p>I wonder why this edge case keeps being stumbled upon recently. I don't think anything changed...</p>



<a name="259801784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Reborrowing%20in%20for%20loops/near/259801784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Reborrowing.20in.20for.20loops.html#259801784">(Oct 31 2021 at 18:40)</a>:</h4>
<p>Oh, the issue mentions <a href="https://www.reddit.com/r/rust/comments/464jge/lifetime_issues_turning_tail_recursion_into_a_loop/">https://www.reddit.com/r/rust/comments/464jge/lifetime_issues_turning_tail_recursion_into_a_loop/</a> where moving (not reborrowing) a mutable reference is necessary</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>