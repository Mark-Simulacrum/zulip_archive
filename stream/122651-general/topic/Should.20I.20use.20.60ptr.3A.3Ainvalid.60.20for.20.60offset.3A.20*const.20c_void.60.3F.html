<html>
<head><meta charset="utf-8"><title>Should I use `ptr::invalid` for `offset: *const c_void`? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Should.20I.20use.20.60ptr.3A.3Ainvalid.60.20for.20.60offset.3A.20*const.20c_void.60.3F.html">Should I use `ptr::invalid` for `offset: *const c_void`?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278508144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Should%20I%20use%20%60ptr%3A%3Ainvalid%60%20for%20%60offset%3A%20%2Aconst%20c_void%60%3F/near/278508144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ruby Lazuli <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Should.20I.20use.20.60ptr.3A.3Ainvalid.60.20for.20.60offset.3A.20*const.20c_void.60.3F.html#278508144">(Apr 11 2022 at 04:40)</a>:</h4>
<p>Hey! I'm writing a game that interfaces directly with OpenGL through <code>gl33</code> (I've made several questionable life choices), so I've decided to opt in to the strict provenance experiment to make sure I wasn't totally dropping the ball. As expected, <code>fuzzy_provenance casts</code> linted against a few calls to <code>gl33::glVertexAttribPointer</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">gl33</span>::<span class="n">glVertexAttribPointer</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">3</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">gl33</span>::<span class="n">GL_FLOAT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">Vertex</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="c1">// from `memoffset`</span>
<span class="w">    </span><span class="n">offset_of</span><span class="o">!</span><span class="p">(</span><span class="n">Vertex</span><span class="p">,</span><span class="w"> </span><span class="n">normal</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">c_void</span><span class="p">,</span><span class="w">  </span><span class="c1">//~ WARN strict provenance disallows</span>
<span class="p">);</span><span class="w"></span>
</code></pre></div>
<p><a href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/glVertexAttribPointer.xhtml">Khronos's docs for <code>glVertexAttribPointer</code></a> proclaim that the last argument, <code>pointer</code>, is an offset:</p>
<blockquote>
<p>Specifies a offset of the first component of the first generic vertex attribute in the array in the data store of the buffer currently bound to the GL_ARRAY_BUFFER target. The initial value is 0.</p>
</blockquote>
<p>I believe this is the use case for <a href="https://doc.rust-lang.org/nightly/std/ptr/fn.invalid.html"><code>ptr::invalid</code></a>, whose docs state:</p>
<blockquote>
<p>essentially this expresses that the pointer is not associated with any actual allocation and is little more than a usize address in disguise.</p>
</blockquote>
<p>... but just to make sure I'm not committing Undefined Behaviour™, should I use <code>ptr::invalid</code> here, or is there a better way?</p>



<a name="278516339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Should%20I%20use%20%60ptr%3A%3Ainvalid%60%20for%20%60offset%3A%20%2Aconst%20c_void%60%3F/near/278516339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Should.20I.20use.20.60ptr.3A.3Ainvalid.60.20for.20.60offset.3A.20*const.20c_void.60.3F.html#278516339">(Apr 11 2022 at 07:23)</a>:</h4>
<p>You might find more help in <a class="stream" data-stream-id="136281" href="/#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines">#t-lang/wg-unsafe-code-guidelines</a> or perhaps a mod could move this thread over</p>



<a name="278543471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Should%20I%20use%20%60ptr%3A%3Ainvalid%60%20for%20%60offset%3A%20%2Aconst%20c_void%60%3F/near/278543471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Should.20I.20use.20.60ptr.3A.3Ainvalid.60.20for.20.60offset.3A.20*const.20c_void.60.3F.html#278543471">(Apr 11 2022 at 12:08)</a>:</h4>
<p>This is just a mistake on OpenGL's part, an offset is not a pointer, it cannot be dereferenced (nor can any pointer derived from it). So for your end, yes using <code>invalid</code> is fine here</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>