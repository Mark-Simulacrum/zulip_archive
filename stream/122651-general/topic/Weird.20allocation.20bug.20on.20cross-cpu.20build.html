<html>
<head><meta charset="utf-8"><title>Weird allocation bug on cross-cpu build · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Weird.20allocation.20bug.20on.20cross-cpu.20build.html">Weird allocation bug on cross-cpu build</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261641977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Weird%20allocation%20bug%20on%20cross-cpu%20build/near/261641977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Köln <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Weird.20allocation.20bug.20on.20cross-cpu.20build.html#261641977">(Nov 16 2021 at 13:44)</a>:</h4>
<p>I tried to run a locally build crate on a different machine today and got something fishy:<br>
It goes from allocating a Vec with a capacity of 64 elements to allocating a RawVec with 0x400000000000000 bytes.</p>
<div class="codehilite"><pre><span></span><code>#6  0x0000555556960667 in alloc::alloc::handle_alloc_error () at library/alloc/src/alloc.rs:367
#7  0x00005555568b3185 in alloc::raw_vec::RawVec&lt;T,A&gt;::allocate_in (capacity=288230376151711744, init=alloc::raw_vec::AllocInit::Uninitialized, alloc=...)
    at /rustc/59eed8a2aac0230a8b53e89d4e99d55912ba6b35/library/alloc/src/raw_vec.rs:209
#8  0x00005555568b677d in alloc::raw_vec::RawVec&lt;T,A&gt;::with_capacity_in (capacity=288230376151711744, alloc=...)
    at /rustc/59eed8a2aac0230a8b53e89d4e99d55912ba6b35/library/alloc/src/raw_vec.rs:143
#9  0x00005555568af5b1 in alloc::collections::vec_deque::VecDeque&lt;T,A&gt;::with_capacity_in (capacity=64, alloc=...)
    at /rustc/59eed8a2aac0230a8b53e89d4e99d55912ba6b35/library/alloc/src/collections/vec_deque/mod.rs:529
#10 0x00005555568aeeb7 in alloc::collections::vec_deque::VecDeque&lt;T&gt;::with_capacity (capacity=64)
    at /rustc/59eed8a2aac0230a8b53e89d4e99d55912ba6b35/library/alloc/src/collections/vec_deque/mod.rs:494
#11 0x000055555686f090 in tokio::runtime::basic_scheduler::BasicScheduler&lt;P&gt;::new (park=...)
    at /home/sebk/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-0.2.25/src/runtime/basic_scheduler.rs:93
#12 0x0000555556872424 in tokio::runtime::builder::Builder::build_basic_runtime (self=0x7fffffffd3b8)
    at /home/sebk/.cargo/registry/src/github.com-1ecc6299db9ec823/tokio-0.2.25/src/runtime/builder.rs:428
</code></pre></div>



<a name="261642304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Weird%20allocation%20bug%20on%20cross-cpu%20build/near/261642304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Köln <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Weird.20allocation.20bug.20on.20cross-cpu.20build.html#261642304">(Nov 16 2021 at 13:47)</a>:</h4>
<p>Build machine is Ubuntu 18 with an i7-4810MQ, target-cpu is ivybridge (sandybridge fails with the same error).<br>
Target machine is a xenon E5-2650 v2.</p>



<a name="261642344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Weird%20allocation%20bug%20on%20cross-cpu%20build/near/261642344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Köln <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Weird.20allocation.20bug.20on.20cross-cpu.20build.html#261642344">(Nov 16 2021 at 13:47)</a>:</h4>
<p>It runs fine locally.</p>



<a name="261642872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Weird%20allocation%20bug%20on%20cross-cpu%20build/near/261642872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Weird.20allocation.20bug.20on.20cross-cpu.20build.html#261642872">(Nov 16 2021 at 13:51)</a>:</h4>
<p>Can you share the crate that you are building?</p>



<a name="261642960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Weird%20allocation%20bug%20on%20cross-cpu%20build/near/261642960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Köln <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Weird.20allocation.20bug.20on.20cross-cpu.20build.html#261642960">(Nov 16 2021 at 13:51)</a>:</h4>
<p>I can try to remove the code that isn't public.</p>



<a name="261644557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Weird%20allocation%20bug%20on%20cross-cpu%20build/near/261644557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Köln <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Weird.20allocation.20bug.20on.20cross-cpu.20build.html#261644557">(Nov 16 2021 at 14:02)</a>:</h4>
<p>I could reproduce it with a 4 line <a href="http://main.rs">main.rs</a>. I will try to remove more dependencies when I have fiber connection back.</p>



<a name="261654495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Weird%20allocation%20bug%20on%20cross-cpu%20build/near/261654495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Köln <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Weird.20allocation.20bug.20on.20cross-cpu.20build.html#261654495">(Nov 16 2021 at 15:09)</a>:</h4>
<p><span class="user-mention" data-user-id="361356">@fee1-dead</span> <a href="https://github.com/s3bk/bugz">https://github.com/s3bk/bugz</a></p>



<a name="261658627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Weird%20allocation%20bug%20on%20cross-cpu%20build/near/261658627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sebastian Köln <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Weird.20allocation.20bug.20on.20cross-cpu.20build.html#261658627">(Nov 16 2021 at 15:34)</a>:</h4>
<p>okay, I may have messed up the rustflags and had target-cpu=native enable (as well)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>