<html>
<head><meta charset="utf-8"><title>C++ global with side-effectful initializer optimized away · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html">C++ global with side-effectful initializer optimized away</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254584184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254584184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254584184">(Sep 23 2021 at 18:44)</a>:</h4>
<p>I'm linking to some generated C++ code that uses the initializer of a never-accessed global variable to perform some setup (in this case, register something in a global map). However, sometimes the linker optimizes the global variable away,  and the initialization never occurs.</p>
<p>I'm not sure whether this is a bug; this pattern seems sketchy at best. I'm more interested in how to work around it. Currently, I'm emitting a <code>-uMY_GLOBAL_SYMBOL</code> flag to the linker in <code>build.rs</code> (using Cargo's <code>-Zrustc-link-arg</code>. However, I want to use this crate as a library, and linker flags emitted this way don't propagate to parent crates. </p>
<p>What would you do here?</p>



<a name="254584536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254584536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254584536">(Sep 23 2021 at 18:47)</a>:</h4>
<p><code>#[used]</code> doesn't work with <code>extern static</code>s, btw.</p>



<a name="254584875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254584875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254584875">(Sep 23 2021 at 18:49)</a>:</h4>
<p>Maybe the best choice is to modify the generated C++ to add <code>__atttribute__((used))</code></p>



<a name="254585707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254585707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254585707">(Sep 23 2021 at 18:55)</a>:</h4>
<p>Some C++ implementations only run the initializers for globals on the first access, rather than at startup.</p>



<a name="254585713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254585713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254585713">(Sep 23 2021 at 18:55)</a>:</h4>
<p>could it be that?</p>



<a name="254586113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254586113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254586113">(Sep 23 2021 at 18:57)</a>:</h4>
<p>I in the past approached this by calling a function in rust that simply accessed the C++ global (the function itself was defined on the C++ side)</p>



<a name="254589042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254589042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254589042">(Sep 23 2021 at 19:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254586113">said</a>:</p>
<blockquote>
<p>I in the past approached this by calling a function in rust that simply accessed the C++ global (the function itself was defined on the C++ side)</p>
</blockquote>
<p>I'll give that a try. I have a set of C++ shims for CXX bindings anyway, so that's pretty simple.</p>



<a name="254589083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254589083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254589083">(Sep 23 2021 at 19:15)</a>:</h4>
<p>Note: That's called deffered initialization, and is only permitted until at the latest, the first statement that odr-uses anything in the same translation unit. You could also solve it by placing a function in the source file that does nothing, but is called by the rust code.</p>



<a name="254589179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254589179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254589179">(Sep 23 2021 at 19:16)</a>:</h4>
<p>(Alternatively, you can avoid the headache that is C++ global variable dynamic initialization, and place the side-effect inducing global inside a function as a function-local static)</p>



<a name="254592153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254592153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Giacomo Stevanato <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254592153">(Sep 23 2021 at 19:36)</a>:</h4>
<p>I think something similar happened to the <code>inventory</code> crate <a href="https://github.com/dtolnay/inventory/issues/32">https://github.com/dtolnay/inventory/issues/32</a></p>



<a name="254592800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254592800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254592800">(Sep 23 2021 at 19:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254589083">said</a>:</p>
<blockquote>
<p>Note: That's called deffered initialization, and is only permitted until at the latest, the first statement that odr-uses anything in the same translation unit. You could also solve it by placing a function in the source file that does nothing, but is called by the rust code.</p>
</blockquote>
<p>The function doesn't even have to access the global?</p>



<a name="254592881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254592881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254592881">(Sep 23 2021 at 19:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254589179">said</a>:</p>
<blockquote>
<p>(Alternatively, you can avoid the headache that is C++ global variable dynamic initialization, and place the side-effect inducing global inside a function as a function-local static)</p>
</blockquote>
<p>function-local statics aren't eligible for deferred initialization then?</p>



<a name="254593078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254593078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254593078">(Sep 23 2021 at 19:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254586113">said</a>:</p>
<blockquote>
<p>I in the past approached this by calling a function in rust that simply accessed the C++ global (the function itself was defined on the C++ side)</p>
</blockquote>
<p>This works, although I ended up just taking its address on the rust-side since the global in question is <code>extern "C"</code>. It feels a bit brittle <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="254593366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254593366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254593366">(Sep 23 2021 at 19:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="338379">Giacomo Stevanato</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254592153">said</a>:</p>
<blockquote>
<p>I think something similar happened to the <code>inventory</code> crate <a href="https://github.com/dtolnay/inventory/issues/32">https://github.com/dtolnay/inventory/issues/32</a></p>
</blockquote>
<p>Rust was only missing life-before-main before it could become truly great.</p>



<a name="254597310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254597310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254597310">(Sep 23 2021 at 20:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie (ecstatic-morse)</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254592800">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254589083">said</a>:</p>
<blockquote>
<p>Note: That's called deffered initialization, and is only permitted until at the latest, the first statement that odr-uses anything in the same translation unit. You could also solve it by placing a function in the source file that does nothing, but is called by the rust code.</p>
</blockquote>
<p>The function doesn't even have to access the global?</p>
</blockquote>
<p>Nope. Just has to be in the same translation unit</p>



<a name="254597684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254597684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254597684">(Sep 23 2021 at 20:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie (ecstatic-morse)</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254592881">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254589179">said</a>:</p>
<blockquote>
<p>(Alternatively, you can avoid the headache that is C++ global variable dynamic initialization, and place the side-effect inducing global inside a function as a function-local static)</p>
</blockquote>
<p>function-local statics aren't eligible for deferred initialization then?</p>
</blockquote>
<p>So, function-local statics have a different form of initialization - the dynamic initialization occurs the first time you pass over the initializer while executing the function, like a once-cell (yes, it's thread safe in C++11 - if multiple threads enter the initialization, all block and only one of them actually intializes the static).</p>



<a name="254599054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254599054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254599054">(Sep 23 2021 at 20:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254597310">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="118594">Dylan MacKenzie (ecstatic-morse)</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254592800">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away/near/254589083">said</a>:</p>
<blockquote>
<p>Note: That's called deffered initialization, and is only permitted until at the latest, the first statement that odr-uses anything in the same translation unit. You could also solve it by placing a function in the source file that does nothing, but is called by the rust code.</p>
</blockquote>
<p>The function doesn't even have to access the global?</p>
</blockquote>
<p>Nope. Just has to be in the same translation unit</p>
</blockquote>
<p>Fascinating, this does seem to be the case. I was surprised that I wasn't calling anything in the same translation by pure chance, but it seems like the function that looks up the plugin is in a separate header file, not the generated code, and it's the first thing the program does.</p>



<a name="254602656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/C%2B%2B%20global%20with%20side-effectful%20initializer%20optimized%20away/near/254602656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dylan MacKenzie (ecstatic-morse) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/C.2B.2B.20global.20with.20side-effectful.20initializer.20optimized.20away.html#254602656">(Sep 23 2021 at 20:48)</a>:</h4>
<p>Thanks everybody</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>