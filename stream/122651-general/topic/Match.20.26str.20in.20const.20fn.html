<html>
<head><meta charset="utf-8"><title>Match &amp;str in const fn · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html">Match &amp;str in const fn</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268494671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268494671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268494671">(Jan 19 2022 at 05:43)</a>:</h4>
<p>I seem to be unable to do the following, which tries to match a <code>&amp;str</code> in a const context.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">protocol_version</span><span class="p">(</span><span class="n">version_string</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">version_string</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">"1.14.4"</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">498</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">None</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I get the following error message, which is not very enlightening:</p>
<div class="codehilite"><pre><span></span><code>error[E0015]: calls in constant functions are limited to constant functions, tuple structs and tuple variants
 --&gt; crates/brine_proto_backend/src/version.rs:5:9
  |
5 |         &quot;1.14.4&quot; =&gt; Some(498),
  |         ^^^^^^^^
</code></pre></div>
<p>It's very much against my intuition that this doesn't work. Does anyone know why it doesn't work?</p>



<a name="268495389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268495389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268495389">(Jan 19 2022 at 05:59)</a>:</h4>
<p>Looking at the MIR (removing <code>const</code> so it compiles), looks like the <code>match</code> gets lowered into a <code>PartialEq::eq</code> call. Perhaps that's it?</p>



<a name="268495825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268495825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268495825">(Jan 19 2022 at 06:06)</a>:</h4>
<p>Indeed: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_build/src/build/matches/test.rs#L261">https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_build/src/build/matches/test.rs#L261</a></p>



<a name="268599959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268599959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268599959">(Jan 19 2022 at 20:39)</a>:</h4>
<p>Interesting. And I guess "const trait impl` isn't exactly a thing at the moment?</p>



<a name="268602022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268602022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268602022">(Jan 19 2022 at 20:56)</a>:</h4>
<p>I wonder how many other scenarios there are where the MIR lowering introduces things that the user didn't explicitly write, causing similarly unhelpful compiler errors</p>



<a name="268610405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268610405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268610405">(Jan 19 2022 at 22:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/122651-general/topic/Match.20.26str.20in.20const.20fn/near/268599959">said</a>:</p>
<blockquote>
<p>Interesting. And I guess "const trait impl" isn't exactly a thing at the moment?</p>
</blockquote>
<p>It is on nightly.</p>



<a name="268628577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268628577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268628577">(Jan 20 2022 at 01:23)</a>:</h4>
<p><span class="user-mention" data-user-id="435059">@Ben Reeves</span> FWIW, byte-string comparisons do already work in <code>const fn</code>s:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">protocol_version</span><span class="w"> </span><span class="p">(</span><span class="n">version_string</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">_</span> <span class="kt">str</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">version_string</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="s">b"1.14.4"</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">498</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* … */</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="268629166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268629166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268629166">(Jan 20 2022 at 01:33)</a>:</h4>
<p>Oh noice, thanks <span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> . Did you mean to put that extra <code>|</code> in there?</p>



<a name="268629223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268629223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268629223">(Jan 20 2022 at 01:34)</a>:</h4>
<p>Fixed</p>



<a name="268639477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268639477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268639477">(Jan 20 2022 at 04:16)</a>:</h4>
<p>Ah but I can't <code>Option::unwrap()</code> in const context on stable Rust yet :/</p>



<a name="268675895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268675895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268675895">(Jan 20 2022 at 11:05)</a>:</h4>
<p>Well, you can <code>panic!</code> in <code>const</code> contexts now, there are just some limitations, if writing a generic <code>const fn unwrap</code>, about the drop glue (even if unreachable). So the following, in practice can be quite handy:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">unwrap</span><span class="w"> </span><span class="p">{(</span><span class="w"> </span><span class="cp">$opt</span>:<span class="nc">expr</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="cp">$opt</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">option</span>::<span class="nb">Option</span>::<span class="nb">Some</span><span class="p">(</span><span class="n">it</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">it</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">option</span>::<span class="nb">Option</span>::<span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span>::<span class="n">core</span>::<span class="fm">panic!</span><span class="p">(</span><span class="s">"Called `unwrap()` on a `None` value"</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">)}</span><span class="w"></span>
</code></pre></div>
<ul>
<li><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=27dad7f5846a7cf05ba470bc95082436">Demo</a></li>
</ul>



<a name="268734744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268734744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268734744">(Jan 20 2022 at 18:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/122651-general/topic/Match.20.26str.20in.20const.20fn/near/268629223">said</a>:</p>
<blockquote>
<p>Fixed</p>
</blockquote>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="n">match_arm_leading_pipes</span> <span class="o">=</span> <span class="s">"Always"</span>
</code></pre></div>



<a name="268738220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Match%20%26str%20in%20const%20fn/near/268738220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Match.20.26str.20in.20const.20fn.html#268738220">(Jan 20 2022 at 18:40)</a>:</h4>
<p>Whaaat, that's a thing?? All this time without knowing about it <span aria-label="weary" class="emoji emoji-1f629" role="img" title="weary">:weary:</span>, I guess just no codebase uses that setting <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>