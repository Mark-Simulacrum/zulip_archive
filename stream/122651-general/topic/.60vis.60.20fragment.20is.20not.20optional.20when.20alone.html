<html>
<head><meta charset="utf-8"><title>`vis` fragment is not optional when alone · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60vis.60.20fragment.20is.20not.20optional.20when.20alone.html">`vis` fragment is not optional when alone</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278182379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60vis%60%20fragment%20is%20not%20optional%20when%20alone/near/278182379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60vis.60.20fragment.20is.20not.20optional.20when.20alone.html#278182379">(Apr 07 2022 at 15:35)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$v</span>:<span class="nc">vis</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">m</span><span class="o">!</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>fails with</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>error: unexpected end of macro invocation
 --&gt; src/lib.rs:4:1
  |
1 | macro_rules! m {
  | -------------- when calling this macro
...
4 | m!();
  | ^^^^ missing tokens in macro arguments
</code></pre></div>
<p>even though the <code>vis</code> fragment is allowed to match nothing. Is this intended behavior for when it is standing alone like this?</p>



<a name="278182583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60vis%60%20fragment%20is%20not%20optional%20when%20alone/near/278182583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60vis.60.20fragment.20is.20not.20optional.20when.20alone.html#278182583">(Apr 07 2022 at 15:36)</a>:</h4>
<p>Or rather it seems this is the behavior when a vis fragment is at the end of the matcher in general, that is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="cp">$v</span>:<span class="nc">vis</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="n">m</span><span class="o">!</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>also fails. I assume this could be intentional, but I figured I'd better ask before noting that down in the little book of rust macros.</p>



<a name="278239925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60vis%60%20fragment%20is%20not%20optional%20when%20alone/near/278239925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60vis.60.20fragment.20is.20not.20optional.20when.20alone.html#278239925">(Apr 07 2022 at 23:34)</a>:</h4>
<p>Parsing a <code>vis</code> might need tokens after it.</p>



<a name="278290863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60vis%60%20fragment%20is%20not%20optional%20when%20alone/near/278290863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60vis.60.20fragment.20is.20not.20optional.20when.20alone.html#278290863">(Apr 08 2022 at 11:32)</a>:</h4>
<p>Yeah, <code>:vis</code> is really intended to be followed by a keyword or something, <em>à la</em> <code>struct, enum, union, fn</code> <em>etc.</em> For instance <code>$pub:vis $ident:ident</code> will be ambiguous as well, since <code>pub</code> could be part of the <code>:vis</code>, or it could be an empty <code>:vis</code> followed by the <code>ident</code> <code>pub</code>.</p>
<p>So, if you are not in a "classic" <code>:vis</code> situation, using <code>$(pub $(( $($vis:tt)* ))?)?</code> may be better (it will have the drawback not to be usable by other macros that already parsed a <code>:vis</code>, however. <em>e.g.</em>, good luck trying to feed a <code>$pub</code> of the <code>:vis</code> kind to <code>lazy_static!</code>)</p>



<a name="278291292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60vis%60%20fragment%20is%20not%20optional%20when%20alone/near/278291292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60vis.60.20fragment.20is.20not.20optional.20when.20alone.html#278291292">(Apr 08 2022 at 11:37)</a>:</h4>
<blockquote>
<p>For instance $pub:vis $ident:ident will be ambiguous as well, since pub could be part of the :vis, or it could be an empty :vis followed by the ident pub.</p>
</blockquote>
<p>That's not quite true, <code>pub</code> isn't an ident so that would parse as <code>vis</code> and then fail matching due to no tokens being left for matching up with the <code>ident</code> fragment.</p>
<p>But ye, it's not a problem I ran into per se, just an interesting behavior I found when trying to investigate a bug in rust-analyzer revolving around this special behaving fragment type.</p>



<a name="278291915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60vis%60%20fragment%20is%20not%20optional%20when%20alone/near/278291915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60vis.60.20fragment.20is.20not.20optional.20when.20alone.html#278291915">(Apr 08 2022 at 11:42)</a>:</h4>
<p><code>pub</code> is an <code>:ident</code>. macro <code>:ident</code> / <code>TokenTree::Ident</code> are actually the backing token for both keywords and non-keyword identifiers (the latter being the intuition that we may have of identifiers).</p>
<p>This is what leads to the very disheartenening situation of <code>$(mut)? $varname:ident</code> being an ambiguous parsing rule as well, for instance.</p>
<p>That being said, some testing does suggest that, to my surprsise,<code>:vis</code> may be a case (the only one that I know of) of "greedy matching" in the <code>macro_rules</code> world, thence avoiding the ambiguity when followed up by an <code>:ident</code>. I guess I mixed up the situation with <code>mut</code>, my bad</p>



<a name="278292335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60vis%60%20fragment%20is%20not%20optional%20when%20alone/near/278292335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60vis.60.20fragment.20is.20not.20optional.20when.20alone.html#278292335">(Apr 08 2022 at 11:46)</a>:</h4>
<p>Ye right, I forgot as well that keywords count as idents for macros. Tested the mentioned ambiguity which worked so I assumed different.</p>
<p>That is the exact weirdness I was wondering about, previously I explained <code>vis</code> as being an implicit optional repetition but it really doesn't behave like that at all as it turns out.</p>



<a name="278295080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60vis%60%20fragment%20is%20not%20optional%20when%20alone/near/278295080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60vis.60.20fragment.20is.20not.20optional.20when.20alone.html#278295080">(Apr 08 2022 at 12:14)</a>:</h4>
<p>I've expanded the <code>vis</code> section in the fragment specifier chapter a bit more, <a href="https://veykril.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#vis">https://veykril.github.io/tlborm/decl-macros/minutiae/fragment-specifiers.html#vis</a> I think it should cover all the oddities of it now</p>



<a name="278295261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60vis%60%20fragment%20is%20not%20optional%20when%20alone/near/278295261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lukas Wirth <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60vis.60.20fragment.20is.20not.20optional.20when.20alone.html#278295261">(Apr 08 2022 at 12:16)</a>:</h4>
<p>I've also found a way to make rust emit a fun error with this yesterday: <a href="https://github.com/rust-lang/rust/issues/95778">https://github.com/rust-lang/rust/issues/95778</a></p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>error: no rules expected the token ``
</code></pre></div>



<a name="278359790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/%60vis%60%20fragment%20is%20not%20optional%20when%20alone/near/278359790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/.60vis.60.20fragment.20is.20not.20optional.20when.20alone.html#278359790">(Apr 08 2022 at 20:43)</a>:</h4>
<p>Haha, an opaque token with empty contents <span aria-label="ok" class="emoji emoji-1f44c" role="img" title="ok">:ok:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>