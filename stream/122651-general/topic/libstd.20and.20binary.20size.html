<html>
<head><meta charset="utf-8"><title>libstd and binary size · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/libstd.20and.20binary.20size.html">libstd and binary size</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253565722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/libstd%20and%20binary%20size/near/253565722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wei Liu <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/libstd.20and.20binary.20size.html#253565722">(Sep 16 2021 at 11:28)</a>:</h4>
<p>I was reading <a href="https://github.com/johnthagen/min-sized-rust#optimize-libstd-with-build-std">https://github.com/johnthagen/min-sized-rust#optimize-libstd-with-build-std</a> and found this tidbit: "It's not possible to remove portions of libstd that are not used in a particular application".</p>
<p>I'm wondering why this is the case? I have the impression that linkers are generally smart enough to discard things that are not needed in the final binary. What stops that from happening in Rust?</p>



<a name="253569095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/libstd%20and%20binary%20size/near/253569095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/libstd.20and.20binary.20size.html#253569095">(Sep 16 2021 at 11:56)</a>:</h4>
<p>It is a slightly confusing statement. These portions of libstd are reachable, but only in exceptional cases. Take for example</p>
<blockquote>
<p>Remove panic String Formatting with panic_immediate_abort</p>
</blockquote>
<p>This removes part of libstd that is used to format panic messages when panicking. Your program likely won't panic, but there is no guarantee and as such the compiler is not allowed to remove this, because doing so would change behavior in the case that a panic does happen.</p>



<a name="253569670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/libstd%20and%20binary%20size/near/253569670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/libstd.20and.20binary.20size.html#253569670">(Sep 16 2021 at 12:00)</a>:</h4>
<p>Note that even a program with an empty <code>main</code> function can panic. For example if libc were to call into <code>main</code> twice, this assertion would fire:</p>
<p><a href="https://github.com/rust-lang/rust/blob/2b5ddf36fdc784106b3a064d93dd054c32b1f10f/library/std/src/sys_common/thread_info.rs#L40">https://github.com/rust-lang/rust/blob/2b5ddf36fdc784106b3a064d93dd054c32b1f10f/library/std/src/sys_common/thread_info.rs#L40</a></p>
<p>Or libc could return a nonsensical page size:</p>
<p><a href="https://github.com/rust-lang/rust/blob/2b5ddf36fdc784106b3a064d93dd054c32b1f10f/library/std/src/sys/unix/thread.rs#L452">https://github.com/rust-lang/rust/blob/2b5ddf36fdc784106b3a064d93dd054c32b1f10f/library/std/src/sys/unix/thread.rs#L452</a></p>
<p>Or it could return an error from any of the pthread functions in the same file.</p>



<a name="253569812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/libstd%20and%20binary%20size/near/253569812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/libstd.20and.20binary.20size.html#253569812">(Sep 16 2021 at 12:01)</a>:</h4>
<p>It is unlikely to happen, but the compiler can't remove the panic message formatting code just in case it does happen.</p>



<a name="253570427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/libstd%20and%20binary%20size/near/253570427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/libstd.20and.20binary.20size.html#253570427">(Sep 16 2021 at 12:06)</a>:</h4>
<p>min-sized-rust also suggests using <code>#![no_std]</code> which will disable certain safety mechanisms of libstd like adding a guard page to prevent stack clash attacks, add a SIGSEGV signal handler to give a nice message when a stack overflow happens. Santizing fds to ensure that if the invoking process closed stdin, stdout or stderr attempts to read from/write to any of these won't cause a file opened by the current process to be read from/written to instead, which can be a security issue. Libstd also prevents SIGPIPE from killing the current process.</p>
<p><a href="https://github.com/rust-lang/rust/blob/2b5ddf36fdc784106b3a064d93dd054c32b1f10f/library/std/src/sys_common/rt.rs#L14-L26">https://github.com/rust-lang/rust/blob/2b5ddf36fdc784106b3a064d93dd054c32b1f10f/library/std/src/sys_common/rt.rs#L14-L26</a></p>
<p><a href="https://github.com/rust-lang/rust/blob/2b5ddf36fdc784106b3a064d93dd054c32b1f10f/library/std/src/sys/unix/mod.rs#L53-L125">https://github.com/rust-lang/rust/blob/2b5ddf36fdc784106b3a064d93dd054c32b1f10f/library/std/src/sys/unix/mod.rs#L53-L125</a></p>



<a name="253570626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/libstd%20and%20binary%20size/near/253570626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/libstd.20and.20binary.20size.html#253570626">(Sep 16 2021 at 12:08)</a>:</h4>
<p>These are basically the reasons min-sized-rust is not the default, but if you are willing to accept these limitations, it is completely fine to use it to reduce binary size.</p>



<a name="253578123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/libstd%20and%20binary%20size/near/253578123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/libstd.20and.20binary.20size.html#253578123">(Sep 16 2021 at 13:07)</a>:</h4>
<blockquote>
<p>libstd also prevents SIGPIPE from killing the current process?</p>
</blockquote>
<p>Wouldn't that impact something like <code>cat</code>, that relies on the signal to terminate the stream early if you send an infinite stream to a finite output (such as <code>cat /dev/random | head -c 64</code>)? Or is that handled by <code>std::io</code>?</p>



<a name="253580189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/libstd%20and%20binary%20size/near/253580189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/libstd.20and.20binary.20size.html#253580189">(Sep 16 2021 at 13:21)</a>:</h4>
<p>In that case EPIPE is returned by the stdout write. <code>println!()</code> panics on errors during writing.</p>



<a name="253580294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/libstd%20and%20binary%20size/near/253580294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/libstd.20and.20binary.20size.html#253580294">(Sep 16 2021 at 13:22)</a>:</h4>
<p>And yes, you will get a panic instead of silent abort due to this code.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>