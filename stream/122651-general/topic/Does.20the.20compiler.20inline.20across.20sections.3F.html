<html>
<head><meta charset="utf-8"><title>Does the compiler inline across sections? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html">Does the compiler inline across sections?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250532171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250532171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250532171">(Aug 24 2021 at 19:01)</a>:</h4>
<p>If you have a function with a link_section attribute to place it in a specific section of the program, can it also still get inlined into other parts of the program?</p>



<a name="250532367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250532367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250532367">(Aug 24 2021 at 19:02)</a>:</h4>
<p>I would assume so.</p>



<a name="250532456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250532456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250532456">(Aug 24 2021 at 19:03)</a>:</h4>
<p>unfortunate</p>



<a name="250532524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250532524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250532524">(Aug 24 2021 at 19:03)</a>:</h4>
<p>yeah it can</p>



<a name="250532544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250532544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250532544">(Aug 24 2021 at 19:03)</a>:</h4>
<p>are you trying to put code in RAM or something like that?</p>



<a name="250532642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250532642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250532642">(Aug 24 2021 at 19:04)</a>:</h4>
<p>oh, or is this the thumb vs. arm mode code thing again?</p>



<a name="250532700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250532700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250532700">(Aug 24 2021 at 19:04)</a>:</h4>
<p><a href="https://rust.godbolt.org/z/Gf6qxexGj">https://rust.godbolt.org/z/Gf6qxexGj</a></p>



<a name="250540100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250540100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250540100">(Aug 24 2021 at 19:59)</a>:</h4>
<p>yeah, code in ram</p>



<a name="250757708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250757708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250757708">(Aug 26 2021 at 11:33)</a>:</h4>
<p>Couldn't you just add <code>#[inline(never)]</code>?</p>



<a name="250757796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250757796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elichai Turkel <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250757796">(Aug 26 2021 at 11:34)</a>:</h4>
<p>(or use external linking, but even then LTO can still link it)</p>



<a name="250767854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250767854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250767854">(Aug 26 2021 at 13:02)</a>:</h4>
<p><code>#[inline(never)]</code> is just a hint. LLVM happily looks at the content of the function for global analysis. Currently it just causes things like calls to such functions to disappear if they don't have side-effects and the result isn't used, but I wouldn't put it past LLVM to try to hoist code out of <code>#[inline(never)]</code> functions in the (far) future.</p>



<a name="250768982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250768982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250768982">(Aug 26 2021 at 13:10)</a>:</h4>
<p>I've even seen clang duplicate and const-prop functions that have __attribute__((noinline))</p>



<a name="250769289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250769289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250769289">(Aug 26 2021 at 13:12)</a>:</h4>
<p><code>#[inline(never)]</code> is probably the strongest hint of the three, but like <code>#[inline(always)]</code>, it's a misnomer.</p>



<a name="250769391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250769391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250769391">(Aug 26 2021 at 13:13)</a>:</h4>
<p>yeah we need to, long term, get something that's not a hint</p>



<a name="250769832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250769832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250769832">(Aug 26 2021 at 13:16)</a>:</h4>
<p>It may be possible to make <code>#[inline(never)]</code> actually guaranteed? I would prefer that we don't get a guaranteed <code>#[inline(always)]</code> because that implies that rust compilers MUST include the ability to inline functions at all (which, while that behaviour may be desirable of any optimizing compiler, it complicates non-optimizing compilers).</p>



<a name="250771615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250771615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250771615">(Aug 26 2021 at 13:29)</a>:</h4>
<p>most of the compiler pipeline is also angostic to linkage concerns.</p>



<a name="250777697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250777697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250777697">(Aug 26 2021 at 14:09)</a>:</h4>
<p>I wouldn't say thay inline(absolutely_never) doesn't imply that you're able to inline, it just implies that if inline happens, this one won't be considered.</p>



<a name="250779130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250779130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250779130">(Aug 26 2021 at 14:18)</a>:</h4>
<p>Why does this need a separate attribute? Just make inline(never) behave how inline (absolutely_never) would</p>



<a name="250779531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250779531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250779531">(Aug 26 2021 at 14:21)</a>:</h4>
<p>uh, sure? I don't care, but currently it's a hint is all</p>



<a name="250790642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250790642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250790642">(Aug 26 2021 at 15:28)</a>:</h4>
<blockquote>
<p>I wouldn't say thay inline(absolutely_never) doesn't imply that you're able to inline, it just implies that if inline happens, this one won't be considered.</p>
</blockquote>
<p>I was saying <code>inline(always)</code> being anything other than a strong hint would imply rust impls must inline.</p>



<a name="250791839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250791839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250791839">(Aug 26 2021 at 15:35)</a>:</h4>
<p>Although, I guess it could be the same - if any function would be inlined, a function marked inline(always) that can be, must be.</p>



<a name="250801780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250801780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250801780">(Aug 26 2021 at 16:37)</a>:</h4>
<p>Unless it is done at MIR level I don't want to guarantee that <code>#[inline(always)]</code> is always inlined. Not every backend (eg cg_clif) implements inlining.</p>



<a name="250807965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250807965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250807965">(Aug 26 2021 at 17:18)</a>:</h4>
<p>i think doing it at MIR level is the right solution then. I think <code>#[inline(always)]</code> ever not inlining is a bug, although i guess we could push people who really need it to use macros instead.</p>



<a name="250808215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250808215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250808215">(Aug 26 2021 at 17:20)</a>:</h4>
<p>it can't inline recursion, for example</p>



<a name="250808408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250808408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250808408">(Aug 26 2021 at 17:22)</a>:</h4>
<p>hmm, I feel like it should warn if it's really impossible to inline</p>



<a name="250810943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250810943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250810943">(Aug 26 2021 at 17:39)</a>:</h4>
<blockquote>
<p>i think doing it at MIR level is the right solution then. I think <code>#[inline(always)]</code> ever not inlining is a bug, although i guess we could push people who really need it to use macros instead.</p>
</blockquote>
<p>Still rules out other impls that may not have inlining support (at the current time, or as-planned).</p>



<a name="250811165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250811165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250811165">(Aug 26 2021 at 17:40)</a>:</h4>
<p>It could be reasonable to lint - that's a trivial implementation if it really doesn't support inlining whatsoever.</p>



<a name="250815059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250815059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250815059">(Aug 26 2021 at 18:07)</a>:</h4>
<blockquote>
<p>it can't inline recursion, for example</p>
</blockquote>
<p>Heavy agreement that it should at least warn if you try to use <code>#[inline(always)]</code> on a recursive function.</p>
<blockquote>
<p>Still rules out other impls that may not have inlining support (at the current time, or as-planned).</p>
</blockquote>
<p>I don't think this is the most difficult thing in the list of things a compiler must support in order to implement Rust.</p>



<a name="250818975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250818975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250818975">(Aug 26 2021 at 18:36)</a>:</h4>
<p>One of the problems here is that you need to specify what <code>inline</code> actually does if it's not just a hint, but in the abstract machine it doesn't do anything, thus making it something other than a lint difficult.</p>
<p>That said, I'd love more options for inlining.  For example, we have a bunch of things where it'd be great for them to be inlined into their <em>callers</em> before inlining their <em>callees</em> into themselves.  But the LLVM ones is bottom-up-only right now, IIRC.</p>



<a name="250819033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250819033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250819033">(Aug 26 2021 at 18:36)</a>:</h4>
<p>Guarantees like that also make alternative implementations hard.</p>



<a name="250819679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250819679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250819679">(Aug 26 2021 at 18:41)</a>:</h4>
<p>performance!</p>



<a name="250819730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250819730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250819730">(Aug 26 2021 at 18:42)</a>:</h4>
<p>but I'd really like the other way: <em>guaranteed to not be inlined</em></p>



<a name="250819853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250819853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250819853">(Aug 26 2021 at 18:43)</a>:</h4>
<p>Being able to rely on the fact that there won't be a stack frame associated with the call, for example. Also yes, performance.</p>



<a name="250825890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250825890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250825890">(Aug 26 2021 at 19:26)</a>:</h4>
<p>Performance is not a justification for a guarantee in the abstract machine. A valid implementation of rust could compile to brainf*ck code, running inside java, on a super nintendo. Would guaranteed inlining be useful to code running in such an implementation?</p>



<a name="250827398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250827398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250827398">(Aug 26 2021 at 19:36)</a>:</h4>
<p>I gave another justification.</p>



<a name="250827683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250827683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250827683">(Aug 26 2021 at 19:38)</a>:</h4>
<p>For example, when accessing a backtrace, you may want to hide (or force) certain frames to be captured as part of that backtrace.</p>



<a name="250828597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250828597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250828597">(Aug 26 2021 at 19:44)</a>:</h4>
<p>True.</p>



<a name="250832248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250832248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250832248">(Aug 26 2021 at 20:08)</a>:</h4>
<p>they will still show up when debuginfo is enabled. unless it is a tail call, in which case even debuginfo and <code>#[inline(never)]</code> won't help keeping the frame. you need something like a volatile read after the call to prevent tco. libstd had to do this to get short backtraces to work again.</p>



<a name="250847903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250847903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250847903">(Aug 26 2021 at 22:06)</a>:</h4>
<p>It's been a while, but this still matters when implementing backtraces. Anyway, the point is whether or not something is inlined is not entirely a noop in the abstract machine, just partially.</p>



<a name="250850603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250850603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250850603">(Aug 26 2021 at 22:28)</a>:</h4>
<p>(I'm pretty sure that backtraces aren't part of the abstract machine either -- or at very least they definitely have no stability guarantees, since otherwise no heuristics could be changed.)</p>



<a name="250852028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250852028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250852028">(Aug 26 2021 at 22:41)</a>:</h4>
<p>backtraces have to be part of the abstract machine, but they aren't stable</p>



<a name="250852463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/250852463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#250852463">(Aug 26 2021 at 22:45)</a>:</h4>
<p>it seems similar to pointer addresses, in that they are very obviously observable differences in response to compiler-internal changes, so "observational equivalence" is useless as a litmus test for compiler optimizations like eliminating a malloc / inlining a function</p>



<a name="251239762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/251239762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#251239762">(Aug 30 2021 at 14:41)</a>:</h4>
<p>I think an <code>inline(always)</code> that's guaranteed to work (or emit an error) makes sense. Among other uses, wrappers around inline assembly make sense to be always inlined.</p>



<a name="251248649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/251248649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#251248649">(Aug 30 2021 at 15:39)</a>:</h4>
<p>clearly we need repr(transparent) on functions</p>



<a name="251263859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/251263859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#251263859">(Aug 30 2021 at 17:28)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> We actually specify that <code>asm!()</code> invocations may be outlined by any backend for compatibility with backends that don't natively support inline asm. cg_clif uses an external assembler to assemble the <code>asm!()</code> by wrapping it in instructions to implement the SystemV abi, making it possible to call it from a cranelift generated function.</p>



<a name="251264003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/251264003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#251264003">(Aug 30 2021 at 17:29)</a>:</h4>
<p><a href="https://rust-lang.github.io/rfcs/2873-inline-asm.html#supporting-back-ends-without-inline-assembly">https://rust-lang.github.io/rfcs/2873-inline-asm.html#supporting-back-ends-without-inline-assembly</a></p>



<a name="251302189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/251302189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#251302189">(Aug 30 2021 at 22:05)</a>:</h4>
<p>Fair point, I'd forgotten that. (I do hope we add "native" inline asm support there one day, but <em>shrug</em>.)</p>



<a name="251517696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/251517696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#251517696">(Sep 01 2021 at 07:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="224471">Lokathor</span> <a href="#narrow/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F/near/250532456">said</a>:</p>
<blockquote>
<p>unfortunate</p>
</blockquote>
<p><span class="user-mention" data-user-id="224471">@Lokathor</span> if you want to prevent it from being inlined, this seems to work on Godbolt: <a href="https://godbolt.org/z/GrWEdf5eT">https://godbolt.org/z/GrWEdf5eT</a><br>
It basically wraps a function pointer inside a global <code>UnsafeCell</code> to fool the compiler into thinking that it might be mutated from other threads, therefore it won't be inlined.</p>



<a name="251517796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/251517796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#251517796">(Sep 01 2021 at 07:54)</a>:</h4>
<p>Also it does not make use of the <code>inline</code> attribute</p>



<a name="251523321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/251523321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#251523321">(Sep 01 2021 at 08:41)</a>:</h4>
<p>There are other optimizations here that can be sketchy – function deduplication comes to mind.</p>



<a name="251524612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/251524612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#251524612">(Sep 01 2021 at 08:51)</a>:</h4>
<p>Good point <span class="user-mention" data-user-id="123586">@nagisa</span>  <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>  I guess this is because of the <code>link_section</code> attribute?</p>



<a name="251535220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/251535220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#251535220">(Sep 01 2021 at 10:17)</a>:</h4>
<p>When all the function pointers point to the same <code>link_section</code>, it seems to deduplicate functions alright: <a href="https://godbolt.org/z/fTf8K9e4x">https://godbolt.org/z/fTf8K9e4x</a> (This is not the case when there are multiple <code>link_section</code> holding identical code). Curious now how this plays out with generics on functions <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="251536427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/Does%20the%20compiler%20inline%20across%20sections%3F/near/251536427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pointerbender <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/Does.20the.20compiler.20inline.20across.20sections.3F.html#251536427">(Sep 01 2021 at 10:27)</a>:</h4>
<p>With generics it also deduplicates functions, but slightly differently: <a href="https://godbolt.org/z/bn841rfxK">https://godbolt.org/z/bn841rfxK</a><br>
Without generics the assembly is <code>jmp     qword ptr [rip + example::square@GOTPCREL]</code> and with generics the assembly says <code>jmp     example::square</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>