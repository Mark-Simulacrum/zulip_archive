<html>
<head><meta charset="utf-8"><title>HRTB and closures returning futures · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html">HRTB and closures returning futures</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271884703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271884703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271884703">(Feb 14 2022 at 20:35)</a>:</h4>
<p>You can't "spread" a HRTB across two trait bounds:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">demo</span><span class="o">&lt;</span><span class="n">Foo</span><span class="p">,</span><span class="w"> </span><span class="n">FooFut</span><span class="o">&gt;</span><span class="p">(</span><span class="n">foo</span>: <span class="nc">Foo</span><span class="p">)</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Foo</span>: <span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">FooFut</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">FooFut</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="p">,</span><span class="w"></span>
</code></pre></div>
<p>I found some comments from <span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span>  that suggest the current best solution is a trait object:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">demo</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">(</span><span class="n">foo</span>: <span class="nc">Foo</span><span class="p">)</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Foo</span>: <span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
</code></pre></div>
<p>What language features does the eventual non-allocating solution need?</p>



<a name="271889923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271889923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271889923">(Feb 14 2022 at 21:18)</a>:</h4>
<p>None, technically (although it's slightly inconvenient):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">demo</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">(</span><span class="n">foo</span>: <span class="nc">Foo</span><span class="p">)</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Foo</span>: <span class="nc">AsyncCallback</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">AsyncCallback</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="bp">Self</span>: <span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">&lt;</span><span class="bp">Self</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AsyncCallback</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;&gt;</span>::<span class="n">Future</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Future</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="o">?</span><span class="nb">Sized</span><span class="p">,</span><span class="w"> </span><span class="n">Fut</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AsyncCallback</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">F</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="bp">Self</span>: <span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Fut</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Fut</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fut</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>demo to prove that it works: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=b10ba3ca7027bb74ce3e2b23c0411ffb">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=b10ba3ca7027bb74ce3e2b23c0411ffb</a></p>
<p>Now that there is potential for HRTB syntax to be added to closures, it's _possible_ that it would enable this pattern to work with async closures. I long for the day.</p>



<a name="271889994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271889994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271889994">(Feb 14 2022 at 21:19)</a>:</h4>
<p>Hmm, I tried the helper trait solution and couldn't get it to work. I wonder what's different here and my real code.</p>



<a name="271890105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271890105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271890105">(Feb 14 2022 at 21:20)</a>:</h4>
<p>Oh, maybe the "due to some arcane issue with how rustc produces HRTB impls" in the playground link</p>



<a name="271890231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271890231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271890231">(Feb 14 2022 at 21:21)</a>:</h4>
<p>But then you can't have a <em>closure</em>, is that correct?</p>



<a name="271890412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271890412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kestrer <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271890412">(Feb 14 2022 at 21:22)</a>:</h4>
<p>Yeah, unfortunately</p>



<a name="271894585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271894585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271894585">(Feb 14 2022 at 21:52)</a>:</h4>
<p>So <span class="user-mention" data-user-id="116155">@Jake Goulding</span>, I advocate for <code>BoxFuture</code> in practice, even though helper traits can express the right semantics (btw <span class="user-mention" data-user-id="280891">@Frank Steffahn</span> wrote a nifty crate to make it more lightweight: <a href="https://docs.rs/async_fn_traits">https://docs.rs/async_fn_traits</a>), because only <code>async fn</code> get to feature that signature / meet the necessary higher-order property</p>



<a name="271894697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271894697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271894697">(Feb 14 2022 at 21:53)</a>:</h4>
<p>A closure yielding an <code>async</code> block won't be able to be imbued with the right higher-order signature, for reasons similar to the justification of <a href="https://docs.rs/higher-order-closure">https://docs.rs/higher-order-closure</a></p>



<a name="271894709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271894709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271894709">(Feb 14 2022 at 21:53)</a>:</h4>
<p>oh dear <a href="/user_uploads/4715/rS9B_WOS6ua0mw40ZjbMgFhJ/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/rS9B_WOS6ua0mw40ZjbMgFhJ/image.png" title="image.png"><img src="/user_uploads/4715/rS9B_WOS6ua0mw40ZjbMgFhJ/image.png"></a></div>



<a name="271894805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271894805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271894805">(Feb 14 2022 at 21:54)</a>:</h4>
<p>But with TAIT, <code>higher_order_closure!</code> can be made to support this</p>



<a name="271894864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271894864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271894864">(Feb 14 2022 at 21:55)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> sure, from a practical POV it makes sense to use <code>BoxFuture</code> today. What I'm curious about is how we make it better.</p>



<a name="271894932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271894932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271894932">(Feb 14 2022 at 21:55)</a>:</h4>
<p>I'm planning on featuring that as a crate soon, using <code>BoxFuture</code> as a current stable polyfill / fallback, and letting a feature-gate use taits to avoid the heap allocation</p>



<a name="271895065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271895065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271895065">(Feb 14 2022 at 21:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116155">Jake Goulding</span> <a href="#narrow/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures/near/271894709">said</a>:</p>
<blockquote>
<p>oh dear <a href="/user_uploads/4715/rS9B_WOS6ua0mw40ZjbMgFhJ/image.png">image.png</a></p>
</blockquote>
<p>it's macro generated though. Feel free to peek at the source code ^^</p>



<a name="271895102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271895102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271895102">(Feb 14 2022 at 21:57)</a>:</h4>
<p><span class="user-mention" data-user-id="280891">@Frank Steffahn</span> oh, sure. It's just a big wall when you open the docs though.</p>



<a name="271895180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271895180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271895180">(Feb 14 2022 at 21:57)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> make sure you peek at <a class="stream-topic" data-stream-id="122651" href="/#narrow/stream/122651-general/topic/HRTB.20and.20dyn">#general &gt; HRTB and dyn</a>; relevant to your sphere of knowledge.</p>



<a name="271895255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/HRTB%20and%20closures%20returning%20futures/near/271895255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/HRTB.20and.20closures.20returning.20futures.html#271895255">(Feb 14 2022 at 21:58)</a>:</h4>
<p>... as you post in there <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>