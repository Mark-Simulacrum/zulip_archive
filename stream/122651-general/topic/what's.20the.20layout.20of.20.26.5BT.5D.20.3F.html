<html>
<head><meta charset="utf-8"><title>what&#x27;s the layout of &amp;[T] ? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/index.html">general</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html">what&#x27;s the layout of &amp;[T] ?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252148617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252148617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252148617">(Sep 06 2021 at 09:15)</a>:</h4>
<p>I'm passing <code>&amp;[T]</code> from one API to another via C FFI, but I'm calling these APIs a lot and I'm getting hit by the wrapping &amp; unwrapping of from_raw_parts.</p>



<a name="252148772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252148772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252148772">(Sep 06 2021 at 09:17)</a>:</h4>
<p>I'd like to just pass it as a <code>#[repr(C)] struct(....????....);</code> that has the exact same layout as <code>&amp;[T]</code></p>



<a name="252148833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252148833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252148833">(Sep 06 2021 at 09:17)</a>:</h4>
<p>I've tried <code>#[repr(C)] struct S(*mut u8, usize)</code> and <code>#[repr(C)] struct S(usize, *mut u8)</code> without luck. </p>
<p>What's the actual layout of <code>&amp;[T]</code>? Can it be expressed in Rust ?</p>
<hr>
<p>Not sure if the errors that I am seeing might be because the <code>repr(C)</code> layout differs from that of the <code>&amp;[T]</code>, but it appears that they do indeed differ. Is there a way to dump their layouts from their compiler for comparison?</p>



<a name="252149425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252149425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252149425">(Sep 06 2021 at 09:23)</a>:</h4>
<p>The layout of <code>&amp;[T]</code> is unstable.</p>



<a name="252149505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252149505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252149505">(Sep 06 2021 at 09:24)</a>:</h4>
<p>In any case the <strong>current</strong> layout is a separate pointer and length argument without wrapping it in a struct.</p>



<a name="252149527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252149527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252149527">(Sep 06 2021 at 09:24)</a>:</h4>
<p>So there is no way to express that in Rust ?</p>



<a name="252149575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252149575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252149575">(Sep 06 2021 at 09:25)</a>:</h4>
<p>No</p>



<a name="252149593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252149593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252149593">(Sep 06 2021 at 09:25)</a>:</h4>
<p>i.e. there is no <code>repr(slice)</code> or something ?</p>



<a name="252149610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252149610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252149610">(Sep 06 2021 at 09:25)</a>:</h4>
<p>No</p>



<a name="252149624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252149624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252149624">(Sep 06 2021 at 09:25)</a>:</h4>
<p>so that's bad, thanks</p>



<a name="252149632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252149632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252149632">(Sep 06 2021 at 09:25)</a>:</h4>
<p>from_raw_parts is the way to go for now.</p>



<a name="252149811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252149811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252149811">(Sep 06 2021 at 09:27)</a>:</h4>
<p>that sucks because its unsafe</p>



<a name="252149998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252149998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252149998">(Sep 06 2021 at 09:29)</a>:</h4>
<p>I think the unsafe code guidelines are wrong</p>



<a name="252150037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252150037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252150037">(Sep 06 2021 at 09:29)</a>:</h4>
<p><a href="https://rust-lang.github.io/unsafe-code-guidelines/layout/pointers.html">https://rust-lang.github.io/unsafe-code-guidelines/layout/pointers.html</a></p>



<a name="252150121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252150121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252150121">(Sep 06 2021 at 09:30)</a>:</h4>
<p>If you see the pointer to the slice section, it says that the</p>
<div class="codehilite"><pre><span></span><code>#[repr(C)]
struct Slice&lt;T&gt; {
  ptr: *const T,
  len: usize,
}
</code></pre></div>
<p>has the same layout as <code>*const [T]</code>/<code>&amp;[T]</code></p>



<a name="252150148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252150148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252150148">(Sep 06 2021 at 09:30)</a>:</h4>
<p>But that is incorrect because the "call ABI" of these differ.</p>



<a name="252150159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252150159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252150159">(Sep 06 2021 at 09:30)</a>:</h4>
<p>The UCG talks about memory layout and not call ABI.</p>



<a name="252150178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252150178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252150178">(Sep 06 2021 at 09:30)</a>:</h4>
<p>The UCG defines call ABI as part of layout, with niches, and many other things.</p>



<a name="252150198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252150198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252150198">(Sep 06 2021 at 09:31)</a>:</h4>
<p><code>rustc</code> also considers "call ABI" to be part of Layout</p>



<a name="252150236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252150236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252150236">(Sep 06 2021 at 09:31)</a>:</h4>
<p>In that case the UCG is indeed wrong.</p>



<a name="252150259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252150259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252150259">(Sep 06 2021 at 09:31)</a>:</h4>
<p><a href="https://rust-lang.github.io/unsafe-code-guidelines/glossary.html#layout">https://rust-lang.github.io/unsafe-code-guidelines/glossary.html#layout</a></p>



<a name="252150318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252150318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hannahE2 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252150318">(Sep 06 2021 at 09:32)</a>:</h4>
<blockquote>
<p>Moreover, the layout of a type records its function call ABI (or just ABI for short): how the type is passed by value across a function boundary.</p>
</blockquote>



<a name="252242222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252242222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt1992 <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252242222">(Sep 07 2021 at 02:20)</a>:</h4>
<p><a href="https://rust-lang.github.io/unsafe-code-guidelines/introduction.html">https://rust-lang.github.io/unsafe-code-guidelines/introduction.html</a></p>
<blockquote>
<p>Unless we state otherwise, the information in the guide is mostly a "recommendation" and still subject to change.</p>
</blockquote>
<p>Also, in the page for pointers, where the layout of <code>&amp;[T]</code> is described:<br>
<a href="https://rust-lang.github.io/unsafe-code-guidelines/layout/pointers.html#layout-of-reference-and-pointer-types">https://rust-lang.github.io/unsafe-code-guidelines/layout/pointers.html#layout-of-reference-and-pointer-types</a></p>
<blockquote>
<p>Disclaimer: Everything this section says about pointers to dynamically sized types represents the consensus from issue <a href="https://github.com/rust-lang/rust/issues/16">#16</a>, but has not been stabilized through an RFC. As such, this is preliminary information.</p>
</blockquote>



<a name="252283918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252283918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252283918">(Sep 07 2021 at 10:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="409057">hannahE2</span> <a href="#narrow/stream/122651-general/topic/what's.20the.20layout.20of.20.26.5BT.5D.20.3F/near/252148617">said</a>:</p>
<blockquote>
<p>I'm passing <code>&amp;[T]</code> from one API to another via C FFI, but I'm calling these APIs a lot and I'm getting hit by the wrapping &amp; unwrapping of from_raw_parts.</p>
</blockquote>
<ul>
<li><a href="https://docs.rs/safer-ffi/0.0.6/safer_ffi/slice/struct.slice_ref.html">https://docs.rs/safer-ffi/0.0.6/safer_ffi/slice/struct.slice_ref.html</a></li>
<li><a href="https://docs.rs/abi_stable/0.10.1/abi_stable/std_types/struct.RSlice.html">https://docs.rs/abi_stable/0.10.1/abi_stable/std_types/struct.RSlice.html</a></li>
<li><a href="https://docs.rs/chromium/0.0.2/chromium/struct.SharedSlice.html">https://docs.rs/chromium/0.0.2/chromium/struct.SharedSlice.html</a></li>
</ul>



<a name="252323797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122651-general/topic/what%27s%20the%20layout%20of%20%26%5BT%5D%20%3F/near/252323797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lokathor <a href="https://zulip-archive.rust-lang.org/stream/122651-general/topic/what&#x27;s.20the.20layout.20of.20.26.5BT.5D.20.3F.html#252323797">(Sep 07 2021 at 15:32)</a>:</h4>
<p>Love to get a mention &lt;3</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>