<html>
<head><meta charset="utf-8"><title>#[deprecated_safe] + Fn/FnMut/FnOnce · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html">#[deprecated_safe] + Fn/FnMut/FnOnce</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276234158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/%23%5Bdeprecated_safe%5D%20%2B%20Fn/FnMut/FnOnce/near/276234158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html#276234158">(Mar 22 2022 at 18:26)</a>:</h4>
<p>hey, i'm popping over here are the recommendation of the lang team</p>
<p>i have some questions about how the new <code>#[deprecated_safe]</code> (<a href="#narrow/stream/243200-t-lang.2Fmajor-changes/topic/Add.20.23.5Brustc_deprecated_safe.5D.20attribute.20to.20all.E2.80.A6.20lang-team.23147">zulip stream</a>) will interact with traits (which was surprising to some that it would)</p>
<p>this interacts with traits because now we need to allow an <code>unsafe fn</code> to become compatible with <code>Fn</code>/<code>FnMut</code>/<code>FnOnce</code> (unsoundly) as part of the backwards compatibility "hack"</p>
<p>you can see some examples in my (<em>very ugly</em>) <a href="https://github.com/rust-lang/rust/blob/862a10960403fd414b3631c1c8ee8a8246838076/src/test/ui/deprecated-safe/deprecated-safe.rs">current ui test</a></p>
<p>the way i currently have this implemented is that <code>FnPointerCandidate</code> gets tainted with a new <code>is_deprecated_safe</code> bool that gets set to true when assembling an <code>FnPointerCandidate</code> from an <code>unsafe fn</code> due to the new attribute</p>
<p>i also taint <code>BuiltinUnsizeCandidate</code> with a <code>is_deprecated_safe</code> bool when unsizing from an <code>unsafe fn</code> <code>FnDef</code> to one of the <code>Fn</code> traits</p>
<p>i then lint when confirming a <code>FnPointerCandidate</code> or <code>BuiltinUnsizeCandidate</code> that has been tainted as coming from a deprecated safe function, with a check to make sure i don't lint twice if the tainted <code>FnPointerCandidate</code> is coming from a tainted <code>BuiltinUnsizeCandidate</code> higher up the obligation stack</p>
<p>i'm not sure if this is a valid approach (this code is all new to me), and i also have no idea if this has implications  for other things... like chalk? i dunno <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>
<p>some feedback from people "in the know" on traits would be great <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="276235609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/%23%5Bdeprecated_safe%5D%20%2B%20Fn/FnMut/FnOnce/near/276235609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html#276235609">(Mar 22 2022 at 18:35)</a>:</h4>
<p>the reason i need to taint <code>BuiltinUnsizeCandidate</code> in addition to <code>FnPointerCandidate</code> is that <code>FnPointerCandidate</code> won't always get confirmed on every usage due to caching of a <code>BuiltinUnsizeCandidate</code> higher up in the stack, which is why i also need to check that i don't lint twice (although that "twice" check is currently somewhat kludgy)</p>



<a name="276237155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/%23%5Bdeprecated_safe%5D%20%2B%20Fn/FnMut/FnOnce/near/276237155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html#276237155">(Mar 22 2022 at 18:46)</a>:</h4>
<p>my current work can also be seen here: <a href="https://github.com/rust-lang/rust/pull/95025">https://github.com/rust-lang/rust/pull/95025</a></p>
<p>warning that i've been force pushing to that a lot though to stash my working directory as i go, so i woudn't use github review comments just yet</p>



<a name="276240666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/%23%5Bdeprecated_safe%5D%20%2B%20Fn/FnMut/FnOnce/near/276240666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html#276240666">(Mar 22 2022 at 19:13)</a>:</h4>
<p>Linting twice is fine. The actual user facing output deduplicates diagnostics. Ui tests however enable a special mode that doesn't deduplicate them.</p>



<a name="276247002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/%23%5Bdeprecated_safe%5D%20%2B%20Fn/FnMut/FnOnce/near/276247002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html#276247002">(Mar 22 2022 at 20:04)</a>:</h4>
<p>ahhh, getting the ui test passing is why i added the logic to prevent duplicates, <del>is there a way to handle that in ui tests?</del> (figured it out, <code>~|</code>)</p>
<p>i still find the <code>BuiltinUnsizeCandidate</code> check somewhat unsatisfactory since the check in <code>FnPointerCandidate</code> feels more natural, but i'm also very fussy <span aria-label="nerd" class="emoji emoji-1f913" role="img" title="nerd">:nerd:</span></p>



<a name="276254029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/%23%5Bdeprecated_safe%5D%20%2B%20Fn/FnMut/FnOnce/near/276254029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html#276254029">(Mar 22 2022 at 21:04)</a>:</h4>
<p>oh, i just double checked and i don't always end up with a <code>FnPointerCandidate</code> for every <code>BuiltinUnsizeCandidate</code>, so i think the check is actually necessary after all and it's not just caching</p>



<a name="276261665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/%23%5Bdeprecated_safe%5D%20%2B%20Fn/FnMut/FnOnce/near/276261665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html#276261665">(Mar 22 2022 at 22:09)</a>:</h4>
<p>btw, my "make sure i don't output duplicate lints" check was the last piece of code that i was 100% certain wouldn't fly in production, so extra special thanks <span class="user-mention" data-user-id="133247">@bjorn3</span>  for letting me remove that :)</p>



<a name="277354931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/%23%5Bdeprecated_safe%5D%20%2B%20Fn/FnMut/FnOnce/near/277354931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html#277354931">(Mar 31 2022 at 23:51)</a>:</h4>
<p>i'm getting back to this after being away for a week and have another question</p>
<p>one of my FIXMEs is around the fact that there are two <code>confirm_fn_pointer_candidate</code> functions, with one of them being related to "projection", and i'm trying to figure out if <code>#[deprecated_safe]</code> needs to support something here</p>
<p>from what i understand, projection would apply in something like this example (which doesn't compile):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Bla</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">T</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Bla</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="n">std</span>::<span class="n">ffi</span>::<span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">ffi</span>::<span class="n">OsString</span><span class="o">&gt;&gt;</span>::<span class="n">Output</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>is it actually possible to make something like what i've tried here that will compile? where i take a function and treat it as <code>Fn</code>/<code>FnMut</code>/<code>FnOnce</code> for the purposes of projection</p>



<a name="277357601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/%23%5Bdeprecated_safe%5D%20%2B%20Fn/FnMut/FnOnce/near/277357601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html#277357601">(Apr 01 2022 at 00:34)</a>:</h4>
<p>i've also tried:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Bla</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">T</span>: <span class="nb">Fn</span><span class="p">(</span><span class="n">std</span>::<span class="n">ffi</span>::<span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">ffi</span>::<span class="n">OsString</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Bla</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>but that doesn't work either:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="o">|</span><span class="w"></span>
<span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="k">type</span> <span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="o">|</span><span class="w">              </span><span class="o">^^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">type</span>
</code></pre></div>



<a name="277357823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/%23%5Bdeprecated_safe%5D%20%2B%20Fn/FnMut/FnOnce/near/277357823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jules Bertholet <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html#277357823">(Apr 01 2022 at 00:38)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(type_alias_impl_trait)]</span><span class="w"></span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ffi</span>::<span class="n">OsString</span><span class="p">;</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Bla</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">T</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">type</span> <span class="nc">Tait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">);</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Bla</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tait</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Tait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=2501486ab1758e33061ae414a7597ae5">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=2501486ab1758e33061ae414a7597ae5</a></p>



<a name="277359080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/%23%5Bdeprecated_safe%5D%20%2B%20Fn/FnMut/FnOnce/near/277359080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> skippy <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/.23.5Bdeprecated_safe.5D.20.2B.20Fn.2FFnMut.2FFnOnce.html#277359080">(Apr 01 2022 at 00:59)</a>:</h4>
<p>thank you!!!!</p>
<p>that does cause the secondary <code>project.rs</code>:<code>confirm_fn_pointer_candidate</code> function that i was curious about to get hit with my <code>#[deprecated_safe]</code> version of <code>set_var</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[deprecated_safe(since = </span><span class="s">"TBD"</span><span class="cp">, note = </span><span class="s">"reason"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_var</span><span class="o">&lt;</span><span class="n">K</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">V</span>: <span class="nb">AsRef</span><span class="o">&lt;</span><span class="n">OsStr</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">key</span>: <span class="nc">K</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="nc">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span>::<span class="n">env</span>::<span class="n">set_var</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Bla</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">T</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">type</span> <span class="nc">Tait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="n">OsString</span><span class="p">,</span><span class="w"> </span><span class="n">OsString</span><span class="p">);</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Bla</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tait</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Tait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">set_var</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>interestingly my new lint already fires in this case, so i think i may be ok as is? (that's for me to explore <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span>)<br>
<a href="/user_uploads/4715/nx-mqxkqBTxaYK5WxGfocciE/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/4715/nx-mqxkqBTxaYK5WxGfocciE/image.png" title="image.png"><img src="/user_uploads/4715/nx-mqxkqBTxaYK5WxGfocciE/image.png"></a></div><p>in <code>project.rs</code> there's no more <code>FnPointerCandidate</code> either, just <code>ImplSource::FnPointer</code>... which i think would always come from an <code>FnPointerCandidate</code> that i already linted about... so i think it already working may make sense</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>