<html>
<head><meta charset="utf-8"><title>Variance and associated types · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html">Variance and associated types</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250510905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250510905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250510905">(Aug 24 2021 at 16:33)</a>:</h4>
<p>Okay, so while trying to figure out why the <code>rustc_type_ir</code> changes don't work (see <a href="#narrow/stream/144729-wg-traits/topic/Moving.20.60TyEncodable.60.2F.60TyDecodable.60.20to.20.60rustc_typeir.60">https://rust-lang.zulipchat.com/#narrow/stream/144729-wg-traits/topic/Moving.20.60TyEncodable.60.2F.60TyDecodable.60.20to.20.60rustc_typeir.60</a>), I basically figured out that changing <code>enum TyKind&lt;'tcx&gt; { ... }</code> to <code>enum TyKind&lt;I: Interner&gt; { ... }</code> <em>won't</em> work currently</p>



<a name="250511070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250511070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250511070">(Aug 24 2021 at 16:34)</a>:</h4>
<p>Namely, you can imagine you might have a variant <code>Slice(&amp;'tcx TyKind&lt;'tcx&gt;)</code> which turns into <code>Slice(I::Ty)</code></p>



<a name="250511115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250511115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250511115">(Aug 24 2021 at 16:34)</a>:</h4>
<p>(I'm simplifying by leaving out <code>Ty</code> and <code>TyS</code>, but the principle holds)</p>



<a name="250511223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250511223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250511223">(Aug 24 2021 at 16:35)</a>:</h4>
<p>An important distinction here is that the former allows <code>TyKind</code> to be <em>covariant</em> over <code>'tcx</code>, whereas the latter requires that <code>TyKind</code> be <em>invariant</em> over <code>I</code></p>



<a name="250511378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250511378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250511378">(Aug 24 2021 at 16:36)</a>:</h4>
<p>See <a href="https://github.com/rust-lang/rust/issues/21726">#21726</a> for why this was changes. Tldr, if you have <code>A &lt;: B</code>, you can't necessarily assume that <code>A::Ty</code> &lt;: <code>B::Ty</code></p>



<a name="250511439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250511439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250511439">(Aug 24 2021 at 16:37)</a>:</h4>
<p>I was thinking about what the best way to "fix" this</p>



<a name="250511624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250511624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250511624">(Aug 24 2021 at 16:38)</a>:</h4>
<p>I do want to quickly note a workaround: <code>enum TyKind&lt;I: Interner, ITy = &lt;I as Interner&gt;::Ty&gt; where &lt;I as Interner&gt;::Ty = ITy { ... }</code></p>



<a name="250511695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250511695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250511695">(Aug 24 2021 at 16:38)</a>:</h4>
<p>But that quickly falls apart once you add cycles (even though they are broken through references and such)</p>



<a name="250512082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250512082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250512082">(Aug 24 2021 at 16:41)</a>:</h4>
<p>Now, one way to fix this (and was briefly mentioned in <a href="https://github.com/rust-lang/rust/issues/21726">#21726</a>), would be to have some way to mark the variances on associated types on a trait. And impls would have to abide by that. This probably works, but isn't particularly ideal. You would have to have something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cp">#[variance(covariant, covariant, covariant)]</span><span class="w"> </span><span class="c1">// Self, A, B</span>
<span class="w">  </span><span class="k">type</span> <span class="nc">Bar</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>or some form. Workable but ugly.</p>



<a name="250512114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250512114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250512114">(Aug 24 2021 at 16:41)</a>:</h4>
<p>I was musing about something better</p>



<a name="250512330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250512330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250512330">(Aug 24 2021 at 16:43)</a>:</h4>
<p>So, looking back at the workaround from above, this <em>works</em> because we extract out <code>I::Ty</code> into a separate parameter, which we can then be covariant.</p>



<a name="250512513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250512513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250512513">(Aug 24 2021 at 16:44)</a>:</h4>
<p>I thought a little bit about this, how we could conceivably "automate" that, etc., but then I realized: what if we change the way we approach this</p>



<a name="250512672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250512672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250512672">(Aug 24 2021 at 16:45)</a>:</h4>
<p>So, sort of the key limitation here is that we relate types (particularly here adts) by the required variances of their <em>generics</em></p>



<a name="250512742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250512742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250512742">(Aug 24 2021 at 16:46)</a>:</h4>
<p>And these really are calculated <em>a priori</em> by the fields of adts</p>



<a name="250512877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250512877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250512877">(Aug 24 2021 at 16:46)</a>:</h4>
<p>Now, imagine we <em>didn't</em> calculate them ahead of time</p>



<a name="250513139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250513139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250513139">(Aug 24 2021 at 16:48)</a>:</h4>
<p>Anytime we wanted to relate two types (again, here just using adts), we would just relate each individual <em>field</em></p>



<a name="250513296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250513296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250513296">(Aug 24 2021 at 16:49)</a>:</h4>
<p>So say we had <code>struct Foo&lt;A&gt; { a: A }</code>. To relate <code>Foo&lt;X&gt; &lt;: Foo&lt;Y&gt;</code>, we would relate <code>X &lt;: Y</code>.</p>



<a name="250513754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250513754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250513754">(Aug 24 2021 at 16:52)</a>:</h4>
<p>Now, why can't we do this when we use associated types in fields. If instead we had <code>struct Foo&lt;I: Interner&gt; { ty: I::Ty }</code>, to relate <code>Foo&lt;X&gt; &lt;: Foo&lt;Y&gt;</code>, we just create the goal <code>X::Ty &lt;: Y::Ty</code>. Importantly, we don't have to "think" about the variance on <code>I</code> itself.</p>



<a name="250513995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250513995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250513995">(Aug 24 2021 at 16:54)</a>:</h4>
<p>Where I'm less sure about is the way we currently compute the variances. Because these are calculated ahead of time, they are able to run to a fixed-state. Theoretically, the trait solver does the same thing (runs to a fixed-state).</p>



<a name="250514101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250514101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250514101">(Aug 24 2021 at 16:54)</a>:</h4>
<p>Also, I'm not sure if not directly related <code>X</code> and <code>Y</code> would cause us not to be able to solve some goals we otherwise would have</p>



<a name="250514125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250514125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250514125">(Aug 24 2021 at 16:55)</a>:</h4>
<p>But that's where I'm at in my thoughts.</p>



<a name="250514137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250514137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250514137">(Aug 24 2021 at 16:55)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span> for thoughts :)</p>



<a name="250559371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/250559371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#250559371">(Aug 24 2021 at 22:41)</a>:</h4>
<p>Wow, I have never thought about variance in regards to associated types, the use of invariance is surprising but makes sense as a default with some thought, fascinating!</p>



<a name="251410713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/251410713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#251410713">(Aug 31 2021 at 16:03)</a>:</h4>
<p>I don't think that works</p>



<a name="251410841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/251410841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#251410841">(Aug 31 2021 at 16:03)</a>:</h4>
<p>Well, hold on, maybe I don't totally understand what you are proposing</p>



<a name="251414953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/251414953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#251414953">(Aug 31 2021 at 16:31)</a>:</h4>
<p>I'm not exactly sure what I'm proposing</p>



<a name="251415286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Variance%20and%20associated%20types/near/251415286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Variance.20and.20associated.20types.html#251415286">(Aug 31 2021 at 16:33)</a>:</h4>
<p>Right now, to relate to adts, we relate their substs based on the variance of each that we've precalculated. But theoretically, we could relate the fields themselves? (Importantly, we could relate <em>projections</em> built from the substs)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>