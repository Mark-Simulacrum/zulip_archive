<html>
<head><meta charset="utf-8"><title>Dyn upcasting vs deref coercion · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html">Dyn upcasting vs deref coercion</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254461534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254461534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254461534">(Sep 23 2021 at 00:32)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/89190">#89190</a> gives code that compiles in stable but does not in beta, and involves trait upcasting.</p>
<p>In stable it is currently deref coercion, and it now becomes an upcasting coercion. How can we resolve this? Unsizing coercion takes priority over deref coercion and I think it's very reasonable since unsizing can only be done via coercion while deref can be explicit. We could "hide" upcasting coercion if the feature is not enabled so the code won't break, but then when we stablise this feature it'll become a behaviour change.</p>



<a name="254595946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254595946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254595946">(Sep 23 2021 at 20:03)</a>:</h4>
<p>Oh dear! :)</p>



<a name="254595969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254595969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254595969">(Sep 23 2021 at 20:03)</a>:</h4>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> is this a hypothetical regression or something from a real code base?</p>



<a name="254596286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254596286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254596286">(Sep 23 2021 at 20:06)</a>:</h4>
<p>I am not the original poster :)</p>
<p>I hope it's not from a real code base; it it was, then it might actually be mimicking trait upcasting so replacing it with trait upcasting might work. But I guess we might need a crater run to find out.</p>



<a name="254598479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254598479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254598479">(Sep 23 2021 at 20:20)</a>:</h4>
<p>I'm quite curious how that deref could be implemented though...</p>



<a name="254600381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254600381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tamme Schichler <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254600381">(Sep 23 2021 at 20:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion/near/254595969">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> is this a hypothetical regression or something from a real code base?</p>
</blockquote>
<p>Yes and no, I'm more or less about to publish the crate where I ran across this (days, likely), but I've also put a workaround in there already because I need to debug some derive macros with <code>cargo expand</code>. (I'm exposing <code>Ord</code> and <code>Eq</code> on trait objects of one trait object type that derefs into another trait object type that's only <code>Eq</code> that in turns derefs into another that's neither, and they're also a trait dependency chain.)</p>



<a name="254601645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254601645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tamme Schichler <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254601645">(Sep 23 2021 at 20:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion/near/254596286">said</a>:</p>
<blockquote>
<p>I am not the original poster :)</p>
<p>I hope it's not from a real code base; it it was, then it might actually be mimicking trait upcasting so replacing it with trait upcasting might work. But I guess we might need a crater run to find out.</p>
</blockquote>
<p>It's mimicking trait upcasting in this case, or rather it <em>should</em>. Consumers can implement it differently, though.<br>
It may be possible to lock this down more. I'll have to think about it, but it would likely involve additional marker traits.</p>



<a name="254602790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254602790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tamme Schichler <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254602790">(Sep 23 2021 at 20:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232957">Jack Huey</span> <a href="#narrow/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion/near/254598479">said</a>:</p>
<blockquote>
<p>I'm quite curious how that deref could be implemented though...</p>
</blockquote>
<p><a href="https://github.com/Tamschi/fruit-salad/blob/develop/src/lib.rs#L352-L361">https://github.com/Tamschi/fruit-salad/blob/develop/src/lib.rs#L352-L361</a> Is the implementation, so it's really just deferring that to the actual trait implementation there. (I've got some left-over <code>mem::transmute</code>s in there, I think. I'll go over this again later on, once all my tests compile.)<br>
<a href="https://github.com/Tamschi/fruit-salad/blob/develop/src/lib.rs#L374">https://github.com/Tamschi/fruit-salad/blob/develop/src/lib.rs#L374</a> (for example) is where I ran across the bug. The second <code>.as_dyncast_eq()</code> is unnecessary on stable.</p>



<a name="254603160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254603160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254603160">(Sep 23 2021 at 20:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232957">Jack Huey</span> <a href="#narrow/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion/near/254598479">said</a>:</p>
<blockquote>
<p>I'm quite curious how that deref could be implemented though...</p>
</blockquote>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=9c804746d53218d5762c9b0e04dff5b6">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=9c804746d53218d5762c9b0e04dff5b6</a> Here you go, a working dyn upcast emulation :)</p>



<a name="254603586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254603586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254603586">(Sep 23 2021 at 20:54)</a>:</h4>
<p>Using a technique that I discovered ~1 month ago about how to add default impl that has Sized bound without making the method non-object-safe ;)</p>



<a name="254603643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254603643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254603643">(Sep 23 2021 at 20:54)</a>:</h4>
<p>Ah interesting</p>



<a name="254603657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254603657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254603657">(Sep 23 2021 at 20:54)</a>:</h4>
<p>I figured it was going to be something like that</p>



<a name="254603770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254603770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254603770">(Sep 23 2021 at 20:55)</a>:</h4>
<p>Oops, I named it downcast but it's actually upcast (fixed)</p>



<a name="254608666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254608666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tamme Schichler <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254608666">(Sep 23 2021 at 21:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion/near/254603160">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="232957">Jack Huey</span> <a href="#narrow/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion/near/254598479">said</a>:</p>
<blockquote>
<p>I'm quite curious how that deref could be implemented though...</p>
</blockquote>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=9c804746d53218d5762c9b0e04dff5b6">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=9c804746d53218d5762c9b0e04dff5b6</a> Here you go, a working dyn upcast emulation :)</p>
</blockquote>
<p>This works extremely well for my crate. Is it okay if I credit you for the idea (in a source code comment) by GitHub username and a link to this message? (I've adapted it a bit to use a private generic trait, since I need this for multiple traits.)</p>



<a name="254608811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254608811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tamme Schichler <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254608811">(Sep 23 2021 at 21:31)</a>:</h4>
<p>Still not entirely airtight, but it's less convenient to implement this otherwise now.</p>



<a name="254615734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254615734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254615734">(Sep 23 2021 at 22:29)</a>:</h4>
<p>Sure</p>



<a name="254650009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254650009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254650009">(Sep 24 2021 at 04:40)</a>:</h4>
<p>Thanks for pointing this out!</p>



<a name="254650747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/254650747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#254650747">(Sep 24 2021 at 04:51)</a>:</h4>
<p>I'm not totally familiar with the procedure here...  Should we start a crater run to address the back-compat-breakage scope first?</p>



<a name="255049264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/255049264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#255049264">(Sep 27 2021 at 13:39)</a>:</h4>
<p>I guess <span class="user-mention" data-user-id="116458">@Charles Lew</span> we should decide whether we want to fix it first :)</p>



<a name="255370074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/255370074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#255370074">(Sep 29 2021 at 09:44)</a>:</h4>
<p>Ok... I have a branch that converts this into a future incompat lint. If a future-incompat lint is the way to go here, i can finish the implementation and submit it this weekend.</p>



<a name="255370896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/255370896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#255370896">(Sep 29 2021 at 09:51)</a>:</h4>
<p>Personally i'd prefer to discourage people using this trick... A future incompatible lint can provide smooth migration, but i fear this actually advocates people using this trick...</p>



<a name="255371605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/255371605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#255371605">(Sep 29 2021 at 09:56)</a>:</h4>
<p>Why is it future incompatible? The code using this trick will still compile with <code>#![feature(trait_upcasting)]</code>/after its stabilization. It just will silently stop calling the <code>deref</code> (and that shouldn't be a problem for reasonable deref implementations).</p>



<a name="255375034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/255375034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#255375034">(Sep 29 2021 at 10:25)</a>:</h4>
<p>I'm just not sure what people might do in <code>deref</code> and <code>deref_mut</code>s... Maybe i'm more prudent than necessary...</p>



<a name="255485814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/255485814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#255485814">(Sep 29 2021 at 22:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="273349">Waffle Lapkin</span> <a href="#narrow/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion/near/255371605">said</a>:</p>
<blockquote>
<p>Why is it future incompatible? The code using this trick will still compile with <code>#![feature(trait_upcasting)]</code>/after its stabilization. It just will silently stop calling the <code>deref</code> (and that shouldn't be a problem for reasonable deref implementations).</p>
</blockquote>
<p>This is a behaviour change, so I think a future incompat lint is a good idea.</p>



<a name="255864501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Dyn%20upcasting%20vs%20deref%20coercion/near/255864501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Dyn.20upcasting.20vs.20deref.20coercion.html#255864501">(Oct 02 2021 at 11:36)</a>:</h4>
<p>created <a href="https://github.com/rust-lang/rust/pull/89461">https://github.com/rust-lang/rust/pull/89461</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>