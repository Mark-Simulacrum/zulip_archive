<html>
<head><meta charset="utf-8"><title>Removing ordering from DefId (chalk) · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html">Removing ordering from DefId (chalk)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265235716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265235716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265235716">(Dec 16 2021 at 23:39)</a>:</h4>
<p>I'm really starting to think this isn't correct: <a href="https://github.com/rust-lang/chalk/pull/739/files#diff-ba814a8e084488bce444bd626693c6c99786b7be83fc1f0f05c51853e0fb96deR119">https://github.com/rust-lang/chalk/pull/739/files#diff-ba814a8e084488bce444bd626693c6c99786b7be83fc1f0f05c51853e0fb96deR119</a></p>



<a name="265235819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265235819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265235819">(Dec 16 2021 at 23:40)</a>:</h4>
<p>Based on? The failing test?</p>



<a name="265235866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265235866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265235866">(Dec 16 2021 at 23:41)</a>:</h4>
<p>Try adding <code>disable_coherence;</code> to the test</p>



<a name="265236107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265236107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265236107">(Dec 16 2021 at 23:44)</a>:</h4>
<p>I think something like this might be needed to make it correct:</p>
<div class="codehilite"><pre><span></span><code>        // Find all specializations (implemented in coherence/solve)
        // Record them in the forest by adding an edge from the less special
        // to the more special.
        self.visit_specializations_of_trait(|less_special, more_special| {
            let node_impls: Vec&lt;ImplId&lt;_&gt;&gt; = forest.raw_nodes().iter().map(|x| x.weight).collect();

            match (
                node_impls.contains(&amp;less_special),
                node_impls.contains(&amp;more_special),
            ) {
                (true, true) =&gt; {
                    // get an identifier for existing node for less_special
                    // get an identifier for existing node for more_special
                    // make sure there&#39;s an edge connecting them
                }
                (true, false) =&gt; {
                    // get an identifier for existing node for less_special
                    // add node for more_special
                    // make sure there&#39;s an edge connecting them
                }
                (false, true) =&gt; {
                    // add node for less_special
                    // get an identifier for existing node for more_special
                    // make sure there&#39;s an edge connecting them
                }
                (false, false) =&gt; {
                    // add both modes and make edge
                }
            };
        })?;

        Ok(forest)
</code></pre></div>



<a name="265236194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265236194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265236194">(Dec 16 2021 at 23:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232957">Jack Huey</span> <a href="#narrow/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20.28chalk.29/near/265235866">said</a>:</p>
<blockquote>
<p>Try adding <code>disable_coherence;</code> to the test</p>
</blockquote>
<p>will try</p>



<a name="265236432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265236432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265236432">(Dec 16 2021 at 23:48)</a>:</h4>
<p>Previously the code above used a <a href="https://docs.rs/petgraph/latest/petgraph/graphmap/struct.GraphMap.html">GraphMap</a>, which required <code>Ord</code> on the node types. It ensured there weren't duplicates and that edges were added properly. Now that we use <a href="https://docs.rs/petgraph/latest/petgraph/graph/struct.Graph.html">https://docs.rs/petgraph/latest/petgraph/graph/struct.Graph.html</a>, I think we'll need logic like the above to ensure correctness.</p>



<a name="265236446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265236446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265236446">(Dec 16 2021 at 23:48)</a>:</h4>
<p>But I might be wrong/overthinking it....</p>



<a name="265236737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265236737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265236737">(Dec 16 2021 at 23:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="316352">pierwill</span> <a href="#narrow/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20.28chalk.29/near/265236194">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="232957">Jack Huey</span> <a href="#narrow/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20.28chalk.29/near/265235866">said</a>:</p>
<blockquote>
<p>Try adding <code>disable_coherence;</code> to the test</p>
</blockquote>
<p>will try</p>
</blockquote>
<div class="codehilite"><pre><span></span><code>test::unsize::dyn_to_dyn_unsizing still fails with `disable coherence`
</code></pre></div>



<a name="265239402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265239402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265239402">(Dec 17 2021 at 00:26)</a>:</h4>
<p>Right, so the test failure isn't due to the code you linked</p>



<a name="265239447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265239447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265239447">(Dec 17 2021 at 00:26)</a>:</h4>
<p>Its something with the unsizing code I imagine</p>



<a name="265332023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265332023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265332023">(Dec 17 2021 at 17:37)</a>:</h4>
<p>I'm gonna retry doing the work of this PR, see if I can do things a bit more simply</p>



<a name="265834764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId%20%28chalk%29/near/265834764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.20(chalk).html#265834764">(Dec 22 2021 at 18:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="316352">pierwill</span> has marked this topic as unresolved.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>