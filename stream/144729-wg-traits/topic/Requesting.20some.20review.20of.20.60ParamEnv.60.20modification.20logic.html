<html>
<head><meta charset="utf-8"><title>Requesting some review of `ParamEnv` modification logic · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html">Requesting some review of `ParamEnv` modification logic</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265590395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265590395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265590395">(Dec 20 2021 at 17:09)</a>:</h4>
<p>I'd like to request some additional review of the logic I'm adding in PR <a href="https://github.com/rust-lang/rust/pull/92044">https://github.com/rust-lang/rust/pull/92044</a></p>
<p>The idea is: if the predicate we're evaluating doesn't contain any free regions, then any 'purely region-related' bounds in the <code>ParamEnv</code> don't matter. For example, <code>T: MyTrait</code>, <code>for&lt;'a&gt; &amp;'a u8: OtherTrait&lt;'a&gt;</code> do not use any information from a <code>where</code> clause like <code>fn foo&lt;'a, T&gt;() where T: 'a</code></p>
<p>There are two exceptions: bounds like <code>T: 'static</code>, any anything involving higher-ranked lifetime (late-bound regions). For example, we could have <code>fn foo&lt;T: 'static&gt;() {}</code>, and need to evaluate <code>T as MyTrait</code>. If we find an impl like <code>impl&lt;T: 'static&gt; MyTrait for T {}</code>, then it's important that we preserved the <code>T: 'static</code> bound in the <code>ParamEnv</code>.</p>
<p>The other case is late-bound regions. It's possible to write an impossible-to-satisfy <code>where</code> clause like <code>fn foo&lt;'a&gt;(val: &amp;'a bool) where for&lt;'b&gt; &amp;'b u8: 'a </code>. As far as I can tell, you can't actually make use of that <code>where</code> clause in the body of the function, even though you can with an 'impossible-to-satisfy' trait bound. For example, I can copy a <code>Vec&lt;u8&gt;</code> in a function with a bound <code>where Vec&lt;u8&gt;: Copy</code> (this is sound because I can never actually call that function). However, I can't pass a reference to a local variable to a function expecting a <code>&amp;'static</code> reference, no matter what <code>where</code> clause I write.</p>
<p>As a result, my PR always keeps <code>ParamEnv</code> bounds involving late-bound regions, as well as any bound of the form <code>SomeType&lt;'maybe_regions&gt;: 'static</code>. I believe this is sufficient to make my change sound (though it's possibly overly conservatively)</p>



<a name="265590629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265590629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265590629">(Dec 20 2021 at 17:11)</a>:</h4>
<p>However, I'm concerned that I may have missed something. Are there any other ways for a predicate involving no free regions (e.g. <code>SomeType&lt;Vec&lt;u8&gt;&gt;: SomeOtherTrait</code> to depend on <code>RegionOutlives</code> or <code>TypeOutlives</code> predicates from the environment? Could inference variables complicate things?</p>



<a name="265616527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265616527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265616527">(Dec 20 2021 at 21:12)</a>:</h4>
<p>Inference vars would be caught by the <code>is_global</code> check. I don't think we ever have inference vars in a ParamEnv, mostly because I'm not sure how they could end up in there. That would probably break any non-canonical query anyway, so I think we're good?</p>



<a name="265616797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265616797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265616797">(Dec 20 2021 at 21:15)</a>:</h4>
<p>What I'm wondering is whether we could ramp your change up to 11 by substituting early bound lifetimes in ways that allows caching of bounds that include lifetimes of the current environment. But let's stash that idea for a follow up PR</p>



<a name="265616883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265616883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265616883">(Dec 20 2021 at 21:16)</a>:</h4>
<p>Back to inference vars: add a debug assert checking that there are none in the param env</p>



<a name="265618103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265618103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265618103">(Dec 20 2021 at 21:31)</a>:</h4>
<p>You can have inference variables in a ParamEnv - it occurs when you invoke a canonicalized query</p>



<a name="265618148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265618148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265618148">(Dec 20 2021 at 21:31)</a>:</h4>
<p>The query implementation will instantiate the canonicalized input (including the <code>ParamEnv</code>), creating inference variables</p>



<a name="265618206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265618206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265618206">(Dec 20 2021 at 21:32)</a>:</h4>
<p>I didn't realize that until I investigated the perf issue that lead to this PR</p>



<a name="265618272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265618272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265618272">(Dec 20 2021 at 21:33)</a>:</h4>
<p>Also, I'm only checking for free regions, not using <code>is_global</code>. That allows me to still discard bounds for things like <code>T as MyTrait</code></p>



<a name="265618299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265618299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265618299">(Dec 20 2021 at 21:33)</a>:</h4>
<p>which might have some minor perf benefit</p>



<a name="265623249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265623249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265623249">(Dec 20 2021 at 22:26)</a>:</h4>
<p>Ah right, the inside of canonicalized queries</p>



<a name="265623320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265623320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265623320">(Dec 20 2021 at 22:27)</a>:</h4>
<p>You do check if the predicate is global, so the predicate has no inference vars. I wonder if this means that you can throw away any parts of the param env that mention inference vars?</p>



<a name="265625237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265625237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265625237">(Dec 20 2021 at 22:50)</a>:</h4>
<p>Couldn't something end up getting unified with one of the bounds in the ParamEnv?</p>



<a name="265641949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265641949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265641949">(Dec 21 2021 at 02:57)</a>:</h4>
<p>I confused myself early - I check if the <em>predicate</em> is global, and if the <code>ParamEnv</code> has any free regions (so that we avoid re-constructing it if there's nothing to actually discard)</p>



<a name="265736333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265736333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265736333">(Dec 21 2021 at 21:28)</a>:</h4>
<p>I'm now even less confident about this optimization. If we have <code>MyType: ?0</code> in the <code>ParamEnv</code>, what prevents us from unifiying <code>?0 = 'static</code> during evaluation? Couldn't we end up in a situation where that unifications is necessary in order for <code>impl&lt;T: 'static&gt; MyTrait for T {}</code> to successfully match?</p>



<a name="265736516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265736516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265736516">(Dec 21 2021 at 21:31)</a>:</h4>
<p>I think the safest form of this would be to only discard <code>RegionOutlives</code> predicate involving inference variables (and no bound regions) when our predicate has no free regions. Additionally, we can try to make sure that canonicalization doesn't canonicalize <code>'static</code>, so that we can avoid ending up with <code>MyTrait: ?0</code> in our <code>ParamEnv</code> to begin with in more cases</p>



<a name="265737475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265737475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265737475">(Dec 21 2021 at 21:37)</a>:</h4>
<p>Of course, we could have <code>MyType: ?0</code> and <code>?0: ?1</code> in our <code>ParamEnv</code>, and then later unify <code>?0 = 'a</code> and <code>?1 = 'static</code></p>



<a name="265737499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Requesting%20some%20review%20of%20%60ParamEnv%60%20modification%20logic/near/265737499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Requesting.20some.20review.20of.20.60ParamEnv.60.20modification.20logic.html#265737499">(Dec 21 2021 at 21:37)</a>:</h4>
<p>which would allow us to conclude that <code>MyType: 'static</code> ...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>