<html>
<head><meta charset="utf-8"><title>wfness of trait objects · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html">wfness of trait objects</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261137826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261137826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261137826">(Nov 11 2021 at 14:06)</a>:</h4>
<p>I've come across a bunch of weird looking code snippets that compile, I haven't been able to turn any into unsoundness but they all seem really suspicious:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(generic_associated_types)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Foo</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="bp">Self</span>: <span class="nb">Sized</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">_</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="n">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="mi">10_</span><span class="k">u64</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>why is this valid code? <code>dyn Trait</code> is very much not <code>Sized</code> yet the <code>Foo = u32</code> makes it seem like our trait object is sized and has the <code>Foo</code> associated type?</p>
<p>There's other stuff that's weird about wfness of trait objects:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Foo</span>: <span class="nc">OtherTrait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Foo</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">OtherTrait</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">_</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="n">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p><code>u32: otherTrait</code> doesn't hold but this code compiles.</p>
<p>Is it written anywhere what counts as a "valid" trait object? Trying to understand this stuff so that I might be able to look at <code>feature(associated_type_defaults)</code> and how it should add associated type equality bounds for trait objects</p>



<a name="261138629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261138629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261138629">(Nov 11 2021 at 14:14)</a>:</h4>
<p>Can you actually use the associated type or only specify it? If the former, that may be a soundness hole, if the later I don't think it would be unsound.</p>



<a name="261138668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261138668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261138668">(Nov 11 2021 at 14:15)</a>:</h4>
<p>for the gats one I couldnt find a way to actually use the associated type as every use case seemed to require proving the where clause <code>Self: Sized</code></p>



<a name="261138714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261138714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261138714">(Nov 11 2021 at 14:15)</a>:</h4>
<p>and the second code example you cant call <code>foo</code></p>



<a name="261138765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261138765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261138765">(Nov 11 2021 at 14:15)</a>:</h4>
<p>I did try and make unsoundness but couldn't figure it out, doesnt mean there isnt any though</p>



<a name="261138942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261138942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261138942">(Nov 11 2021 at 14:17)</a>:</h4>
<p>I think this is known</p>



<a name="261138990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261138990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261138990">(Nov 11 2021 at 14:17)</a>:</h4>
<p>I looked though <code>I-unsound</code> issues that mentioned trait objects and some stuff did seem kinda similar</p>



<a name="261138995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261138995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261138995">(Nov 11 2021 at 14:17)</a>:</h4>
<p>There are still unanswered questions for <em>when</em> we check associated type wf</p>



<a name="261139324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261139324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261139324">(Nov 11 2021 at 14:20)</a>:</h4>
<p>Looks like you can use the associated type:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">OtherTrait</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Foo</span>: <span class="nc">OtherTrait</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">FOO</span>: <span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Trait</span><span class="o">&lt;</span><span class="n">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Trait</span><span class="o">&gt;</span>::<span class="n">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="261140606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261140606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261140606">(Nov 11 2021 at 14:31)</a>:</h4>
<p>Can you use FOO though?</p>



<a name="261141122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261141122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261141122">(Nov 11 2021 at 14:36)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"> </span><span class="n">FOO</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>yes</p>



<a name="261141163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261141163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261141163">(Nov 11 2021 at 14:36)</a>:</h4>
<p>I couldn't actually find a way to use <code>u32: OtherTrait</code> anywhere though</p>



<a name="261141262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261141262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261141262">(Nov 11 2021 at 14:37)</a>:</h4>
<p>Hmm</p>



<a name="261141453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261141453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261141453">(Nov 11 2021 at 14:39)</a>:</h4>
<p>(perhaps in a world with fancy enough implied bounds this would be more of a problem or soemthing idk)</p>



<a name="261141493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/wfness%20of%20trait%20objects/near/261141493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/wfness.20of.20trait.20objects.html#261141493">(Nov 11 2021 at 14:39)</a>:</h4>
<p>(it doesnt seem unreasonable to turn knowing <code>dyn Trait&lt;Foo = u32&gt;</code> is wf into knowing <code>u32: OtherTrait</code>)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>