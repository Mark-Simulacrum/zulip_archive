<html>
<head><meta charset="utf-8"><title>chalk-parse build is slow · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html">chalk-parse build is slow</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249481414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249481414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jade <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249481414">(Aug 14 2021 at 23:03)</a>:</h4>
<p>On my machine, it takes 20+ seconds to build the chalk parser. I assume this is probably due to the 151k lines of rust that are generated by the parser generator <span aria-label="scared" class="emoji emoji-1f628" role="img" title="scared">:scared:</span></p>
<p>Is there some construct in LALRPop that causes n^2 output blowup somehow?</p>



<a name="249481865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249481865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249481865">(Aug 14 2021 at 23:17)</a>:</h4>
<p>Not exactly sure. The nice thing is that unless you're modifying the parsing, I've generally not had problems</p>



<a name="249481868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249481868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249481868">(Aug 14 2021 at 23:17)</a>:</h4>
<p>But I've also not tried to build since the incremental issues</p>



<a name="249494823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249494823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249494823">(Aug 15 2021 at 05:55)</a>:</h4>
<p>Heh, I was never able to build it</p>



<a name="249499033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249499033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> detrumi <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249499033">(Aug 15 2021 at 08:01)</a>:</h4>
<p>We had a regression <a href="#narrow/stream/144729-wg-traits/topic/chalk.20build.20problem/near/205278059">last year</a>, maybe this is a similar problem?</p>



<a name="249499102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249499102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> detrumi <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249499102">(Aug 15 2021 at 08:03)</a>:</h4>
<p>As for the general slowness, I don't think there's an easy fix apart from rewriting the parser using something else than LALRPOP</p>



<a name="249499239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249499239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249499239">(Aug 15 2021 at 08:06)</a>:</h4>
<p>We never reverted the lalrpop 0.17 -&gt; 0.19 version bump</p>



<a name="249508463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249508463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> detrumi <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249508463">(Aug 15 2021 at 11:51)</a>:</h4>
<p>Timed a few release builds with different lalrpop versions, and both 0.17 and 0.19 are slow. 0.19.6 is slightly faster so we might want to bump, but they're all fairly close</p>



<a name="249519708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249519708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249519708">(Aug 15 2021 at 16:09)</a>:</h4>
<p>What about debug?</p>



<a name="249523487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249523487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249523487">(Aug 15 2021 at 17:47)</a>:</h4>
<p>FWIW, this was an item in the recent Polonius sprint, because of basically the exact same issues with compile times. The existing parser is also an <code>lalrpop</code> grammar. During the sprint I replaced that first with <code>logos</code> plus a hand-written parser, which was somewhat of an improvement in debug, but actually worse in release. So I hand-wrote a lexer as well, which finally improved build times significantly: <a href="https://github.com/rust-lang/polonius/pull/173">https://github.com/rust-lang/polonius/pull/173</a></p>



<a name="249523502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249523502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249523502">(Aug 15 2021 at 17:47)</a>:</h4>
<p>Ofc the chalk parser is significantly larger, so it is probably less feasible to maintain a manual implementation</p>



<a name="249523557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249523557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Domenic Quirl <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249523557">(Aug 15 2021 at 17:49)</a>:</h4>
<p>(but I'm not usually involved here and this thread only caught my eye because the Polonius work literally just happened, so you definitely know best)</p>



<a name="249523563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249523563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249523563">(Aug 15 2021 at 17:49)</a>:</h4>
<p>FWIW, I don't really care about release all that match here. The only time we <em>might</em> use release mode is with standalone Chalk repl. Other than that, we're just using it for tests, which is almost always debug</p>



<a name="249538006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/chalk-parse%20build%20is%20slow/near/249538006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jade <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow.html#249538006">(Aug 16 2021 at 00:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232957">Jack Huey</span> <a href="#narrow/stream/144729-wg-traits/topic/chalk-parse.20build.20is.20slow/near/249481865">said</a>:</p>
<blockquote>
<p>Not exactly sure. The nice thing is that unless you're modifying the parsing, I've generally not had problems</p>
</blockquote>
<p>Yeah, and this is generally only our problem anyway, since I can only see chalk ever needing to use chalk-integration. That said, it is a barrier to contributors with slower computers (the ~20s parser build time is on high end hardware)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>