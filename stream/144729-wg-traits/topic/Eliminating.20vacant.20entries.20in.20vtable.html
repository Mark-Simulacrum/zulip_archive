<html>
<head><meta charset="utf-8"><title>Eliminating vacant entries in vtable · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Eliminating.20vacant.20entries.20in.20vtable.html">Eliminating vacant entries in vtable</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251589052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Eliminating%20vacant%20entries%20in%20vtable/near/251589052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Eliminating.20vacant.20entries.20in.20vtable.html#251589052">(Sep 01 2021 at 16:31)</a>:</h4>
<p>I am trying to get rid of vacant entries in vtable to reduce vtable size. Currently PR <a href="https://github.com/rust-lang/rust/issues/88552">#88552</a> is filed to remove non-object-safe methods from vtable.</p>
<p>During the implementation I noticed about the only other piece of code that creates a vacant entry via <code>impossible_predicates</code>. The comment points me to <a href="https://github.com/rust-lang/rust/issues/23435">#23435</a>, and trying the code now gives a <code>where_clauses_object_safety</code> warning (<a href="https://github.com/rust-lang/rust/issues/51443">#51443</a>). Would this code path ever be exercised after if <a href="https://github.com/rust-lang/rust/issues/51443">#51443</a> is made a hard error?</p>
<p>Also, I am wondering whether it'll be worthwhile to separate the vtable creation into two passes. Instead of going through each <code>PolyTraitRef</code> and create a vtable structure, we should probably first go through determine a fixed vtable shape for each <code>PolyExistentialTraitRef</code> and then instantiate that vtable for each concrete self ty. In that sense we don't need to do ad hoc computation of vtable entry index and count, etc, and the vtable shape of each <code>PolyExistentialTraitRef</code> would be the ground truth that everything else can base on.</p>



<a name="251900860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Eliminating%20vacant%20entries%20in%20vtable/near/251900860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Eliminating.20vacant.20entries.20in.20vtable.html#251900860">(Sep 03 2021 at 15:46)</a>:</h4>
<p>I've updated <a href="https://github.com/rust-lang/rust/issues/88552">#88552</a> to have a <code>own_existential_vtable_entries</code> query that returns the shape of vtable based on <code>PolyExistentialTraitRef</code>, and make it the single source of truth for own vtable entries. Currently I just specify it to return <code>[DefId]</code> because own vtable entries can only be methods. I wonder if I would be better to introduce a new type similar to <code>VtblEntry</code> (I am not sure about what the name would be for such a new type though)? Further more, would it make sense to have <code>existential_vtable_entries</code> query and have <code>vtable_entries</code> call into it and just instantiate all entries?</p>
<p><span class="user-mention" data-user-id="116458">@Charles Lew</span> since you work a lot on these code bases for trait upcasting I am curious about your opinion.</p>



<a name="251908050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Eliminating%20vacant%20entries%20in%20vtable/near/251908050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Eliminating.20vacant.20entries.20in.20vtable.html#251908050">(Sep 03 2021 at 16:34)</a>:</h4>
<p>I think reducing or even completely removing <code>Vacant</code> entry usages is a good thing. </p>
<p>About adding new types and queries to describe the vtable entries though, i wonder if it's possible to replace the current queries instead of adding new ones?</p>



<a name="251910076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Eliminating%20vacant%20entries%20in%20vtable/near/251910076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Eliminating.20vacant.20entries.20in.20vtable.html#251910076">(Sep 03 2021 at 16:50)</a>:</h4>
<p>I'll have a look.</p>



<a name="251910355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Eliminating%20vacant%20entries%20in%20vtable/near/251910355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Eliminating.20vacant.20entries.20in.20vtable.html#251910355">(Sep 03 2021 at 16:52)</a>:</h4>
<p>But we might not yet be ready to repalce current query, since we still need to decide if it an entry is vacant or not based on concrete type, due to <a href="https://github.com/rust-lang/rust/issues/51443">#51443</a>.</p>



<a name="251978331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Eliminating%20vacant%20entries%20in%20vtable/near/251978331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Eliminating.20vacant.20entries.20in.20vtable.html#251978331">(Sep 04 2021 at 06:38)</a>:</h4>
<p>So it seems eliminating vacant entries in vtables is fundamentally impossible(since the concrete type is still participating at the moment), and the plan here would be simply reducing the amount of vacant entries? From user's point of view, this is harder to predict the behavior than before. So maybe instead of inferring from type system, maybe user annotation is actually better? Something like <code>#[rustc_exclude_from_vtable]</code> on trait associated functions.</p>



<a name="252011642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Eliminating%20vacant%20entries%20in%20vtable/near/252011642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Eliminating.20vacant.20entries.20in.20vtable.html#252011642">(Sep 04 2021 at 16:33)</a>:</h4>
<p>No, I don't user should do any annotation. A non-object-safe method should never be included in the vtable. The fact we cannot eliminate vacant entries is just a hint of current state of unsoundness.</p>



<a name="252140352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Eliminating%20vacant%20entries%20in%20vtable/near/252140352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Eliminating.20vacant.20entries.20in.20vtable.html#252140352">(Sep 06 2021 at 08:02)</a>:</h4>
<p>Well, i'm less sure about this aspect. To me vtable is just a piece of metadata designated for trait object values. There's really nothing preventing it from storing data for all associated consts, types, and functions, other than current language rules. I'd imagine rules changing quite soon for async traits etc.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>