<html>
<head><meta charset="utf-8"><title>Why `impl Trait` is allowed *only* in return types? · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Why.20.60impl.20Trait.60.20is.20allowed.20*only*.20in.20return.20types.3F.html">Why `impl Trait` is allowed *only* in return types?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266030253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Why%20%60impl%20Trait%60%20is%20allowed%20%2Aonly%2A%20in%20return%20types%3F/near/266030253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Why.20.60impl.20Trait.60.20is.20allowed.20*only*.20in.20return.20types.3F.html#266030253">(Dec 24 2021 at 23:27)</a>:</h4>
<p>Consider I want to return an async closure with three arguments, the "natural way" to write this would be </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">async_closure</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>But this <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=f02df056a54859627521da81188070a6">doesn't work</a> since the <code>impl Future</code> is not in a return position, but in a associated type position instead:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>error[E0562]: `impl Trait` not allowed outside of function and method return types
 --&gt; src/lib.rs:3:49
  |
3 | fn async_closure() -&gt; impl Fn(i32, i32, i32) -&gt; impl Future&lt;Output = u32&gt; {
  |                                                 ^^^^^^^^^^^^^^^^^^^^^^^^^
</code></pre></div>
<p>And yet, if I declare a trait which is bound by <code>Fn</code>, it's <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=aef51a7b0c1d2dfffe8b3816165c9140">possible</a> to return such closure:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">AsyncFn3</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span>: <span class="nb">Fn</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">&lt;</span><span class="bp">Self</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">AsyncFn3</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;&gt;</span>::<span class="n">Future</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Future</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Out</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">type</span> <span class="nc">Out</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">Fut</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="n">AsyncFn3</span><span class="o">&lt;</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">F</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">F</span>: <span class="nb">Fn</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Fut</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Fut</span>: <span class="nc">Future</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fut</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">type</span> <span class="nc">Out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fut</span>::<span class="n">Output</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">async_closure</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">AsyncFn3</span><span class="o">&lt;</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">Out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">|</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This is a lot of boilerplate though. Why is this boilerplate required? Why <code>impl Trait</code> can't "just" recursively work in RPIT's type parameters/associated types?</p>



<a name="266054397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Why%20%60impl%20Trait%60%20is%20allowed%20%2Aonly%2A%20in%20return%20types%3F/near/266054397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Why.20.60impl.20Trait.60.20is.20allowed.20*only*.20in.20return.20types.3F.html#266054397">(Dec 25 2021 at 11:03)</a>:</h4>
<p>I think that is just out of caution. We just never got around to adding a feature gate for it and continuing the work on it</p>



<a name="268448292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Why%20%60impl%20Trait%60%20is%20allowed%20%2Aonly%2A%20in%20return%20types%3F/near/268448292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Why.20.60impl.20Trait.60.20is.20allowed.20*only*.20in.20return.20types.3F.html#268448292">(Jan 18 2022 at 20:07)</a>:</h4>
<p>I just accidentally noticed (by writing it), that <code>impl A&lt;Assoc = impl B&gt;</code> <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=028fa87156e770043df86c02a95b2436">is allowed</a>, so it seems even more like an overlook</p>



<a name="268533688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Why%20%60impl%20Trait%60%20is%20allowed%20%2Aonly%2A%20in%20return%20types%3F/near/268533688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Why.20.60impl.20Trait.60.20is.20allowed.20*only*.20in.20return.20types.3F.html#268533688">(Jan 19 2022 at 12:51)</a>:</h4>
<p>Another question is why this is not allowed:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">g</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">core</span>::<span class="n">fmt</span>::<span class="n">Debug</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">||</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Isn't <code>fn() -&gt; T</code> ~= <code>struct&lt;T&gt; { ptr: *const (), __: PhantomData&lt;fn() -&gt; T&gt; }</code>? Returning <code>F&lt;impl Trait&gt;</code> <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=959d46057b70b671ea4e5f6b11d3594f">is allowed</a> too</p>



<a name="268542935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Why%20%60impl%20Trait%60%20is%20allowed%20%2Aonly%2A%20in%20return%20types%3F/near/268542935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Why.20.60impl.20Trait.60.20is.20allowed.20*only*.20in.20return.20types.3F.html#268542935">(Jan 19 2022 at 14:00)</a>:</h4>
<p>huh<br>
<a href="/user_uploads/4715/3FZHFU7tQ85k4yy0yCHAYfpb/2022-01-19_17-00.png">2022-01-19_17-00.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/3FZHFU7tQ85k4yy0yCHAYfpb/2022-01-19_17-00.png" title="2022-01-19_17-00.png"><img src="/user_uploads/4715/3FZHFU7tQ85k4yy0yCHAYfpb/2022-01-19_17-00.png"></a></div>



<a name="268543272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Why%20%60impl%20Trait%60%20is%20allowed%20%2Aonly%2A%20in%20return%20types%3F/near/268543272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Why.20.60impl.20Trait.60.20is.20allowed.20*only*.20in.20return.20types.3F.html#268543272">(Jan 19 2022 at 14:03)</a>:</h4>
<p>It's also confusing that <code>lower_fn_decl</code> is used when lowering bare fn types (<code>fn(_) -&gt; _</code>) and not only function <strong>declarations</strong></p>



<a name="268551505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Why%20%60impl%20Trait%60%20is%20allowed%20%2Aonly%2A%20in%20return%20types%3F/near/268551505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Why.20.60impl.20Trait.60.20is.20allowed.20*only*.20in.20return.20types.3F.html#268551505">(Jan 19 2022 at 15:00)</a>:</h4>
<p>The farther I go, the more confusing everything is. There is a test that's supposed to test that <code>impl Fn() -&gt; impl Trait</code> is allowed, but it tests the opposite</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">allowed_in_ret_type</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Into</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="c1">//~^ `impl Trait` not allowed</span>
<span class="w">    </span><span class="o">||</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(note: it starts with <strong>allowed</strong>)<br>
<a href="https://github.com/rust-lang/rust/blob/2f004d2d401682e553af3984ebd9a3976885e752/src/test/ui/impl-trait/nested_impl_trait.rs#L25-L28">https://github.com/rust-lang/rust/blob/2f004d2d401682e553af3984ebd9a3976885e752/src/test/ui/impl-trait/nested_impl_trait.rs#L25-L28</a></p>



<a name="268554137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Why%20%60impl%20Trait%60%20is%20allowed%20%2Aonly%2A%20in%20return%20types%3F/near/268554137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> erikdesjardins <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Why.20.60impl.20Trait.60.20is.20allowed.20*only*.20in.20return.20types.3F.html#268554137">(Jan 19 2022 at 15:18)</a>:</h4>
<p>that test was allowed when it was written; it was disallowed by <a href="https://github.com/rust-lang/rust/pull/48084/files#diff-ccecca938872d65ffe8cd1c3ef1956e309fac83bcda547d8b16b89257e53a437R37">https://github.com/rust-lang/rust/pull/48084/files#diff-ccecca938872d65ffe8cd1c3ef1956e309fac83bcda547d8b16b89257e53a437R37</a></p>



<a name="268554191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Why%20%60impl%20Trait%60%20is%20allowed%20%2Aonly%2A%20in%20return%20types%3F/near/268554191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> erikdesjardins <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Why.20.60impl.20Trait.60.20is.20allowed.20*only*.20in.20return.20types.3F.html#268554191">(Jan 19 2022 at 15:18)</a>:</h4>
<p>seems unintentional given <a href="https://github.com/rust-lang/rust/pull/48084/files#diff-5a02f1ed43debed1fd24f7aad72490064f795b9420f15d847bac822aa4621a1cR476-R477">https://github.com/rust-lang/rust/pull/48084/files#diff-5a02f1ed43debed1fd24f7aad72490064f795b9420f15d847bac822aa4621a1cR476-R477</a></p>
<div class="codehilite"><pre><span></span><code>// `-&gt; Foo` syntax is essentially an associated type binding,
// so it is also allowed to contain nested `impl Trait`.
</code></pre></div>



<a name="268564153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Why%20%60impl%20Trait%60%20is%20allowed%20%2Aonly%2A%20in%20return%20types%3F/near/268564153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Why.20.60impl.20Trait.60.20is.20allowed.20*only*.20in.20return.20types.3F.html#268564153">(Jan 19 2022 at 16:21)</a>:</h4>
<p>I've opened a PR that fixes the <code>Fn() -&gt; impl Trait</code> checks: <a href="https://github.com/rust-lang/rust/pull/93082">https://github.com/rust-lang/rust/pull/93082</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>