<html>
<head><meta charset="utf-8"><title>Removing ordering from DefId · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html">Removing ordering from DefId</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265036876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265036876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265036876">(Dec 15 2021 at 16:37)</a>:</h4>
<p>Hello all! <span aria-label="hello" class="emoji emoji-1f44b" role="img" title="hello">:hello:</span></p>
<p>I'm working on removing ordering traits from <code>DefId</code>. (Part of my current quest, <a href="https://github.com/rust-lang/rust/issues/90317">#90317</a>.)</p>
<p>This work has taken me into chalk, since chalk expects DefIds to be ordered. (See <a href="https://github.com/rust-lang/rust/pull/90749#issuecomment-964699542">https://github.com/rust-lang/rust/pull/90749#issuecomment-964699542</a>)</p>
<p>I've made progress using <code>indexmap</code> in chalk, and have been able to remove the Ord trait almost everywhere. (In fact, I may have removed it from places where I didn't need to/shouldn't have!)</p>
<p>But now I'm hitting a failing test that I don't understand:</p>
<p><a href="https://github.com/rust-lang/chalk/runs/4528345616?check_suite_focus=true#step:6:629">https://github.com/rust-lang/chalk/runs/4528345616?check_suite_focus=true#step:6:629</a></p>
<p>I would love if someone here could take a look. <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span> I'm not sure which of my changes would cause this.</p>



<a name="265037095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037095">(Dec 15 2021 at 16:39)</a>:</h4>
<p>I saw you started that WIP PR</p>



<a name="265037111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037111">(Dec 15 2021 at 16:39)</a>:</h4>
<p>Let me quickly look at that test</p>



<a name="265037132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037132">(Dec 15 2021 at 16:39)</a>:</h4>
<p>Thank you!!!</p>



<a name="265037249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037249">(Dec 15 2021 at 16:40)</a>:</h4>
<p>This code especially might be incorrect: <a href="https://github.com/rust-lang/chalk/pull/739/files#diff-ba814a8e084488bce444bd626693c6c99786b7be83fc1f0f05c51853e0fb96deL108-L118">https://github.com/rust-lang/chalk/pull/739/files#diff-ba814a8e084488bce444bd626693c6c99786b7be83fc1f0f05c51853e0fb96deL108-L118</a></p>



<a name="265037303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037303">(Dec 15 2021 at 16:40)</a>:</h4>
<p>Right, so this is basically just saying that <code>dyn Principal + Auto2 + Auto1 + 'a  == dyn Principal + Auto1 + Auto2 + 'a</code></p>



<a name="265037304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037304">(Dec 15 2021 at 16:40)</a>:</h4>
<p>I might be missing a case where an edge needs to be added...</p>



<a name="265037352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037352">(Dec 15 2021 at 16:41)</a>:</h4>
<p>Not a coherence problem</p>



<a name="265037404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037404">(Dec 15 2021 at 16:41)</a>:</h4>
<p>I have to admit, I don't speak chalk <span aria-label="lol" class="emoji emoji-1f606" role="img" title="lol">:lol:</span></p>



<a name="265037423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037423">(Dec 15 2021 at 16:41)</a>:</h4>
<p>or traits lol</p>



<a name="265037426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037426">(Dec 15 2021 at 16:41)</a>:</h4>
<p>Somewhere I think we sorted the <code>DefId</code> to compare, but we probably need to compare sets instead</p>



<a name="265037566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037566">(Dec 15 2021 at 16:42)</a>:</h4>
<p>Here are the <code>.sort</code>s:</p>
<div class="codehilite"><pre><span></span><code>chalk-integration/src/lowering.rs:450:13:if k.sort != TypeSort::Trait {
tests/display/util.rs:73:8:ids.sort_by_key(|(raw_id, _)| *raw_id);
tests/test/mod.rs:25:19:sorted.sort_by_key(|c| format!(&quot;{:?}&quot;, c));
</code></pre></div>



<a name="265037721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037721">(Dec 15 2021 at 16:43)</a>:</h4>
<p><a href="https://github.com/rust-lang/chalk/pull/739/files#diff-a32055208473b24b6db2049c6967f6e381a6bff8e72cd9440c2bfb5c2715d476L567">https://github.com/rust-lang/chalk/pull/739/files#diff-a32055208473b24b6db2049c6967f6e381a6bff8e72cd9440c2bfb5c2715d476L567</a></p>



<a name="265037767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265037767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265037767">(Dec 15 2021 at 16:44)</a>:</h4>
<p>that's the cause</p>



<a name="265038212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265038212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265038212">(Dec 15 2021 at 16:47)</a>:</h4>
<p>I don't off the top of my head have a good solution here</p>



<a name="265040446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265040446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265040446">(Dec 15 2021 at 17:01)</a>:</h4>
<p>Ahhhh</p>



<a name="265040466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265040466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265040466">(Dec 15 2021 at 17:01)</a>:</h4>
<p>Okay thanks. I'll play around with it....</p>



<a name="265043330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265043330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265043330">(Dec 15 2021 at 17:20)</a>:</h4>
<p><a href="https://github.com/rust-lang/chalk/pull/739/files#diff-a32055208473b24b6db2049c6967f6e381a6bff8e72cd9440c2bfb5c2715d476R545">This</a> (and the related rustc code) should probably use a set instead of a <code>Vec</code> (or a ty::List in the case of rustc)</p>



<a name="265046320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265046320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265046320">(Dec 15 2021 at 17:41)</a>:</h4>
<p>Sorry, which line is that? Github being weird...</p>



<a name="265046533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265046533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265046533">(Dec 15 2021 at 17:42)</a>:</h4>
<div class="codehilite"><pre><span></span><code>impl LowerWithEnv for [QuantifiedInlineBound] {
    type Lowered = Vec&lt;rust_ir::QuantifiedInlineBound&lt;ChalkIr&gt;&gt;;
</code></pre></div>
<p>in <code>lowering..rs</code></p>



<a name="265049216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265049216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265049216">(Dec 15 2021 at 17:59)</a>:</h4>
<p>Weird to get an error like this in the <code>target/</code> dir... what does it mean? </p>
<div class="codehilite"><pre><span></span><code>✗  cargo check
chalk-solve/src/infer/canonicalize.rs:67:5: warning: field is never read: `max_universe`
warning: `chalk-solve` (lib) generated 1 warning
    Checking chalk-parse v0.76.0-dev.0 (/Users/wpierce/repos/chalk/chalk-parse)
error[E0308]: mismatched types
      --&gt; /Users/wpierce/repos/chalk/target/debug/build/chalk-parse-79de8ed817df80fa/out/parser.rs:106167:28
       |
106167 |             where_clauses: w,
       |                            ^ expected struct `IndexSet`, found struct `Vec`
       |
       = note: expected struct `IndexSet&lt;ast::QuantifiedWhereClause&gt;`
                  found struct `Vec&lt;ast::QuantifiedWhereClause&gt;`

For more information about this error, try `rustc --explain E0308`.
error: could not compile `chalk-parse` due to previous error
</code></pre></div>



<a name="265049436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265049436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265049436">(Dec 15 2021 at 18:00)</a>:</h4>
<p>I know what the error means, actually, it's just not very helpful in the target output!</p>



<a name="265049472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265049472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265049472">(Dec 15 2021 at 18:00)</a>:</h4>
<p>It's because of <code>parser.lalrpop</code></p>



<a name="265049490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265049490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265049490">(Dec 15 2021 at 18:00)</a>:</h4>
<p>It generates code</p>



<a name="265049506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265049506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265049506">(Dec 15 2021 at 18:00)</a>:</h4>
<p>ah ok</p>



<a name="265049581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265049581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265049581">(Dec 15 2021 at 18:01)</a>:</h4>
<p>ah might have found the problem...</p>



<a name="265076488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265076488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265076488">(Dec 15 2021 at 21:20)</a>:</h4>
<p>Wow this has become a total mess lol</p>



<a name="265078123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265078123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265078123">(Dec 15 2021 at 21:33)</a>:</h4>
<p>That's okay, that's what reviews are for</p>



<a name="265078356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265078356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265078356">(Dec 15 2021 at 21:35)</a>:</h4>
<p>Seems like no matter what, I'm blocked because of these missing traits for IndexSet:</p>
<p>example output</p>
<div class="codehilite"><pre><span></span><code>chalk-solve/src/rust_ir.rs:633:5: error[E0277]: the trait bound `IndexSet&lt;chalk_ir::Binders&lt;chalk_ir::WhereClause&lt;I&gt;&gt;&gt;: Hash` is not satisfied
chalk-solve/src/rust_ir.rs:626:45: error[E0277]: the trait bound `IndexSet&lt;chalk_ir::Binders&lt;chalk_ir::WhereClause&lt;I&gt;&gt;&gt;: chalk_ir::fold::Fold&lt;I&gt;` is not satisfied
chalk-solve/src/rust_ir.rs:626:64: error[E0277]: the trait bound `IndexSet&lt;chalk_ir::Binders&lt;chalk_ir::WhereClause&lt;I&gt;&gt;&gt;: chalk_ir::visit::Visit&lt;_&gt;` is not satisfied
</code></pre></div>



<a name="265078515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265078515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265078515">(Dec 15 2021 at 21:36)</a>:</h4>
<p>Can you give the full error?</p>



<a name="265078536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265078536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265078536">(Dec 15 2021 at 21:36)</a>:</h4>
<p>i've got so many! one sec</p>



<a name="265078757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265078757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265078757">(Dec 15 2021 at 21:38)</a>:</h4>
<p>maybe it's more useful to see the error on my current commit: </p>
<div class="codehilite"><pre><span></span><code>    Checking chalk-parse v0.76.0-dev.0 (/Users/wpierce/repos/chalk/chalk-parse)
error[E0308]: mismatched types
      --&gt; /Users/wpierce/repos/chalk/target/debug/build/chalk-parse-79de8ed817df80fa/out/parser.rs:107409:5
       |
107407 | ) -&gt; IndexSet&lt;QuantifiedWhereClause&gt;
       |      ------------------------------- expected `IndexSet&lt;ast::QuantifiedWhereClause&gt;` because of return type
107408 | {
107409 |     __0
       |     ^^^ expected struct `IndexSet`, found struct `Vec`
       |
       = note: expected struct `IndexSet&lt;ast::QuantifiedWhereClause&gt;`
                  found struct `Vec&lt;ast::QuantifiedWhereClause&gt;`

For more information about this error, try `rustc --explain E0308`.
error: could not compile `chalk-parse` due to previous error
</code></pre></div>



<a name="265078814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265078814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265078814">(Dec 15 2021 at 21:39)</a>:</h4>
<p>There are plenty of Vec where clauses that could be problems:</p>
<div class="codehilite"><pre><span></span><code>✗  rg &quot;Vec&lt;Quant&quot;
chalk-integration/src/interner.rs:69:43:type InternedQuantifiedWhereClauses = Vec&lt;QuantifiedWhereClause&lt;ChalkIr&gt;&gt;;
chalk-parse/src/ast.rs:180:17:pub bounds: Vec&lt;QuantifiedInlineBound&gt;,
chalk-parse/src/ast.rs:189:17:pub bounds: Vec&lt;QuantifiedInlineBound&gt;,
chalk-parse/src/ast.rs:294:17:bounds: Vec&lt;QuantifiedInlineBound&gt;,
chalk-solve/src/display/bounds.rs:76:39:impl&lt;I: Interner&gt; RenderAsRust&lt;I&gt; for Vec&lt;QuantifiedWhereClause&lt;I&gt;&gt; {
chalk-solve/src/rust_ir.rs:58:24:pub where_clauses: Vec&lt;QuantifiedWhereClause&lt;I&gt;&gt;,
chalk-solve/src/rust_ir.rs:100:24:pub where_clauses: Vec&lt;QuantifiedWhereClause&lt;I&gt;&gt;,
chalk-solve/src/rust_ir.rs:197:24:pub where_clauses: Vec&lt;QuantifiedWhereClause&lt;I&gt;&gt;,
chalk-solve/src/rust_ir.rs:285:45:pub fn where_clauses(&amp;self) -&gt; Binders&lt;&amp;Vec&lt;QuantifiedWhereClause&lt;I&gt;&gt;&gt; {
chalk-solve/src/rust_ir.rs:298:24:pub where_clauses: Vec&lt;QuantifiedWhereClause&lt;I&gt;&gt;,
chalk-solve/src/rust_ir.rs:371:66:fn into_where_clauses(&amp;self, interner: I, self_ty: Ty&lt;I&gt;) -&gt; Vec&lt;QuantifiedWhereClause&lt;I&gt;&gt; {
chalk-solve/src/rust_ir.rs:510:17:pub bounds: Vec&lt;QuantifiedInlineBound&lt;I&gt;&gt;,
chalk-solve/src/rust_ir.rs:513:24:pub where_clauses: Vec&lt;QuantifiedWhereClause&lt;I&gt;&gt;,
chalk-solve/src/rust_ir.rs:525:50:pub fn bounds_on_self(&amp;self, interner: I) -&gt; Vec&lt;QuantifiedWhereClause&lt;I&gt;&gt; {
chalk-solve/src/rust_ir.rs:628:25:pub bounds: Binders&lt;Vec&lt;QuantifiedWhereClause&lt;I&gt;&gt;&gt;,
chalk-solve/src/rust_ir.rs:632:32:pub where_clauses: Binders&lt;Vec&lt;QuantifiedWhereClause&lt;I&gt;&gt;&gt;,
</code></pre></div>



<a name="265078936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265078936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265078936">(Dec 15 2021 at 21:40)</a>:</h4>
<p>But inevitably, types like <code>Binders&lt;&amp;IndexSet&lt;QuantifiedWhereClause&lt;I&gt;&gt;&gt;</code> will complain about <code>Hash</code>, <code>Fold</code>, <code>HasInterner</code>, etc...</p>



<a name="265078983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265078983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265078983">(Dec 15 2021 at 21:40)</a>:</h4>
<p>As in:</p>



<a name="265079046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265079046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265079046">(Dec 15 2021 at 21:41)</a>:</h4>
<div class="codehilite"><pre><span></span><code>    Checking chalk-parse v0.76.0-dev.0 (/Users/wpierce/repos/chalk/chalk-parse)
error[E0277]: the trait bound `IndexSet&lt;chalk_ir::Binders&lt;chalk_ir::WhereClause&lt;I&gt;&gt;&gt;: HasInterner` is not satisfied
    --&gt; chalk-solve/src/rust_ir.rs:286:36
     |
286  |     pub fn where_clauses(&amp;self) -&gt; Binders&lt;&amp;IndexSet&lt;QuantifiedWhereClause&lt;I&gt;&gt;&gt; {
     |                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `HasInterner` is not implemented for `IndexSet&lt;chalk_ir::Binders&lt;chalk_ir::WhereClause&lt;I&gt;&gt;&gt;`
     |
     = note: required because of the requirements on the impl of `HasInterner` for `&amp;IndexSet&lt;chalk_ir::Binders&lt;chalk_ir::WhereClause&lt;I&gt;&gt;&gt;`
note: required by a bound in `chalk_ir::Binders`
    --&gt; /Users/wpierce/repos/chalk/chalk-ir/src/lib.rs:2063:23
     |
2063 | pub struct Binders&lt;T: HasInterner&gt; {
     |                       ^^^^^^^^^^^ required by this bound in `chalk_ir::Binders`

error[E0277]: the trait bound `IndexSet&lt;chalk_ir::Binders&lt;chalk_ir::WhereClause&lt;I&gt;&gt;&gt;: HasInterner` is not satisfied
    --&gt; chalk-solve/src/rust_ir.rs:633:17
     |
633  |     pub bounds: Binders&lt;IndexSet&lt;QuantifiedWhereClause&lt;I&gt;&gt;&gt;,
     |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `HasInterner` is not implemented for `IndexSet&lt;chalk_ir::Binders&lt;chalk_ir::WhereClause&lt;I&gt;&gt;&gt;`
     |
note: required by a bound in `chalk_ir::Binders`
    --&gt; /Users/wpierce/repos/chalk/chalk-ir/src/lib.rs:2063:23
     |
2063 | pub struct Binders&lt;T: HasInterner&gt; {
     |                       ^^^^^^^^^^^ required by this bound in `chalk_ir::Binders`

For more information about this error, try `rustc --explain E0277`.
error: could not compile `chalk-solve` due to 2 previous errors
warning: build failed, waiting for other jobs to finish...
error[E0308]: mismatched types
      --&gt; /Users/wpierce/repos/chalk/target/debug/build/chalk-parse-79de8ed817df80fa/out/parser.rs:107409:5
       |
107407 | ) -&gt; IndexSet&lt;QuantifiedWhereClause&gt;
       |      ------------------------------- expected `IndexSet&lt;ast::QuantifiedWhereClause&gt;` because of return type
107408 | {
107409 |     __0
       |     ^^^ expected struct `IndexSet`, found struct `Vec`
       |
       = note: expected struct `IndexSet&lt;ast::QuantifiedWhereClause&gt;`
                  found struct `Vec&lt;ast::QuantifiedWhereClause&gt;`

For more information about this error, try `rustc --explain E0308`.
error: build failed
</code></pre></div>



<a name="265079116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265079116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265079116">(Dec 15 2021 at 21:42)</a>:</h4>
<p>looking</p>



<a name="265079508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265079508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265079508">(Dec 15 2021 at 21:44)</a>:</h4>
<p>Can you upload <code>/Users/wpierce/repos/chalk/target/debug/build/chalk-parse-79de8ed817df80fa/out/parser.rs</code> somewhere?</p>



<a name="265079584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265079584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265079584">(Dec 15 2021 at 21:44)</a>:</h4>
<p>sure one sec</p>



<a name="265079618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265079618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265079618">(Dec 15 2021 at 21:44)</a>:</h4>
<p>well, I guess you're getting that error locally too, right</p>



<a name="265079665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265079665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265079665">(Dec 15 2021 at 21:44)</a>:</h4>
<p>yep</p>



<a name="265079786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265079786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265079786">(Dec 15 2021 at 21:44)</a>:</h4>
<p><a href="/user_uploads/4715/TP6zUzQdqMwcJnw1-d6b6Q3b/parser.rs">parser.rs</a></p>



<a name="265080377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265080377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265080377">(Dec 15 2021 at 21:48)</a>:</h4>
<p>It's because of <a href="https://github.com/rust-lang/chalk/blob/a8525b6514cb3a00f3bed0fa8cc4833b6915aa2d/chalk-parse/src/parser.lalrpop#L669">https://github.com/rust-lang/chalk/blob/a8525b6514cb3a00f3bed0fa8cc4833b6915aa2d/chalk-parse/src/parser.lalrpop#L669</a></p>



<a name="265080426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265080426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265080426">(Dec 15 2021 at 21:48)</a>:</h4>
<p><span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>



<a name="265080484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265080484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265080484">(Dec 15 2021 at 21:49)</a>:</h4>
<p>And here: <a href="https://github.com/rust-lang/chalk/blob/a8525b6514cb3a00f3bed0fa8cc4833b6915aa2d/chalk-parse/src/parser.lalrpop#L603">https://github.com/rust-lang/chalk/blob/a8525b6514cb3a00f3bed0fa8cc4833b6915aa2d/chalk-parse/src/parser.lalrpop#L603</a></p>



<a name="265080538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265080538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265080538">(Dec 15 2021 at 21:49)</a>:</h4>
<p>I recommend not changing anything in parser.lalrpop, and only do the Vec -&gt; IndexSet conversion during lowering</p>



<a name="265080649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265080649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265080649">(Dec 15 2021 at 21:50)</a>:</h4>
<p>Hm.. okay I'll try that</p>



<a name="265082677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265082677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265082677">(Dec 15 2021 at 22:05)</a>:</h4>
<blockquote>
<p>only do the Vec -&gt; IndexSet conversion during lowering</p>
</blockquote>
<p>As in, covert at runtime? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="265082830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265082830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265082830">(Dec 15 2021 at 22:07)</a>:</h4>
<p>well...I mean it's all at runtime</p>



<a name="265082896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265082896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265082896">(Dec 15 2021 at 22:07)</a>:</h4>
<p>ah okay. you're saying to limit my changes to <code>chalk-integration/src/lowering/</code>?</p>



<a name="265082962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265082962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265082962">(Dec 15 2021 at 22:08)</a>:</h4>
<p>yes</p>



<a name="265082966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265082966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265082966">(Dec 15 2021 at 22:08)</a>:</h4>
<p>trying to get an exact line number</p>



<a name="265082982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265082982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265082982">(Dec 15 2021 at 22:08)</a>:</h4>
<p>so i'll need to do things like this huh:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code>                         let binders = empty_env.in_binders(variable_kinds, |env| {
<span class="gi">+                            let v1 = assoc_ty_defn.bounds.lower(&amp;env);</span>
<span class="gi">+                            let v2 = assoc_ty_defn.where_clauses.lower(&amp;env);</span>
                             Ok(rust_ir::AssociatedTyDatumBound {
<span class="gd">-                                bounds: assoc_ty_defn.bounds.lower(&amp;env)?,</span>
<span class="gd">-                                where_clauses: assoc_ty_defn.where_clauses.lower(&amp;env)?,</span>
<span class="gi">+                                bounds: IndexSet::from(v1),</span>
<span class="gi">+                                where_clauses: IndexSet::from(v2),</span>
</code></pre></div>



<a name="265083049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265083049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265083049">(Dec 15 2021 at 22:09)</a>:</h4>
<p>Yes</p>



<a name="265083071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265083071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265083071">(Dec 15 2021 at 22:09)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="265088677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265088677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265088677">(Dec 15 2021 at 23:01)</a>:</h4>
<p>I though this would do it, but now another test is failing... <a href="https://github.com/rust-lang/chalk/pull/739">https://github.com/rust-lang/chalk/pull/739</a></p>



<a name="265088717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265088717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265088717">(Dec 15 2021 at 23:01)</a>:</h4>
<div class="codehilite"><pre><span></span><code>failures:

---- lowering::duplicate_parameters stdout ----
thread &#39;lowering::duplicate_parameters&#39; panicked at &#39;called `Result::unwrap_err()` on an `Ok` value: Program { adt_ids: {}, adt_kinds: {}, adt_variances: {}, fn_def_ids: {}, fn_def_kinds: {}, fn_def_variances: {}, closure_ids: {}, closure_upvars: {}, closure_kinds: {}, generator_ids: {}, generator_kinds: {}, generator_data: {}, generator_witness_data: {}, trait_ids: {Atom(&#39;Foo&#39; type=inline): TraitId(#0)}, trait_kinds: {TraitId(#0): TypeKind { sort: Trait, name: Atom(&#39;Foo&#39; type=inline), binders: for[type, type] Unit }}, adt_data: {}, adt_reprs: {}, fn_def_data: {}, closure_inputs_and_output: {}, closure_closure_kind: {}, impl_data: {}, associated_ty_values: {}, opaque_ty_ids: {}, opaque_ty_kinds: {}, opaque_ty_data: {}, hidden_opaque_types: {}, trait_data: {TraitId(#0): TraitDatum { id: TraitId(#0), binders: for[type, type] TraitDatumBound { where_clauses: [] }, flags: TraitFlags { auto: false, marker: false, upstream: false, fundamental: false, non_enumerable: false, coinductive: false }, associated_ty_ids: [], well_known: None }}, well_known_traits: {}, associated_ty_data: {}, custom_clauses: [], object_safe_traits: {}, foreign_ty_ids: {} }&#39;, tests/lowering/mod.rs:400:5

---- test::unsize::dyn_to_dyn_unsizing stdout ----
program {
    #[lang(unsize)] trait Unsize &lt; T &gt; {} #[object_safe] trait Principal {}
    #[object_safe] trait OtherPrincipal {} #[object_safe] trait
    GenericPrincipal &lt; T &gt; { type Item ; } #[auto] #[object_safe] trait Auto1
    {} #[auto] #[object_safe] trait Auto2 {} #[auto] #[object_safe] trait
    Auto3 {}
}
----------------------------------------------------------------------
goal {
    forall &lt; &#39;a &gt;
    { forall &lt; &#39;b &gt; { dyn Principal + &#39;a : Unsize &lt; dyn Principal + &#39;b &gt; } }
}
using solver: SLG { max_size: 10, expected_answers: None }
expected:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!2_0 }]
actual:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!2_0 }]
----------------------------------------------------------------------
goal {
    forall &lt; &#39;a &gt;
    { forall &lt; &#39;b &gt; { dyn Principal + &#39;a : Unsize &lt; dyn Principal + &#39;b &gt; } }
}
using solver: Recursive { overflow_depth: 100, caching_enabled: true, max_size: 30 }
expected:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!2_0 }]
actual:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!2_0 }]
----------------------------------------------------------------------
goal {
    forall &lt; &#39;a &gt;
    {
        forall &lt; &#39;b &gt;
        {
            dyn Principal + Auto1 + Auto2 + Auto3 + &#39;a : Unsize &lt; dyn
            Principal + Auto1 + Auto2 + Auto3 + &#39;b &gt;
        }
    }
}
using solver: SLG { max_size: 10, expected_answers: None }
expected:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!2_0 }]
actual:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!2_0 }]
----------------------------------------------------------------------
goal {
    forall &lt; &#39;a &gt;
    {
        forall &lt; &#39;b &gt;
        {
            dyn Principal + Auto1 + Auto2 + Auto3 + &#39;a : Unsize &lt; dyn
            Principal + Auto1 + Auto2 + Auto3 + &#39;b &gt;
        }
    }
}
using solver: Recursive { overflow_depth: 100, caching_enabled: true, max_size: 30 }
expected:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!2_0 }]
actual:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!2_0 }]
----------------------------------------------------------------------
goal {
    forall &lt; &#39;a &gt;
    {
        dyn Principal + Auto1 + Auto2 + &#39;a : Unsize &lt; dyn Principal + Auto1 +
        &#39;a &gt;
    }
}
using solver: SLG { max_size: 10, expected_answers: None }
expected:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
actual:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
----------------------------------------------------------------------
goal {
    forall &lt; &#39;a &gt;
    {
        dyn Principal + Auto1 + Auto2 + &#39;a : Unsize &lt; dyn Principal + Auto1 +
        &#39;a &gt;
    }
}
using solver: Recursive { overflow_depth: 100, caching_enabled: true, max_size: 30 }
expected:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
actual:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
----------------------------------------------------------------------
goal {
    forall &lt; &#39;a &gt;
    { dyn Auto1 + Principal + &#39;a : Unsize &lt; dyn Auto1 + Principal + &#39;a &gt; }
}
using solver: SLG { max_size: 10, expected_answers: None }
expected:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
actual:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
----------------------------------------------------------------------
goal {
    forall &lt; &#39;a &gt;
    { dyn Auto1 + Principal + &#39;a : Unsize &lt; dyn Auto1 + Principal + &#39;a &gt; }
}
using solver: Recursive { overflow_depth: 100, caching_enabled: true, max_size: 30 }
expected:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
actual:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
----------------------------------------------------------------------
goal {
    forall &lt; &#39;a &gt;
    { dyn Principal + Auto1 + &#39;a : Unsize &lt; dyn Auto1 + Principal + &#39;a &gt; }
}
using solver: SLG { max_size: 10, expected_answers: None }
expected:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
actual:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
----------------------------------------------------------------------
goal {
    forall &lt; &#39;a &gt;
    { dyn Principal + Auto1 + &#39;a : Unsize &lt; dyn Auto1 + Principal + &#39;a &gt; }
}
using solver: Recursive { overflow_depth: 100, caching_enabled: true, max_size: 30 }
expected:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
actual:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
----------------------------------------------------------------------
goal {
    forall &lt; &#39;a &gt;
    {
        dyn Principal + Auto2 + Auto1 + &#39;a : Unsize &lt; dyn Principal + Auto1 +
        Auto2 + &#39;a &gt;
    }
}
using solver: SLG { max_size: 10, expected_answers: None }
expected:
Unique; substitution [], lifetime constraints [InEnvironment { environment: Env([]), goal: &#39;!1_0: &#39;!1_0 }]
actual:
No possible solution
thread &#39;test::unsize::dyn_to_dyn_unsizing&#39; panicked at &#39;assertion failed: `(left == right)`

Diff &lt; left / right &gt; :
&lt;&quot;Unique;substitution[],lifetimeconstraints[InEnvironment{environment:Env([]),goal:&#39;!1_0:&#39;!1_0}]&quot;
&gt;&quot;Nopossiblesolution&quot;

&#39;, tests/test_util.rs:52:9


failures:
    lowering::duplicate_parameters
    test::unsize::dyn_to_dyn_unsizing

test result: FAILED. 501 passed; 2 failed; 7 ignored; 0 measured; 0 filtered out; finished in 16.94s

error: test failed, to rerun pass &#39;--test lib&#39;
</code></pre></div>



<a name="265092597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265092597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265092597">(Dec 15 2021 at 23:39)</a>:</h4>
<p>looking</p>



<a name="265092677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265092677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265092677">(Dec 15 2021 at 23:40)</a>:</h4>
<p>wait CI fails with</p>
<div class="codehilite"><pre><span></span><code>error[E0277]: the trait bound `chalk_parse::ast::QuantifiedInlineBound: Hash` is not satisfied
   --&gt; chalk-integration/src/lowering.rs:580:36
    |
580 |                 auto_traits.insert((b, id));
    |                             ------ ^^^^^^^ the trait `Hash` is not implemented for `chalk_parse::ast::QuantifiedInlineBound`
    |                             |
    |                             required by a bound introduced by this call
    |
    = note: required because of the requirements on the impl of `Hash` for `&amp;chalk_parse::ast::QuantifiedInlineBound`
    = note: 1 redundant requirement hidden
    = note: required because of the requirements on the impl of `Hash` for `(&amp;chalk_parse::ast::QuantifiedInlineBound, TraitId&lt;ChalkIr&gt;)`

error[E0277]: the trait bound `chalk_parse::ast::QuantifiedInlineBound: Hash` is not satisfied
   --&gt; chalk-integration/src/lowering.rs:582:39
    |
582 |                 regular_traits.insert((b, id));
    |                                ------ ^^^^^^^ the trait `Hash` is not implemented for `chalk_parse::ast::QuantifiedInlineBound`
    |                                |
    |                                required by a bound introduced by this call
    |
    = note: required because of the requirements on the impl of `Hash` for `&amp;chalk_parse::ast::QuantifiedInlineBound`
    = note: 1 redundant requirement hidden
    = note: required because of the requirements on the impl of `Hash` for `(&amp;chalk_parse::ast::QuantifiedInlineBound, TraitId&lt;ChalkIr&gt;)`
</code></pre></div>



<a name="265093652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265093652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265093652">(Dec 15 2021 at 23:50)</a>:</h4>
<p>I think I fixed the original problem we talked about, here: <a href="https://github.com/pierwill/chalk/blob/14f731920abbff5f4c25f40f3b37983743fbdef5/chalk-integration/src/lowering.rs#L576-L592">https://github.com/pierwill/chalk/blob/14f731920abbff5f4c25f40f3b37983743fbdef5/chalk-integration/src/lowering.rs#L576-L592</a></p>



<a name="265093698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265093698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265093698">(Dec 15 2021 at 23:51)</a>:</h4>
<p>But tests still fail</p>



<a name="265093724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265093724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265093724">(Dec 15 2021 at 23:51)</a>:</h4>
<p><a href="https://github.com/rust-lang/chalk/runs/4541259589?check_suite_focus=true#step:6:590">https://github.com/rust-lang/chalk/runs/4541259589?check_suite_focus=true#step:6:590</a></p>



<a name="265094078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265094078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265094078">(Dec 15 2021 at 23:54)</a>:</h4>
<p>hmm</p>



<a name="265094090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265094090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265094090">(Dec 15 2021 at 23:54)</a>:</h4>
<p>I'll have to check later</p>



<a name="265111071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265111071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265111071">(Dec 16 2021 at 04:23)</a>:</h4>
<p>Btw <span class="user-mention" data-user-id="316352">@pierwill</span> <a href="https://github.com/rust-lang/chalk/blob/977b0a5e3aec60cc70c1ef3783b68ad506e57c04/chalk-solve/src/clauses/builtin_traits/unsize.rs#L210">this</a> is probably where that test is having problems, for whatever reason</p>



<a name="265111149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Removing%20ordering%20from%20DefId/near/265111149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Removing.20ordering.20from.20DefId.html#265111149">(Dec 16 2021 at 04:25)</a>:</h4>
<p>I'm just a tad confused because you don't modify that in your PR...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>