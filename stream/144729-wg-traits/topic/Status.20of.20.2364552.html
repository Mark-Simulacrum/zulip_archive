<html>
<head><meta charset="utf-8"><title>Status of #64552 · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html">Status of #64552</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="277979197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/277979197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sgk <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#277979197">(Apr 06 2022 at 06:09)</a>:</h4>
<p>What's the status of <a href="https://github.com/rust-lang/rust/issues/64552">https://github.com/rust-lang/rust/issues/64552</a>?  I see <a href="https://github.com/rust-lang/rust/pull/92449">https://github.com/rust-lang/rust/pull/92449</a> mentions it (but doesn't fix it). If I want to have a try on fixing <a href="https://github.com/rust-lang/rust/issues/64552">#64552</a>, should I wait <a href="https://github.com/rust-lang/rust/issues/92449">#92449</a> merged first?</p>



<a name="277981990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/277981990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#277981990">(Apr 06 2022 at 06:57)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/92449">#92449</a> is kinda stalled, though the issue <a href="https://github.com/rust-lang/rust/issues/64552">#64552</a> and related issues with auto traits and generators are very difficult to fix it seems, at least with the way that we currently have typeck and borrowck set up</p>



<a name="277982008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/277982008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#277982008">(Apr 06 2022 at 06:57)</a>:</h4>
<p>if you do want to take a stab at it, feel free to ask me questions</p>



<a name="278002800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278002800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sgk <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278002800">(Apr 06 2022 at 10:17)</a>:</h4>
<p>Yes. I want to at least have a proper picture of how hard this is or what's problem really is. Then I will try to fix this.<br>
Which part of the coded should I look into first?  I believe this mostly related to mir and typeck?</p>



<a name="278002934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278002934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sgk <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278002934">(Apr 06 2022 at 10:19)</a>:</h4>
<p>And should I follow your work in <a href="https://github.com/rust-lang/rust/issues/92449">#92449</a>?</p>



<a name="278078730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278078730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278078730">(Apr 06 2022 at 20:05)</a>:</h4>
<p>no, I don't think <a href="https://github.com/rust-lang/rust/issues/92449">#92449</a> is really worth salvaging at this point, at least not without a really dramatic redesign</p>



<a name="278078995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278078995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278078995">(Apr 06 2022 at 20:07)</a>:</h4>
<p>so the "future is not send due to generators" issue is actually a class of several issues</p>



<a name="278079015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278079015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278079015">(Apr 06 2022 at 20:07)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/64552">#64552</a> specifically is pretty difficult member of that class, because the generator needs to prove that one of its internal members, specifically the iterator type of <code>BTreeMap</code>, is <code>Send</code></p>



<a name="278079154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278079154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278079154">(Apr 06 2022 at 20:08)</a>:</h4>
<p>however, that means proving that one of the internal members of BTreeMap is Send as well, specifically <a href="https://github.com/rust-lang/rust/blob/master/library/alloc/src/collections/btree/node.rs#L209-213"><code>NodeRef</code></a></p>



<a name="278079282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278079282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278079282">(Apr 06 2022 at 20:09)</a>:</h4>
<p>but to prove that <code>Send</code> bound, we need to prove an outlives constraint on the key and value types, but we just don't have enough information to prove that outlives constraint when all the lifetimes are erased</p>



<a name="278079632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278079632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278079632">(Apr 06 2022 at 20:12)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/92449">#92449</a> tries to stash the outlives predicates that we know in the generator, and then add them to the param-env that we use to prove that the generator is <code>Send</code></p>



<a name="278080034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278080034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278080034">(Apr 06 2022 at 20:15)</a>:</h4>
<p>but (as far as i can tell) we can't infer it from the structure of the btreemap itself, and don't need to prove it anywhere else in our function body so we know nothing about the lifetime relationship between the <code>K</code> and <code>V</code> args of the btreemap and the NodeRef...</p>



<a name="278080087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278080087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278080087">(Apr 06 2022 at 20:15)</a>:</h4>
<p>this is all speculation and recollection, i wrote that PR a few months ago when I knew far less about the compiler</p>



<a name="278080379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278080379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278080379">(Apr 06 2022 at 20:17)</a>:</h4>
<p>but the root cause of all of these issues is that we erase the lifetimes of the generator-interior elements <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/generator_interior.rs#L213-220">so we can't prove anything about the lifetime relationships</a> of the contents of the generators, but we _need_ information about the lifetime relationships of the contents of the generator, at least in this case, to prove that the generator is <code>Send</code></p>



<a name="278139204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Status%20of%20%2364552/near/278139204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sgk <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Status.20of.20.2364552.html#278139204">(Apr 07 2022 at 09:45)</a>:</h4>
<p>Thank you for the info. I will look into this for a bit before giving some more thoughts about it. I'm still not that familiar with rustc code.<br>
From what I see, my intuition is that, <code>NodeRef</code> impl <code>Send</code> base on some bound related to lifetime, but generator-interior erased all lifetime info (to <code>'alpha</code> it seems). Result is the <code>Send</code> bound is not satisfied. To fix this, we should store lifetime info somewhere.<br>
What I don't get is why are we erasing lifetime info in the first place?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>