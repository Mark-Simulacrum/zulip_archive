<html>
<head><meta charset="utf-8"><title>Self-update syntax and HKT via GATs · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html">Self-update syntax and HKT via GATs</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249419826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249419826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249419826">(Aug 13 2021 at 22:05)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Functor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">type</span> <span class="nc">Self</span>: <span class="nc">Functor</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">type</span> <span class="nc">Item</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">fn</span> <span class="nf">map</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">F</span>: <span class="nb">Fn</span><span class="p">(</span><span class="bp">Self</span>::<span class="n">Item</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="bp">Self</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">=</span><span class="n">U</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249419866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249419866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249419866">(Aug 13 2021 at 22:05)</a>:</h4>
<p>That looks about right</p>



<a name="249420114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249420114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249420114">(Aug 13 2021 at 22:08)</a>:</h4>
<p>My apologies- it appears renaming a topic breaks it apart. I can try to rename it back? I turned it into <a class="stream-topic" data-stream-id="144729" href="/#narrow/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs">#wg-traits &gt; Self-update syntax and HKT via GATs</a></p>



<a name="249420204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249420204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249420204">(Aug 13 2021 at 22:09)</a>:</h4>
<p>I think I can fix</p>



<a name="249420400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249420400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249420400">(Aug 13 2021 at 22:11)</a>:</h4>
<p><span class="user-mention" data-user-id="398288">@Zoey</span> any thoughts on the above</p>



<a name="249420461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249420461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249420461">(Aug 13 2021 at 22:12)</a>:</h4>
<p>Interestingly, there's actually no GATs</p>



<a name="249420725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249420725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249420725">(Aug 13 2021 at 22:14)</a>:</h4>
<p>I feel like <code>Self::New</code> may be more conceptually appropriate naming in this case, but that isn't reserved. Is <code>Self::Self</code> currently illegal?</p>
<p><code>Self::Self</code> feels redundant to me, and it makes the syntax for supertrait updates even more verbose and potentially confusing: <code>&lt;Self as MySuperTrait&gt;::Self&lt;overrides...&gt;</code></p>
<p>Also, I realize now that GATs are not strictly necessary to resolve this if it's a built-in, but - without GATs - the actual associated type, whatever its name, cannot actually be represented in Rust without GATs, so - without them - it becomes more than a syntactic sugar.</p>



<a name="249420965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249420965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249420965">(Aug 13 2021 at 22:17)</a>:</h4>
<p>(deleted)</p>



<a name="249421018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249421018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249421018">(Aug 13 2021 at 22:18)</a>:</h4>
<p>Hmm, I don't think this can be represented with GATs</p>



<a name="249421032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249421032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249421032">(Aug 13 2021 at 22:18)</a>:</h4>
<p>And I was only using the Self associated type about a point for "desugaring"</p>



<a name="249421063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249421063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249421063">(Aug 13 2021 at 22:19)</a>:</h4>
<p>I think just the <code>Self&lt;Item=U&gt;</code> sugar is "better"</p>



<a name="249429316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249429316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249429316">(Aug 14 2021 at 00:43)</a>:</h4>
<p>I’ve only skimmed the discussion but you might be interested in looking at my own attempt at encoding Monads in Rust a while ago:</p>
<p><a href="https://users.rust-lang.org/t/monads-in-rust-with-gats/50487">https://users.rust-lang.org/t/monads-in-rust-with-gats/50487</a></p>
<p>(make sure to click the playground link for the details; and perhaps ignore the stuff around <code>Clone1</code> if you want to focus on the <code>Monad</code> side of things)</p>



<a name="249429481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249429481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249429481">(Aug 14 2021 at 00:47)</a>:</h4>
<p>In particular, it contains some approaches to make sure that nonsensical implementations that change around the types aren’t allowed. You implement <code>Monad</code> on a dummy type that acts as a stand-in for the type constructor (that type implements <code>TyCon</code>, then you <del>can</del> <em>have to</em> link that dummy type to the actual type with another trait (<code>HasTyCon</code>) but that trait has constraints that the type constructor applied to the right parameter <em>must</em> indeed create the right type again.</p>



<a name="249429749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249429749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249429749">(Aug 14 2021 at 00:53)</a>:</h4>
<p>Then, you can get method syntax and IIRC halfways decent interaction with type inference…</p>
<p>I think from my short exploration there, it’s also clear that it’s not trivial how best to address Rust’s ownership model for functional traits like <code>Monad</code> and <del>polymorphic</del> generic functions involving them.</p>



<a name="249432958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249432958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249432958">(Aug 14 2021 at 02:01)</a>:</h4>
<p>Hello <span class="user-mention" data-user-id="280891">@Frank Steffahn</span> !<br>
I just read through and played with your implementation for a while; it seems to have the same fundamental limitations as my <code>Id</code> trait mechanism in the opening post:</p>
<ul>
<li>Only one type can be passed to the type constructor, so multi-parameter typeclasses are still unavailable without variadic generics support </li>
<li>The implementation can lie- in this case, <code>TyCon</code> itself is the point where a lie may occur.</li>
</ul>
<p>I see these additional disadvantages:</p>
<ul>
<li>Significant boilerplate, macro invocations required for concise usage at the implementations rather than just the definitions</li>
<li>Passing around actual values as witnesses- probably not a runtime concern, as they're ZSTs, but it complicates things significantly</li>
</ul>
<p>And this possible advantage:</p>
<ul>
<li>MonadVal indicates a potential hole in my evaluation for typeclass categories - I was primarily considering immutable semantics, not mutation</li>
<li><code>do</code> computations - I'm not sure how my style would work with these- and I'm curious if we can convert this behaviour - not to the Id trait - but to a <code>Self</code>-update syntax backing</li>
</ul>



<a name="249436850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249436850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249436850">(Aug 14 2021 at 03:13)</a>:</h4>
<p>This was my implementation a while ago:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">FunctorFamily</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">fmap</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span>: <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">ApplicativeFamily</span>: <span class="nc">FunctorFamily</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">pure</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inner</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">apply</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span>: <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">MonadFamily</span>: <span class="nc">ApplicativeFamily</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">bind</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span>: <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">OptionType</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">FunctorFamily</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">OptionType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">fmap</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span>: <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">value</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">ApplicativeFamily</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">OptionType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">pure</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">inner</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">apply</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span>: <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">value</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">f</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">MonadFamily</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">OptionType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">bind</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span>: <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">value</span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249436856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249436856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249436856">(Aug 14 2021 at 03:13)</a>:</h4>
<p>I'm not sure whether this link is usable, but the whole post is here: <a href="https://zhuanlan.zhihu.com/p/369302538">https://zhuanlan.zhihu.com/p/369302538</a></p>



<a name="249437228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249437228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249437228">(Aug 14 2021 at 03:18)</a>:</h4>
<p>This implementation exhibits the unlawful implementation issue and the enforcement falls down to the implementation rather than the definition.</p>
<p>I will say it's pretty concise for what was available prior to GATs, at least. I believe they are an incremental improvement, followed by the proposed Self-update syntax.</p>



<a name="249438532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438532">(Aug 14 2021 at 03:46)</a>:</h4>
<p>By "unlawful implementation" did you mean the implementation of, say "bind" is not correct in principle, or did you mean the function signatures could be incorrect? If the later, I can't see how...</p>



<a name="249438614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438614">(Aug 14 2021 at 03:48)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">FunctorFamily</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">OptionType</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">fmap</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span>: <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Type</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">U</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">value</span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">"UwU"</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Edit:<br>
Oh wait- I see! The type being bound there prevents it but now we're talking about results the whole time. Okay, how do you propose passing around the OptionType type; what does an invocation site look like?</p>



<a name="249438621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438621">(Aug 14 2021 at 03:49)</a>:</h4>
<p>I think a big question that should be answered here: <em>why</em> are implementations like this discouraged?</p>



<a name="249438626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438626">(Aug 14 2021 at 03:49)</a>:</h4>
<p>Sure, then <code>OptionType</code> corresponds to <code>Result</code> despite its name. I think this is not incorrect?</p>



<a name="249438714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438714">(Aug 14 2021 at 03:50)</a>:</h4>
<p>In current rust, it will be  <code>OptionType::fmap(..., ...)</code>, but this might be covered by <code>arbitrary-self-types</code> in the future, if it's worth it, i think?</p>



<a name="249438723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438723">(Aug 14 2021 at 03:51)</a>:</h4>
<p>Arbitrary self types are hard</p>



<a name="249438727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438727">(Aug 14 2021 at 03:51)</a>:</h4>
<p>Indeed!</p>



<a name="249438731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438731">(Aug 14 2021 at 03:51)</a>:</h4>
<p>I wouldn't bet on something like this working</p>



<a name="249438737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438737">(Aug 14 2021 at 03:51)</a>:</h4>
<p>(For arbitrary self types)</p>



<a name="249438785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438785">(Aug 14 2021 at 03:52)</a>:</h4>
<p>But, I could be wrong</p>



<a name="249438801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438801">(Aug 14 2021 at 03:53)</a>:</h4>
<p>I think a benefit of this approach compared to <code>Id</code> is that you don't have to match the self type with the associated type</p>



<a name="249438803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438803">(Aug 14 2021 at 03:53)</a>:</h4>
<blockquote>
<p>Sure, then OptionType corresponds to Result despite its name</p>
</blockquote>
<p>Responded inline with an edit; kept my prior example up for clarification of my mistake in understanding.</p>
<p><span class="user-mention silent" data-user-id="232957">Jack Huey</span> <a href="#narrow/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs/near/249438621">said</a>:</p>
<blockquote>
<p>I think a big question that should be answered here: <em>why</em> are implementations like this discouraged?</p>
</blockquote>
<p>Because they describe a morphism between one category and another- but that is fundamentally not an endomorphism, leading to this not being a Functor.</p>
<p>This is legally representable via another syntax in the above proposal, but doesn't allow the illegal implementations to "lie".</p>
<p>The reason this matters:<br>
Sometimes you want to act on a Functor of Functors- but if you can't guarantee they are returning the same type they currently are, you can't actually operate on their contents abstractly. We end up back in the area of specialization, and lose out on the benefits of defining categories.</p>



<a name="249438861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438861">(Aug 14 2021 at 03:55)</a>:</h4>
<p>I think I would try to pinpoint more exact code requirements</p>



<a name="249438961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438961">(Aug 14 2021 at 03:56)</a>:</h4>
<p>I ... Am unclear where the requirements are not clear? This allows enforcing an invariant which is currently unenforceable, and reduces boilerplate in the process.</p>



<a name="249438978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249438978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249438978">(Aug 14 2021 at 03:57)</a>:</h4>
<p>You'll have to forgive me, I'm not super familiar with Haskell or a lot of functional terminology (though I have some basic understanding).</p>
<p>I would steer away from making "this isn't exactly what a Functor is" and more so "when you allow what should be a Functor trait to return a different self type, this is no longer possible"</p>



<a name="249439053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249439053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249439053">(Aug 14 2021 at 03:59)</a>:</h4>
<p>I personally think Rust generally discourages highly-abstracted API designs without strong motivation. Maybe that's because that will make crate API documentations quite hard to write :) </p>
<p>All type-system expressiveness here serves for API design, i think:)</p>



<a name="249439166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249439166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249439166">(Aug 14 2021 at 04:00)</a>:</h4>
<p>Fundamentally, if you define a typeclass, you don't want people to be able to accidentally lie in the implementation. If categories cannot be soundly represented, you cannot use categories. This is fundamentally _why_ we have to implement .iter() separately for every type.</p>
<blockquote>
<p>Maybe that's because that will make crate API documentations quite hard to write :) </p>
</blockquote>
<p>Allowing dishonesty in implementations limits reuse and composition, and requires documentation to clarify exactly when/how/why that is done, or conventions to encourage not doing them (which will sometimes be disobeyed and need documented).</p>
<p>As for code which demonstrates why this matters, see <code>mapM/traverse</code> in this article, which shows the limitation's implications: <a href="https://www.fpcomplete.com/blog/monads-gats-nightly-rust/#mapm-traverse">https://www.fpcomplete.com/blog/monads-gats-nightly-rust/#mapm-traverse</a></p>



<a name="249439176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249439176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249439176">(Aug 14 2021 at 04:01)</a>:</h4>
<p>For example, at the trait level, how does creating the invariant that the Self type doesn't change affect usage? It's not like the trait would know what that concrete type would be. And if you need certain functionality, you could have trait bounds on the associated type.</p>



<a name="249439396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249439396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249439396">(Aug 14 2021 at 04:06)</a>:</h4>
<p>I'll have to look more into the article tomorrow. I see there's a snippet of code that doesn't compile. I think it would be helpful to see what it would look like with the Self-change update syntax. (And presumably show that it <em>would</em> compile)</p>



<a name="249439459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249439459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249439459">(Aug 14 2021 at 04:07)</a>:</h4>
<p>I will attempt to represent all of his code using my <code>Id</code> trait, which was designed to prove that invariant specifically for his example, then - with it compiling - rewrite it into Self-update syntax.</p>
<p>In the meantime, I've also linked the author of that article to this thread. Maybe he'll be able to word the importance of this invariant.</p>



<a name="249439516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249439516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249439516">(Aug 14 2021 at 04:08)</a>:</h4>
<p>Well, I mean, the big thing I'd like to see is what is possible with Self-update syntax but not <code>Id</code></p>



<a name="249439541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249439541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249439541">(Aug 14 2021 at 04:09)</a>:</h4>
<p>Bifunctor is not possible with <code>Id</code>, and <code>Id</code> cannot be trusted because it requires manual implementation (and is therein technically <code>unsafe impl</code> but not in memory terms).</p>
<p>I will write that up and show some attempted workarounds using Variadic Generics, but those are also not available.</p>



<a name="249439647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249439647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249439647">(Aug 14 2021 at 04:11)</a>:</h4>
<p>Generally i think type families is a very useful pattern :)  If you always project from a single family representative type like <code>OptionType</code> above, the result can always be trusted.</p>



<a name="249439691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249439691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249439691">(Aug 14 2021 at 04:12)</a>:</h4>
<p>Yes, what about to ask about that design</p>



<a name="249439694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249439694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249439694">(Aug 14 2021 at 04:12)</a>:</h4>
<p>I can definitely see the pros and cons of the different approaches. Just trying to flesh them out a bit :)</p>



<a name="249439697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249439697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249439697">(Aug 14 2021 at 04:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116458">Charles Lew</span> <a href="#narrow/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs/near/249439647">said</a>:</p>
<blockquote>
<p>Generally i think type families is a very useful pattern :)  If you always project from a single family representative type like <code>OptionType</code> above, the result can always be trusted.</p>
</blockquote>
<p>Families are not compositional (Composable?)- you can't derive TypeFamily for Option without knowing it's an Option concretely.</p>
<p>In some sense, this is the higher-order logic difference between "methods" and "trait methods", or "functions" and "typeclasses". Imagine if you needed to concretely say which trait implementation you were talking about in order to use traits (instead of being able to use them generically).</p>



<a name="249440320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249440320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249440320">(Aug 14 2021 at 04:28)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">TypeEq</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TypeEq</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">type</span> <span class="nc">New</span><span class="o">&lt;</span><span class="n">Ego</span><span class="o">&gt;</span>: <span class="nc">TypeEq</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249440337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249440337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249440337">(Aug 14 2021 at 04:29)</a>:</h4>
<p>I ... don't really know how well this will work. Maybe it will mean you'll repeat the obvious where bound a lot, at many different places.</p>



<a name="249440343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249440343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249440343">(Aug 14 2021 at 04:29)</a>:</h4>
<p>But in principle this will give you the bound you want, i think?</p>



<a name="249440344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249440344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249440344">(Aug 14 2021 at 04:29)</a>:</h4>
<p>That doesn't allow reaching "into" the type, so you have to rely on type families again. It's close, though. I think this is fundamentally unrepresentable in current rust without the chance of illegal implementations.</p>



<a name="249440574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249440574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249440574">(Aug 14 2021 at 04:35)</a>:</h4>
<p>Did you mean something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="k">type</span> <span class="nc">New</span><span class="o">&lt;</span><span class="n">Ego</span><span class="o">&gt;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">Ego</span>: <span class="nc">TypeEq</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249441008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249441008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249441008">(Aug 14 2021 at 04:45)</a>:</h4>
<p>Neither of these appear to enforce that the <code>Id</code> implementation is truthful- and... <code>Ego</code> is the contents, not the <code>Self</code> type. It strictly must not be limited to only the current type- as it is how we bridge to other types in the same family.</p>



<a name="249447790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249447790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249447790">(Aug 14 2021 at 08:02)</a>:</h4>
<p><span class="user-mention" data-user-id="398288">@Zoey</span> <a href="https://meet.jit.si/683914435248316">Click to join video call</a></p>
<p><span class="user-mention silent" data-user-id="398288">Zoey</span> <a href="#narrow/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs/near/249432958">said</a>:</p>
<blockquote>
<p>I see these additional disadvantages:</p>
<ul>
<li>Significant boilerplate, macro invocations required for concise usage at the implementations rather than just the definitions</li>
<li>Passing around actual values as witnesses- probably not a runtime concern, as they're ZSTs, but it complicates things significantly</li>
</ul>
</blockquote>
<p>While the usage of the macro or its expansion is not strictly necessary (one could use <code>M::Of&lt;T&gt;</code> for the arguments), the approach with the generic <code>impl HasTyCon</code> arguments allows for functions to be called without explicitly specifying the <code>M</code> type argument. Otherwise, the boilerplate is real, yeah. </p>
<p>There are no values passed around of types like <code>Vec_</code>, in fact using an uninhabited type like <code>enum Vec_ {}</code> works, too.</p>



<a name="249447988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Self-update%20syntax%20and%20HKT%20via%20GATs/near/249447988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Self-update.20syntax.20and.20HKT.20via.20GATs.html#249447988">(Aug 14 2021 at 08:08)</a>:</h4>
<p><span class="user-mention" data-user-id="116458">@Charles Lew</span> I've worked with a</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">TypeEqual</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">To</span>: <span class="o">?</span><span class="nb">Sized</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TypeEqual</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">To</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>a few times which more strictly enforce the types involved being equal in a way that (with some boilerplate overhead) can actually be used to somewhat gain back the knowledge that the types are actually equal. (If you want to see an example of what that means, ask me, I can give more details later.)</p>
<p>The bound to use it is <code>T: TypeEqual&lt;To=U&gt;</code> in order to state that <code>T == U</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>