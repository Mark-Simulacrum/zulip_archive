<html>
<head><meta charset="utf-8"><title>Infinite recursion in `infer::opaque_types::fold_opaque_ty` · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html">Infinite recursion in `infer::opaque_types::fold_opaque_ty`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275899039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/275899039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#275899039">(Mar 19 2022 at 08:57)</a>:</h4>
<p>I was adding tests for <a href="https://github.com/rust-lang/rust/pull/93582"><code>impl Fn() -&gt; impl Trait</code> PR</a> and I've found a segfault on this function:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">f</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="k">impl</span><span class="w"> </span><span class="n">Debug</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Upon further investigation I've found an infinite recursion in <code>rustc_infer::infer::opaque_types::fold_opaque_ty</code>:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>┐rustc_infer::infer::opaque_types::fold_opaque_ty ty=impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]), opaque_type_key=OpaqueTypeKey { def_id: DefId(0:7 ~ impl_fn_associativity2[4a39]::f::{opaque#0}), substs: [] }, origin=FnReturn(DefId(0:6 ~ impl_fn_associativity2[4a39]::f))
├─0ms DEBUG rustc_infer::infer::type_variable new_var(index=_#0t, universe=U0, origin=TypeVariableOrigin { kind: TypeInference, span: src/test/ui/impl-trait/impl_fn_associativity2.rs:10:11: 10:55 (#0) })
├─0ms DEBUG rustc_infer::infer::opaque_types generated new type inference var Infer(_#0t)
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]) as std::marker::Sized&gt;, polarity:Positive), [])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]) as std::marker::Sized&gt;, polarity:Positive), [])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;_ as std::marker::Sized&gt;, polarity:Positive), [])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;_ as std::marker::Sized&gt;, polarity:Positive), [])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]) as std::ops::Fn&lt;(&amp;'a u8,)&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]) as std::ops::Fn&lt;(&amp;'a u8,)&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;_ as std::ops::Fn&lt;(&amp;'a u8,)&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;_ as std::ops::Fn&lt;(&amp;'a u8,)&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]), (&amp;'a u8,)], item_def_id: DefId(2:3286 ~ core[5484]::ops::function::FnOnce::Output) }, Ty(impl std::fmt::Debug)), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]), (&amp;'a u8,)], item_def_id: DefId(2:3286 ~ core[5484]::ops::function::FnOnce::Output) }, Ty(impl std::fmt::Debug)), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─┐rustc_infer::infer::opaque_types::fold_opaque_ty ty=impl std::fmt::Debug, opaque_type_key=OpaqueTypeKey { def_id: DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), substs: [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })] }, origin=FnReturn(DefId(0:6 ~ impl_fn_associativity2[4a39]::f))
│ ├─0ms DEBUG rustc_infer::infer::type_variable new_var(index=_#1t, universe=U0, origin=TypeVariableOrigin { kind: TypeInference, span: src/test/ui/impl-trait/impl_fn_associativity2.rs:10:11: 10:55 (#0) })
│ ├─0ms DEBUG rustc_infer::infer::opaque_types generated new type inference var Infer(_#1t)
│ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
│ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
│ ├─┐rustc_infer::infer::opaque_types::fold_opaque_ty ty=impl std::fmt::Debug, opaque_type_key=OpaqueTypeKey { def_id: DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), substs: [ReLateBound(DebruijnIndex(1), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })] }, origin=FnReturn(DefId(0:6 ~ impl_fn_associativity2[4a39]::f))
│ │ ├─0ms DEBUG rustc_infer::infer::type_variable new_var(index=_#2t, universe=U0, origin=TypeVariableOrigin { kind: TypeInference, span: src/test/ui/impl-trait/impl_fn_associativity2.rs:10:11: 10:55 (#0) })
│ │ ├─0ms DEBUG rustc_infer::infer::opaque_types generated new type inference var Infer(_#2t)
│ │ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
│ │ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
│ │ ├─┐rustc_infer::infer::opaque_types::fold_opaque_ty ty=impl std::fmt::Debug, opaque_type_key=OpaqueTypeKey { def_id: DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), substs: [ReLateBound(DebruijnIndex(2), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })] }, origin=FnReturn(DefId(0:6 ~ impl_fn_associativity2[4a39]::f))
│ │ │ ├─0ms DEBUG rustc_infer::infer::type_variable new_var(index=_#3t, universe=U0, origin=TypeVariableOrigin { kind: TypeInference, span: src/test/ui/impl-trait/impl_fn_associativity2.rs:10:11: 10:55 (#0) })
│ │ │ ├─0ms DEBUG rustc_infer::infer::opaque_types generated new type inference var Infer(_#3t)
│ │ │ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
│ │ │ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
...
</code></pre></div>



<a name="275899263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/275899263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#275899263">(Mar 19 2022 at 09:01)</a>:</h4>
<p>Any ideas why this might happen?</p>



<a name="275907503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/275907503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#275907503">(Mar 19 2022 at 12:12)</a>:</h4>
<p>It seems like recursion happens somewhere here: <a href="https://github.com/rust-lang/rust/blob/feac2ecf1cae1dd0f56bed1cecc6e109c64b3d4f/compiler/rustc_infer/src/infer/opaque_types.rs#L552-L585">https://github.com/rust-lang/rust/blob/feac2ecf1cae1dd0f56bed1cecc6e109c64b3d4f/compiler/rustc_infer/src/infer/opaque_types.rs#L552-L585</a></p>



<a name="275961397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/275961397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#275961397">(Mar 20 2022 at 11:05)</a>:</h4>
<p>Probably fixed by lazy type alias impl trait as that removes all these recursive ops</p>



<a name="275961452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/275961452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#275961452">(Mar 20 2022 at 11:06)</a>:</h4>
<p>I can add your test to my PR</p>



<a name="276015172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/276015172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#276015172">(Mar 21 2022 at 07:49)</a>:</h4>
<p>This only ICEs when allowing <code>impl Debug</code> in that position, so adding this to your PR won't do anything, I think</p>



<a name="276024337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/276024337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#276024337">(Mar 21 2022 at 09:31)</a>:</h4>
<p>I thought it segfaults due to stack overflow due to infinite recursion? This recursion is removed in my PR. We may run into other issues of course, but at least the segfault should be gone</p>



<a name="276040778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/276040778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#276040778">(Mar 21 2022 at 12:13)</a>:</h4>
<p>Yeah, but without my PR it isn't accepted while parsing, so type check doesn't even start with it :D</p>



<a name="276068245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/276068245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#276068245">(Mar 21 2022 at 15:27)</a>:</h4>
<p>Aaah xD</p>



<a name="276068349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/276068349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#276068349">(Mar 21 2022 at 15:28)</a>:</h4>
<p>Yea, I guess you need to wait until after my PR or mark the test as known-bug</p>



<a name="277328283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277328283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277328283">(Mar 31 2022 at 19:22)</a>:</h4>
<p>lazy taits fixed the overflow, yay!</p>
<p>Though I now get another ICE :D</p>



<a name="277328549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277328549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277328549">(Mar 31 2022 at 19:25)</a>:</h4>
<p>Heh, yea, unexplored territory</p>



<a name="277328654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277328654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277328654">(Mar 31 2022 at 19:26)</a>:</h4>
<p>Got any details?</p>



<a name="277329152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277329152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277329152">(Mar 31 2022 at 19:31)</a>:</h4>
<p>I get <code>escaping bound vars in predicate Obligation(predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), []), depth=0)</code></p>



<a name="277329331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277329331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277329331">(Mar 31 2022 at 19:32)</a>:</h4>
<p>Here is the traceback that annoyingly doesn't fit in a message:</p>
<p><a href="/user_uploads/4715/_QTd3nt81iA97nTV88-QLZDy/traceback.txt">traceback.txt</a></p>



<a name="277330405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277330405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277330405">(Mar 31 2022 at 19:42)</a>:</h4>
<p>oic how it is... twitter gets this info first <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="277330510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277330510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277330510">(Mar 31 2022 at 19:43)</a>:</h4>
<p>I guess we had that ice coming... we played dangerously with binders and got bitten</p>



<a name="277330628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277330628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277330628">(Mar 31 2022 at 19:44)</a>:</h4>
<p>Should be a bottom up folder close to where the recursion segfault was before. Same file as <code>handle_opaque_type</code></p>



<a name="277330684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277330684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277330684">(Mar 31 2022 at 19:45)</a>:</h4>
<p>That folder is not handing binders and replacing types without considering binders</p>



<a name="277330784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277330784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277330784">(Mar 31 2022 at 19:46)</a>:</h4>
<p>No clue what the fix is, but that guess could make tracing dumps easier to read</p>



<a name="277331337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277331337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277331337">(Mar 31 2022 at 19:51)</a>:</h4>
<p>So, quick analysis: the 'a is not shown in the error message, but it's there. The binder has no bound lifetimes tho. That's causing the ice. This obligation is coming from the return type projection on the outer opaque type. Which incidentally has a match arm in the BottomUpFolder...</p>



<a name="277331469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277331469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277331469">(Mar 31 2022 at 19:52)</a>:</h4>
<p>On mobile, so can't look at code, but I think I remember some binder shenanigans in the function called to generate the projection obligation</p>



<a name="277332523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277332523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277332523">(Mar 31 2022 at 20:01)</a>:</h4>
<p>Thanks, I'll try to investigate this :)</p>



<a name="277736816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277736816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277736816">(Apr 04 2022 at 14:15)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> I've found a new ICE that works on nightly!</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Tr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Tr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">g</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Tr</span><span class="o">&lt;&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Debug</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>error: internal compiler error: compiler/rustc_trait_selection/src/opaque_types.rs:157:17: unexpected region kind in opaque type: RePlaceholder(Placeholder { universe: U2, name: BrNamed(DefId(0:11 ~ playground[302b]::g::{opaque#0}::'a), 'a) })

thread 'rustc' panicked at 'Box&lt;dyn Any&gt;', compiler/rustc_errors/src/lib.rs:1279:9
</code></pre></div>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=2045d01c52c448330fba40b524b2ff50">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=2045d01c52c448330fba40b524b2ff50</a></p>



<a name="277737096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277737096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277737096">(Apr 04 2022 at 14:17)</a>:</h4>
<p>Weirdly enough <code>type Output = ();</code> works fine</p>



<a name="277737173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277737173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277737173">(Apr 04 2022 at 14:17)</a>:</h4>
<p><span aria-label="see no evil" class="emoji emoji-1f648" role="img" title="see no evil">:see_no_evil:</span></p>



<a name="277737189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277737189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277737189">(Apr 04 2022 at 14:18)</a>:</h4>
<p>yea, the problem is the projection</p>



<a name="277737433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277737433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277737433">(Apr 04 2022 at 14:19)</a>:</h4>
<p>we convert this to <code>__hidden_type__: for&lt;'a&gt; Tr&lt;&amp;'a u8&gt;</code> and <code>&lt;__hidden_type__ as for&lt;'a&gt; Tr&lt;&amp;'a u8&gt;&gt;::Output == ...</code>, and the <code>...</code> part is where we muck up the binders</p>



<a name="277737638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277737638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277737638">(Apr 04 2022 at 14:20)</a>:</h4>
<p>something something <a href="https://github.com/rust-lang/rust/blob/ffaf6f0d0ccfbc76da00baded073d10f05ffcbd1/compiler/rustc_infer/src/infer/opaque_types.rs#L567">https://github.com/rust-lang/rust/blob/ffaf6f0d0ccfbc76da00baded073d10f05ffcbd1/compiler/rustc_infer/src/infer/opaque_types.rs#L567</a> is hacky</p>



<a name="277738037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277738037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277738037">(Apr 04 2022 at 14:23)</a>:</h4>
<p>Should I open an issue or something?</p>



<a name="277738109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277738109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277738109">(Apr 04 2022 at 14:23)</a>:</h4>
<p>yea, tracking this is good, even if I'm not sure we'll try to do anything about it any time soon</p>



<a name="277738220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277738220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277738220">(Apr 04 2022 at 14:24)</a>:</h4>
<p>:(</p>



<a name="277739020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277739020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277739020">(Apr 04 2022 at 14:30)</a>:</h4>
<p>(if it is blocking your work, that's another story)</p>



<a name="277739133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277739133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277739133">(Apr 04 2022 at 14:30)</a>:</h4>
<p>oh, this is the minification of your issue</p>



<a name="277739150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277739150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277739150">(Apr 04 2022 at 14:30)</a>:</h4>
<p>ok, time to bump the priority</p>



<a name="277739204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277739204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277739204">(Apr 04 2022 at 14:31)</a>:</h4>
<p>was <code>&lt;type as for&lt;'a&gt; Trait&lt;'a&gt;&gt;::Assoc</code> a typo or is the binder really there <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span></p>



<a name="277739256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277739256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277739256">(Apr 04 2022 at 14:31)</a>:</h4>
<p><code>T as for&lt;'a&gt; Trait&lt;'a&gt;</code> makes no sense right? lol</p>



<a name="277739336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277739336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277739336">(Apr 04 2022 at 14:32)</a>:</h4>
<p>It actually seems like these are a bit distinct issues (at least the ICE message is different), but I'm not sure</p>



<a name="277739479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277739479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277739479">(Apr 04 2022 at 14:33)</a>:</h4>
<p>But yeah, I've got there trying to understand what is special here about <code>Fn</code></p>



<a name="277741115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277741115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277741115">(Apr 04 2022 at 14:44)</a>:</h4>
<p>Opened an issue: <a href="https://github.com/rust-lang/rust/issues/95647">https://github.com/rust-lang/rust/issues/95647</a></p>



<a name="277741897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277741897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277741897">(Apr 04 2022 at 14:49)</a>:</h4>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>thread 'rustc' panicked at 'assertion failed: self.scc_universes[scc] == ty::UniverseIndex::ROOT', compiler/rustc_borrowck/src/region_infer/mod.rs:708:9
</code></pre></div>
<p>AND ANOTHER ONE</p>



<a name="277742250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277742250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277742250">(Apr 04 2022 at 14:51)</a>:</h4>
<p><span aria-label="scream" class="emoji emoji-1f631" role="img" title="scream">:scream:</span></p>



<a name="277742291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277742291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277742291">(Apr 04 2022 at 14:51)</a>:</h4>
<p>no wonder I never got this code, it has been broken forever</p>



<a name="277755935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277755935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277755935">(Apr 04 2022 at 16:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60/near/277737433">said</a>:</p>
<blockquote>
<p>we convert this to <code>__hidden_type__: for&lt;'a&gt; Tr&lt;&amp;'a u8&gt;</code> and <code>&lt;__hidden_type__ as for&lt;'a&gt; Tr&lt;&amp;'a u8&gt;&gt;::Output == ...</code>, and the <code>...</code> part is where we muck up the binders</p>
</blockquote>
<p>ugh, there's a bug in FnPtr confirmation in <a href="https://github.com/rust-lang/rust/issues/95421">#95421</a> that looks almost the same way, in we have <code>for&lt;'b&gt; &lt;for&lt;'a&gt; fn(&amp;'a ()) -&gt; &amp;'a () as Fn(&amp;'b ())&gt;::Output = &amp;'b ()</code></p>



<a name="277756057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277756057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277756057">(Apr 04 2022 at 16:20)</a>:</h4>
<p>confusing to have binders on predicates, then also have binders that are inherent to a Ty (and sometimes selection uses the binder inherent to the ty, and throws away the outer binder...)</p>



<a name="277756184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277756184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277756184">(Apr 04 2022 at 16:21)</a>:</h4>
<p>I'll take a look at <a href="https://github.com/rust-lang/rust/issues/95647">#95647</a> after work, if only to write up an explanation why we're getting a bound region to point to the wrong thing...</p>



<a name="277759331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277759331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277759331">(Apr 04 2022 at 16:41)</a>:</h4>
<p>(I renamed the thread and now there are two threads :( )</p>



<a name="277762024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277762024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277762024">(Apr 04 2022 at 16:59)</a>:</h4>
<p>zulip bug? i only see one thread (this one) in wg-traits</p>



<a name="277762556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277762556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277762556">(Apr 04 2022 at 17:02)</a>:</h4>
<p>uhhh, maybe <a href="/user_uploads/4715/iKWO-eGbfswJ4KY5U3Z5Jy0_/2022-04-04_21-02.png">2022-04-04_21-02.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/iKWO-eGbfswJ4KY5U3Z5Jy0_/2022-04-04_21-02.png" title="2022-04-04_21-02.png"><img src="/user_uploads/4715/iKWO-eGbfswJ4KY5U3Z5Jy0_/2022-04-04_21-02.png"></a></div>



<a name="277762684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277762684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277762684">(Apr 04 2022 at 17:02)</a>:</h4>
<p><span aria-label="surprise" class="emoji emoji-1f62e" role="img" title="surprise">:surprise:</span> I don't even see that  new one (or is "new ices" the old one?) <a href="/user_uploads/4715/htiIUh3gZQ5iiNTYpxd0n3k7/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/htiIUh3gZQ5iiNTYpxd0n3k7/image.png" title="image.png"><img src="/user_uploads/4715/htiIUh3gZQ5iiNTYpxd0n3k7/image.png"></a></div>



<a name="277762777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/Infinite%20recursion%20in%20%60infer%3A%3Aopaque_types%3A%3Afold_opaque_ty%60/near/277762777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/Infinite.20recursion.20in.20.60infer.3A.3Aopaque_types.3A.3Afold_opaque_ty.60.html#277762777">(Apr 04 2022 at 17:03)</a>:</h4>
<p>oh nvm I see it when I expand the full topic list...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>