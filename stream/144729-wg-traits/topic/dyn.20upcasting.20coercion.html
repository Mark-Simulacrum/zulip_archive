<html>
<head><meta charset="utf-8"><title>dyn upcasting coercion · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html">dyn upcasting coercion</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250619460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250619460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250619460">(Aug 25 2021 at 13:27)</a>:</h4>
<p>( I think we should probably make a spin-off, or adapt that template, for initiatives, it isn't <em>quite</em> right )</p>



<a name="250619662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250619662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250619662">(Aug 25 2021 at 13:28)</a>:</h4>
<p><a href="https://github.com/nikomatsakis/dyn-upcasting-coercion-initiative">https://github.com/nikomatsakis/dyn-upcasting-coercion-initiative</a></p>



<a name="250620441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250620441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250620441">(Aug 25 2021 at 13:34)</a>:</h4>
<p>Oh i tried to rename this stream but seems i failed...</p>



<a name="250621508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250621508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250621508">(Aug 25 2021 at 13:43)</a>:</h4>
<p>I've accepted the invitation. Now i'll update the repo.</p>



<a name="250630279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250630279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250630279">(Aug 25 2021 at 14:45)</a>:</h4>
<p>We have safe <code>self: *const Self</code> trait methods (with <code>#[feature(arbitrary_self_types)]</code>) so metadata must always be valid anyways, right?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(arbitrary_self_types)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="bp">Self</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">fn</span> <span class="nf">bar</span><span class="p">(</span><span class="n">x</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Foo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">foo</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="250631103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250631103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250631103">(Aug 25 2021 at 14:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116458">Charles Lew</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion/near/250616737">said</a>:</p>
<blockquote>
<ol>
<li>Announce that every fat pointer needs to have valid metadata part.<br>
    Needs to switch the <code>std::ptr::from_raw_parts{,_mut}</code> APIs to be unsafe.<br>
    And updates other documentations.</li>
</ol>
</blockquote>
<p>I don’t fully understand why <code>from_raw_parts</code> would need to be unsafe. I thought there’s no way of creating an invalid <code>DynMetadata&lt;dyn Trait&gt;</code>.</p>



<a name="250632517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250632517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250632517">(Aug 25 2021 at 15:01)</a>:</h4>
<p>We can already simulate the <code>*const dyn _</code>-upcasting in a <code>Bar: Foo</code> hierarchy with arbitrary-self-types alone, e.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(arbitrary_self_types)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">FooUpcast</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">foo_upcast</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="bp">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">(</span><span class="k">dyn</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="bp">Self</span>: <span class="o">'</span><span class="na">a</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Foo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">FooUpcast</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">foo_upcast</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="bp">self</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="bp">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">(</span><span class="k">dyn</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="bp">Self</span>: <span class="o">'</span><span class="na">a</span> <span class="p">{</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Foo</span>: <span class="nc">FooUpcast</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">some_foo_method</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Bar</span>: <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">some_bar_method</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">demo</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Bar</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ptr</span><span class="p">.</span><span class="n">foo_upcast</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">S</span><span class="p">;</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">some_foo_method</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Bar</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">some_bar_method</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">demo2</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">null</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Bar</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">z</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">.</span><span class="n">foo_upcast</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="250641660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250641660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250641660">(Aug 25 2021 at 16:12)</a>:</h4>
<p>So <span class="user-mention" data-user-id="116458">@Charles Lew</span> feel free to push (or open a PR) to extend the design questions etc, but in particular I'd appreciate review/and-or edits of <a href="https://github.com/nikomatsakis/dyn-upcasting-coercion-initiative/blob/master/design-questions/upcast-safety.md">this page</a></p>



<a name="250641713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250641713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250641713">(Aug 25 2021 at 16:12)</a>:</h4>
<p>Repo link: <a href="https://github.com/nikomatsakis/dyn-upcasting-coercion-initiative">https://github.com/nikomatsakis/dyn-upcasting-coercion-initiative</a></p>



<a name="250642402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250642402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250642402">(Aug 25 2021 at 16:17)</a>:</h4>
<p>Giving it a brief read, i think it's a lot better written than mine version :)  I've written the a first version of the vtable page, but i need to add the original alternatives.</p>



<a name="250643545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250643545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250643545">(Aug 25 2021 at 16:25)</a>:</h4>
<p><span class="user-mention" data-user-id="280891">@Frank Steffahn</span> pointed out that there's no safe way to create an "incompatible" trait object metadata to be used by <code>from_raw_parts</code>. I think they're correct.</p>



<a name="250652774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250652774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250652774">(Aug 25 2021 at 17:33)</a>:</h4>
<p>Created <a href="https://github.com/nikomatsakis/dyn-upcasting-coercion-initiative/pull/1/">https://github.com/nikomatsakis/dyn-upcasting-coercion-initiative/pull/1/</a></p>



<a name="250658563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/250658563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#250658563">(Aug 25 2021 at 18:14)</a>:</h4>
<p>merged</p>



<a name="251037919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251037919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251037919">(Aug 28 2021 at 07:51)</a>:</h4>
<p>Posted my experience report at <a href="https://github.com/rust-lang/dyn-upcasting-coercion-initiative/issues/2">https://github.com/rust-lang/dyn-upcasting-coercion-initiative/issues/2</a></p>



<a name="251039582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251039582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251039582">(Aug 28 2021 at 08:23)</a>:</h4>
<p>Another at <a href="https://github.com/rust-lang/dyn-upcasting-coercion-initiative/issues/3">https://github.com/rust-lang/dyn-upcasting-coercion-initiative/issues/3</a></p>



<a name="251240278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251240278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251240278">(Aug 30 2021 at 14:45)</a>:</h4>
<p>awesome!</p>



<a name="251485862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251485862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251485862">(Sep 01 2021 at 01:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116458">Charles Lew</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion/near/250616610">said</a>:</p>
<blockquote>
<p>However, there's one remaining issue related-to raw pointers.<br>
<code>fn foo(v: *const dyn Foo) -&gt; * const dyn Bar { v }</code></p>
<p>currently compiles. If v is arbitrarily created using<br>
<code>std::ptr::from_raw_parts</code>(an unstable safe API), <code>foo</code> can cause UB when it tries to read the vtable contents(with multiple inheritance).</p>
</blockquote>
<p>is that true? when I checked the std::ptr metadata APIs, they were actually careful about "hiding" vtables in a way that you could not make up the vtable ptr. Or did I miss something?</p>



<a name="251485946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251485946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251485946">(Sep 01 2021 at 01:18)</a>:</h4>
<p>specifically, the <code>Metadata</code> associated type is <a href="https://doc.rust-lang.org/nightly/std/ptr/struct.DynMetadata.html">https://doc.rust-lang.org/nightly/std/ptr/struct.DynMetadata.html</a> when the unsized tail is a dyn Trait</p>



<a name="251485952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251485952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251485952">(Sep 01 2021 at 01:18)</a>:</h4>
<p>(still catching up with this thread)</p>



<a name="251486094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251486094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251486094">(Sep 01 2021 at 01:20)</a>:</h4>
<p>(ah Frank already said as much)</p>



<a name="251486125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251486125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251486125">(Sep 01 2021 at 01:20)</a>:</h4>
<p>as noted on GH, this is also related to the question whether <code>size_of_val_raw</code> can be safe or not -- it might be about time we decide on the validity and safety invariants of metadata of raw ptrs</p>



<a name="251486139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251486139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251486139">(Sep 01 2021 at 01:21)</a>:</h4>
<p>(but then, doing so might preclude some variants of custom DSTs, if we still want to keep the door open for those)</p>



<a name="251584901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251584901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251584901">(Sep 01 2021 at 16:06)</a>:</h4>
<p>I think it'll be better for "raw pointers" to be actually raw, aka metadata doesn't have to be valid. That means:</p>
<ul>
<li>Raw ptr construction takes the form of</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">from_raw_parts</span><span class="o">&lt;</span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">MaybeUninit</span><span class="o">&lt;&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Pointee</span><span class="o">&gt;</span>::<span class="n">Metadata</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<ul>
<li>Raw ptr upcasting coercion becomes unsafe.</li>
<li>Methods that have raw ptr as receiver are not object safe</li>
</ul>



<a name="251588836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251588836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251588836">(Sep 01 2021 at 16:30)</a>:</h4>
<p>why does the upcasting have to be unsafe? you can't dereference the invalid upcasted raw pointer without unsafe?</p>



<a name="251589014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251589014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251589014">(Sep 01 2021 at 16:31)</a>:</h4>
<p>With upcasting it may be necessary to load a vtable for the new trait object from the vtable of the old trait object. This requires the vtable to be valid.</p>



<a name="251589196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251589196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251589196">(Sep 01 2021 at 16:32)</a>:</h4>
<p>the jury is still out on whether dyn metadata has to be valid though, right?</p>



<a name="251589465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/251589465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#251589465">(Sep 01 2021 at 16:34)</a>:</h4>
<p>(oh, I see this is the subject of discussion)</p>



<a name="252871081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/252871081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#252871081">(Sep 11 2021 at 01:07)</a>:</h4>
<p>Progress report:<br>
In the last two weeks we switched this into in an <a href="https://github.com/rust-lang/dyn-upcasting-coercion-initiative/">t-lang initiative</a>. And there're two experience reports now. On the implementation side, we're still pending on <a href="https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety.html">t-lang decision on upcast-safety matter</a>, so nothing much happened.</p>



<a name="253083071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/253083071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#253083071">(Sep 13 2021 at 12:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116458">@Charles Lew</span> oh, thanks-- I forgot we were blocked on that!</p>



<a name="253083087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/253083087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#253083087">(Sep 13 2021 at 12:47)</a>:</h4>
<p>I'll try to move that along :)</p>



<a name="253083095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/253083095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#253083095">(Sep 13 2021 at 12:47)</a>:</h4>
<p>it may require a design meeting</p>



<a name="254082784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254082784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254082784">(Sep 20 2021 at 17:01)</a>:</h4>
<p><span class="user-mention" data-user-id="116458">@Charles Lew</span> ping</p>



<a name="254082794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254082794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254082794">(Sep 20 2021 at 17:01)</a>:</h4>
<p><em>so</em> I didn't move that along</p>



<a name="254082821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254082821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254082821">(Sep 20 2021 at 17:01)</a>:</h4>
<p>I am trying to remember if you and I had a proposal, I think we did, right?</p>



<a name="254082845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254082845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254082845">(Sep 20 2021 at 17:01)</a>:</h4>
<p>yes</p>



<a name="254082857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254082857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254082857">(Sep 20 2021 at 17:01)</a>:</h4>
<p>which option did we like best :)</p>



<a name="254082982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254082982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254082982">(Sep 20 2021 at 17:02)</a>:</h4>
<p>we talked about making sure raw fat pointers always have a valid vtable ptr</p>



<a name="254083026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254083026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254083026">(Sep 20 2021 at 17:02)</a>:</h4>
<p>the first choice of the three.</p>



<a name="254083102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254083102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254083102">(Sep 20 2021 at 17:03)</a>:</h4>
<p><a href="https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety.html#unsafe-to-create-a-dyn-foo">https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety.html#unsafe-to-create-a-dyn-foo</a></p>



<a name="254083831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254083831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254083831">(Sep 20 2021 at 17:08)</a>:</h4>
<p>The zulip discussion context was here: <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion/near/250618801">https://rust-lang.zulipchat.com/#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion/near/250618801</a></p>



<a name="254084592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254084592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254084592">(Sep 20 2021 at 17:14)</a>:</h4>
<p>that's what I figured</p>



<a name="254084642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254084642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254084642">(Sep 20 2021 at 17:14)</a>:</h4>
<p>thanks</p>



<a name="254084653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254084653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254084653">(Sep 20 2021 at 17:14)</a>:</h4>
<p>I think I will open an issue around it</p>



<a name="254084658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254084658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254084658">(Sep 20 2021 at 17:14)</a>:</h4>
<p>np</p>



<a name="254345502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254345502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254345502">(Sep 22 2021 at 10:24)</a>:</h4>
<p>we discussed this in the rust-lang meeting today, decision was to make a design meeting discussion</p>



<a name="254345512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254345512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254345512">(Sep 22 2021 at 10:24)</a>:</h4>
<p><span class="user-mention" data-user-id="116458">@Charles Lew</span> do you think you would want to attend?</p>



<a name="254345918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254345918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254345918">(Sep 22 2021 at 10:28)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> if it's a text-based discussion, i'd love to attend if i can. i'm available on 19:00pm~26:00pm on weekdays, and 11:00 am~26:00pm at weekends.</p>



<a name="254345977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254345977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254345977">(Sep 22 2021 at 10:29)</a>:</h4>
<p>well, 26:00 i mean 2am in the next day.</p>



<a name="254345989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%20coercion/near/254345989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.20coercion.html#254345989">(Sep 22 2021 at 10:29)</a>:</h4>
<p>i'm in UTC+8</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>