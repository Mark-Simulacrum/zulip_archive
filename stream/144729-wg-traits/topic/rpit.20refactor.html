<html>
<head><meta charset="utf-8"><title>rpit refactor · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html">rpit refactor</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264056025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264056025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264056025">(Dec 07 2021 at 19:10)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="248906">@cjgillot</span> opening a topic for future discussions</p>



<a name="264056076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264056076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264056076">(Dec 07 2021 at 19:11)</a>:</h4>
<p>I've been talking over DMs with you both, let's discuss things here maybe better</p>



<a name="264056083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264056083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264056083">(Dec 07 2021 at 19:11)</a>:</h4>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>



<a name="264056187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264056187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264056187">(Dec 07 2021 at 19:11)</a>:</h4>
<p>gonna paste last message from Camile and we can continue from there</p>



<a name="264056188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264056188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264056188">(Dec 07 2021 at 19:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/pm-with/116266,248906-pm/near/264055884">said</a>:</p>
<blockquote>
<blockquote>
<p>To go back to your lowering step 1 &amp; 2:<br>
HIR path segments contain a <code>Res</code> field, which contains the resolution for this segment. When we have <code>foo&lt;'a, T&gt;</code>, all mentions of <code>T</code> will have a <code>Res::Def(DefKind::TyParam, &lt;T's DefId&gt;)</code>.</p>
</blockquote>
<p>Continuing: now, if you have <code>fn foo&lt;'a, T&gt;() -&gt; impl Borrow&lt;T&gt;</code>, AST resolution will say that the T inside Borrow&lt;T&gt; resolves to foo's generic. But in HIR, you will have <code>type foo#Ty&lt;'a, T2&gt; = impl Borrow&lt;T2&gt;</code>, with AST telling you the T2 inside Borrow&lt;&gt; still resolves to foo's T. So you need to fix <code>T2</code>'s resolution to hve <code>foo#Ty</code>'s T2 DefId instead.</p>
</blockquote>



<a name="264056476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264056476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264056476">(Dec 07 2021 at 19:14)</a>:</h4>
<p>yea, this makes sense. Do we have a HIR &amp;mut visitor that we can use here?</p>



<a name="264056537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264056537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264056537">(Dec 07 2021 at 19:14)</a>:</h4>
<p>nope, doesn't look like it</p>



<a name="264056602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264056602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264056602">(Dec 07 2021 at 19:15)</a>:</h4>
<p>in that case, we may need to do some ad-hoc patching during the HIR lowering instead of fixing it up after the fact?</p>



<a name="264056622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264056622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264056622">(Dec 07 2021 at 19:15)</a>:</h4>
<p>or implement a MutVisitor</p>



<a name="264056741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264056741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264056741">(Dec 07 2021 at 19:16)</a>:</h4>
<p>HIR can't be mutated, on purpose. It uses <code>&amp;</code> references allocated on an arena, so MutVisitor would be very unsafe.</p>



<a name="264057047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264057047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264057047">(Dec 07 2021 at 19:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/144729-wg-traits/topic/rpit.20refactor/near/264056602">said</a>:</p>
<blockquote>
<p>in that case, we may need to do some ad-hoc patching during the HIR lowering instead of fixing it up after the fact?</p>
</blockquote>
<p>right patching during lowering seems like the way to go then?</p>



<a name="264057051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264057051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264057051">(Dec 07 2021 at 19:18)</a>:</h4>
<p>generic params can appear everywhere from expressions to types, so we'd have to be able to modify what a generic param lowers throughout the entire HIR lowering infra</p>



<a name="264057054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264057054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264057054">(Dec 07 2021 at 19:18)</a>:</h4>
<p>Illustration I sent in PM:<br>
AST:</p>
<div class="codehilite"><pre><span></span><code>fn foo&lt;T&gt;() -&gt; impl Borrow&lt;T&gt; {}
       ^     resolution    |
       +-------------------+
</code></pre></div>
<p>HIR</p>
<div class="codehilite"><pre><span></span><code>fn foo&lt;T&gt;() -&gt; foo#Ty&lt;T&gt; {
       ^              |
       +--------------+

    type foo#Ty&lt;T2&gt; = impl Borrow&lt;T2&gt;;
                ^^                ||
                ++----------------++
}
</code></pre></div>



<a name="264058041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264058041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264058041">(Dec 07 2021 at 19:25)</a>:</h4>
<p>in a bit I'm going to try to summarize all the things that we've been talking about somehow</p>



<a name="264058275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264058275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264058275">(Dec 07 2021 at 19:27)</a>:</h4>
<p>Another solution would be to re-implement resolution on the HIR, like lifetime resolution works. But this is a very large amount of work.</p>



<a name="264154773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264154773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264154773">(Dec 08 2021 at 13:32)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="248906">@cjgillot</span>, Niko was sharing with me some ideas about how to handle this and asked me to check with you both to see if you see some issues related to it</p>



<a name="264154779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264154779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264154779">(Dec 08 2021 at 13:32)</a>:</h4>
<p><a href="#narrow/stream/144729-wg-traits/topic/rpit.20refactor">How to manage this</a></p>
<ol>
<li>Parsing into AST</li>
<li>Name resolution on the AST (produces some kind of map from AST paths to definitions)</li>
<li>AST lowering into HIR<br>
    4. reads the name resolution results and produces a <code>Res</code> in the HIR that maps to a <code>DefId</code></li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Debug</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>: <span class="nb">Ord</span>
<span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="c1">// want to produce</span>

<span class="k">type</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T1</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">Debug</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T1</span>: <span class="nb">Ord</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>: <span class="nb">Ord</span>
<span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>For example:</p>
<ul>
<li>There will be some AST nodes that represent <code>where T: Ord</code><br>
    * the AST node for <code>T</code> will have a "name resolution result" that maps to <code>T</code> on <code>foo</code></li>
<li>Conceptually, you can model this as:<br>
    * <code>AstNameResolution: Map&lt;AstNode, DefId&gt;</code> 'more or less'</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">lower_ast_to_hir</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">path</span>: <span class="kp">&amp;</span><span class="nc">ast</span>::<span class="n">Path</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">hir</span>::<span class="n">Path</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ast_name_resolution</span><span class="p">[</span><span class="n">path</span><span class="p">.</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">SomeVariant</span><span class="p">(</span><span class="n">def_id</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Res</span>::<span class="n">DefId</span><span class="p">(</span><span class="n">def_id</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">hir</span>::<span class="n">Path</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>What we want to do, in terms of that example:</p>
<ul>
<li>Produce the same HIR we did before (<code>where T: Ord</code>) for use within <code>foo</code> function</li>
<li>Produce the HIR for the <code>Foo</code> TAIT, which is <em>almost</em> the same but any reference to <code>T</code> now is mapped to <code>T1</code><br>
    * <code>where T1: Ord</code></li>
</ul>
<h3>Option 1.</h3>
<p>Lower the AST twice, and have a mapping at that time.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* AST for some function that returns impl trait */</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">f_wc_hir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_ast_to_hir</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">where_clauses</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="c1">// &lt;-- old code, nothing changed</span>

<span class="kd">let</span><span class="w"> </span><span class="n">tait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* new def id */</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">tait_generics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_of</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">generics</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">generics</span><span class="w"> </span>-&gt; <span class="nc">tait</span><span class="p">.</span><span class="n">generics</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">tait_wc_hir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_ast_to_hir</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">where_clauses</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">map</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span><span class="w"> </span><span class="c1">// &lt;-- old code, nothing changed</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">lower_ast_to_hir</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">path</span>: <span class="kp">&amp;</span><span class="nc">ast</span>::<span class="n">Path</span><span class="p">,</span><span class="w"> </span><span class="n">map_fn</span>: <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">Res</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Res</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">hir</span>::<span class="n">Path</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ast_name_resolution</span><span class="p">[</span><span class="n">path</span><span class="p">.</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">SomeVariant</span><span class="p">(</span><span class="n">def_id</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Res</span>::<span class="n">DefId</span><span class="p">(</span><span class="n">def_id</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map_fn</span><span class="p">(</span><span class="n">res</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">hir</span>::<span class="n">Path</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3>Option 2.</h3>
<p>Lower the AST to HIR, then clone the HIR and apply a mapping as we do so.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* AST for some function that returns impl trait */</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">f_wc_hir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lower_ast_to_hir</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">where_clauses</span><span class="p">);</span><span class="w"> </span><span class="c1">// &lt;-- old code, nothing changed</span>

<span class="kd">let</span><span class="w"> </span><span class="n">tait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* new def id */</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">tait_generics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy_of</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">generics</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">generics</span><span class="w"> </span>-&gt; <span class="nc">tait</span><span class="p">.</span><span class="n">generics</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">tait_wc_hir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clone_hir</span><span class="p">(</span><span class="n">f_wc_hir</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">map</span><span class="p">[</span><span class="n">x</span><span class="p">]);</span><span class="w"></span>
</code></pre></div>



<a name="264154805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264154805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264154805">(Dec 08 2021 at 13:32)</a>:</h4>
<p>those are his ideas <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span></p>



<a name="264155512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264155512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264155512">(Dec 08 2021 at 13:37)</a>:</h4>
<p>as discussed earlier, cloning is not really an option. The infrastructure needed for that would be enormous. It may be worth it if we can re-use it for other things, but doing it on the fly seems like the better option, but it may cause perf regressions in cases that don't use RPIT, so we need to see</p>



<a name="264155621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264155621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264155621">(Dec 08 2021 at 13:38)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="264155675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264155675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264155675">(Dec 08 2021 at 13:39)</a>:</h4>
<p>but this is more or less what you also had in mind?</p>



<a name="264155728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264155728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264155728">(Dec 08 2021 at 13:39)</a>:</h4>
<p>yea, pretty much</p>



<a name="264155801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264155801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264155801">(Dec 08 2021 at 13:39)</a>:</h4>
<p>tho I'm not sold on threading a mapping closure through all of HIR lowering</p>



<a name="264155911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264155911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264155911">(Dec 08 2021 at 13:40)</a>:</h4>
<p>may want to start out with a field on the lowering context that is a boxed closure</p>



<a name="264156079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264156079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264156079">(Dec 08 2021 at 13:42)</a>:</h4>
<p>yeah, we can check these kind of details as we go</p>



<a name="264196120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264196120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264196120">(Dec 08 2021 at 18:11)</a>:</h4>
<p>I really have very strong doubts about this approach. For my understanding, what are the difficulties of using <code>generics_of</code> as previously suggested?</p>



<a name="264211332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264211332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264211332">(Dec 08 2021 at 19:57)</a>:</h4>
<p>I don't think there are huge difficulties from what I've seen in my code</p>



<a name="264211393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264211393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264211393">(Dec 08 2021 at 19:57)</a>:</h4>
<p>although I clearly see how with this new approach all the different variants of return position impl trait behave similar</p>



<a name="264211635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264211635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264211635">(Dec 08 2021 at 19:59)</a>:</h4>
<p>I was told that this approach may not interact well with <span class="user-mention" data-user-id="124288">@oli</span>'s new lazy taits, but I'm not sure because I don't know what are exactly the changes there</p>



<a name="264211815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264211815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264211815">(Dec 08 2021 at 20:00)</a>:</h4>
<p>also ... you only want to catch lifetimes that show up in the bounds, so I guess the current solution does some kind of a hack to hide the ones that you want to discard, (is that the <code>'static</code> thing that <span class="user-mention" data-user-id="124288">@oli</span> mentioned me?)</p>



<a name="264211864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264211864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264211864">(Dec 08 2021 at 20:00)</a>:</h4>
<p>I'm not 100% sure of all the things involved to be honest</p>



<a name="264211896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264211896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264211896">(Dec 08 2021 at 20:00)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span> <span class="user-mention" data-user-id="124288">@oli</span></p>



<a name="264229373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/264229373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#264229373">(Dec 08 2021 at 22:19)</a>:</h4>
<blockquote>
<p>also ... you only want to catch lifetimes that show up in the bounds, so I guess the current solution does some kind of a hack to hide the ones that you want to discard, (is that the <code>'static</code> thing that <span class="user-mention silent" data-user-id="124288">oli</span> mentioned me?)</p>
</blockquote>
<p>Yes. In the current code, all lifetimes from the function are inherited in the RPIT. In order to avoid capturing those we don't want, astconv replaces them with <code>'static</code>.</p>



<a name="265310115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265310115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265310115">(Dec 17 2021 at 15:25)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> <span class="user-mention" data-user-id="124288">@oli</span> I have a question about something that we've talked already but I do not really understand</p>



<a name="265310145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265310145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265310145">(Dec 17 2021 at 15:25)</a>:</h4>
<p>we've said that <code>def_collector</code> runs before macro expansion</p>



<a name="265310203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265310203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265310203">(Dec 17 2021 at 15:26)</a>:</h4>
<p>which yeah, I see :)</p>



<a name="265310217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265310217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265310217">(Dec 17 2021 at 15:26)</a>:</h4>
<p>but then, given that we've also said ...</p>



<a name="265310244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265310244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265310244">(Dec 17 2021 at 15:26)</a>:</h4>
<p>so ... we can’t have a list of all generic parameters bound by a function on <code>def_collector</code></p>



<a name="265310335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265310335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265310335">(Dec 17 2021 at 15:27)</a>:</h4>
<p>that phrase seems to imply that macro resolution is the thing that will make accessible the generic parameters</p>



<a name="265310380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265310380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265310380">(Dec 17 2021 at 15:27)</a>:</h4>
<p>is that what we mean? how? can any of you explain a bit better?</p>



<a name="265310420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265310420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265310420">(Dec 17 2021 at 15:28)</a>:</h4>
<p>we were talking about this with <span class="user-mention" data-user-id="116113">@lqd</span> too</p>



<a name="265331526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265331526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265331526">(Dec 17 2021 at 17:33)</a>:</h4>
<p>Macros haven't been expanded yet, so we don't know yet if macros will expand into additional generic parameters. It's not about macro resolution, it's about having the information available.</p>



<a name="265425893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265425893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265425893">(Dec 18 2021 at 16:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/144729-wg-traits/topic/rpit.20refactor/near/264196120">said</a>:</p>
<blockquote>
<p>I really have very strong doubts about this approach. For my understanding, what are the difficulties of using <code>generics_of</code> as previously suggested?</p>
</blockquote>
<p>cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="265818997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265818997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265818997">(Dec 22 2021 at 15:46)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>



<a name="265819020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265819020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265819020">(Dec 22 2021 at 15:46)</a>:</h4>
<p>can you ask your question here so <span class="user-mention" data-user-id="116009">@nikomatsakis</span> can see it too?</p>



<a name="265819473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265819473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265819473">(Dec 22 2021 at 15:50)</a>:</h4>
<p>I don't have a broad enough view of the current opaque type infrastructure, so I think I need a reminder of the end goal and long view here. This refactoring we have been working on: Which technical debt / complexity are we trying to remove ? Which feature does it prevent us to implement correctly ?</p>



<a name="265921320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921320">(Dec 23 2021 at 14:29)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="248906">@cjgillot</span> -- sorry for being unresponsive, I've been snowed under lately.</p>



<a name="265921333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921333">(Dec 23 2021 at 14:29)</a>:</h4>
<p>here is my position</p>



<a name="265921347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921347">(Dec 23 2021 at 14:29)</a>:</h4>
<p>(A) I would like to have a simple "mini Rust" that we know how to reason about</p>



<a name="265921358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921358">(Dec 23 2021 at 14:29)</a>:</h4>
<p>(B) I would like rustc to lower to something that faithfully represents this mini Rust</p>



<a name="265921425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921425">(Dec 23 2021 at 14:30)</a>:</h4>
<p>(C) If there's going to be complexity, I want it to be pushed more into the "lowering" and "desugaring" logic than the "subtle bits"</p>



<a name="265921489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921489">(Dec 23 2021 at 14:31)</a>:</h4>
<p>I think that the correct model for "mini rust" (let's call it Patina) is going to include opaque types, which I'll represent with this syntax:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">P0</span><span class="o">..</span><span class="p">.</span><span class="n">Pn</span><span class="o">&gt;</span>: <span class="nc">TraitBound</span><span class="w"></span>
</code></pre></div>
<p>Notably this is the same as an associated type, but at the module level. (I think we should actually have this syntax in full rust, too)</p>



<a name="265921510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921510">(Dec 23 2021 at 14:31)</a>:</h4>
<p>So something like <code>type Foo = (impl Trait1, impl Trait2)</code> would desugar to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">Foo1</span>: <span class="nc">Trait1</span><span class="p">;</span><span class="w"></span>
<span class="k">type</span> <span class="nc">Foo2</span>: <span class="nc">Trait2</span><span class="p">;</span><span class="w"></span>
<span class="k">type</span> <span class="nc">Foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Foo1</span><span class="p">,</span><span class="w"> </span><span class="n">Foo2</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="265921582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921582">(Dec 23 2021 at 14:32)</a>:</h4>
<p>In any case, Patina wouldn't include "nested" items that inherit type parameters from the surrounding item, so I don't want to include that in the compiler's internal model either.</p>



<a name="265921623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921623">(Dec 23 2021 at 14:32)</a>:</h4>
<p>I don't think that inheriting type parameters is particularly <em>elegant</em>, anyhow, because of the "incomplete capture" properties of impl Trait -- having to "add back" lifetime parameters and then add "dummy" lifetimes means we need a lot of the same machinery either way.</p>



<a name="265921662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921662">(Dec 23 2021 at 14:33)</a>:</h4>
<p>In Patina, I would expect that the "opaque type" definition would be cheked for well-formedness in the obvious way. This means that it would be important to inherit the where cluases from the surrounding function. Consider something like this:</p>



<a name="265921686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921686">(Dec 23 2021 at 14:33)</a>:</h4>
<p>(Actually, the <code>type Foo: Trait</code> syntax is incomplete. The full Patina syntax would be <code>type Foo: Trait = HiddenType;</code>, sorry)</p>



<a name="265921694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921694">(Dec 23 2021 at 14:34)</a>:</h4>
<p>Given a rust program like</p>



<a name="265921785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921785">(Dec 23 2021 at 14:34)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">RequiresOrd</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Ord</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>:

<span class="nc">fn</span><span class="w"> </span><span class="n">returns_ord</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Ord</span> <span class="o">+</span><span class="w"> </span><span class="n">Debug</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Debug</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">RequiresOrd</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="265921792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921792">(Dec 23 2021 at 14:34)</a>:</h4>
<p>the resulting patina program would be</p>



<a name="265921829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921829">(Dec 23 2021 at 14:35)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>: <span class="nc">Debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequiresOrd</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">T</span>: <span class="nb">Ord</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">returns_ord</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Ord</span> <span class="o">+</span><span class="w"> </span><span class="n">Debug</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Foo</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">RequiresOrd</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="265921907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921907">(Dec 23 2021 at 14:36)</a>:</h4>
<p>we would then check <code>RequiresOrd&lt;T&gt;</code> for well-formedness against the where clauses declared on <code>Foo</code> -- which would require that we know <code>T: Ord</code></p>



<a name="265921917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921917">(Dec 23 2021 at 14:36)</a>:</h4>
<p>Now consider a case with lifetimes...</p>



<a name="265921990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265921990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265921990">(Dec 23 2021 at 14:37)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">SomeTrait</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Wrapper</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="nc">SomeTrait</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">T</span><span class="p">)</span>:

<span class="nc">fn</span><span class="w"> </span><span class="n">returns_ord</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="nc">SomeTrait</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Debug</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Debug</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Wrapper</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="265922001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265922001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265922001">(Dec 23 2021 at 14:37)</a>:</h4>
<p>desugared:</p>



<a name="265922095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265922095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265922095">(Dec 23 2021 at 14:38)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">type</span> <span class="nc">ReturnsOrd</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span>: <span class="nc">Debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Wrapper</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">     </span><span class="n">T</span>: <span class="nc">SomeTrait</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">returns_ord</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="nc">SomeTrait</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Debug</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReturnsOrd</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="265922101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265922101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265922101">(Dec 23 2021 at 14:38)</a>:</h4>
<p>but if we use the 'inherited' technique</p>



<a name="265922114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265922114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265922114">(Dec 23 2021 at 14:38)</a>:</h4>
<p>the desugaring is <em>more like</em> this</p>



<a name="265922221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265922221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265922221">(Dec 23 2021 at 14:39)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">returns_ord</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="nc">SomeTrait</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Debug</span><span class="o">&gt;</span><span class="p">(</span><span class="n">t</span>: <span class="kp">&amp;</span><span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReturnsOrd</span><span class="o">&lt;'</span><span class="nb">static</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">ReturnsOrd</span><span class="o">&lt;..</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="o">&gt;</span>: <span class="nc">Debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Wrapper</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">         </span><span class="n">T</span>: <span class="nc">SomeTrait</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>where the <code>.., 'a</code> indicates that it inherits its generics from the surrounding item.</p>



<a name="265922288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265922288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265922288">(Dec 23 2021 at 14:40)</a>:</h4>
<p>Note that we <em>still</em> had to clone the where clause <code>T: SomeTrait&lt;'a&gt;</code> and the lifetime parameter <code>'a</code></p>



<a name="265922309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265922309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265922309">(Dec 23 2021 at 14:40)</a>:</h4>
<p>So, we're still cloning, and thus requiring all the machinery, but we're <em>not</em> getting the simplicity</p>



<a name="265922324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265922324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265922324">(Dec 23 2021 at 14:40)</a>:</h4>
<p>fin :)</p>



<a name="265922355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265922355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265922355">(Dec 23 2021 at 14:41)</a>:</h4>
<p>also, cloning seems very simple to me :)</p>



<a name="265922380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265922380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265922380">(Dec 23 2021 at 14:41)</a>:</h4>
<p>it's a bit of code but that's mostly because HIR lowering is in need of a good refactoring and cleanup, conceptually it's very simple</p>



<a name="265922407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/265922407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#265922407">(Dec 23 2021 at 14:41)</a>:</h4>
<p>as we lean heavier on desugaring, we should make cloning easy and convenient, we're going to want it more and more often imo</p>



<a name="266117538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/266117538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#266117538">(Dec 26 2021 at 16:59)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="116009">@nikomatsakis</span>, thank you for your answer.<br>
I understand that the aim is to make HIR the simplified pseudo-language that you call Priroda. I agree with this objective.</p>
<p>However, I think the current HIR is not the right tool for that. This is fixable, but we will need to define precise objectives for what we want and how we want it.</p>
<p>Current HIR is very close to the AST. HIR mostly departs from the AST by:</p>
<ul>
<li>making HirIds local to each item;</li>
<li>being indexed;</li>
<li>a few desugarings (loops, async, in-band lifetimes, nested APIT and RPIT...).</li>
</ul>
<p>The main property, which will need to redesign is the indexing:</p>
<ul>
<li>HIR has node identity semantics: each node has a HirId, which is globally unique in the HIR, and can be used to query the HIR node;</li>
<li>HIR also has tree semantics: from a node, there exists a query for its parent.</li>
</ul>
<p>If we simply clone a HIR sub-tree into another sub-tree, the current setup will ICE all over the place since it won't be able to build an HirId -&gt; Node mapping. If we mention a DefId twice in HIR (this will happen if we lower the same AST fragment twice), indexing will need to know which edge defines the right "parent". We cannot simply act as if the AST was written twice, since even a trait can embed arbitrary code and define functions.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">C</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">bar</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bar</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}}]</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Trait</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>(I even think that having two copies of <code>bar</code> could create a type mismatch in some cases, but I don't have an example yet.)</p>
<p>If we want to enable subtree sharing inside HIR, we would need:</p>
<ul>
<li>to define how we want to find the parent of a HIR node: only inside a Body? across items? how do we handle AnonConsts?</li>
<li>to define whether we want to lower stuff twice or to insert more opaque references: do we want to have two pointers to the same <code>hir::Ty</code> (and have some code elsewhere to do the typechecking twice), or do we want a more destructured HIR where we store a <code>TyId</code> twice and have a side map <code>TyId -&gt; hir::Ty</code>?</li>
<li>what is the lowering granularity: whole-crate? per item-like?</li>
</ul>
<p>I would suggest using a lower-level representation than the current HIR. For example: HIR where types have been canonicalized by astconv. Some kind of global THIR (different by the local THIR which is used for MIR building)? Built by gathering item signatures before wf-check?</p>



<a name="266940661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/266940661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#266940661">(Jan 05 2022 at 14:20)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> thanks! I hadn't considered constants, that does indeed introduce some additional complications. I'll have to read this a bit more carefully-- one other thing to keep in mind is that we're talking not only about HIR but also the results of the <code>generics_of</code> query and the like, and I definitely think that those queries are meant to map to this "simplified language" I am referring to.</p>



<a name="266940848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/266940848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#266940848">(Jan 05 2022 at 14:21)</a>:</h4>
<blockquote>
<p>If we simply clone a HIR sub-tree into another sub-tree, </p>
</blockquote>
<p>This isn't what I'm proposing, though. What I'm proposing is rather that we lower the AST twice, with some tweaks to remap name resolution results and the like. I agree that it may be a bit more complex than I was giving credit too, but I don't think fundamentally more complex.</p>



<a name="267252326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/267252326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#267252326">(Jan 07 2022 at 22:39)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> thanks! I hadn't considered constants, that does indeed introduce some additional complications. I'll have to read this a bit more carefully-- one other thing to keep in mind is that we're talking not only about HIR but also the results of the <code>generics_of</code> query and the like, and I definitely think that those queries are meant to map to this "simplified language" I am referring to.</p>
</blockquote>
<p>Making the information in those queries an actual formalized language would greatly benefit the logic behind typeck. That's a great idea!</p>



<a name="267252676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/267252676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#267252676">(Jan 07 2022 at 22:43)</a>:</h4>
<p>Actually, Priroda could be the language of queries: we would specify a set of properties for a definition (visibility, generics, bounds, type...), and this set of properties would define a simplified and uniform language for typeck &amp; borrowck purposes.</p>



<a name="267252693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/267252693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#267252693">(Jan 07 2022 at 22:43)</a>:</h4>
<p>Did I understand your project correctly?</p>



<a name="267306782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/267306782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#267306782">(Jan 08 2022 at 17:44)</a>:</h4>
<p>Oh no, who co-opted the priroda name <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span> it's already the name of my ui frontend for miri xD</p>



<a name="267307017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/267307017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#267307017">(Jan 08 2022 at 17:51)</a>:</h4>
<p>My bad, I got confused between priroda and patina. That's why it sounded familiar.</p>



<a name="268278291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/268278291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#268278291">(Jan 17 2022 at 14:36)</a>:</h4>
<blockquote>
<p>(I even think that having two copies of bar could create a type mismatch in some cases, but I don't have an example yet.)</p>
</blockquote>
<p>that could only be a problem if the array length used a generic parameter, otherwise the constant is evaluated instead of the expression getting compared</p>



<a name="271859418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/rpit%20refactor/near/271859418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/rpit.20refactor.html#271859418">(Feb 14 2022 at 17:26)</a>:</h4>
<p>This topic was moved to <a class="stream-topic" data-stream-id="315482" href="/#narrow/stream/315482-t-compiler.2Fetc.2Fopaque-types/topic/rpit.20refactor">#t-compiler/etc/opaque-types &gt; rpit refactor</a> by <span class="user-mention silent" data-user-id="124288">oli</span>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>