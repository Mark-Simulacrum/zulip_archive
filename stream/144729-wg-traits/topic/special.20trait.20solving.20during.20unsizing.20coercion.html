<html>
<head><meta charset="utf-8"><title>special trait solving during unsizing coercion · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html">special trait solving during unsizing coercion</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249096002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249096002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249096002">(Aug 11 2021 at 11:48)</a>:</h4>
<p>soo, when doing unsizing coercions, we have to solve some <code>T: CoerceUnsized&lt;U&gt;</code> goal at a point where <code>T</code> and <code>U</code> might still contain some unknown type variables, and it turns out this might be hard to do correctly. rustc actually has a <a href="https://github.com/rust-lang/rust/blob/d488de82f30fd1dcb0220d57498638596622394e/compiler/rustc_typeck/src/check/coercion.rs#L581-L667">custom trait solving loop</a> during coercion, where it just tries to solve <code>CoerceUnsized</code> and <code>Unsize</code> subgoals and keeps the rest for later, plus there's some additional special handling for dyn types. </p>
<p>Now that we're <a href="https://github.com/rust-analyzer/rust-analyzer/pull/9807">implementing <code>Sized</code> bounds in rust-analyzer</a>, it looks like something like this is actually necessary to get coercions correct in all cases. Any ideas how this could be handled in Chalk, or whether there might be some other way?</p>



<a name="249096202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249096202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249096202">(Aug 11 2021 at 11:51)</a>:</h4>
<p>CC <span class="user-mention" data-user-id="116009">@nikomatsakis</span> <span class="user-mention" data-user-id="232957">@Jack Huey</span></p>



<a name="249107949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249107949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249107949">(Aug 11 2021 at 13:37)</a>:</h4>
<p>Uh, I have to get this back in my mind. I'm not personally super familiar with CoerceUnsized</p>



<a name="249114058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249114058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249114058">(Aug 11 2021 at 14:17)</a>:</h4>
<p><span class="user-mention" data-user-id="129457">@Florian Diebold</span> could you provide an example goal that is problematic?</p>



<a name="249114563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249114563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249114563">(Aug 11 2021 at 14:20)</a>:</h4>
<p>not right now, maybe <span class="user-mention" data-user-id="319948">@Dawer</span> can, otherwise I'll collect more details probably this evening</p>



<a name="249117029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249117029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249117029">(Aug 11 2021 at 14:38)</a>:</h4>
<p>I think it's something like, when we want to unsize something that contains an inference variable we'll get an ambiguous answer, but we also get an ambiguous answer in other cases where we actually shouldn't unsize (e.g. for <code>&amp;$0 -&gt; &amp;SomeStruct</code>)</p>



<a name="249117088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249117088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249117088">(Aug 11 2021 at 14:38)</a>:</h4>
<p>so we have no way of distinguishing those cases</p>



<a name="249120427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249120427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249120427">(Aug 11 2021 at 15:02)</a>:</h4>
<p>So, it doesn't surprise me that if there is an inference variable, you'll get an ambiguous answer. (but when I skimmed through the thread, you did get <code>Definite</code>, which means progress was made)</p>



<a name="249120507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249120507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249120507">(Aug 11 2021 at 15:03)</a>:</h4>
<p><code>&amp;$0 -&gt; &amp;SomeStruct</code> is interesting...I imagine that's probably not <code>Definite</code>?</p>



<a name="249126941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249126941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249126941">(Aug 11 2021 at 15:50)</a>:</h4>
<p>I would guess not, and drawing the line at Definite is something I thought about as well, but it seems a bit arbitrary. We'll see how the results look with that</p>



<a name="249127234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249127234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249127234">(Aug 11 2021 at 15:52)</a>:</h4>
<p><code>Ambiguous(Definite)</code> means "we didn't find a 'concrete' answer, but we made progress; the eventually concrete answer will look like this"</p>



<a name="249127905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249127905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249127905">(Aug 11 2021 at 15:57)</a>:</h4>
<p>yeah, but are we sure we'll get definite guidance in every situation where we should do unsizing?</p>



<a name="249128605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249128605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249128605">(Aug 11 2021 at 16:01)</a>:</h4>
<p>I'm not sure. I'm not really familiar with the types of goals generated.</p>



<a name="249128794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249128794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249128794">(Aug 11 2021 at 16:02)</a>:</h4>
<p>yeah</p>



<a name="249128817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249128817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249128817">(Aug 11 2021 at 16:02)</a>:</h4>
<p>we'll have to extract some goals from our test cases and see</p>



<a name="249159477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249159477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249159477">(Aug 11 2021 at 19:43)</a>:</h4>
<p>yeah, looking at the examples, it's pretty much what I described above</p>



<a name="249159518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249159518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249159518">(Aug 11 2021 at 19:43)</a>:</h4>
<p>so maybe deciding based on the guidance will work</p>



<a name="249159723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249159723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249159723">(Aug 11 2021 at 19:45)</a>:</h4>
<p>Oh good</p>



<a name="249160052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/special%20trait%20solving%20during%20unsizing%20coercion/near/249160052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/special.20trait.20solving.20during.20unsizing.20coercion.html#249160052">(Aug 11 2021 at 19:47)</a>:</h4>
<p>I'm still a bit worried that rustc's special handling is necessary in some edge cases, but we'll see</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>