<html>
<head><meta charset="utf-8"><title>raw pointers to dyn T, size, layout, and expectations · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html">raw pointers to dyn T, size, layout, and expectations</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265360003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360003">(Dec 17 2021 at 21:03)</a>:</h4>
<p>The kind of code I'm thinking of is, roughly, "code passing around raw pointers opaquely".</p>



<a name="265360024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360024">(Dec 17 2021 at 21:03)</a>:</h4>
<p>As well as code building data structures out of raw pointers.</p>



<a name="265360074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360074">(Dec 17 2021 at 21:04)</a>:</h4>
<p>I think those should generally be <code>*const T</code> where <code>T: Sized</code></p>



<a name="265360135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360135">(Dec 17 2021 at 21:04)</a>:</h4>
<p>so long as you keep the pointer as <code>*const T</code> and have <code>T: ?Sized</code> everywhere, that works just as before</p>



<a name="265360190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360190">(Dec 17 2021 at 21:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265360074">said</a>:</p>
<blockquote>
<p>I think those should generally be <code>*const T</code> where <code>T: Sized</code></p>
</blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265360135">said</a>:</p>
<blockquote>
<p>so long as you keep the pointer as <code>*const T</code> and have <code>T: ?Sized</code> everywhere, that works just as before</p>
</blockquote>
<p><code>Sized</code> or <code>?Sized</code>?</p>



<a name="265360229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360229">(Dec 17 2021 at 21:05)</a>:</h4>
<p>well, depends on what set of raw pointers you want to pass around, I suppose?</p>



<a name="265360269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360269">(Dec 17 2021 at 21:05)</a>:</h4>
<p>(i.e., do you want to include <code>*const dyn Trait</code>, <code>*const [T]</code>)</p>



<a name="265360298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360298">(Dec 17 2021 at 21:05)</a>:</h4>
<p>Both statements are true. You should consciously opt in to <code>T: ?Sized</code>, but it shouldn't present any problems if you just pass it around opaquely</p>



<a name="265360324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360324">(Dec 17 2021 at 21:05)</a>:</h4>
<p>the Sized-ness doesn't really matter if you're working solely with <code>*const</code>, and not trying to e.g. stash it in a usize or similar.</p>



<a name="265360391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360391">(Dec 17 2021 at 21:06)</a>:</h4>
<p>I think I'd be rather surprised, and problematically so, if saying that <em>T</em> wasn't sized makes the <em>pointer</em> to it change size.</p>



<a name="265360424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360424">(Dec 17 2021 at 21:06)</a>:</h4>
<p>that's already (on stable, observably) the case today.</p>



<a name="265360480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360480">(Dec 17 2021 at 21:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265360424">said</a>:</p>
<blockquote>
<p>that's already (on stable, observably) the case today.</p>
</blockquote>
<p>I acknowledge that. And my reaction to that is roughly <a href="https://twitter.com/infinite_scream">https://twitter.com/infinite_scream</a> :)</p>



<a name="265360489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360489">(Dec 17 2021 at 21:06)</a>:</h4>
<p>That should be one of the layout decisions discussed early in the rust book</p>



<a name="265360513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360513">(Dec 17 2021 at 21:07)</a>:</h4>
<p>it feels pretty baked in at this point</p>



<a name="265360531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360531">(Dec 17 2021 at 21:07)</a>:</h4>
<p>Which is to say "gah, how do we make this not utterly suck for people who thought they understood what <code>*</code> meant".</p>



<a name="265360591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360591">(Dec 17 2021 at 21:07)</a>:</h4>
<p>I thought "if you thought you understood pointers before, you were wrong" is rust's subtitle</p>



<a name="265360685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360685">(Dec 17 2021 at 21:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265360531">said</a>:</p>
<blockquote>
<p>Which is to say "gah, how do we make this not utterly suck for people who thought they understood what <code>*</code> meant".</p>
</blockquote>
<p>it seems like the "this" there is just raw pointer to unsized, has nothing really to do with dyn upcasting?</p>



<a name="265360768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360768">(Dec 17 2021 at 21:09)</a>:</h4>
<p>An explanation I've both given and seen given <em>many</em> times is roughly "<code>&amp;</code> is a pointer that's always valid and has a lifetime making sure it can't outlive what it points to; <code>*</code> is a raw pointer that can be null or garbage as long as you don't dereference it, and it acts exactly like the pointers you're used to from C".</p>



<a name="265360833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360833">(Dec 17 2021 at 21:10)</a>:</h4>
<p>I've seen almost exactly the same explanation given, and it's been my mental model up until very recently</p>



<a name="265360956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265360956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265360956">(Dec 17 2021 at 21:10)</a>:</h4>
<p>This is a rather massive "except" clause to append to that. And I'm acknowledging that that "except" exists on stable and can to some extent be observed. It's still a massive "except" that throws a wrench in the conception of "raw pointer".</p>



<a name="265361029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361029">(Dec 17 2021 at 21:11)</a>:</h4>
<p>"This" is doing some work there: it seems like a larger problem/question than this specific dyn-upcasting topic, and seems useful if possible to decouple.</p>



<a name="265361055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361055">(Dec 17 2021 at 21:11)</a>:</h4>
<p>The things I would put on that description to make it more complete is that "exactly like the pointers you are used to from C" is limited to <code>*mut T</code> for <code>T: Sized</code>, and the rule used to make sense of <code>*const T</code> for other types is "<code>&amp;T</code> and <code>*const T</code> are always layout compatible"</p>



<a name="265361057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361057">(Dec 17 2021 at 21:11)</a>:</h4>
<p>(I'm trying to understand whether we are aligned on the decoupling there)</p>



<a name="265361110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361110">(Dec 17 2021 at 21:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265361029">said</a>:</p>
<blockquote>
<p>"This" is doing some work there: it seems like a larger problem/question than this specific dyn-upcasting topic, and seems useful if possible to decouple.</p>
</blockquote>
<p>I'd be happy to split out this sub-discussion from dyn upcasting, though I think it still has relevance if introducing a new validity invariant that wasn't necessarily the case before.</p>



<a name="265361130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361130">(Dec 17 2021 at 21:12)</a>:</h4>
<p>By the way, what's the reasoning behind our current requirement that the metadata of a raw pointer be non-null?</p>



<a name="265361145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361145">(Dec 17 2021 at 21:12)</a>:</h4>
<p>Is it so that we can emit <code>nonnnull</code> to llvm for better optimizations?</p>



<a name="265361315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361315">(Dec 17 2021 at 21:14)</a>:</h4>
<p>well, in general, the unstable suite of functions we have for accessing raw pointer metadata mostly assume fairly significant validity (e.g., it is safe to access roughly size_of_val for <code>*const dyn T</code>))</p>



<a name="265361344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361344">(Dec 17 2021 at 21:14)</a>:</h4>
<p>(I just attempted to roughly split the digression in this topic off into a separate topic.)</p>



<a name="265361423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361423">(Dec 17 2021 at 21:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265361315">said</a>:</p>
<blockquote>
<p>well, in general, the unstable suite of functions we have for accessing raw pointer metadata mostly assume fairly significant validity (e.g., it is safe to access roughly size_of_val for <code>*const dyn T</code>))</p>
</blockquote>
<p>Right, but those functions are unstable, and until they're stable, we don't have those validity expectations.</p>



<a name="265361458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361458">(Dec 17 2021 at 21:15)</a>:</h4>
<p>er, I guess, at least safety invariant: validity is a separate question.</p>



<a name="265361657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361657">(Dec 17 2021 at 21:16)</a>:</h4>
<p>From my perspective, operations on raw wide pointers are a fairly niche use-case. Do we gain anything by making things like non-null-ness and vtable validity part of the safety invariant? What would happen if we were to just make them safety conditions on the relevant <code>unsafe</code> functions?</p>



<a name="265361658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361658">(Dec 17 2021 at 21:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265361423">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265361315">said</a>:</p>
<blockquote>
<p>well, in general, the unstable suite of functions we have for accessing raw pointer metadata mostly assume fairly significant validity (e.g., it is safe to access roughly size_of_val for <code>*const dyn T</code>))</p>
</blockquote>
<p>Right, but those functions are unstable, and until they're stable, we don't have those validity expectations.</p>
</blockquote>
<p>I think validity expectations are insta-stable, since UB in unstable code is UB for everyone</p>



<a name="265361709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361709">(Dec 17 2021 at 21:17)</a>:</h4>
<p>Only if the standard library uses and exposes it via a stable interface.</p>



<a name="265361743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361743">(Dec 17 2021 at 21:17)</a>:</h4>
<p>Otherwise, you'd have to be building with a nightly compiler and using a crate that uses nightly features.</p>



<a name="265361773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361773">(Dec 17 2021 at 21:18)</a>:</h4>
<p>e.g. safe code couldn't do anything with a garbage raw pointer, and calling <code>size_of_val_raw</code> requires that the metadata be 'correct' in some specific sense (e.g the vtable is fully correct, or at least the 'size' field)</p>



<a name="265361820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361820">(Dec 17 2021 at 21:18)</a>:</h4>
<p>Validity invariants are exposed to LLVM codegen, they exist transparently throughout all rust code. You don't get to opt in or out of it</p>



<a name="265361868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361868">(Dec 17 2021 at 21:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265361820">said</a>:</p>
<blockquote>
<p>Validity invariants are exposed to LLVM codegen, they exist transparently throughout all rust code. You don't get to opt in or out of it</p>
</blockquote>
<p>It's entirely possible for the validity invariant to be <em>wrong</em>, and that's not the problem of stable rust code.</p>



<a name="265361899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361899">(Dec 17 2021 at 21:18)</a>:</h4>
<p>You mean wrong in the sense of we shouldn't have that invariant?</p>



<a name="265361901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361901">(Dec 17 2021 at 21:18)</a>:</h4>
<p>Also, I don't think LLVM is aware of <em>all</em> of our validity invariants</p>



<a name="265361904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361904">(Dec 17 2021 at 21:18)</a>:</h4>
<p>If the validity invariant is wrong, then rustc will miscompile code</p>



<a name="265361942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361942">(Dec 17 2021 at 21:19)</a>:</h4>
<p>for example, I think LLVM is generally fine with uninitialized values (except if you try to branch on them)</p>



<a name="265361958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265361958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265361958">(Dec 17 2021 at 21:19)</a>:</h4>
<p>Or to say that another way: when we agreed to add the raw pointer APIs unstably, I don't recall there being any discussion of any insta-stable assumptions about validity, and if those APIs are making validity assumptions, and stable Rust is not matching those assumptions, that's the problem of those APIs and not of the stable Rust code.</p>



<a name="265362031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362031">(Dec 17 2021 at 21:20)</a>:</h4>
<p>yes, I misspoke: those are only about safety invariants, and so can be unstable until we stabilize them.</p>



<a name="265362110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362110">(Dec 17 2021 at 21:20)</a>:</h4>
<p>The raw pointer APIs make no statement on these validity invariants one way or another</p>



<a name="265362115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362115">(Dec 17 2021 at 21:20)</a>:</h4>
<p>but the validity invariant of nonnull does seem true today (i.e., in the "we tell LLVM about it" sense).</p>



<a name="265362225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362225">(Dec 17 2021 at 21:21)</a>:</h4>
<p>They do take a stance on safety invariants, which constrain the validity invariants via safe -&gt; valid</p>



<a name="265362334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362334">(Dec 17 2021 at 21:22)</a>:</h4>
<p>I think at a minimum it's reasonable to argue that we can't stabilize those APIs until we stabilize the assumptions those APIs make, and to the best of my knowledge (which I may well be misremembering given the length of time these APIs have iterated and been discussed) those assumptions have not yet been stabilized.</p>



<a name="265362335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362335">(Dec 17 2021 at 21:22)</a>:</h4>
<p>I think they're all <code>unsafe</code> functions, so they're not necessarily taking a stand on safety invariants, right?</p>



<a name="265362367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362367">(Dec 17 2021 at 21:22)</a>:</h4>
<p>std::ptr::metadata and functions on DynMetadata are currently all safe.</p>



<a name="265362375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362375">(Dec 17 2021 at 21:23)</a>:</h4>
<p>That is, you could expose a garbage wide raw pointer to safe code, and everything would be fine, since it can't actually call those functions</p>



<a name="265362386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362386">(Dec 17 2021 at 21:23)</a>:</h4>
<p>ah, I forgot about DynMetadata</p>



<a name="265362396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362396">(Dec 17 2021 at 21:23)</a>:</h4>
<p>So for instance if there was a safe <code>fn mk_dyn(*const (), *const ()) -&gt; *const dyn T</code> that would be a problem, but that seems extremely unlikely</p>



<a name="265362538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362538">(Dec 17 2021 at 21:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265362367">said</a>:</p>
<blockquote>
<p>std::ptr::metadata and functions on DynMetadata are currently all safe.</p>
</blockquote>
<p>Suppose, hypothetically, we made that function unsafe, and effectively said "it's the caller's responsibility to not pass NULL or a garbage pointer here".</p>



<a name="265362554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362554">(Dec 17 2021 at 21:24)</a>:</h4>
<p>I think that would make things significantly less ergonomic for the wide reference case</p>



<a name="265362572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362572">(Dec 17 2021 at 21:24)</a>:</h4>
<p>Marking that <code>unsafe</code> would be consistent with our stance elsewhere, which is "it's not unsafe to make and store a bad raw pointer, only to dereference one". Today, there's a fair bit of code out there that assumes it's not unsafe/unsound to return a raw pointer and not check it.</p>



<a name="265362596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362596">(Dec 17 2021 at 21:24)</a>:</h4>
<p>e.g. <code>&amp;dyn MyTrait</code>, where <code>std::ptr::metadata</code> and <code>DynMetadata</code> methods should really all be safe</p>



<a name="265362606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362606">(Dec 17 2021 at 21:25)</a>:</h4>
<p>The only current danger I see in the DynMetadata API is that a <code>&lt;dyn T&gt;::Metadata</code> might have a lifetime associated with it for e.g. jitted code</p>



<a name="265362647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362647">(Dec 17 2021 at 21:25)</a>:</h4>
<p>we could duplicate the APIs for references and raw pointers (e.g. <code>std::ptr::metadata_ref</code>, <code>DynMetadataRef</code>, but that seems far from ideal</p>



<a name="265362662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362662">(Dec 17 2021 at 21:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265362596">said</a>:</p>
<blockquote>
<p>e.g. <code>&amp;dyn MyTrait</code>, where <code>std::ptr::metadata</code> and <code>DynMetadata</code> methods should really all be safe</p>
</blockquote>
<p>I think it'd <em>absolutely</em> be valid to have a safe API on references, and an unsafe one on raw pointers.</p>



<a name="265362667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362667">(Dec 17 2021 at 21:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265362572">said</a>:</p>
<blockquote>
<p>That would be consistent with our stance elsewhere, which is "it's not unsafe to make and store a bad raw pointer, only to dereference one".</p>
</blockquote>
<p><a href="https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#metadata-and-field-offsets">https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#metadata-and-field-offsets</a> suggests that we need at least alignment reading to be part of the validity invariant, I think</p>



<a name="265362754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362754">(Dec 17 2021 at 21:26)</a>:</h4>
<p>that's only if we want to allow coercions involving raw pointers, right?</p>



<a name="265362785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362785">(Dec 17 2021 at 21:26)</a>:</h4>
<p>well, that code is a stable coercion, I think -- but not 100% sure</p>



<a name="265362809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362809">(Dec 17 2021 at 21:26)</a>:</h4>
<p>since it's <code>*const u32 -&gt; *const dyn Debug</code>, which you can do on stable already.</p>



<a name="265362853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362853">(Dec 17 2021 at 21:27)</a>:</h4>
<p>that example seems to rely on the existence of a <code>CoerceUnsized</code> impl, which is unstable</p>



<a name="265362884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362884">(Dec 17 2021 at 21:27)</a>:</h4>
<p>because otherwise, you can't coerce through a custom <code>RefCounted</code> struct</p>



<a name="265362900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362900">(Dec 17 2021 at 21:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265362785">said</a>:</p>
<blockquote>
<p>well, that code is a stable coercion, I think -- but not 100% sure</p>
</blockquote>
<p>(This is another aside, but if that's allowed without an <code>as</code>...argh.)</p>



<a name="265362999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265362999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265362999">(Dec 17 2021 at 21:28)</a>:</h4>
<p>I'm fairly certain that there are no stable safe coercions that would require alignment reading to be part of the validity invariant</p>



<a name="265363000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363000">(Dec 17 2021 at 21:28)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=826dfd2519dedc2f082f400736452802">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=826dfd2519dedc2f082f400736452802</a></p>
<div class="codehilite"><pre><span></span><code>use std::rc::Rc;
fn foo(v: *const Rc&lt;u32&gt;) -&gt; *const Rc&lt;dyn std::fmt::Debug&gt; {
    v as *const Rc&lt;dyn std::fmt::Debug&gt;
}
</code></pre></div>



<a name="265363035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363035">(Dec 17 2021 at 21:29)</a>:</h4>
<p>that's just wrong though</p>



<a name="265363046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363046">(Dec 17 2021 at 21:29)</a>:</h4>
<p>That doesn't have the same problem as the example, I think. <code>Rc</code> doesn't expose its fields, so you can't actually "see" how it affects the alignment</p>



<a name="265363067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363067">(Dec 17 2021 at 21:29)</a>:</h4>
<p>that's not an upsize coercion, both of those are sized types</p>



<a name="265363072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363072">(Dec 17 2021 at 21:29)</a>:</h4>
<p>/me is remembering a discussion we had about optimizing <code>Rc</code> that involved ratifying an assumption there; trying to find it...</p>



<a name="265363104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363104">(Dec 17 2021 at 21:29)</a>:</h4>
<p>that is just a <code>ptr::cast</code>, and an incorrect one too</p>



<a name="265363106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363106">(Dec 17 2021 at 21:29)</a>:</h4>
<p>I think all of the stdlib types with <code>CoerceUnsized</code> impls have private fields, so <a href="https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#metadata-and-field-offsets">https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#metadata-and-field-offsets</a> doesn't apply</p>



<a name="265363184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363184">(Dec 17 2021 at 21:30)</a>:</h4>
<p>you can't use <code>raw_addr!</code> to do anything weird</p>



<a name="265363223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363223">(Dec 17 2021 at 21:30)</a>:</h4>
<p>yeah, I suppose -- <a href="https://doc.rust-lang.org/nightly/core/mem/fn.align_of_val_raw.html">https://doc.rust-lang.org/nightly/core/mem/fn.align_of_val_raw.html</a> is unsafe.</p>



<a name="265363254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363254">(Dec 17 2021 at 21:30)</a>:</h4>
<p>(which is in conflict with the safe std::ptr::metadata APIs, but that's another story).</p>



<a name="265363313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363313">(Dec 17 2021 at 21:31)</a>:</h4>
<p>Ignoring <code>std::ptr::metadata</code> for the moment, I think it would be possible for all of the raw pointer metadata functions (like <code>align_of_val_raw</code> to just state their requirements upfront, without imposing any requirements on the validity of safety invariants</p>



<a name="265363314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363314">(Dec 17 2021 at 21:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265363104">said</a>:</p>
<blockquote>
<p>that is just a <code>ptr::cast</code>, and an incorrect one too</p>
</blockquote>
<p>not sure I follow this -- the above function unsizes, it's not just a pointer cast</p>



<a name="265363374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363374">(Dec 17 2021 at 21:32)</a>:</h4>
<p>e.g. the <code>Safety</code> section states that the vtable pointer needs to be valid, the vtable memory needs to be set up right, etc</p>



<a name="265363454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363454">(Dec 17 2021 at 21:33)</a>:</h4>
<p>Considering <code>std::ptr::metadata</code>, I think we would need to duplicate the APIs for references + raw pointers in order to avoid any validity and safety requirements on metadata</p>



<a name="265363482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363482">(Dec 17 2021 at 21:33)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> you casted from a thin pointer to an Rc to a thin pointer to a fat Rc; dereferencing the result would cause UB</p>



<a name="265363513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363513">(Dec 17 2021 at 21:33)</a>:</h4>
<p>the fat part of the pointer isn't stored in the rc</p>



<a name="265363603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363603">(Dec 17 2021 at 21:34)</a>:</h4>
<p><code>Rc&lt;dyn std::fmt::Debug&gt;</code> has size 16, <code>*const Rc&lt;dyn std::fmt::Debug&gt;</code> has size 8</p>



<a name="265363647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363647">(Dec 17 2021 at 21:34)</a>:</h4>
<p>ah, hm</p>



<a name="265363668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363668">(Dec 17 2021 at 21:34)</a>:</h4>
<p>I would have expected that to work fine (maybe Rc is weird here?)</p>



<a name="265363754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363754">(Dec 17 2021 at 21:35)</a>:</h4>
<p>This is working as intended, I think - <code>Rc&lt;dyn debug&gt;</code> is a fat pointer just like <code>&amp;dyn Debug</code> or <code>Box&lt;dyn Debug&gt;</code></p>



<a name="265363821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363821">(Dec 17 2021 at 21:36)</a>:</h4>
<p>the extra <code>*const</code> makes it a thin pointer to a fat pointer</p>



<a name="265363847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363847">(Dec 17 2021 at 21:36)</a>:</h4>
<p>ah, right</p>



<a name="265363880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363880">(Dec 17 2021 at 21:36)</a>:</h4>
<p>Wait, how does an Rc fat pointer fit in 16 bytes? Where's the refcount?</p>



<a name="265363921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363921">(Dec 17 2021 at 21:37)</a>:</h4>
<p>The payload of <code>Rc&lt;T&gt;</code> is a <code>NonNull&lt;RcImpl&lt;T&gt;&gt;</code></p>



<a name="265363928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363928">(Dec 17 2021 at 21:37)</a>:</h4>
<p>Better example would've been:</p>
<div class="codehilite"><pre><span></span><code>use std::cell::Cell;
fn foo(v: *const Cell&lt;u32&gt;) -&gt; *const Cell&lt;dyn std::fmt::Debug&gt; {
    v
}
</code></pre></div>



<a name="265363951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265363951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265363951">(Dec 17 2021 at 21:37)</a>:</h4>
<p><span class="user-mention" data-user-id="271719">@Mario Carneiro</span> Ah.</p>



<a name="265364214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364214">(Dec 17 2021 at 21:40)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> The example you linked to involving <code>RefCounted</code> seems evocative, and it seems like it has something in common with "object safety". I'm wondering if there's some kind of generalized rule here, involving the use of generics <em>inside</em> a dyn, to specify when you need a valid vtable to know the layout of an object. Because it seems valid that you can't get the raw pointer offset to that field without knowing the types involved (which would involve having valid information about the type), while you <em>should</em> be able to get a similar raw pointer offset for a non-generic struct.</p>



<a name="265364298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364298">(Dec 17 2021 at 21:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265363928">said</a>:</p>
<blockquote>
<p>Better example would've been:</p>
<p><div class="codehilite"><pre><span></span><code>use std::cell::Cell;
fn foo(v: *const Cell&lt;u32&gt;) -&gt; *const Cell&lt;dyn std::fmt::Debug&gt; {
    v
}
</code></pre></div><br>
</p>
</blockquote>
<p>Ow. Not a single <code>as</code> in that. That feels very much more like C than Rust sensibilities, insofar as allowing a coercion there without a cast.</p>



<a name="265364332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364332">(Dec 17 2021 at 21:41)</a>:</h4>
<p>(Leaving aside the thin-vs-fat pointer question.)</p>



<a name="265364422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364422">(Dec 17 2021 at 21:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265364214">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> The example you linked to involving <code>RefCounted</code> seems evocative, and it seems like it has something in common with "object safety". I'm wondering if there's some kind of generalized rule here, involving the use of generics <em>inside</em> a dyn, to specify when you need a valid vtable to know the layout of an object. Because it seems valid that you can't get the raw pointer offset to that field without knowing the types involved (which would involve having valid information about the type), while you <em>should</em> be able to get a similar raw pointer offset for a non-generic struct.</p>
</blockquote>
<p>I think the important thing to note here is that a <code>CoerceUnsize</code> impl needs to be written for this to work. As the mutliple soundness issues with <code>Pin</code> have shown, <code>CoerceUnsize</code> can be quite complicated</p>



<a name="265364451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364451">(Dec 17 2021 at 21:42)</a>:</h4>
<p>and there's probably a lot of work that would need to be done in order to stabilize <code>CoerceUnsized</code>, and allow users towrite their own impls of it</p>



<a name="265364484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364484">(Dec 17 2021 at 21:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265364298">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265363928">said</a>:</p>
<blockquote>
<p>Better example would've been:</p>
<p><div class="codehilite"><pre><span></span><code>use std::cell::Cell;
fn foo(v: *const Cell&lt;u32&gt;) -&gt; *const Cell&lt;dyn std::fmt::Debug&gt; {
    v
}
</code></pre></div><br>
</p>
</blockquote>
<p>Ow. Not a single <code>as</code> in that. That feels very much more like C than Rust sensibilities, insofar as allowing a coercion there without a cast.</p>
</blockquote>
<p>This seems like another case of conflicting principles. It makes sense that you can pass an object type where a trait implemented by that object was expected. But separately, it seems like <code>*T</code> should never silently coerce to <code>*U</code> if T is not <em>exactly</em> U.</p>



<a name="265364583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364583">(Dec 17 2021 at 21:44)</a>:</h4>
<p>Anyway, that digression can wait for Rust 2024, and/or whenever we get around to trying to eliminate both <code>as</code> and potentially some coercions. :)</p>



<a name="265364725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364725">(Dec 17 2021 at 21:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265363928">said</a>:</p>
<blockquote>
<p>Better example would've been:</p>
<p><div class="codehilite"><pre><span></span><code>use std::cell::Cell;
fn foo(v: *const Cell&lt;u32&gt;) -&gt; *const Cell&lt;dyn std::fmt::Debug&gt; {
    v
}
</code></pre></div><br>
</p>
</blockquote>
<p>In this example, is Rust using magic knowledge about Cell here, or is this generating an invalid pointer from a valid one?</p>



<a name="265364737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364737">(Dec 17 2021 at 21:45)</a>:</h4>
<p>/me checks struct sizes.</p>



<a name="265364741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364741">(Dec 17 2021 at 21:45)</a>:</h4>
<p>It's using the <code>CoerceUnized</code> impl</p>



<a name="265364761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364761">(Dec 17 2021 at 21:45)</a>:</h4>
<p>implementing it requires that <code>Cell</code> just has one non-ZST field</p>



<a name="265364817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364817">(Dec 17 2021 at 21:46)</a>:</h4>
<p><span class="user-mention" data-user-id="125294">@Aaron Hill</span> Aaaaah. Got it.</p>



<a name="265364901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364901">(Dec 17 2021 at 21:46)</a>:</h4>
<p>though I had only ever seen it used for references before</p>



<a name="265364941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265364941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265364941">(Dec 17 2021 at 21:47)</a>:</h4>
<p>So <code>CoerceUnsized</code> <em>is</em> the "magic knowledge about <code>Cell</code>" I was wondering about, then. "This thing contains only one pointer, and Rust can turn it from a thin pointer into a fat pointer".</p>



<a name="265365374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265365374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265365374">(Dec 17 2021 at 21:50)</a>:</h4>
<p>Regarding pointers to unsized, I <em>also</em> didn't realize that <code>* [T]</code> was a fat pointer. I had thought it was a thin pointer to a thing that had a size in it.</p>



<a name="265365439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265365439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265365439">(Dec 17 2021 at 21:51)</a>:</h4>
<p>But sure enough, <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=7e5e1d58e1a952845f34d241f0042b6d">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=7e5e1d58e1a952845f34d241f0042b6d</a></p>



<a name="265365544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265365544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265365544">(Dec 17 2021 at 21:52)</a>:</h4>
<p>I believe that <code>&amp;T, &amp;mut T, *const T, *mut T</code> always have the same representation in memory</p>



<a name="265365618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265365618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265365618">(Dec 17 2021 at 21:53)</a>:</h4>
<p>/me has the feeling of retroactively having a rug pulled out from under him.</p>



<a name="265366052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265366052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265366052">(Dec 17 2021 at 21:58)</a>:</h4>
<p>/me tries to recalibrate for how raw unsized pointers have apparently worked, and apply that to the question of validity invariants.</p>



<a name="265366115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265366115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265366115">(Dec 17 2021 at 21:59)</a>:</h4>
<p>I'd have to think about it a bit more, but this is roughly leading me towards "these things already didn't act at all like other raw pointers, so having them act even less like raw pointers might not make things any <em>worse</em>?". :)</p>



<a name="265366163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265366163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265366163">(Dec 17 2021 at 21:59)</a>:</h4>
<p>The "think about it a bit more" likely amounts to "is there any way to make them <em>more</em> like raw pointers in a useful way, or should I give up on that line of thinking".</p>



<a name="265375637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265375637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265375637">(Dec 17 2021 at 23:25)</a>:</h4>
<p>I don't see the value of having the metadata of fat raw pointers be raw, TBH.</p>



<a name="265375736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265375736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265375736">(Dec 17 2021 at 23:26)</a>:</h4>
<p>Since C don't have fat pointers, C FFI wouldn't be a concern; this is pretty much a Rust-only concept. All other types interacting with unsized types all expect valid metadata.</p>



<a name="265376103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265376103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265376103">(Dec 17 2021 at 23:31)</a>:</h4>
<p>And arbitrary self types, trait upcasting and metadata API as currently implemented all expect the metadata to be valid.</p>



<a name="265407815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265407815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marmeladema <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265407815">(Dec 18 2021 at 09:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations/near/265365544">said</a>:</p>
<blockquote>
<p>I believe that <code>&amp;T, &amp;mut T, *const T, *mut T</code> always have the same representation in memory</p>
</blockquote>
<p>Raw fat pointers are not ffi safe though, there are lints about this already if you try to use or return such types in an extern C function or repr(C) struct</p>



<a name="265407886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/raw%20pointers%20to%20dyn%20T%2C%20size%2C%20layout%2C%20and%20expectations/near/265407886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marmeladema <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/raw.20pointers.20to.20dyn.20T.2C.20size.2C.20layout.2C.20and.20expectations.html#265407886">(Dec 18 2021 at 09:19)</a>:</h4>
<p><a href="https://doc.rust-lang.org/std/boxed/index.html">https://doc.rust-lang.org/std/boxed/index.html</a></p>
<p>Is the place where those things are documented, though it through Box, it does talk about about raw pointers to Sized Vs DST</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>