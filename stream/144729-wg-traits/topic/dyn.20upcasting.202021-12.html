<html>
<head><meta charset="utf-8"><title>dyn upcasting 2021-12 · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html">dyn upcasting 2021-12</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264757594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264757594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264757594">(Dec 13 2021 at 19:29)</a>:</h4>
<p>I want to unblock dyn upcasting and get this done. <span class="user-mention" data-user-id="116458">@Charles Lew</span>  I started a fresh <a href="https://hackmd.io/BZIOk5AOR2Sc_Gn7LbLfJA">write-up</a> but it's not that far yet. I'm mostly just bringing things back in cache right now. When it's done I'm going to ping you.</p>



<a name="264769562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264769562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264769562">(Dec 13 2021 at 21:03)</a>:</h4>
<p>OK, <span class="user-mention" data-user-id="116458">@Charles Lew</span>, I think the doc is ready. I'd also like to ping <span class="user-mention" data-user-id="239881">@Josh Triplett</span>, <span class="user-mention" data-user-id="127859">@Taylor Cramer</span>, <span class="user-mention" data-user-id="120791">@RalfJ</span>, <span class="user-mention" data-user-id="125270">@scottmcm</span> and maybe <span class="user-mention" data-user-id="124288">@oli</span> -- am I missing things in <a href="https://hackmd.io/BZIOk5AOR2Sc_Gn7LbLfJA?edit">this write-up on dyn upcasting</a>? Do you understand it? Help me improve it!</p>



<a name="264772192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264772192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264772192">(Dec 13 2021 at 21:26)</a>:</h4>
<p>Actually I moved the write-up to the repo (and tweaked it a bit): <a href="https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html">https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html</a></p>



<a name="264778218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264778218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264778218">(Dec 13 2021 at 22:14)</a>:</h4>
<p>I'm guessing "upsizing" should be "unsizing"?</p>



<a name="264778588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264778588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264778588">(Dec 13 2021 at 22:16)</a>:</h4>
<p>So, I think I fully understand the document as written.</p>



<a name="264778639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264778639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264778639">(Dec 13 2021 at 22:16)</a>:</h4>
<p>I do think that we need <em>at least</em> the special case for a null pointer.</p>



<a name="264778884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264778884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264778884">(Dec 13 2021 at 22:17)</a>:</h4>
<p>More importantly, though, I'm <em>really</em> concerned about letting this be a coercion rather than an explicit cast.</p>



<a name="264778974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264778974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264778974">(Dec 13 2021 at 22:18)</a>:</h4>
<p>Reading the document, I don't see any mention of requiring an <code>as</code> or a conversion function, rather than just letting the pointer coerce silently.</p>



<a name="264779063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264779063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264779063">(Dec 13 2021 at 22:19)</a>:</h4>
<p>The <em>combination</em> of that with the fact that the coercion explodes with an invalid pointer (including null) feels especially hazardous to me. It feels like a violation of a general principle in Rust that we don't do invisible operations that have semantic significance.</p>



<a name="264798506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264798506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264798506">(Dec 14 2021 at 02:19)</a>:</h4>
<blockquote>
<p>(Although not directly relevant here, there is another option that requires accessing the vtable from safe code, which is finding the offset of fields. This is because the alignment of a *const dyn Foo depends on the hidden type and hence we must load the alignment from the vtable and do offsetting adjustments at runtime.)</p>
</blockquote>
<p>I'm not sure I understand this bit -- which fields is this talking about?</p>
<hr>
<p>I feel like there's a possible alternative to "Make raw pointer upcasting unsafe (not possible once <code>dyn SubTrait: Unsize&lt;dyn SuperTrait&gt;</code> is stable)":</p>
<ul>
<li>Instead of UnsafeUnsize, we forbid the case for raw pointers (i.e., it's not unsafe, just not allowed at all). Obviously, complicates the system, but less so than introducing conditionally unsafe operations.<ul>
<li>Do we have use cases where it's necessary/helpful to have this upcast on raw pointers?</li>
<li>One might imagine that <code>Unsize</code> is not <em>really</em> a marker trait, but rather has an <code>unsafe fn make_metadata(old: Source::Metadata) -&gt; Target::Metadata</code>, where all current impls are <em>safe</em> impls of that method. In such a world, it's not really a separate UnsafeUnsize trait, but rather just some types are safe to coerce from and some are not, largely because for some types getting the target metadata is a safe operation (it's statically known as <code>()</code>) and for some types that's not the case.</li>
</ul>
</li>
</ul>
<p>This is the most(?) future proof of the options, I think, and lets us pick a story here when we've nailed down the safety &amp; validity invariant more generally for metadata.</p>



<a name="264798643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264798643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264798643">(Dec 14 2021 at 02:21)</a>:</h4>
<p>It's also worth noting that for many (don't have a characterization off hand) trait hierarchies the coercion doesn't actually perform a load, so we could expand in that direction as well -- it's plausible that we can have a min version of this feature that is still eminently useful that only addresses those hierarchies, right?</p>



<a name="264798758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264798758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264798758">(Dec 14 2021 at 02:23)</a>:</h4>
<p>I think the key bit is that for me <code>*const u32 -&gt; *const dyn Debug</code> is an unsizing coercion, but it's not so clear that <code>*const dyn SubTrait -&gt; *const dyn SuperTrait</code> is -- that's not really unsizing anymore. So it going through <code>Unsize</code> seems "interesting" as an assumption.</p>



<a name="264808218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264808218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264808218">(Dec 14 2021 at 04:11)</a>:</h4>
<p>I want to add some background info that <code>*const dyn Trait + AutoTraits -&gt; *const dyn Trait</code> going through <code>Unsize</code> was the previous status quo, and our previous dyn upcasting implementation followed that.</p>



<a name="264808489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264808489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264808489">(Dec 14 2021 at 04:14)</a>:</h4>
<p>-</p>



<a name="264882436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264882436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264882436">(Dec 14 2021 at 16:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264778884">said</a>:</p>
<blockquote>
<p>More importantly, though, I'm <em>really</em> concerned about letting this be a coercion rather than an explicit cast.</p>
</blockquote>
<p>We must be talking past each other, because an explicit cast feels to me like it would be a really big ergonomic hit and I don't understand the urgency you feel about it. In particular...</p>
<blockquote>
<p>The combination of that with the fact that the coercion explodes with an invalid pointer (including null) feels especially hazardous to me. It feels like a violation of a general principle in Rust that we don't do invisible operations that have semantic significance.</p>
</blockquote>
<p>This doesn't match what I expect. What the document proposes is that we don't <em>have</em> invalid pointers -- you always use a valid vtable (even if it's a dummy one). I'm not opposed to special casing null in some way, although I think I would prefer to use the "function to give a sufficiently valid vtable" approach versus saying that the vtable can be null. This is purely an efficiency argument, though, I just don't want to generate inefficient assembly for every upcast to cater to what feels to me like an obscure case.</p>



<a name="264882518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264882518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264882518">(Dec 14 2021 at 16:19)</a>:</h4>
<p>I will say that more and more I regret that <code>*const T</code> permits null</p>



<a name="264883035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264883035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264883035">(Dec 14 2021 at 16:22)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> </p>
<blockquote>
<p>Instead of UnsafeUnsize, we forbid the case for raw pointers (i.e., it's not unsafe, just not allowed at all). Obviously, complicates the system, but less so than introducing conditionally unsafe operations.</p>
</blockquote>
<p>I will add this as an alternative, but I think it's not a good choice. I think in particular that there are definitely use cases for raw pointer upcasting, though I don't have a crisp example at hand. I just know that I've been very grateful that dyn works smoothly with raw pointers in general numerous times, and I can't see why this would be an exception.</p>



<a name="264883095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264883095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264883095">(Dec 14 2021 at 16:23)</a>:</h4>
<p><span class="user-mention" data-user-id="116458">@Charles Lew</span> that sounds like the proposed plan, but I remain pretty opposed to it :)</p>



<a name="264883258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264883258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264883258">(Dec 14 2021 at 16:24)</a>:</h4>
<p>it feels significantly worse than having some kind of "sufficiently valid" vtable (which may include just accepting null)</p>



<a name="264883319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264883319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264883319">(Dec 14 2021 at 16:24)</a>:</h4>
<p>I want to try and articulate in what way... I guess in that it introduces an asymmetry between pointer types and I don't really understand the use case it is protecting</p>



<a name="264883450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264883450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264883450">(Dec 14 2021 at 16:25)</a>:</h4>
<p>really I think that people should be using <code>Option&lt;NonNull&lt;dyn Foo&gt;&gt;</code> and we should make <em>that</em> ergonomic</p>



<a name="264883697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264883697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264883697">(Dec 14 2021 at 16:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264882436">said</a>:</p>
<blockquote>
<p>This doesn't match what I expect. What the document proposes is that we don't <em>have</em> invalid pointers -- you always use a valid vtable (even if it's a dummy one). </p>
</blockquote>
<p>To build on this, I'd like to see <span class="user-mention" data-user-id="239881">@Josh Triplett</span> if we can get real specific -- can we sketch out some code that you anticipate being harder to write under the proposal than you would like?</p>



<a name="264884603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264884603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264884603">(Dec 14 2021 at 16:32)</a>:</h4>
<p>yeah, I agree that option nonnull etc are probably the right path in general -- I think my perspective comes less so from a place of <em>wanting</em> the invalid vtables to "work" (i.e., I don't have code off hand that might fail that) but there's a concern in the back of my mind where it's plausibly unexpected behavior that introduces subtle UB</p>



<a name="264884617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264884617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264884617">(Dec 14 2021 at 16:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264883095">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116458">Charles Lew</span> that sounds like the proposed plan, but I remain pretty opposed to it :)</p>
</blockquote>
<p>ok, I'm trying to elaborate it in the doc; maybe I am not as opposed as I thought I was, but I'm still not sure I like it :)</p>



<a name="264884643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264884643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264884643">(Dec 14 2021 at 16:33)</a>:</h4>
<p>but that may not be actually a problem if it's hard to generate this case in the first place</p>



<a name="264885198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264885198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264885198">(Dec 14 2021 at 16:36)</a>:</h4>
<p>(i.e., how does one end up with a vtable that doesn't work well?)</p>



<a name="264885229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264885229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264885229">(Dec 14 2021 at 16:36)</a>:</h4>
<p>Right. I'd like to drill into that question.</p>



<a name="264885292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264885292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264885292">(Dec 14 2021 at 16:37)</a>:</h4>
<p>I also wonder how much appetite there is for some kind of "raw but not null" pointer that is nice to use</p>



<a name="264885341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264885341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264885341">(Dec 14 2021 at 16:37)</a>:</h4>
<p>It feels like it would be much more ergonomic overall to me</p>



<a name="264889460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264889460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264889460">(Dec 14 2021 at 17:02)</a>:</h4>
<blockquote>
<p><a href="https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#extend-safety-condition-to-require-a-fully-valid-vtable-still-possible-in-the-future">https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#extend-safety-condition-to-require-a-fully-valid-vtable-still-possible-in-the-future</a></p>
</blockquote>
<p><a href="https://doc.rust-lang.org/nightly/std/ptr/fn.metadata.html">https://doc.rust-lang.org/nightly/std/ptr/fn.metadata.html</a> is currently safe, and the methods on the returned <a href="https://doc.rust-lang.org/nightly/std/ptr/struct.DynMetadata.html">https://doc.rust-lang.org/nightly/std/ptr/struct.DynMetadata.html</a> are also safe -- there was another discussion on this, somewhat recently, I think</p>



<a name="264890019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264890019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264890019">(Dec 14 2021 at 17:05)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/63851">https://github.com/rust-lang/rust/issues/63851</a>, I suppose</p>



<a name="264890038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264890038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264890038">(Dec 14 2021 at 17:05)</a>:</h4>
<p>but I think there was discussion on Zulip as well</p>



<a name="264890586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264890586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264890586">(Dec 14 2021 at 17:08)</a>:</h4>
<p>in any case, I agree that drilling into the ways folks are constructing dyn metadata -- it seems like vtables are pretty opaque today, so it seems like the only way to actually get it wrong would be to mem::transmute -- even <a href="https://doc.rust-lang.org/nightly/std/ptr/fn.from_raw_parts.html">https://doc.rust-lang.org/nightly/std/ptr/fn.from_raw_parts.html</a> wouldn't let you manufacture and incorrect vtable as far as I can tell</p>



<a name="264891105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264891105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264891105">(Dec 14 2021 at 17:11)</a>:</h4>
<p>FWIW C++ does <a href="https://stackoverflow.com/questions/29850716/does-upcasting-a-null-pointer-lead-to-undefined-behavior">allow</a> null pointer casting, it seems, but that's a slightly different case, I think, since their vtable is behind the pointer and not on the side</p>



<a name="264891400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264891400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264891400">(Dec 14 2021 at 17:12)</a>:</h4>
<p>anyway, I think I'd be OK with the original proposal -- but part of me is inclined to block raw pointer dyn upcasts until we have concrete code that wants them. But given the difficulty of manufacturing an incorrect vtable already that seems not as necessary.</p>



<a name="264891826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264891826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264891826">(Dec 14 2021 at 17:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264778884">said</a>:</p>
<blockquote>
<p>More importantly, though, I'm <em>really</em> concerned about letting this be a coercion rather than an explicit cast.</p>
</blockquote>
<p>I'd like to second this. I think introducing a new safety invariant for raw pointers is an enormous conceptual shift in how users need to think about raw pointers. While raw pointers are currently "more than just bytes" (provenance), this only affects explicit (unsafe) loads/stores. Simply copying a raw pointer around in memory doesn't require any additional care.</p>
<p>If we do take the approach of adding in some kind of safety invariant related to the vtable, I think it would be a large footgun to perform an implicit upcasting coercion with raw pointers. Unsafe code that appears to be 'just copying around' a raw pointer may actually be performing a read from memory, which I think will be extremely suprising to code reviewers</p>



<a name="264892035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892035">(Dec 14 2021 at 17:16)</a>:</h4>
<p>Note that simply copying a raw pointer here wouldn't require any additional care either</p>



<a name="264892064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892064">(Dec 14 2021 at 17:16)</a>:</h4>
<p>What would require care is <em>producing a raw pointer from nothing</em></p>



<a name="264892171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892171">(Dec 14 2021 at 17:17)</a>:</h4>
<p>Or, more to the point, synthesizing a vtable</p>



<a name="264892214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892214">(Dec 14 2021 at 17:17)</a>:</h4>
<p>If we're just modifying the safety invariant, then it would still be legal to produce a raw pointer with invalid metadata / vtable, right?</p>



<a name="264892246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892246">(Dec 14 2021 at 17:17)</a>:</h4>
<p>Define "legal"</p>



<a name="264892259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892259">(Dec 14 2021 at 17:17)</a>:</h4>
<p>Not immediate undefined behavior</p>



<a name="264892317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892317">(Dec 14 2021 at 17:18)</a>:</h4>
<p>since it doesn't violate the validity invariant</p>



<a name="264892342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892342">(Dec 14 2021 at 17:18)</a>:</h4>
<p>That is correct, not immediate UB.</p>



<a name="264892366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892366">(Dec 14 2021 at 17:18)</a>:</h4>
<p>Though I'd be happy to make it be UB :)</p>



<a name="264892367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892367">(Dec 14 2021 at 17:18)</a>:</h4>
<p>I might then have a helper function, and do <code>my_function(my_synthetic_raw_ptr)</code></p>



<a name="264892378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892378">(Dec 14 2021 at 17:18)</a>:</h4>
<p>But I don't think it's required to be UB</p>



<a name="264892393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892393">(Dec 14 2021 at 17:18)</a>:</h4>
<p>Yes, ok, I see your point.</p>



<a name="264892421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892421">(Dec 14 2021 at 17:18)</a>:</h4>
<p>and that could actually trigger undefined behavior, if the function call performs a coercion in the argument</p>



<a name="264892436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892436">(Dec 14 2021 at 17:18)</a>:</h4>
<p>which I think would be extremely suprising</p>



<a name="264892487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892487">(Dec 14 2021 at 17:19)</a>:</h4>
<p>I guess in my head it would be good to treat it like undefined bytes, that's how I would teach it to people -- in other words, part of the validity invariant.</p>



<a name="264892506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892506">(Dec 14 2021 at 17:19)</a>:</h4>
<p>Perhaps that is another alternative that should be listed.</p>



<a name="264892541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892541">(Dec 14 2021 at 17:19)</a>:</h4>
<p>I think that would be the right way to treat it, regardless.</p>



<a name="264892605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892605">(Dec 14 2021 at 17:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264892393">said</a>:</p>
<blockquote>
<p>Yes, ok, I see your point.</p>
</blockquote>
<p>let me try to articulate that example in the writeup somewhere more cleanly</p>



<a name="264892785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892785">(Dec 14 2021 at 17:20)</a>:</h4>
<p>Anecdotally, I think I've seen that there's a pretty strong belief in the community that raw pointers are "just bytes" when you're not dereferencing them (e.g. ignoring provenance)</p>



<a name="264892835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892835">(Dec 14 2021 at 17:21)</a>:</h4>
<p>I think introducing any kind of validity invariant for raw pointers themselves would be a very significant change to how people percieve the language</p>



<a name="264892872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264892872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264892872">(Dec 14 2021 at 17:21)</a>:</h4>
<p>Even if the spec currently leaves the door open for doing that (e.g. we don't specify certain things about raw pointers)</p>



<a name="264893517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264893517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264893517">(Dec 14 2021 at 17:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264883035">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> </p>
<blockquote>
<p>Instead of UnsafeUnsize, we forbid the case for raw pointers (i.e., it's not unsafe, just not allowed at all). Obviously, complicates the system, but less so than introducing conditionally unsafe operations.</p>
</blockquote>
<p>I will add this as an alternative, but I think it's not a good choice. I think in particular that there are definitely use cases for raw pointer upcasting, though I don't have a crisp example at hand. I just know that I've been very grateful that dyn works smoothly with raw pointers in general numerous times, and I can't see why this would be an exception.</p>
</blockquote>
<p>My impression has been that <code>*const dyn Trait</code> is a very niche feature (though I certainly could be wrong about that). Even if raw pointer upcasting coercions were made to work without any changes to safety/validity invariants, I would expect any actual uses to be extremely rare. Are there any examples of code currently making use of raw trait object pointers?</p>



<a name="264896865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264896865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264896865">(Dec 14 2021 at 17:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264892214">said</a>:</p>
<blockquote>
<p>If we're just modifying the safety invariant, then it would still be legal to produce a raw pointer with invalid metadata / vtable, right?</p>
</blockquote>
<p>Note that this is today -- at least by my reading -- pretty hard</p>



<a name="264896877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264896877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264896877">(Dec 14 2021 at 17:46)</a>:</h4>
<p>you basically have to transmute</p>



<a name="264896992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264896992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264896992">(Dec 14 2021 at 17:47)</a>:</h4>
<p>and when you're transmuting a pair of usizes or so into a dyn raw pointer, you're probably already being pretty careful -- I'm not sure <em>anyone</em> is synthesizing dyn vtables today</p>



<a name="264897033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897033">(Dec 14 2021 at 17:47)</a>:</h4>
<p>ok, I pushed a bunch of edits. I also removed the reference to a "prefered option" since I think my mind at least is not made up</p>



<a name="264897055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897055">(Dec 14 2021 at 17:47)</a>:</h4>
<p>that took way longer than I thought it would lol</p>



<a name="264897066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897066">(Dec 14 2021 at 17:47)</a>:</h4>
<p>I wnated to do other lang team tasks int his hour</p>



<a name="264897095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897095">(Dec 14 2021 at 17:48)</a>:</h4>
<p>but that's ok! this is an important one :)</p>



<a name="264897204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897204">(Dec 14 2021 at 17:48)</a>:</h4>
<p><a href="https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#core-decision-to-be-made">https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#core-decision-to-be-made</a></p>



<a name="264897233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897233">(Dec 14 2021 at 17:48)</a>:</h4>
<p>this section summarizes what I see as the <em>core decision</em> as well as the arguments for each choice</p>



<a name="264897306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897306">(Dec 14 2021 at 17:48)</a>:</h4>
<p><span class="user-mention" data-user-id="125294">@Aaron Hill</span> I will read your latest comments now but I'd appreciate if you gave <a href="https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#why-prefer-unsafe-raw-pointer-upcasting">this section</a> a skim to see if it covers your argument</p>



<a name="264897375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897375">(Dec 14 2021 at 17:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264892785">said</a>:</p>
<blockquote>
<p>Anecdotally, I think I've seen that there's a pretty strong belief in the community that raw pointers are "just bytes" when you're not dereferencing them (e.g. ignoring provenance)</p>
</blockquote>
<p>I think I got this aspect, yes.</p>



<a name="264897453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897453">(Dec 14 2021 at 17:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264896865">said</a>:</p>
<blockquote>
<p>Note that this is today -- at least by my reading -- pretty hard</p>
</blockquote>
<p>I think this is right, I was struggling a bit to come up with a realistic example that isn't <em>also</em> uninitialized -- I came up with <code>unsafe { std::mem::zeroed() }</code></p>



<a name="264897462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897462">(Dec 14 2021 at 17:49)</a>:</h4>
<p>seems plausible</p>



<a name="264897629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897629">(Dec 14 2021 at 17:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264897306">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> I will read your latest comments now but I'd appreciate if you gave <a href="https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#why-prefer-unsafe-raw-pointer-upcasting">this section</a> a skim to see if it covers your argument</p>
</blockquote>
<p>Yes, that looks like a good summary to me</p>



<a name="264897961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264897961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264897961">(Dec 14 2021 at 17:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264897453">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264896865">said</a>:</p>
<blockquote>
<p>Note that this is today -- at least by my reading -- pretty hard</p>
</blockquote>
<p>I think this is right, I was struggling a bit to come up with a realistic example that isn't <em>also</em> uninitialized -- I came up with <code>unsafe { std::mem::zeroed() }</code></p>
</blockquote>
<p>yeah, though it's worth noting:</p>
<div class="codehilite"><pre><span></span><code>warning: the type `*const dyn Debug` does not permit zero-initialization
 --&gt; src/lib.rs:2:14
  |
2 |     unsafe { std::mem::zeroed() }
  |              ^^^^^^^^^^^^^^^^^^
  |              |
  |              this code causes undefined behavior when executed
  |              help: use `MaybeUninit&lt;T&gt;` instead, and only call `assume_init` after initialization is done
  |
  = note: `#[warn(invalid_value)]` on by default
  = note: the vtable of a wide raw pointer must be non-null
</code></pre></div>



<a name="264898042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898042">(Dec 14 2021 at 17:53)</a>:</h4>
<p>interesting :)</p>



<a name="264898106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898106">(Dec 14 2021 at 17:53)</a>:</h4>
<p>and that the current std::ptr::metadata at least implies that there's at least a safety invariant of not doing so -- that gives you safe access to fields of dyn vtables, though it's unstable</p>



<a name="264898110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898110">(Dec 14 2021 at 17:53)</a>:</h4>
<p>I guess I should adjust the doc</p>



<a name="264898129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898129">(Dec 14 2021 at 17:53)</a>:</h4>
<p>there <em>is</em> a layout advantage to the validity invariant</p>



<a name="264898162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898162">(Dec 14 2021 at 17:53)</a>:</h4>
<p><span class="user-mention" data-user-id="125294">@Aaron Hill</span> I'm curious if you feel differently if the result is validity invariant</p>



<a name="264898244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898244">(Dec 14 2021 at 17:54)</a>:</h4>
<p>and I'm also curious whether a standard UB detector would change the calculus for you</p>



<a name="264898260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898260">(Dec 14 2021 at 17:54)</a>:</h4>
<p>that's something I am feelign very strongly about :)</p>



<a name="264898278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898278">(Dec 14 2021 at 17:54)</a>:</h4>
<p>in which case validity invariant failures would mean cargo test just fails</p>



<a name="264898341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898341">(Dec 14 2021 at 17:54)</a>:</h4>
<p>oh, <span class="user-mention" data-user-id="116122">@simulacrum</span>, I wrote up  the case you found confusing</p>



<a name="264898360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898360">(Dec 14 2021 at 17:54)</a>:</h4>
<p><a href="https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#metadata-and-field-offsets">https://rust-lang.github.io/dyn-upcasting-coercion-initiative/design-discussions/upcast-safety-2.html#metadata-and-field-offsets</a></p>



<a name="264898435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898435">(Dec 14 2021 at 17:55)</a>:</h4>
<p>My initial reaction is that a change to the validity invariant seems like a much larger change to the idea that "raw pointers are just bytes until you dereference them"</p>



<a name="264898453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898453">(Dec 14 2021 at 17:55)</a>:</h4>
<p>I'll have to think about the trade-off with detecting U.B.</p>



<a name="264898760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898760">(Dec 14 2021 at 17:57)</a>:</h4>
<p>Generic code does need to 'opt in' to this in a sense (since a <code>*const T</code> won't accept <code>*const dyn Trait</code> due to the implicit <code>Sized</code> bound), so the overall impact might be smaller than I initially thought</p>



<a name="264898774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264898774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264898774">(Dec 14 2021 at 17:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> ah, hm. I guess I'll need to stare at it -- "This is because the offset of field is a function of the alignment of <code>Foo&lt;U&gt;</code>, which is a function of the alignment of U." does not instantly compute for me just yet :)</p>



<a name="264899731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264899731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264899731">(Dec 14 2021 at 18:02)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I just realized that this example is more complex than it has to be</p>



<a name="264900509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264900509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264900509">(Dec 14 2021 at 18:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264883697">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264882436">said</a>:</p>
<blockquote>
<p>This doesn't match what I expect. What the document proposes is that we don't <em>have</em> invalid pointers -- you always use a valid vtable (even if it's a dummy one). </p>
</blockquote>
<p>To build on this, I'd like to see <span class="user-mention silent" data-user-id="239881">Josh Triplett</span> if we can get real specific -- can we sketch out some code that you anticipate being harder to write under the proposal than you would like?</p>
</blockquote>
<p>I think that isn't capturing the nature of my feedback. I can sketch out some code that I anticipate <em>not being sufficiently hard to accidentally write</em>. :)</p>



<a name="264900679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264900679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264900679">(Dec 14 2021 at 18:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264882518">said</a>:</p>
<blockquote>
<p>I will say that more and more I regret that <code>*const T</code> permits null</p>
</blockquote>
<p>That seems like a rather primary property of raw pointers; if you don't want to permit null or garbage, you can often use a reference.</p>



<a name="264900807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264900807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264900807">(Dec 14 2021 at 18:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264898760">said</a>:</p>
<blockquote>
<p>Generic code does need to 'opt in' to this in a sense (since a <code>*const T</code> won't accept <code>*const dyn Trait</code> due to the implicit <code>Sized</code> bound), so the overall impact might be smaller than I initially thought</p>
</blockquote>
<p>That doesn't seem at all like it should be correlated with "can't be null or garbage".</p>



<a name="264900984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264900984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264900984">(Dec 14 2021 at 18:11)</a>:</h4>
<p>I meant that in practice, it might be more difficult that I thought to write code that will ever actually deal with a raw pointer with invalid metadata</p>



<a name="264901008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264901008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264901008">(Dec 14 2021 at 18:11)</a>:</h4>
<p>I'm still in favor of leaving the validity and safety invariants unchanged</p>



<a name="264901015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264901015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264901015">(Dec 14 2021 at 18:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264900679">said</a>:</p>
<blockquote>
<p>That seems like a rather primary property of raw pointers; if you don't want to permit null or garbage, you can often use a reference.</p>
</blockquote>
<p>I disagree that it's primary, I guess. To me it's primarily about "compiler can't prove that it's valid"</p>



<a name="264901128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264901128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264901128">(Dec 14 2021 at 18:12)</a>:</h4>
<p>being potentially null seems better expressed with <code>Option</code>, and being potentially not initialized seems like <code>MaybeUninit</code>; not sure what other forms of "garbage" there are</p>



<a name="264902186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264902186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264902186">(Dec 14 2021 at 18:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264900679">said</a>:</p>
<blockquote>
<p>That seems like a rather primary property of raw pointers; if you don't want to permit null or garbage, you can often use a reference.</p>
</blockquote>
<p>I'm not convinced, there.  Past-the-end references don't exist, for example, and it's incredibly common for pointers in C to be de-facto non-null, even if the type system can't know that.</p>
<p>Not to mention the stacked borrows implications.  You can use a pointer to read past the item in a way you can't with a <code>&amp;mut T</code>, for example.</p>
<p>And a ton of the methods on pointers just don't work on nullable things.  Putting the few methods that do on <code>Option&lt;NonNull&lt;T&gt;&gt;</code> instead would make sense to me.  (<code>wrapping_offset</code>, perhaps, though that's a very rare thing.)</p>



<a name="264908415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264908415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264908415">(Dec 14 2021 at 18:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264901008">said</a>:</p>
<blockquote>
<p>I'm still in favor of leaving the validity and safety invariants unchanged</p>
</blockquote>
<p>I believe we already have an invariant that vtable is non-null even for raw pointers.</p>



<a name="264909142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264909142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264909142">(Dec 14 2021 at 19:02)</a>:</h4>
<p>So despite that I originally think raw pointers should be raw, currently I am leaning towards requiring a fully valid vtable (or as the doc says, "sufficiently valid" for now and leave the fully valid option on the table).</p>



<a name="264910094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264910094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264910094">(Dec 14 2021 at 19:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264901128">said</a>:</p>
<blockquote>
<p>being potentially null seems better expressed with <code>Option</code>, and being potentially not initialized seems like <code>MaybeUninit</code>; not sure what other forms of "garbage" there are</p>
</blockquote>
<p>I think it's too late to make raw pointers <em>not</em> be nullable, and having <em>some</em> raw pointers not be nullable seems confusing.</p>



<a name="264914911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264914911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264914911">(Dec 14 2021 at 19:44)</a>:</h4>
<p>I agree it's too late to directly change <code>*const</code> right now.</p>
<p>The conversation about <code>Aligned&lt;_&gt;</code> in <a href="https://github.com/rust-lang/RFCs/issues/3204">RFCs#3204</a> has been making me thing about a more generic <code>Ptr&lt;...&gt;</code> type, though, which could represent more of these things.  Maybe even say that <code>*const T</code> is sugar for <code>Ptr&lt;T, {Alignment::Unknown}&gt;</code> or something.</p>
<p>That would make it <em>potentially</em> possible to change <code>*const</code> to desugar to something else over like 6 years and multiple editions if we really wanted to later.</p>
<p>But I guess I should take that out of this thread...</p>



<a name="264915065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264915065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264915065">(Dec 14 2021 at 19:46)</a>:</h4>
<p>I think I mentioned this before in another thread: Interaction with <code>#![feature(arbitrary_self_types)]</code> is important. This feature alone requires all vtable pointers to always be valid. E.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(arbitrary_self_types)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Trait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="bp">Self</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// this is safe code, hence `*const dyn Trait` must always</span>
<span class="c1">// contain a completely valid vtable pointer</span>
<span class="k">fn</span> <span class="nf">call_method</span><span class="p">(</span><span class="n">x</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Trait</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="n">method</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I’m not aware of any soundness issues around <code>arbitrary_self_types</code>. If there are any, feel free to point me to them; if there are none, then there must already be an invariant in place that raw pointers to trait objects always have a valid vtable.</p>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>  IMO this point about <code>arbitrary_self_types</code> should be mentioned in the write-up.</p>



<a name="264919085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264919085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264919085">(Dec 14 2021 at 20:17)</a>:</h4>
<p>I think it's questionable if we actually want to support raw pointers with arbitrary_self_types.</p>



<a name="264921892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264921892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264921892">(Dec 14 2021 at 20:39)</a>:</h4>
<p>Hmm, interesting, the tracking issue for that, <a href="https://github.com/rust-lang/rust/issues/44874">#44874</a>, contains a short mention of the problem of "raw pointer[s] with a garbage vtable", too. If that’s really a problem, I feel like the unstable feature <code>arbitrary_self_types</code> should to more to communicate (potential) soundness issues e.g. by triggering a <code>incomplete_features</code> warning?</p>
<p>In any case, that feature <em>does</em> make for some prior discussion of vtable pointer validity guarantees, so it definitely makes sense to consider it as prior art in this discussion.</p>



<a name="264959450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/264959450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#264959450">(Dec 15 2021 at 03:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264919085">said</a>:</p>
<blockquote>
<p>I think it's questionable if we actually want to support raw pointers with arbitrary_self_types.</p>
</blockquote>
<p>I think for trait methods the answer is no (or perhaps it should require <code>Self: Sized</code> — that is, I'm not in favor of having <code>*const dyn Foo</code> require a valid vtable), but I have wanted them very badly many times on inherent methods, for improving ergonomics of unsafe code (currently it's a lot safer to work with raw pointers than references in unsafe code, but the ergonomics push you to use references)</p>



<a name="265042198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265042198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265042198">(Dec 15 2021 at 17:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/264892785">said</a>:</p>
<blockquote>
<p>Anecdotally, I think I've seen that there's a pretty strong belief in the community that raw pointers are "just bytes" when you're not dereferencing them (e.g. ignoring provenance)</p>
</blockquote>
<p>this is already violated by the nonnull attribute on the vtable ptr, though... (which is the reason for the warning on <code>mem::zeroed</code>)</p>



<a name="265042512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265042512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265042512">(Dec 15 2021 at 17:14)</a>:</h4>
<p>if this is to be part of the validity invariant then I hope we can have a clear operational spec for "sufficiently valid" -- Miri will have to implement <em>something</em> after all ;)</p>



<a name="265129460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265129460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265129460">(Dec 16 2021 at 09:26)</a>:</h4>
<p>My intuition for raw dyn pointers has been that the data pointer part works like a raw pointer but that the vtable pointer bit (and by extension the vtable itself and anything related to method dispatch) works like any other fat pointer. In other words a raw dyn pointer is a dyn pointer first and a raw pointer second</p>



<a name="265174299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265174299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265174299">(Dec 16 2021 at 15:42)</a>:</h4>
<p>I guess I've been thinking of the "raw" in "raw pointer" as applying to the entire pointer+metadata, when it really only (or should only) apply to the pointer part, and not the metadata part</p>



<a name="265354856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265354856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265354856">(Dec 17 2021 at 20:14)</a>:</h4>
<p>I think that's likely to break <em>many</em> people's intuitions.</p>



<a name="265354955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265354955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265354955">(Dec 17 2021 at 20:14)</a>:</h4>
<p>Many people, including myself, see <code>*T</code> as "raw pointer to something or other", and the <code>T</code> shouldn't be relevant for the core properties of a raw pointer (e.g. "it's the size of a pointer, it can be null, it's just a number until you dereference it, you can pass it through C", etc).</p>



<a name="265355055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265355055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265355055">(Dec 17 2021 at 20:16)</a>:</h4>
<p>If <code>*T</code> for some value of <code>T</code> is suddenly something with validity invariants, my <em>first</em> question is going to be "so how do I get the raw-er thing that doesn't have validity invariants".</p>



<a name="265355119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265355119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265355119">(Dec 17 2021 at 20:16)</a>:</h4>
<p>(And my second question is likely to be "why isn't <code>*</code> the raw-er thing, and the less-raw thing some kind of reference".)</p>



<a name="265355272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265355272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265355272">(Dec 17 2021 at 20:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265129460">said</a>:</p>
<blockquote>
<p>My intuition for raw dyn pointers has been that the data pointer part works like a raw pointer but that the vtable pointer bit (and by extension the vtable itself and anything related to method dispatch) works like any other fat pointer. In other words a raw dyn pointer is a dyn pointer first and a raw pointer second</p>
</blockquote>
<p>I would have expected that a "raw dyn pointer" was a raw pointer to something that itself included a vtable, rather than a fat pointer.</p>



<a name="265355445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265355445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265355445">(Dec 17 2021 at 20:20)</a>:</h4>
<p>(And that the thing-that-included-a-vtable would be where any non-null non-garbage validity expectations are. So, for instance, you could have a garbage raw pointer, but not a valid raw pointer with a garbage vtable pointer on the other end.)</p>



<a name="265355730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265355730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265355730">(Dec 17 2021 at 20:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265355272">said</a>:</p>
<blockquote>
<p>I would have expected that a "raw dyn pointer" was a raw pointer to something that itself included a vtable, rather than a fat pointer.</p>
</blockquote>
<p>Does that type exist in rust? ("raw pointer to something that itself included a vtable") I assume that changes to the data layout of <code>*const dyn T</code> are not feasible due to stability concerns</p>



<a name="265356409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265356409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265356409">(Dec 17 2021 at 20:29)</a>:</h4>
<p>I don't <em>think</em> we've stabilized those internals yet?</p>



<a name="265356465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265356465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265356465">(Dec 17 2021 at 20:30)</a>:</h4>
<p>I think we have functions for unpacking and packing them, but not the structures themselves.</p>



<a name="265356560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265356560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265356560">(Dec 17 2021 at 20:31)</a>:</h4>
<p>Oh, it looks like even the functions to pack and unpack them are still unstable.</p>



<a name="265356609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265356609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265356609">(Dec 17 2021 at 20:31)</a>:</h4>
<p>So I don't think there are stability issues that would prevent us from saying <code>*const dyn T</code> and <code>*mut dyn T</code> are just thin pointers to a thing that has a vtable on the other end.</p>



<a name="265356613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265356613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265356613">(Dec 17 2021 at 20:31)</a>:</h4>
<p>I mean more fundamentally, I think it would break a lot of things if <code>*const dyn T</code> suddenly became 8 bytes</p>



<a name="265356714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265356714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265356714">(Dec 17 2021 at 20:32)</a>:</h4>
<p>but also, I don't understand how you want the data layout to work. Where is the data pointer then?</p>



<a name="265356727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265356727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265356727">(Dec 17 2021 at 20:32)</a>:</h4>
<p>you wouldnt be able to do <code>&amp;dyn Trait</code> -&gt; <code>*const dyn Trait</code> if <code>*const dyn Trait</code> was a thin pointer could you?</p>



<a name="265356815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265356815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265356815">(Dec 17 2021 at 20:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265356613">said</a>:</p>
<blockquote>
<p>I mean more fundamentally, I think it would break a lot of things if <code>*const dyn T</code> suddenly became 8 bytes</p>
</blockquote>
<p>Oh, I didn't realize <code>*const dyn T</code> was two pointers already. :(</p>
<p><a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=9bc076c78e3327ef02f8dfdfcf7fce4a">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=9bc076c78e3327ef02f8dfdfcf7fce4a</a></p>



<a name="265357403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265357403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265357403">(Dec 17 2021 at 20:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265355055">said</a>:</p>
<blockquote>
<p>If <code>*T</code> for some value of <code>T</code> is suddenly something with validity invariants, my <em>first</em> question is going to be "so how do I get the raw-er thing that doesn't have validity invariants".</p>
</blockquote>
<p>It seems like you can take a fat pointer and split it into a <code>data_ptr: *const ()</code> and <code>vtable_ptr: &lt;dyn T&gt;::Metadata</code>, but the latter part still has validity invariants. There isn't any type that has no validity invariants there, although I suppose you could wrap it in <code>MaybeUninit</code> or use <code>[u8; size_of::&lt;&lt;dyn T&gt;::Metadata&gt;()]</code> instead</p>



<a name="265357563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265357563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265357563">(Dec 17 2021 at 20:40)</a>:</h4>
<p>I'm not sure what kind of code is being enabled by invalid metadata types though</p>



<a name="265357605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265357605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265357605">(Dec 17 2021 at 20:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265356714">said</a>:</p>
<blockquote>
<p>but also, I don't understand how you want the data layout to work. Where is the data pointer then?</p>
</blockquote>
<p>I can imagine a few different layouts that could work, with various properties and tradeoffs:</p>
<ul>
<li>Thin pointer to <code>(data pointer, vtable pointer)</code>.</li>
<li>Thin pointer directly to a vtable that has a slot for a data pointer (less indirect vtable access, at the expense of copying more when creating it)</li>
<li>Thin pointer to data, where the data has a vtable pointer in it or available from it via an offset. (That seems likely to have layout compatibility issues.)</li>
</ul>



<a name="265357745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265357745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265357745">(Dec 17 2021 at 20:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="271719">Mario Carneiro</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265357563">said</a>:</p>
<blockquote>
<p>I'm not sure what kind of code is being enabled by invalid metadata types though</p>
</blockquote>
<p>Passing pointers through FFI. Or storing them in data structures as pointers, where some slots of the data structure aren't filled in and you don't want a separate "is valid" bit.</p>



<a name="265357803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265357803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265357803">(Dec 17 2021 at 20:43)</a>:</h4>
<p>The first one already exists, that's <code>&amp;&amp;dyn T</code></p>



<a name="265357890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265357890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265357890">(Dec 17 2021 at 20:44)</a>:</h4>
<p>Presumably <code>*const &amp;dyn T</code> if you want a raw pointer and its lack of validity expectations?</p>



<a name="265357910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265357910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265357910">(Dec 17 2021 at 20:44)</a>:</h4>
<p>sure</p>



<a name="265357929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265357929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265357929">(Dec 17 2021 at 20:44)</a>:</h4>
<p>(Or <code>*mut &amp;mut dyn T</code> if mutable)</p>



<a name="265357963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265357963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265357963">(Dec 17 2021 at 20:44)</a>:</h4>
<p>Both of the first two suffer from the issue of an additional allocation, which has to be put somewhere (and the rust user will want to control whether that pointer is a <code>Box</code>, <code>&amp;</code>, <code>*const</code> etc)</p>



<a name="265358131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358131">(Dec 17 2021 at 20:46)</a>:</h4>
<p>Going back to "already exists" for a moment: don't we already have a thick pointer with validity expectations, in the form of <code>&amp;dyn T</code>?</p>



<a name="265358155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358155">(Dec 17 2021 at 20:46)</a>:</h4>
<p>(or <code>&amp;mut dyn T</code>)</p>



<a name="265358209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358209">(Dec 17 2021 at 20:46)</a>:</h4>
<p>That has a lifetime though, what if you want to opt out?</p>



<a name="265358319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358319">(Dec 17 2021 at 20:47)</a>:</h4>
<p>I don't see how you can possibly opt out of having a valid vtable pointer when rust gives you no tools for constructing a vtable pointer by hand or checking the validity of vtable pointers</p>



<a name="265358433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358433">(Dec 17 2021 at 20:48)</a>:</h4>
<p>We have (unstably, but with plans to stabilize in the future) functions to disassemble and reassemble a vtable-and-data pointer pair.</p>



<a name="265358498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358498">(Dec 17 2021 at 20:49)</a>:</h4>
<p>Also, <code>extern "C" fn xyz() -&gt; *const T</code> for various <code>T</code>. And <code>extern "C" fn xyz(*const T)</code> with the expectation you'll be handed the pointer back in the future.</p>



<a name="265358528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358528">(Dec 17 2021 at 20:49)</a>:</h4>
<p>That part seems okay, that's the <code>&lt;dyn T&gt;::Metadata</code> part I mentioned. But this type is not just <code>usize</code>, it has validity invariants</p>



<a name="265358614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358614">(Dec 17 2021 at 20:50)</a>:</h4>
<p>I think the concept of a thick pointer with validity invariants isn't the main sticking point, it's the idea of that type being spelled with a <code>*</code> but not behaving like other <code>*</code>s.</p>



<a name="265358631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358631">(Dec 17 2021 at 20:50)</a>:</h4>
<p>and I see no reasonable analogue of this type that doesn't have validity invariants except for wrapping it in <code>MaybeUninit</code> as I mentioned</p>



<a name="265358659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358659">(Dec 17 2021 at 20:50)</a>:</h4>
<p>(I want to acknowledge here that I feel like I'm late to the party and confused. Sorry for that.)</p>



<a name="265358773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358773">(Dec 17 2021 at 20:52)</a>:</h4>
<p>I see your general point about <code>*</code> meaning no invariants, but this implies that there is some other type <code>&lt;dyn T&gt;::RawMetadata</code> and I don't see how it can possibly be handled safely</p>



<a name="265358799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358799">(Dec 17 2021 at 20:52)</a>:</h4>
<p>Suppose you have a big hash table full of "output streams", which you want to represent as <code>dyn std::io::Write</code>. You want each output stream to take up one pointer in size, and you want them to be potentially null so that your hash table can use a null pointer to represent "there's nothing in this bucket".</p>



<a name="265358810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358810">(Dec 17 2021 at 20:52)</a>:</h4>
<p>(that is, if we define <code>*const dyn T = (*const (), &lt;dyn T&gt;::RawMetadata)</code>)</p>



<a name="265358963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265358963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265358963">(Dec 17 2021 at 20:54)</a>:</h4>
<p>That hashmap example sounds like <code>*const Box&lt;dyn Write&gt;</code></p>



<a name="265359058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359058">(Dec 17 2021 at 20:55)</a>:</h4>
<p>or even <code>Option&lt;Box&lt;Box&lt;dyn Write&gt;&gt;</code> since that example doesn't call for any unsafe access</p>



<a name="265359089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359089">(Dec 17 2021 at 20:55)</a>:</h4>
<p><code>*Box</code> or <code>Box&lt;Box&lt;...</code> feels like one more level of indirection than ought to be required there...</p>



<a name="265359173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359173">(Dec 17 2021 at 20:56)</a>:</h4>
<p>I'm assuming your option 1 data layout, which has a pointer to a pointer pair</p>



<a name="265359211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359211">(Dec 17 2021 at 20:56)</a>:</h4>
<p>the others can't easily be represented in rust today</p>



<a name="265359215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359215">(Dec 17 2021 at 20:57)</a>:</h4>
<p>I'm wondering if it's possible that I have some assumptions inherited from C++, where any non-POD object already has a vtable pointer in front of it, so the idea of "pointer to data and pointer to vtable" isn't a necessary concept, whereas Rust allows traits on otherwise-POD types so the pointers have to be separate.</p>



<a name="265359253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359253">(Dec 17 2021 at 20:57)</a>:</h4>
<p>(Or, likewise, Haskell's approach to structures and "vtables", which similarly has pointers in front of each object.)</p>



<a name="265359345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359345">(Dec 17 2021 at 20:58)</a>:</h4>
<p>Well, a big part of the issue is that you can take any type and put it in a<code>&amp;dyn T</code> for any <code>T</code> implemented by the type, including traits defined downstream</p>



<a name="265359403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359403">(Dec 17 2021 at 20:58)</a>:</h4>
<p>so a mechanism that tries to stuff the vtable pointer in the data seems fundamentally impossible</p>



<a name="265359408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359408">(Dec 17 2021 at 20:58)</a>:</h4>
<p>that is, option 3</p>



<a name="265359484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359484">(Dec 17 2021 at 20:59)</a>:</h4>
<p>Right, and you can't know in advance which types might need vtables handled that way, because unlike C++ where <code>virtual</code> is a big clue, any trait can be implemented by any type.</p>



<a name="265359575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359575">(Dec 17 2021 at 21:00)</a>:</h4>
<p>(For what it's worth here, I'm fairly sure at this point that I'm <em>not</em> arguing against the existence of <em>some</em> type that contains a validity invariant for the vtable; I'm just trying to figure out how to avoid confusing people who have a <em>lot</em> of intuition attached to <code>*</code> that's being broken here, and I'm trying to figure out if there's any reasonable way for this to still act like a raw pointer.)</p>



<a name="265359740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359740">(Dec 17 2021 at 21:01)</a>:</h4>
<p>what's an example of code that would be broken by validity-carrying <code>*const dyn T</code> that isn't already broken?</p>



<a name="265359824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359824">(Dec 17 2021 at 21:01)</a>:</h4>
<p>Is it possible for <code>dyn T</code> to be the X in a <code>fn&lt;X&gt;(..., *const X)</code>?</p>



<a name="265359879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265359879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265359879">(Dec 17 2021 at 21:02)</a>:</h4>
<p>with <code>X: ?Sized</code>, yes</p>



<a name="265494292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265494292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265494292">(Dec 19 2021 at 18:57)</a>:</h4>
<p>"it's the size of a pointer" is already clearly not the case though for raw ptrs to dyn types.</p>



<a name="265494359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265494359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265494359">(Dec 19 2021 at 18:58)</a>:</h4>
<p>(and "just a number" is also wrong given that provenance is required to explain which interactions with that supposed 'number' are legal and which are not, but that is a separate discussion)</p>



<a name="265599848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265599848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265599848">(Dec 20 2021 at 18:24)</a>:</h4>
<p>That's true, but I think the intuition that <code>*const T</code>/<code>*mut T</code> shouldn't have validity invariants probably still holds — I find the notion very surprising and like it would need a lot of justification if it does. — After all, that's what references/Box/etc are for.</p>



<a name="265600133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265600133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265600133">(Dec 20 2021 at 18:27)</a>:</h4>
<p>This might have been already addressed, but there are any performance/optimization reasons for raw pointer metadata validity invariants? The only one I'm aware of would be emitting <code>nonnull</code> and <code>deferenceable</code> to LLVM, but I'd be curious to see if that actually makes a difference in practice</p>



<a name="265611396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265611396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265611396">(Dec 20 2021 at 20:21)</a>:</h4>
<p><span class="user-mention" data-user-id="280891">@Frank Steffahn</span> ah, thank you! good callout on the arbitrary self types point. I will add it to the writeup. (Catching up on this thread)</p>



<a name="265611599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265611599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265611599">(Dec 20 2021 at 20:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265599848">said</a>:</p>
<blockquote>
<p>That's true, but I think the intuition that <code>*const T</code>/<code>*mut T</code> shouldn't have validity invariants probably still holds — I find the notion very surprising and like it would need a lot of justification if it does. — After all, that's what references/Box/etc are for.</p>
</blockquote>
<p>we are, indeed, discussing those justifications <em>now</em> :)</p>



<a name="265611669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265611669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265611669">(Dec 20 2021 at 20:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12/near/265600133">said</a>:</p>
<blockquote>
<p>This might have been already addressed, but there are any performance/optimization reasons for raw pointer metadata validity invariants? The only one I'm aware of would be emitting <code>nonnull</code> and <code>deferenceable</code> to LLVM, but I'd be curious to see if that actually makes a difference in practice</p>
</blockquote>
<p>niches?</p>



<a name="265644188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/dyn%20upcasting%202021-12/near/265644188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/dyn.20upcasting.202021-12.html#265644188">(Dec 21 2021 at 03:42)</a>:</h4>
<p>For niches you can always use NonNull&lt;dyn T&gt;. Actually, I think it would be reasonable for the NonNull to apply to both the vtable pointer as well as the data pointer.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>