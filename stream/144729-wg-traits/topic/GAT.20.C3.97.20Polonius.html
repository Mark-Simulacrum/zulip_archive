<html>
<head><meta charset="utf-8"><title>GAT × Polonius · wg-traits · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/index.html">wg-traits</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html">GAT × Polonius</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="248843492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/GAT%20%C3%97%20Polonius/near/248843492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html#248843492">(Aug 09 2021 at 13:11)</a>:</h4>
<p>I worry that focusing on <code>LendingIterator</code> as a tentpole feature of GATs is going to cause a small but noticeable uptick in people running into limitations of the current borrow checker (hopefully solved by Polonius):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(generic_associated_types)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">LendingIterator</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Item</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">    </span><span class="k">where</span><span class="w"></span>
<span class="w">        </span><span class="bp">Self</span>: <span class="o">'</span><span class="na">a</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">next</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Item</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">example</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">LendingIterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">str</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"Trying again"</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">i</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>error[E0499]: cannot borrow `*i` as mutable more than once at a time
  --&gt; src/lib.rs:16:13
   |
11 | fn example&lt;&#39;a&gt;(i: &amp;&#39;a mut impl LendingIterator&lt;Item&lt;&#39;a&gt; = &amp;&#39;a str&gt;) -&gt; &amp;&#39;a str {
   |            -- lifetime `&#39;a` defined here
12 |     match i.next() {
   |           --------
   |           |
   |           first mutable borrow occurs here
   |           argument requires that `*i` is borrowed for `&#39;a`
...
16 |             i.next().unwrap()
   |             ^ second mutable borrow occurs here
</code></pre></div>



<a name="248843721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/GAT%20%C3%97%20Polonius/near/248843721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html#248843721">(Aug 09 2021 at 13:13)</a>:</h4>
<p>I wonder if it's worth either (a) picking a different headline example or (b) adding some notes to the <code>LendingIterator</code> example that indicate it won't solve all the problems in Rust.</p>



<a name="248851724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/GAT%20%C3%97%20Polonius/near/248851724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html#248851724">(Aug 09 2021 at 14:11)</a>:</h4>
<p>unrelated, but why do we allow lifetime shadowing in GATs like that?</p>



<a name="248851795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/GAT%20%C3%97%20Polonius/near/248851795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html#248851795">(Aug 09 2021 at 14:12)</a>:</h4>
<p>was that a conscious decision by the lang team?</p>



<a name="248851867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/GAT%20%C3%97%20Polonius/near/248851867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html#248851867">(Aug 09 2021 at 14:12)</a>:</h4>
<p>I thought that was saying that <code>Item&lt;'a&gt; = &amp;'a str</code> not <code>for&lt;'b&gt; Item&lt;'b&gt; = &amp;'b str</code> <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="248852125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/GAT%20%C3%97%20Polonius/near/248852125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html#248852125">(Aug 09 2021 at 14:14)</a>:</h4>
<p><code>Item&lt;'a&gt;</code> also brings a new lifetime into scope, right?</p>



<a name="248853685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/GAT%20%C3%97%20Polonius/near/248853685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html#248853685">(Aug 09 2021 at 14:23)</a>:</h4>
<p>Filed <a href="https://github.com/rust-lang/rust/issues/87884">https://github.com/rust-lang/rust/issues/87884</a></p>



<a name="248854331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/GAT%20%C3%97%20Polonius/near/248854331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html#248854331">(Aug 09 2021 at 14:28)</a>:</h4>
<p>It's not a new lifetime</p>



<a name="248855323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/GAT%20%C3%97%20Polonius/near/248855323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html#248855323">(Aug 09 2021 at 14:35)</a>:</h4>
<p><code>Item&lt;'a&gt;</code> brings a new lifetime into scope as much as <code>fn foo&lt;'a&gt;() {}</code> does: only for the item</p>



<a name="248855780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/GAT%20%C3%97%20Polonius/near/248855780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html#248855780">(Aug 09 2021 at 14:39)</a>:</h4>
<p>If y'all are talking about </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">example</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">LendingIterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">str</span>
</code></pre></div>
<p>then it may be worth noting that I originally typed</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">example</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">mut</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">LendingIterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">str</span>
</code></pre></div>
<p>but got told to add it:</p>
<div class="codehilite" data-code-language="none"><pre><span></span><code>error[E0107]: missing generics for associated type `LendingIterator::Item`
  --&gt; src/lib.rs:11:48
   |
11 | fn example&lt;'a&gt;(i: &amp;'a mut impl LendingIterator&lt;Item = &amp;'a str&gt;) -&gt; &amp;'a str {
   |                                                ^^^^ expected 1 lifetime argument
   |
note: associated type defined here, with 1 lifetime parameter: `'a`
  --&gt; src/lib.rs:4:10
   |
4  |     type Item&lt;'a&gt;
   |          ^^^^ --
help: add missing lifetime argument
   |
11 | fn example&lt;'a&gt;(i: &amp;'a mut impl LendingIterator&lt;Item&lt;'a&gt; = &amp;'a str&gt;) -&gt; &amp;'a str {
   |                                                ^^^^^^^^
</code></pre></div>



<a name="248856136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/144729-wg-traits/topic/GAT%20%C3%97%20Polonius/near/248856136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/144729-wg-traits/topic/GAT.20.C3.97.20Polonius.html#248856136">(Aug 09 2021 at 14:41)</a>:</h4>
<p>huh, okay, that makes sense</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>