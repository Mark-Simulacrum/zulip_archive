<html>
<head><meta charset="utf-8"><title>subtree madness · t-devtools · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/index.html">t-devtools</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html">subtree madness</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258831093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258831093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Cartwright <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258831093">(Oct 23 2021 at 16:19)</a>:</h4>
<p>relatively confident this is a PEBKAC issue, but sending out a flare after banging a hole in my desk with my head..</p>
<p>i'm trying to sync commits back to rust-lang/rustfmt from rust-lang/rust via the standard git subtree flows, but git is refusing the _push_, apparently because it's behind the remote, while a subtree pull is a no op because everything's already up to date.</p>
<p>didn't encounter this issue on the last sync, and have been following the standard instructions the clippy team documented (<a href="https://github.com/rust-lang/rust-clippy/blob/master/CONTRIBUTING.md#performing-the-sync-from-rust-langrust-to-clippy">https://github.com/rust-lang/rust-clippy/blob/master/CONTRIBUTING.md#performing-the-sync-from-rust-langrust-to-clippy</a>). it's starting to look like i might have to split/rejoin manually, which gives me pause as i feel like the standard push/pull model should just work</p>
<p>any and all suggestions are appreciated, especially if this was caused by me doing something goofy</p>



<a name="258831758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258831758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258831758">(Oct 23 2021 at 16:35)</a>:</h4>
<p>can you post the error you're seeing?</p>



<a name="258831951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258831951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Cartwright <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258831951">(Oct 23 2021 at 16:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/301329-t-devtools/topic/subtree.20madness/near/258831758">said</a>:</p>
<blockquote>
<p>can you post the error you're seeing?</p>
</blockquote>
<p>this, have tried with a few different branches to no avail</p>
<div class="codehilite"><pre><span></span><code>$ git subtree push -P src/tools/rustfmt https://github.com/calebcartwright/rustfmt sync-doc-commits
git push using:  https://github.com/calebcartwright/rustfmt sync-doc-commits
To https://github.com/calebcartwright/rustfmt
 ! [rejected]                29be5483b618ecbf216aff559098c61e23b300c0 -&gt; sync-doc-commits (non-fast-forward)
error: failed to push some refs to &#39;https://github.com/calebcartwright/rustfmt&#39;
hint: Updates were rejected because the tip of your current branch is behind
hint: its remote counterpart. Integrate the remote changes (e.g.
hint: &#39;git pull ...&#39;) before pushing again.
hint: See the &#39;Note about fast-forwards&#39; in &#39;git push --help&#39; for details.
</code></pre></div>



<a name="258832463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258832463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258832463">(Oct 23 2021 at 16:52)</a>:</h4>
<p>hmm, yeah I'm not sure</p>



<a name="258832711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258832711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258832711">(Oct 23 2021 at 16:58)</a>:</h4>
<p>You already have a single commit on this branch: <a href="https://github.com/calebcartwright/rustfmt/tree/sync-doc-commits">https://github.com/calebcartwright/rustfmt/tree/sync-doc-commits</a></p>



<a name="258832883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258832883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Cartwright <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258832883">(Oct 23 2021 at 17:01)</a>:</h4>
<p>yeah i'd started messing around trying to get it to work, and subsequently merged a PR in the rustfmt repo, but i got the same behavior across the board. and even (now) with that one, a subtree pull will go through, but push still hits the same issue</p>



<a name="258833044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258833044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258833044">(Oct 23 2021 at 17:05)</a>:</h4>
<p>Try pushing to a different branch. Preferably a not yet existing branch.</p>



<a name="258833108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258833108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Cartwright <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258833108">(Oct 23 2021 at 17:06)</a>:</h4>
<p>that worked</p>



<a name="258833144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258833144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Cartwright <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258833144">(Oct 23 2021 at 17:07)</a>:</h4>
<p>well, at least from git. the diff looks extremely odd though - <a href="https://github.com/rust-lang/rustfmt/compare/master...calebcartwright:subtree-push-debugging?expand=1">https://github.com/rust-lang/rustfmt/compare/master...calebcartwright:subtree-push-debugging?expand=1</a></p>



<a name="258833212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258833212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Cartwright <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258833212">(Oct 23 2021 at 17:08)</a>:</h4>
<p>hmm that may actually just be due to some stuff i've tried locally. let me try with a completely clean workspace and a net-new branch and see if that produces a more reasonable diff</p>



<a name="258833657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258833657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Cartwright <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258833657">(Oct 23 2021 at 17:18)</a>:</h4>
<p>nope same issue, and the diff for the push is the same as the diff from pull in rust-lang/rust that just landed</p>
<p><a href="https://github.com/rust-lang/rustfmt/compare/master...calebcartwright:new-subtree-sync?expand=1">https://github.com/rust-lang/rustfmt/compare/master...calebcartwright:new-subtree-sync?expand=1</a><br>
<a href="https://github.com/rust-lang/rust/pull/90087">https://github.com/rust-lang/rust/pull/90087</a></p>
<p>which makes me think there's a history related issue</p>



<a name="258877725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258877725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258877725">(Oct 24 2021 at 12:58)</a>:</h4>
<p>So pull almost always just works. You might have some merge conflicts, but otherwise it works.</p>
<p>Push on the other hand has more things you have to know about.</p>
<p>So the above error is because the branch already exists and the changes can't be fast-forwarded. This can be avoided by just deleting the branch before running <code>git subtree push</code>.  I recommend to always make sure that you delete the branch beforehand. Otherwise you'll have to wait for the whole <code>push</code> again.</p>
<p>The weird diff you see is because <code>git subtree</code> bases the push on the last commit that was synced to <code>rust-lang/rust</code> and not on the current <code>master</code> branch of <code>rust-lang/rustffmt</code>. So most of the time you'll have to:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>git subtree push -P ... branch-name
git checkout branch-name
git merge upstream/master  <span class="c1"># assuming `upstream` points to the `github.com/rust-lang/rustfmt.git` remote</span>
</code></pre></div>
<p>and then resolve merge conflicts. It is important, that you use <code>git merge</code> and not <code>git rebase</code>, otherwise <code>git subtree</code> will get really confused.</p>
<p>My usual workflow is to push to a <em>local</em> remote, so your clone of the rustfmt repo:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="c1"># assuming the rust-lang/rust and rust-lang/rustfmt clone are in the same directory</span>
<span class="c1"># in the rust directory:</span>
git remote add rustfmt-local ../rustfmt
git subtree push -P ... rustfmt-local branch-name
<span class="c1"># in the rustfmt directory:</span>
git checkout branch-name
git fetch upstream
git merge upstream/master
<span class="c1"># resolve merge conflicts</span>
git push ...
</code></pre></div>
<p>With pushing to the local repository, you will also have to make sure that the branch doesn't exist. Before syncing, just run <code>git branch -D branch-name</code> for that.</p>
<p>I also recommend to do the <code>push</code> first. In Clippy we don't run all of our tests in the Rust repository. Running the push first makes sure that a completely working (and correctly formatted) version gets synced into the Rust repo every 2 weeks. Not sure if that is a concern for rustfmt though.</p>



<a name="258878051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258878051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258878051">(Oct 24 2021 at 13:06)</a>:</h4>
<p>I'm looking to improve our documentation on all the sync/release process, so knowing what's missing there is nice for that. So let me know if you have any other questions!</p>



<a name="258892194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/301329-t-devtools/topic/subtree%20madness/near/258892194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Caleb Cartwright <a href="https://zulip-archive.rust-lang.org/stream/301329-t-devtools/topic/subtree.20madness.html#258892194">(Oct 24 2021 at 18:48)</a>:</h4>
<p>thank you so much <span class="user-mention" data-user-id="264664">@flip1995</span>! i think the biggest piece i was missing was the need for a new/clean branch on pushes, as my initial reading of the docs led me to believe that <code>sync-from-rust</code> was a long lived branch used for all syncs.</p>
<p>trying to use a single/existing branch led me down all sorts of confusing rabbit holes but it all makes sense, and is working now <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>