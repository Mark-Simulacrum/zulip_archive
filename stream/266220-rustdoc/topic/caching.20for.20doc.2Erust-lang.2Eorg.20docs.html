<html>
<head><meta charset="utf-8"><title>caching for doc.rust-lang.org docs · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html">caching for doc.rust-lang.org docs</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262957610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262957610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262957610">(Nov 29 2021 at 00:50)</a>:</h4>
<p>For the stdlib docs on <a href="http://doc.rust-lang.org">doc.rust-lang.org</a>, here's the current situation for caching: everything is in S3, so it gets ETags and Last-Modified automatically. The Cache-Control headers are controlled by what's set when uploading to S3, which is currently nothing. That means it's up to browsers to apply a heuristic about how long to cache.</p>
<p>According to <a href="https://paulcalvano.com/2018-03-14-http-heuristic-caching-missing-cache-control-and-expires-headers-explained/">https://paulcalvano.com/2018-03-14-http-heuristic-caching-missing-cache-control-and-expires-headers-explained/</a>, that heuristic is "10% of the time since Last-Modified." So for anything in the current stable docs, released 29 days ago, the heuristic cache time is 2.9 days. After the next stable is released, the heuristic cache time will be ~0 days, and slowly go up.</p>
<p>It'd be nice to do better! In particular, for versioned static assets like CSS, JS, and fonts (especially fonts), we'd like to do as <a href="http://docs.rs">docs.rs</a> does and set a long max-age plus "immutable." For nightly, this doesn't really work, since those static assets get overwritten (with the same version number) every night. However, for the stable docs, this could work.</p>
<p>For HTML in the stable docs: We could set "Expires" to the scheduled release of the next stable version. But that would create a problem when there needs to be a patchlevel release in between. During an uneventful 6-week release cycle with no patchlevel releases, the heuristic cache time would get as high as 4.2 days. So we could safely set max-age=4.2 days and have not much worse than the current situation. Or we could round up a bit in the name of more caching and say 7 days. We could also set stale-while-revalidate to some period on the order of months.</p>
<p>For HTML in the nightly docs: Here we can quite confidently set Expires to the time of the next planned nightly build, since it's unlikely there will be another build in between.</p>



<a name="262957686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262957686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262957686">(Nov 29 2021 at 00:52)</a>:</h4>
<p><span class="user-mention" data-user-id="315412">@jsha</span> these seem like good ideas, but rustdoc doesn't control them: you should talk to T-infra</p>



<a name="262957688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262957688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262957688">(Nov 29 2021 at 00:52)</a>:</h4>
<p>Feel free to ping me if you want feedback on the proper cache options though!</p>



<a name="262957704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262957704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262957704">(Nov 29 2021 at 00:53)</a>:</h4>
<p>Also, I don't think it's a big deal to cache the stable docs even after a point release; usually those only modify the compiler, I've never seen one that changes a public API</p>



<a name="262957706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262957706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262957706">(Nov 29 2021 at 00:53)</a>:</h4>
<p>right, rustdoc doesn't control them, but I think T-rustdoc has the best insight into what might break if you have different versions of things cached.</p>



<a name="262957767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262957767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262957767">(Nov 29 2021 at 00:55)</a>:</h4>
<p>I noticed you didn't mention beta - it gets updated pretty often I'd say (I usually see around 7 updates before it's promoted to stable) but those also rarely modify public APIs, so I think a week-long cache or something would be fine</p>



<a name="262957770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262957770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262957770">(Nov 29 2021 at 00:55)</a>:</h4>
<p>also from a tradeoffs perspective - users seeing stale docs vs getting better performance - is that something that T-rustdoc has input on or is it solely T-infra's decision?</p>



<a name="262957829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262957829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262957829">(Nov 29 2021 at 00:57)</a>:</h4>
<p>I don't think there's precedent for this</p>



<a name="262957834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262957834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262957834">(Nov 29 2021 at 00:57)</a>:</h4>
<p>But I would be very surprised if infra just completely ignored us haha</p>



<a name="262957901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262957901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262957901">(Nov 29 2021 at 00:59)</a>:</h4>
<p>What does the "immutable" cache header do? The /stable/ urls do change, it's only /1.XX/ that's immutable</p>



<a name="262958006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262958006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262958006">(Nov 29 2021 at 01:00)</a>:</h4>
<p>according to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control</a> it sounds like:</p>
<p>for resources that are still fresh, a soft-reload will send an If-Modified-Since/If-None-Match to revalidate them. If those resources were marked immutable, a soft-reload will not revalidate them.</p>



<a name="262958045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262958045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262958045">(Nov 29 2021 at 01:01)</a>:</h4>
<p>It's meant for versioned URLs - so like <a href="https://doc.rust-lang.org/main1.56.1.js">https://doc.rust-lang.org/main1.56.1.js</a></p>



<a name="262958124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262958124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262958124">(Nov 29 2021 at 01:02)</a>:</h4>
<p>or from <a href="https://pokeinthe.io/2021/09/13/cache-control-recommendations/">https://pokeinthe.io/2021/09/13/cache-control-recommendations/</a>:</p>
<blockquote>
<p>immutable<br>
when combined with a large max-age, instructs the browser to not check to see if it's still valid, even when user purposefully chooses to refresh their browser</p>
</blockquote>



<a name="262958192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262958192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262958192">(Nov 29 2021 at 01:04)</a>:</h4>
<p>Here's a blog post about immutable: <a href="https://paulcalvano.com/2018-01-07-cache-control-immutable-a-year-later/">https://paulcalvano.com/2018-01-07-cache-control-immutable-a-year-later/</a></p>



<a name="262958275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262958275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262958275">(Nov 29 2021 at 01:07)</a>:</h4>
<p>Linked from there, it sounds like Chrome nerfed the reload button in 2017: <a href="https://blog.chromium.org/2017/01/reload-reloaded-faster-and-leaner-page_26.html">https://blog.chromium.org/2017/01/reload-reloaded-faster-and-leaner-page_26.html</a>. Now a reload in Chrome only revalidates the main page, rather than trying to revalidate all subresources, regardless of whether immutable was set.</p>



<a name="262958515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262958515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262958515">(Nov 29 2021 at 01:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs/near/262957704">said</a>:</p>
<blockquote>
<p>Also, I don't think it's a big deal to cache the stable docs even after a point release; usually those only modify the compiler, I've never seen one that changes a public API</p>
</blockquote>
<p>Counterexample: <a href="https://blog.rust-lang.org/2017/02/09/Rust-1.15.1.html#whats-in-1151-stable">https://blog.rust-lang.org/2017/02/09/Rust-1.15.1.html#whats-in-1151-stable</a></p>
<p>But yeah, almost never an issue.</p>



<a name="262958604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/caching%20for%20doc.rust-lang.org%20docs/near/262958604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/caching.20for.20doc.2Erust-lang.2Eorg.20docs.html#262958604">(Nov 29 2021 at 01:17)</a>:</h4>
<p>I mean yeah, this is the exception that proves the rule <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> this is the only one I've seen in 6 years of stable rust</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>