<html>
<head><meta charset="utf-8"><title>reducing duplication · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/reducing.20duplication.html">reducing duplication</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264110515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/reducing%20duplication/near/264110515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/reducing.20duplication.html#264110515">(Dec 08 2021 at 04:25)</a>:</h4>
<p>Rustdoc currently duplicates a lot of code, mainly in <code>clean</code>. There's one version for <code>rustc_hir</code>, and one for <code>rustc_middle::ty</code>. Usually, the HIR version corresponds to definitions from the local crate, while the <code>ty</code> version corresponds to external definitions, which don't have HIR available.</p>
<p>Ideally, rustdoc would use <code>ty</code> information more, since it would avoid awful hacks like <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustdoc/core/struct.DocContext.html#structfield.substs">syntax-directed type parameter substitution</a>. Also, rustdoc has <em>a lot</em> of <a href="https://github.com/rust-lang/rust/issues?q=is%3Aopen+is%3Aissue+label%3AA-cross-crate-reexports">bugs related to cross-crate re-exports</a>, and I suspect many of these are due to local and external definitions having totally different codepaths.</p>
<p>However, type aliases no longer exist in <code>ty::Ty</code>s—they are expanded away—but rustdoc currently keeps type aliases unexpanded when it would improve the docs reading experience. (FWIW, I'm pretty sure that re-exported functions that use type aliases always have them expanded, since re-exports should use the <code>ty</code> codepath.)</p>
<p>I would really like to get rid of (a lot of) the HIR cleaning code, but I'm a bit stuck on how to deal with the type aliases situation. Does anyone have ideas on how to deal with this?</p>



<a name="264111418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/reducing%20duplication/near/264111418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/reducing.20duplication.html#264111418">(Dec 08 2021 at 04:40)</a>:</h4>
<p>Perhaps we should just always expand type aliases? It would at least make rustdoc's behavior consistent between local and external definitions, though it might regress the UX somewhat.</p>



<a name="264111436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/reducing%20duplication/near/264111436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/reducing.20duplication.html#264111436">(Dec 08 2021 at 04:40)</a>:</h4>
<p><span class="user-mention" data-user-id="307537">@Noah Lev</span> slightly correction - re-exported functions <em>from other crates</em> use the <code>ty</code> codepath. I'd expect local re-exports to preserve type aliases. Everything else looks right though.</p>
<p>What uses type aliases? We could at least switch everything that doesn't use clean::Type</p>



<a name="264111471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/reducing%20duplication/near/264111471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/reducing.20duplication.html#264111471">(Dec 08 2021 at 04:41)</a>:</h4>
<p>Yeah, when I said "re-exports" I meant "cross-crate re-exports" <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="264111525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/reducing%20duplication/near/264111525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/reducing.20duplication.html#264111525">(Dec 08 2021 at 04:42)</a>:</h4>
<p>(Maybe we should use an acronym, like CCRE)</p>



<a name="264111527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/reducing%20duplication/near/264111527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/reducing.20duplication.html#264111527">(Dec 08 2021 at 04:42)</a>:</h4>
<p>Another alternative is to change rustc to preserve type alias info in metadata</p>



<a name="264111542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/reducing%20duplication/near/264111542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/reducing.20duplication.html#264111542">(Dec 08 2021 at 04:42)</a>:</h4>
<p>Hmm, my understanding was that type-checking just always expands type aliases</p>



<a name="264111552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/reducing%20duplication/near/264111552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/reducing.20duplication.html#264111552">(Dec 08 2021 at 04:43)</a>:</h4>
<blockquote>
<p>What uses type aliases? We could at least switch everything that doesn't use clean::Type</p>
</blockquote>
<p>Not sure what you mean by "What use type aliases?". Could you elaborate?</p>



<a name="264111579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/reducing%20duplication/near/264111579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/reducing.20duplication.html#264111579">(Dec 08 2021 at 04:43)</a>:</h4>
<p>"what code paths would have a user facing impact by switching to <code>ty</code>"?</p>



<a name="264111636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/reducing%20duplication/near/264111636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/reducing.20duplication.html#264111636">(Dec 08 2021 at 04:44)</a>:</h4>
<p>I imagine any place where type signatures occur: functions, traits, struct fields, etc.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>