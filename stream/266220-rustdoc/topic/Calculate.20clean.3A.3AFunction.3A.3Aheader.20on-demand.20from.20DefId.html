<html>
<head><meta charset="utf-8"><title>Calculate clean::Function::header on-demand from DefId · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html">Calculate clean::Function::header on-demand from DefId</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260538043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/260538043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#260538043">(Nov 06 2021 at 21:49)</a>:</h4>
<p>Hi, I'm working on issue <a href="https://github.com/rust-lang/rust/issues/89673">#89673</a><br>
I'm quite new to rustc and rustdoc.<br>
I'm trying to understand how to get rid of <code>clean::Function::header</code> and calculate it from the <code>DefId</code>.<br>
Could you please direct me toward a place where I can look to find how that can be done?</p>
<p>Thanks!</p>



<a name="260538473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/260538473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#260538473">(Nov 06 2021 at 21:59)</a>:</h4>
<p>Look for <code>clean_fn_or_proc_macro</code> in <code>clean/mod.rs</code></p>



<a name="260538483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/260538483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#260538483">(Nov 06 2021 at 21:59)</a>:</h4>
<p>it calls <code>let mut func = (sig, generics, body_id).clean(cx);</code></p>



<a name="260538492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/260538492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#260538492">(Nov 06 2021 at 21:59)</a>:</h4>
<p><code>sig</code> contains a <code>header</code> field, that's the one you're looking for</p>



<a name="260600750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/260600750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#260600750">(Nov 07 2021 at 23:02)</a>:</h4>
<p><span class="user-mention" data-user-id="210316">@GuillaumeGomez</span> Thank you!</p>



<a name="262071378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262071378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262071378">(Nov 19 2021 at 14:17)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="210316">@GuillaumeGomez</span>,<br>
the <code>sig</code> in <code>clean/mod.rs</code> is a <code>hir::FnSig</code>, but the sig in the function I'm working on (<code>build_external_function</code>) is a <code>ty::FnSig</code>, which does not contain a <code>header</code> field. Is there a way to convert the <code>ty::FnSig</code> to a <code>hir::FnSig</code>?<br>
I tried using the <code>fn_sig_by_hir_id</code>, but I could not retrieve the <code>HirId</code> for the external function's <code>DefId</code> as it is non-local (<code>did.as_local</code> fails), and thus the <code>local_def_id_to_hir_id</code> function doesn't work with it.</p>
<p>Thanks!</p>



<a name="262072924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262072924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262072924">(Nov 19 2021 at 14:29)</a>:</h4>
<p><span class="user-mention" data-user-id="452510">@Yuval Dolev</span> I'd suggest changing the function in clean to take a <code>ty</code> header instead of HIR, HIR is only available for the local crate. You should be able to get the same info from a function on TyCtxt taking DefId (not sure which without looking it up)</p>



<a name="262080927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262080927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262080927">(Nov 19 2021 at 15:26)</a>:</h4>
<p>E.g., for constness we'd want to use something like <code>tcx.is_const_fn</code>.</p>



<a name="262088822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262088822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262088822">(Nov 19 2021 at 16:18)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> <span class="user-mention" data-user-id="307537">@Noah Lev</span> Thanks!</p>



<a name="262092799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262092799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262092799">(Nov 19 2021 at 16:45)</a>:</h4>
<p>Ok, so in this issue should I remove the <code>header</code> field from the <code>clean::Function</code> struct, and then calculate it using the <code>DefId</code>?<br>
Thank you!</p>



<a name="262093987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262093987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262093987">(Nov 19 2021 at 16:52)</a>:</h4>
<p>yes, that's the goal</p>



<a name="262136910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262136910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262136910">(Nov 19 2021 at 22:07)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> Great, thanks!</p>



<a name="262202985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262202985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262202985">(Nov 20 2021 at 20:28)</a>:</h4>
<p>Hi, what's the best way to retrieve the <code>unsafety</code> property for a function based on its <code>DefId</code>?</p>



<a name="262203533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262203533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262203533">(Nov 20 2021 at 20:41)</a>:</h4>
<p><span class="user-mention" data-user-id="452510">@Yuval Dolev</span> I think <code>tcx.type_of(fn_def_id).fn_sig(tcx).unsafety</code> should work</p>



<a name="262203603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262203603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262203603">(Nov 20 2021 at 20:43)</a>:</h4>
<p>Just be careful to only call it on function-like types (function items, closures, or function pointers)</p>



<a name="262203616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262203616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262203616">(Nov 20 2021 at 20:43)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> Will try it, thanks!</p>



<a name="262653701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262653701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262653701">(Nov 25 2021 at 00:07)</a>:</h4>
<p>Hi!<br>
What about the <code>rustdoc-json-types</code> <code>Function</code> struct, it also has a <code>header</code> field, should it be removed as well?</p>
<p>Thanks!</p>



<a name="262653812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262653812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262653812">(Nov 25 2021 at 00:09)</a>:</h4>
<p>No, rustdoc-json-types is a public API</p>



<a name="262653834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262653834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262653834">(Nov 25 2021 at 00:09)</a>:</h4>
<p>Great, thank you!</p>



<a name="262654085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262654085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262654085">(Nov 25 2021 at 00:13)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> <br>
What should I do with the <code>FromWithTcx&lt;clean::Function&gt;::from_tcx</code> function, as it doesn't receive a <code>DefId</code> from which I can calculate the header?</p>



<a name="262655085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262655085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262655085">(Nov 25 2021 at 00:29)</a>:</h4>
<p><span class="user-mention" data-user-id="452510">@Yuval Dolev</span> Just replace it with an ordinary function (e.g., something like <code>fn convert_function(...) -&gt; ... { ... }</code>) that takes a <code>DefId</code> and a <code>clean::Function</code>.</p>



<a name="262655465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Calculate%20clean%3A%3AFunction%3A%3Aheader%20on-demand%20from%20DefId/near/262655465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yuval Dolev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Calculate.20clean.3A.3AFunction.3A.3Aheader.20on-demand.20from.20DefId.html#262655465">(Nov 25 2021 at 00:35)</a>:</h4>
<p>Got it, will do, thank you!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>