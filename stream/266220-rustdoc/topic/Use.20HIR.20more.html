<html>
<head><meta charset="utf-8"><title>Use HIR more · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html">Use HIR more</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269355152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269355152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269355152">(Jan 26 2022 at 02:31)</a>:</h4>
<p>After fixing the one rustdoc JSON ICE, I found that some other similar ICEs still occur, as many places end up using the ty architecture instead of HIR. It might be nice to use HIR more when possible, and there seem to be a couple ways to go about it. I could add checks for locality to the top of ty based methods, alternatively, it might be nice to refactor a bit, and mostly pass around DefId with the necessary information not needing to be passed into the function, but calculated on demand. There are surely other options too. Thoughts?</p>



<a name="269439647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269439647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269439647">(Jan 26 2022 at 16:29)</a>:</h4>
<p>What I think would look really nice is clean using a more query-like system on the context, so I can request 'a cleaned function' and it always goes through one code path, and gets cached for the future.</p>



<a name="269483617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269483617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269483617">(Jan 26 2022 at 21:17)</a>:</h4>
<p>We should <em>not</em> be using HIR more; we should be using <em>ty</em> more.</p>



<a name="269483679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269483679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269483679">(Jan 26 2022 at 21:17)</a>:</h4>
<p>HIR is missing a lot of semantic information, and it's only available for the local crate, which creates inconsistencies when there are cross-crate re-exports.</p>



<a name="269483706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269483706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269483706">(Jan 26 2022 at 21:17)</a>:</h4>
<p>My ultimate goal is to stop using HIR altogether, and only use <code>ty</code>.</p>



<a name="269483768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269483768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269483768">(Jan 26 2022 at 21:18)</a>:</h4>
<p>Why would it be better to use HIR for your use case?</p>



<a name="269484907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269484907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269484907">(Jan 26 2022 at 21:26)</a>:</h4>
<p>Ty and HIR are inconsistent locally due to ty not having a distinction between return default and return empty tuple, and trait implementation visibility is slightly different. Also currently ty doesn't match up with HIR for self parameters, though I think that's due to a weird special case in the clean function for method defs where it always uses an empty array of param names if the cleaned method is local?</p>



<a name="269485104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269485104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269485104">(Jan 26 2022 at 21:27)</a>:</h4>
<p>The Self issue is probably a rustdoc issue rather than a rustc one</p>



<a name="269485121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269485121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269485121">(Jan 26 2022 at 21:27)</a>:</h4>
<p>Yeah, that's why I separated it from the other two</p>



<a name="269485177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269485177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269485177">(Jan 26 2022 at 21:28)</a>:</h4>
<p>Regarding the return default vs return <code>()</code>, why not just normalize it in rustdoc to return default?</p>



<a name="269485221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269485221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269485221">(Jan 26 2022 at 21:28)</a>:</h4>
<p>And for the trait visibility, rustdoc just can do some post-processing to mark the methods as inherited visibility (which is what it does already I believe)</p>



<a name="269485281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269485281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269485281">(Jan 26 2022 at 21:29)</a>:</h4>
<p>If we can avoid it, IMO we shouldn't add more uses of HIR</p>



<a name="269485607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269485607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269485607">(Jan 26 2022 at 21:31)</a>:</h4>
<p>I just added more HIR to blanket impls to fix a JSON ICE, but I'd be willing to go the other direction just as well. The big thing is that blanket impls don't follow the normal clean code path, and currently fail tests if I try to use it. If we want to move towards <code>ty</code> more though, I'm down to work on tracking down the issues and see if it can unify more.</p>



<a name="269485716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269485716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269485716">(Jan 26 2022 at 21:32)</a>:</h4>
<p>The names which are probably an us thing, I know where to start on as I mentioned I saw the code that does it, I may try tracking down why it does it that way and if it can be fixed.</p>



<a name="269485796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269485796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269485796">(Jan 26 2022 at 21:33)</a>:</h4>
<p>The main issue with <code>ty</code> that I'm not sure how to solve is that type aliases are not preserved</p>



<a name="269485825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269485825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269485825">(Jan 26 2022 at 21:33)</a>:</h4>
<p>Other than that, I think we should be able to post-process it as needed</p>



<a name="269487973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269487973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269487973">(Jan 26 2022 at 21:52)</a>:</h4>
<p>Update: Check for 'is_local' appears to be because one caller uses <code>DefId::local(CRATE_DEF_INDEX)</code> as a sentinel for fn pointers / etc, which don't have arg names. This seems to be a very odd choice of sentinel value instead of, say, <code>None</code>, as it would also break if the def id was ever used in a new way in the future. I'll see if that's the whole issue or not.</p>



<a name="269489550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269489550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269489550">(Jan 26 2022 at 22:03)</a>:</h4>
<p>Yeah, removing junk like that will probably make the ty transition easier :)</p>



<a name="269490263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269490263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269490263">(Jan 26 2022 at 22:09)</a>:</h4>
<p>Looks like the sentinel can be cleanly swapped for None. I'll be working on that and some other changes to fix ty stuff</p>



<a name="269490308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Use%20HIR%20more/near/269490308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Use.20HIR.20more.html#269490308">(Jan 26 2022 at 22:09)</a>:</h4>
<p>I can try to review PRs related to that if you assign me :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>