<html>
<head><meta charset="utf-8"><title>`impl` stripping in `CacheBuilder::fold_item` · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html">`impl` stripping in `CacheBuilder::fold_item`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276731253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/276731253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#276731253">(Mar 26 2022 at 15:30)</a>:</h4>
<p>Hi all. I am working on <a href="https://github.com/rust-lang/rust/pull/82014">https://github.com/rust-lang/rust/pull/82014</a> on and off to try and finally close it out (can't believe it's been a full year). I am actually very close to having it working, at least unreliably with some false negatives. The last problem I'm running into is that <code>Cache::populate</code> is destructive: when <code>CacheBuilder::fold_item</code> runs, it removes all <code>impl</code> items from the crate: <a href="https://github.com/rust-lang/rust/blob/bc881e83d1cced71046e844fa55c0b0e9f9af382/src/librustdoc/formats/cache.rs#L473">https://github.com/rust-lang/rust/blob/bc881e83d1cced71046e844fa55c0b0e9f9af382/src/librustdoc/formats/cache.rs#L473</a><br>
As a result, when the intra-doc links pass runs, it no longer sees documentation from impl blocks at <em>all</em> - for the program below, it reports no warnings or errors.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">S</span><span class="p">;</span><span class="w"></span>

<span class="sd">/// [type@S::h]</span>
<span class="c1">//~^ ERROR unresolved link</span>
<span class="c1">//~| HELP to link to the associated function</span>
<span class="c1">//~| NOTE not in the type namespace</span>
<span class="k">impl</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">h</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I tried changing CacheBuilder to no longer be destructive, by returning <code>Some(item)</code> in <code>fold_item</code> unconditionally, and that breaks other things for reasons I don't understand:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">---</span><span class="w"> </span><span class="n">stderr</span><span class="w"> </span><span class="o">-------------------------------</span><span class="w"></span>
<span class="mi">5</span>: <span class="o">@!</span><span class="n">has</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="n">failed</span><span class="w"></span>
<span class="w">        </span><span class="err">`</span><span class="n">PATTERN</span><span class="err">`</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="k">match</span><span class="w"></span>
<span class="w">        </span><span class="c1">// @!has foo/index.html 'Implementations'</span>

<span class="n">Encountered</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">errors</span><span class="w"></span>
<span class="o">------------------------------------------</span><span class="w"></span>

<span class="n">failures</span>:
    <span class="p">[</span><span class="n">rustdoc</span><span class="p">]</span><span class="w"> </span><span class="n">rustdoc</span><span class="o">/</span><span class="n">module</span><span class="o">-</span><span class="n">impls</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
</code></pre></div>
<p>Does anyone know what code in rustdoc depends on <code>Impl</code> items after running passes?</p>



<a name="276731316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/276731316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#276731316">(Mar 26 2022 at 15:32)</a>:</h4>
<p>(well, "last problem" is probably overoptimistic, since I made this change on master and saw fewer failures than before ... but this is the one I'm currently stuck on :P)</p>



<a name="276731727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/276731727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#276731727">(Mar 26 2022 at 15:42)</a>:</h4>
<p>I see that "Implementations" comes from <code>ItemSection::Name</code> in <code>html::render</code>; I'll try tracing back from there</p>



<a name="276735636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/276735636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#276735636">(Mar 26 2022 at 17:08)</a>:</h4>
<p>to be clear, the reason I think this question makes sense (as opposed to "what code uses Impl?", which could be anything) is because there should have been <em>no</em> <code>Impl</code> items before, because they were all removed. So whatever code is generating <code>Implementations</code> must have been dead code before I made this change.</p>



<a name="276745923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/276745923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#276745923">(Mar 26 2022 at 21:08)</a>:</h4>
<p>oh fun, it turns out there are a bunch of other <code>Impl</code>s from other crates being injected somewhere:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">DEBUG</span><span class="w"> </span><span class="n">rustdoc</span>::<span class="n">fold</span><span class="w"> </span><span class="n">rustdoc</span>::<span class="n">passes</span>::<span class="n">unindent_comments</span>::<span class="n">CommentCleaner</span>: <span class="nc">before</span><span class="w"> </span><span class="n">folding</span><span class="w"> </span><span class="n">module</span>: <span class="p">[</span><span class="n">Item</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span>: <span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">visibility</span>: <span class="nc">Restricted</span><span class="p">(</span><span class="n">DefId</span><span class="p">(</span><span class="mi">1</span>:<span class="mi">7256</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">std</span><span class="p">[</span><span class="n">be90</span><span class="p">]</span>::<span class="n">path</span><span class="p">)),</span><span class="w"> </span><span class="n">def_id</span>: <span class="nc">DefId</span><span class="p">(</span><span class="n">DefId</span><span class="p">(</span><span class="mi">1</span>:<span class="mi">7653</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">std</span><span class="p">[</span><span class="n">be90</span><span class="p">]</span>::<span class="n">path</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">71</span><span class="p">})),</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">Impl</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">Item</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span>: <span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">visibility</span>: <span class="nc">Restricted</span><span class="p">(</span><span class="n">DefId</span><span class="p">(</span><span class="mi">1</span>:<span class="mi">3040</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">std</span><span class="p">[</span><span class="n">be90</span><span class="p">]</span>::<span class="n">ffi</span>::<span class="n">os_str</span><span class="p">)),</span><span class="w"> </span><span class="n">def_id</span>: <span class="nc">DefId</span><span class="p">(</span><span class="n">DefId</span><span class="p">(</span><span class="mi">1</span>:<span class="mi">3238</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">std</span><span class="p">[</span><span class="n">be90</span><span class="p">]</span>::<span class="n">ffi</span>::<span class="n">os_str</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">44</span><span class="p">})),</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">Impl</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">Item</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span>: <span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">visibility</span>: <span class="nc">Restricted</span><span class="p">(</span><span class="n">DefId</span><span class="p">(</span><span class="mi">1</span>:<span class="mi">2823</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">std</span><span class="p">[</span><span class="n">be90</span><span class="p">]</span>::<span class="n">ffi</span>::<span class="n">c_str</span><span class="p">)),</span><span class="w"> </span><span class="n">def_id</span>: <span class="nc">DefId</span><span class="p">(</span><span class="n">DefId</span><span class="p">(</span><span class="mi">1</span>:<span class="mi">3022</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">std</span><span class="p">[</span><span class="n">be90</span><span class="p">]</span>::<span class="n">ffi</span>::<span class="n">c_str</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">43</span><span class="p">})),</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">Impl</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">Item</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span>: <span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">visibility</span>: <span class="nc">Restricted</span><span class="p">(</span><span class="n">DefId</span><span class="p">(</span><span class="mi">1</span>:<span class="mi">7256</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">std</span><span class="p">[</span><span class="n">be90</span><span class="p">]</span>::<span class="n">path</span><span class="p">)),</span><span class="w"> </span><span class="n">def_id</span>: <span class="nc">DefId</span><span class="p">(</span><span class="n">DefId</span><span class="p">(</span><span class="mi">1</span>:<span class="mi">7650</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">std</span><span class="p">[</span><span class="n">be90</span><span class="p">]</span>::<span class="n">path</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">69</span><span class="p">})),</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">Impl</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">Item</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">name</span>: <span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">visibility</span>: <span class="nc">Restricted</span><span class="p">(</span><span class="n">DefId</span><span class="p">(</span><span class="mi">1</span>:<span class="mi">3040</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">std</span><span class="p">[</span><span class="n">be90</span><span class="p">]</span>::<span class="n">ffi</span>::<span class="n">os_str</span><span class="p">)),</span><span class="w"> </span><span class="n">def_id</span>: <span class="nc">DefId</span><span class="p">(</span><span class="n">DefId</span><span class="p">(</span><span class="mi">1</span>:<span class="mi">3229</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">std</span><span class="p">[</span><span class="n">be90</span><span class="p">]</span>::<span class="n">ffi</span>::<span class="n">os_str</span>::<span class="p">{</span><span class="k">impl</span>#<span class="mi">41</span><span class="p">})),</span><span class="w"> </span><span class="n">kind</span>: <span class="nc">Impl</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
</code></pre></div>



<a name="276745944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/276745944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#276745944">(Mar 26 2022 at 21:09)</a>:</h4>
<p>actually hold on I'm doing this the hard way, I can just strip all impls after the intra-doc links pass sees them</p>



<a name="276746339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/276746339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#276746339">(Mar 26 2022 at 21:18)</a>:</h4>
<p>YES ok that worked</p>



<a name="276799092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/276799092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Manish Goregaokar <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#276799092">(Mar 27 2022 at 17:43)</a>:</h4>
<p>hahaha i hate this part of the code, good luck!</p>



<a name="276799259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/276799259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#276799259">(Mar 27 2022 at 17:47)</a>:</h4>
<p>I actually fixed this part and then found that <code>href()</code> is buggy for unrelated reasons lol</p>



<a name="276799305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/276799305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#276799305">(Mar 27 2022 at 17:48)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/runs/5705843690?check_suite_focus=true#step:26:3569">https://github.com/rust-lang/rust/runs/5705843690?check_suite_focus=true#step:26:3569</a> giving up on it for now, maybe someday when <a href="https://github.com/rust-lang/rust/issues/86798">https://github.com/rust-lang/rust/issues/86798</a> is fixed</p>



<a name="277801218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/277801218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#277801218">(Apr 04 2022 at 22:14)</a>:</h4>
<p>I also really dislike the Cache, so happy to help with any cleanups relating to it!</p>



<a name="277806706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/277806706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#277806706">(Apr 04 2022 at 23:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60/near/276799305">said</a>:</p>
<blockquote>
<p><a href="https://github.com/rust-lang/rust/runs/5705843690?check_suite_focus=true#step:26:3569">https://github.com/rust-lang/rust/runs/5705843690?check_suite_focus=true#step:26:3569</a> giving up on it for now, maybe someday when <a href="https://github.com/rust-lang/rust/issues/86798">https://github.com/rust-lang/rust/issues/86798</a> is fixed</p>
</blockquote>
<p>so I remember - the errors here are non-nonsensical things like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span>: <span class="nc">documentation</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="n">boxed</span><span class="err">`</span><span class="w"> </span><span class="n">links</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="err">`</span><span class="bp">self</span>::<span class="n">alloc</span>::<span class="n">Layout</span>::<span class="n">for_value</span><span class="err">`</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">documentation</span><span class="w"> </span><span class="n">generated</span><span class="w"></span>
<span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">library</span><span class="o">/</span><span class="n">alloc</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">boxed</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">130</span>:<span class="mi">37</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="mi">130</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="sd">//! [`Layout::for_value(&amp;*value)`]: crate::alloc::Layout::for_value</span>
<span class="w">    </span><span class="o">|</span><span class="w">                                     </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">documented</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="err">`</span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="n">rustdoc</span>::<span class="n">private</span><span class="o">-</span><span class="n">intra</span><span class="o">-</span><span class="n">doc</span><span class="o">-</span><span class="n">links</span><span class="err">`</span><span class="w"> </span><span class="n">implied</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="err">`</span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="n">warnings</span><span class="err">`</span><span class="w"></span>
<span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="err">`</span><span class="bp">self</span>::<span class="n">alloc</span>::<span class="n">Layout</span>::<span class="n">for_value</span><span class="err">`</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">re</span><span class="o">-</span><span class="n">exports</span><span class="w"> </span><span class="n">marked</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="err">`</span><span class="cp">#[doc(no_inline)]</span><span class="err">`</span><span class="w"></span>
</code></pre></div>
<p>which occur because <code>cache.paths</code> and <code>cache.external_paths</code> are missing the item and so <code>href</code> returns <code>HrefError::NotInExternalCache</code>: <a href="https://github.com/rust-lang/rust/blob/60e50fc1cfe0bb693a5f4f93eb83ef70854531e3/src/librustdoc/html/format.rs#L584">https://github.com/rust-lang/rust/blob/60e50fc1cfe0bb693a5f4f93eb83ef70854531e3/src/librustdoc/html/format.rs#L584</a>. Don't know why it's not in cache.</p>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60/near/277801218">said</a>:</p>
<blockquote>
<p>I also really dislike the Cache, so happy to help with any cleanups relating to it!</p>
</blockquote>
<p>I am probably not going to work on it myself. But if you want to open issues for it, these are the places <code>href</code> depends on the cache:</p>
<ul>
<li><a href="https://github.com/rust-lang/rust/blob/d33d01473649e764f05eacceb7d59a1b66cd2b60/src/librustdoc/html/format.rs#L581-L587">https://github.com/rust-lang/rust/blob/d33d01473649e764f05eacceb7d59a1b66cd2b60/src/librustdoc/html/format.rs#L581-L587</a>:</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">did</span><span class="p">.</span><span class="n">is_local</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">cache</span><span class="p">.</span><span class="n">access_levels</span><span class="p">.</span><span class="n">is_public</span><span class="p">(</span><span class="n">did</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">cache</span><span class="p">.</span><span class="n">document_private</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">cache</span><span class="p">.</span><span class="n">primitive_locations</span><span class="p">.</span><span class="n">values</span><span class="p">().</span><span class="n">any</span><span class="p">(</span><span class="o">|&amp;</span><span class="n">id</span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">did</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">HrefError</span>::<span class="n">Private</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This one seems reasonable, except that we should kill <code>access_levels</code> with fire now that the <code>privacy_access_levels</code> is reliable.</p>
<ul>
<li><a href="https://github.com/rust-lang/rust/blob/d33d01473649e764f05eacceb7d59a1b66cd2b60/src/librustdoc/html/format.rs#L590-L597">https://github.com/rust-lang/rust/blob/d33d01473649e764f05eacceb7d59a1b66cd2b60/src/librustdoc/html/format.rs#L590-L597</a>:</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">fqp</span><span class="p">,</span><span class="w"> </span><span class="n">shortty</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">url_parts</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="n">paths</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">did</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">fqp</span><span class="p">,</span><span class="w"> </span><span class="n">shortty</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">fqp</span><span class="p">,</span><span class="w"> </span><span class="n">shortty</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">module_fqp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">to_module_fqp</span><span class="p">(</span><span class="n">shortty</span><span class="p">,</span><span class="w"> </span><span class="n">fqp</span><span class="p">.</span><span class="n">as_slice</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="o">?</span><span class="n">fqp</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">shortty</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">module_fqp</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">href_relative_parts</span><span class="p">(</span><span class="n">module_fqp</span><span class="p">,</span><span class="w"> </span><span class="n">relative_to</span><span class="p">).</span><span class="n">collect</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">}),</span><span class="w"></span>
<span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">fqp</span><span class="p">,</span><span class="w"> </span><span class="n">shortty</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="n">external_paths</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">did</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>These are the most suspicious. I have no idea what <code>paths</code> and <code>external_paths</code> actually are; it's certainly not "things rustdoc knows about" because as CI shows, there's plenty of things with documentation not in <code>paths</code>.</p>
<ul>
<li><a href="https://github.com/rust-lang/rust/blob/d33d01473649e764f05eacceb7d59a1b66cd2b60/src/librustdoc/html/format.rs#L602-L614">https://github.com/rust-lang/rust/blob/d33d01473649e764f05eacceb7d59a1b66cd2b60/src/librustdoc/html/format.rs#L602-L614</a></li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                    </span><span class="k">match</span><span class="w"> </span><span class="n">cache</span><span class="p">.</span><span class="n">extern_locations</span><span class="p">[</span><span class="o">&amp;</span><span class="n">did</span><span class="p">.</span><span class="n">krate</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>This one is also reasonable; it would be nice to calculate on-demand but it's unlikely to be buggy.</p>



<a name="277807368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/277807368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#277807368">(Apr 04 2022 at 23:23)</a>:</h4>
<blockquote>
<p>This one seems reasonable, except that we should kill access_levels with fire now that the privacy_access_levels is reliable.</p>
</blockquote>
<p>oh, it's taking doc(hidden) into account. Still kinda sketchy, but no obvious replacement for what it does.</p>



<a name="277823889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/277823889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#277823889">(Apr 05 2022 at 03:37)</a>:</h4>
<blockquote>
<p>These are the most suspicious. I have no idea what paths and external_paths actually are; it's certainly not "things rustdoc knows about" because as CI shows, there's plenty of things with documentation not in paths.</p>
</blockquote>
<p>this turned out to be quite difficult to change - I tried something as simple as calculating the <code>ItemType</code> from the <code>DefKind</code> instead of what <code>clean::ItemKind</code> it is, and even that failed several tests because rustdoc special cases so much in <code>clean</code></p>



<a name="277824756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/277824756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#277824756">(Apr 05 2022 at 03:55)</a>:</h4>
<blockquote>
<p>I have no idea what paths and external_paths actually are; it's certainly not "things rustdoc knows about" because as CI shows, there's plenty of things with documentation not in paths.</p>
</blockquote>
<p>That's weird... I also thought they were "items rustdoc knows about" <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span> </p>
<p>Guess I'll have to do some investigating at some point.</p>



<a name="277825795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60impl%60%20stripping%20in%20%60CacheBuilder%3A%3Afold_item%60/near/277825795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60impl.60.20stripping.20in.20.60CacheBuilder.3A.3Afold_item.60.html#277825795">(Apr 05 2022 at 04:16)</a>:</h4>
<p>Yeah :/ I opened that issue ages ago because it just seems fundamentally broken to me, I don't know how it can work</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>