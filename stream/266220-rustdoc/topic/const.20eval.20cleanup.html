<html>
<head><meta charset="utf-8"><title>const eval cleanup · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html">const eval cleanup</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264373972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264373972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264373972">(Dec 09 2021 at 22:05)</a>:</h4>
<p>The current state of how rustdoc displays constants is a bit of a mess. Some constants are displayed using their pretty-printed HIR syntax; others show both their HIR version and their fully-evaluated <code>ty</code> version; and still others (like inherent associated constants) don't show any value at all.</p>
<p>I'd like to start by at least no longer using the HIR. I explain my rationale <a href="https://github.com/rust-lang/rust/issues/83035#issuecomment-989336938">here</a>.</p>
<p>What do you all think?</p>



<a name="264374074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374074">(Dec 09 2021 at 22:06)</a>:</h4>
<p>Already approved on the issue I think? But just in case: I agree.</p>



<a name="264374114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374114">(Dec 09 2021 at 22:06)</a>:</h4>
<p>(By the way, I do recommend reading, or at least skimming, <a href="https://github.com/rust-lang/rust/issues/83035#issuecomment-989336938">the comment I linked above</a>, as it will provide helpful context.)</p>



<a name="264374149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374149">(Dec 09 2021 at 22:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="210316">GuillaumeGomez</span> <a href="#narrow/stream/266220-rustdoc/topic/const.20eval.20cleanup/near/264374074">said</a>:</p>
<blockquote>
<p>Already approved on the issue I think? But just in case: I agree.</p>
</blockquote>
<p>Well, that was back in March, so I wasn't sure if your opinion had changed ;)</p>



<a name="264374191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374191">(Dec 09 2021 at 22:07)</a>:</h4>
<p>Also, I do have working local code that implements most of this change.</p>



<a name="264374226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374226">(Dec 09 2021 at 22:07)</a>:</h4>
<p>One issue is that for, e.g., const generics, what happens if we don't know how to pretty-print the <code>ty::Const</code>? E.g., if it's an ADT?</p>



<a name="264374308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374308">(Dec 09 2021 at 22:08)</a>:</h4>
<p>Like, what if there's a function</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">MyGenericType</span><span class="o">&lt;</span><span class="nb">Some</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>?</p>



<a name="264374332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374332">(Dec 09 2021 at 22:08)</a>:</h4>
<p>(Currently unstable, but IIUC it's implemented and will be eventually stabilized.)</p>



<a name="264374514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374514">(Dec 09 2021 at 22:10)</a>:</h4>
<p>You can mark it as "FIXME" in the implementation and open an issue for this case. It's fine to come back to it later on and work on this in more than one PR</p>



<a name="264374621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374621">(Dec 09 2021 at 22:11)</a>:</h4>
<p><span class="user-mention" data-user-id="210316">@GuillaumeGomez</span> I don't think that's a good fit here - this is a significant amount of work, we should have at least an idea of how we'll eventually implement it so we don't end up reverting it</p>



<a name="264374776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374776">(Dec 09 2021 at 22:12)</a>:</h4>
<p>I saw that as a corner-case that could be handled later on but if it's not the case then we indeed need to have something before doing it.</p>



<a name="264374786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374786">(Dec 09 2021 at 22:12)</a>:</h4>
<p>Well, actually, the compiler has some way of rendering these:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(adt_const_params)]</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">MyGenericType</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">X</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">MyGenericType</span><span class="o">&lt;</span><span class="p">{</span><span class="nb">Some</span><span class="p">(</span><span class="mi">42</span><span class="p">)}</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">MyGenericType</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">MyGenericType</span><span class="o">&lt;</span><span class="p">{</span><span class="nb">None</span><span class="p">}</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>error[E0308]: mismatched types
  --&gt; src/main.rs:10:36
   |
10 |     let _: MyGenericType&lt;{None}&gt; = foo();
   |            ---------------------   ^^^^^ expected `Option::&lt;i32&gt;::None`, found `Option::&lt;i32&gt;::Some(42_i32)`
   |            |
   |            expected due to this
   |
   = note: expected struct `MyGenericType&lt;Option::&lt;i32&gt;::None&gt;`
              found struct `MyGenericType&lt;Option::&lt;i32&gt;::Some(42_i32)&gt;`
</code></pre></div>



<a name="264374808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264374808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264374808">(Dec 09 2021 at 22:13)</a>:</h4>
<p>So we could probably reuse (some of) its code.</p>



<a name="264375067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264375067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264375067">(Dec 09 2021 at 22:14)</a>:</h4>
<p>Ok cool, that seems like a good candidate for a FIXME then :)</p>



<a name="264375585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264375585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264375585">(Dec 09 2021 at 22:18)</a>:</h4>
<p>... or just using that code altogether, rather than writing our own version of it :)</p>



<a name="264375740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264375740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264375740">(Dec 09 2021 at 22:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> <a href="#narrow/stream/266220-rustdoc/topic/const.20eval.20cleanup/near/264375585">said</a>:</p>
<blockquote>
<p>... or just using that code altogether, rather than writing our own version of it :)</p>
</blockquote>
<p>Be careful of that, we did that for attributes at some point and it didn't end well :)</p>



<a name="264376042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264376042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264376042">(Dec 09 2021 at 22:23)</a>:</h4>
<p>This code is used for rustc error messages, so it seems "more okay" than using the HIR pretty-printer.</p>



<a name="264376258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264376258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264376258">(Dec 09 2021 at 22:25)</a>:</h4>
<p>It actually seems a bit difficult to get the machinery set up, so I'll just leave a FIXME for now</p>



<a name="264474604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264474604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Manish Goregaokar <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264474604">(Dec 10 2021 at 16:50)</a>:</h4>
<p>I'm extremely in favor of using the evaluated const and yeah we should just use the existing printing code</p>



<a name="264474654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264474654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Manish Goregaokar <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264474654">(Dec 10 2021 at 16:51)</a>:</h4>
<p>though we could also provide an attribute to let people pick the HIR behavior because the fully expanded type may be large</p>



<a name="264500721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/const%20eval%20cleanup/near/264500721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/const.20eval.20cleanup.html#264500721">(Dec 10 2021 at 20:04)</a>:</h4>
<p>I really don't think we should expose a knob to enable HIR behavior:</p>
<ul>
<li>Using HIR doesn't work for cross-crate re-exports.</li>
<li>It's an internal implementation detail.</li>
<li>I very much want to stop rustdoc from using HIR at all since it creates two separate codepaths and lots of inconsistencies. Exposing an attribute like what you suggest would make that impossible.</li>
</ul>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>