<html>
<head><meta charset="utf-8"><title>`#[test]` in rustdoc · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html">`#[test]` in rustdoc</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264242445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264242445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264242445">(Dec 09 2021 at 00:43)</a>:</h4>
<p>I have some rustdoc that looks like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">//! ```</span>
<span class="sd">//! #[global_allocator]</span>
<span class="sd">//! static ALLOC: dhat::Alloc = dhat::Alloc;</span>
<span class="sd">//!</span>
<span class="sd">//! #[test]</span>
<span class="sd">//! fn test1() {</span>
<span class="sd">//!     ...</span>
<span class="sd">//! }</span>
<span class="sd">//! ```</span>
</code></pre></div>
<p>It's showing how to write a test using the crate I'm working on. As written, <code>test1</code> doesn't get compiled and run as a rustdoc test during <code>cargo test</code> because of the <code>#[test]</code> attribute. I could remove that attribute to make it run, but then it's no longer a correct example.</p>
<p>Is there a way to square this circle?</p>



<a name="264243188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264243188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264243188">(Dec 09 2021 at 00:53)</a>:</h4>
<p>You could do</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="sd">//! # #[cfg_attr(FALSE,</span>
<span class="sd">//! #[test]</span>
<span class="sd">//! # )]</span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>which I think should disable the <code>#[test]</code> attribute for the doctest run, but still show it in the docs.</p>



<a name="264244361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264244361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264244361">(Dec 09 2021 at 01:12)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> I think you can just call <code>test1()</code> at the bottom of the example (and hide it from the docs if you want)</p>



<a name="264246130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246130">(Dec 09 2021 at 01:40)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> but <code>test1</code> isn't visible:</p>
<div class="codehilite"><pre><span></span><code>error[E0425]: cannot find function `test1` in this scope
  --&gt; src/lib.rs:258:1
   |
31 | test1();
   | ^^^^^ not found in this scope
</code></pre></div>



<a name="264246155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246155">(Dec 09 2021 at 01:41)</a>:</h4>
<p>that seems ... odd. does that also happen outside of a doctest?</p>



<a name="264246362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246362">(Dec 09 2021 at 01:44)</a>:</h4>
<p><span class="user-mention" data-user-id="307537">@Noah Lev</span> Yours is close, but it's a syntax error. This compiles, but generates weird looking docs:</p>
<div class="codehilite"><pre><span></span><code>//! # #[cfg_attr(FALSE,
//! test
//! # )]
</code></pre></div>



<a name="264246407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246407">(Dec 09 2021 at 01:45)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> this should work:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">//! # /*</span>
<span class="sd">//! #[test]</span>
<span class="sd">//! # */</span>
</code></pre></div>



<a name="264246413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246413">(Dec 09 2021 at 01:45)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> Outside how?</p>



<a name="264246420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246420">(Dec 09 2021 at 01:45)</a>:</h4>
<p>Aha</p>



<a name="264246421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246421">(Dec 09 2021 at 01:45)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> like in a normal crate that depends on your library</p>



<a name="264246600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246600">(Dec 09 2021 at 01:47)</a>:</h4>
<p><code>#[test]</code> means "ignore this unless you're the test runner", right?</p>



<a name="264246669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246669">(Dec 09 2021 at 01:48)</a>:</h4>
<p>I don't think so, no. <a href="https://doc.rust-lang.org/reference/attributes/testing.html#the-test-attribute">https://doc.rust-lang.org/reference/attributes/testing.html#the-test-attribute</a></p>



<a name="264246681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246681">(Dec 09 2021 at 01:49)</a>:</h4>
<blockquote>
<p>These functions are only compiled when in test mode.</p>
</blockquote>
<p>oh hmm</p>



<a name="264246687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246687">(Dec 09 2021 at 01:49)</a>:</h4>
<p>that doesn't match my experience?</p>



<a name="264246720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246720">(Dec 09 2021 at 01:49)</a>:</h4>
<p>Well, all I can say is that the <code>#[test]</code> function is skipped when running doc tests</p>



<a name="264246764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246764">(Dec 09 2021 at 01:50)</a>:</h4>
<p>The comment trick works, so thanks for that</p>



<a name="264246963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%60%23%5Btest%5D%60%20in%20rustdoc/near/264246963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc.html#264246963">(Dec 09 2021 at 01:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/266220-rustdoc/topic/.60.23.5Btest.5D.60.20in.20rustdoc/near/264246687">said</a>:</p>
<blockquote>
<p>that doesn't match my experience?</p>
</blockquote>
<p>I've often accidentally committed code where the <code>#[test]</code>s don't compile because I forgot to run them. I don't think unit tests are normally built as part of <code>cargo check/build</code>. Maybe a tool you use has been passing <code>--all-targets</code>?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>