<html>
<head><meta charset="utf-8"><title>json ICE breaking · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html">json ICE breaking</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267776996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267776996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267776996">(Jan 12 2022 at 19:52)</a>:</h4>
<p>Looking into <a href="https://github.com/rust-lang/rust/issues/83718">#83718</a>, thoughts so far:</p>
<ul>
<li>Less desugared looking item comes from cache.implementors, more desugared from cache.impls</li>
<li>Tracing back to where they came from, <code>CacheBuilder::fold_item</code></li>
<li>In that method, implementors is extended from the original item. impls is extended from the item <em>after</em> <code>fold_item_recur</code> is called</li>
</ul>



<a name="267777088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267777088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267777088">(Jan 12 2022 at 19:53)</a>:</h4>
<p>I'm going to see if moving the push to impls before that call is possible/changes anything</p>



<a name="267777519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267777519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267777519">(Jan 12 2022 at 19:56)</a>:</h4>
<p>I see, it seems it's done afterwards specifically because it wants to fold the generics first. The question is if maybe it can skip replacing visibility/default</p>



<a name="267778641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267778641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267778641">(Jan 12 2022 at 20:05)</a>:</h4>
<p>Nevermind, that call isn't what changes it. It appears twice in the original module provided to fold, already different. Need to trace back earlier</p>



<a name="267779130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267779130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267779130">(Jan 12 2022 at 20:09)</a>:</h4>
<p>Okay looks like clean::TraitItem and clean::ImplItem just don't agree on the exact value of the items they're implementing</p>



<a name="267780775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267780775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267780775">(Jan 12 2022 at 20:23)</a>:</h4>
<p>Alright so. As it stands, I have two options<br>
1) Try to dive into rustc and figure out why the HIR is different for impls vs traits. This may be a simple change, or it may be incredibly painful<br>
2) Change how json handles the equality check to instead check for equivalence, and/or pick the better impl. This would be time-consuming, but would avoid the problem entirely</p>



<a name="267780876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267780876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267780876">(Jan 12 2022 at 20:23)</a>:</h4>
<blockquote>
<p>HIR is different for impls vs traits.</p>
</blockquote>
<p>Do you mean different for inherent impls vs trait impls?</p>



<a name="267781436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267781436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267781436">(Jan 12 2022 at 20:28)</a>:</h4>
<p>I may actually still be confused. I was talking about between a TraitItem and an ImplItem, but that isn't actually this issue. The issue is that it's different between two instances of an ImplItem</p>



<a name="267781500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267781500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267781500">(Jan 12 2022 at 20:29)</a>:</h4>
<p>I realized I'm still not sure what exactly is going on, as it doesn't matter if the TraitItem and ImplItem disagree, but the ImplItem is inconsistent at two different points in the process.</p>



<a name="267781595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267781595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267781595">(Jan 12 2022 at 20:30)</a>:</h4>
<p>I think I might know a way to fix part of this; it seems like it may be related to <code>FnRetTy</code></p>



<a name="267781640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267781640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267781640">(Jan 12 2022 at 20:30)</a>:</h4>
<p>Or at least Joshua's MCVE is</p>



<a name="267781660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267781660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267781660">(Jan 12 2022 at 20:30)</a>:</h4>
<p>FnRetTy and Visibility are the two things</p>



<a name="267781694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267781694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267781694">(Jan 12 2022 at 20:30)</a>:</h4>
<p>And the self ty</p>



<a name="267781831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267781831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267781831">(Jan 12 2022 at 20:31)</a>:</h4>
<p>I may need to pause for a bit soon, but I'm probably going to go back to the beginning and try again to trace down why I'm getting two slightly different versions of the same ImplItem</p>



<a name="267781838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267781838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267781838">(Jan 12 2022 at 20:31)</a>:</h4>
<p>Sorry if this stream is hard to follow, I'm kind of thought-streaming as I go so I have a record of my thoughts, and in case someone is like 'Hey you just said something blatantly wrong / trivially solvable'</p>



<a name="267782725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267782725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267782725">(Jan 12 2022 at 20:38)</a>:</h4>
<p>thought-streaming is a great technique!</p>



<a name="267789083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267789083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267789083">(Jan 12 2022 at 21:31)</a>:</h4>
<p>Alright, so I get what Noah was saying better now. When the self ty is the generic, the method inside it is the 'unresolved' version. But for each specific impl, those are compiler generated, and it uses actual visibilities and return types instead of 'default' or 'inherited'</p>



<a name="267789163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267789163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267789163">(Jan 12 2022 at 21:32)</a>:</h4>
<p>I feel the real solution would be if it was possible to skip trying to document methods inside generated impls, but I'm not sure how that would be detected, especially given I'm not sure what rules there are about iteration orders</p>



<a name="267789356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267789356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267789356">(Jan 12 2022 at 21:34)</a>:</h4>
<p>Allowing equivalent but not equal types would be possible, but may introduce inconsistencies in user-seen output, where order in the code changes the output or such</p>



<a name="267789499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267789499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267789499">(Jan 12 2022 at 21:36)</a>:</h4>
<p>Third option, make Rust generated impls from blankets exactly match their parents, not resolving visibility or return type. This may be impossible or easy, but either way would involve compiler changes :P</p>



<a name="267790526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267790526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267790526">(Jan 12 2022 at 21:45)</a>:</h4>
<p>Actually, it is already detected whether it's a blanket. ItemId::Blanket vs ItemId::DefId</p>



<a name="267804262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267804262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267804262">(Jan 12 2022 at 23:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="319144">CraftSpider</span> <a href="#narrow/stream/266220-rustdoc/topic/json.20ICE.20breaking/near/267789083">said</a>:</p>
<blockquote>
<p>Alright, so I get what Noah was saying better now. When the self ty is the generic, the method inside it is the 'unresolved' version. But for each specific impl, those are compiler generated, and it uses actual visibilities and return types instead of 'default' or 'inherited'</p>
</blockquote>
<p>That's not really what I was saying, but it seems you figured it out anyway <span aria-label="stuck out tongue wink" class="emoji emoji-1f61c" role="img" title="stuck out tongue wink">:stuck_out_tongue_wink:</span></p>



<a name="267804290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267804290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267804290">(Jan 12 2022 at 23:46)</a>:</h4>
<p>I'm not sure what you mean by "unresolved"</p>



<a name="267804320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267804320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267804320">(Jan 12 2022 at 23:47)</a>:</h4>
<p>I think the issue here is that we should be generating <code>Inherited</code> visibility and <code>self</code> argument names for both impls</p>



<a name="267814629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267814629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267814629">(Jan 13 2022 at 02:02)</a>:</h4>
<p>So, the issue as far as I can tell is that the HIR we're given to clean already has <code>Public</code> instead of <code>Inherited</code> visibility. We could... Revert it in the clean pass, maybe? Turning public or empty tuple on a blanket impl back into the correct type. I'm not sure</p>



<a name="267814938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267814938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267814938">(Jan 13 2022 at 02:08)</a>:</h4>
<p>Clean doesn't use HIR for visibility anymore; it only uses <code>ty::Visibility</code> (computed visibility)</p>



<a name="267907444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267907444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267907444">(Jan 13 2022 at 18:03)</a>:</h4>
<p>I fixed the issue in general by avoiding documenting blanket impl children more than once, but I also see where the visibility quirk comes from - ty::Visibility is actually always public, but when cleaning, ImplItems get it set to 'inherited' in certain cases, and the code path for blanket impls is likely slightly different from the one for the actual impl</p>



<a name="267907593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267907593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267907593">(Jan 13 2022 at 18:04)</a>:</h4>
<p>There are a number of notes around the relevant code paths explaining some of what is going on, and implying this kind of thing could happen</p>



<a name="267915381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/json%20ICE%20breaking/near/267915381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/json.20ICE.20breaking.html#267915381">(Jan 13 2022 at 19:06)</a>:</h4>
<p>Yep, rustdoc has too many code paths — it's the root of most bugs ;)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>