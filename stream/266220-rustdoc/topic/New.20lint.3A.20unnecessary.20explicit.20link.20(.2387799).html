<html>
<head><meta charset="utf-8"><title>New lint: unnecessary explicit link (#87799) · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html">New lint: unnecessary explicit link (#87799)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252001150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252001150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marian <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252001150">(Sep 04 2021 at 13:33)</a>:</h4>
<p>Hi, I claimed this issue because it seemed like a good first one, and spent a few days looking at <code>collect_intra_doc_links</code> and around, starting from the point that was suggested in there (<code>resolve_link</code>).</p>
<p>I have one initial problem that is slowing down trying things and in general debugging/figuring out what's what. I figured I could execute these paths by creating a separate tiny cargo project, with one or two lines of docs on top of <code>main</code>, and use my stage 1 rustdoc on it. It's a pretty slow process: change a line in rustdoc, build, run it on another project. I doubt anyone works like that, what am I missing? Debug output is so thick I've had to change some lines to <code>info!</code> and I'm looking at that instead because it's more manageable. I feel there's some basic workflow thing I missed.</p>
<p>On that line, I also tried to find some unit tests that maybe would place me in that context, so that instead maybe i could just run some specific tests and get quicker feedback, but I'm afraid the unit tests cover rustdoc more generally, not the intra-doc links pass in particular, and the UI tests are probably going to be around the last things I'll be able to test :(</p>
<p>Finally, for something more concrete: i intend to add this check within <code>resolve_link</code>. In order to know whether <code>[Text](path::to::Text)</code> is equivalent to <code>[Text]</code>, I believe I would need to run the actual resolution (<code>resolve_with_disambiguator_cached</code>) a second time on a "made up" <code>MarkdownLink</code> and check if the returned <code>Res</code>'s <code>DefId</code> is equal to the one for the actual link. Does this make sense?</p>
<p>I have some more smaller questions but I think that's enough to start the topic. Thank you</p>



<a name="252003111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252003111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252003111">(Sep 04 2021 at 14:06)</a>:</h4>
<blockquote>
<p>It's a pretty slow process: change a line in rustdoc, build, run it on another project. I doubt anyone works like that, what am I missing? </p>
</blockquote>
<p>Nope, this is pretty much how I work <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> how long are the builds taking you? For me they're around 20 seconds for an incremental change.</p>
<blockquote>
<p>Debug output is so thick I've had to change some lines to info! and I'm looking at that instead because it's more manageable.</p>
</blockquote>
<p>What log variable are you setting? I usually use <code>RUSTDOC_LOG=rustdoc::passes::collect_intra_doc_links=debug</code>, which filters out both <code>trace!</code> logs and anything from other modules.</p>
<blockquote>
<p>On that line, I also tried to find some unit tests that maybe would place me in that context, so that instead maybe i could just run some specific tests and get quicker feedback, but I'm afraid the unit tests cover rustdoc more generally, not the intra-doc links pass in particular, and the UI tests are probably going to be around the last things I'll be able to test :(</p>
</blockquote>
<p>I don't think they would speed things up much anyway - you'd still have to build rustdoc to run the tests. Have you found the intra-doc link tests? You can run them with <code>x.py test src/test/rustdoc/intra-doc src/test/rustdoc-ui/intra-doc</code>, and they run reasonably quickly (~7 seconds for me). You can add your own UI test which means you don't have to switch between directories to test your changes.</p>
<blockquote>
<p>I believe I would need to run the actual resolution (resolve_with_disambiguator_cached) a second time on a "made up" MarkdownLink and check if the returned Res's DefId is equal to the one for the actual link.</p>
</blockquote>
<p>Hmm, I think you're right that you don't need all of <code>resolve_link</code>, just <code>resolve_with_disambiguator_cached</code>. You shouldn't need a full <code>MarkdownLink</code> though, just the module, disambiguator, and path_str. You should already have the module as a parameter, and you can get the disambiguator and path_str by calling <code>preprocess_link</code>.</p>



<a name="252005246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252005246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marian <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252005246">(Sep 04 2021 at 14:41)</a>:</h4>
<blockquote>
<p>how long are the builds taking you? For me they're around 20 seconds for an incremental change.</p>
</blockquote>
<p>Just checked, it took a little under a minute. It's not terribly bad, I just wanted to make sure there wasn't a better way i wasn't aware of. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> </p>
<blockquote>
<p>What log variable are you setting?</p>
</blockquote>
<p>Here's my janky debug one-liner: <code>rm -r -Force .\target\doc; $env:RUSTDOC_LOG = 'rustdoc::passes::collect_intra_doc_links=info'; $env:RUSTDOC = 'C:\src\rust\build\x86_64-pc-windows-msvc\stage1\bin\rustdoc.exe'; cargo doc</code> (i started doing this on windows/powershell and now i don't know how to set the variable for the entire session so I'm just setting it before the command). This is not so bad because in any case I can just turn <code>debug</code> into <code>info</code>. My problem with <code>debug</code> is that there is so much more activity besides the processing of my own test docs that it gets lost. Now that i'm writing this down, maybe i just need to pipe the output into a file </p>
<blockquote>
<p>Have you found the intra-doc link tests?</p>
</blockquote>
<p>I saw them, they run fairly quickly (30s for rustdoc tests, 6s for rustdoc-ui), but since I would've needed to (i think) create the new lint and be able to output the warning in order to make use of those tests, i kind of discarded that option for now.</p>
<p>I'll spend some more time on this and have some more questions soon. Thanks a lot for the help! it's much appreciated</p>



<a name="252005420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252005420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252005420">(Sep 04 2021 at 14:44)</a>:</h4>
<blockquote>
<p>since I would've needed to (i think) create the new lint and be able to output the warning in order to make use of those tests</p>
</blockquote>
<p>Hmm, I think you should be able to add a failing test even before you add the lint.</p>
<p>Have you been using <code>x.py check src/tools/rustdoc</code> btw? It's a lot faster than a full build.</p>



<a name="252005548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252005548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marian <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252005548">(Sep 04 2021 at 14:46)</a>:</h4>
<p>good points, both. I'll see if adding a test is an easier way to get my changes to run than running rustdoc on a separate project</p>



<a name="252015175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252015175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252015175">(Sep 04 2021 at 17:41)</a>:</h4>
<p>There's also a hybrid solution that avoids switching directories, which is what I often use: create a single-file crate (<code>foo.rs</code>, say) and then run <code>rustdoc +stage1 foo.rs</code>. I often do this if I want to quickly test something.</p>



<a name="252015191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252015191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252015191">(Sep 04 2021 at 17:42)</a>:</h4>
<p>So that single-file crate could just be this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">//! [Iterator](std::iter::Iterator)</span>
</code></pre></div>



<a name="252015230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252015230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252015230">(Sep 04 2021 at 17:42)</a>:</h4>
<p>that's assuming you have two terminals open though, right? at some point you need to run x.py build</p>



<a name="252015238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252015238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252015238">(Sep 04 2021 at 17:42)</a>:</h4>
<p>Yes, you do need to run <code>x build</code>.</p>



<a name="252015246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252015246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252015246">(Sep 04 2021 at 17:42)</a>:</h4>
<p>But it avoids having to switch directories</p>



<a name="252015250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252015250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252015250">(Sep 04 2021 at 17:42)</a>:</h4>
<p>Why would you need two terminals open?</p>



<a name="252015263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252015263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252015263">(Sep 04 2021 at 17:42)</a>:</h4>
<p>oh oh, you mean to put the single file in the checkout of rust-lang/rust</p>



<a name="252015275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252015275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252015275">(Sep 04 2021 at 17:43)</a>:</h4>
<p>Yes, that's what I usually do.</p>



<a name="252015286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252015286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252015286">(Sep 04 2021 at 17:43)</a>:</h4>
<p>I don't like doing that because the generated docs end up in <code>doc/</code> which adds untracked files. But I'm realizing now that the docs for rust-lang/rust live in <code>src/doc</code>, not <code>doc/</code>, so it's easy enough to run <code>rm -r doc</code>.</p>



<a name="252109249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252109249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marian <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252109249">(Sep 05 2021 at 23:28)</a>:</h4>
<p>Thanks again for the suggestions and the help. I've managed to get a more manageable test case with Noah's suggestion, and got a basic proof of concept.</p>
<p>Turns out that even <code>resolve_with_disambiguator_cached</code> is too much for this. Since this is just an attempt at resolving a hypothetical link, we don't need the resolution failure to be reported so maybe <code>resolve</code> will be enough. It seems there is useful resolving logic in <code>resolve_with_disambiguator</code>, trying with the given disambiguator first and otherwise trying all namespaces, that should also run when resolving the shortcut link, but unfortunately this method also reports diagnostics. Maybe it could just return <code>Result</code> without side effects, and its callers could handle the diagnostics output.</p>



<a name="252111861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252111861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252111861">(Sep 06 2021 at 00:20)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> seems reasonable to change, just a little tricky</p>



<a name="252219095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252219095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252219095">(Sep 06 2021 at 20:12)</a>:</h4>
<p>wait hold on I misread:</p>
<blockquote>
<p>It seems there is useful resolving logic in resolve_with_disambiguator, trying with the given disambiguator first and otherwise trying all namespaces, that should also run when resolving the shortcut link, but unfortunately this method also reports diagnostics. </p>
</blockquote>
<p>I don't think we need to retry with a different disambiguator; it seems really weird for anyone to write <code>[type@Iterator](type@std::iter::Iterator)</code>. Just trying the original link text seems fine.</p>



<a name="252219137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252219137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252219137">(Sep 06 2021 at 20:13)</a>:</h4>
<p>in particular, I don't think we should suggest changing <code>[Iterator](type@Iterator)</code> to <code>[type@Iterator]</code>.</p>



<a name="252225996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252225996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marian <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252225996">(Sep 06 2021 at 21:44)</a>:</h4>
<p>that makes sense. So it would be reasonable to skip this whole check whenever a disambiguator has been specified</p>



<a name="252226550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252226550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252226550">(Sep 06 2021 at 21:53)</a>:</h4>
<p>I think we should skip the check whenever we're doing it for the lint. We should never suggest adding a disambiguator to the link text, even if it would resolve to a valid link.</p>



<a name="252226803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252226803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marian <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252226803">(Sep 06 2021 at 21:57)</a>:</h4>
<p>sorry, I meant to say: the entire new lint check (namely, the second resolution) should be skipped whenever a disambiguator has been specified. Even if it's on a link like (i don't know if this is valid) <code>[Iterator](type@std::iter::Iterator)</code> -- in this case we would let that be and will not warn or suggest anything.</p>



<a name="252227063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252227063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252227063">(Sep 06 2021 at 22:01)</a>:</h4>
<p>I don't see why your example is relevant - <code>[Iterator]</code> would be fine to suggest.</p>



<a name="252227091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/New%20lint%3A%20unnecessary%20explicit%20link%20%28%2387799%29/near/252227091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/New.20lint.3A.20unnecessary.20explicit.20link.20(.2387799).html#252227091">(Sep 06 2021 at 22:01)</a>:</h4>
<p>we don't want to suggest a disambiguator in the link <em>text</em>: <code>[type@Iterator]</code>. But whether the current link <em>target</em> uses a disambiguator or not doesn't matter.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>