<html>
<head><meta charset="utf-8"><title>Perf win in #91948 · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html">Perf win in #91948</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264952470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264952470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264952470">(Dec 15 2021 at 01:08)</a>:</h4>
<p>What should be a nice perf win is coming in <a href="https://github.com/rust-lang/rust/pull/91948">https://github.com/rust-lang/rust/pull/91948</a></p>



<a name="264952499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264952499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264952499">(Dec 15 2021 at 01:09)</a>:</h4>
<p>In local measurements I see the following rustdoc improvements on rustc-perf:</p>
<ul>
<li>instructions: up to 5% better</li>
<li>cycles: up to 8% better</li>
<li>wall-time: up to 10% better</li>
</ul>



<a name="264955324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264955324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264955324">(Dec 15 2021 at 01:52)</a>:</h4>
<p>This is awesome! Thank you <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span>️</p>



<a name="264955938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264955938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264955938">(Dec 15 2021 at 02:01)</a>:</h4>
<p>I've learned that so much of what rustdoc does is just "building up strings", which makes sense</p>



<a name="264956123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264956123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264956123">(Dec 15 2021 at 02:03)</a>:</h4>
<p>Those strings are built up, piecemeal, in lots of different functions. There would be scope for improving performance by starting with a single string and passing it as a <code>&amp;mut String</code> everywhere and all those functions would just append to it. It would avoid tons of allocations and <code>memcpy</code>s, which are the hottest things in the profiles. But it might be difficult to restructure things such that the ordering is correct.</p>



<a name="264956213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264956213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264956213">(Dec 15 2021 at 02:05)</a>:</h4>
<p>Really rustdoc just shouldn't be building up Strings at all.</p>



<a name="264956255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264956255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264956255">(Dec 15 2021 at 02:06)</a>:</h4>
<p>How did we both think of this change within a day of each other? <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="264956291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264956291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264956291">(Dec 15 2021 at 02:06)</a>:</h4>
<p>What's the alternative?</p>



<a name="264956297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264956297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264956297">(Dec 15 2021 at 02:06)</a>:</h4>
<p>Well, what Strings are you referring to?</p>



<a name="264956313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264956313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264956313">(Dec 15 2021 at 02:06)</a>:</h4>
<p>The generated HTML</p>



<a name="264956323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264956323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264956323">(Dec 15 2021 at 02:06)</a>:</h4>
<p>In the case of rendering, rustdoc writes to an <code>&amp;mut Buffer</code>, no?</p>



<a name="264956362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264956362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264956362">(Dec 15 2021 at 02:07)</a>:</h4>
<p>I'm not sure what you're referring to wrt using <code>&amp;mut String</code></p>



<a name="264956642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264956642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264956642">(Dec 15 2021 at 02:12)</a>:</h4>
<p>I'm not referring to any particular code. But it looks like <code>Buffer</code> is basically a wrapper around a <code>String</code>?</p>



<a name="264956663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264956663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264956663">(Dec 15 2021 at 02:12)</a>:</h4>
<p>The places I were modifying were in the innards, I didn't really see the outer layers of rustdoc</p>



<a name="264957181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264957181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264957181">(Dec 15 2021 at 02:21)</a>:</h4>
<p>FYI we're currently trying to switch a bunch of stuff to templates which should help quite a lot with all the formatting</p>



<a name="264957190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264957190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264957190">(Dec 15 2021 at 02:21)</a>:</h4>
<p>See the "reconsidering tera" topic</p>



<a name="264957614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264957614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264957614">(Dec 15 2021 at 02:27)</a>:</h4>
<p>very exciting! thanks for working on this.</p>



<a name="264958472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264958472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264958472">(Dec 15 2021 at 02:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948/near/264956642">said</a>:</p>
<blockquote>
<p>I'm not referring to any particular code. But it looks like <code>Buffer</code> is basically a wrapper around a <code>String</code>?</p>
</blockquote>
<p>Yes, but rustdoc passes <code>&amp;mut Buffer</code> usually, so I'm confused about this:</p>
<blockquote>
<p>There would be scope for improving performance by starting with a single string and passing it as a <code>&amp;mut String</code> everywhere and all those functions would just append to it. It would avoid tons of allocations and <code>memcpy</code>s, which are the hottest things in the profiles.</p>
</blockquote>
<p>since IIUC rustdoc already does this.</p>



<a name="264958673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264958673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264958673">(Dec 15 2021 at 02:46)</a>:</h4>
<p><span class="user-mention" data-user-id="307537">@Noah Lev</span> I think Nick means a single buffer <em>everywhere</em>, no format calls, only write!</p>



<a name="264958676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264958676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264958676">(Dec 15 2021 at 02:46)</a>:</h4>
<p>That would reduce the amount of copies quite a lot</p>



<a name="264959844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264959844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264959844">(Dec 15 2021 at 03:09)</a>:</h4>
<p>Yes</p>



<a name="264959897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264959897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264959897">(Dec 15 2021 at 03:10)</a>:</h4>
<p>All the code I was modifying was still building shortish strings that presumably end up being put into the <code>&amp;mut Buffer</code></p>



<a name="264960254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264960254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264960254">(Dec 15 2021 at 03:17)</a>:</h4>
<p>Given that join_with_slash and join_with_double_colon seem to get called a lot, and are probably called with the same inputs much of the time - does it make sense to build a cache of the strings they build? So each time we call e.g. <code>join_with_slash(Some(".."), &amp;[".."])</code> we can return "../../" from a cache rather than doing an allocation?</p>



<a name="264960351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264960351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264960351">(Dec 15 2021 at 03:19)</a>:</h4>
<p>Not sure. Feels like the lookup to detect repeats would be reasonably expensive?</p>



<a name="264960375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264960375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264960375">(Dec 15 2021 at 03:19)</a>:</h4>
<p>yeah, probably true.</p>



<a name="264960660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264960660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264960660">(Dec 15 2021 at 03:24)</a>:</h4>
<p>And it feels like unnecessary complexity too.</p>



<a name="264960807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264960807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264960807">(Dec 15 2021 at 03:26)</a>:</h4>
<p>true. maybe it makes sense at a higher level? E.g. <code>href_with_root_path</code> is going to be called at least once for any DefId that appears on a page, right? And probably much more than that, since types usually appear multiple places on a page. So we could wrap DefId with a rustdoc-internal type that calculates its <code>href_with_root_path</code> on construction, and offers <code>href()</code> as an accessor.</p>



<a name="264960910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264960910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264960910">(Dec 15 2021 at 03:28)</a>:</h4>
<p>I'm pretty sure <code>href_with_root_path</code> depends on the current position in the page hierarchy, so it probably wouldn't be that simple or as much of a gain.</p>



<a name="264960914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264960914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264960914">(Dec 15 2021 at 03:28)</a>:</h4>
<p>It does that so it can emit relative URLs IIRC.</p>



<a name="264960943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/Perf%20win%20in%20%2391948/near/264960943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/Perf.20win.20in.20.2391948.html#264960943">(Dec 15 2021 at 03:29)</a>:</h4>
<p>Also, constructing things ahead of time is a giant source of bugs and I'd really rather not</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>