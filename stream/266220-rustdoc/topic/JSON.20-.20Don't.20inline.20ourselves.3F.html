<html>
<head><meta charset="utf-8"><title>JSON - Don&#x27;t inline ourselves? · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html">JSON - Don&#x27;t inline ourselves?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269894258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/269894258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#269894258">(Jan 29 2022 at 22:58)</a>:</h4>
<p>Most remaining JSON ICEs relate to items with the same DefId being visible in multiple places. One way to handle this would be for JSON to never inline items itself. It would track inlined imports as just imports, and in general output closer to source code than HTML. Another would be to disambiguate IDs somehow based on source code.<br>
Pros:</p>
<ul>
<li>Fixes remaining ICEs</li>
<li>
<p>Gives the user more control / knowledge<br>
Cons:</p>
</li>
<li>
<p>JSON must either always document private, or must use a special indicator for 'defined in a private location'</p>
</li>
<li>Users must re-implement inlining</li>
<li>Some work on our end to add this special-casing to code paths</li>
</ul>
<p>Alternatively, we could try to find a way to disambiguate IDs beyond just DefId for inlined cases<br>
Pros:</p>
<ul>
<li>Less invasive</li>
<li>
<p>Users don't need to think about inlining<br>
Cons:</p>
</li>
<li>
<p>Reduces user control - They actually can't know if an item the same definition or not necessarily</p>
</li>
<li>I have no idea what this would look like</li>
</ul>



<a name="269894394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/269894394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#269894394">(Jan 29 2022 at 23:00)</a>:</h4>
<p>TL;DR - My two solutions so far are 'invasive but not hard to design' and 'less invasive, but I don't know how to implement'</p>



<a name="269894523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/269894523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#269894523">(Jan 29 2022 at 23:03)</a>:</h4>
<p>I would be in favor to track them as imports (ie not inlined) because this would means that re-export could be properly handle instead of the  many hacky things that I tried to do to properly handle them.</p>



<a name="269898708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/269898708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jsha <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#269898708">(Jan 30 2022 at 00:37)</a>:</h4>
<p>is inlining related to re-exports? I.e. the process of making a re-export show up in its re-exported place rather than the original place? Seems like that's a big source of bugs in the HTML parts of rustdoc too.</p>
<p>I'm in favor of any way we can simplify - which argues in favor of your first proposal. Rather than always documenting private items in JSON, how about only documenting private items that are targets of a re-export?</p>



<a name="269900347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/269900347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#269900347">(Jan 30 2022 at 01:10)</a>:</h4>
<p><span class="user-mention" data-user-id="315412">@jsha</span> That was roughly my idea. Given a private item publically re-exported, we document it as a private item correctly and then otherwise document the public re-export as you'd expect. Given a public-in-private item, we document it with a special indicator that its parent module is private and has not been documented.</p>



<a name="269900510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/269900510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#269900510">(Jan 30 2022 at 01:13)</a>:</h4>
<p>Given the positive response so far, I think I'll start work on the idea. I know the first couple places it needs handled - the AST walker, which does local inlining, and then in clean, which does external crate inlining. Then the private pruning pass will need some additions to not prune the right items.</p>



<a name="269972736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/269972736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#269972736">(Jan 31 2022 at 02:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="315412">jsha</span> <a href="#narrow/stream/266220-rustdoc/topic/JSON.20-.20Don't.20inline.20ourselves.3F/near/269898708">said</a>:</p>
<blockquote>
<p>is inlining related to re-exports? I.e. the process of making a re-export show up in its re-exported place rather than the original place? Seems like that's a big source of bugs in the HTML parts of rustdoc too.</p>
</blockquote>
<p>Yes, inlining is what you described. And yes, it is a big source of bugs.</p>



<a name="269972748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/269972748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#269972748">(Jan 31 2022 at 02:23)</a>:</h4>
<p>I feel a bit confused about the concept of not inlining only in the JSON format, though. My understanding is that inlining occurs before the JSON backend (or the HTML backend, for that matter) is run.</p>



<a name="269972755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/269972755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#269972755">(Jan 31 2022 at 02:23)</a>:</h4>
<p>I.e., inlining is output format–independent.</p>



<a name="269975819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/269975819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#269975819">(Jan 31 2022 at 03:27)</a>:</h4>
<p>It occurs during cleaning, but the context is already built and aware of which backend is running. That's why I marked it as 'invasive' though, it does involve adding backend-specificity to passes. On the other hand, I do think it's the better option.</p>



<a name="270071795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/270071795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#270071795">(Jan 31 2022 at 17:37)</a>:</h4>
<p>Update from implementation: It seems that actually, the passes don't need to be made aware of anything. The nature of how we currently store stripped items gives me enough info in JSON to do what is needed, only change is to just not inline in JSON</p>



<a name="270096306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/270096306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#270096306">(Jan 31 2022 at 20:06)</a>:</h4>
<p>Opened a PR: <a href="https://github.com/rust-lang/rust/issues/93518">#93518</a></p>



<a name="274596278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/274596278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John DiSanti <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#274596278">(Mar 08 2022 at 19:48)</a>:</h4>
<p>I work on the AWS SDK for Rust, and I've built a tool for our CI that relies on rustdoc's JSON output to validate which external types are allowed in the public API. I'm keenly interested in seeing CraftSpider's PR (<a href="https://github.com/rust-lang/rust/issues/93518">#93518</a>) merged since we observe some of these ICEs on a couple of our crates, which prevents us from using this tool on all of them.</p>
<p>I see in the PR that it's waiting for <a href="https://github.com/rust-lang/rust/issues/93522">#93522</a> and <a href="https://github.com/rust-lang/rust/issues/93524">#93524</a> to be fixed. Are these required for merging this PR, or are these nice to have? Is there anything I can do to help out?</p>



<a name="274914360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/274914360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#274914360">(Mar 11 2022 at 00:09)</a>:</h4>
<p>I need to look into Urgau's reported bug about some things still inlining, and I was hoping for one of the two to be fixed, but I guess they might not be 100% blockers if you have an immediate use-case. Either one would provide a nice solution, but I believe the existing information is available, just more difficult to use without them.</p>



<a name="274914388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/274914388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> CraftSpider <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#274914388">(Mar 11 2022 at 00:09)</a>:</h4>
<p>I made some headway on the path work a bit ago, before getting distracted with other things (Improved JSON test stuff). Not tonight, but this weekend I'll try to spend some more time looking into it.</p>



<a name="274934071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/274934071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Martin Nordholts <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#274934071">(Mar 11 2022 at 05:44)</a>:</h4>
<p>Sorry for slightly off topic , but would be great if you had time to also take another look at <a href="https://github.com/rust-lang/rust/pull/94150">https://github.com/rust-lang/rust/pull/94150</a>, which you already approved once, it has just been rebased </p>
<p>John, is that project public by any chance? I didn't  find it after a quick look at your GitHub. I would be interested in exploration your implementation as I am working on a similar project</p>



<a name="275006138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/JSON%20-%20Don%27t%20inline%20ourselves%3F/near/275006138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John DiSanti <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/JSON.20-.20Don&#x27;t.20inline.20ourselves.3F.html#275006138">(Mar 11 2022 at 17:30)</a>:</h4>
<p>Yeah, you can find it here: <a href="https://github.com/awslabs/smithy-rs/tree/main/tools/api-linter">https://github.com/awslabs/smithy-rs/tree/main/tools/api-linter</a></p>
<p>I'm hoping to polish it up, rename it, and make it more generally usable by library authors throughout the community.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>