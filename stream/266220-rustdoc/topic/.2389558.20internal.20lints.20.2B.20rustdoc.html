<html>
<head><meta charset="utf-8"><title>#89558 internal lints + rustdoc · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html">#89558 internal lints + rustdoc</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258589172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258589172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258589172">(Oct 21 2021 at 17:50)</a>:</h4>
<p>Hey <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> </p>
<p>internal lints are global and therefore run by rustdoc. <a href="https://github.com/rust-lang/rust/issues/89558">#89558</a> adds a lint using <code>TypeckResults</code> which causes rustdoc to fail, see the comment in the PR for more issue. Does my explanation in that comment make sense and what's the best solution for this in your opinion?</p>



<a name="258589976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258589976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258589976">(Oct 21 2021 at 17:56)</a>:</h4>
<p>Which comment?</p>



<a name="258590217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258590217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258590217">(Oct 21 2021 at 17:58)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/89558/commits/4724ee51c653a9a34b719e1a2c851159c2e6cf97">https://github.com/rust-lang/rust/pull/89558/commits/4724ee51c653a9a34b719e1a2c851159c2e6cf97</a></p>



<a name="258590236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258590236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258590236">(Oct 21 2021 at 17:58)</a>:</h4>
<p>i hope i don't rebase this anymore</p>



<a name="258590281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258590281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258590281">(Oct 21 2021 at 17:58)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="c1">// FIXME(rustdoc): This lint uses typecheck results causing rustdoc to</span>
<span class="w">        </span><span class="c1">// error if there are resolution failures.</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// As internal lints are currently always run if there are `unstable_options`</span>
<span class="w">        </span><span class="c1">// they are added to the lint store of rustdoc. Internal lints are also</span>
<span class="w">        </span><span class="c1">// not used via the `lint_mod` query. Crate lints run outside of a query</span>
<span class="w">        </span><span class="c1">// so rustdoc currently doesn't disable them.</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// Instead of relying on this, either change crate lints to a query disabled by</span>
<span class="w">        </span><span class="c1">// rustdoc, only run internal lints if the user is explicitly opting in</span>
<span class="w">        </span><span class="c1">// or figure out a different way to avoid running lints for rustdoc.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">cx</span><span class="p">.</span><span class="n">tcx</span><span class="p">.</span><span class="n">sess</span><span class="p">.</span><span class="n">opts</span><span class="p">.</span><span class="n">actually_rustdoc</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="258590434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258590434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258590434">(Oct 21 2021 at 17:59)</a>:</h4>
<blockquote>
<p>Does my explanation in that comment</p>
</blockquote>
<p>that's definitely pretty vague <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> sorry</p>



<a name="258592291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258592291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258592291">(Oct 21 2021 at 18:10)</a>:</h4>
<p>Hum... We run some parts of rustc but I didn't expect it to be broken there...</p>



<a name="258612022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258612022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258612022">(Oct 21 2021 at 20:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc/near/258590236">said</a>:</p>
<blockquote>
<p>i hope i don't rebase this anymore</p>
</blockquote>
<p>FWIW, the link you sent now returns not found, but replacing <code>/pull/NNNNN/commits/</code> with <code>/commit/</code> shows the commit (pre-force-push): <a href="https://github.com/rust-lang/rust/commit/4724ee51c653a9a34b719e1a2c851159c2e6cf97">https://github.com/rust-lang/rust/commit/4724ee51c653a9a34b719e1a2c851159c2e6cf97</a></p>



<a name="258638507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258638507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258638507">(Oct 22 2021 at 00:22)</a>:</h4>
<blockquote>
<div class="codehilite"><pre><span></span><code>    // As internal lints are currently always run if there are `unstable_options`
    // they are added to the lint store of rustdoc.
</code></pre></div>

</blockquote>
<p><span class="user-mention" data-user-id="216206">@lcnr</span> wait, so rustdoc/rustc run internal lints with <code>-Zunstable-options</code> even when all the lints are disabled? That seems wrong - I think a better fix is to check if any <code>rustc::</code> lint is enabled and only run internal lints if so</p>



<a name="258638559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258638559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258638559">(Oct 22 2021 at 00:23)</a>:</h4>
<p>or if you want a simpler patch for now, you could check if <code>rustc::all</code> is enabled at the crate level and return if not; it's a hack, but we only need internal lints to work in environments we control</p>



<a name="258638847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258638847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258638847">(Oct 22 2021 at 00:26)</a>:</h4>
<p>why is rustdoc running these lints at all, anyway? it never calls analysis() - <span class="user-mention" data-user-id="216206">@lcnr</span> can you get a backtrace of where this is hit?</p>



<a name="258638880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258638880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258638880">(Oct 22 2021 at 00:27)</a>:</h4>
<p>these are the only things it runs unconditionally, and none of them look like lints: <a href="https://github.com/rust-lang/rust/blob/547a6ffee0cf4da9929a9e3d49546dc87d607735/src/librustdoc/core.rs#L331-L345">https://github.com/rust-lang/rust/blob/547a6ffee0cf4da9929a9e3d49546dc87d607735/src/librustdoc/core.rs#L331-L345</a></p>



<a name="258639089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258639089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258639089">(Oct 22 2021 at 00:29)</a>:</h4>
<p>ok apparently you added this lint to <code>check_mod_attrs</code>, which doesn't seem right. Can you put it in a lint pass somewhere instead?</p>



<a name="258809580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258809580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258809580">(Oct 23 2021 at 07:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc/near/258639089">said</a>:</p>
<blockquote>
<p>ok apparently you added this lint to <code>check_mod_attrs</code>, which doesn't seem right. Can you put it in a lint pass somewhere instead?</p>
</blockquote>
<p>I did not? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I am checking that the attribute is only applied to functions there</p>



<a name="258809585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258809585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258809585">(Oct 23 2021 at 07:40)</a>:</h4>
<p>the lint is part of the internal lint store like the other already existing internal lints</p>



<a name="258809651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258809651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258809651">(Oct 23 2021 at 07:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc/near/258638880">said</a>:</p>
<blockquote>
<p>these are the only things it runs unconditionally, and none of them look like lints: <a href="https://github.com/rust-lang/rust/blob/547a6ffee0cf4da9929a9e3d49546dc87d607735/src/librustdoc/core.rs#L331-L345">https://github.com/rust-lang/rust/blob/547a6ffee0cf4da9929a9e3d49546dc87d607735/src/librustdoc/core.rs#L331-L345</a></p>
</blockquote>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">tcx</span><span class="p">.</span><span class="n">sess</span><span class="p">.</span><span class="n">time</span><span class="p">(</span><span class="s">"missing_docs"</span><span class="p">,</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">rustc_lint</span>::<span class="n">check_crate</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">rustc_lint</span>::<span class="n">builtin</span>::<span class="n">MissingDoc</span>::<span class="n">new</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
</code></pre></div>



<a name="258809667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258809667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258809667">(Oct 23 2021 at 07:43)</a>:</h4>
<p>and <code>check_crate</code> runs</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">tcx</span><span class="p">.</span><span class="n">sess</span><span class="p">.</span><span class="n">time</span><span class="p">(</span><span class="s">"crate_lints"</span><span class="p">,</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Run whole crate non-incremental lints</span>
<span class="w">                </span><span class="n">late_lint_crate</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">builtin_lints</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">});</span><span class="w"></span>
</code></pre></div>



<a name="258809734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258809734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258809734">(Oct 23 2021 at 07:44)</a>:</h4>
<p>and <code>late_lint_crate</code> also runs late_passes from the <code>LintStore</code></p>



<a name="258809792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258809792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258809792">(Oct 23 2021 at 07:46)</a>:</h4>
<blockquote>
<p>wait, so rustdoc/rustc run internal lints with -Zunstable-options even when all the lints are disabled?</p>
</blockquote>
<p>so yes, it does</p>



<a name="258809830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258809830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258809830">(Oct 23 2021 at 07:47)</a>:</h4>
<blockquote>
<p>That seems wrong - I think a better fix is to check if any rustc:: lint is enabled and only run internal lints if so</p>
</blockquote>
<p>we don't explicitly enable any <code>rustc</code> lints rn and I don't want to have to add an attribute to all compiler crates to do so</p>



<a name="258809835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258809835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258809835">(Oct 23 2021 at 07:47)</a>:</h4>
<p>i do think that using a special attribute to run internal lints is probably worth it though</p>



<a name="258809838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258809838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258809838">(Oct 23 2021 at 07:47)</a>:</h4>
<p>instead of just using <code>-Zunstable_options</code></p>



<a name="258831809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/%2389558%20internal%20lints%20%2B%20rustdoc/near/258831809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc.html#258831809">(Oct 23 2021 at 16:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/266220-rustdoc/topic/.2389558.20internal.20lints.20.2B.20rustdoc/near/258809835">said</a>:</p>
<blockquote>
<p>i do think that using a special attribute to run internal lints is probably worth it though</p>
</blockquote>
<p>yeah this seems like the proper fix</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>