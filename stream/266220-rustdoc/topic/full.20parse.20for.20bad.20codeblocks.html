<html>
<head><meta charset="utf-8"><title>full parse for bad codeblocks · rustdoc · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/index.html">rustdoc</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html">full parse for bad codeblocks</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254231851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254231851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254231851">(Sep 21 2021 at 15:59)</a>:</h4>
<p>The second aspect of this -- not really tied to 2021 -- is that the lint is probably not firing "enough"; just tokenizing Rust code is kind of a weak approximation of validity. I get that rustdoc only technically needs that for syntax highlighting today, but it seems like actually parsing the input could be a good idea in the future. Certainly that would help with the cases where folks have doctests turned off (or just don't run them, perhaps because they don't use cargo and don't run rustdoc --test)</p>



<a name="254232058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232058">(Sep 21 2021 at 16:00)</a>:</h4>
<p>I really don't think we should do a full parse, we'll end up with basically the whole ecosystem getting warnings (and I worry people will blanket allow the lint in that case)</p>



<a name="254232334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232334">(Sep 21 2021 at 16:02)</a>:</h4>
<p>This topic was moved here from <a class="stream-topic" data-stream-id="268952" href="/#narrow/stream/268952-edition-2021/topic/Edition.20Blockers.28.3F.29">#edition 2021 &gt; Edition Blockers(?)</a> by <span class="user-mention silent" data-user-id="116122">simulacrum</span></p>



<a name="254232357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232357">(Sep 21 2021 at 16:02)</a>:</h4>
<p>taking this thread here</p>



<a name="254232396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232396">(Sep 21 2021 at 16:02)</a>:</h4>
<p>I don't understand why you think most code blocks are syntactically incorrect</p>



<a name="254232418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232418">(Sep 21 2021 at 16:02)</a>:</h4>
<p>(i.e., tokenize but don't parse)</p>



<a name="254232499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232499">(Sep 21 2021 at 16:03)</a>:</h4>
<p>because most people don't realize that their code block is parsed as rust, e.g. your fix to deindent that markdown list</p>



<a name="254232546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232546">(Sep 21 2021 at 16:03)</a>:</h4>
<p>What is the goal for the lint, then?</p>



<a name="254232684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232684">(Sep 21 2021 at 16:04)</a>:</h4>
<p>In particular, "Or in other words, this isn't a "your code is bad" lint, this is "rustdoc tried and failed to highlight the code, and it's trying to let you know something is wrong rather than silently failing""</p>



<a name="254232820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232820">(Sep 21 2021 at 16:04)</a>:</h4>
<p>it feels like 'we failed to highlight your code' is not <em>really</em> what a user cares about</p>



<a name="254232909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232909">(Sep 21 2021 at 16:05)</a>:</h4>
<p>hum indeed</p>



<a name="254232953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232953">(Sep 21 2021 at 16:05)</a>:</h4>
<p>"this code block is considered as a rust one, however it seems invalid"</p>



<a name="254232956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254232956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254232956">(Sep 21 2021 at 16:05)</a>:</h4>
<p>more so, that rustdoc thinks the block is Rust and you don't</p>



<a name="254233003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233003">(Sep 21 2021 at 16:05)</a>:</h4>
<p>I don't have a good reason for rustdoc's current behavior. There are several intersecting issues:</p>
<ul>
<li>People don't realize what code blocks are being parsed as code blocks and not markdown syntax.</li>
<li>Rustdoc parses code blocks as rust by default.</li>
<li><code>ignore</code> doesn't fully silence warnings; it generates an <code>#[ignore]</code> test instead.</li>
<li>There is no way at  <em>all</em> to add an edition/lang string to code blocks indented by 4 spaces</li>
</ul>
<p>There are not good ways to fix any of these in a backwards compatible way. But I don't think fully silencing the warning is helpful either; all that does is make the docs look buggy.</p>



<a name="254233023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233023">(Sep 21 2021 at 16:05)</a>:</h4>
<p>let me find links for these</p>



<a name="254233109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233109">(Sep 21 2021 at 16:06)</a>:</h4>
<p>(I've been trying to avoid dealing with doctests for about 9 months because they're such a headache)</p>



<a name="254233124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233124">(Sep 21 2021 at 16:06)</a>:</h4>
<blockquote>
<p>There is no way at all to add an edition/lang string to code blocks indented by 4 spaces</p>
</blockquote>
<p>Or anything</p>



<a name="254233173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233173">(Sep 21 2021 at 16:06)</a>:</h4>
<blockquote>
<p>(I've been trying to avoid dealing with doctests for about 9 months because they're such a headache)</p>
</blockquote>
<p>I think all rustdoc contributors do the same haha</p>



<a name="254233298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233298">(Sep 21 2021 at 16:07)</a>:</h4>
<p>My assumption (maybe flawed) is that users will get new warnings/errors from this lint in 2021, because previously I'm not sure tokenization would have failed on any not "really weird" input</p>



<a name="254233332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233332">(Sep 21 2021 at 16:07)</a>:</h4>
<p>whereas now it's not uncommon for that to happen</p>



<a name="254233349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233349">(Sep 21 2021 at 16:08)</a>:</h4>
<p>which is maybe fine</p>



<a name="254233464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233464">(Sep 21 2021 at 16:08)</a>:</h4>
<p>but if you're right that part of the reason for not making the lint do a full parse is that users can't nicely silence it, that then seems like a problem :)</p>



<a name="254233472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233472">(Sep 21 2021 at 16:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks/near/254233023">said</a>:</p>
<blockquote>
<p>let me find links for these</p>
</blockquote>
<ul>
<li><a href="https://github.com/rust-lang/rust/issues/88590">https://github.com/rust-lang/rust/issues/88590</a></li>
<li><a href="https://github.com/rust-lang/rust/issues/87586">https://github.com/rust-lang/rust/issues/87586</a></li>
<li><a href="https://github.com/rust-lang/rust/issues/64162">https://github.com/rust-lang/rust/issues/64162</a></li>
<li><a href="https://github.com/rust-lang/rust/issues/63193">https://github.com/rust-lang/rust/issues/63193</a></li>
<li><a href="https://github.com/rust-lang/rust/issues/55813">https://github.com/rust-lang/rust/issues/55813</a></li>
</ul>
<p>are the ones I found just looking through A-doctest, I think there are others</p>



<a name="254233523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233523">(Sep 21 2021 at 16:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks/near/254233464">said</a>:</p>
<blockquote>
<p>but if you're right that part of the reason for not making the lint do a full parse is that users can't nicely silence it, that then seems like a problem :)</p>
</blockquote>
<p>well, how do you suggest we fix this? we'd need some sort of syntax for it which needs an RFC</p>



<a name="254233737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233737">(Sep 21 2021 at 16:10)</a>:</h4>
<p>Just silence the lint entirely for now, for example, could be one easy approach, or -- I suppose -- using 2015/2018 tokenization rules unless edition is speciifically otherwise specified (feels icky)</p>



<a name="254233883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233883">(Sep 21 2021 at 16:11)</a>:</h4>
<p>I don't feel super strongly; if you think the lint isn't adding much value we can turn it off</p>



<a name="254233894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254233894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254233894">(Sep 21 2021 at 16:11)</a>:</h4>
<p>but I'm not sure how much it helps with the larger issues</p>



<a name="254234044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254234044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254234044">(Sep 21 2021 at 16:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks/near/254233023">said</a>:</p>
<blockquote>
<p>let me find links for these</p>
</blockquote>
<p><a href="https://github.com/rust-lang/rust/pull/84597">https://github.com/rust-lang/rust/pull/84597</a> is also related</p>



<a name="254234275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254234275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254234275">(Sep 21 2021 at 16:13)</a>:</h4>
<p>certainly it doesn't solve the larger issues</p>



<a name="254234294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254234294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254234294">(Sep 21 2021 at 16:13)</a>:</h4>
<p>and might hurt some of them</p>



<a name="254234385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/266220-rustdoc/topic/full%20parse%20for%20bad%20codeblocks/near/254234385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/266220-rustdoc/topic/full.20parse.20for.20bad.20codeblocks.html#254234385">(Sep 21 2021 at 16:14)</a>:</h4>
<p>I think most users probably won't be affected because they're running doctests anyway</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>