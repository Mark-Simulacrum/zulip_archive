<html>
<head><meta charset="utf-8"><title>HTTP based index · t-crates-io · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/index.html">t-crates-io</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html">HTTP based index</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275816159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275816159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275816159">(Mar 18 2022 at 15:14)</a>:</h4>
<p>Hi!</p>
<p><span class="user-mention" data-user-id="270929">@Arlo Siemsen</span> has been making excellent progress on the Cargo side of the HTTP based index work! Thank you Arlo!<br>
So I think it's time we get our heads together and create a plan for crates.io's support of this interface. (In the hope that we can talk Arlo into doing that work as well.)<br>
I want to make sure we find a solution <a href="http://crates.io">crates.io</a> is willing to maintain, and infra is willing to host.<br>
I want to start the conversation now, and be involved, to make it clear that cargo can change it's behavior if that will help.<br>
I see three choices we have to make:</p>
<ol>
<li>Use the existing index file layout or add a merkle tree on top. (The question being do we need the merkle tree before we stabilize. )</li>
<li>Use S3 to store the files, or generate them dynamically on <a href="http://crates.io">crates.io</a></li>
<li>Use a short TTL on the CDN or use explicit invalidations</li>
</ol>



<a name="275831919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275831919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275831919">(Mar 18 2022 at 16:56)</a>:</h4>
<p>I have strong evidence that this is wide open for bike shedding. In practice based on the number of long conversations I've already had about this, since the RFC was first proposed. But from first principles because all 8 of the possibilities can work reasonably well, and we can switch between them without much fanfare.</p>



<a name="275832351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275832351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275832351">(Mar 18 2022 at 16:59)</a>:</h4>
<p>I know the <a href="http://crate.io">crate.io</a> team is very short on reviewer time. It seems to me that the biggest design consideration is what is easiest for you to review.</p>



<a name="275843571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275843571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275843571">(Mar 18 2022 at 18:22)</a>:</h4>
<p>What's the simplest thing that would work?</p>



<a name="275843856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275843856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275843856">(Mar 18 2022 at 18:25)</a>:</h4>
<p>Like is there a path that would let us deploy a change, verify it works for people opting in with an unstable cargo feature or something, that would let us monitor, test, then iterate?</p>



<a name="275844093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275844093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275844093">(Mar 18 2022 at 18:27)</a>:</h4>
<p>In addition to minimizing review, I'd also love if the plan minimized the risk-- like, do we have to have a big switch that flips and turns on (or breaks) everyone all at once, or is there a more gradual way to switch over (and switch back if something's not working) to cause the least disruption to cargo users and the least headaches for on-call?</p>



<a name="275844562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275844562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275844562">(Mar 18 2022 at 18:31)</a>:</h4>
<p>The feature is not yet merged in cargo. Even when it's merged it can be opt in as long as we want.</p>



<a name="275844609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275844609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlo Siemsen <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275844609">(Mar 18 2022 at 18:31)</a>:</h4>
<p>At some point we can make the http endpoint the default for <a href="http://crates.io">crates.io</a>, but I expect we'll go through several steps.</p>
<ul>
<li>Require manual configuration of source replacement and <code>-Z http-registry</code> on nightly cargo</li>
<li>Add additional unstable switch to cargo that automatically configures the http endpoint as the default for Cargo (so source replacement is not necessary)</li>
<li>Stabilize http-registry</li>
<li>Make the http endpoint the default on nightly (and have a config option to switch back to the git-based <a href="http://crates.io">crates.io</a> as default)</li>
<li>Make the http endpoint the default for stable.</li>
</ul>



<a name="275844811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275844811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275844811">(Mar 18 2022 at 18:33)</a>:</h4>
<p>We will need support in cargo for realizing that <a href="http://crates.io">crates.io</a> has both a git and an http based index and that they should be treated as equivalent. That code can also be made to handle "try the HTTP based index first, but if that doesn't work try to the git one"<br>
(I don't know that we would make this available to any other registry, but we can definitely do it for <a href="http://crates.io">crates.io</a>)</p>



<a name="275847916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275847916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlo Siemsen <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275847916">(Mar 18 2022 at 18:59)</a>:</h4>
<p>We'll also need to decide what to do about the <code>Cargo.lock</code> files. Eventually we may want to "update" them to away from github as the registry url.</p>



<a name="275848400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275848400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275848400">(Mar 18 2022 at 19:02)</a>:</h4>
<blockquote>
<p>What's the simplest thing that would work?</p>
</blockquote>
<p>Here is a plan:</p>
<ul>
<li>Add code to have new publishes add their crate hash to the database.</li>
<li>Arlo has code that adds the appropriate endpoints to <a href="http://crates.io">crates.io</a> to dynamically generate the index files.<br>
    - (This is enough for some bare minimum of testing on the cargo side.)</li>
<li>Do a backfill to get the hashes from already published crates.<br>
    - (This allows testing of existing projects.)</li>
<li>Add CloudFront in front of those endpoints. (With say a 15 minute CDN- TTL.)<br>
    - (This is enough for us to start encouraging people to test on nightly with <code>-Z http-registry</code>)</li>
<li>Encourage more testing and decrease CDN- TTL. To see how much problem the load is.</li>
</ul>
<p>Reevaluate from here.</p>



<a name="275848413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275848413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlo Siemsen <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275848413">(Mar 18 2022 at 19:02)</a>:</h4>
<p>The simplest thing that would get us started is (IMHO):</p>
<ol>
<li>Use the existing index file layout</li>
<li>Store the crates on S3</li>
<li>Use short TTL on CDN</li>
</ol>
<p>We'd need to bulk upload all the existing index files, then modify <a href="http://crates.io">crates.io</a> to publish new a new index file as part of uploading a new crate.</p>



<a name="275848473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275848473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275848473">(Mar 18 2022 at 19:03)</a>:</h4>
<p>I was just going to write up that as the alternative just as easy plan. :-P</p>



<a name="275848523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275848523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlo Siemsen <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275848523">(Mar 18 2022 at 19:03)</a>:</h4>
<p>Haha yes, both seem similar difficulty.</p>



<a name="275848725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275848725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlo Siemsen <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275848725">(Mar 18 2022 at 19:05)</a>:</h4>
<p>I can do the changes to <a href="http://crates.io">crates.io</a> source, but I expect I'd need to work with someone for the bulk upload of existing files / or bulk import of hashes.</p>



<a name="275849133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275849133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlo Siemsen <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275849133">(Mar 18 2022 at 19:08)</a>:</h4>
<p>Who's available that has access to set up CDN, DNS, etc? Someone also needs to make a decision between "dynamically generate" and "store on S3" options. I can do the code change to <a href="http://crates.io">crates.io</a> for either option.</p>



<a name="275855877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275855877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275855877">(Mar 18 2022 at 20:05)</a>:</h4>
<p>I have the access needed to set the infra up</p>



<a name="275867757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/275867757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#275867757">(Mar 18 2022 at 21:58)</a>:</h4>
<p>Just had a thought that for testing purposes it doesn't have to be a URL at <code>crates.io</code>. We can have the code update the S3 buckets for <a href="https://crates-io-index-temp.rust-lang.org/6887cde41199f4e2934e64646c02e76f8061365e/config.json">https://crates-io-index-temp.rust-lang.org/6887cde41199f4e2934e64646c02e76f8061365e/config.json</a></p>



<a name="276090273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/276090273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#276090273">(Mar 21 2022 at 17:57)</a>:</h4>
<blockquote>
<p>Someone also needs to make a decision between "dynamically generate" and "store on S3" options. I can do the code change to <a href="http://crates.io">crates.io</a> for either option.</p>
</blockquote>
<p><span class="user-mention" data-user-id="257516">@Carol (Nichols || Goulding)</span> who on Crates should make that decision?</p>



<a name="276090663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/276090663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#276090663">(Mar 21 2022 at 18:00)</a>:</h4>
<p>I'd definitely want <span class="user-mention" data-user-id="257369">@Justin Geibel</span> to weigh in. He's often not available during the day because he has a day job though :)</p>



<a name="276091918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/276091918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Geibel <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#276091918">(Mar 21 2022 at 18:09)</a>:</h4>
<p>I think there are pros and cons to each approach. If we go with dynamically generated, then I think that should probably be a separate deployment from the main <a href="http://crates.io">crates.io</a> Heroku app to ensure we don't impact performance. The store on S3 approach would use less resources, but may be more difficult when it comes to cache invalidation and making sure that S3 and the git index are always in agreement.</p>



<a name="276096148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/276096148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#276096148">(Mar 21 2022 at 18:37)</a>:</h4>
<p>Sounds like the S3 approach is less risky to production. So lets start there.</p>



<a name="276227571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/276227571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlo Siemsen <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#276227571">(Mar 22 2022 at 17:44)</a>:</h4>
<p>Here's the initial implementation: <a href="https://github.com/rust-lang/crates.io/pull/4661">https://github.com/rust-lang/crates.io/pull/4661</a>. I still need to understand how the tests work with mocked AWS.</p>



<a name="276235331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/276235331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlo Siemsen <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#276235331">(Mar 22 2022 at 18:33)</a>:</h4>
<p>It looks like the tests are running against captured replays of interactions with <a href="http://alexcrichton-test.s3.amazonaws.com/">http://alexcrichton-test.s3.amazonaws.com/</a> </p>
<p>How can I generate new ones? Do I need to set up an S3 account?</p>



<a name="276273969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/276273969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#276273969">(Mar 23 2022 at 00:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="270929">Arlo Siemsen</span> <a href="#narrow/stream/318791-t-crates-io/topic/HTTP.20based.20index/near/276235331">said</a>:</p>
<blockquote>
<p>It looks like the tests are running against captured replays of interactions with <a href="http://alexcrichton-test.s3.amazonaws.com/">http://alexcrichton-test.s3.amazonaws.com/</a> </p>
<p>How can I generate new ones? Do I need to set up an S3 account?</p>
</blockquote>
<p>I usually just copy-paste an existing capture</p>



<a name="276294182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/276294182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#276294182">(Mar 23 2022 at 06:48)</a>:</h4>
<p>infra wise, can it be a separate bucket?</p>



<a name="276901578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/276901578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlo Siemsen <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#276901578">(Mar 28 2022 at 16:49)</a>:</h4>
<p><span class="user-mention" data-user-id="121055">@Pietro Albini</span> Currently all the config in the <a href="http://crates.io">crates.io</a> source is centered around one S3 bucket for both crates and readme files so making a change to add a different bucket for the index isn't trivial.</p>
<p>If it needs to be a separate bucket I can make that change. I think we'd need additional configuration keys such as <code>S3_INDEX_BUCKET, S3_INDEX_ACCESS_KEY, S3_INDEX_SECRET_KEY, S3_INDEX_REGION, S3_INDEX_CDN</code>, then some refactoring to share code about parsing the config and having a separate <code>Uploader</code> instance for the index.</p>
<p>Is that something we need to move forward?</p>



<a name="277342565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277342565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277342565">(Mar 31 2022 at 21:26)</a>:</h4>
<p><span class="user-mention" data-user-id="121055">@Pietro Albini</span> would you set up a the S3 buckets?<br>
<span class="user-mention" data-user-id="270929">@Arlo Siemsen</span> assuming that the envs get added, do you want to start on that code?</p>



<a name="277342591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277342591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277342591">(Mar 31 2022 at 21:27)</a>:</h4>
<p>didn't have a chance yet</p>



<a name="277342608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277342608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277342608">(Mar 31 2022 at 21:27)</a>:</h4>
<p>will do either on the weekend or next week</p>



<a name="277343126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277343126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277343126">(Mar 31 2022 at 21:33)</a>:</h4>
<p>Perfect, thank you!</p>



<a name="277472010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277472010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277472010">(Apr 01 2022 at 20:12)</a>:</h4>
<p>there are now the <code>crates-io-index</code> and <code>staging-crates-io-index</code> s3 buckets</p>



<a name="277472100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277472100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277472100">(Apr 01 2022 at 20:13)</a>:</h4>
<p><a href="https://github.com/rust-lang/simpleinfra/commit/64d96b727d0fcb0d73a4855c49036f1196cff2ea">https://github.com/rust-lang/simpleinfra/commit/64d96b727d0fcb0d73a4855c49036f1196cff2ea</a></p>



<a name="277472280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277472280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277472280">(Apr 01 2022 at 20:14)</a>:</h4>
<p>Wonderful! Do they have CludFrunt?</p>



<a name="277472446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277472446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277472446">(Apr 01 2022 at 20:16)</a>:</h4>
<p>And what is the URL associated with them?</p>



<a name="277472464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277472464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277472464">(Apr 01 2022 at 20:16)</a>:</h4>
<p>not yet, do you need cloudfront right now?</p>



<a name="277472480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277472480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277472480">(Apr 01 2022 at 20:16)</a>:</h4>
<p>(or like, in the coming days?)</p>



<a name="277472565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277472565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277472565">(Apr 01 2022 at 20:17)</a>:</h4>
<p>I think the s3 unblocks the <a href="http://crates.io">crates.io</a> work. So thank you!</p>



<a name="277472686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277472686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277472686">(Apr 01 2022 at 20:18)</a>:</h4>
<p>cloudfront/URLs will be needed when we get to testing it with cargo, but that is counting chickens.</p>



<a name="277473630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277473630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277473630">(Apr 01 2022 at 20:27)</a>:</h4>
<p><a href="https://index.crates.io/">https://index.crates.io/</a> + <a href="https://index.staging.crates.io">https://index.staging.crates.io</a></p>



<a name="277473661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277473661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277473661">(Apr 01 2022 at 20:27)</a>:</h4>
<p><a href="https://github.com/rust-lang/simpleinfra/commit/62695e20150dccdd91044d85f415ce6f068a8d48">https://github.com/rust-lang/simpleinfra/commit/62695e20150dccdd91044d85f415ce6f068a8d48</a></p>



<a name="277473720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277473720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277473720">(Apr 01 2022 at 20:27)</a>:</h4>
<p>both configs are cut-down copy/pastes of the staging configuration</p>



<a name="277473729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277473729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277473729">(Apr 01 2022 at 20:27)</a>:</h4>
<p>TTLs are definitely wrong on cloudfront</p>



<a name="277474165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277474165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277474165">(Apr 01 2022 at 20:31)</a>:</h4>
<p>Should be more than good enough for testing!<br>
I will make sure that you look at the TTL's again before anything gets stabilized.<br>
Do you know what they are currently set to?</p>



<a name="277474269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277474269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277474269">(Apr 01 2022 at 20:32)</a>:</h4>
<p>whatever default terraform or cloudfront sets</p>



<a name="277978242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277978242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277978242">(Apr 06 2022 at 05:53)</a>:</h4>
<p>I know the current index in GH stores only the 1st degree of dependencies. Would it be worthwhile to cache the entire graph of the dependency tree for each crate somehow</p>



<a name="277978383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277978383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277978383">(Apr 06 2022 at 05:56)</a>:</h4>
<p>I would love to test dependency-circular-bomb and see just how twisted / hostile dependency tree I could build</p>



<a name="277978442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277978442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277978442">(Apr 06 2022 at 05:57)</a>:</h4>
<p>Or are we still using some type of cloning type operation of the whole index in the new design? - what I understood from <a href="https://github.com/rust-lang/crates.io/pull/4661">https://github.com/rust-lang/crates.io/pull/4661</a> is that it's atomic per crate instead of clone</p>



<a name="277981048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277981048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277981048">(Apr 06 2022 at 06:42)</a>:</h4>
<p>Upon publish from design PoV it should resolve the entire tree at publish stage and queue-delay publish upon when the dependency minimums have each been published - resolving by Pub/Sub kind of logic recursively working from the bottom-up - this would also resolve the issue described in broken builds due dependencies not published yet</p>



<a name="277981104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/277981104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#277981104">(Apr 06 2022 at 06:44)</a>:</h4>
<p>Happy to contribute some design / code / tests, it's a bit like reactive publish upon when dependencies are published</p>



<a name="278046604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/278046604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#278046604">(Apr 06 2022 at 16:03)</a>:</h4>
<blockquote>
<p>Would it be worthwhile to cache the entire graph of the dependency tree for each crate somehow</p>
</blockquote>
<p>The graph depends on what else you are depending on. So I don't know how useful it would be to have the "entire graph if this was your only dependency"</p>
<blockquote>
<p>dependency-circular-bomb</p>
</blockquote>
<p>How are you proposing to publish circular dependency?</p>
<blockquote>
<p>what I understood from <a href="https://github.com/rust-lang/crates.io/pull/4661">https://github.com/rust-lang/crates.io/pull/4661</a> is that it's atomic per crate instead of clone</p>
</blockquote>
<p>Yes.</p>
<blockquote>
<p>Happy to contribute some design / code / tests, it's a bit like reactive publish upon when dependencies are published</p>
</blockquote>
<p>I would love to talk about better designs. but the biggest limitations are the extremely limited capacity of both the cargo and <a href="http://crates.io">crates.io</a> team.<br>
The current design is largely optimized to be small enough that both teams could imagine implementing it. and even so the cargo side took two years of implementation.</p>
<p>Good design for what we could do next or really helpful. Designs that require us to do more work in order to see the tangible benefits from this design, is less helpful.</p>



<a name="278310964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/318791-t-crates-io/topic/HTTP%20based%20index/near/278310964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arlo Siemsen <a href="https://zulip-archive.rust-lang.org/stream/318791-t-crates-io/topic/HTTP.20based.20index.html#278310964">(Apr 08 2022 at 14:20)</a>:</h4>
<p>I updated the PR for <a href="http://crates.io">crates.io</a> to add a separate bucket for the index, as well as a bulk-upload tool. <a href="https://github.com/rust-lang/crates.io/pull/4661">https://github.com/rust-lang/crates.io/pull/4661</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>