<html>
<head><meta charset="utf-8"><title>Issue #87814 · t-compiler/wg-rfc-2229 · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/index.html">t-compiler/wg-rfc-2229</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html">Issue #87814</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="248661059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/248661059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rocksand <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#248661059">(Aug 06 2021 at 20:00)</a>:</h4>
<p>I took a look at issue <a href="https://github.com/rust-lang/rust/issues/87814">https://github.com/rust-lang/rust/issues/87814</a> and I think the underlying issue may not be a result of our changes for RFC2229, but instead something to do with using `as Result&lt;(),_&gt;. I have a <a href="https://github.com/rust-lang/rust/issues/87814#issuecomment-894487391">comment here</a> summarizing my thought process.<br>
Any thoughts? <span class="user-mention" data-user-id="281950">@Aman Arora</span> <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="248821681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/248821681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donough Liu <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#248821681">(Aug 09 2021 at 09:13)</a>:</h4>
<p><span class="user-mention" data-user-id="307184">@rocksand</span> I looked into it a bit. It seems that when using <code>as Result</code>, the typeck result of <code>subpat</code>(the _ in <code>Error(_)</code>) is a type var which makes <code>resolve_type_vars_or_error</code> return <code>Err</code>. But if <code>as Result</code> is removed, the typeck result of <code>subpat</code> is <code>()</code> rather than <code>_</code>, then it works fine. Is this expected? Or it's a bug in the type var resolving?</p>



<a name="248926710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/248926710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rocksand <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#248926710">(Aug 10 2021 at 00:31)</a>:</h4>
<p>I am not very familiar with this part of the code, so I am not sure</p>



<a name="249736256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249736256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249736256">(Aug 17 2021 at 15:35)</a>:</h4>
<p>I'm reading here</p>



<a name="249736493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249736493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249736493">(Aug 17 2021 at 15:36)</a>:</h4>
<p>Hmm</p>



<a name="249736517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249736517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249736517">(Aug 17 2021 at 15:37)</a>:</h4>
<p>The problem might be the ordering of when cast results are compared versus upvar inference</p>



<a name="249736760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249736760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249736760">(Aug 17 2021 at 15:38)</a>:</h4>
<p>also maybe unrelated but when MIR is generated but is MIR for <code>let x: T = &lt;expr&gt;</code> and <code>&lt;expr&gt; as T</code> similar? i.e. do they both count as type ascription?</p>



<a name="249737955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249737955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249737955">(Aug 17 2021 at 15:47)</a>:</h4>
<p>(deleted)</p>



<a name="249740109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249740109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249740109">(Aug 17 2021 at 16:02)</a>:</h4>
<p>neither is type ascription, but they do behave pretty similarly</p>



<a name="249740459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249740459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249740459">(Aug 17 2021 at 16:05)</a>:</h4>
<p>Okay, thanks</p>



<a name="249740519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249740519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249740519">(Aug 17 2021 at 16:05)</a>:</h4>
<p>What's considered type ascription?</p>



<a name="249773516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249773516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249773516">(Aug 17 2021 at 20:19)</a>:</h4>
<p><span class="user-mention" data-user-id="281950">@Aman Arora</span> type ascription usually just means expressions of the form <code>e: T</code></p>



<a name="249773521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249773521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249773521">(Aug 17 2021 at 20:19)</a>:</h4>
<p>which are an unstable feature</p>



<a name="249773534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249773534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249773534">(Aug 17 2021 at 20:19)</a>:</h4>
<p>Ah I see, thanks</p>



<a name="249782467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249782467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rocksand <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249782467">(Aug 17 2021 at 21:38)</a>:</h4>
<p>By ordering, you mean the ordering of the checks in cat_pattern?</p>



<a name="249782564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249782564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249782564">(Aug 17 2021 at 21:39)</a>:</h4>
<p>I think my hypothesis about ordering was wrong</p>



<a name="249782574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249782574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249782574">(Aug 17 2021 at 21:39)</a>:</h4>
<p>I started reading into the code and it didn't seem to line up</p>



<a name="249782584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249782584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249782584">(Aug 17 2021 at 21:39)</a>:</h4>
<p>I didn't get far eough to decide if I like that PR or not yet though</p>



<a name="249783047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249783047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rocksand <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249783047">(Aug 17 2021 at 21:45)</a>:</h4>
<p>Ok, is my assumption correct though?´cat_pattern’ should only fail if we expect a failure to arise somewhere else in the code? Because if that is correct either the input to ‘cat_pattern’ is wrong or the checks done inside the method are wrong… 🤔</p>



<a name="249783768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249783768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249783768">(Aug 17 2021 at 21:53)</a>:</h4>
<p>Yes, your assumption is I believe correct</p>



<a name="249783779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249783779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249783779">(Aug 17 2021 at 21:53)</a>:</h4>
<p>which is why I'm not sure about that PR</p>



<a name="249783937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249783937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249783937">(Aug 17 2021 at 21:54)</a>:</h4>
<p>I think the early exit can be split into another PR that uses a different interface for the caller to say "early exit"</p>



<a name="249784038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249784038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249784038">(Aug 17 2021 at 21:55)</a>:</h4>
<p>Returning result from the callback conflicts with the result from actually processing the patterns</p>



<a name="249932839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249932839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249932839">(Aug 19 2021 at 01:57)</a>:</h4>
<p>So I think I have an idea why <a href="https://github.com/rust-lang/rust/issues/87814">#87814</a> and <a href="https://github.com/rust-lang/rust/issues/88118">#88118</a> </p>
<p>We don't handle <code>ExprKind::Cast</code> properly <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/mem_categorization.rs#L364">https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/mem_categorization.rs#L364</a></p>



<a name="249932901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249932901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249932901">(Aug 19 2021 at 01:58)</a>:</h4>
<p><code>cat_rvalue</code> really is a dummy place that says Rvalue that came from this expr</p>



<a name="249932930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249932930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249932930">(Aug 19 2021 at 01:59)</a>:</h4>
<p>Well more like Rvalue with diagnostics from this expr</p>



<a name="249933442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/249933442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#249933442">(Aug 19 2021 at 02:07)</a>:</h4>
<p>nvm it is handled here: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/expr_use_visitor.rs#L398-L400">https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/expr_use_visitor.rs#L398-L400</a></p>



<a name="250109162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250109162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rocksand <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250109162">(Aug 20 2021 at 12:07)</a>:</h4>
<p>Is there any reason against just removing the <code>ty.is_ty_var()</code> from <a href="https://github.com/rust-lang/rust/blame/master/compiler/rustc_typeck/src/mem_categorization.rs#L146">here</a> or attempting to work around that check in cat_pattern?</p>



<a name="250143238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250143238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250143238">(Aug 20 2021 at 16:50)</a>:</h4>
<p>Removing that check would mean we'd try construct a place without knowing it's type</p>



<a name="250143328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250143328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250143328">(Aug 20 2021 at 16:51)</a>:</h4>
<p>Hmm actually not sure if that's really an issue because write back will resolve the types</p>



<a name="250143419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250143419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250143419">(Aug 20 2021 at 16:52)</a>:</h4>
<p>That said it feels like we should've resolved most of the types by the time we get to closure analysis since it's like at the very end of typechk</p>



<a name="250143525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250143525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250143525">(Aug 20 2021 at 16:53)</a>:</h4>
<p>Also missing/uninferred type errors can also come in other parts of the code: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/expr_use_visitor.rs#L398-L400">https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/expr_use_visitor.rs#L398-L400</a></p>



<a name="250143542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250143542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250143542">(Aug 20 2021 at 16:53)</a>:</h4>
<p>So we'd need to figure out a better way of handling these</p>



<a name="250146965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250146965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rocksand <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250146965">(Aug 20 2021 at 17:22)</a>:</h4>
<p>We do actually get the type regardless of the check. It knows that the type is Wild</p>



<a name="250147029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250147029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rocksand <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250147029">(Aug 20 2021 at 17:23)</a>:</h4>
<p>Maybe there should be somethjng along the line that we don’t care whether it’s a var or not as long at the type is Wild…. 🤔</p>



<a name="250229567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250229567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donough Liu <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250229567">(Aug 21 2021 at 17:59)</a>:</h4>
<p>Okay, the early exit change is reverted.</p>



<a name="250230412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250230412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donough Liu <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250230412">(Aug 21 2021 at 18:20)</a>:</h4>
<p>I don't like the PR either. But currently, this is the only solution I can do with my knowledge of rustc's code base.</p>



<a name="250230550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250230550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donough Liu <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250230550">(Aug 21 2021 at 18:22)</a>:</h4>
<p>This is problem would be solved (I guess) in another way by hinting the type inference context that the <code>_</code> in <code>Err(()) as Result&lt;(), _&gt;</code> actually has a type <code>()</code> during type coercion.</p>



<a name="250370209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250370209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250370209">(Aug 23 2021 at 15:46)</a>:</h4>
<p><span class="user-mention" data-user-id="294318">@Donough Liu</span> reverted where?</p>



<a name="250371898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250371898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donough Liu <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250371898">(Aug 23 2021 at 15:59)</a>:</h4>
<p>Reverted a commit on an open PR: <a href="https://github.com/rust-lang/rust/pull/87879">https://github.com/rust-lang/rust/pull/87879</a></p>



<a name="250372004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250372004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donough Liu <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250372004">(Aug 23 2021 at 16:00)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="250377452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250377452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250377452">(Aug 23 2021 at 16:41)</a>:</h4>
<p><span class="user-mention" data-user-id="294318">@Donough Liu</span> ok! I was just going to look into that PR in more detail</p>



<a name="250377488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250377488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250377488">(Aug 23 2021 at 16:41)</a>:</h4>
<p>I think what's bothering me a bit is "why did typeck fail"??</p>



<a name="250377648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250377648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250377648">(Aug 23 2021 at 16:42)</a>:</h4>
<p>I tried pushing closure analysis to even further below in typechk (after regionchk -- which is incorrect) but still we didn't resolve the types</p>



<a name="250377735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250377735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250377735">(Aug 23 2021 at 16:43)</a>:</h4>
<p>I'm going to dig in a bit right now</p>



<a name="250377764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250377764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250377764">(Aug 23 2021 at 16:43)</a>:</h4>
<p>The issue is the same with <a href="https://github.com/rust-lang/rust/issues/88118">#88118</a> where we fail to resolve the type of the function param</p>



<a name="250377911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250377911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250377911">(Aug 23 2021 at 16:44)</a>:</h4>
<p>As a sanity check I tried using rust builds from earlier this year to see if something changed outside of 2229, but that didn't help</p>



<a name="250377980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250377980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250377980">(Aug 23 2021 at 16:45)</a>:</h4>
<p>OK</p>



<a name="250378015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250378015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250378015">(Aug 23 2021 at 16:45)</a>:</h4>
<p>I was wondering what was wrong with <a href="https://github.com/rust-lang/rust/issues/88118">#88118</a>, good to know that they seem similar</p>



<a name="250388011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250388011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donough Liu <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250388011">(Aug 23 2021 at 18:00)</a>:</h4>
<p>I think the reason <a href="https://github.com/rust-lang/rust/issues/87814">#87814</a> fails is that the coercion result of <code>Err(()) as Result&lt;(), _&gt;</code> is <code>Result&lt;(), _&gt;</code> rather than <code>Result&lt;(), ()&gt;</code>, which makes type var resolving failed. The commit that introduces the regression just propagates the error rather than silently ignores it. The code uses <code>cat_pattern</code> before this commit just swallows the error and continue.</p>



<a name="250388631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250388631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250388631">(Aug 23 2021 at 18:05)</a>:</h4>
<p><code>Result&lt;(), _&gt;</code> is valid because the only part of type information missing from <code>Err(())</code> is the type of the <code>Ok</code> case.</p>
<p>We can see that it works as expected: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d721faa40b5216614fec41ef78a3c970">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d721faa40b5216614fec41ef78a3c970</a></p>



<a name="250389004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250389004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donough Liu <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250389004">(Aug 23 2021 at 18:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281950">Aman Arora</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/Issue.20.2387814/near/250388631">said</a>:</p>
<blockquote>
<p><code>Result&lt;(), _&gt;</code> is valid because the only part of type information missing from <code>Err(())</code> is the type of the <code>Ok</code> case.</p>
<p>We can see that it works as expected: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d721faa40b5216614fec41ef78a3c970">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d721faa40b5216614fec41ef78a3c970</a></p>
</blockquote>
<p>It's valid. But at the stage of calling <code>cat_pattern</code>, I just cannot resolve the <code>_</code> to <code>()</code>.</p>



<a name="250389118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250389118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donough Liu <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250389118">(Aug 23 2021 at 18:09)</a>:</h4>
<p>At least I didn't find a way to do this.</p>



<a name="250389297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250389297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Donough Liu <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250389297">(Aug 23 2021 at 18:11)</a>:</h4>
<p>And I guess the issue <a href="https://github.com/rust-lang/rust/issues/88118">#88118</a> is also the same. <span aria-label="mask" class="emoji emoji-1f637" role="img" title="mask">:mask:</span></p>



<a name="250392765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250392765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250392765">(Aug 23 2021 at 18:33)</a>:</h4>
<p>I'm still investigating</p>



<a name="250392772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250392772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250392772">(Aug 23 2021 at 18:33)</a>:</h4>
<p>I don't quite get what's going on yet</p>



<a name="250392830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250392830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250392830">(Aug 23 2021 at 18:34)</a>:</h4>
<p>I see most of the links, but it seems like there's enough type information</p>



<a name="250392864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250392864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250392864">(Aug 23 2021 at 18:34)</a>:</h4>
<p>I'm not sure how <a href="https://github.com/rust-lang/rust/issues/88118">#88118</a> is related yet</p>



<a name="250394841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250394841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250394841">(Aug 23 2021 at 18:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/Issue.20.2387814/near/250392864">said</a>:</p>
<blockquote>
<p>I'm not sure how <a href="https://github.com/rust-lang/rust/issues/88118">#88118</a> is related yet</p>
</blockquote>
<p><a href="https://github.com/rust-lang/rust/blob/6aa9937a768bf13e5f7bd0ee6dd8579403b39058/compiler/rustc_typeck/src/expr_use_visitor.rs#L127">https://github.com/rust-lang/rust/blob/6aa9937a768bf13e5f7bd0ee6dd8579403b39058/compiler/rustc_typeck/src/expr_use_visitor.rs#L127</a></p>
<p>We get an Ty::Infer here and we end up exiting early instead of capturing <code>handler</code></p>



<a name="250395059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395059">(Aug 23 2021 at 18:51)</a>:</h4>
<p>ok</p>



<a name="250395066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395066">(Aug 23 2021 at 18:51)</a>:</h4>
<p>I found the bug for <a href="https://github.com/rust-lang/rust/issues/87814">#87814</a></p>



<a name="250395073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395073">(Aug 23 2021 at 18:51)</a>:</h4>
<p>let me see if <a href="https://github.com/rust-lang/rust/issues/88118">#88118</a> is fixed too</p>



<a name="250395127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395127">(Aug 23 2021 at 18:51)</a>:</h4>
<p>yes, it is</p>



<a name="250395148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395148">(Aug 23 2021 at 18:51)</a>:</h4>
<p>The problem is this:</p>



<a name="250395229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395229">(Aug 23 2021 at 18:52)</a>:</h4>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/compiler/rustc_typeck/src/check/mod.rs b/compiler/rustc_typeck/src/check/mod.rs</span>
<span class="gh">index ad7e96e2833..ff6cb35a752 100644</span>
<span class="gd">--- a/compiler/rustc_typeck/src/check/mod.rs</span>
<span class="gi">+++ b/compiler/rustc_typeck/src/check/mod.rs</span>
<span class="gu">@@ -446,11 +446,12 @@ fn typeck_with_fallback&lt;'tcx&gt;(</span>
             fcx
         };

<span class="gd">-        fcx.type_inference_fallback();</span>
<span class="gi">+        let fallback_has_occurred = fcx.type_inference_fallback();</span>

         // Even though coercion casts provide type hints, we check casts after fallback for
         // backwards compatibility. This makes fallback a stronger type hint than a cast coercion.
         fcx.check_casts();
<span class="gi">+        fcx.select_obligations_where_possible(fallback_has_occurred, |_| {});</span>

         // Closure and generator analysis may run after fallback
         // because they don't constrain other type variables.
</code></pre></div>



<a name="250395233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395233">(Aug 23 2021 at 18:52)</a>:</h4>
<p>or rather, the fix</p>



<a name="250395282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395282">(Aug 23 2021 at 18:52)</a>:</h4>
<p>so what happens here is that the type checker has some internal state of "stuff I need to prove at some point" (which we call 'obligations')</p>



<a name="250395300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395300">(Aug 23 2021 at 18:52)</a>:</h4>
<p>some of those are "subtype obligations", which have the form: T1 &lt;: T2</p>



<a name="250395313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395313">(Aug 23 2021 at 18:53)</a>:</h4>
<p>i.e., T1 is assignable to T2</p>



<a name="250395333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395333">(Aug 23 2021 at 18:53)</a>:</h4>
<p>in the case of this <strong>particular</strong> example</p>



<a name="250395346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395346">(Aug 23 2021 at 18:53)</a>:</h4>
<p>because of how coercion, subtyping, etc work</p>



<a name="250395373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395373">(Aug 23 2021 at 18:53)</a>:</h4>
<p>we would up where there was one crucial link in the form of a subtype obligation</p>



<a name="250395518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395518">(Aug 23 2021 at 18:54)</a>:</h4>
<p>Thank you so much for finding this!</p>



<a name="250395529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395529">(Aug 23 2021 at 18:54)</a>:</h4>
<p>basically you had some variables like:</p>
<ul>
<li><code>Result&lt;_, ()&gt;</code> cast to <code>Result&lt;(), #15t&gt;</code> (which is a "deferred cast" that gets checked by <code>check_casts</code>)</li>
<li><code>Result&lt;_, #15t&gt;</code> subtype of <code>Result&lt;(), #18t&gt;</code> (this obligation can be proven once <a href="https://github.com/rust-lang/rust/issues/15">#15</a> is known to be <code>()</code>)</li>
</ul>



<a name="250395568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395568">(Aug 23 2021 at 18:55)</a>:</h4>
<p>the <code>Result&lt;(), _#18t&gt;</code> is what the upvar code would see</p>



<a name="250395584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395584">(Aug 23 2021 at 18:55)</a>:</h4>
<p>so if we <em>just</em> did <code>check_casts</code></p>



<a name="250395601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395601">(Aug 23 2021 at 18:55)</a>:</h4>
<p>we set <code>_#15t</code> to <code>()</code> but we never processed that subtype obligation</p>



<a name="250395609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395609">(Aug 23 2021 at 18:55)</a>:</h4>
<p>so <code>_#18t</code> remained unchanged</p>



<a name="250395627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395627">(Aug 23 2021 at 18:55)</a>:</h4>
<p>really, calling <code>check_casts</code> <em>after</em> type inference fallback is pretty bogus</p>



<a name="250395649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395649">(Aug 23 2021 at 18:55)</a>:</h4>
<p>we're not supposed to do any subtyping or other things after fallback</p>



<a name="250395683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395683">(Aug 23 2021 at 18:56)</a>:</h4>
<p>...but I don't want to change that now :)</p>



<a name="250395704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395704">(Aug 23 2021 at 18:56)</a>:</h4>
<p>and this fix seems fine</p>



<a name="250395732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395732">(Aug 23 2021 at 18:56)</a>:</h4>
<p>I guess I'll open a PR</p>



<a name="250395745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395745">(Aug 23 2021 at 18:56)</a>:</h4>
<p>Thank you</p>



<a name="250395756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395756">(Aug 23 2021 at 18:56)</a>:</h4>
<p>yeah that was a tricky one :)</p>



<a name="250395859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250395859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rocksand <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250395859">(Aug 23 2021 at 18:57)</a>:</h4>
<p>Thank you : <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="250398954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/Issue%20%2387814/near/250398954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/Issue.20.2387814.html#250398954">(Aug 23 2021 at 19:20)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/88266">https://github.com/rust-lang/rust/pull/88266</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>