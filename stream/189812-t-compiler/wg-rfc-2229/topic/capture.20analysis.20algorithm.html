<html>
<head><meta charset="utf-8"><title>capture analysis algorithm · t-compiler/wg-rfc-2229 · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/index.html">t-compiler/wg-rfc-2229</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html">capture analysis algorithm</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249783944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249783944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249783944">(Aug 17 2021 at 21:54)</a>:</h4>
<p>So I was reading the <a href="https://github.com/sexxi-goose/reference/blob/closure-doc/src/types/closure.md#overall-capture-analysis-algorithm">reference PR</a> and my feeling is that </p>
<ul>
<li>we need to improve the presentation of this algorithm =)</li>
<li>I am still not thrilled with "ref-unique" being part of the modes that come from the initial analysis; it feels like it should be something we apply at the end, after truncation? I kind of forget where we landed on this</li>
</ul>



<a name="249783967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249783967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249783967">(Aug 17 2021 at 21:54)</a>:</h4>
<p>Oh I think I need to clean that up</p>



<a name="249783986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249783986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249783986">(Aug 17 2021 at 21:55)</a>:</h4>
<p>I dont think we get ref uniq there anymore</p>



<a name="249786387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786387">(Aug 17 2021 at 22:20)</a>:</h4>
<p>The other question is where we landed when it comes to by-value access to copy types</p>



<a name="249786427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786427">(Aug 17 2021 at 22:21)</a>:</h4>
<p>ExprUseVisitor never calls ByValue with Copy types</p>



<a name="249786443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786443">(Aug 17 2021 at 22:21)</a>:</h4>
<p>It automatically changes them to ImmBorrow</p>



<a name="249786476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786476">(Aug 17 2021 at 22:21)</a>:</h4>
<p>OK, great</p>



<a name="249786527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786527">(Aug 17 2021 at 22:22)</a>:</h4>
<p>so really the modes are "ref", "ref mut", and "move"</p>



<a name="249786533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786533">(Aug 17 2021 at 22:22)</a>:</h4>
<p>(so to speak)</p>



<a name="249786548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786548">(Aug 17 2021 at 22:22)</a>:</h4>
<p>And when we have a move closure we deal with same way as others</p>



<a name="249786556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786556">(Aug 17 2021 at 22:22)</a>:</h4>
<p>Yes, that's correct</p>



<a name="249786577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786577">(Aug 17 2021 at 22:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281950">Aman Arora</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/capture.20analysis.20algorithm/near/249786548">said</a>:</p>
<blockquote>
<p>And when we have a move closure we deal with same way as others</p>
</blockquote>
<p>what do you mean by this?</p>



<a name="249786599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786599">(Aug 17 2021 at 22:23)</a>:</h4>
<p>I don't think having a move closure should affect how <code>ExprUseVisitor</code> classifies things, right?</p>



<a name="249786614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786614">(Aug 17 2021 at 22:23)</a>:</h4>
<p>it just gets transformed to a "move" mode later on</p>



<a name="249786624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786624">(Aug 17 2021 at 22:23)</a>:</h4>
<p>Eg: x.y.z will become ByValue</p>



<a name="249786635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786635">(Aug 17 2021 at 22:23)</a>:</h4>
<p>Regardless of Copy</p>



<a name="249786640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786640">(Aug 17 2021 at 22:23)</a>:</h4>
<p>Exactly</p>



<a name="249786727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786727">(Aug 17 2021 at 22:24)</a>:</h4>
<p><a href="https://hackmd.io/49cGGbsKTcy1s6uMeKWP0A#What-data-does-a-closure-use">https://hackmd.io/49cGGbsKTcy1s6uMeKWP0A#What-data-does-a-closure-use</a></p>



<a name="249786742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786742">(Aug 17 2021 at 22:24)</a>:</h4>
<p><a href="https://hackmd.io/49cGGbsKTcy1s6uMeKWP0A#Capture-algorithm-precise-description">https://hackmd.io/49cGGbsKTcy1s6uMeKWP0A#Capture-algorithm-precise-description</a></p>



<a name="249786747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/capture%20analysis%20algorithm/near/249786747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/capture.20analysis.20algorithm.html#249786747">(Aug 17 2021 at 22:24)</a>:</h4>
<p>if you get a chance, check those and let me know if they sound right</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>