<html>
<head><meta charset="utf-8"><title>measure closure sizes · t-compiler/wg-rfc-2229 · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/index.html">t-compiler/wg-rfc-2229</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html">measure closure sizes</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="245228558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245228558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245228558">(Jul 07 2021 at 19:13)</a>:</h4>
<p>Hey <span class="user-group-mention" data-user-group-id="1175">@WG-rfc-2229</span>, we were discussing the question of how to measure closure sizes, and <span class="user-mention" data-user-id="116122">@simulacrum</span> suggested that instead of soliciting people to send in their measurements, we may want to just run the measurements <em>ourselves</em> using crater.</p>



<a name="245228574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245228574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245228574">(Jul 07 2021 at 19:13)</a>:</h4>
<p>I'm not sure how hard that is, I've never modified crater myself, <span class="user-mention" data-user-id="116122">@simulacrum</span> can perhaps weigh in</p>



<a name="245228606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245228606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245228606">(Jul 07 2021 at 19:13)</a>:</h4>
<p><span class="user-mention" data-user-id="281950">@Aman Arora</span>, does the <code>-Z</code> flag today generate a file as output, or dump to stderr?</p>



<a name="245228619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245228619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245228619">(Jul 07 2021 at 19:14)</a>:</h4>
<p>a file</p>



<a name="245228678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245228678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245228678">(Jul 07 2021 at 19:14)</a>:</h4>
<p>so we have just collect all closure_profile_*.csv</p>



<a name="245228787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245228787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245228787">(Jul 07 2021 at 19:15)</a>:</h4>
<p>OK. We <em>may</em> find it easier if we dump it to stdout, though we could readily do that at the end of process.</p>



<a name="245228807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245228807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245228807">(Jul 07 2021 at 19:15)</a>:</h4>
<p>Just beacuse that data is then collected in the logs, which I guess we can scrape.</p>



<a name="245229685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245229685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245229685">(Jul 07 2021 at 19:22)</a>:</h4>
<p>I am going to write up some notes later today</p>



<a name="245229691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245229691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245229691">(Jul 07 2021 at 19:22)</a>:</h4>
<p>that won't be hard</p>



<a name="245229712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245229712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245229712">(Jul 07 2021 at 19:23)</a>:</h4>
<p>that was for outputitng to stdout ^</p>



<a name="245229789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245229789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245229789">(Jul 07 2021 at 19:23)</a>:</h4>
<p>I don't think it'll be too hard</p>



<a name="245229831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245229831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245229831">(Jul 07 2021 at 19:23)</a>:</h4>
<p>Do we have a rough idea of how much data it is per crate?</p>



<a name="245230012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245230012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245230012">(Jul 07 2021 at 19:25)</a>:</h4>
<p>Most crates under 100 lines</p>



<a name="245230147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245230147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245230147">(Jul 07 2021 at 19:26)</a>:</h4>
<p>Cargo serde syn were all closer to 50 than 100</p>



<a name="245230329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245230329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245230329">(Jul 07 2021 at 19:27)</a>:</h4>
<p>compiler + stdlib + rustdoc + any dependencies that we have from <a href="http://crates.io">crates.io</a> were together &lt; 20k lines</p>



<a name="245254196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245254196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245254196">(Jul 07 2021 at 23:13)</a>:</h4>
<p>oh that sounds very small, great</p>



<a name="245254330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245254330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245254330">(Jul 07 2021 at 23:14)</a>:</h4>
<p>I think in that case I would just dump to stdout with a known prefix (e.g., e93ae495ec -- we'll need to grep for it) before each line.</p>
<p>It probably makes sense to try and include the number of records so that we know we missed stuff, too</p>



<a name="245254347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245254347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245254347">(Jul 07 2021 at 23:15)</a>:</h4>
<p>stderr might actually work better</p>



<a name="245254453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245254453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245254453">(Jul 07 2021 at 23:16)</a>:</h4>
<p>but you can do a mini-crater with a high priority to test the idea -- <a href="https://github.com/rust-lang/crater/blob/master/docs/bot-usage.md#available-crate-selections">https://github.com/rust-lang/crater/blob/master/docs/bot-usage.md#available-crate-selections</a> with list:cargo or something might work well. I think we'll only want to emit on workspace crates, we can probably look for cap-lints to figure out when to emit or so.</p>



<a name="245254515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245254515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245254515">(Jul 07 2021 at 23:17)</a>:</h4>
<p>once we have a run done, we can use the all logs tarball to easily get the logs and analyze them as needed; see the available tarballs for the last beta run here - <a href="https://crater-reports.s3.amazonaws.com/beta-1.54-1/downloads.html">https://crater-reports.s3.amazonaws.com/beta-1.54-1/downloads.html</a> -- those will be available for your runs too.</p>



<a name="245254546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245254546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245254546">(Jul 07 2021 at 23:17)</a>:</h4>
<p><span class="user-mention" data-user-id="281950">@Aman Arora</span> With this we shouldn't have to modify crater at all which will streamline the process a lot</p>



<a name="245254602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245254602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245254602">(Jul 07 2021 at 23:18)</a>:</h4>
<p>if we do end up needing to modify it, my guess is the easy thing will be to temporarily bump the limits of lines/bytes emitted per log up, and then we can just go with this. That would be nearly trivial.</p>



<a name="245254618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245254618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245254618">(Jul 07 2021 at 23:18)</a>:</h4>
<p>Let me know if I can provide further hints/help here!</p>



<a name="245266839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245266839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245266839">(Jul 08 2021 at 02:43)</a>:</h4>
<p>I'll try this tomorrow, thanks</p>



<a name="245618936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245618936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245618936">(Jul 11 2021 at 17:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281950">Aman Arora</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/245230147">said</a>:</p>
<blockquote>
<p>Cargo serde syn were all closer to 50 than 100</p>
</blockquote>
<p>I think I confused some stat within the closure profile to the actual numbers. cargo is closer to 2k lines of output, serder_derive was 150ish</p>



<a name="245702432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245702432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245702432">(Jul 12 2021 at 15:26)</a>:</h4>
<p><span class="user-mention" data-user-id="281950">@Aman Arora</span> did you mean -Zprofile-closures on both start and end toolchains for <a href="https://github.com/rust-lang/rust/pull/87066#issuecomment-877847095">https://github.com/rust-lang/rust/pull/87066#issuecomment-877847095</a>?</p>



<a name="245702448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245702448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245702448">(Jul 12 2021 at 15:26)</a>:</h4>
<p>Or does it give comparative results?</p>



<a name="245702550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245702550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245702550">(Jul 12 2021 at 15:27)</a>:</h4>
<p>-Zprofile-closures compares on its own. So it will compute the size before and size after 2229 is enabled within the same compile</p>



<a name="245702564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245702564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245702564">(Jul 12 2021 at 15:27)</a>:</h4>
<p>OK, great</p>



<a name="245702695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245702695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245702695">(Jul 12 2021 at 15:28)</a>:</h4>
<p>That should run in ~4-5 hours, I believe, and we'll see if it works then</p>



<a name="245755729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/245755729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#245755729">(Jul 12 2021 at 21:59)</a>:</h4>
<p>So the test failed (also on master it seems)</p>
<p>One thing I realized that in our full run we'd a lot of duplicate information because we are using RUSTFLAGS. </p>
<p>Since all dependencies would also emit data, so if two crate have the same dependency the data from it will be emitted multiple times</p>



<a name="246272511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272511">(Jul 16 2021 at 20:10)</a>:</h4>
<p>Hm</p>



<a name="246272554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272554">(Jul 16 2021 at 20:11)</a>:</h4>
<p><a href="https://crater-reports.s3.amazonaws.com/pr-87066-1/try%238a4c071f46be56484e9723bd8f1e5eea08177963%2Brustflags=-Zprofile-closures/reg/cargo-0.54.0/log.txt">https://crater-reports.s3.amazonaws.com/pr-87066-1/try%238a4c071f46be56484e9723bd8f1e5eea08177963%2Brustflags=-Zprofile-closures/reg/cargo-0.54.0/log.txt</a> looks like it also hit the 100KB limit and might've been externally killed as a result, I'm not quite sure</p>



<a name="246272587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272587">(Jul 16 2021 at 20:11)</a>:</h4>
<p><a href="https://github.com/rust-lang/crater/blob/master/config.toml#L32-L33">https://github.com/rust-lang/crater/blob/master/config.toml#L32-L33</a> -- looks like I remembered wrong, that's probably just coincidental</p>



<a name="246272677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272677">(Jul 16 2021 at 20:12)</a>:</h4>
<p>In any case <span class="user-mention" data-user-id="281950">@Aman Arora</span> I'd suggest we try again, but remove everything except a hash of the location of the closure -- that'll be much smaller than the full line info debug print</p>



<a name="246272725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272725">(Jul 16 2021 at 20:12)</a>:</h4>
<p>Can we take the hash and go back to the original closure locatiot?</p>



<a name="246272732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272732">(Jul 16 2021 at 20:13)</a>:</h4>
<p>Location*</p>



<a name="246272756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272756">(Jul 16 2021 at 20:13)</a>:</h4>
<p>Also should I just skip printing if both before and after are 0?</p>



<a name="246272794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272794">(Jul 16 2021 at 20:13)</a>:</h4>
<p>I think I'd not skip printing any closures</p>



<a name="246272803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272803">(Jul 16 2021 at 20:13)</a>:</h4>
<p>that'll skew our results a little.</p>



<a name="246272852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272852">(Jul 16 2021 at 20:14)</a>:</h4>
<p>Fair enough</p>



<a name="246272856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272856">(Jul 16 2021 at 20:14)</a>:</h4>
<p>We can't take the hash, but ultimately, if anything looks notable we can rerun that particular crate locally</p>



<a name="246272870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272870">(Jul 16 2021 at 20:14)</a>:</h4>
<p>the hash is only really so we can deduplicate across crates, I think</p>



<a name="246272900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272900">(Jul 16 2021 at 20:14)</a>:</h4>
<p>Looking at the last beta run, it seems like libc compiles fine</p>



<a name="246272958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272958">(Jul 16 2021 at 20:15)</a>:</h4>
<p>serde_derive does too.</p>



<a name="246272976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246272976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246272976">(Jul 16 2021 at 20:15)</a>:</h4>
<p>So we might try some other crates.</p>



<a name="246273049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246273049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246273049">(Jul 16 2021 at 20:16)</a>:</h4>
<p>I'm not sure if we want to deduplicate based on span. The closure can be within a generic function and then type parameters might have different sizes</p>



<a name="246273289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246273289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246273289">(Jul 16 2021 at 20:18)</a>:</h4>
<p>Hm</p>



<a name="246273302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246273302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246273302">(Jul 16 2021 at 20:18)</a>:</h4>
<p>I imagine we could put <em>something</em> in the hash to make it unique</p>



<a name="246273368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246273368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246273368">(Jul 16 2021 at 20:19)</a>:</h4>
<p>I guess ultimately it doesn't matter too much wrt to deduplication, we can likely just skip the hash too. This is really for broad analysis, which if it has duplicates will just weight more widely used projects more heavily</p>



<a name="246273373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246273373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246273373">(Jul 16 2021 at 20:19)</a>:</h4>
<p>which seems OK</p>



<a name="246273492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246273492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246273492">(Jul 16 2021 at 20:20)</a>:</h4>
<p>I'd assume ty::Instance used for codegen in MIR is somewhat unique? Or deduplicated to some degree</p>



<a name="246273564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246273564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246273564">(Jul 16 2021 at 20:21)</a>:</h4>
<p>codegen would already have generics instantiated, I think, so it should be pretty close to a good thing to hash, I'd imagine</p>



<a name="246273579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246273579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246273579">(Jul 16 2021 at 20:21)</a>:</h4>
<p>(You'd want the stable hash, I believe, not the regular hash impl)</p>



<a name="246273586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246273586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246273586">(Jul 16 2021 at 20:21)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span> as well</p>



<a name="246308208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246308208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246308208">(Jul 17 2021 at 06:23)</a>:</h4>
<p>This all sounds right</p>



<a name="246483957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246483957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246483957">(Jul 19 2021 at 17:15)</a>:</h4>
<p>I have pushed a change to output the stable hash. In the change i pushed I also reduced the size of the prefix a bit</p>
<p><a href="/user_uploads/4715/kQP7BE_ZqLCfq85KePtByh53/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/kQP7BE_ZqLCfq85KePtByh53/image.png" title="image.png"><img src="/user_uploads/4715/kQP7BE_ZqLCfq85KePtByh53/image.png"></a></div>



<a name="246733199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246733199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246733199">(Jul 21 2021 at 15:07)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> can you restart the crater run please? Thank you</p>



<a name="246733304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/246733304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#246733304">(Jul 21 2021 at 15:08)</a>:</h4>
<p>will do later today</p>



<a name="249752895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/249752895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#249752895">(Aug 17 2021 at 17:41)</a>:</h4>
<p>I totally forgot about this, <span class="user-mention" data-user-id="116122">@simulacrum</span>  can you please trigger a full run</p>



<a name="249752935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/249752935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#249752935">(Aug 17 2021 at 17:41)</a>:</h4>
<p><span class="user-mention" data-user-id="281950">@Aman Arora</span> with the current PR?</p>



<a name="249752953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/249752953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#249752953">(Aug 17 2021 at 17:41)</a>:</h4>
<p>(do you want it with the old try build or on a new one?)</p>



<a name="249753419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/249753419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#249753419">(Aug 17 2021 at 17:46)</a>:</h4>
<p>New might be better</p>



<a name="249753534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/249753534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#249753534">(Aug 17 2021 at 17:47)</a>:</h4>
<p>@roxelo made some bug fixes, maybe we should wait for the open ones to be merged <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> since atleast one of them changes what gets captured</p>



<a name="249753567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/249753567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#249753567">(Aug 17 2021 at 17:47)</a>:</h4>
<p>hm, ok</p>



<a name="249753582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/249753582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#249753582">(Aug 17 2021 at 17:47)</a>:</h4>
<p>well, queued up a try build, feel free to cherry pick onto this PR</p>



<a name="249754010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/249754010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#249754010">(Aug 17 2021 at 17:51)</a>:</h4>
<p>Fair enough, I'll wait for discussions to resolve in case the solution changes</p>



<a name="249787604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/249787604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#249787604">(Aug 17 2021 at 22:33)</a>:</h4>
<p>Is there some summary <span class="user-mention" data-user-id="281950">@Aman Arora</span> of the latest closure size measurements?</p>



<a name="249792095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/249792095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#249792095">(Aug 17 2021 at 23:32)</a>:</h4>
<p>I only have compiler and cargo for now. I had a really busy last two week and this slipped my mind. We should test this once the change for <a href="https://github.com/rust-lang/rust/issues/87814">#87814</a> is merged</p>



<a name="249792536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/249792536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#249792536">(Aug 17 2021 at 23:40)</a>:</h4>
<p>OK-- it's all right, but we can amend the content in <a href="https://github.com/rust-lang/rust/issues/88126">https://github.com/rust-lang/rust/issues/88126</a> with add'l data</p>



<a name="250034374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250034374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250034374">(Aug 19 2021 at 19:12)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span>  Is there a script to download all the log files?</p>



<a name="250034429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250034429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250034429">(Aug 19 2021 at 19:13)</a>:</h4>
<p>uh, there's tarballs</p>



<a name="250034505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250034505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250034505">(Aug 19 2021 at 19:13)</a>:</h4>
<p><span class="user-mention" data-user-id="281950">@Aman Arora</span> <a href="https://crater-reports.s3.amazonaws.com/pr-87066-3/downloads.html">https://crater-reports.s3.amazonaws.com/pr-87066-3/downloads.html</a></p>



<a name="250034532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250034532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250034532">(Aug 19 2021 at 19:13)</a>:</h4>
<p>you probably want all.tar.gz and then you can figure it out from there</p>



<a name="250034595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250034595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250034595">(Aug 19 2021 at 19:14)</a>:</h4>
<p>(the directory structure is pretty obvious once you look)</p>



<a name="250034669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250034669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250034669">(Aug 19 2021 at 19:14)</a>:</h4>
<p>Sweet, thanks</p>



<a name="250662254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250662254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250662254">(Aug 25 2021 at 18:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/250034505">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281950">Aman Arora</span> <a href="https://crater-reports.s3.amazonaws.com/pr-87066-3/downloads.html">https://crater-reports.s3.amazonaws.com/pr-87066-3/downloads.html</a></p>
</blockquote>
<p>original size:</p>
<div class="codehilite"><pre><span></span><code>0..16:                 count=8975928                 avg_old=2.939998738849064                 avg_change=0.2572048260636672                 percentage_change=8.748467224321207
16..32:                 count=955973                 avg_old=18.091243162725306                 avg_change=1.2895332817977077                 percentage_change=7.127941790394074
32..64:                 count=178807                 avg_old=38.53406745820913                 avg_change=2.3893471732091025                 percentage_change=6.200609826098404
64..512:                 count=49083                 avg_old=152.14267669050383                 avg_change=-1.106207852005786                 percentage_change=-0.7270858355253529
0..MAX:                 count=10163957                 avg_old=6.510008749545084                 avg_change=0.38127148707929404                 percentage_change=5.856696999154373
</code></pre></div>



<a name="250663471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250663471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250663471">(Aug 25 2021 at 18:49)</a>:</h4>
<p><a href="/user_uploads/4715/1CRfRNZeCe8RaXSHuJhEEC-U/compute.sh">compute.sh</a> <a href="/user_uploads/4715/IW_26mYxNPqk26RD3cUgXRED/compute.py">compute.py</a></p>



<a name="250663594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250663594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250663594">(Aug 25 2021 at 18:50)</a>:</h4>
<p>Place both of these in the root of the extracted all.gz</p>
<p>run <code>./compute.sh</code></p>



<a name="250670879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250670879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250670879">(Aug 25 2021 at 19:35)</a>:</h4>
<table>
<thead>
<tr>
<th>original size range in bytes</th>
<th>count</th>
<th>avg old size in bytes</th>
<th>avg change in bytes</th>
<th>% change</th>
</tr>
</thead>
<tbody>
<tr>
<td>0..16</td>
<td>count=8975928</td>
<td>avg_old=2.939998738849064</td>
<td>avg_change=0.2572048260636672</td>
<td>percentage_change=8.748467224321207</td>
</tr>
</tbody>
</table>



<a name="250670964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250670964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250670964">(Aug 25 2021 at 19:36)</a>:</h4>
<p>meh, I was going to convert it to the table, but it's too much work :)</p>



<a name="250671012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250671012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250671012">(Aug 25 2021 at 19:36)</a>:</h4>
<p>I can change the CSV output</p>



<a name="250671047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250671047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250671047">(Aug 25 2021 at 19:36)</a>:</h4>
<p>Change to CSV *</p>



<a name="250671829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250671829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250671829">(Aug 25 2021 at 19:43)</a>:</h4>
<table>
<thead>
<tr>
<th>start</th>
<th>end</th>
<th>avg size (bytes)</th>
<th>avg_change (bytes)</th>
<th>percentage_change</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>16</td>
<td>2.939998738849064</td>
<td>0.2572048260636672</td>
<td>8.748467224321207</td>
</tr>
<tr>
<td>16</td>
<td>32</td>
<td>18.091243162725306</td>
<td>1.2895332817977077</td>
<td>7.127941790394074</td>
</tr>
<tr>
<td>32</td>
<td>64</td>
<td>38.53406745820913</td>
<td>2.3893471732091025</td>
<td>6.200609826098404</td>
</tr>
<tr>
<td>64</td>
<td>512</td>
<td>152.14267669050383</td>
<td>-1.106207852005786</td>
<td>-0.7270858355253529</td>
</tr>
<tr>
<td>0</td>
<td>MAX</td>
<td>6.510008749545084</td>
<td>0.38127148707929404</td>
<td>5.856696999154373</td>
</tr>
</tbody>
</table>



<a name="250672261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250672261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250672261">(Aug 25 2021 at 19:46)</a>:</h4>
<p>nice</p>



<a name="250672289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250672289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250672289">(Aug 25 2021 at 19:46)</a>:</h4>
<p>I feel pretty ok about those results</p>



<a name="250672318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250672318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250672318">(Aug 25 2021 at 19:46)</a>:</h4>
<p>do you have the frequency?</p>



<a name="250672328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250672328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250672328">(Aug 25 2021 at 19:46)</a>:</h4>
<p>i.e., number of closures in each category?</p>



<a name="250672386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250672386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250672386">(Aug 25 2021 at 19:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281950">Aman Arora</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/250662254">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/250034505">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281950">Aman Arora</span> <a href="https://crater-reports.s3.amazonaws.com/pr-87066-3/downloads.html">https://crater-reports.s3.amazonaws.com/pr-87066-3/downloads.html</a></p>
</blockquote>
<p>original size range in bytes (upper bound exlusive), count, avg old size in bytes, avg change in bytes</p>
<p><div class="codehilite"><pre><span></span><code>0..16:                 count=8975928                 avg_old=2.939998738849064                 avg_change=0.2572048260636672                 percentage_change=8.748467224321207
16..32:                 count=955973                 avg_old=18.091243162725306                 avg_change=1.2895332817977077                 percentage_change=7.127941790394074
32..64:                 count=178807                 avg_old=38.53406745820913                 avg_change=2.3893471732091025                 percentage_change=6.200609826098404
64..512:                 count=49083                 avg_old=152.14267669050383                 avg_change=-1.106207852005786                 percentage_change=-0.7270858355253529
0..MAX:                 count=10163957                 avg_old=6.510008749545084                 avg_change=0.38127148707929404                 percentage_change=5.856696999154373
</code></pre></div><br>
</p>
</blockquote>
<p>its here, i messed something up while converiting to md</p>



<a name="250672422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250672422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250672422">(Aug 25 2021 at 19:47)</a>:</h4>
<p>yeah, I saw that after I asked</p>



<a name="250672998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250672998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250672998">(Aug 25 2021 at 19:51)</a>:</h4>
<table>
<thead>
<tr>
<th>start</th>
<th>end</th>
<th>count</th>
<th>avg old size (bytes)</th>
<th>avg change (bytes)</th>
<th>% change</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>16</td>
<td>17951856</td>
<td>2.939998738849064</td>
<td>0.2572048260636672</td>
<td>8.748467224321207</td>
</tr>
<tr>
<td>16</td>
<td>32</td>
<td>1911946</td>
<td>18.091243162725306</td>
<td>1.2895332817977077</td>
<td>7.127941790394074</td>
</tr>
<tr>
<td>32</td>
<td>64</td>
<td>357614</td>
<td>38.53406745820913</td>
<td>2.3893471732091025</td>
<td>6.200609826098404</td>
</tr>
<tr>
<td>64</td>
<td>512</td>
<td>98166</td>
<td>152.14267669050383</td>
<td>-1.106207852005786</td>
<td>-0.7270858355253529</td>
</tr>
<tr>
<td>0</td>
<td>MAX</td>
<td>20327914</td>
<td>6.510008749545084</td>
<td>0.38127148707929404</td>
<td>5.856696999154373</td>
</tr>
</tbody>
</table>



<a name="250673083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250673083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250673083">(Aug 25 2021 at 19:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281950">Aman Arora</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/250663471">said</a>:</p>
<blockquote>
<p><a href="/user_uploads/4715/1CRfRNZeCe8RaXSHuJhEEC-U/compute.sh">compute.sh</a> <br>
<a href="/user_uploads/4715/2-MA5yLkjw-WuxKqFQNL5F43/compute.py">compute.py</a></p>
</blockquote>
<p>script updated to ouput csv and md</p>



<a name="250673275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250673275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250673275">(Aug 25 2021 at 19:53)</a>:</h4>
<p>nice -- is that a large %change than we saw on compiler/rustc, I can't  remember?</p>



<a name="250673283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250673283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250673283">(Aug 25 2021 at 19:54)</a>:</h4>
<p>still, &lt;1 byte change seems .. ok</p>



<a name="250673339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250673339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250673339">(Aug 25 2021 at 19:54)</a>:</h4>
<p>One thing I should add here a lot of popular dependencies are multiple counted here</p>



<a name="250673435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250673435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250673435">(Aug 25 2021 at 19:54)</a>:</h4>
<p>Becuase we are using env variables each dependecy for a crate logs closure size as well</p>



<a name="250673497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250673497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250673497">(Aug 25 2021 at 19:55)</a>:</h4>
<p>We can't quite deduplicate data because closures have the same span/df id when generics get resolved</p>



<a name="250674571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250674571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250674571">(Aug 25 2021 at 20:03)</a>:</h4>
<p>can you add, say, 90th percentile or something (basically how bad does it get)?</p>



<a name="250674615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250674615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250674615">(Aug 25 2021 at 20:03)</a>:</h4>
<p>it would be nice to see the distribution</p>



<a name="250674643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250674643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250674643">(Aug 25 2021 at 20:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/250673275">said</a>:</p>
<blockquote>
<p>nice -- is that a large %change than we saw on compiler/rustc, I can't  remember?</p>
</blockquote>
<p>[Uploading image.png…]()</p>



<a name="250674718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250674718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250674718">(Aug 25 2021 at 20:04)</a>:</h4>
<p>I can try write that up later tonight<br>
<span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/250674571">said</a>:</p>
<blockquote>
<p>can you add, say, 90th percentile or something (basically how bad does it get)?</p>
</blockquote>



<a name="250675013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250675013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250675013">(Aug 25 2021 at 20:06)</a>:</h4>
<p>The current crater run is missing one of the edge cases found in the 2021 crater run that affect what gets captured + non_exhaustive. I have rebased the <a href="https://github.com/rust-lang/rust/pull/87066">PR</a>. </p>
<p>Maybe we do another run after the current open issue for 2229, though I don't expect much to change</p>



<a name="250710637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250710637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250710637">(Aug 26 2021 at 02:23)</a>:</h4>
<p><a href="/user_uploads/4715/MRQxBHjRWaCZWcoQmckpxf-H/Figure_1.png">Figure_1.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/MRQxBHjRWaCZWcoQmckpxf-H/Figure_1.png" title="Figure_1.png"><img src="/user_uploads/4715/MRQxBHjRWaCZWcoQmckpxf-H/Figure_1.png"></a></div>



<a name="250710977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250710977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250710977">(Aug 26 2021 at 02:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281950">Aman Arora</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/250674643">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/250673275">said</a>:</p>
<blockquote>
<p>nice -- is that a large %change than we saw on compiler/rustc, I can't  remember?</p>
</blockquote>
<p>[Uploading image.png…]()</p>
</blockquote>
<p>"[Uploading image.png…]()" lol<br>
"<a href="/user_uploads/4715/RHMS9nTsFbMCv2cVRfP6CLM1/image.png">image.png</a>"</p>
<div class="message_inline_image"><a href="/user_uploads/4715/RHMS9nTsFbMCv2cVRfP6CLM1/image.png" title="image.png"><img src="/user_uploads/4715/RHMS9nTsFbMCv2cVRfP6CLM1/image.png"></a></div>



<a name="250711560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250711560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250711560">(Aug 26 2021 at 02:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281950">Aman Arora</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/250710637">said</a>:</p>
<blockquote>
<p><a href="/user_uploads/4715/MRQxBHjRWaCZWcoQmckpxf-H/Figure_1.png">Figure_1.png</a></p>
</blockquote>
<p><a href="/user_uploads/4715/hr1o-5j1YN0TSh9hiUekFUOS/Figure_2.png">Figure_2.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/hr1o-5j1YN0TSh9hiUekFUOS/Figure_2.png" title="Figure_2.png"><img src="/user_uploads/4715/hr1o-5j1YN0TSh9hiUekFUOS/Figure_2.png"></a></div>



<a name="250711580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250711580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250711580">(Aug 26 2021 at 02:41)</a>:</h4>
<p>I zoomed in on the top 2% area that's &gt; 40 bytes</p>



<a name="250711582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250711582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250711582">(Aug 26 2021 at 02:41)</a>:</h4>
<p><a href="/user_uploads/4715/LDP5HEut7W23SIPhg3E215h6/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/LDP5HEut7W23SIPhg3E215h6/image.png" title="image.png"><img src="/user_uploads/4715/LDP5HEut7W23SIPhg3E215h6/image.png"></a></div>



<a name="250711722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250711722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250711722">(Aug 26 2021 at 02:44)</a>:</h4>
<p>might not be the worst idea to take a dive into increase &gt; 40 bytes, though I won't be surprised if some of these are duplicated entires</p>



<a name="250711823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250711823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250711823">(Aug 26 2021 at 02:46)</a>:</h4>
<p>also maybe someone should ensure there is no stupid errors in this script</p>



<a name="250711828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250711828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250711828">(Aug 26 2021 at 02:46)</a>:</h4>
<p><a href="/user_uploads/4715/f7oyhFN8Z92F5WQvd4KkN2re/compute.py">compute.py</a></p>



<a name="250713479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250713479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250713479">(Aug 26 2021 at 03:16)</a>:</h4>
<p><a href="/user_uploads/4715/DQ6kE8sBHQToD3Y57IIC9Pd-/unique_closure_increase">unique_closure_increase</a> . I depulicated using <code>sort -u</code> I don't think I'm using stable hashing correctly.</p>



<a name="250715281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250715281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aman Arora <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250715281">(Aug 26 2021 at 03:39)</a>:</h4>
<p>Looking at the largest increase, closure is basically starts off &amp;mut and seems like most of the fields are individually captured : <a href="https://github.com/Manishearth/compiletest-rs/blob/master/src/header.rs#L292-L407">https://github.com/Manishearth/compiletest-rs/blob/master/src/header.rs#L292-L407</a></p>
<p>Looking at the one that shows up alot: <a href="https://github.com/hyperium/h2/blob/master/src/frame/headers.rs#L858-L897">https://github.com/hyperium/h2/blob/master/src/frame/headers.rs#L858-L897</a>. Similar to compiletest a lot different fields/fields of fields used starting of <code>&amp;mut self</code></p>



<a name="250746082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250746082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250746082">(Aug 26 2021 at 09:34)</a>:</h4>
<p>Could we continue capturing just &amp;Mut self in machine code but for the purposes of analyses consider it as just capturing the certain fields?</p>



<a name="250746179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250746179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250746179">(Aug 26 2021 at 09:35)</a>:</h4>
<p>(not sure if what I wrote makes much sense at all I've only been following this effort very peripherally)</p>



<a name="250781331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250781331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250781331">(Aug 26 2021 at 14:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281950">Aman Arora</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/250711722">said</a>:</p>
<blockquote>
<p>might not be the worst idea to take a dive into increase &gt; 40 bytes, though I won't be surprised if some of these are duplicated entires</p>
</blockquote>
<p>I agree we should dive into that</p>



<a name="250781347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250781347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250781347">(Aug 26 2021 at 14:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/measure.20closure.20sizes/near/250746082">said</a>:</p>
<blockquote>
<p>Could we continue capturing just &amp;Mut self in machine code but for the purposes of analyses consider it as just capturing the certain fields?</p>
</blockquote>
<p>I would strongly prefer not to do that</p>



<a name="250781387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250781387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250781387">(Aug 26 2021 at 14:33)</a>:</h4>
<p>It is possible, but I really like that we are not "cheating" in the code we generate, I am sure we will get some subtle bugs if we try to be too clever, and it largely seems unnecessary so far</p>



<a name="250781479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250781479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250781479">(Aug 26 2021 at 14:33)</a>:</h4>
<p>That said, I wouldn't be <em>opposed</em> to it if we do it as a "after the fact" MIR transform sort of thing</p>



<a name="250781525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250781525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250781525">(Aug 26 2021 at 14:33)</a>:</h4>
<p>(although that seems hard, now that I think a bit more about it)</p>



<a name="250781980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250781980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250781980">(Aug 26 2021 at 14:36)</a>:</h4>
<p>...still...</p>



<a name="250782066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250782066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250782066">(Aug 26 2021 at 14:36)</a>:</h4>
<p>a kind of goofy transform would be to take a <code>&amp;mut (&amp;mut...&amp;mut)</code></p>



<a name="250782115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/189812-t-compiler/wg-rfc-2229/topic/measure%20closure%20sizes/near/250782115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/189812-t-compiler/wg-rfc-2229/topic/measure.20closure.20sizes.html#250782115">(Aug 26 2021 at 14:37)</a>:</h4>
<p>never mind, that's not equivalent anyway</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>