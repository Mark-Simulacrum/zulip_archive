<html>
<head><meta charset="utf-8"><title>impl-vs-derived-copy · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/impl-vs-derived-copy.html">impl-vs-derived-copy</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272093552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/impl-vs-derived-copy/near/272093552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/impl-vs-derived-copy.html#272093552">(Feb 16 2022 at 09:50)</a>:</h4>
<p>Invoke <code>clone</code> on a enum with <code>impl</code>'ed <code>Copy</code> generates more asm than <code>derive(Copy)</code>, is this intentional?<br>
<a href="https://rust.godbolt.org/z/76o181Yfb">https://rust.godbolt.org/z/76o181Yfb</a></p>



<a name="272093898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/impl-vs-derived-copy/near/272093898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/impl-vs-derived-copy.html#272093898">(Feb 16 2022 at 09:53)</a>:</h4>
<p>For derived copy in the same <code>#[derive]</code> as the clone derive, the clone derive knows that it is possible to do <code>*self</code> which results in a memcpy. If there is no derived copy, each field has to be individually cloned.</p>



<a name="272094779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/impl-vs-derived-copy/near/272094779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/impl-vs-derived-copy.html#272094779">(Feb 16 2022 at 10:00)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span>  a bit surprised to know this, is it possible to eliminate the difference? never thought the macro would affect the final code.</p>



<a name="272095615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/impl-vs-derived-copy/near/272095615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/impl-vs-derived-copy.html#272095615">(Feb 16 2022 at 10:08)</a>:</h4>
<p>I once made a mir-opt that turns clones to copies on <code>Copy</code> types, but based on &lt;<a href="https://github.com/rust-lang/rfcs/pull/3197">https://github.com/rust-lang/rfcs/pull/3197</a>&gt; we're not actually allowed to do that in general.</p>



<a name="272096866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/impl-vs-derived-copy/near/272096866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/impl-vs-derived-copy.html#272096866">(Feb 16 2022 at 10:20)</a>:</h4>
<p>The optimization would still be allowable under the as-if rule. If the compiler sees the clone impl has no side-effects it could optimize it further to a memcpy.</p>



<a name="272096982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/impl-vs-derived-copy/near/272096982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/impl-vs-derived-copy.html#272096982">(Feb 16 2022 at 10:21)</a>:</h4>
<p>Plus that clarification PR isn't settled.</p>



<a name="272097981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/impl-vs-derived-copy/near/272097981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/impl-vs-derived-copy.html#272097981">(Feb 16 2022 at 10:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/impl-vs-derived-copy/near/272096866">said</a>:</p>
<blockquote>
<p>The optimization would still be allowable under the as-if rule. If the compiler sees the clone impl has no side-effects it could optimize it further to a memcpy.</p>
</blockquote>
<p>yep, the transformation <span class="user-mention" data-user-id="125294">@Aaron Hill</span> did for <code>derived(Clone)</code> benefited our binary size about 200k in a experiment.</p>



<a name="272098013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/impl-vs-derived-copy/near/272098013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/impl-vs-derived-copy.html#272098013">(Feb 16 2022 at 10:31)</a>:</h4>
<p><a href="https://github.com/rust-lang/rfcs/pull/3197#issuecomment-1024450110">https://github.com/rust-lang/rfcs/pull/3197#issuecomment-1024450110</a></p>



<a name="272098168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/impl-vs-derived-copy/near/272098168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/impl-vs-derived-copy.html#272098168">(Feb 16 2022 at 10:33)</a>:</h4>
<p>your approach should benefit more if we can cover more no-side-effect cases.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>