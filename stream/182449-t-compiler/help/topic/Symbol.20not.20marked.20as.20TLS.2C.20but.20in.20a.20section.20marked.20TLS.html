<html>
<head><meta charset="utf-8"><title>Symbol not marked as TLS, but in a section marked TLS · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html">Symbol not marked as TLS, but in a section marked TLS</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268141834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268141834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Buchholz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268141834">(Jan 15 2022 at 19:16)</a>:</h4>
<p>If a symbol in an object file is not marked as being TLS, but is within a TLS section, is this probably more of a problem with the LLVM code generation, or something further upstream on the Rust side of things?  This is with the wasm32-unknown-emscripten target and more detail can be found at: <a href="https://github.com/rust-lang/rust/issues/92676">https://github.com/rust-lang/rust/issues/92676</a> .  It seems like all of the symbols in the TLS sections need to be marked as TLS, otherwise linker complains ("wasm-ld" in this case).  I'm trying hone into an area to start investigating next.</p>



<a name="268141863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268141863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268141863">(Jan 15 2022 at 19:17)</a>:</h4>
<p>My first guess would be an llvm problem</p>



<a name="268141933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268141933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268141933">(Jan 15 2022 at 19:18)</a>:</h4>
<p>Can you see if the issue occurs with the unstable <code>#[thread_local]</code> attribute instead of <code>thread_local!</code></p>



<a name="268142028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268142028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Buchholz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268142028">(Jan 15 2022 at 19:20)</a>:</h4>
<p>Let me give that a whirl</p>



<a name="268142056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268142056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268142056">(Jan 15 2022 at 19:21)</a>:</h4>
<p>I don't think rustc has much code explicitly dealing with sections (except for embedding crate metadata / llvm bitcode)</p>



<a name="268142228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268142228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Buchholz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268142228">(Jan 15 2022 at 19:25)</a>:</h4>
<p>Hmmm..</p>
<div class="codehilite"><pre><span></span><code>error: expected item after attributes
 --&gt; src/main.rs:4:1
  |
4 | #[thread_local]{ static VAR1: Cell&lt;i32&gt; = Cell::new(11111); }
  | ^^^^^^^^^^^^^^^
</code></pre></div>



<a name="268142280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268142280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268142280">(Jan 15 2022 at 19:26)</a>:</h4>
<p>Oh, sorry - you need to apply that attribute directly to the static</p>



<a name="268142282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268142282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268142282">(Jan 15 2022 at 19:26)</a>:</h4>
<p>Without adding a new block</p>



<a name="268142744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268142744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Buchholz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268142744">(Jan 15 2022 at 19:36)</a>:</h4>
<p>For some reason it then can't find methods on the items I added the annotation to.  For example:</p>
<div class="codehilite"><pre><span></span><code>#[thread_local] static VAR1: Cell&lt;i32&gt; = Cell::new(11111);
</code></pre></div>

<p>...then has errors where the methods are used later on in the code:</p>
<div class="codehilite"><pre><span></span><code>error[E0599]: no method named `with` found for struct `Cell` in the current scope
  --&gt; src/main.rs:10:40
   |
10 |     println!(&quot;VAR1 in thread: {}&quot;,VAR1.with(|v| {v.get()}));
   |                                        ^^^^ method not found in `Cell&lt;i32&gt;`
</code></pre></div>



<a name="268142764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268142764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268142764">(Jan 15 2022 at 19:37)</a>:</h4>
<p>With that attribute, I believe you can 'just' access that static like normal</p>



<a name="268142806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268142806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268142806">(Jan 15 2022 at 19:38)</a>:</h4>
<p>and all of the accesses will automatically become thread local</p>



<a name="268142912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268142912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Buchholz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268142912">(Jan 15 2022 at 19:41)</a>:</h4>
<p>the macro expansion of thread_local! looks like it might be using #[thread_local]:</p>
<div class="codehilite"><pre><span></span><code>const VAR1: ::std::thread::LocalKey&lt;Cell&lt;i32&gt;&gt; =
    {
        #[inline]
        fn __init() -&gt; Cell&lt;i32&gt; { Cell::new(1) }
        #[inline]
        unsafe fn __getit() -&gt; ::std::option::Option&lt;&amp;&#39;static Cell&lt;i32&gt;&gt; {
            #[thread_local]
            #[cfg(all(target_thread_local,
                      not(all(target_family = &quot;wasm&quot;,
                              not(target_feature = &quot;atomics&quot;))),))]
            static __KEY: ::std::thread::__FastLocalKeyInner&lt;Cell&lt;i32&gt;&gt; =
                ::std::thread::__FastLocalKeyInner::new();

            #[allow(unused_unsafe)]
            unsafe { __KEY.get(__init) }
        }
        unsafe { ::std::thread::LocalKey::new(__getit) }
    };
</code></pre></div>



<a name="268142962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268142962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Buchholz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268142962">(Jan 15 2022 at 19:42)</a>:</h4>
<blockquote>
<p>With that attribute, I believe you can 'just' access that static like normal</p>
</blockquote>
<p>I'll play around with that.</p>



<a name="268142983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268142983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Buchholz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268142983">(Jan 15 2022 at 19:43)</a>:</h4>
<p>...but most of the link errors come from elsewhere in the standard library, not my code.</p>



<a name="268143424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Symbol%20not%20marked%20as%20TLS%2C%20but%20in%20a%20section%20marked%20TLS/near/268143424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Greg Buchholz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Symbol.20not.20marked.20as.20TLS.2C.20but.20in.20a.20section.20marked.20TLS.html#268143424">(Jan 15 2022 at 19:52)</a>:</h4>
<p>The LLVM IR (*.ll file) has a line:</p>
<div class="codehilite"><pre><span></span><code>@_ZN7Example4VAR17__getit5__KEY17hcfea1b84ac025f51E = internal thread_local(localexec) global &lt;{ [12 x i8] }&gt; zeroinitializer, align 4, !dbg !21
</code></pre></div>

<p>...the "thread_local" gives me a little bit of a warm fuzzy that it made it that far...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>