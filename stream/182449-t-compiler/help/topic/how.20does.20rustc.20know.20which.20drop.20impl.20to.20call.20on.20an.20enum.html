<html>
<head><meta charset="utf-8"><title>how does rustc know which drop impl to call on an enum · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum.html">how does rustc know which drop impl to call on an enum</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273170173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/how%20does%20rustc%20know%20which%20drop%20impl%20to%20call%20on%20an%20enum/near/273170173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Hughes <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum.html#273170173">(Feb 25 2022 at 00:36)</a>:</h4>
<p>Imagine I had an enum:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">E</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">A</span><span class="p">(</span><span class="nb">Box</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="w">   </span><span class="n">B</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span><span class="w"></span>
<span class="w">   </span><span class="n">C</span><span class="p">(</span><span class="kt">usize</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Since it's not possible to know what variant is used statically. How does rust codegen know which <code>Drop::drop</code> instance to resolve when builds the drop call for this enum?</p>



<a name="273171622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/how%20does%20rustc%20know%20which%20drop%20impl%20to%20call%20on%20an%20enum/near/273171622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum.html#273171622">(Feb 25 2022 at 00:57)</a>:</h4>
<p>I believe the drop function for <code>E</code> checks the discriminant at runtime.</p>



<a name="273171770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/how%20does%20rustc%20know%20which%20drop%20impl%20to%20call%20on%20an%20enum/near/273171770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Hughes <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum.html#273171770">(Feb 25 2022 at 00:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120518">Eric Huss</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum/near/273171622">said</a>:</p>
<blockquote>
<p>I believe the drop function for <code>E</code> checks the discriminant at runtime.</p>
</blockquote>
<p>Thanks <span class="user-mention" data-user-id="120518">@Eric Huss</span> , any idea where this lives?</p>



<a name="273171880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/how%20does%20rustc%20know%20which%20drop%20impl%20to%20call%20on%20an%20enum/near/273171880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Hughes <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum.html#273171880">(Feb 25 2022 at 01:00)</a>:</h4>
<p>whereabouts in the rustc source I mean</p>



<a name="273171918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/how%20does%20rustc%20know%20which%20drop%20impl%20to%20call%20on%20an%20enum/near/273171918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum.html#273171918">(Feb 25 2022 at 01:01)</a>:</h4>
<p>I'm no expert, but I believe it lives somewhere in <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_dataflow/src/elaborate_drops.rs"><code>elaborate_drops.rs</code></a>.</p>



<a name="273172219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/how%20does%20rustc%20know%20which%20drop%20impl%20to%20call%20on%20an%20enum/near/273172219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum.html#273172219">(Feb 25 2022 at 01:04)</a>:</h4>
<p>If I had to guess, <code>adt_switch_block</code> is where the switch on the discriminant happens.</p>



<a name="273172462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/how%20does%20rustc%20know%20which%20drop%20impl%20to%20call%20on%20an%20enum/near/273172462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Hughes <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum.html#273172462">(Feb 25 2022 at 01:09)</a>:</h4>
<p>I see yes. Not quite sure I understand whats happening in this elaborate_drops pass. I'll have to do some reading. Do you know if there are any docs about the internals of drop somewhere?</p>



<a name="273172723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/how%20does%20rustc%20know%20which%20drop%20impl%20to%20call%20on%20an%20enum/near/273172723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum.html#273172723">(Feb 25 2022 at 01:13)</a>:</h4>
<p><a href="https://rustc-dev-guide.rust-lang.org/mir/drop-elaboration.html">https://rustc-dev-guide.rust-lang.org/mir/drop-elaboration.html</a> is the only thing that comes to mind.</p>



<a name="273200273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/how%20does%20rustc%20know%20which%20drop%20impl%20to%20call%20on%20an%20enum/near/273200273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum.html#273200273">(Feb 25 2022 at 08:27)</a>:</h4>
<p>It is probably in <a href="https://github.com/rust-lang/rust/blob/ece55d416e65256e4da274988651c20e5d5cb4ea/compiler/rustc_mir_transform/src/shim.rs#L144">https://github.com/rust-lang/rust/blob/ece55d416e65256e4da274988651c20e5d5cb4ea/compiler/rustc_mir_transform/src/shim.rs#L144</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>