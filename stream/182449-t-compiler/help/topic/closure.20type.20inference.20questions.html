<html>
<head><meta charset="utf-8"><title>closure type inference questions · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html">closure type inference questions</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272431071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272431071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272431071">(Feb 18 2022 at 17:30)</a>:</h4>
<p>I'm trying to understand what's going on in <a href="https://github.com/rust-lang/rust/issues/70263">https://github.com/rust-lang/rust/issues/70263</a></p>
<p>My understanding from reading <a href="https://github.com/rust-lang/rfcs/pull/3216">this</a> is the core of the issue is the types <code>for&lt;'a&gt; FnOnce(&amp;'a i32) -&gt; &amp;'a i32</code> and <code>for a concrete 'a FnOnce(&amp;'a i32) -&gt; &amp;'a i32</code> are different (first is higher-ranked, second is not), and the compiler tries to infer which one the user wants. How does this inference work?</p>
<p>I've been looking at here <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/closure.rs">https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/closure.rs</a> . Comparing traces I can see the "good" snippet goes through <code>deduce_sig_from_projection</code>, <code>sig_of_closure_with_expectation</code>, and the "bad" one goes through <code>sig_of_closure_no_expectation</code></p>



<a name="272431401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272431401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272431401">(Feb 18 2022 at 17:32)</a>:</h4>
<p>Is this the right place to look?</p>
<p>The trace from here <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/closure.rs#L162">https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/closure.rs#L162</a> says:</p>
<p>good:</p>
<div class="codehilite"><pre><span></span><code>│ │ │ │ │ │ │ │ ├─1ms DEBUG rustc_typeck::check::closure sig=Binder(([(&amp;i32,)]; c_variadic: false)-&gt;&amp;i32, [Region(BrAnon(0))]), opt_kind=Some(FnOnce)
│ │ │ │ │ │ │ │ ├─1ms DEBUG rustc_typeck::check::closure expr.hir_id=HirId { owner: DefId(0:11 ~ lol[6f2f]::main), local_id: 17 }, closure_type=[closure@lol.rs]
</code></pre></div>
<p>bad: </p>
<div class="codehilite"><pre><span></span><code>│ │ │ │ │ │ │ │ ├─1ms DEBUG rustc_typeck::check::closure sig=Binder(([(&amp;i32,)]; c_variadic: false)-&gt;&amp;i32, [Region(BrAnon(0))]), opt_kind=None
│ │ │ │ │ │ │ │ ├─1ms DEBUG rustc_typeck::check::closure expr.hir_id=HirId { owner: DefId(0:11 ~ lol[6f2f]::main), local_id: 17 }, closure_type=[closure@lol.rs]
</code></pre></div>
<p>sigs are the same. Should I see the differenceif I inspect the <code>closure_type</code>? Or am I looking at the wrong place?</p>



<a name="272457412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272457412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272457412">(Feb 18 2022 at 21:06)</a>:</h4>
<p>Yes, you're looking in the right place</p>



<a name="272457502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272457502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272457502">(Feb 18 2022 at 21:07)</a>:</h4>
<p>what snippet are you compiling when you're getting that debug output?</p>



<a name="272457688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272457688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272457688">(Feb 18 2022 at 21:08)</a>:</h4>
<p>the one from <a href="https://github.com/rust-lang/rust/issues/70263">#70263</a> OP</p>
<p>bad:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">MyFn</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyFn</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">F</span><span class="w"> </span><span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">i32</span> <span class="p">{}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">F</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyFn</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="n">foo</span><span class="p">(</span><span class="o">|</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="o">|</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">i32</span> <span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">});</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>good:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">F</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="kt">i32</span> <span class="p">{}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="n">foo</span><span class="p">(</span><span class="o">|</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="o">|</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">i32</span> <span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">});</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272460610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272460610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272460610">(Feb 18 2022 at 21:35)</a>:</h4>
<p>that's odd - let me see if I can figure out what's happening</p>



<a name="272460996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272460996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272460996">(Feb 18 2022 at 21:38)</a>:</h4>
<p>I think it's coming from <code>check_supplied_sig_against_expectation</code></p>



<a name="272461208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272461208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272461208">(Feb 18 2022 at 21:41)</a>:</h4>
<p>in the 'good' case, you get an expected signature deduced from the <code>FnOnce</code> bound, which has the proper higher-ranked lifetimes</p>



<a name="272461246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272461246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272461246">(Feb 18 2022 at 21:41)</a>:</h4>
<p>in the 'bad' case, it doesn't deduce a signature from the obligation, so its ends up calling <code>sig_of_closure_no_expectation</code></p>



<a name="272461376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272461376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272461376">(Feb 18 2022 at 21:42)</a>:</h4>
<p>You can also pass <code>-Z verbose</code> to the compiler to see distinct signatures</p>



<a name="272461423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272461423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272461423">(Feb 18 2022 at 21:43)</a>:</h4>
<p>In the 'bad' case, you'll get:</p>
<div class="codehilite"><pre><span></span><code>│ ├─0ms DEBUG rustc_typeck::check::closure sig=Binder(([(&amp;ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrAnon(0) }) i32,)]; c_variadic: false)-&gt;&amp;&#39;_#0r i32, [Region(BrAnon(0))]), opt_kind=None
</code></pre></div>
<p>and in the 'good' case:</p>
<div class="codehilite"><pre><span></span><code>│ ├─0ms DEBUG rustc_typeck::check::closure sig=Binder(([(&amp;ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrAnon(0) }) i32,)]; c_variadic: false)-&gt;&amp;ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrAnon(0) }) i32, [Region(BrAnon(0))]), opt_kind=Some(FnOnce)
</code></pre></div>



<a name="272461473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272461473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272461473">(Feb 18 2022 at 21:43)</a>:</h4>
<p>Note how the 'good' case has the same region in the argument and region type, while the 'bad' case has a different region in the return type</p>



<a name="272461879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272461879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272461879">(Feb 18 2022 at 21:47)</a>:</h4>
<p>ooh, I see! makes sense</p>



<a name="272461995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272461995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272461995">(Feb 18 2022 at 21:48)</a>:</h4>
<p>It's strange that without verbose the two sigs look the same but aren't, that was confusing me</p>



<a name="272462020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462020">(Feb 18 2022 at 21:48)</a>:</h4>
<p>Yeah, I think we might want to change the non-verbose printing of that. It threw me off as well</p>



<a name="272462041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462041">(Feb 18 2022 at 21:48)</a>:</h4>
<p>how could the inference be improved?</p>



<a name="272462077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462077">(Feb 18 2022 at 21:49)</a>:</h4>
<p>for exampe, if the closure is self-contained (doesn't capture anything) it seems to me there's no reason to not make it always higher-ranked</p>



<a name="272462226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462226">(Feb 18 2022 at 21:50)</a>:</h4>
<p>I think that would probably be a good idea</p>



<a name="272462247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462247">(Feb 18 2022 at 21:50)</a>:</h4>
<p>Unfortunately, I think it will be pretty difficult to fix the specific issue with that reproducer</p>



<a name="272462268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462268">(Feb 18 2022 at 21:50)</a>:</h4>
<p>We're not 'seeing' the <code>FnOnce</code> bound when we try to deduce the closure signature, because it's behind the <code>where</code> clause of the impl</p>



<a name="272462299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462299">(Feb 18 2022 at 21:51)</a>:</h4>
<p>At this stage in typechecking, we haven't actually created the closure type yet (we still have an inference variable)</p>



<a name="272462320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462320">(Feb 18 2022 at 21:51)</a>:</h4>
<p>yeah, that sounds super complicated. there could be other impls as well</p>



<a name="272462332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462332">(Feb 18 2022 at 21:51)</a>:</h4>
<p>and the trait selection system doesn't really work with an inference variable as the self type, IIRC</p>



<a name="272462352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462352">(Feb 18 2022 at 21:51)</a>:</h4>
<p>We would need to recursively process that obligation in some kind of special mode</p>



<a name="272462354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462354">(Feb 18 2022 at 21:51)</a>:</h4>
<p>but "make it higher-ranked if there's no captures" would fix it, wouldn't it?</p>



<a name="272462367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462367">(Feb 18 2022 at 21:51)</a>:</h4>
<p>so that we could discover the <code>FnOnce</code> bound</p>



<a name="272462371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462371">(Feb 18 2022 at 21:51)</a>:</h4>
<p>I think it should, yes</p>



<a name="272462429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462429">(Feb 18 2022 at 21:52)</a>:</h4>
<p>The only possible issue would be breaking cases where people are relying on <em>not</em> being higher-ranked</p>



<a name="272462450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462450">(Feb 18 2022 at 21:52)</a>:</h4>
<p>let me see if I can think of a case where that would happen without captures</p>



<a name="272462527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462527">(Feb 18 2022 at 21:53)</a>:</h4>
<p>but that won't be that useful for real-world code though, usually you do have captures. the original issue that led me down this rabbit hole does have captures...</p>



<a name="272462572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462572">(Feb 18 2022 at 21:53)</a>:</h4>
<p>and if there's no captures you can always rewrite it as a standalone fn</p>



<a name="272462736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462736">(Feb 18 2022 at 21:54)</a>:</h4>
<p>Yeah, I think it should be fine in practice. In the worst case, we'll do a Crater run and discover some weird code that can make for good test cases :)</p>



<a name="272462753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462753">(Feb 18 2022 at 21:54)</a>:</h4>
<p>If you're interested in working on this, I can give you some pointers</p>



<a name="272462764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462764">(Feb 18 2022 at 21:55)</a>:</h4>
<p>If not, I can work on implementing this myself</p>



<a name="272462819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272462819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272462819">(Feb 18 2022 at 21:55)</a>:</h4>
<p>please do! I have never contributed but would really like to get started</p>



<a name="272463098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272463098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272463098">(Feb 18 2022 at 21:57)</a>:</h4>
<p>hmm - it looks like we run the closure capture anaylsis late in typechecking</p>



<a name="272463672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272463672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272463672">(Feb 18 2022 at 22:01)</a>:</h4>
<p>I think we could run a very basic version (that just checks if there are any upvars at all) when we're computing the closure signature</p>



<a name="272464099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272464099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272464099">(Feb 18 2022 at 22:05)</a>:</h4>
<p>what about cases like these?<br>
<code>|a: &amp;u8, b: &amp;u8| a</code> --&gt; <code>for&lt;'a,'b&gt; FnOnce(&amp;'a u8, &amp;'b u8) -&gt; &amp;'a u8</code><br>
<code>|a: &amp;u8, b: &amp;u8| if cond {a} else {b}</code>  --&gt; <code>for&lt;'a&gt; FnOnce(&amp;'a u8, &amp;'a u8) -&gt; &amp;'a u8</code></p>



<a name="272464233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272464233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272464233">(Feb 18 2022 at 22:06)</a>:</h4>
<p>In general, I think it's going to be very tricky to get that working (partially due to the fact that the closure signature is determined before NLL runs, and partially due to the complexity of higher-ranked regions)</p>



<a name="272464240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272464240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272464240">(Feb 18 2022 at 22:06)</a>:</h4>
<p>how would it match input lifetimes to output lifetimes?</p>



<a name="272464272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272464272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272464272">(Feb 18 2022 at 22:06)</a>:</h4>
<p>yeah.. :S</p>



<a name="272464291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272464291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272464291">(Feb 18 2022 at 22:07)</a>:</h4>
<p>For tricky cases, explicitly specifiying the signature via <a href="https://github.com/rust-lang/rfcs/pull/3216">https://github.com/rust-lang/rfcs/pull/3216</a> will probably be the way to go</p>



<a name="272464317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272464317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272464317">(Feb 18 2022 at 22:07)</a>:</h4>
<p>However, we can hopefully make unambiguous improvements to inference for common cases</p>



<a name="272464802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272464802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272464802">(Feb 18 2022 at 22:11)</a>:</h4>
<p>my original issue was trying to do async closures <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=bc5d8bb1f708bf94fc346653b413b0a3">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=bc5d8bb1f708bf94fc346653b413b0a3</a></p>



<a name="272464975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272464975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272464975">(Feb 18 2022 at 22:13)</a>:</h4>
<p>which is annoying because it's impossible to write the bounds for the closure with a <code>for&lt;'a&gt; F: FnOnce(..)</code></p>



<a name="272465191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272465191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272465191">(Feb 18 2022 at 22:15)</a>:</h4>
<p>but seeing this is so tricky perhaps it's better to invest efforts towards <a href="https://rust-lang.github.io/async-fundamentals-initiative/roadmap/async_closures.html">async closures</a>?</p>



<a name="272465617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272465617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272465617">(Feb 18 2022 at 22:17)</a>:</h4>
<p>because these could do the same "peek at the expectation to deduce everything" trick...</p>



<a name="272465827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272465827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272465827">(Feb 18 2022 at 22:19)</a>:</h4>
<p>I think many of the underlying inference issues will be the same, unfortunately</p>



<a name="272467064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467064">(Feb 18 2022 at 22:30)</a>:</h4>
<p>After looking at this in more detail, I think the simplest approach would be to attempt to apply the normal function signature lifetime elision rules</p>



<a name="272467104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467104">(Feb 18 2022 at 22:30)</a>:</h4>
<p>If there's exactly one elided input lifetime, then it will get applied to the output lifetimes (<a href="https://doc.rust-lang.org/nomicon/lifetime-elision.html">https://doc.rust-lang.org/nomicon/lifetime-elision.html</a>)</p>



<a name="272467131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467131">(Feb 18 2022 at 22:30)</a>:</h4>
<p>e.g. <code>fn foo(arg: &amp;u8, other: bool) -&gt; &amp;u8 {}</code> compiles</p>



<a name="272467227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467227">(Feb 18 2022 at 22:31)</a>:</h4>
<p>We can apply the same logic to explicit closure signatures (so <code>|arg: &amp;i32| -&gt; &amp;i32</code> will behave like <code>fn foo(arg: &amp;i32) -&gt; &amp;i32</code>)</p>



<a name="272467327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467327">(Feb 18 2022 at 22:32)</a>:</h4>
<p>of course, closures support things like <code>|first: &amp;i32, second: &amp;i32| -&gt; &amp;i32 { ... }</code>, which have no corresponding function equivalent (for good reason :P)</p>



<a name="272467367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467367">(Feb 18 2022 at 22:32)</a>:</h4>
<p>However, we can just fall back to existing closure behavior in those kinds of tricky cases</p>



<a name="272467368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467368">(Feb 18 2022 at 22:32)</a>:</h4>
<p>still only if there's no upvars, right?</p>



<a name="272467429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467429">(Feb 18 2022 at 22:33)</a>:</h4>
<p>I think this could apply regardless of upvars - it would just work based on the signature</p>



<a name="272467546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467546">(Feb 18 2022 at 22:34)</a>:</h4>
<p>An upvar-based inference rule could be added separately. However, I'm concerned that it might lead to somewhat brittle code - you could have a working closure, but adding a single upvar usage causes a confusing signature error</p>



<a name="272467568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467568">(Feb 18 2022 at 22:34)</a>:</h4>
<p>even if your upvar isn't related to the input or output at all</p>



<a name="272467759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467759">(Feb 18 2022 at 22:36)</a>:</h4>
<p><span class="user-mention" data-user-id="348152">@Dario Nieuwenhuis</span> If you're interested, I can help walk you through the changes needed to implement the elision change</p>



<a name="272467792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467792">(Feb 18 2022 at 22:36)</a>:</h4>
<p>hmm, I think that might break existing code that has upvars, because an input/output lifetime could  be related to one that's "exfiltrated" through an upvar</p>



<a name="272467830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467830">(Feb 18 2022 at 22:37)</a>:</h4>
<p>or even if there's no upvars:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">STATIK</span>: <span class="kt">u8</span> <span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">closure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="kt">u8</span><span class="o">|</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">u8</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">STATIK</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">static</span> <span class="kt">u8</span> <span class="o">=</span><span class="w"> </span><span class="n">closure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272467917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467917">(Feb 18 2022 at 22:38)</a>:</h4>
<p>that currently infers <code>for&lt;'a&gt; Fn(&amp;'a u8) -&gt; &amp;'static u8</code><br>
with the change it would infer <code>for&lt;'a&gt; Fn(&amp;'a u8) -&gt; &amp;'a u8</code> and break</p>



<a name="272467986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272467986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272467986">(Feb 18 2022 at 22:39)</a>:</h4>
<p>That's a good point. However,  it would allow code like this to compile:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">arg</span>: <span class="kp">&amp;</span><span class="kt">i32</span><span class="o">|</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="kt">i32</span> <span class="p">{</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272468039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468039">(Feb 18 2022 at 22:39)</a>:</h4>
<p>while your example could be fixed by adding an explicit <code>'static</code> lifetime, the code I posted currently <em>can't</em> compile with an explicit signature</p>



<a name="272468116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468116">(Feb 18 2022 at 22:40)</a>:</h4>
<p>oh wow why does that not compile</p>



<a name="272468127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468127">(Feb 18 2022 at 22:40)</a>:</h4>
<p>However, we'd probably want to do a Crater run to evaluate the inference breakage in practice</p>



<a name="272468142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468142">(Feb 18 2022 at 22:40)</a>:</h4>
<p>Yeah, I discovered that <em>lovely</em> example while working on my closure RFC</p>



<a name="272468201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468201">(Feb 18 2022 at 22:41)</a>:</h4>
<blockquote>
<p>returning this value requires that <code>'1</code> must outlive <code>'2</code></p>
</blockquote>
<p>but it seems like it should just infer that <code>'1 : '2</code> and carry on, wtf :D</p>



<a name="272468270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468270">(Feb 18 2022 at 22:41)</a>:</h4>
<p>A lot of the closure issues stem from the fact that most of the 'intelligence' around regions occurs after types are inferred (the AST-based region logic, and MIR borrowcheck)</p>



<a name="272468343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468343">(Feb 18 2022 at 22:42)</a>:</h4>
<p>Unfortunately, the closure signature gets inferred <em>during</em> type inference (so that we can create the <code>ty::Closure</code>)</p>



<a name="272468467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468467">(Feb 18 2022 at 22:43)</a>:</h4>
<p>Everything dealing with closure regions tends to get complicated fairly quickly :)</p>



<a name="272468610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468610">(Feb 18 2022 at 22:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/closure.20type.20inference.20questions/near/272467759">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="348152">Dario Nieuwenhuis</span> If you're interested, I can help walk you through the changes needed to implement the elision change</p>
</blockquote>
<p>of course, I'd love that!</p>



<a name="272468621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468621">(Feb 18 2022 at 22:45)</a>:</h4>
<p>I'm somewhat scared this will be "too breaking" though</p>



<a name="272468707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468707">(Feb 18 2022 at 22:46)</a>:</h4>
<p>I made an initial attempt locally, and there was only one break in the test suite (which was easily fixed)</p>



<a name="272468734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468734">(Feb 18 2022 at 22:46)</a>:</h4>
<p>We can do a Crater run on your PR to evaluate the breakage, and discuss with the rest of the compiler team</p>



<a name="272468759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468759">(Feb 18 2022 at 22:46)</a>:</h4>
<p>To start with, I'd recommend taking a look at compiler/rustc_resolve/src/late/lifetimes.rs</p>



<a name="272468898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468898">(Feb 18 2022 at 22:48)</a>:</h4>
<p>Here's where we skip running the elision logic for closures: <a href="https://github.com/rust-lang/rust/blob/b17226fcc11587fed612631be372a5b4cb89988a/compiler/rustc_resolve/src/late/lifetimes.rs#L2768-L2769">https://github.com/rust-lang/rust/blob/b17226fcc11587fed612631be372a5b4cb89988a/compiler/rustc_resolve/src/late/lifetimes.rs#L2768-L2769</a></p>



<a name="272468937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468937">(Feb 18 2022 at 22:48)</a>:</h4>
<p>To start with, I'd reccomend adding a new <code>match</code> arm that checks for a closure</p>



<a name="272468955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468955">(Feb 18 2022 at 22:48)</a>:</h4>
<p>Have you looked at <code>hir::Expr</code> before?</p>



<a name="272468973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272468973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272468973">(Feb 18 2022 at 22:49)</a>:</h4>
<p>not much, no</p>



<a name="272469014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272469014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272469014">(Feb 18 2022 at 22:49)</a>:</h4>
<p>If you haven't seen it already, the compiler docs site is very helpful: <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_hir/struct.Expr.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_hir/struct.Expr.html</a></p>



<a name="272469041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272469041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272469041">(Feb 18 2022 at 22:49)</a>:</h4>
<p>You're going to want to check for an <code>ExprKind::Closure</code></p>



<a name="272469139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272469139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272469139">(Feb 18 2022 at 22:50)</a>:</h4>
<p>To check that, you'll want to match against <code>Node::Expr</code> in that existing match block</p>



<a name="272469464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272469464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272469464">(Feb 18 2022 at 22:54)</a>:</h4>
<p>you can just have that arm produce <code>None</code> (the <code>body</code> field is just used for diagnostics)</p>



<a name="272469479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272469479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272469479">(Feb 18 2022 at 22:54)</a>:</h4>
<p>Let me know if you run into any issues doing that</p>



<a name="272469686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272469686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272469686">(Feb 18 2022 at 22:56)</a>:</h4>
<p>Will try, thanks!</p>



<a name="272469943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272469943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272469943">(Feb 18 2022 at 22:59)</a>:</h4>
<p>Additionally, you'll want to modify the error case: <a href="https://github.com/rust-lang/rust/blob/b17226fcc11587fed612631be372a5b4cb89988a/compiler/rustc_resolve/src/late/lifetimes.rs#L2888">https://github.com/rust-lang/rust/blob/b17226fcc11587fed612631be372a5b4cb89988a/compiler/rustc_resolve/src/late/lifetimes.rs#L2888</a></p>



<a name="272470103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470103">(Feb 18 2022 at 23:00)</a>:</h4>
<p>For closures, we don't want to emit an error if the elision logic fails, since we want to continue to accept code like <code>|first: &amp;i32, second: &amp;i32| -&gt; &amp;i32 { ... }</code> (which is <em>not</em> allowed in function signatures)</p>



<a name="272470141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470141">(Feb 18 2022 at 23:00)</a>:</h4>
<p>Inside that <code>else</code> branch, you'll want to check if you're in a closure</p>



<a name="272470180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470180">(Feb 18 2022 at 23:01)</a>:</h4>
<p>If you are, then you'll want to fall back to the code that we currently run unconditionally:</p>



<a name="272470188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470188">(Feb 18 2022 at 23:01)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/b17226fcc11587fed612631be372a5b4cb89988a/compiler/rustc_resolve/src/late/lifetimes.rs#L2771-L2772">https://github.com/rust-lang/rust/blob/b17226fcc11587fed612631be372a5b4cb89988a/compiler/rustc_resolve/src/late/lifetimes.rs#L2771-L2772</a></p>



<a name="272470237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470237">(Feb 18 2022 at 23:01)</a>:</h4>
<p>Feel free to ping me for any help that you need</p>



<a name="272470433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470433">(Feb 18 2022 at 23:03)</a>:</h4>
<p>what about the <code>&amp;'static</code> case then?</p>



<a name="272470452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470452">(Feb 18 2022 at 23:03)</a>:</h4>
<p>The example that you gave?</p>



<a name="272470539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470539">(Feb 18 2022 at 23:04)</a>:</h4>
<p>That kind of code will need to be modified to be <code>let closure = |x: &amp;u8| -&gt; &amp;'static u8 { ... }</code></p>



<a name="272470578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470578">(Feb 18 2022 at 23:05)</a>:</h4>
<p>yeah, or you can construct similar ones with captures, I suspect these will be more common</p>



<a name="272470613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470613">(Feb 18 2022 at 23:05)</a>:</h4>
<p>moving references from an input to a capture, or from a capture to the return value</p>



<a name="272470617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470617">(Feb 18 2022 at 23:05)</a>:</h4>
<p>The compiler is allowed to make 'small' inference breakages in the course of improvements to the language. We'll need to see how large of an issue that code is in practice, using a Crater run</p>



<a name="272470864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470864">(Feb 18 2022 at 23:07)</a>:</h4>
<p>Also, that code only starts erroring if you have an explicit type on both the input <em>and</em> output</p>



<a name="272470956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470956">(Feb 18 2022 at 23:08)</a>:</h4>
<p><code>|x| -&gt; &amp;u8 { ... }</code> and <code>|x: &amp;u8| { ... }</code>are both unaffected by this elision change</p>



<a name="272470994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470994">(Feb 18 2022 at 23:08)</a>:</h4>
<p>In my experience, explicitly specifying both the closure input and output is pretty rare</p>



<a name="272470995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272470995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272470995">(Feb 18 2022 at 23:08)</a>:</h4>
<p>right</p>



<a name="272471012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471012">(Feb 18 2022 at 23:08)</a>:</h4>
<p>which should hopefully reduce the impact of this change</p>



<a name="272471176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471176">(Feb 18 2022 at 23:10)</a>:</h4>
<p>maybe it's a bit overlapping with your RFC?</p>



<a name="272471202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471202">(Feb 18 2022 at 23:10)</a>:</h4>
<p>you've specified if you use <code>for&lt;..&gt;</code> then all lifetimes must be specified</p>



<a name="272471265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471265">(Feb 18 2022 at 23:11)</a>:</h4>
<p>an extension of that would be "apply lifetime elision rules to elided lifetimes"</p>



<a name="272471293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471293">(Feb 18 2022 at 23:11)</a>:</h4>
<p>that's a good point - there's definitely some overlap there</p>



<a name="272471327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471327">(Feb 18 2022 at 23:11)</a>:</h4>
<p>or even an empty <code>for&lt;&gt;</code></p>



<a name="272471394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471394">(Feb 18 2022 at 23:12)</a>:</h4>
<p>so <code>for&lt;&gt; |arg: &amp;i32| -&gt; &amp;i32 { arg }</code> means <code>for&lt;'a&gt; |arg: &amp;'a i32| -&gt; &amp;'a i32 { arg }</code></p>



<a name="272471446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471446">(Feb 18 2022 at 23:12)</a>:</h4>
<p>looks a bit weird, but feels more consistent</p>



<a name="272471472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471472">(Feb 18 2022 at 23:12)</a>:</h4>
<p>Personally, I think it would be a good idea to apply this elision change in all cases, if we can 'get away' with it</p>



<a name="272471510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471510">(Feb 18 2022 at 23:13)</a>:</h4>
<p>It would be really nice for <code>|val: &amp;i32| -&gt; &amp;i32 { val }</code> to compile, especially for people new to the language</p>



<a name="272471527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471527">(Feb 18 2022 at 23:13)</a>:</h4>
<p>no <code>for&lt;&gt;</code> -&gt; lifetimes are inferred within the context of parent function<br>
<code>for&lt;&gt;</code> -&gt; lifetimes are always higher-ranked, elision rules are applied</p>



<a name="272471542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471542">(Feb 18 2022 at 23:13)</a>:</h4>
<p>However, if the breakage turns out to be too high in practice, then I think it would be a great idea to put it behind <code>for&lt;&gt;</code> as you suggested</p>



<a name="272471636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471636">(Feb 18 2022 at 23:14)</a>:</h4>
<p>also you could argue <code>&amp;u32</code> means different things "inside" and "outside" a fn body</p>



<a name="272471664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471664">(Feb 18 2022 at 23:14)</a>:</h4>
<p>outside -&gt; apply elision rules, or it's invalid if you can't<br>
inside -&gt; infer lifetimes within the whole fn context</p>



<a name="272471714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471714">(Feb 18 2022 at 23:15)</a>:</h4>
<p>while with this change, <code>&amp;u32</code> would "mean" a different thing in <code>let x: &amp;u32</code> vs in <code>|x: &amp;u32| -&gt; &amp;u32</code></p>



<a name="272471845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471845">(Feb 18 2022 at 23:16)</a>:</h4>
<p>dunno, it's a bit handwavey. Maybe I'm too used to how it works now</p>



<a name="272471871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471871">(Feb 18 2022 at 23:16)</a>:</h4>
<p>it's certainly super whacky that this fails to compile <code>|val: &amp;i32| -&gt; &amp;i32 { val }</code></p>



<a name="272471953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471953">(Feb 18 2022 at 23:17)</a>:</h4>
<p>I think you raise some good points. I've always thought of the closure signature as more like a function signature that 'happens' to be written inside another function, but I can see the argument for consistency with <code>let x: &amp;u32</code></p>



<a name="272471994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272471994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272471994">(Feb 18 2022 at 23:17)</a>:</h4>
<p>yeah... closure signatures are a weird "in-between" thing</p>



<a name="272472137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272472137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272472137">(Feb 18 2022 at 23:19)</a>:</h4>
<p>I like the idea of <code>for&lt;&gt;</code> to "activate function signature-like mode" a bit better</p>



<a name="272472710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272472710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272472710">(Feb 18 2022 at 23:25)</a>:</h4>
<p>Are you still interested in trying out the 'unconditional' elision change, or would you prefer to wait for my RFC to (hopefully) land?</p>



<a name="272472835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272472835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272472835">(Feb 18 2022 at 23:26)</a>:</h4>
<p>I'm not sure <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="272472874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272472874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272472874">(Feb 18 2022 at 23:27)</a>:</h4>
<p>At the very least, I think it would be interesting to do a Crater run to gather data on how people are using closure signatures in practice</p>



<a name="272472886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272472886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272472886">(Feb 18 2022 at 23:27)</a>:</h4>
<p>and how many cases would need to use <code>for&lt;&gt;</code> syntax if we gate the elision change behind it</p>



<a name="272473411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272473411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272473411">(Feb 18 2022 at 23:33)</a>:</h4>
<p>indeed! I'll give it a try next week.</p>



<a name="272473441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272473441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272473441">(Feb 18 2022 at 23:33)</a>:</h4>
<p>I have to run now. Thanks a lot for the pointers and the interesting conversation!</p>



<a name="272506172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272506172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272506172">(Feb 19 2022 at 09:25)</a>:</h4>
<p>I wonder if we could do something tricky like delay such checking all the way to mir borrowck. Basically allow typeck to assume that those lifetimes are equal and leave it to mir borrowck to actually check them. At that point we do have all the information and can make more complicated decisions</p>



<a name="272604415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272604415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272604415">(Feb 20 2022 at 17:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/closure.20type.20inference.20questions/near/272468039">said</a>:</p>
<blockquote>
<p>while your example could be fixed by adding an explicit <code>'static</code> lifetime, the code I posted currently <em>can't</em> compile with an explicit signature</p>
</blockquote>
<p>This particular example has a namable lifetime, but closure can return something with an unnamable lifetime and with elision it'll break.</p>



<a name="272629727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272629727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272629727">(Feb 21 2022 at 01:16)</a>:</h4>
<p>I've shifted goal a bit</p>
<p>Currently higher-ranked inference works with these obligations</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u32</span><span class="p">,)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u32</span><span class="p">,)</span><span class="o">&gt;&gt;</span>::<span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"></span>
</code></pre></div>
<p>I want to try getting it working with these obligations as well:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u32</span><span class="p">,)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u32</span><span class="p">,)</span><span class="o">&gt;&gt;</span>::<span class="n">Output</span>: <span class="nc">Debug</span><span class="p">,</span><span class="w"></span>
</code></pre></div>
<p>because I believe it'll make async closures just work in more cases (most?)</p>



<a name="272629970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272629970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272629970">(Feb 21 2022 at 01:21)</a>:</h4>
<p>but I'm not getting all obligations <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/closure.rs#L199">here</a>, the log <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/fn_ctxt/_impl.rs#L689">here</a> is printing:</p>
<p>good:</p>
<div class="codehilite"><pre><span></span><code>│ │ │ │ │ │ │ │ │ ├─0ms TRACE rustc_typeck::check::fn_ctxt::_impl pending_obligations = [
│ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(TraitPredicate(&lt;_#0t as std::marker::Sized&gt;, polarity:Positive), []), cause=ObligationCause { span: snippets/good.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:9 ~ good[6163]::main), local_id: 13 }, code: Some(BindingObligation(DefId(0:6 ~ good[6163]::foo), snippets/good.rs:4:8: 4:9 (#0))) }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(TraitPredicate(&lt;_#0t as std::ops::FnOnce&lt;(&amp;ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ good[6163]::foo::&#39;a), &#39;a) }) i32,)&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:8 ~ good[6163]::foo::&#39;a), &#39;a))]), cause=ObligationCause { span: snippets/good.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:9 ~ good[6163]::main), local_id: 13 }, code: Some(BindingObligation(DefId(0:6 ~ good[6163]::foo), snippets/good.rs:6:8: 6:38 (#0))) }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [_#0t, (&amp;ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ good[6163]::foo::&#39;a), &#39;a) }) i32,)], item_def_id: DefId(2:3277 ~ core[ce39]::ops::function::FnOnce::Output) }, Ty(i32)), [Region(BrNamed(DefId(0:8 ~ good[6163]::foo::&#39;a), &#39;a))]), cause=ObligationCause { span: snippets/good.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:9 ~ good[6163]::main), local_id: 13 }, code: Some(BindingObligation(DefId(0:6 ~ good[6163]::foo), snippets/good.rs:6:35: 6:38 (#0))) }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(WellFormed(_#0t), []), cause=ObligationCause { span: snippets/good.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:9 ~ good[6163]::main), local_id: 13 }, code: None }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │ ]
</code></pre></div>
<p>bad</p>
<div class="codehilite"><pre><span></span><code>│ │ │ │ │ │ │ │ │ ├─0ms TRACE rustc_typeck::check::fn_ctxt::_impl pending_obligations = [
│ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(TraitPredicate(&lt;_#0t as std::marker::Sized&gt;, polarity:Positive), []), cause=ObligationCause { span: snippets/good.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:10 ~ good[4f88]::main), local_id: 13 }, code: Some(BindingObligation(DefId(0:6 ~ good[4f88]::foo), snippets/good.rs:4:8: 4:9 (#0))) }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(TraitPredicate(&lt;_#0t as std::ops::FnOnce&lt;(&amp;ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ good[4f88]::foo::&#39;a), &#39;a) }) u32,)&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:8 ~ good[4f88]::foo::&#39;a), &#39;a))]), cause=ObligationCause { span: snippets/good.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:10 ~ good[4f88]::main), local_id: 13 }, code: Some(BindingObligation(DefId(0:6 ~ good[4f88]::foo), snippets/good.rs:6:16: 6:34 (#0))) }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(WellFormed(_#0t), []), cause=ObligationCause { span: snippets/good.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:10 ~ good[4f88]::main), local_id: 13 }, code: None }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │ ]
</code></pre></div>



<a name="272630034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272630034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272630034">(Feb 21 2022 at 01:22)</a>:</h4>
<p><a href="http://good.rs">good.rs</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(unboxed_closures)]</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Debug</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">F</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//a</span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">(</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><a href="http://bad.rs">bad.rs</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(unboxed_closures)]</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Debug</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u32</span><span class="p">,)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u32</span><span class="p">,)</span><span class="o">&gt;&gt;</span>::<span class="n">Output</span>: <span class="nc">Debug</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">(</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272630059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272630059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272630059">(Feb 21 2022 at 01:23)</a>:</h4>
<p>where do these obligations come from? How can I get the <code>: Debug</code> one?</p>



<a name="272630294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272630294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272630294">(Feb 21 2022 at 01:28)</a>:</h4>
<p>I can see it in the logs in unrelated stuff... I suspect it's something to do with it having a different self type? but the log there is before filtering by self type</p>
<div class="codehilite"><pre><span></span><code>Binder(TraitPredicate(&lt;&lt;F as std::ops::FnOnce&lt;(&amp;ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:9 ~ good[4f88]::foo::&#39;a#1), &#39;a) }) u32,)&gt;&gt;::Output as std::fmt::Debug&gt;, polarity:Positive), [Region(BrNamed(DefId(0:9 ~ good[4f88]::foo::&#39;a#1), &#39;a))])
</code></pre></div>



<a name="272632994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272632994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272632994">(Feb 21 2022 at 02:21)</a>:</h4>
<p>wait, that's erroring <em>before</em> doing any closure typechecking.. how's that possible?</p>



<a name="272633729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272633729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272633729">(Feb 21 2022 at 02:35)</a>:</h4>
<p>why does this fail? it makes no sense (<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=612ff388ada95547a912d6f4883ed5ea">playground</a>)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(unboxed_closures)]</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Debug</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u32</span><span class="p">,)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u32</span><span class="p">,)</span><span class="o">&gt;&gt;</span>::<span class="n">Output</span>: <span class="nc">Debug</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272633807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272633807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272633807">(Feb 21 2022 at 02:36)</a>:</h4>
<p>the fulfillment ctx is immediately exploding when adding these obligations instead of leaving it pending, why is that?</p>



<a name="272637211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272637211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272637211">(Feb 21 2022 at 03:32)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/94207">https://github.com/rust-lang/rust/issues/94207</a></p>



<a name="272647535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272647535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272647535">(Feb 21 2022 at 06:44)</a>:</h4>
<p>Those <code>: Debug</code> bounds are lowered as opaque types. In the current system that means there'll be an inference type there that you need to query for its obligations</p>



<a name="272647602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272647602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272647602">(Feb 21 2022 at 06:45)</a>:</h4>
<p>You may have it easier if you wait for <a href="https://github.com/rust-lang/rust/pull/94081">https://github.com/rust-lang/rust/pull/94081</a> to get merged, as then you see the opaque types and can get the bounds from it directly</p>



<a name="272710126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272710126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272710126">(Feb 21 2022 at 16:32)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> is it possible they're lowered to opaque types only if the bounds are not higher-ranked?</p>
<p>With this</p>
<div class="codehilite"><pre><span></span><code>    F: FnOnce&lt;(u32,)&gt;,
    &lt;F as FnOnce&lt;(u32,)&gt;&gt;::Output: Debug,
</code></pre></div>
<p>I get </p>
<div class="codehilite"><pre><span></span><code>│ │ │ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [_#0t, (u32,)], item_def_id: DefId(2:3291 ~ core[ac93]::ops::function::FnOnce::Output) }, Ty(_#1t)), []), cause=ObligationCause { span: snippets/FILE.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:8 ~ FILE::main), local_id: 12 }, code: None }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=1),
│ │ │ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(TraitPredicate(&lt;_#0t as std::marker::Sized&gt;, polarity:Positive), []), cause=ObligationCause { span: snippets/FILE.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:8 ~ FILE::main), local_id: 12 }, code: Some(BindingObligation(DefId(0:6 ~ FILE::foo), snippets/FILE.rs:4:8: 4:9 (#0))) }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(TraitPredicate(&lt;_#0t as std::ops::FnOnce&lt;(u32,)&gt;&gt;, polarity:Positive), []), cause=ObligationCause { span: snippets/FILE.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:8 ~ FILE::main), local_id: 12 }, code: Some(BindingObligation(DefId(0:6 ~ FILE::foo), snippets/FILE.rs:6:8: 6:22 (#0))) }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(TraitPredicate(&lt;_#1t as std::fmt::Debug&gt;, polarity:Positive), []), cause=ObligationCause { span: snippets/FILE.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:8 ~ FILE::main), local_id: 12 }, code: Some(BindingObligation(DefId(0:6 ~ FILE::foo), snippets/FILE.rs:7:36: 7:41 (#0))) }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(WellFormed(_#0t), []), cause=ObligationCause { span: snippets/FILE.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:8 ~ FILE::main), local_id: 12 }, code: None }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(WellFormed(_#0t), []), cause=ObligationCause { span: snippets/FILE.rs:12:9: 12:14 (#0), body_id: HirId { owner: DefId(0:8 ~ FILE::main), local_id: 12 }, code: None }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
</code></pre></div>
<p>the new <code>_#1t </code> variable is what you're talking about, I guess</p>



<a name="272710183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272710183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272710183">(Feb 21 2022 at 16:32)</a>:</h4>
<p>but with this</p>
<div class="codehilite"><pre><span></span><code>    for&lt;&#39;a&gt; F: FnOnce&lt;(&amp;&#39;a u32,)&gt;,
    for&lt;&#39;a&gt; &lt;F as FnOnce&lt;(&amp;&#39;a u32,)&gt;&gt;::Output: Debug,
</code></pre></div>
<p>I get</p>
<div class="codehilite"><pre><span></span><code>│ │ │ │ │ │ │ │ │ │ │ ├─0ms TRACE rustc_typeck::check::fn_ctxt::_impl pending_obligations = [
│ │ │ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(TraitPredicate(&lt;_#0t as std::marker::Sized&gt;, polarity:Positive), []), cause=ObligationCause { span: snippets/FILE.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:10 ~ FILE::main), local_id: 13 }, code: Some(BindingObligation(DefId(0:6 ~ FILE::foo), snippets/FILE.rs:4:8: 4:9 (#0))) }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(TraitPredicate(&lt;_#0t as std::ops::FnOnce&lt;(&amp;ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ FILE::foo::&#39;a), &#39;a) }) u32,)&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:8 ~ FILE::foo::&#39;a), &#39;a))]), cause=ObligationCause { span: snippets/FILE.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:10 ~ FILE::main), local_id: 13 }, code: Some(BindingObligation(DefId(0:6 ~ FILE::foo), snippets/FILE.rs:6:16: 6:34 (#0))) }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(TraitPredicate(&lt;&lt;_#0t as std::ops::FnOnce&lt;(&amp;ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:9 ~ FILE::foo::&#39;a#1), &#39;a) }) u32,)&gt;&gt;::Output as std::fmt::Debug&gt;, polarity:Positive), [Region(BrNamed(DefId(0:9 ~ FILE::foo::&#39;a#1), &#39;a))]), cause=ObligationCause { span: snippets/FILE.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:10 ~ FILE::main), local_id: 13 }, code: Some(BindingObligation(DefId(0:6 ~ FILE::foo), snippets/FILE.rs:7:48: 7:53 (#0))) }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(WellFormed(_#0t), []), cause=ObligationCause { span: snippets/FILE.rs:12:5: 12:8 (#0), body_id: HirId { owner: DefId(0:10 ~ FILE::main), local_id: 13 }, code: None }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │ │ │     Obligation(predicate=Binder(WellFormed(_#0t), []), cause=ObligationCause { span: snippets/FILE.rs:12:9: 12:15 (#0), body_id: HirId { owner: DefId(0:10 ~ FILE::main), local_id: 13 }, code: None }, param_env=ParamEnv { caller_bounds: [], reveal: UserFacing, constness: NotConst }, depth=0),
│ │ │ │ │ │ │ │ │ │ │ │ ]
</code></pre></div>



<a name="272710614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272710614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272710614">(Feb 21 2022 at 16:36)</a>:</h4>
<p>so I was thinking of updating the closure typeck to also match obligations like <code>Binder(TraitPredicate(&lt;&lt;_#0t as std::ops::FnOnce&lt;....&gt;&gt;::Output as std::fmt::Debug&gt;, ..</code></p>



<a name="272710716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272710716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272710716">(Feb 21 2022 at 16:37)</a>:</h4>
<p>(I tried both master and <a href="https://github.com/rust-lang/rust/issues/94081">#94081</a> , the behavior is the same)</p>



<a name="272711536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272711536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272711536">(Feb 21 2022 at 16:43)</a>:</h4>
<p>well, we explicitly stop going into higher ranked things, because of some reason that I didn't dig into yet, so those obligation changes make sense, but there's still an opaque type behind the <code>::Output</code> projection. You'll see it once the projection gets resolved</p>



<a name="272711946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272711946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272711946">(Feb 21 2022 at 16:47)</a>:</h4>
<p>okay, but at the time of typechecking the closure I get just these obligations</p>



<a name="272712004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272712004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272712004">(Feb 21 2022 at 16:47)</a>:</h4>
<p>so does it make sense to make closure typechecking to match these to infer the closure signature?</p>



<a name="272712271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272712271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272712271">(Feb 21 2022 at 16:50)</a>:</h4>
<p>currently it matches only <code>ProjectionPredicate</code>s, so it can't infer the closure signature with HRTBs</p>



<a name="272712303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/closure%20type%20inference%20questions/near/272712303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/closure.20type.20inference.20questions.html#272712303">(Feb 21 2022 at 16:50)</a>:</h4>
<p>full example</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(unboxed_closures)]</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fmt</span>::<span class="n">Debug</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u32</span><span class="p">,)</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">FnOnce</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u32</span><span class="p">,)</span><span class="o">&gt;&gt;</span>::<span class="n">Output</span>: <span class="nc">Debug</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">(</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>