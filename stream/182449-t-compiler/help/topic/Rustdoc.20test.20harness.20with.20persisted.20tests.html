<html>
<head><meta charset="utf-8"><title>Rustdoc test harness with persisted tests · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html">Rustdoc test harness with persisted tests</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261374126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261374126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261374126">(Nov 13 2021 at 18:44)</a>:</h4>
<p>I've been toying around with getting rustdoc tests to build and run under Bazel so my team can finally start using them but to do so, I need some way of building the tests separately from running them. I've been able to do this with nightly toolchains and <a href="https://github.com/rust-lang/rust/issues/56925">https://github.com/rust-lang/rust/issues/56925</a> but in order to run them, I've written my own less-than-desirable test runner. Is there any way I can have rustdoc re-run with pre-built test binaries?</p>



<a name="261375407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261375407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261375407">(Nov 13 2021 at 19:14)</a>:</h4>
<p>Rustdoc only supports building tests itself afaik. Sometimes this is even the only possible strategy. For example for compile fail tests, where you can't just provide pre-built binaries as compilation needs to fail.</p>



<a name="261375838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261375838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261375838">(Nov 13 2021 at 19:26)</a>:</h4>
<p>I mean, <code>rustdoc</code> did build the tests, just in a previous execution, which I suppose makes no difference here? The thing I'm trying to work around is that the tests get built in a sandbox and running rustdoc outside of that sandbox would probably fail or produce different results</p>



<a name="261376088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261376088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261376088">(Nov 13 2021 at 19:34)</a>:</h4>
<p>If a test is a compile fail test, rustdoc will not persist anything about the fact that the test failed to compile, so it would need to try to compile it again even if all already compiled test binaries are reused by rustdoc.</p>



<a name="261376233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261376233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261376233">(Nov 13 2021 at 19:36)</a>:</h4>
<p>Why can't you run rustdoc and all tests produced by rustdoc in the same sandbox?</p>



<a name="261376321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261376321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261376321">(Nov 13 2021 at 19:38)</a>:</h4>
<p>Generally tests are built and run separately</p>



<a name="261376343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261376343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261376343">(Nov 13 2021 at 19:38)</a>:</h4>
<p>There's a big philosophy about that in Bazel</p>



<a name="261376455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261376455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261376455">(Nov 13 2021 at 19:41)</a>:</h4>
<p>I mean, I have what I want but I'm sacrificing the nice test harness which I'd love to avoid</p>



<a name="261376456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261376456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261376456">(Nov 13 2021 at 19:41)</a>:</h4>
<p>or have to recreate</p>



<a name="261376685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261376685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261376685">(Nov 13 2021 at 19:46)</a>:</h4>
<p>Also, what do you mean by "compile fail test"?</p>



<a name="261376773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261376773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261376773">(Nov 13 2021 at 19:48)</a>:</h4>
<p>Just some rustdoc snippet that you expect to fail to compile if the code changes?</p>



<a name="261377055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261377055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261377055">(Nov 13 2021 at 19:55)</a>:</h4>
<p>Yes, something like:</p>
<p><a href="https://github.com/rust-lang/rust/blob/673d0db5e393e9c64897005b470bfeb6d5aec61b/compiler/rustc_error_codes/src/error_codes/E0423.md">https://github.com/rust-lang/rust/blob/673d0db5e393e9c64897005b470bfeb6d5aec61b/compiler/rustc_error_codes/src/error_codes/E0423.md</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// ```compile_fail</span>
<span class="sd">/// struct Foo { a: bool };</span>
<span class="sd">///</span>
<span class="sd">/// let f = Foo();</span>
<span class="sd">/// // error: expected function, tuple struct or tuple variant, found `Foo`</span>
<span class="sd">/// // `Foo` is a struct name, but this expression uses it like a function name</span>
<span class="sd">/// ```</span>
</code></pre></div>
<p>They are often used to demonstrate incorrect use of api's.</p>



<a name="261377104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261377104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261377104">(Nov 13 2021 at 19:56)</a>:</h4>
<p>Or test that misuse doesn't compile and instead for example gives a borrowck error.</p>



<a name="261384006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261384006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261384006">(Nov 13 2021 at 22:38)</a>:</h4>
<p><span class="user-mention" data-user-id="343063">@UebelAndre</span> on nightly you can use --persist-doctests --no-run I think. Not sure if there's a programmatic way to get the output path.</p>



<a name="261384037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261384037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261384037">(Nov 13 2021 at 22:39)</a>:</h4>
<p>Yeah, I can build and find the tests but now I want to run them using the test runner. I can invoke the tests directly but do miss libtest</p>



<a name="261386781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261386781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261386781">(Nov 13 2021 at 23:45)</a>:</h4>
<p>... I don't understand why --persist-doctests would prevent you from using the test runner</p>



<a name="261432429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261432429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261432429">(Nov 14 2021 at 18:50)</a>:</h4>
<p>The issue isn't  in <code>--persist-doctests</code> again, because I was hoping to build and test separately, I wanted to persist tests but also use <code>--no-run</code> so that "building" would be separated from "testing". This worked and I could produce binaries without actually running them. But then the issue became "how do I now get rustdoc to run those pre-built binaries"?</p>



<a name="261432460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261432460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261432460">(Nov 14 2021 at 18:51)</a>:</h4>
<p>While I still think the behavior is desirable, It seems a long way off from being something I can rely on and would need to do some work in <code>rustdoc</code> to make that experience better</p>



<a name="261432529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261432529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261432529">(Nov 14 2021 at 18:52)</a>:</h4>
<p>I did run into an issue though in trying to run <code>rustdoc --test</code></p>
<div class="codehilite"><pre><span></span><code>==================== Test output for //tools/cargo_bazel:rustdoc_test:
error[E0460]: found possibly newer version of crate `ucd_trie` which `tera` depends on
 --&gt; tools/cargo_bazel/src/rendering/template_engine.rs:7:5
  |
7 | use tera::{self, Tera};
  |     ^^^^
  |
  = note: perhaps that crate needs to be recompiled?
  = note: the following crate versions were found:
          crate `ucd_trie`: /private/var/tmp/_bazel_user/c4900dc498759a5aae30fdfe5c69c114/execroot/cargo_bazel/bazel-out/darwin-opt-exec-2B5CBBC6/bin/external/crate_index__ucd-trie-0.1.3/libucd_trie--891559306.rlib
          crate `tera`: /private/var/tmp/_bazel_user/c4900dc498759a5aae30fdfe5c69c114/execroot/cargo_bazel/bazel-out/darwin-fastbuild/bin/external/crate_index__tera-1.15.0/libtera--749639002.rlib

error: aborting due to previous error
</code></pre></div>
<p>I've never seen this before and don't think I understand what the error means by <code>found possibly newer version of crate </code>. <span class="user-mention" data-user-id="232545">@Joshua Nelson</span>  <span class="user-mention" data-user-id="133247">@bjorn3</span>  would you be able to explain the error to me a bit more?</p>



<a name="261436786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261436786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261436786">(Nov 14 2021 at 20:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343063">UebelAndre</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Rustdoc.20test.20harness.20with.20persisted.20tests/near/261376343">said</a>:</p>
<blockquote>
<p>There's a big philosophy about that in Bazel</p>
</blockquote>
<p>Why not treat rustdoc as an interpreter? No separation of build and execution <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="261436796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261436796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261436796">(Nov 14 2021 at 20:29)</a>:</h4>
<p>it's just jitting to disk!</p>



<a name="261436855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261436855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261436855">(Nov 14 2021 at 20:30)</a>:</h4>
<p>maybe one could even make it use O_TMPFILE for that</p>



<a name="261437359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261437359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261437359">(Nov 14 2021 at 20:42)</a>:</h4>
<p>I think I've gotten what I want (and i think effectively that) by not trying to separate build and test. Just simply invoking <code>rustdoc --test</code>. For now, I'm stuck on that error....</p>



<a name="261437368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261437368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> UebelAndre <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261437368">(Nov 14 2021 at 20:42)</a>:</h4>
<p>Would definitely appreciate the help since I feel to understand it I need to do a very deep dive into rustc/rustdoc</p>



<a name="261437456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261437456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261437456">(Nov 14 2021 at 20:45)</a>:</h4>
<p>Not sure, sorry. I would try cleaning the build directory maybe</p>



<a name="261442181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustdoc%20test%20harness%20with%20persisted%20tests/near/261442181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustdoc.20test.20harness.20with.20persisted.20tests.html#261442181">(Nov 14 2021 at 22:42)</a>:</h4>
<p>I think it means the crate expects a dependency to have a particular crate hash but the found crate hash doesn't match. I have seen that happening when building rustc and changing code at the same time.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>