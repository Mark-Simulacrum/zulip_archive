<html>
<head><meta charset="utf-8"><title>How do I synthesize a span from another edition? · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html">How do I synthesize a span from another edition?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254260847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254260847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254260847">(Sep 21 2021 at 19:08)</a>:</h4>
<p>I want to change the edition of a <code>Span</code>. How can I do that? I see I can get a Span from a SpanData, but I don't know how to make a SpanData either.</p>



<a name="254261326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254261326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254261326">(Sep 21 2021 at 19:11)</a>:</h4>
<p>looks like rustdoc does this for doctests by changing the global default (!!) which seems like overkill: <a href="https://github.com/rust-lang/rust/blob/840acd378a273dab6798352d3d6a087fa09e4806/src/librustdoc/doctest.rs#L534">https://github.com/rust-lang/rust/blob/840acd378a273dab6798352d3d6a087fa09e4806/src/librustdoc/doctest.rs#L534</a></p>



<a name="254261596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254261596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254261596">(Sep 21 2021 at 19:13)</a>:</h4>
<p>(and at this point in compilation I think I'd need to spawn a new thread to change the default which is <em>definitely</em> overkill)</p>



<a name="254287096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254287096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254287096">(Sep 21 2021 at 22:21)</a>:</h4>
<p>What is the goal of changing the edition of an existing span?</p>



<a name="254298583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254298583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254298583">(Sep 22 2021 at 00:31)</a>:</h4>
<p>edition is taken from ExpnData</p>



<a name="254299405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254299405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254299405">(Sep 22 2021 at 00:43)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> it doesn't necessarily have to be an existing span, changing a dummy span would work too. This is for <a href="https://github.com/rust-lang/rust/issues/89135">https://github.com/rust-lang/rust/issues/89135</a>; right now the lint ignores <code>edition2018</code> in the code block attributes.</p>



<a name="254299564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254299564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254299564">(Sep 22 2021 at 00:45)</a>:</h4>
<p>Specifically <a href="https://github.com/rust-lang/rust/blob/d8d1d1059a7837551c0065fc060dcb806ad729ef/src/librustdoc/passes/check_code_block_syntax.rs#L44">https://github.com/rust-lang/rust/blob/d8d1d1059a7837551c0065fc060dcb806ad729ef/src/librustdoc/passes/check_code_block_syntax.rs#L44</a> always uses the default edition, which is not correct</p>



<a name="254306390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254306390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254306390">(Sep 22 2021 at 02:26)</a>:</h4>
<p>Yeah, I started looking into that issue yesterday but got stuck trying to figure out how to create a dummy span with the correct edition.</p>



<a name="254451656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254451656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254451656">(Sep 22 2021 at 22:47)</a>:</h4>
<blockquote>
<p>rustdoc does this for doctests by changing the global default (!!) which seems like overkill</p>
</blockquote>
<p>This seems like the right way to do it.<br>
A block with a <code> ```rust,editionNNNN</code> annotation is basically a separate crate, so it's pretty logical to process it like one and create a new parse session for it.</p>



<a name="254452121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254452121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254452121">(Sep 22 2021 at 22:52)</a>:</h4>
<p>But it may be a problem in practice if you are in context where another <code>SessionGlobals</code> is already created, that's true.</p>



<a name="254452540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254452540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254452540">(Sep 22 2021 at 22:55)</a>:</h4>
<p>Perhaps it's possible to save, change and then restore the <code>SessionGlobals</code> though?<br>
It's a <code>scoped_thread_local!</code> after all, not a true global variable.</p>



<a name="254452836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254452836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254452836">(Sep 22 2021 at 22:58)</a>:</h4>
<p>You only need to do it at most twice (whether you create a new thread or not), for two editions that are different from the current crate's one, because all blocks with the same edition can be batched.</p>



<a name="254453642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254453642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254453642">(Sep 22 2021 at 23:04)</a>:</h4>
<hr>
<p>Another approach is to take a span with the current edition and "wrap it into a macro" with a different edition using <code>fresh_expansion</code>.</p>



<a name="254453877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254453877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254453877">(Sep 22 2021 at 23:06)</a>:</h4>
<p>But the <code>SessionGlobals</code> approach seems cleaner, because every doctest is indeed a small separate crate, and not a part of the current crate.</p>



<a name="254456958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254456958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254456958">(Sep 22 2021 at 23:38)</a>:</h4>
<hr>
<p>Also, looking at the larger picture, I would personally remove the <code>invalid_rust_codeblocks</code> lint entirely, it's not a rustdoc's job.<br>
You either don't run doctests, then contents of those blocks don't affect the doc generation in any way, or you run doctests, then you need them to compile and the light syntactic checking done by <code>invalid_rust_codeblocks</code> is not enough.</p>



<a name="254457106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254457106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254457106">(Sep 22 2021 at 23:40)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> the lint is misnamed - rustdoc needs to lex these to do syntax highlighting. The warning is if syntax highlighting fails</p>



<a name="254457126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254457126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254457126">(Sep 22 2021 at 23:40)</a>:</h4>
<p>See also the thread in <a class="stream" data-stream-id="266220" href="/#narrow/stream/266220-rustdoc">#rustdoc</a></p>



<a name="254942867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254942867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254942867">(Sep 26 2021 at 16:19)</a>:</h4>
<blockquote>
<p>You only need to do it at most twice (whether you create a new thread or not), for two editions that are different from the current crate's one, because all blocks with the same edition can be batched.</p>
</blockquote>
<p>that would require quite a lot of redesign - maybe it's simpler to just use a lazy_static that spawns a thread or something? but that seems kind of cursed, <code>fresh_expansion</code> seems less hacky</p>



<a name="254942896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20do%20I%20synthesize%20a%20span%20from%20another%20edition%3F/near/254942896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20do.20I.20synthesize.20a.20span.20from.20another.20edition.3F.html#254942896">(Sep 26 2021 at 16:19)</a>:</h4>
<p>I'll come back to this when/if I work on doctest performance</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>