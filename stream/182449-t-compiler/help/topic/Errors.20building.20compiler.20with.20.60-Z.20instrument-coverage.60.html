<html>
<head><meta charset="utf-8"><title>Errors building compiler with `-Z instrument-coverage` · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Errors.20building.20compiler.20with.20.60-Z.20instrument-coverage.60.html">Errors building compiler with `-Z instrument-coverage`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249210983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Errors%20building%20compiler%20with%20%60-Z%20instrument-coverage%60/near/249210983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jmanchuck <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Errors.20building.20compiler.20with.20.60-Z.20instrument-coverage.60.html#249210983">(Aug 12 2021 at 08:55)</a>:</h4>
<p>Hi, I'm getting errors when trying to build the stage1 compiler with <code>-Z instrument-coverage</code>. I tried using both "beta" and "nightly" in <code>src/stage0.txt</code> (although I saw somewhere that this is not correct), set <code>profiler = true</code> under build in  config.toml and  ran <code>RUSTFLAGS="-Z instrument-coverage" RUSTC_BOOTSTRAP=1 ./x.py build --stage 1</code>.</p>
<p>I get this error in both cases for "beta" and "nightly":</p>
<p><code>``error: </code>profiler_builtins<code> crate (required by compiler options) is not compatible with crate attribute </code>#![no_core]`</p>
<p>error[E0463]: can't find crate for <code>profiler_builtins</code><br>
  |<br>
  = note: the compiler may have been built without the profiler runtime</p>
<p>For more information about this error, try <code>rustc --explain E0463</code>.<br>
error: build failed</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>



<a name="249237178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Errors%20building%20compiler%20with%20%60-Z%20instrument-coverage%60/near/249237178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Errors.20building.20compiler.20with.20.60-Z.20instrument-coverage.60.html#249237178">(Aug 12 2021 at 13:52)</a>:</h4>
<p>It sounds like you have made a lot of modifications. I would undo all the changes and try just running <code>RUSTFLAGS_BOOTSTRAP=-Zinstrument-coverage x.py build</code> and see if you make more progress.</p>



<a name="249569719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Errors%20building%20compiler%20with%20%60-Z%20instrument-coverage%60/near/249569719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jmanchuck <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Errors.20building.20compiler.20with.20.60-Z.20instrument-coverage.60.html#249569719">(Aug 16 2021 at 10:05)</a>:</h4>
<p>I did a clean install again from scratch - I'm still getting the same error so I was hoping to double check that the steps I've taken is correct:</p>
<ol>
<li>.<code>/x.py  setup</code></li>
<li>Add <code>profiler = true</code> under <code>[build]</code> in <code>config.toml</code> </li>
<li><code>RUSTFLAGS_BOOTSTRAP=-Zinstrument-coverage ./ x.py build --config config.toml</code></li>
</ol>



<a name="249585228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Errors%20building%20compiler%20with%20%60-Z%20instrument-coverage%60/near/249585228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Errors.20building.20compiler.20with.20.60-Z.20instrument-coverage.60.html#249585228">(Aug 16 2021 at 13:01)</a>:</h4>
<p>Hmm, and the error is about profiler_builtins? That seems odd</p>



<a name="249585382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Errors%20building%20compiler%20with%20%60-Z%20instrument-coverage%60/near/249585382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Errors.20building.20compiler.20with.20.60-Z.20instrument-coverage.60.html#249585382">(Aug 16 2021 at 13:03)</a>:</h4>
<p>I wonder if you need to set these flags only when building the compiler and not the standard library? I don't know a great way to do that</p>



<a name="250587708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Errors%20building%20compiler%20with%20%60-Z%20instrument-coverage%60/near/250587708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jmanchuck <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Errors.20building.20compiler.20with.20.60-Z.20instrument-coverage.60.html#250587708">(Aug 25 2021 at 07:30)</a>:</h4>
<p>I tried only enabling the flags when building the final <code>compiler/rustc</code> part but unfortunately it fails since it requires <code>profiler_builtins</code> which previously didn't exist (because I compiled earlier stages without the flags).</p>
<p>I'm not familiar with the compiler source code but could it be because <code>x.py</code> is attempting to compile <code>profiler_builtins</code> with a dependency on itself (which hasn't been built yet)?</p>
<p>If that's the case is there some way to first build <code>library/profiler_builtins</code> separately, or pass in different flags/options to that crate only?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>