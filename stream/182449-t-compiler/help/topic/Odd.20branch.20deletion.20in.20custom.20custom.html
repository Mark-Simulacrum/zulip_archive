<html>
<head><meta charset="utf-8"><title>Odd branch deletion in custom custom · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html">Odd branch deletion in custom custom</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258281660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258281660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258281660">(Oct 19 2021 at 22:18)</a>:</h4>
<p>Hello!<br>
I am getting some pretty weird optimization from LLVM 7 in my GPU codegen in which it seems to be deleting the completely wrong branch. I wanted to check if this was a known issue in the past, if so i may have to upgrade to llvm 13 right now. This is the rust code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">a</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Boo</span><span class="p">;</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Boo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">a</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(())</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_kernel</span><span class="p">(</span><span class="n">buf</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread_idx_x</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">Boo</span>::<span class="n">a</span><span class="p">().</span><span class="n">is_some</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">buf</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">buf</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the unoptimized LLVM IR looks like this:</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span> <span class="k">void</span> <span class="vg">@test_kernel</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="nv">%buf</span><span class="p">)</span> <span class="k">unnamed_addr</span> <span class="p">{</span>
<span class="nl">start:</span>
  <span class="nv nv-Anonymous">%0</span> <span class="p">=</span> <span class="k">alloca</span> <span class="kt">i8</span><span class="p">*,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="nv nv-Anonymous">%1</span> <span class="p">=</span> <span class="k">alloca</span> <span class="kt">i8</span><span class="p">*,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="nv">%_6</span> <span class="p">=</span> <span class="k">alloca</span> <span class="kt">i8</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb1</span>
<span class="nl">bb1:</span>                                              <span class="c">; preds = %start</span>
  <span class="nv">%_1.i</span> <span class="p">=</span> <span class="k">call</span> <span class="k">zeroext</span> <span class="kt">i32</span> <span class="vg">@__nvvm_thread_idx_x</span><span class="p">(),</span> <span class="nv">!range</span> <span class="nv nv-Anonymous">!7</span>
  <span class="nv nv-Anonymous">%2</span> <span class="p">=</span> <span class="k">zext</span> <span class="kt">i32</span> <span class="nv">%_1.i</span> <span class="k">to</span> <span class="kt">i64</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb2</span>
<span class="nl">bb2:</span>                                              <span class="c">; preds = %bb1</span>
  <span class="nv nv-Anonymous">%3</span> <span class="p">=</span> <span class="k">call</span> <span class="k">zeroext</span> <span class="kt">i1</span> <span class="vg">@"_ZN77_$LT$kernels$$render_kernels$$Boo$u20$as$u20$kernels$$render_kernels$$Foo$GT$1a17hcd167bac31c3390fE"</span><span class="p">()</span>
  <span class="nv nv-Anonymous">%4</span> <span class="p">=</span> <span class="k">zext</span> <span class="kt">i1</span> <span class="nv nv-Anonymous">%3</span> <span class="k">to</span> <span class="kt">i8</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="nv nv-Anonymous">%4</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv">%_6</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb3</span>
<span class="nl">bb3:</span>                                              <span class="c">; preds = %bb2</span>
<span class="c">; call core::option::Option&lt;T&gt;::is_some</span>
  <span class="nv">%_4</span> <span class="p">=</span> <span class="k">call</span> <span class="k">zeroext</span> <span class="kt">i1</span> <span class="vg">@"_ZN4core6option15Option$LT$T$GT$7is_some17h8d581fc592e36a2eE"</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="k">align</span> <span class="m">1</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="nv">%_6</span><span class="p">)</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb4</span>
<span class="nl">bb4:</span>                                              <span class="c">; preds = %bb3</span>
  <span class="k">br</span> <span class="kt">i1</span> <span class="nv">%_4</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb5</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb7</span>
<span class="nl">bb7:</span>                                              <span class="c">; preds = %bb4</span>
  <span class="nv nv-Anonymous">%5</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">i8</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv">%buf</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv nv-Anonymous">%2</span>
  <span class="k">store</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%5</span><span class="p">,</span> <span class="kt">i8</span><span class="p">**</span> <span class="nv nv-Anonymous">%1</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="nv">%_3.i.i</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">i8</span><span class="p">*,</span> <span class="kt">i8</span><span class="p">**</span> <span class="nv nv-Anonymous">%1</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb8</span>
<span class="nl">bb5:</span>                                              <span class="c">; preds = %bb4</span>
  <span class="nv nv-Anonymous">%6</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">i8</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv">%buf</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv nv-Anonymous">%2</span>
  <span class="k">store</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%6</span><span class="p">,</span> <span class="kt">i8</span><span class="p">**</span> <span class="nv nv-Anonymous">%0</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="nv">%_3.i.i1</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">i8</span><span class="p">*,</span> <span class="kt">i8</span><span class="p">**</span> <span class="nv nv-Anonymous">%0</span><span class="p">,</span> <span class="k">align</span> <span class="m">8</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb6</span>
<span class="nl">bb6:</span>                                              <span class="c">; preds = %bb5</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="m">32</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv">%_3.i.i1</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb9</span>
<span class="nl">bb9:</span>                                              <span class="c">; preds = %bb8, %bb6</span>
  <span class="k">ret</span> <span class="k">void</span>
<span class="nl">bb8:</span>                                              <span class="c">; preds = %bb7</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="m">7</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv">%_3.i.i</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb9</span>
<span class="p">}</span>
</code></pre></div>
<p>Which looks correct, all the right branches are there. But suddenly, when llvm 7 optimizes it, it optimizes it away into the wrong branch:</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span> <span class="k">void</span> <span class="vg">@test_kernel</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="k">nocapture</span> <span class="nv">%buf</span><span class="p">)</span> <span class="k">unnamed_addr</span> <span class="p">{</span>
<span class="nl">start:</span>
  <span class="nv">%_1.i</span> <span class="p">=</span> <span class="k">tail</span> <span class="k">call</span> <span class="k">zeroext</span> <span class="kt">i32</span> <span class="vg">@__nvvm_thread_idx_x</span><span class="p">(),</span> <span class="nv">!range</span> <span class="nv nv-Anonymous">!3</span>
  <span class="nv nv-Anonymous">%0</span> <span class="p">=</span> <span class="k">zext</span> <span class="kt">i32</span> <span class="nv">%_1.i</span> <span class="k">to</span> <span class="kt">i64</span>
  <span class="nv nv-Anonymous">%1</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">i8</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv">%buf</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv nv-Anonymous">%0</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="m">7</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%1</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="k">ret</span> <span class="k">void</span>
<span class="p">}</span>
</code></pre></div>
<p>(it should be storing 32 instead of 7)<br>
I presume this is an LLVM issue because current rustc has no problem with it, has this been a known issue in the past?</p>



<a name="258289645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258289645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258289645">(Oct 19 2021 at 23:33)</a>:</h4>
<p>Are opt-level the same for both IRs?</p>



<a name="258289692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258289692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258289692">(Oct 19 2021 at 23:34)</a>:</h4>
<p>yep both release</p>



<a name="258289711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258289711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258289711">(Oct 19 2021 at 23:34)</a>:</h4>
<p>I tried putting the IR through llvm 7 <code>opt</code> and it optimized incorrectly too, so its not my codegen's pass manager</p>



<a name="258289931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258289931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258289931">(Oct 19 2021 at 23:37)</a>:</h4>
<p>this is a link to the playground: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=53aad4ed9d506fd8dfd9193a268f1802">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=53aad4ed9d506fd8dfd9193a268f1802</a></p>



<a name="258289953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258289953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258289953">(Oct 19 2021 at 23:37)</a>:</h4>
<p>looking at the llvm ir in debug, it looks the same for the most part</p>



<a name="258289960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258289960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258289960">(Oct 19 2021 at 23:37)</a>:</h4>
<p>minus the debug stuff</p>



<a name="258293839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258293839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258293839">(Oct 20 2021 at 00:20)</a>:</h4>
<p>I was thinking about whether MIR opt is broken</p>



<a name="258293878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258293878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258293878">(Oct 20 2021 at 00:21)</a>:</h4>
<p>But if you compile with release and get correct LLVM IR then probably MIR opt is not the culprit</p>



<a name="258293903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258293903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258293903">(Oct 20 2021 at 00:21)</a>:</h4>
<p>I dont think mir opt is the culprit, because cg_llvm works fine, my codegen doesnt, which uses llvm 7</p>



<a name="258294000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258294000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258294000">(Oct 20 2021 at 00:22)</a>:</h4>
<p>oddly, if i use a bool over an option it works</p>



<a name="258294073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258294073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258294073">(Oct 20 2021 at 00:23)</a>:</h4>
<p>actually, it doesnt seem to now</p>



<a name="258294192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258294192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258294192">(Oct 20 2021 at 00:25)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> could this perhaps be related to fewer-names?</p>



<a name="258294567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258294567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258294567">(Oct 20 2021 at 00:29)</a>:</h4>
<p>there plenty of names in this IR though.</p>



<a name="258294584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258294584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258294584">(Oct 20 2021 at 00:29)</a>:</h4>
<p>Yeah</p>



<a name="258294655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258294655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258294655">(Oct 20 2021 at 00:30)</a>:</h4>
<p>I dont get why it can optimize it just fine for a bool but not a struct</p>



<a name="258295007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295007">(Oct 20 2021 at 00:34)</a>:</h4>
<p>The only remotely close thing I can think of is <a href="https://github.com/rust-lang/rust/pull/90040">https://github.com/rust-lang/rust/pull/90040</a></p>



<a name="258295030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295030">(Oct 20 2021 at 00:34)</a>:</h4>
<p>but u'll need to provide IR for the <code>is_some</code> and the <code>Boo::a</code> too.</p>



<a name="258295046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295046">(Oct 20 2021 at 00:34)</a>:</h4>
<p>Sure just give me a second ill get those</p>



<a name="258295232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295232">(Oct 20 2021 at 00:37)</a>:</h4>
<p>the latter is </p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="c">; &lt;kernels$$render_kernels$$Boo$u20$as$u20$kernels$$render_kernels$$Foo$GT$::a</span>
<span class="k">define</span> <span class="k">internal</span> <span class="kt">i1</span> <span class="vg">@"_ZN77_$LT$kernels$$render_kernels$$Boo$u20$as$u20$kernels$$render_kernels$$Foo$GT$1a17hcd167bac31c3390fE"</span><span class="p">()</span> <span class="k">unnamed_addr</span> <span class="p">{</span>
<span class="nl">start:</span>
  <span class="nv nv-Anonymous">%0</span> <span class="p">=</span> <span class="k">alloca</span> <span class="kt">i8</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="m">1</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%0</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="nv nv-Anonymous">%1</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">i8</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%0</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span><span class="p">,</span> <span class="nv">!range</span> <span class="nv nv-Anonymous">!4</span>
  <span class="nv nv-Anonymous">%2</span> <span class="p">=</span> <span class="k">trunc</span> <span class="kt">i8</span> <span class="nv nv-Anonymous">%1</span> <span class="k">to</span> <span class="kt">i1</span>
  <span class="k">ret</span> <span class="kt">i1</span> <span class="nv nv-Anonymous">%2</span>
<span class="p">}</span>
</code></pre></div>



<a name="258295245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295245">(Oct 20 2021 at 00:37)</a>:</h4>
<p>which looks ok to me, its representing the option as a bool (except not i1)</p>



<a name="258295263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295263">(Oct 20 2021 at 00:38)</a>:</h4>
<p>is_some is</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span> <span class="k">internal</span> <span class="kt">i1</span> <span class="vg">@"_ZN4core6option15Option$LT$T$GT$7is_some17h8d581fc592e36a2eE"</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="nv">%self</span><span class="p">)</span> <span class="k">unnamed_addr</span> <span class="vg">#0</span> <span class="p">{</span>
<span class="nl">start:</span>
  <span class="nv nv-Anonymous">%0</span> <span class="p">=</span> <span class="k">alloca</span> <span class="kt">i8</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="nv nv-Anonymous">%1</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">i8</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv">%self</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span><span class="p">,</span> <span class="nv">!range</span> <span class="nv nv-Anonymous">!4</span>
  <span class="nv nv-Anonymous">%2</span> <span class="p">=</span> <span class="k">trunc</span> <span class="kt">i8</span> <span class="nv nv-Anonymous">%1</span> <span class="k">to</span> <span class="kt">i1</span>
  <span class="nv">%_2</span> <span class="p">=</span> <span class="k">zext</span> <span class="kt">i1</span> <span class="nv nv-Anonymous">%2</span> <span class="k">to</span> <span class="kt">i64</span>
  <span class="nv nv-Anonymous">%3</span> <span class="p">=</span> <span class="k">icmp</span> <span class="k">eq</span> <span class="kt">i64</span> <span class="nv">%_2</span><span class="p">,</span> <span class="m">1</span>
  <span class="k">br</span> <span class="kt">i1</span> <span class="nv nv-Anonymous">%3</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb2</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb1</span>

<span class="nl">bb2:</span>                                              <span class="c">; preds = %start</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="m">1</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%0</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb3</span>

<span class="nl">bb1:</span>                                              <span class="c">; preds = %start</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%0</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb3</span>

<span class="nl">bb3:</span>                                              <span class="c">; preds = %bb2, %bb1</span>
  <span class="nv nv-Anonymous">%4</span> <span class="p">=</span> <span class="k">load</span> <span class="kt">i8</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%0</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span><span class="p">,</span> <span class="nv">!range</span> <span class="nv nv-Anonymous">!4</span>
  <span class="nv nv-Anonymous">%5</span> <span class="p">=</span> <span class="k">trunc</span> <span class="kt">i8</span> <span class="nv nv-Anonymous">%4</span> <span class="k">to</span> <span class="kt">i1</span>
  <span class="k">ret</span> <span class="kt">i1</span> <span class="nv nv-Anonymous">%5</span>
<span class="p">}</span>
</code></pre></div>



<a name="258295350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295350">(Oct 20 2021 at 00:38)</a>:</h4>
<p>other than the weird zext to i64 it looks fine to me also</p>



<a name="258295363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295363">(Oct 20 2021 at 00:39)</a>:</h4>
<p>what's <code>!4</code>?</p>



<a name="258295382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295382">(Oct 20 2021 at 00:39)</a>:</h4>
<p><code>!4 = !{i8 0, i8 1}</code></p>



<a name="258295424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295424">(Oct 20 2021 at 00:40)</a>:</h4>
<p>yeah <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="258295528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295528">(Oct 20 2021 at 00:41)</a>:</h4>
<p>and this is the entire llvm ir file (with a lot of other stuff because this is an "actual" crate<br>
<a href="/user_uploads/4715/UAFtzT00CTPLGB3rUcG8A_bE/kernels.ll">kernels.ll</a></p>



<a name="258295533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295533">(Oct 20 2021 at 00:41)</a>:</h4>
<p>this is such basic IR that misoptimizing it seems… incredible. Like whatever is wrong its not subtly wrong.</p>



<a name="258295559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295559">(Oct 20 2021 at 00:41)</a>:</h4>
<p>Exactly, im thinking that i mustve missed something glaringly obvious in the IR but i dont think thats the case</p>



<a name="258295627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295627">(Oct 20 2021 at 00:42)</a>:</h4>
<p>This is the point where you pull out some <code>-bisect-opt-limit</code> and <code>-print-after-all</code>s.</p>



<a name="258295679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295679">(Oct 20 2021 at 00:43)</a>:</h4>
<p>ill first try to get a minimal version of the IR then check if llvm 13 has the same thing</p>



<a name="258295730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258295730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258295730">(Oct 20 2021 at 00:43)</a>:</h4>
<p>do you happen to have <code>opt</code> for llvm 12/13? if so could you maybe try running it on that file? I only have llvm 7 opt :/</p>



<a name="258296893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258296893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258296893">(Oct 20 2021 at 00:58)</a>:</h4>
<p>and this is a very minimal version of the bug <a href="/user_uploads/4715/3GHO5CetTU9XzgVKywvzwuOi/plsllvm.ll">plsllvm.ll</a></p>



<a name="258297802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258297802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258297802">(Oct 20 2021 at 01:10)</a>:</h4>
<p>Ok it seems like the incorrect transform happens after <code>Interprocedural Sparse Conditional Constant Propagation</code></p>



<a name="258297823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258297823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258297823">(Oct 20 2021 at 01:10)</a>:</h4>
<p>before that, the IR is </p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span> <span class="k">void</span> <span class="vg">@test_kernel</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="nv">%buf</span><span class="p">)</span> <span class="k">unnamed_addr</span> <span class="p">{</span>
<span class="nl">start:</span>
  <span class="nv">%_6</span> <span class="p">=</span> <span class="k">alloca</span> <span class="kt">i8</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="nv">%_1.i</span> <span class="p">=</span> <span class="k">call</span> <span class="k">zeroext</span> <span class="kt">i32</span> <span class="vg">@__nvvm_thread_idx_x</span><span class="p">(),</span> <span class="nv">!range</span> <span class="nv nv-Anonymous">!1</span>
  <span class="nv nv-Anonymous">%0</span> <span class="p">=</span> <span class="k">zext</span> <span class="kt">i32</span> <span class="nv">%_1.i</span> <span class="k">to</span> <span class="kt">i64</span>
  <span class="nv nv-Anonymous">%1</span> <span class="p">=</span> <span class="k">call</span> <span class="k">zeroext</span> <span class="kt">i1</span> <span class="vg">@"_ZN45_$LT$plsllvm$$Boo$u20$as$u20$plsllvm$$Foo$GT$1a17h8da93b67e1269092E"</span><span class="p">()</span>
  <span class="nv nv-Anonymous">%2</span> <span class="p">=</span> <span class="k">zext</span> <span class="kt">i1</span> <span class="nv nv-Anonymous">%1</span> <span class="k">to</span> <span class="kt">i8</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="nv nv-Anonymous">%2</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv">%_6</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="nv">%_4</span> <span class="p">=</span> <span class="k">call</span> <span class="k">zeroext</span> <span class="kt">i1</span> <span class="vg">@"_ZN4core6option15Option$LT$T$GT$7is_some17h70f5212344228d54E"</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="k">align</span> <span class="m">1</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="nv">%_6</span><span class="p">)</span>
  <span class="nv nv-Anonymous">%3</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">i8</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv">%buf</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv nv-Anonymous">%0</span>
  <span class="k">br</span> <span class="kt">i1</span> <span class="nv">%_4</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb5</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb7</span>

<span class="nl">bb7:</span>                                              <span class="c">; preds = %start</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="m">7</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%3</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb9</span>

<span class="nl">bb5:</span>                                              <span class="c">; preds = %start</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="m">32</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%3</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb9</span>

<span class="nl">bb9:</span>                                              <span class="c">; preds = %bb7, %bb5</span>
  <span class="k">ret</span> <span class="k">void</span>
<span class="p">}</span>
</code></pre></div>



<a name="258297841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258297841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258297841">(Oct 20 2021 at 01:10)</a>:</h4>
<p>after it becomes</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span> <span class="k">void</span> <span class="vg">@test_kernel</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="nv">%buf</span><span class="p">)</span> <span class="k">unnamed_addr</span> <span class="p">{</span>
<span class="nl">start:</span>
  <span class="nv">%_6</span> <span class="p">=</span> <span class="k">alloca</span> <span class="kt">i8</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="nv">%_1.i</span> <span class="p">=</span> <span class="k">call</span> <span class="k">zeroext</span> <span class="kt">i32</span> <span class="vg">@__nvvm_thread_idx_x</span><span class="p">(),</span> <span class="nv">!range</span> <span class="nv nv-Anonymous">!1</span>
  <span class="nv nv-Anonymous">%0</span> <span class="p">=</span> <span class="k">zext</span> <span class="kt">i32</span> <span class="nv">%_1.i</span> <span class="k">to</span> <span class="kt">i64</span>
  <span class="nv nv-Anonymous">%1</span> <span class="p">=</span> <span class="k">call</span> <span class="k">zeroext</span> <span class="kt">i1</span> <span class="vg">@"_ZN45_$LT$plsllvm$$Boo$u20$as$u20$plsllvm$$Foo$GT$1a17h8da93b67e1269092E"</span><span class="p">()</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="m">1</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv">%_6</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="nv">%_4</span> <span class="p">=</span> <span class="k">call</span> <span class="k">zeroext</span> <span class="kt">i1</span> <span class="vg">@"_ZN4core6option15Option$LT$T$GT$7is_some17h70f5212344228d54E"</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="k">align</span> <span class="m">1</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="nv">%_6</span><span class="p">)</span>
  <span class="nv nv-Anonymous">%2</span> <span class="p">=</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="kt">i8</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv">%buf</span><span class="p">,</span> <span class="kt">i64</span> <span class="nv nv-Anonymous">%0</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb7</span>

<span class="nl">bb7:</span>                                              <span class="c">; preds = %start</span>
  <span class="k">store</span> <span class="kt">i8</span> <span class="m">7</span><span class="p">,</span> <span class="kt">i8</span><span class="p">*</span> <span class="nv nv-Anonymous">%2</span><span class="p">,</span> <span class="k">align</span> <span class="m">1</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb9</span>

<span class="nl">bb9:</span>                                              <span class="c">; preds = %bb7</span>
  <span class="k">ret</span> <span class="k">void</span>
<span class="p">}</span>
</code></pre></div>



<a name="258297978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258297978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258297978">(Oct 20 2021 at 01:13)</a>:</h4>
<p>however at some point is_some seems to be rewritten into</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span> <span class="k">internal</span> <span class="kt">i1</span> <span class="vg">@"_ZN4core6option15Option$LT$T$GT$7is_some17h70f5212344228d54E"</span><span class="p">(</span><span class="kt">i8</span><span class="p">*</span> <span class="nv">%self</span><span class="p">)</span> <span class="k">unnamed_addr</span> <span class="vg">#0</span> <span class="p">{</span>
<span class="nl">start:</span>
  <span class="k">br</span> <span class="kt">i1</span> <span class="k">false</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb2</span><span class="p">,</span> <span class="kt">label</span> <span class="nv">%bb1</span>

<span class="nl">bb2:</span>                                              <span class="c">; preds = %start</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb3</span>

<span class="nl">bb1:</span>                                              <span class="c">; preds = %start</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb3</span>

<span class="nl">bb3:</span>                                              <span class="c">; preds = %bb1, %bb2</span>
  <span class="nv">%.0</span> <span class="p">=</span> <span class="k">phi</span> <span class="kt">i8</span> <span class="p">[</span> <span class="m">1</span><span class="p">,</span> <span class="nv">%bb2</span> <span class="p">],</span> <span class="p">[</span> <span class="m">0</span><span class="p">,</span> <span class="nv">%bb1</span> <span class="p">]</span>
  <span class="nv nv-Anonymous">%0</span> <span class="p">=</span> <span class="k">trunc</span> <span class="kt">i8</span> <span class="nv">%.0</span> <span class="k">to</span> <span class="kt">i1</span>
  <span class="k">ret</span> <span class="kt">i1</span> <span class="nv nv-Anonymous">%0</span>
<span class="p">}</span>
</code></pre></div>



<a name="258297981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258297981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258297981">(Oct 20 2021 at 01:13)</a>:</h4>
<p>which is very odd to say the least</p>



<a name="258298119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258298119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258298119">(Oct 20 2021 at 01:14)</a>:</h4>
<p>and that seems to happen after <code>SROA</code></p>



<a name="258298272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258298272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258298272">(Oct 20 2021 at 01:16)</a>:</h4>
<p>sroa seems to just plain delete the stores ???</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="nl">bb2:</span>                                              <span class="c">; preds = %start</span>
  <span class="c">; store i8 1, i8* %0, align 1                                       deleted</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb3</span>

<span class="nl">bb1:</span>                                              <span class="c">; preds = %start</span>
  <span class="c">; store i8 0, i8* %0, align 1                                       deleted</span>
  <span class="k">br</span> <span class="kt">label</span> <span class="nv">%bb3</span>
</code></pre></div>



<a name="258298327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258298327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258298327">(Oct 20 2021 at 01:17)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> IIRC you mentioned fewer-names caused issues with SROA, this isnt fewer-names but were the issues kind of like this?</p>



<a name="258298593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258298593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258298593">(Oct 20 2021 at 01:21)</a>:</h4>
<p>i hope i didnt find a major bug in LLVM for a library in which i dont control the version of llvm it uses <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="258298997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258298997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258298997">(Oct 20 2021 at 01:27)</a>:</h4>
<p>Ok LLVM 12 and LLVM 13 all optimize to the same exact thing</p>



<a name="258299715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258299715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258299715">(Oct 20 2021 at 01:39)</a>:</h4>
<p>wait this looks kind of sus </p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="nl">bb1:</span>
  <span class="nv">%_1.i</span> <span class="p">=</span> <span class="k">call</span> <span class="k">zeroext</span> <span class="kt">i32</span> <span class="vg">@__nvvm_thread_idx_x</span><span class="p">(),</span> <span class="nv">!range</span> <span class="nv nv-Anonymous">!2</span>

<span class="nv nv-Anonymous">!2</span> <span class="p">=</span> <span class="p">!{</span><span class="kt">i32</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">-1</span><span class="p">}</span>
</code></pre></div>



<a name="258299794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258299794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258299794">(Oct 20 2021 at 01:40)</a>:</h4>
<p>nvm removing that range doesn't do anything</p>



<a name="258302289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258302289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258302289">(Oct 20 2021 at 02:15)</a>:</h4>
<p>and this is what rustc gives which optimizes correctly <a href="/user_uploads/4715/DNPii4KDde7oOt9SlweI-OsK/rustc.ll">rustc.ll</a></p>



<a name="258302346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258302346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258302346">(Oct 20 2021 at 02:16)</a>:</h4>
<p>strangely, rustc represents the option as an aggregate</p>



<a name="258302363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258302363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258302363">(Oct 20 2021 at 02:16)</a>:</h4>
<p>it also uses a range of <code>!2 = !{i8 0, i8 2}</code> for the option</p>



<a name="258302610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258302610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258302610">(Oct 20 2021 at 02:20)</a>:</h4>
<p>ok it is the range, substituting the 0-1 range in my code for 0-2 makes it optimize correctly</p>



<a name="258302632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258302632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258302632">(Oct 20 2021 at 02:20)</a>:</h4>
<p>guess ill go back to my codegen and see if i borked something in the range calculation</p>



<a name="258302829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258302829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258302829">(Oct 20 2021 at 02:23)</a>:</h4>
<p>oh my god i am so dumb, <code>self.cx.const_uint_big(llty, range.end)</code> should be <code>self.cx.const_uint_big(llty, range.end.wrapping_add(1))</code></p>



<a name="258302869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258302869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258302869">(Oct 20 2021 at 02:24)</a>:</h4>
<p>thank you everyone for your help <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="258302874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Odd%20branch%20deletion%20in%20custom%20custom/near/258302874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Odd.20branch.20deletion.20in.20custom.20custom.html#258302874">(Oct 20 2021 at 02:24)</a>:</h4>
<p>sorry to bother</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>