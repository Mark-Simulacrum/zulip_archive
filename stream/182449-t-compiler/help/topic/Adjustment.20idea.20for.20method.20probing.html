<html>
<head><meta charset="utf-8"><title>Adjustment idea for method probing · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adjustment.20idea.20for.20method.20probing.html">Adjustment idea for method probing</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249692355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adjustment%20idea%20for%20method%20probing/near/249692355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> osa1 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adjustment.20idea.20for.20method.20probing.html#249692355">(Aug 17 2021 at 08:49)</a>:</h4>
<p>I'm curious if this makes sense. In this code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(arbitrary_self_types)]</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Test</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">a</span><span class="p">(</span><span class="bp">self</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="bp">Self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">doesnt_work</span><span class="p">(</span><span class="n">a</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Test</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">works</span><span class="p">(</span><span class="n">a</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Test</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Test</span><span class="p">).</span><span class="n">a</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>In the function "doesnt_work" I'm curious if we could search for <code>*mut Self</code> methods during method probing and add the adjustment automatically. WDYT? Any problems with this? I worked on method probing before, happy to implement this myself if there aren't any blockers.</p>



<a name="249747890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adjustment%20idea%20for%20method%20probing/near/249747890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adjustment.20idea.20for.20method.20probing.html#249747890">(Aug 17 2021 at 17:01)</a>:</h4>
<p>It seems very surprising to me that the compiler would dereference raw pointers implicitly, you could get crashes from code you didn't explicitly write</p>



<a name="249748273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adjustment%20idea%20for%20method%20probing/near/249748273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adjustment.20idea.20for.20method.20probing.html#249748273">(Aug 17 2021 at 17:04)</a>:</h4>
<p>It wouldn't, <code>Test::a</code> takes a <code>*mut Self</code> receiver</p>



<a name="249805435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adjustment%20idea%20for%20method%20probing/near/249805435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adjustment.20idea.20for.20method.20probing.html#249805435">(Aug 18 2021 at 04:08)</a>:</h4>
<p>Ahhh, that make more sense</p>



<a name="249819357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adjustment%20idea%20for%20method%20probing/near/249819357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> osa1 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adjustment.20idea.20for.20method.20probing.html#249819357">(Aug 18 2021 at 08:09)</a>:</h4>
<p>Right, as Jonas said, this just casts. In addition to being surprising to the user, dereferencing is unsafe so cannot be done implicitly.</p>



<a name="249826640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adjustment%20idea%20for%20method%20probing/near/249826640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Léo Lanteri Thauvin <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adjustment.20idea.20for.20method.20probing.html#249826640">(Aug 18 2021 at 09:41)</a>:</h4>
<p>I think this is consistent with what the reference says:</p>
<blockquote>
<p>When looking up a method call, the receiver may be automatically dereferenced or borrowed in order to call a method. This requires a more complex lookup process than for other functions, since there may be a number of possible methods to call. The following procedure is used:</p>
<p>The first step is to build a list of candidate receiver types. Obtain these by repeatedly dereferencing the receiver expression's type, adding each type encountered to the list, then finally attempting an unsized coercion at the end, and adding the result type if that is successful. Then, for each candidate <code>T</code>, add <code>&amp;T</code> and <code>&amp;mut T</code> to the list immediately after <code>T</code>.</p>
</blockquote>



<a name="249860668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adjustment%20idea%20for%20method%20probing/near/249860668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zie1ony <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adjustment.20idea.20for.20method.20probing.html#249860668">(Aug 18 2021 at 14:48)</a>:</h4>
<p>I'm exploring how to write a custom compiler plugin, but I can't find how to call rustc with the plugin file like this one: <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui-fulldeps/auxiliary/lint-for-crate.rs">https://github.com/rust-lang/rust/blob/master/src/test/ui-fulldeps/auxiliary/lint-for-crate.rs</a>  I have found that building a clippy lint could help, but it would be better to have it as rustc plugin. Could someone help?</p>



<a name="249863998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adjustment%20idea%20for%20method%20probing/near/249863998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> osa1 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adjustment.20idea.20for.20method.20probing.html#249863998">(Aug 18 2021 at 15:10)</a>:</h4>
<p><span class="user-mention" data-user-id="255061">@Léo Lanteri Thauvin</span> where is that quote from?<br>
<span class="user-mention" data-user-id="433805">@zie1ony</span> I think you posted to wrong thread. You may want to create a new thread.</p>



<a name="249864180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adjustment%20idea%20for%20method%20probing/near/249864180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Léo Lanteri Thauvin <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adjustment.20idea.20for.20method.20probing.html#249864180">(Aug 18 2021 at 15:11)</a>:</h4>
<p>The quote is from the Reference: <a href="https://doc.rust-lang.org/reference/expressions/method-call-expr.html">https://doc.rust-lang.org/reference/expressions/method-call-expr.html</a></p>



<a name="249864771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adjustment%20idea%20for%20method%20probing/near/249864771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adjustment.20idea.20for.20method.20probing.html#249864771">(Aug 18 2021 at 15:14)</a>:</h4>
<p>I mean, the reference can be changed, this is a language semantics change after all</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>