<html>
<head><meta charset="utf-8"><title>Testing +neon sans +fp is no-change · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html">Testing +neon sans +fp is no-change</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276215517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276215517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276215517">(Mar 22 2022 at 16:24)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> What kind of codegen test did you have in mind?</p>



<a name="276215908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276215908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276215908">(Mar 22 2022 at 16:27)</a>:</h4>
<p>Ah, hm, I'm not sure if codegen test in particular is a best option, but at the very least a regression test for the issues being fixed would be good.</p>



<a name="276216275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276216275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276216275">(Mar 22 2022 at 16:29)</a>:</h4>
<p>Ah, to make sure code invoking <code>#[target_feature(enable = "+neon")]</code> continues to compile? Yeah I can do that.</p>



<a name="276216464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276216464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276216464">(Mar 22 2022 at 16:30)</a>:</h4>
<p>AFAICT there are two things that are going wrong: one is us setting wrong <code>target_feature</code>s and another that we don’t allow code in <a href="https://github.com/rust-lang/rust/issues/95002">https://github.com/rust-lang/rust/issues/95002</a> to build. AFAIU what this PR achieves is ensuring that the superfluous cfgs don't get set and also that the code from <a href="https://github.com/rust-lang/rust/issues/95002">#95002</a> does build.</p>



<a name="276216700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276216700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276216700">(Mar 22 2022 at 16:31)</a>:</h4>
<p>Correct.</p>



<a name="276217202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276217202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276217202">(Mar 22 2022 at 16:35)</a>:</h4>
<p>re:</p>
<blockquote>
<p>This change alters the behaviour of the function entirely. Previously it was returning the rust view of the target features (some of which use different names, and some of which have mapping that's not 1:1), and now it'll return a list of the backend feature names.</p>
</blockquote>
<p>So on that, my understanding of the bug that crept in is that on the last change, it became the case that the smallvec that was being returned included "neon", which always matched.</p>



<a name="276219859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276219859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276219859">(Mar 22 2022 at 16:52)</a>:</h4>
<p>And my understanding was that normalizing to the LLVM features that way was acceptable because this is the function used to implement applying the target features during codegen.</p>



<a name="276221469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276221469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276221469">(Mar 22 2022 at 17:02)</a>:</h4>
<p><code>target_features</code> is _also_ used to produce the <code>cfg</code> variables (here I think: <a href="https://github.com/rust-lang/rust/blob/3ea44938e21f0de8ae7d4f6399a8a30f97867c70/compiler/rustc_interface/src/util.rs#L51">https://github.com/rust-lang/rust/blob/3ea44938e21f0de8ae7d4f6399a8a30f97867c70/compiler/rustc_interface/src/util.rs#L51</a>). And that one mustn't let backend feature names leak through.</p>



<a name="276221617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276221617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276221617">(Mar 22 2022 at 17:03)</a>:</h4>
<p>in isolation <code>to_llvm_features</code> is doing the right thing, but returning anything related to the backend feature names from <code>target_features</code> is incorrect.</p>



<a name="276222208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276222208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276222208">(Mar 22 2022 at 17:07)</a>:</h4>
<p>In short the following test must pass:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// compile-flags: -Ctarget-features=+rdrand --target=x86_64-unknown-linux-gnu</span>
<span class="cp">#![no_core]</span><span class="w"></span>
<span class="c1">//...</span>
<span class="n">static_assert_eq</span><span class="o">!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="o">=</span><span class="s">"rdrand"</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="n">static_assert_eq</span><span class="o">!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="o">=</span><span class="s">"rdrnd"</span><span class="p">),</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>And the following must pass as well:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// compile-flags: -Ctarget-features=+sse4.2 --target=x86_64-unknown-linux-gnu</span>
<span class="cp">#![no_core]</span><span class="w"></span>
<span class="c1">//...</span>
<span class="n">static_assert_eq</span><span class="o">!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="o">=</span><span class="s">"sse4.2"</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="n">static_assert_eq</span><span class="o">!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="o">=</span><span class="s">"crc32"</span><span class="p">),</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="276222769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276222769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276222769">(Mar 22 2022 at 17:10)</a>:</h4>
<p>Hmmmm.</p>



<a name="276222835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276222835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276222835">(Mar 22 2022 at 17:11)</a>:</h4>
<p>(these would be good tests to add as well, and since <a href="https://github.com/rust-lang/rust/pull/90621">https://github.com/rust-lang/rust/pull/90621</a> failed to add any for the <code>f32mm</code>, <code>f64mm</code>... codegen tests for these would be great too)</p>



<a name="276222844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276222844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276222844">(Mar 22 2022 at 17:11)</a>:</h4>
<p>Okay gonna add those regression tests yeah.</p>



<a name="276222923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276222923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276222923">(Mar 22 2022 at 17:11)</a>:</h4>
<p>(like, checking that <code>-Ctarget-feature=+f32mm</code> actually enables everything that it should enable on LLVM side of things)</p>



<a name="276223221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276223221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276223221">(Mar 22 2022 at 17:13)</a>:</h4>
<p>From the fix perspective, IIRC the decision to filter <a href="https://github.com/rust-lang/rust/blob/3ea44938e21f0de8ae7d4f6399a8a30f97867c70/compiler/rustc_codegen_llvm/src/llvm_util.rs#L242-L248">here</a> like “any” would rather than “all” was pretty arbitrary.</p>



<a name="276223446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276223446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276223446">(Mar 22 2022 at 17:15)</a>:</h4>
<p>so I think just changing the logic here from any to all might work out well. Basically the idea was that with <code>-Ctarget-cpu=native</code> you'd get rust features enabled if some subset of the llvm features were enabled, but that sounds silly now that I've written it out.</p>



<a name="276223471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276223471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276223471">(Mar 22 2022 at 17:15)</a>:</h4>
<p>thonking</p>



<a name="276241124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276241124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276241124">(Mar 22 2022 at 19:17)</a>:</h4>
<p>Alright, I think I got everything working, yeah.</p>



<a name="276241297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276241297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276241297">(Mar 22 2022 at 19:18)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// compile-flags: -Ctarget-feature=+sse4.2,+rdrand --target=x86_64-unknown-linux-gnu</span>
<span class="c1">// build-pass</span>
<span class="cp">#![feature(core_intrinsics)]</span><span class="w"></span>
<span class="cp">#![feature(lang_items)]</span><span class="w"></span>
<span class="cp">#![no_std]</span><span class="w"></span>
<span class="cp">#![crate_type = </span><span class="s">"rlib"</span><span class="cp">]</span><span class="w"></span>

<span class="cp">#[panic_handler]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">panic</span><span class="p">(</span><span class="n">_info</span>: <span class="kp">&amp;</span><span class="nc">core</span>::<span class="n">panic</span>::<span class="n">PanicInfo</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">core</span>::<span class="n">intrinsics</span>::<span class="n">abort</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[lang = </span><span class="s">"eh_personality"</span><span class="cp">]</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">eh_personality</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">const_assert</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$x</span>:<span class="nc">expr</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="p">[();</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">!</span><span class="p">{</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ASSERT</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cp">$x</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="n">ASSERT</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">check</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// This checks that the rustc feature name is used, not the LLVM feature.</span>
<span class="w">    </span><span class="cp">#[cfg(target_feature = </span><span class="s">"rdrand"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">RDRAND</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(not(target_feature = </span><span class="s">"rdrand"</span><span class="cp">))]</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">RDRAND</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(target_feature = </span><span class="s">"rdrnd"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">RDRND</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(not(target_feature = </span><span class="s">"rdrnd"</span><span class="cp">))]</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">RDRND</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">const_assert</span><span class="o">!</span><span class="p">(</span><span class="n">RDRAND</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">const_assert</span><span class="o">!</span><span class="p">(</span><span class="n">RDRND</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Likewise: We enable LLVM's crc32 feature, but treat it as simply sse4.2</span>
<span class="w">    </span><span class="cp">#[cfg(target_feature = </span><span class="s">"sse4.2"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">SSE4_2</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(not(target_feature = </span><span class="s">"sse4.2"</span><span class="cp">))]</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">SSE4_2</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(target_feature = </span><span class="s">"crc32"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">CRC32</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[cfg(not(target_feature = </span><span class="s">"crc32"</span><span class="cp">))]</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">CRC32</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">const_assert</span><span class="o">!</span><span class="p">(</span><span class="n">SSE4_2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">const_assert</span><span class="o">!</span><span class="p">(</span><span class="n">CRC32</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This... will be made much prettier with macros.</p>



<a name="276241418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276241418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276241418">(Mar 22 2022 at 19:19)</a>:</h4>
<p>Can you use <code>cfg!(target_feature = "...")</code> instead of <code>#[cfg]</code>?</p>



<a name="276241523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276241523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276241523">(Mar 22 2022 at 19:20)</a>:</h4>
<p>You also need <code>// needs-llvm-component: x86</code> I think. Don't know the exact syntax.</p>



<a name="276241872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276241872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276241872">(Mar 22 2022 at 19:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change/near/276241418">said</a>:</p>
<blockquote>
<p>Can you use <code>cfg!(target_feature = "...")</code> instead of <code>#[cfg]</code>?</p>
</blockquote>
<p>Ah, yeah, I can. I tried before and it didn't work, but I think it was something else not working.</p>



<a name="276242087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276242087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276242087">(Mar 22 2022 at 19:25)</a>:</h4>
<p>much nicer.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// compile-flags: -Ctarget-feature=+sse4.2,+rdrand --target=x86_64-unknown-linux-gnu</span>
<span class="c1">// needs-llvm-components: x86</span>
<span class="c1">// build-pass</span>
<span class="cp">#![feature(core_intrinsics)]</span><span class="w"></span>
<span class="cp">#![feature(lang_items)]</span><span class="w"></span>
<span class="cp">#![no_std]</span><span class="w"></span>
<span class="cp">#![crate_type = </span><span class="s">"rlib"</span><span class="cp">]</span><span class="w"></span>

<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">const_assert</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$x</span>:<span class="nc">expr</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="p">[();</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">!</span><span class="p">{</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ASSERT</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cp">$x</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="n">ASSERT</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">check</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// This checks that the rustc feature name is used, not the LLVM feature.</span>
<span class="w">    </span><span class="n">const_assert</span><span class="o">!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"rdrand"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">const_assert</span><span class="o">!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"rdrnd"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Likewise: We enable LLVM's crc32 feature, but Rust says it's just no</span>
<span class="w">    </span><span class="n">const_assert</span><span class="o">!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"sse4.2"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">const_assert</span><span class="o">!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"crc32"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276243442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276243442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276243442">(Mar 22 2022 at 19:36)</a>:</h4>
<p>ugh, how do I specify a test needs to be cross-compiled with core appropriately?</p>



<a name="276243621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276243621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276243621">(Mar 22 2022 at 19:38)</a>:</h4>
<p>You have to use <code>#![no_core]</code> for that and provide the respective lang items yourself.</p>



<a name="276243716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276243716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276243716">(Mar 22 2022 at 19:38)</a>:</h4>
<p>hmm.</p>



<a name="276243717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276243717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276243717">(Mar 22 2022 at 19:38)</a>:</h4>
<p>Or you can use <code>// only-x86-64</code>.</p>



<a name="276243731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276243731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276243731">(Mar 22 2022 at 19:38)</a>:</h4>
<p>annoying.</p>



<a name="276243965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276243965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276243965">(Mar 22 2022 at 19:40)</a>:</h4>
<p>right, I remember now,<br>
my problem was trying to use <code>cfg!</code> in <code>#![no_core]</code> doesn't work. <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="276244014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276244014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276244014">(Mar 22 2022 at 19:40)</a>:</h4>
<p><code>#[rustc_builtin_macro = "cfg"] macro_rules! cfg {}</code> or something like that.</p>



<a name="276244056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276244056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276244056">(Mar 22 2022 at 19:41)</a>:</h4>
<p>ooh thanks.</p>



<a name="276244458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276244458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276244458">(Mar 22 2022 at 19:44)</a>:</h4>
<p>oh and now I need to implement subtracting usize</p>



<a name="276244470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276244470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276244470">(Mar 22 2022 at 19:44)</a>:</h4>
<p>lol. lmao.</p>



<a name="276244532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276244532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276244532">(Mar 22 2022 at 19:45)</a>:</h4>
<p>You can take inspiration from <a href="https://github.com/bjorn3/rustc_codegen_cranelift/blob/master/example/mini_core.rs">https://github.com/bjorn3/rustc_codegen_cranelift/blob/master/example/mini_core.rs</a></p>



<a name="276244571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276244571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276244571">(Mar 22 2022 at 19:45)</a>:</h4>
<p>This is what I use to test some cg_clif things without having to recompile the full standard library.</p>



<a name="276246960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276246960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276246960">(Mar 22 2022 at 20:04)</a>:</h4>
<p>tests in the test/ui/ suite can't refer to each other via <code>extern</code> or all that, right?</p>



<a name="276247320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276247320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276247320">(Mar 22 2022 at 20:07)</a>:</h4>
<p>You can use auxiliary crates. Basically put the crate source in a file inside the <code>auxiliary</code> directory of the directory in which the actual test is and then use <code>// aux-build:crate_source.rs</code> in the actual test.</p>



<a name="276247413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276247413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276247413">(Mar 22 2022 at 20:08)</a>:</h4>
<p>ah cool cool.</p>



<a name="276247755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276247755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276247755">(Mar 22 2022 at 20:11)</a>:</h4>
<p>I'm not sure if its worth to make the no-core if it takes significant effort to do so.</p>



<a name="276247879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276247879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276247879">(Mar 22 2022 at 20:12)</a>:</h4>
<p><code>only-x86</code> for complex cases is plenty okay. Sure it won't run if somebody is developing on ARM, but hey, maintaining an implementation of a subset of core for every test is also not a great proposition.</p>



<a name="276247940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276247940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276247940">(Mar 22 2022 at 20:12)</a>:</h4>
<p>(I could definitely see some sort of common file that you could <code>include!()</code> into tests though)</p>



<a name="276248163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276248163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276248163">(Mar 22 2022 at 20:14)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> yeah I was going to use aux-build, and actually the case I wanted to handle is that I am on an x86 machine and I want to make sure aarch64 tests pass.</p>



<a name="276248547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276248547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276248547">(Mar 22 2022 at 20:17)</a>:</h4>
<p>you could also avoid having to implement subtraction and <code>!</code> with something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"rust-intrinsics"</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">fn</span> <span class="nf">abort</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="cp">#[rustc_do_not_const_check]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">assert</span><span class="p">(</span><span class="n">cond</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"></span>
<span class="w">        </span><span class="n">abort</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>or some such.</p>



<a name="276248576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276248576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276248576">(Mar 22 2022 at 20:17)</a>:</h4>
<p>lmao</p>



<a name="276248803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276248803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276248803">(Mar 22 2022 at 20:19)</a>:</h4>
<p>/me prototypes it in playground.</p>



<a name="276249030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276249030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276249030">(Mar 22 2022 at 20:21)</a>:</h4>
<p>apparently aux-build doesn't play nice with cross-compiling.</p>



<a name="276250547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276250547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276250547">(Mar 22 2022 at 20:35)</a>:</h4>
<p>I did it!</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![no_core]</span><span class="w"></span>
<span class="cp">#![feature(intrinsics, rustc_attrs, no_core, lang_items, staged_api)]</span><span class="w"></span>
<span class="cp">#![stable(feature = </span><span class="s">"test"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>

<span class="cp">#[rustc_builtin_macro]</span><span class="w"></span>
<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">cfg</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$($cfg</span>:<span class="nc">tt</span><span class="p">)</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[lang = </span><span class="s">"sized"</span><span class="cp">]</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="nb">Sized</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="cp">#[lang = </span><span class="s">"copy"</span><span class="cp">]</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="nb">Copy</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">extern</span><span class="w"> </span><span class="s">"rust-intrinsic"</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[rustc_const_stable(feature = </span><span class="s">"test"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">unreachable</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">assert</span><span class="p">(</span><span class="n">cond</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">unreachable</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">assert_not</span><span class="p">(</span><span class="n">cond</span>: <span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">cond</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">unreachable</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">YES</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assert</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"sse2"</span><span class="p">));</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">NO</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assert_not</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"sse4.1"</span><span class="p">));</span><span class="w"></span>
</code></pre></div>
<p>replace the assert contents with other stuff.</p>



<a name="276250586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276250586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276250586">(Mar 22 2022 at 20:35)</a>:</h4>
<p>Oh nice.</p>



<a name="276250810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276250810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276250810">(Mar 22 2022 at 20:37)</a>:</h4>
<p>I feel like you'll probably want to use revisions for this test to avoid having to replicate the supporting code multiple times between tests.</p>



<a name="276250823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276250823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276250823">(Mar 22 2022 at 20:37)</a>:</h4>
<p>yeaaaaaah.</p>



<a name="276250892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276250892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276250892">(Mar 22 2022 at 20:38)</a>:</h4>
<p>/me wonders if revisions actually add any <code>cfg</code> variables for test to use...</p>



<a name="276250911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276250911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276250911">(Mar 22 2022 at 20:38)</a>:</h4>
<p>If you specify them, I think?</p>



<a name="276251198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276251198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276251198">(Mar 22 2022 at 20:41)</a>:</h4>
<p>we do already by default: <a href="https://github.com/rust-lang/rust/blob/64137f0b15b752d0c734661dc713bcd140858320/src/tools/compiletest/src/runtest.rs#L601-L608">https://github.com/rust-lang/rust/blob/64137f0b15b752d0c734661dc713bcd140858320/src/tools/compiletest/src/runtest.rs#L601-L608</a>!</p>



<a name="276251216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276251216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276251216">(Mar 22 2022 at 20:41)</a>:</h4>
<p>props to whoever had the foresight to add this specific function</p>



<a name="276251507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276251507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276251507">(Mar 22 2022 at 20:44)</a>:</h4>
<p>oh nice.</p>



<a name="276251651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276251651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276251651">(Mar 22 2022 at 20:45)</a>:</h4>
<p>so that means a revision should be x86-64 or x86_64, I think, and another one should be aarch64...</p>



<a name="276251703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276251703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276251703">(Mar 22 2022 at 20:46)</a>:</h4>
<p>yeah, it'd look probably something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// revisions: aarch64 x64</span>
<span class="c1">// [aarch64] compile-flags: ...</span>
<span class="c1">// [x64] compile-flags: ...</span>

<span class="cm">/* common supporting code here */</span><span class="w"></span>

<span class="cp">#[cfg(aarch64)]</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">FOO</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assert</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"someaarch64feat"</span><span class="p">));</span><span class="w"></span>
<span class="cp">#[cfg(x64)]</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">BAR</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assert</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"somex86feat"</span><span class="p">));</span><span class="w"></span>
</code></pre></div>
<p>etc. You could also <code>cfg</code> based on <code>target_arch</code> and similar cfgs too, I guess.</p>



<a name="276251826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276251826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276251826">(Mar 22 2022 at 20:46)</a>:</h4>
<p>right.</p>



<a name="276261534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276261534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276261534">(Mar 22 2022 at 22:08)</a>:</h4>
<p>nailed it (I think?)</p>



<a name="276261646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276261646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276261646">(Mar 22 2022 at 22:09)</a>:</h4>
<p>One more question: isn't neon enabled by default?</p>



<a name="276261732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276261732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276261732">(Mar 22 2022 at 22:10)</a>:</h4>
<p>I think the test that verifies that <code>+sve2</code> implies <code>+neon</code> isn't really doing that in that case, since both of them are explicitly enabled.</p>



<a name="276261843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276261843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276261843">(Mar 22 2022 at 22:11)</a>:</h4>
<p>I think you'll want <code>-Ctarget-feature=-neon,+sve2</code> there.</p>



<a name="276262375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276262375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276262375">(Mar 22 2022 at 22:18)</a>:</h4>
<p>possibly.</p>



<a name="276263068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276263068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276263068">(Mar 22 2022 at 22:25)</a>:</h4>
<p>odd. this whiffs?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg(aarch64_sve2)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">check_sve2_includes_neon</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// This checks that aarch64's sve2 includes neon...</span>
<span class="w">    </span><span class="c1">// ...and that we've managed to avoid turning neon on by default.</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">not</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"neon"</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sve2_check</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[target_feature(enable = </span><span class="s">"sve2"</span><span class="cp">)]</span><span class="w"></span>
<span class="cp">#[cfg(aarch64_sve2)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">sve2_check</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// assert!(cfg!(target_feature = "neon"));</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"sve2"</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="276263641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276263641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276263641">(Mar 22 2022 at 22:32)</a>:</h4>
<p>Well whatever. I will return to that mystery another time. The simpler version works.</p>



<a name="276263776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276263776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276263776">(Mar 22 2022 at 22:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281757">Jubilee</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change/near/276263068">said</a>:</p>
<blockquote>
<p>odd. this whiffs?</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg(aarch64_sve2)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">check_sve2_includes_neon</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// This checks that aarch64's sve2 includes neon...</span>
<span class="w">    </span><span class="c1">// ...and that we've managed to avoid turning neon on by default.</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">not</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"neon"</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">sve2_check</span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[target_feature(enable = </span><span class="s">"sve2"</span><span class="cp">)]</span><span class="w"></span>
<span class="cp">#[cfg(aarch64_sve2)]</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">sve2_check</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// assert!(cfg!(target_feature = "neon"));</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="fm">cfg!</span><span class="p">(</span><span class="n">target_feature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"sve2"</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>Ha, this doesn't work, if you uncommend the neon assert in <code>sve2_check</code>, right? I can see why (it probably has everything to do with there being like a dozen different places and implementations all over the place all doing different things…)</p>



<a name="276263871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276263871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276263871">(Mar 22 2022 at 22:34)</a>:</h4>
<p>This is a genuine bug, but also would definitely be a preexisting one.</p>



<a name="276263897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20%2Bneon%20sans%20%2Bfp%20is%20no-change/near/276263897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20.2Bneon.20sans.20.2Bfp.20is.20no-change.html#276263897">(Mar 22 2022 at 22:34)</a>:</h4>
<p>Yeaaaah.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>