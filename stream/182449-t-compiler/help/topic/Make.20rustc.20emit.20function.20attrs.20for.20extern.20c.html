<html>
<head><meta charset="utf-8"><title>Make rustc emit function attrs for extern c · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20rustc.20emit.20function.20attrs.20for.20extern.20c.html">Make rustc emit function attrs for extern c</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262010728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20rustc%20emit%20function%20attrs%20for%20extern%20c/near/262010728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20rustc.20emit.20function.20attrs.20for.20extern.20c.html#262010728">(Nov 19 2021 at 00:09)</a>:</h4>
<p>I ran into a not-so-minor issue in my CUDA codegen which im not so sure how to solve. <br>
As a background, my codegen guarantees how structs, slices, arrays, etc are passed through GPU kernels by overriding the ABI calculation for anything not rustcall. This is because CUDA expects stuff like <code>foo: Foo</code> to be always passed by value (CUDA supports this, it uses byte arrays), and rustc wouldn't do that, it'd pass it indirectly which yielded a nice segfault. So i overrode the ABI calculation just to guarantee certain things are passed that way.</p>
<p>This works perfectly, but i just realized that rustc will not emit very important function attributes like noalias for extern "C" functions. This is a big problem because <code>noalias</code> is vital for fast GPU code, because it allows cuda to load things like <code>&amp;[u8]</code> into readonly cache, which can have tremendous performance benefits.</p>
<p>Im not quite sure how i could solve this issue, i basically need to tell rustc to treat extern c functions as normal rust functions, to add any attributes it would normally add if it was a rust function. I have tried making a "shell" rust function called by the top level gpu kernel, but that does not work, looking at the LLVM IR and the generated PTX, there is no <code>ld.global.nc</code> (non-coherent read-only cache read) being generated.</p>



<a name="262010876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20rustc%20emit%20function%20attrs%20for%20extern%20c/near/262010876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20rustc.20emit.20function.20attrs.20for.20extern.20c.html#262010876">(Nov 19 2021 at 00:11)</a>:</h4>
<p>Is there any way to retrieve the attributes it would have put but is not putting because it is extern "C"? so i can then apply them to the functions that need them</p>



<a name="262018326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20rustc%20emit%20function%20attrs%20for%20extern%20c/near/262018326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20rustc.20emit.20function.20attrs.20for.20extern.20c.html#262018326">(Nov 19 2021 at 01:54)</a>:</h4>
<p>oh i think the problem is actually that i am not giving any scalar attrs when making a new arg abi</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ArgAbi</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">.</span><span class="n">layout</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">ArgAttributes</span>::<span class="n">new</span><span class="p">());</span><span class="w"></span>
</code></pre></div>



<a name="262018871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20rustc%20emit%20function%20attrs%20for%20extern%20c/near/262018871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20rustc.20emit.20function.20attrs.20for.20extern.20c.html#262018871">(Nov 19 2021 at 02:03)</a>:</h4>
<p>it seems that fixed it for <code>&amp;Struct</code> but slices are still the same, it emits <code>[0 x float]* nocapture readonly %a.0</code> without noalias, which is weird</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>