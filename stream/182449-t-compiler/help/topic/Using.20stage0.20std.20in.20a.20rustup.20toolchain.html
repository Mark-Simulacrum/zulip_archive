<html>
<head><meta charset="utf-8"><title>Using stage0 std in a rustup toolchain · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Using.20stage0.20std.20in.20a.20rustup.20toolchain.html">Using stage0 std in a rustup toolchain</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252973971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Using%20stage0%20std%20in%20a%20rustup%20toolchain/near/252973971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Using.20stage0.20std.20in.20a.20rustup.20toolchain.html#252973971">(Sep 12 2021 at 09:42)</a>:</h4>
<p>Hi! Maybe I missed something obvious, but is there an easy way to build just the stdlib (with stage0 compiler), and then use the resulting stage0 rustc + modified stage0 stdlib to create a <code>rustup</code> toolchain?</p>
<p>When working on the compiler, when stage1 is built, it creates a directory with <code>bin</code> and <code>lib</code> directories that can be easily turned into a toolchain using <code>rustup toolchain link</code>. This makes it very convenient to e.g. run <code>rustc-perf</code> benchmarks using the linked toolchain or just use it to compile arbitrary crates using <code>cargo +my-toolchain build</code>.</p>
<p>Now let's say that I want to try some hacking on the stdlib, without changing the compiler at all. I can build stage1 rustc + stage1 libstd, but that takes several minutes to compile on my PC after each change. I can compile just the stdlib with the stage0 compiler using e.g. <code>x.py build library/std --stage 0</code>, which is fast. But this will only create the <code>stage0-std</code> directory, and I can't easily create a <code>rustup</code> toolchain out of that. Is there an easy way of achieving this? Basically I want to create a directory that has <code>bin</code> and <code>lib</code> directories with stage0 rustc linked to the modified stage0 libdstd.</p>



<a name="252974395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Using%20stage0%20std%20in%20a%20rustup%20toolchain/near/252974395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Using.20stage0.20std.20in.20a.20rustup.20toolchain.html#252974395">(Sep 12 2021 at 09:51)</a>:</h4>
<p><code>./x.py build --stage 0</code></p>



<a name="252974607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Using%20stage0%20std%20in%20a%20rustup%20toolchain/near/252974607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Using.20stage0.20std.20in.20a.20rustup.20toolchain.html#252974607">(Sep 12 2021 at 09:55)</a>:</h4>
<p>This indeed builds stage0 libstd, but does it generate a directory with rustc + libstd which could be linked by <code>rustup</code>? When I look into build/&lt;target&gt;/stage0 directory, it still uses the original (beta) libstd. I tried creating a toolchain out of it and it does not contain my modifications to std.</p>



<a name="252974759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Using%20stage0%20std%20in%20a%20rustup%20toolchain/near/252974759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Using.20stage0.20std.20in.20a.20rustup.20toolchain.html#252974759">(Sep 12 2021 at 09:58)</a>:</h4>
<p>The built rustc is located in stage0-rustc, the built libstd is located in stage0-std, but I didn't find a directory that would contain these two things in a form that could be easily used and linked by <code>rustup</code>.</p>



<a name="252974786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Using%20stage0%20std%20in%20a%20rustup%20toolchain/near/252974786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Using.20stage0.20std.20in.20a.20rustup.20toolchain.html#252974786">(Sep 12 2021 at 09:59)</a>:</h4>
<p>I think that the .so used to run rustc, not the std rlib used to build projects with that rustc</p>



<a name="252981550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Using%20stage0%20std%20in%20a%20rustup%20toolchain/near/252981550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Using.20stage0.20std.20in.20a.20rustup.20toolchain.html#252981550">(Sep 12 2021 at 12:01)</a>:</h4>
<p>Yes, the correct .so has to be used I suppose. I was wondering if the current infrastructure prepares such directory with stage0 rustc and <a href="http://libstd.so">libstd.so</a> (to enable rustup linking), but it seems that it doesn't.</p>



<a name="252992582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Using%20stage0%20std%20in%20a%20rustup%20toolchain/near/252992582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Using.20stage0.20std.20in.20a.20rustup.20toolchain.html#252992582">(Sep 12 2021 at 15:04)</a>:</h4>
<p>No, there's no sysroot with stage0 std and the bootstrap compiler. There's <code>stage0-sysroot</code>, but it doesn't have the beta compiler. (Maybe you could copy it by hand and have it work?)</p>



<a name="253043599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Using%20stage0%20std%20in%20a%20rustup%20toolchain/near/253043599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Using.20stage0.20std.20in.20a.20rustup.20toolchain.html#253043599">(Sep 13 2021 at 06:31)</a>:</h4>
<p>That sounds like a plan, I'll try it :) Maybe I'm doing this in a wrong way, what's your way of hacking on the stdlib? Recompiling stage1 every time?</p>



<a name="253085233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Using%20stage0%20std%20in%20a%20rustup%20toolchain/near/253085233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Using.20stage0.20std.20in.20a.20rustup.20toolchain.html#253085233">(Sep 13 2021 at 13:02)</a>:</h4>
<p>I would run x.py test --stage 0 library/std. It's the standard library, so writing a test for it is exactly the same as using it in a standalone project.</p>



<a name="253366741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Using%20stage0%20std%20in%20a%20rustup%20toolchain/near/253366741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Using.20stage0.20std.20in.20a.20rustup.20toolchain.html#253366741">(Sep 15 2021 at 06:02)</a>:</h4>
<p>Thanks, that sounds like a reasonable solution :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>