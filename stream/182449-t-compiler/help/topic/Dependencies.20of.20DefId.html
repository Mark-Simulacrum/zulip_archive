<html>
<head><meta charset="utf-8"><title>Dependencies of DefId · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html">Dependencies of DefId</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250940862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250940862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250940862">(Aug 27 2021 at 14:36)</a>:</h4>
<p>It's me again :P is there anyway to get the dependencies of a <code>DefId</code> across crates / compilation sessions? By that I mean the set of DefIds mentioned in the body / definition. </p>
<p>It seems like this could be answered by the <code>DepGraph</code> but I'm not certain...</p>



<a name="250941403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250941403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250941403">(Aug 27 2021 at 14:40)</a>:</h4>
<p>Otherwise I supposed I can store the <code>DefPathHash</code>es of definitions during compilation and use that to look up definitions across session boundaries</p>



<a name="250942055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250942055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton Golov [they/them] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250942055">(Aug 27 2021 at 14:44)</a>:</h4>
<p>If this isn't done yet, I think it may be worth doing in some form; I think something like this is likely going to be needed to make the dead code pass per-module rather than per-crate.</p>



<a name="250942992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250942992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250942992">(Aug 27 2021 at 14:50)</a>:</h4>
<p>I can't find any easy query to get a reachable set for a DefId, let alone across crates</p>



<a name="250943061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250943061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250943061">(Aug 27 2021 at 14:50)</a>:</h4>
<p>I also can't figure out if external crates keep their dependencies in the current dep graph</p>



<a name="250945066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250945066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250945066">(Aug 27 2021 at 15:03)</a>:</h4>
<p>The dep graph is per compilation session and not created at all when incremental mode is not enabled.</p>



<a name="250945301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250945301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250945301">(Aug 27 2021 at 15:04)</a>:</h4>
<p>yeah but doesn't it load the previous session's graph and use stable fingerprints?</p>



<a name="250945402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250945402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250945402">(Aug 27 2021 at 15:05)</a>:</h4>
<p>are queries not cached at all without incremental mode?</p>



<a name="250950763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250950763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250950763">(Aug 27 2021 at 15:43)</a>:</h4>
<p>Queries are not cached only during the current compilation session when incremental mode is disabled.</p>



<a name="250952839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250952839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250952839">(Aug 27 2021 at 15:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Dependencies.20of.20DefId/near/250940862">said</a>:</p>
<blockquote>
<p>It's me again :P is there anyway to get the dependencies of a <code>DefId</code> across crates / compilation sessions? By that I mean the set of DefIds mentioned in the body / definition. </p>
</blockquote>
<p>What do you want to do? What do you mean exactly by "dependencies"? Mentions in HIR? MIR calls?</p>



<a name="250954041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250954041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250954041">(Aug 27 2021 at 16:06)</a>:</h4>
<p>Either could work for me I believe</p>



<a name="250954297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250954297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250954297">(Aug 27 2021 at 16:08)</a>:</h4>
<p>For MIR calls you could take a look at the collector: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir/src/monomorphize/collector.rs">https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir/src/monomorphize/collector.rs</a> Depending on what you need it for you may need to customize the used crate roots and maybe remove the special cases for <code>#[inline]</code>..</p>



<a name="250954414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250954414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250954414">(Aug 27 2021 at 16:09)</a>:</h4>
<p>That can go across crates?</p>



<a name="250954509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250954509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250954509">(Aug 27 2021 at 16:10)</a>:</h4>
<p>If you use <code>-Zalways-encode-mir</code> and remove the code that prevents it from going across crates, yes.</p>



<a name="250954555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250954555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250954555">(Aug 27 2021 at 16:10)</a>:</h4>
<p>Ah yea, sadly I can’t use always-encode-mir for other reasons</p>



<a name="250954593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250954593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250954593">(Aug 27 2021 at 16:11)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/4a6547cca6d2b2f465f01331927855734687b527/compiler/rustc_mir/src/monomorphize/collector.rs#L939-L978">https://github.com/rust-lang/rust/blob/4a6547cca6d2b2f465f01331927855734687b527/compiler/rustc_mir/src/monomorphize/collector.rs#L939-L978</a></p>



<a name="250954610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250954610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250954610">(Aug 27 2021 at 16:11)</a>:</h4>
<p>I guess I’ll just go for my approach of storing defpathhash es</p>



<a name="250955080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250955080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250955080">(Aug 27 2021 at 16:14)</a>:</h4>
<p>So as I compile crates I can create a map of dependencies for each DefId</p>



<a name="250955081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250955081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250955081">(Aug 27 2021 at 16:14)</a>:</h4>
<p>Looking at the documentation those should be stable</p>



<a name="250955268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250955268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250955268">(Aug 27 2021 at 16:15)</a>:</h4>
<p>The <code>DefPathHash</code> is stable. The <code>DefId</code> is not.</p>



<a name="250955478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250955478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250955478">(Aug 27 2021 at 16:17)</a>:</h4>
<p>A <code>DefId</code> is and id that corresponds to a specific <code>DefPathHash</code> within the current compilation session. The <code>DefId</code> changes between compilation sessions.</p>



<a name="250955676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250955676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250955676">(Aug 27 2021 at 16:18)</a>:</h4>
<p>Yea but I can turn a defpathhash into a DefId within a session, right?</p>



<a name="250955731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250955731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250955731">(Aug 27 2021 at 16:18)</a>:</h4>
<p>Through the cratestore interface</p>



<a name="250956648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250956648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250956648">(Aug 27 2021 at 16:24)</a>:</h4>
<p>Yes, for as long as the <code>DefPathHash</code> actually exists in the current crate or a (direct or indirect) dependency of the current crate.</p>



<a name="250956857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Dependencies%20of%20DefId/near/250956857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Dependencies.20of.20DefId.html#250956857">(Aug 27 2021 at 16:26)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_metadata/creader/struct.CStore.html#method.def_path_hash_to_def_id">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_metadata/creader/struct.CStore.html#method.def_path_hash_to_def_id</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>