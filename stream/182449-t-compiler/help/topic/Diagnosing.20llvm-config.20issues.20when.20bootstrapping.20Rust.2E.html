<html>
<head><meta charset="utf-8"><title>Diagnosing llvm-config issues when bootstrapping Rust. · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html">Diagnosing llvm-config issues when bootstrapping Rust.</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256262429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256262429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AdamH <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256262429">(Oct 05 2021 at 15:07)</a>:</h4>
<p>Hi all! I'm currently (as mentioned in my welcome message) attempting to get the rust compiler working with a custom llvm implementation. I thought I had succeeded in this but unfortunately, I'm getting issues when looking up my "new" target in llvm's target machine. (Specifically, this is in the function <code>LLVMRustCreateTargetMachine</code> in <code>PassWrapper.cpp</code>)</p>
<p>I <em>believe</em> that my issue is with the way that the bootstrap compiler is finding <code>llvm-config</code>, but I'm struggling to diagnose/debug this exactly. I <em>believe</em> that I've set it correctly in <code>config.toml</code>, as follows: </p>
<div class="codehilite"><pre><span></span><code>[build]
verbose = 2

target = [&quot;x86_64-unknown-linux-gnu&quot;, &quot;my-special-target&quot;]

[rust]
debug-logging = true
incremental = true
debug = true
codegen-units = 0
debuginfo-level = 2
backtrace-on-ice = true

[llvm]
download-ci-llvm = false

[target.x86_64-unknown-linux-gnu]
llvm-config = &quot;/path/to/my/llvm/build/folder/bin/llvm-config&quot;

[target.my-special-target]
llvm-config = &quot;/path/to/my/llvm/build/folder/bin/llvm-config&quot;
</code></pre></div>
<p>Does anyone have any advice as to how I should diagnose this, or if there is another route that I should be taking to to specify the <code>llvm-config</code> program?</p>



<a name="256265427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256265427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256265427">(Oct 05 2021 at 15:22)</a>:</h4>
<p>You can always check what LLVM is being linked to by looking at the <code>ldd</code> output for <code>librustc_codegen_llvm.so</code></p>



<a name="256265577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256265577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AdamH <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256265577">(Oct 05 2021 at 15:23)</a>:</h4>
<p>Ah, that's a good shout!</p>



<a name="256266182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256266182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256266182">(Oct 05 2021 at 15:26)</a>:</h4>
<p>Hm, they're rlibs actually… well, since its system llvm something must link to llvm dynamically either way.</p>



<a name="256266283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256266283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256266283">(Oct 05 2021 at 15:26)</a>:</h4>
<p>perhaps <a href="http://librustc_driver.so">librustc_driver.so</a>... or something of the sort.</p>



<a name="256266885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256266885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AdamH <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256266885">(Oct 05 2021 at 15:30)</a>:</h4>
<p>I am currently re-compiling rustc_driver, but I shall take a look for that once it's done.</p>



<a name="256269120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256269120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AdamH <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256269120">(Oct 05 2021 at 15:42)</a>:</h4>
<p>Okay, I can confirm that the <code>llvm-config</code> in <code>rustc_llvm/build.rs</code> <em>is</em> seeing the correct my llvm.</p>



<a name="256269159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256269159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AdamH <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256269159">(Oct 05 2021 at 15:42)</a>:</h4>
<p>(And it sees our backend as one of the components)</p>



<a name="256270493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256270493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AdamH <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256270493">(Oct 05 2021 at 15:51)</a>:</h4>
<p>Hmm, so I can confirm that I see symbols from my backend in <code>librustc_driver.so</code>. I suppose there must be some other issue occuring.</p>



<a name="256272704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256272704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256272704">(Oct 05 2021 at 16:04)</a>:</h4>
<p>Did you add your backend initialization functions to <code>initialize_available_targets</code>?</p>



<a name="256272749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256272749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256272749">(Oct 05 2021 at 16:04)</a>:</h4>
<p>in compiler/rustc_llvm/src/lib.rs</p>



<a name="256273165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256273165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AdamH <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256273165">(Oct 05 2021 at 16:06)</a>:</h4>
<p>Ah, I did not! I wasn't aware of that.</p>



<a name="256273287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnosing%20llvm-config%20issues%20when%20bootstrapping%20Rust./near/256273287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> AdamH <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnosing.20llvm-config.20issues.20when.20bootstrapping.20Rust.2E.html#256273287">(Oct 05 2021 at 16:07)</a>:</h4>
<p>Giving that a try now.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>