<html>
<head><meta charset="utf-8"><title>Obtain External Mir · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Obtain.20External.20Mir.html">Obtain External Mir</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263092576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Obtain%20External%20Mir/near/263092576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jerry Liu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Obtain.20External.20Mir.html#263092576">(Nov 30 2021 at 01:42)</a>:</h4>
<p>Hi everyone, I am working on a program verifier on Rust which encodes <code>mir</code> to <code>viper</code>. One issue we encountered is that we would like to develop a feature which allows users to write the specification and implmentation separately, especially when the functions they try to verify is in a dependency crate. However, looks like currently rustc only let us obtain <code>optimized_mir</code> if the function is not local, but we need the <code>mir</code> before optimization for encoding purpose. Is there any workaround?</p>



<a name="263108022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Obtain%20External%20Mir/near/263108022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Obtain.20External.20Mir.html#263108022">(Nov 30 2021 at 07:08)</a>:</h4>
<p>You can use -Zmir-opt-level=0 to disable all MIR optimizations.</p>



<a name="263108344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Obtain%20External%20Mir/near/263108344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jerry Liu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Obtain.20External.20Mir.html#263108344">(Nov 30 2021 at 07:15)</a>:</h4>
<p>What if I only want to obtain the unoptimized version<code>mir</code> of a procedure's body with a specific <code>DefId</code>? I guess the arg you mentioned will disable all MIR optimizations?</p>



<a name="263108417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Obtain%20External%20Mir/near/263108417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Obtain.20External.20Mir.html#263108417">(Nov 30 2021 at 07:17)</a>:</h4>
<p>For extern crates only the MIR after optimizations is stored. If you want MIR without optimizations you will have to disable optimizations when compiling it.</p>



<a name="263108485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Obtain%20External%20Mir/near/263108485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Obtain.20External.20Mir.html#263108485">(Nov 30 2021 at 07:18)</a>:</h4>
<p>For local crates something similar applies because the mir_optimized query steals the generated MIR making it inaccessible from other places.</p>



<a name="263108513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Obtain%20External%20Mir/near/263108513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jerry Liu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Obtain.20External.20Mir.html#263108513">(Nov 30 2021 at 07:19)</a>:</h4>
<p>If we disable all mir optimization, I can directly load the <code>mir</code> without optimization from metadata?</p>



<a name="263108719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Obtain%20External%20Mir/near/263108719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jerry Liu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Obtain.20External.20Mir.html#263108719">(Nov 30 2021 at 07:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Obtain.20External.20Mir/near/263108417">said</a>:</p>
<blockquote>
<p>For extern crates only the MIR after optimizations is stored. If you want MIR without optimizations you will have to disable optimizations when compiling it.</p>
</blockquote>
<p>If we do compile external without optimization, what API should I use to obtain <code>mir</code> of external crate?</p>



<a name="263120827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Obtain%20External%20Mir/near/263120827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Obtain.20External.20Mir.html#263120827">(Nov 30 2021 at 09:46)</a>:</h4>
<p>Yes to the first question and use <code>optimized_mir</code> for the second question.</p>



<a name="263121127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Obtain%20External%20Mir/near/263121127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Obtain.20External.20Mir.html#263121127">(Nov 30 2021 at 09:49)</a>:</h4>
<p><code>optimized_mir</code> runs optimizations if enabled, but also a couple of required transformations like lowering generators to state machines (for async functions), drop elaboration (so the drop terminator doesn't run when a value is already moved out) and const propagation (required to report certain errors).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>