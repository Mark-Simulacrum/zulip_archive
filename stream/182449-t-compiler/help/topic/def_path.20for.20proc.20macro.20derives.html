<html>
<head><meta charset="utf-8"><title>def_path for proc macro derives · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html">def_path for proc macro derives</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253963418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/253963418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#253963418">(Sep 19 2021 at 18:41)</a>:</h4>
<p>Is there an equivalent to <code>tcx.def_path()</code> that will account for <code>#[proc_macro_derive(SomeDerive)]</code> renamings?</p>



<a name="253980251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/253980251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#253980251">(Sep 19 2021 at 23:41)</a>:</h4>
<p>E.g., if the program is this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// crate foo</span>
<span class="cp">#[proc_macro_derive(SomeDerive)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">some_derive</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>Then <code>def_path()</code> returns something like <code>foo::some_derive</code>, whereas I want to get <code>foo::SomeDerive</code>. I assume there's some way to do at least part of this, because the compiler needs to resolve <code>#[derive(SomeDerive)]</code> to <code>foo::some_derive</code>, but it would be nice to have a solution that can give me the full path.</p>



<a name="253980263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/253980263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#253980263">(Sep 19 2021 at 23:42)</a>:</h4>
<p>For context, I'd like to use this in rustdoc as part of a cleanup.</p>



<a name="254023775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254023775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254023775">(Sep 20 2021 at 09:52)</a>:</h4>
<p>IIRC, proc macros don't create separate <code>DefId</code>s and reuse <code>DefId</code>s (and therefore def paths) or their functions.</p>



<a name="254024385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254024385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254024385">(Sep 20 2021 at 09:56)</a>:</h4>
<p>So <code>SomeDerive</code> needs to be obtained in some other way.<br>
For cross-crate scenarios it's just encoded into metadata separately, see <code>CrateMetadata::raw_proc_macros</code>.</p>



<a name="254072160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254072160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254072160">(Sep 20 2021 at 15:51)</a>:</h4>
<p>Hmm, I was hoping to find an existing compiler API and not have rustdoc roll its own. So I guess the best bet would be to look at the HIR attributes for the function if the current crate is a proc macro crate, and look at that metadata field if it's a cross-crate scenario?</p>



<a name="254072477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254072477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254072477">(Sep 20 2021 at 15:53)</a>:</h4>
<p>Actually, it looks like there's a <code>TyCtxt::item_attrs</code> function that works cross-crate. Could I use that for both intra-crate and cross-crate situations to avoid having two code paths in rustdoc?</p>



<a name="254084694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254084694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254084694">(Sep 20 2021 at 17:14)</a>:</h4>
<p>Does this code look reasonable?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// If `def_id` is a proc macro derive, return its name.</span>
<span class="sd">/// Otherwise, return `None`.</span>
<span class="k">fn</span> <span class="nf">proc_macro_derive_name</span><span class="p">(</span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">def_id</span>: <span class="nc">DefId</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Symbol</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">item_attrs</span><span class="p">(</span><span class="n">def_id</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">attrs</span><span class="p">.</span><span class="n">lists</span><span class="p">(</span><span class="n">sym</span>::<span class="n">proc_macro_derive</span><span class="p">).</span><span class="n">find_map</span><span class="p">(</span><span class="o">|</span><span class="n">mi</span><span class="o">|</span><span class="w"> </span><span class="n">mi</span><span class="p">.</span><span class="n">ident</span><span class="p">()).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">ident</span><span class="o">|</span><span class="w"> </span><span class="n">ident</span><span class="p">.</span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>(Note that <code>lists()</code> is defined in <code>rustdoc::clean::types::AttributesExt</code>.)</p>



<a name="254084768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254084768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254084768">(Sep 20 2021 at 17:15)</a>:</h4>
<p>The <code>attrs.lists(...)...</code> part is from another part of rustdoc that determines names of proc macros.</p>



<a name="254085514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254085514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254085514">(Sep 20 2021 at 17:20)</a>:</h4>
<p>Looks reasonable, this is very similar to what resolve does for local proc macros:<br>
<a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_resolve/src/build_reduced_graph.rs#L1204-L1218">https://github.com/rust-lang/rust/blob/master/compiler/rustc_resolve/src/build_reduced_graph.rs#L1204-L1218</a></p>



<a name="254085797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254085797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254085797">(Sep 20 2021 at 17:22)</a>:</h4>
<p>Hmm, actually it's ICEing:</p>
<div class="codehilite"><pre><span></span><code>error: internal compiler error: compiler/rustc_middle/src/ty/query.rs:263:1: `tcx.item_attrs(DefId(0:0 ~ foo[cf51]))` unsupported by its crate; perhaps the `item_attrs` query was never assigned a provider function
</code></pre></div>



<a name="254085978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254085978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254085978">(Sep 20 2021 at 17:23)</a>:</h4>
<p>The query stack looks weird too:</p>
<div class="codehilite"><pre><span></span><code>query stack during panic:
#0 [item_attrs] collecting attributes of ``
end of query stack
error: aborting due to previous error
</code></pre></div>



<a name="254086027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086027">(Sep 20 2021 at 17:23)</a>:</h4>
<p>Do you have any idea why this is happening? I know rustdoc messes with query providers somewhat, so could that be it?</p>



<a name="254086093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086093">(Sep 20 2021 at 17:24)</a>:</h4>
<p><code>tcx.item_attrs()</code> probably doesn't work for proc-macro external crates.</p>



<a name="254086099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086099">(Sep 20 2021 at 17:24)</a>:</h4>
<p>Actually I don't think rustdoc messes with this one.</p>



<a name="254086121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086121">(Sep 20 2021 at 17:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/def_path.20for.20proc.20macro.20derives/near/254086093">said</a>:</p>
<blockquote>
<p><code>tcx.item_attrs()</code> probably doesn't work for proc-macro external crates.</p>
</blockquote>
<p>Huh, why not?</p>



<a name="254086165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086165">(Sep 20 2021 at 17:24)</a>:</h4>
<p>Encoding the crate metadata of proc-macros skips a lot of unnecessary information to reduce their size.</p>



<a name="254086224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086224">(Sep 20 2021 at 17:25)</a>:</h4>
<p>Ah, okay. I guess I'll have to fallback to using metadata. What check should I do to see if a <code>def_id</code> belongs to an external proc-macro crate?</p>



<a name="254086293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086293">(Sep 20 2021 at 17:25)</a>:</h4>
<p>Actually, how do I access metadata from the <code>tcx</code>?</p>



<a name="254086442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086442">(Sep 20 2021 at 17:26)</a>:</h4>
<p>Ah, it looks like <code>CStore::from_tcx</code> is what I want.</p>



<a name="254086470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086470">(Sep 20 2021 at 17:26)</a>:</h4>
<p>The <code>raw_proc_macros</code> field is private. The <code>CrateMetadataRef::raw_proc_macro()</code> function is too.</p>



<a name="254086691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086691">(Sep 20 2021 at 17:28)</a>:</h4>
<p>It looks like there's another part of rustdoc that has this code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="fm">matches!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">CStore</span>::<span class="n">from_tcx</span><span class="p">(</span><span class="n">cx</span><span class="p">.</span><span class="n">tcx</span><span class="p">).</span><span class="n">load_macro_untracked</span><span class="p">(</span><span class="n">did</span><span class="p">,</span><span class="w"> </span><span class="n">cx</span><span class="p">.</span><span class="n">sess</span><span class="p">()),</span><span class="w"></span>
<span class="w">            </span><span class="n">LoadedMacro</span>::<span class="n">MacroDef</span><span class="p">(</span><span class="n">def</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="fm">matches!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">def</span><span class="p">.</span><span class="n">kind</span><span class="p">,</span><span class="w"> </span><span class="n">ast</span>::<span class="n">ItemKind</span>::<span class="n">MacroDef</span><span class="p">(</span><span class="n">ast_def</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">ast_def</span><span class="p">.</span><span class="n">macro_rules</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>Does using <code>load_macro_untracked</code> seem reasonable?</p>



<a name="254086792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086792">(Sep 20 2021 at 17:29)</a>:</h4>
<p>Or actually I probably want <code>load_proc_macro</code>.</p>



<a name="254086828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086828">(Sep 20 2021 at 17:29)</a>:</h4>
<p>Yeah, I think so.</p>



<a name="254086838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086838">(Sep 20 2021 at 17:29)</a>:</h4>
<p>Never mind, <code>load_proc_macro</code>'s private too <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="254086881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086881">(Sep 20 2021 at 17:29)</a>:</h4>
<p>But <code>load_macro_untracked</code> is public. However, that doesn't return an <code>Option</code>, so will that panic if there's no macro?</p>



<a name="254086999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254086999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254086999">(Sep 20 2021 at 17:30)</a>:</h4>
<p>Yes, it seems so.</p>



<a name="254087028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254087028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254087028">(Sep 20 2021 at 17:30)</a>:</h4>
<p>Hmm. So could I use <code>tcx.def_kind</code> to check first or will that not work for proc-macro extern crates?</p>



<a name="254087057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254087057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254087057">(Sep 20 2021 at 17:31)</a>:</h4>
<p>I think that will work.</p>



<a name="254087104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254087104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254087104">(Sep 20 2021 at 17:31)</a>:</h4>
<p>And possibly also check if the crate is a proc macro first.</p>



<a name="254087173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254087173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254087173">(Sep 20 2021 at 17:31)</a>:</h4>
<p>How do I do that check?</p>



<a name="254087486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254087486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254087486">(Sep 20 2021 at 17:33)</a>:</h4>
<p>There is an <code>is_proc_macro_crate</code> method on <code>CrateMetadata</code>, but it is private.</p>



<a name="254087560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254087560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254087560">(Sep 20 2021 at 17:34)</a>:</h4>
<p>Looks like you don't need to check if it is a proc-macro for as long as you check the def is a macro of any kind.</p>



<a name="254087708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254087708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254087708">(Sep 20 2021 at 17:35)</a>:</h4>
<p>Also, it looks like I may be able to just check if <code>tcx.def_kind(did)</code> is <code>DefKind::Macro(MacroKind::Derive)</code>.</p>



<a name="254087724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254087724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254087724">(Sep 20 2021 at 17:35)</a>:</h4>
<p>Thank you for your help!</p>



<a name="254088947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/254088947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#254088947">(Sep 20 2021 at 17:43)</a>:</h4>
<p>Hmm, how do I get the name of a proc macro from its <code>rustc_expand::base::SyntaxExtension</code>? The only field that looks like a name is <code>builtin_name</code>, and it seems that's only for <code>rustc_builtin_macro</code>s.</p>



<a name="261810414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/261810414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#261810414">(Nov 17 2021 at 16:36)</a>:</h4>
<p>Bumping this. Does anyone know how to get the name of a proc macro from its SyntaxExtension?</p>



<a name="261824339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/261824339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#261824339">(Nov 17 2021 at 18:08)</a>:</h4>
<p>I don't think you can.</p>



<a name="261989400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/def_path%20for%20proc%20macro%20derives/near/261989400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/def_path.20for.20proc.20macro.20derives.html#261989400">(Nov 18 2021 at 20:56)</a>:</h4>
<p>Hmm, I guess I'll have to delay this cleanup for now until I come up with a way to do it.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>