<html>
<head><meta charset="utf-8"><title>function declaration lookup · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/function.20declaration.20lookup.html">function declaration lookup</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266642316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/function%20declaration%20lookup/near/266642316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Manuel Drehwald <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/function.20declaration.20lookup.html#266642316">(Jan 03 2022 at 00:53)</a>:</h4>
<p>For some experimenting, I would like to test if I can create a <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_builtin_macros">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_builtin_macros</a> which is able to look up the declaration of a function passed to it. I'm not talking about having any kind of type analysis, the replacement should be completely done on a "string"-level. Say we have </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span> <span class="nn">foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span>: <span class="kt">f64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">f64</span> <span class="p">{</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">mod</span> <span class="nn">bar</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="n">magic</span><span class="o">!</span><span class="p">(</span><span class="k">super</span>::<span class="n">foo</span>::<span class="n">f</span><span class="p">)</span><span class="w"></span>
<span class="c1">// expands to</span>
<span class="c1">// magic!("f(x: f64) -&gt; f64")</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Macro expansion is done before type analysis, so I guess I can't just add a querry for it. But some builtin macros already have the capability to expand their inner macros. <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=1618816971f9324fe2cbedb6024324a3">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=1618816971f9324fe2cbedb6024324a3</a><br>
Is there any specific blocker, or can I just go and try to understand / adjust <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_builtin_macros/concat.rs.html#8-65">https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_builtin_macros/concat.rs.html#8-65</a>?<br>
Also, I'm not saying in any way that we should really give users this feature, it's just an interesting question for me and a way to learn about how rustc works.</p>



<a name="266655104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/function%20declaration%20lookup/near/266655104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/function.20declaration.20lookup.html#266655104">(Jan 03 2022 at 06:28)</a>:</h4>
<p><span class="user-mention" data-user-id="348574">@Manuel Drehwald</span> </p>
<p>Disclaimer: I'm a novice rustc contributor.</p>
<blockquote>
<p>I'm not talking about having any kind of type analysis, the replacement should be completely done on a "string"-level</p>
</blockquote>
<p>I don't see how this is possible without querying the type system. At macro expansion time, all you have is the AST tokens and no information about the function signature of <code>f</code>.</p>
<p>The documentation on rustc_builtin_macros says that they inject code before lowering to HIR. And type information doesn't really exist until you get to the HIR.</p>
<p>To my knowledge, the closest existing thing to what you want to do is the <code>core::intrinsics::type_name</code> intrinsic (perhaps more commonly known by <code>std::any::type_name</code>): <a href="https://doc.rust-lang.org/std/any/fn.type_name.html">https://doc.rust-lang.org/std/any/fn.type_name.html</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>