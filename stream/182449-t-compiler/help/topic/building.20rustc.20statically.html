<html>
<head><meta charset="utf-8"><title>building rustc statically · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html">building rustc statically</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263608384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263608384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263608384">(Dec 03 2021 at 17:05)</a>:</h4>
<p>So, after sorting out the "cross-compilation" part (see:  <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo">https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo</a>), I'd like to build rustc and cargo statically.</p>
<p>I was suggested to use 'cargo expand' to manually do what the uses of <code>proc-macros</code> would do, since <code>proc-macros</code> crates rely on being dynamically linked.  But that's a 3rd party package that would need to pull more into my bootstrapping environment; I'd like to get away with just what I have in the rust (1.54) sources.  I see that <code>cargo-expand</code> is a wrapper around <code>cargo rustc --profile=check -- -Zunpretty=expanded</code>, which probably operates on a crate rather than a file the way <code>rustc</code> alone would, correct?</p>



<a name="263609141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263609141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263609141">(Dec 03 2021 at 17:10)</a>:</h4>
<p>Rustc always operates on crates. Some crates happen to be only a single file.</p>



<a name="263609227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263609227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263609227">(Dec 03 2021 at 17:11)</a>:</h4>
<p>Using cargo-expand is ... kinda hacky. It <em>might</em> work but I wouldn't plan on it</p>



<a name="263609432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263609432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263609432">(Dec 03 2021 at 17:12)</a>:</h4>
<p>I don't understand why the process of expanding macros causes information to be lost;  why can't macros be expanded the same way they would if compiled with the proc-macros crates?</p>



<a name="263609502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263609502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263609502">(Dec 03 2021 at 17:13)</a>:</h4>
<p>Because of macro hygiene. Macros can create new identifiers with the same name as variables already in scope.</p>



<a name="263609635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263609635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263609635">(Dec 03 2021 at 17:14)</a>:</h4>
<p>When rustc compiles the crate, it associates a Span / ExpnData metadata with the variable that lets it know whether to use the new or existing variable when it sees that name, but there's no way to add that metadata in rust source code directly.</p>



<a name="263609677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263609677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263609677">(Dec 03 2021 at 17:14)</a>:</h4>
<p>See <code>-Zunpretty=hir,identified</code> for an example (I think that's the flag name)</p>



<a name="263609822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263609822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263609822">(Dec 03 2021 at 17:15)</a>:</h4>
<p>Also <code>unpretty</code> is only meant to be used for debugging, it doesn't have any guarantees of being accurate</p>



<a name="263612839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263612839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263612839">(Dec 03 2021 at 17:39)</a>:</h4>
<p>OK; that's a limitation of the macro system as implemented in Rust, right?  I'm told Scheme (at least through its Guile implementation), expand macros into tree-il, and tree-il can be decompiled back into source code safely, with the only information lost being that macros are not unexpanded and variable names may be altered.</p>



<a name="263613041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263613041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263613041">(Dec 03 2021 at 17:41)</a>:</h4>
<p>I'm not sure. Maybe in theory rustc could make sure to rename variables created by macros but I'm not familiar enough with expansion to know if that's sufficient.</p>



<a name="263613091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263613091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263613091">(Dec 03 2021 at 17:41)</a>:</h4>
<p>I thought that's what hygiene meant (that variables were safely renamed by the compiler to avoid any clashes)</p>



<a name="263613399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263613399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263613399">(Dec 03 2021 at 17:44)</a>:</h4>
<p>but I guess there are many ways to implement hygiene, and that the one pursued in rust (via added metadata) has this problematic aspect of not being decompilable back into source form</p>



<a name="263614615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263614615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263614615">(Dec 03 2021 at 17:53)</a>:</h4>
<p>is there an opened issue about this limitation (proc-macros requiring dynamic linking) basically making the <code>crt-static = true</code> build option useless? :-)</p>



<a name="263659874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263659874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263659874">(Dec 03 2021 at 22:09)</a>:</h4>
<p>I mean, it doesn't make it useless in general, it just makes it useless for building <strong>the compiler</strong>.</p>



<a name="263659947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263659947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263659947">(Dec 03 2021 at 22:10)</a>:</h4>
<p>The "intended use" of it is user code, basically.</p>



<a name="263665552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263665552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263665552">(Dec 03 2021 at 23:12)</a>:</h4>
<p>What the reason for a statically linked rustc? Does the targeted platform not support dynamic loading?</p>



<a name="263665977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263665977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263665977">(Dec 03 2021 at 23:16)</a>:</h4>
<p>If that's the case probably the easiest way is to run proc macros on a separate process.</p>



<a name="263676211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263676211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263676211">(Dec 04 2021 at 02:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/building.20rustc.20statically/near/263665552">said</a>:</p>
<blockquote>
<p>What the reason for a statically linked rustc? Does the targeted platform not support dynamic loading?</p>
</blockquote>
<p>Basically the goal is to have Rust bootstrap binaries that would be offered a tarballs via <a href="http://ftp.gnu.org">ftp.gnu.org</a> and used in GNU Guix to cleanly bootstrap Rust on non-x86_64 architectures; statically linked binaries would be most suitable for this purpose, being self-contained and portable.  These bootstrap binaries, unlike the official ones, would be derived via a mrustc bootstrap on x86_64, then cross-compiled from x86_64 to other architectures.  Rust as packaged in Guix on x86_64 is already reproducible, so it is expected that these bootstrap binaries could be challenged by their users.</p>



<a name="263676383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263676383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263676383">(Dec 04 2021 at 02:11)</a>:</h4>
<p>So far what I have is rust 1.54 on x86_64 (with the bootstrap chain starting from from 1.40 using mrustc); I was also able to cross-build <a href="mailto:rust@1.54">rust@1.54</a> from x86_64 to i686, so far dynamically linked.</p>



<a name="263702753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263702753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263702753">(Dec 04 2021 at 12:15)</a>:</h4>
<p>can't you bundle the dynamic libraries needed and use chroot/container/ld_library_path if static linking causes too many problems?</p>



<a name="263709358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263709358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263709358">(Dec 04 2021 at 13:56)</a>:</h4>
<p>The following dylibs are needed by rustc (excluding those already shipped with rustc):</p>
<div class="codehilite"><pre><span></span><code>        linux-vdso.so.1 (0x00007fff297e6000)
        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f7125afc000)
        librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007f7125af1000)
        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f7125aeb000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f7125926000)
        libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f712083d000)
        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f71206f9000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f7129def000)
        libz.so.1 =&gt; /lib/x86_64-linux-gnu/libz.so.1 (0x00007f71206dc000)
</code></pre></div>
<p>I believe of these dylibs only <code>libc</code>, <code>ld-linux.so</code>, <code>libgcc_s</code> and<code>libz</code> are necessary due to the recent glibc library unification. If you want a smaller bundle you could use a dynamically linked musl. This requires a small change to rustc to enable dynamic linking for musl I believe, though <code>crt-static=false</code> may be enough.</p>



<a name="263709455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263709455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263709455">(Dec 04 2021 at 13:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/building.20rustc.20statically/near/263702753">said</a>:</p>
<blockquote>
<p>can't you bundle the dynamic libraries needed and use chroot/container/ld_library_path if static linking causes too many problems?</p>
</blockquote>
<p><code>LD_LIBRARY_PATH</code> won't be enough as the dynamic linker needs to be replaced too. This requires modifying the executable using patchelf, or prefixing all rustc invocations with the dynamic linker executable (<code>/path/to/ld-linux-x86_64.so.2 /path/to/rustc</code>).</p>



<a name="263710361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263710361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263710361">(Dec 04 2021 at 14:17)</a>:</h4>
<p>Toss in RUSTC_WRAPPER to do that?</p>



<a name="263750089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263750089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263750089">(Dec 05 2021 at 05:05)</a>:</h4>
<p>Currently the runtime references used by the cross-linked rust package (which includes rustc and cargo) look like this:<br>
<a href="/user_uploads/4715/JEdpBaCUOJTqqT9AmVUYYckJ/noname.gv.svg">noname.gv.svg</a></p>



<a name="263807311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263807311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263807311">(Dec 06 2021 at 04:17)</a>:</h4>
<p>is there a way with config.toml to specify <code>--libdir</code> for the <code>llvm-config</code>  commands used?   My static LLVM library archives are not installed to the same prefix as llvm-config and are not found.</p>



<a name="263807498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263807498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263807498">(Dec 06 2021 at 04:22)</a>:</h4>
<p>Hmm, there's this: <code>LLVM_SYS_&lt;version&gt;_PREFIX</code>, but as with other non-target prefixed environment variables, it won't be of much help in a cross-compilation setting.</p>



<a name="263808519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263808519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263808519">(Dec 06 2021 at 04:48)</a>:</h4>
<p>/me works around it with <code>build-union</code>, a guix procedure that symlinks directories into one to fake a single prefix.</p>



<a name="263854957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263854957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263854957">(Dec 06 2021 at 14:12)</a>:</h4>
<p>I'm attempting to statically link the libraries (keeping <code>crt-static = false</code> for now) as a first step. Currently this yields:</p>
<div class="codehilite"><pre><span></span><code>error: linking with `/gnu/store/m33dzmxnxvhmas1dggj3gr5rfwpl3h6c-gcc-cross-i686-linux-gnu-10.3.0/bin/i686-linux-gnu-gcc` failed: exit status: 1
  |
  = note: &quot;/gnu/store/m33dzmxnxvhmas1dggj3gr5rfwpl3h6c-gcc-cross-i686-linux-gnu-10.3.0/bin/i686-linux-gnu-gcc&quot; &quot;-m32&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/rustc_main-94e0d615a8fdc8e1.rustc_main.9rakka3r-cgu.0.rcgu.o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/rustc_main-94e0d615a8fdc8e1.rustc_main.9rakka3r-cgu.1.rcgu.o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/rustc_main-94e0d615a8fdc8e1.rustc_main.9rakka3r-cgu.2.rcgu.o&quot; &quot;-Wl,--as-needed&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/release/deps&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/build/psm-548840bfe0ab3bcc/out&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/build/rustc_llvm-5239a49fc6d31bf1/out&quot; &quot;-L&quot; &quot;/gnu/store/dq2xi1al59k800c63pxd4f1qzgxrd2rh-llvm-next-12.0.1/lib&quot; &quot;-L&quot; &quot;/gnu/store/x5y2ngh1asiv3dkcbzaga9ml56xcm3ps-gcc-cross-i686-linux-gnu-10.3.0-lib/lib/gcc/i686-linux-gnu/10.3.0/../../../../i686-linux-gnu/lib&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/i686-unknown-linux-gnu/lib&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps&quot; &quot;-lrustc_driver-b96e39972e920021&quot; &quot;-Wl,--start-group&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/i686-unknown-linux-gnu/lib&quot; &quot;-lstd-9c917f45e5ac8791&quot; &quot;-Wl,--end-group&quot; &quot;-Wl,-Bstatic&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/i686-unknown-linux-gnu/lib/libcompiler_builtins-865f6241f33083a5.rlib&quot; &quot;-Wl,-Bdynamic&quot; &quot;-lgcc_s&quot; &quot;-lutil&quot; &quot;-lrt&quot; &quot;-lpthread&quot; &quot;-lm&quot; &quot;-ldl&quot; &quot;-lc&quot; &quot;-Wl,--eh-frame-hdr&quot; &quot;-Wl,-znoexecstack&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/i686-unknown-linux-gnu/lib&quot; &quot;-o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/rustc_main-94e0d615a8fdc8e1&quot; &quot;-Wl,--gc-sections&quot; &quot;-pie&quot; &quot;-Wl,-zrelro&quot; &quot;-Wl,-znow&quot; &quot;-Wl,-O1&quot; &quot;-nodefaultlibs&quot; &quot;-Wl,-rpath,$ORIGIN/../lib&quot;
  = note: i686-linux-gnu-ld: /tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/librustc_driver-b96e39972e920021.so: undefined reference to `uncompress&#39;
          i686-linux-gnu-ld: /tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/librustc_driver-b96e39972e920021.so: undefined reference to `compress2&#39;
          i686-linux-gnu-ld: /tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/librustc_driver-b96e39972e920021.so: undefined reference to `crc32&#39;
          i686-linux-gnu-ld: /tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/librustc_driver-b96e39972e920021.so: undefined reference to `compressBound&#39;
          collect2: error: ld returned 1 exit status


error: aborting due to previous error

error: could not compile `rustc-main`

To learn more, run the command again with --verbose.
command did not execute successfully: &quot;/gnu/store/2gi4xhwh70kgycpdq467c7z65iwx3v44-rust-1.54.0-cargo/bin/cargo&quot; &quot;build&quot; &quot;--target&quot; &quot;i686-unknown-linux-gnu&quot; &quot;-Zdual-proc-macros&quot; &quot;-Zbinary-dep-depinfo&quot; &quot;-j&quot; &quot;24&quot; &quot;--release&quot; &quot;--frozen&quot; &quot;--features&quot; &quot; llvm max_level_info&quot; &quot;--manifest-path&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/compiler/rustc/Cargo.toml&quot; &quot;--message-format&quot; &quot;json-render-diagnostics&quot;
expected success, got: exit status: 101
failed to run: /tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/bootstrap/debug/bootstrap -j24 build compiler/rustc library/std src/tools/cargo
Build completed unsuccessfully in 0:07:11
error: in phase &#39;build&#39;: uncaught exception:
%exception #&lt;&amp;invoke-error program: &quot;./x.py&quot; arguments: (&quot;-j24&quot; &quot;build&quot; &quot;compiler/rustc&quot; &quot;library/std&quot; &quot;src/tools/cargo&quot;) exit-status: 1 term-signal: #f stop-signal: #f&gt;
phase `build&#39; failed after 431.2 seconds
command &quot;./x.py&quot; &quot;-j24&quot; &quot;build&quot; &quot;compiler/rustc&quot; &quot;library/std&quot; &quot;src/tools/cargo&quot; failed with status 1
note: keeping build directory `/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0&#39;
</code></pre></div>



<a name="263855099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263855099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263855099">(Dec 06 2021 at 14:13)</a>:</h4>
<p>I'm guessing my environment is lacking static libraries for zlib</p>



<a name="263855428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263855428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263855428">(Dec 06 2021 at 14:16)</a>:</h4>
<p>I would guess so too.</p>



<a name="263861470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263861470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263861470">(Dec 06 2021 at 14:58)</a>:</h4>
<p>next it failed with:</p>
<div class="codehilite"><pre><span></span><code>   Compiling rustc_driver v0.0.0 (/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/compiler/rustc_driver)
error: linking with `/gnu/store/vakvgvrb839igv16jkif4lmx11d25jqb-gcc-10.3.0/bin/gcc` failed: exit status: 1
  |
  = note: &quot;/gnu/store/vakvgvrb839igv16jkif4lmx11d25jqb-gcc-10.3.0/bin/gcc&quot; &quot;-Wl,--version-script=/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustcEVt93R/list&quot; &quot;-m64&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/rustc_driver-27dcccb7229d2393.rustc_driver.8tdqwjgq-cgu.0.rcgu.o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/rustc_driver-27dcccb7229d2393.rustc_driver.8tdqwjgq-cgu.1.rcgu.o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/rustc_driver-27dcccb7229d2393.rustc_driver.8tdqwjgq-cgu.10.rcgu.o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/rustc_driver-27dcccb7229d2393.rustc_driver.8tdqwjgq-cgu.11.rcgu.o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/rustc_driver-27dcccb7229d2393.rustc_driver.8tdqwjgq-cgu.12.rcgu.o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/rustc_driver-27dcccb7229d2393.rustc_driver.8tdqwjgq-cgu.13.rcgu.o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/rustc_driver-27dcccb7229d2393.rustc_driver.8tdqwjgq-[...] &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/liblazy_static-920701e8f2cab7fc.rlib&quot; &quot;-Wl,--no-whole-archive&quot; &quot;-Wl,--whole-archive&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/libcfg_if-4e06639ef271cb6a.rlib&quot; &quot;-Wl,--no-whole-archive&quot; &quot;-Wl,--start-group&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib&quot; &quot;-Wl,-Bdynamic&quot; &quot;-lstd-1231cd54f3e303c3&quot; &quot;-Wl,--end-group&quot; &quot;-Wl,-Bstatic&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-97a486fe07f79757.rlib&quot; &quot;-Wl,-Bdynamic&quot; &quot;-lrt&quot; &quot;-ldl&quot; &quot;-lpthread&quot; &quot;-lm&quot; &quot;-lz&quot; &quot;-lgcc_s&quot; &quot;-lutil&quot; &quot;-lrt&quot; &quot;-lpthread&quot; &quot;-lm&quot; &quot;-ldl&quot; &quot;-lc&quot; &quot;-Wl,--eh-frame-hdr&quot; &quot;-Wl,-znoexecstack&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib&quot; &quot;-o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_driver-27dcccb7229d2393.so&quot; &quot;-shared&quot; &quot;-Wl,-zrelro&quot; &quot;-Wl,-znow&quot; &quot;-Wl,-O1&quot; &quot;-nodefaultlibs&quot; &quot;-Wl,-rpath,$ORIGIN/../lib&quot;
  = note: ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(crc32.o): relocation R_X86_64_32S against `.rodata&#39; can not be used when making a shared object; recompile with -fPIC
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(compress.o): relocation R_X86_64_32 against `.rodata.str1.1&#39; can not be used when making a shared object; recompile with -fPIC
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(uncompr.o): relocation R_X86_64_32 against `.rodata.str1.1&#39; can not be used when making a shared object; recompile with -fPIC
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(deflate.o): relocation R_X86_64_32S against hidden symbol `_length_code&#39; can not be used when making a shared object
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(inflate.o): relocation R_X86_64_32S against hidden symbol `zcfree&#39; can not be used when making a shared object
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(inftrees.o): relocation R_X86_64_32S against `.rodata&#39; can not be used when making a shared object; recompile with -fPIC
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(trees.o): relocation R_X86_64_32S against hidden symbol `_length_code&#39; can not be used when making a shared object
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(zutil.o): relocation R_X86_64_32 against `.rodata.str1.1&#39; can not be used when making a shared object; recompile with -fPIC
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(inffast.o): relocation R_X86_64_32S against `.rodata.str1.1&#39; can not be used when making a shared object; recompile with -fPIC
          collect2: error: ld returned 1 exit status


error: aborting due to previous error

error: could not compile `rustc_driver`

To learn more, run the command again with --verbose.
command did not execute successfully: &quot;/gnu/store/2gi4xhwh70kgycpdq467c7z65iwx3v44-rust-1.54.0-cargo/bin/cargo&quot; &quot;build&quot; &quot;--target&quot; &quot;x86_64-unknown-linux-gnu&quot; &quot;-Zbinary-dep-depinfo&quot; &quot;-j&quot; &quot;24&quot; &quot;--release&quot; &quot;--frozen&quot; &quot;--features&quot; &quot; llvm max_level_info&quot; &quot;--manifest-path&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/compiler/rustc/Cargo.toml&quot; &quot;--message-format&quot; &quot;json-render-diagnostics&quot;
</code></pre></div>
<p>I guess <code>rustc_driver</code> is part of what requires to be dynamically linked for the proc-macros?</p>



<a name="263862655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263862655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263862655">(Dec 06 2021 at 15:06)</a>:</h4>
<p>Not for proc-macros, but for <code>rustc_private</code></p>



<a name="263862717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263862717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263862717">(Dec 06 2021 at 15:06)</a>:</h4>
<p>Which is how clippy/Miri/rustdoc work, they load the dynamic libraries from the sysroot</p>



<a name="263865175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263865175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263865175">(Dec 06 2021 at 15:21)</a>:</h4>
<p>is this support optional, and if so, how can I disable it?</p>



<a name="263865436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263865436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263865436">(Dec 06 2021 at 15:23)</a>:</h4>
<p>You can remove <code>crate-type = ["dylib"]</code> from <code>compiler/rustc_middle/Cargo.toml</code>.</p>



<a name="263866256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263866256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263866256">(Dec 06 2021 at 15:27)</a>:</h4>
<p>Well, you <em>can</em> do that, but then all the tools will be broken</p>



<a name="263866480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263866480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263866480">(Dec 06 2021 at 15:28)</a>:</h4>
<p>I'm only interested in <code>rustc</code> and <code>cargo</code></p>



<a name="263867846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263867846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263867846">(Dec 06 2021 at 15:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/building.20rustc.20statically/near/263865436">said</a>:</p>
<blockquote>
<p>You can remove <code>crate-type = ["dylib"]</code> from <code>compiler/rustc_middle/Cargo.toml</code>.</p>
</blockquote>
<p>Did you mean in <code>compiler/rustc_driver/Cargo.toml</code> ?  I don't have a "dylib" entry in <code>compiler/rustc_middle/Cargo.toml</code> (rust 1.54).</p>



<a name="263868150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263868150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263868150">(Dec 06 2021 at 15:39)</a>:</h4>
<p>Right</p>



<a name="263870192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263870192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263870192">(Dec 06 2021 at 15:53)</a>:</h4>
<p>OK, thanks.  This time it proceeded to:</p>
<div class="codehilite"><pre><span></span><code>src/build/x86_64-unknown-linux-gnu/stage0-sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib&quot; &quot;-o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/rustc_main-ac9fac4304f0fa6e&quot; &quot;-Wl,--gc-sections&quot; &quot;-pie&quot; &quot;-Wl,-zrelro&quot; &quot;-Wl,-znow&quot; &quot;-Wl,-O1&quot; &quot;-nodefaultlibs&quot; &quot;-Wl,-rpath,$ORIGIN/../lib&quot;
  = note: ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(crc32.o): relocation R_X86_64_32S against `.rodata&#39; can not be used when making a PIE object; recompile with -fPIE
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(compress.o): relocation R_X86_64_32 against `.rodata.str1.1&#39; can not be used when making a PIE object; recompile with -fPIE
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(uncompr.o): relocation R_X86_64_32 against `.rodata.str1.1&#39; can not be used when making a PIE object; recompile with -fPIE
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(deflate.o): relocation R_X86_64_32S against hidden symbol `_length_code&#39; can not be used when making a PIE object
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(inflate.o): relocation R_X86_64_32S against hidden symbol `zcfree&#39; can not be used when making a PIE object
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(inftrees.o): relocation R_X86_64_32S against `.rodata&#39; can not be used when making a PIE object; recompile with -fPIE
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(trees.o): relocation R_X86_64_32S against hidden symbol `_length_code&#39; can not be used when making a PIE object
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(zutil.o): relocation R_X86_64_32 against `.rodata.str1.1&#39; can not be used when making a PIE object; recompile with -fPIE
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(inffast.o): relocation R_X86_64_32S against `.rodata.str1.1&#39; can not be used when making a PIE object; recompile with -fPIE
          collect2: error: ld returned 1 exit status


error: aborting due to previous error

error: could not compile `rustc-main`

To learn more, run the command again with --verbose.
command did not execute successfully: &quot;/gnu/store/2gi4xhwh70kgycpdq467c7z65iwx3v44-rust-1.54.0-cargo/bin/cargo&quot; &quot;build&quot; &quot;--target&quot; &quot;x86_64-unknown-linux-gnu&quot; &quot;-Zbinary-dep-depinfo&quot; &quot;-j&quot; &quot;24&quot; &quot;--release&quot; &quot;--frozen&quot; &quot;--features&quot; &quot; llvm max_level_info&quot; &quot;--manifest-path&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/compiler/rustc/Cargo.toml&quot; &quot;--message-format&quot; &quot;json-render-diagnostics&quot;
expected success, got: exit status: 101
failed to run: /tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/bootstrap/debug/bootstrap -j24 build compiler/rustc library/std src/tools/cargo
</code></pre></div>
<p>Is this workable similarly?</p>



<a name="263871012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263871012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263871012">(Dec 06 2021 at 15:58)</a>:</h4>
<p>You could either recompile libz with <code>-fPIE</code> or pass <code>-Crelocation-model=static</code> to rustc to prevent it from trying to link a PIE executable.</p>



<a name="263880670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263880670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263880670">(Dec 06 2021 at 16:58)</a>:</h4>
<p>Can codegen options be provided from the <code>config.toml</code> file? what's the correct way to otherwise have them honored by Rust's build system (<code>x.py</code>) ?</p>



<a name="263883636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263883636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263883636">(Dec 06 2021 at 17:17)</a>:</h4>
<p>RUSTFLAGS_BOOTSTRAP should work</p>



<a name="263883673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263883673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263883673">(Dec 06 2021 at 17:17)</a>:</h4>
<p>(and RUSTFLAGS_NOT_BOOTSTRAP if you need that)</p>



<a name="263886059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263886059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263886059">(Dec 06 2021 at 17:33)</a>:</h4>
<p>OK, thank you</p>



<a name="263889771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263889771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263889771">(Dec 06 2021 at 17:59)</a>:</h4>
<p>Hmm, seems it's not enough:</p>
<div class="codehilite"><pre><span></span><code>ld-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/libcfg_if-4e06639ef271cb6a.rlib&quot; &quot;-Wl,--start-group&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib&quot; &quot;-Wl,-Bdynamic&quot; &quot;-lstd-1231cd54f3e303c3&quot; &quot;-Wl,--end-group&quot; &quot;-Wl,-Bstatic&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib/libcompiler_builtins-97a486fe07f79757.rlib&quot; &quot;-Wl,-Bdynamic&quot; &quot;-lrt&quot; &quot;-ldl&quot; &quot;-lpthread&quot; &quot;-lm&quot; &quot;-lz&quot; &quot;-lgcc_s&quot; &quot;-lutil&quot; &quot;-lrt&quot; &quot;-lpthread&quot; &quot;-lm&quot; &quot;-ldl&quot; &quot;-lc&quot; &quot;-Wl,--eh-frame-hdr&quot; &quot;-Wl,-znoexecstack&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib&quot; &quot;-o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/rustc_main-ac9fac4304f0fa6e&quot; &quot;-Wl,--gc-sections&quot; &quot;-pie&quot; &quot;-Wl,-zrelro&quot; &quot;-Wl,-znow&quot; &quot;-Wl,-O1&quot; &quot;-nodefaultlibs&quot; &quot;-Wl,-rpath,$ORIGIN/../lib&quot;
  = note: ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(crc32.o): relocation R_X86_64_32S against `.rodata&#39; can not be used when making a PIE object; recompile with -fPIE
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(compress.o): relocation R_X86_64_32 against `.rodata.str1.1&#39; can not be used when making a PIE object; recompile with -fPIE
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(uncompr.o): relocation R_X86_64_32 against `.rodata.str1.1&#39; can not be used when making a PIE object; recompile with -fPIE
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(deflate.o): relocation R_X86_64_32S against hidden symbol `_length_code&#39; can not be used when making a PIE object
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(inflate.o): relocation R_X86_64_32S against hidden symbol `zcfree&#39; can not be used when making a PIE object
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(inftrees.o): relocation R_X86_64_32S against `.rodata&#39; can not be used when making a PIE object; recompile with -fPIE
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(trees.o): relocation R_X86_64_32S against hidden symbol `_length_code&#39; can not be used when making a PIE object
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(zutil.o): relocation R_X86_64_32 against `.rodata.str1.1&#39; can not be used when making a PIE object; recompile with -fPIE
          ld: /gnu/store/ln9fprji2wkl0sz535hb6hz65sqv1wvl-zlib-1.2.11-static/lib/libz.a(inffast.o): relocation R_X86_64_32S against `.rodata.str1.1&#39; can not be used when making a PIE object; recompile with -fPIE
          collect2: error: ld returned 1 exit status


error: aborting due to previous error

error: could not compile `rustc-main`
</code></pre></div>



<a name="263914397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263914397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263914397">(Dec 06 2021 at 20:05)</a>:</h4>
<p>I've rebuilt zlib with -fPIC, but I'm still getting errors from it:</p>
<div class="codehilite"><pre><span></span><code>rlib&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/libpin_project_lite-2a1eae6df0367d8b.rlib&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/libtracing_core-d6a425bf333ff524.rlib&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/liblazy_static-88c2515ad56b001b.rlib&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/libcfg_if-4d18288b9d22eb8f.rlib&quot; &quot;-Wl,--start-group&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/i686-unknown-linux-gnu/lib&quot; &quot;-Wl,-Bdynamic&quot; &quot;-lstd-9c917f45e5ac8791&quot; &quot;-Wl,--end-group&quot; &quot;-Wl,-Bstatic&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/i686-unknown-linux-gnu/lib/libcompiler_builtins-865f6241f33083a5.rlib&quot; &quot;-Wl,-Bdynamic&quot; &quot;-lgcc_s&quot; &quot;-lutil&quot; &quot;-lrt&quot; &quot;-lpthread&quot; &quot;-lm&quot; &quot;-ldl&quot; &quot;-lc&quot; &quot;-Wl,--eh-frame-hdr&quot; &quot;-Wl,-znoexecstack&quot; &quot;-L&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/i686-unknown-linux-gnu/lib&quot; &quot;-o&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/rustc_main-969d289436049930&quot; &quot;-Wl,--gc-sections&quot; &quot;-pie&quot; &quot;-Wl,-zrelro&quot; &quot;-Wl,-znow&quot; &quot;-Wl,-O1&quot; &quot;-nodefaultlibs&quot; &quot;-Wl,-rpath,$ORIGIN/../lib&quot;
  = note: i686-linux-gnu-ld: /tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/librustc_llvm-22f416aabb7e38e5.rlib(Compression.cpp.o): in function `llvm::zlib::compress(llvm::StringRef, llvm::SmallVectorImpl&lt;char&gt;&amp;, int)&#39;:
          (.text._ZN4llvm4zlib8compressENS_9StringRefERNS_15SmallVectorImplIcEEi+0x20): undefined reference to `compressBound&#39;
          i686-linux-gnu-ld: (.text._ZN4llvm4zlib8compressENS_9StringRefERNS_15SmallVectorImplIcEEi+0x45): undefined reference to `compress2&#39;
          i686-linux-gnu-ld: /tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/librustc_llvm-22f416aabb7e38e5.rlib(Compression.cpp.o): in function `llvm::zlib::uncompress(llvm::StringRef, char*, unsigned int&amp;)&#39;:
          (.text._ZN4llvm4zlib10uncompressENS_9StringRefEPcRj+0x27): undefined reference to `uncompress&#39;
          i686-linux-gnu-ld: /tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/build/x86_64-unknown-linux-gnu/stage1-rustc/i686-unknown-linux-gnu/release/deps/librustc_llvm-22f416aabb7e38e5.rlib(CRC.cpp.o): in function `llvm::crc32(unsigned int, llvm::ArrayRef&lt;unsigned char&gt;)&#39;:
          (.text._ZN4llvm5crc32EjNS_8ArrayRefIhEE+0x1c): undefined reference to `crc32&#39;
          collect2: error: ld returned 1 exit status


error: aborting due to previous error

error: could not compile `rustc-main`

To learn more, run the command again with --verbose.
command did not execute successfully: &quot;/gnu/store/2gi4xhwh70kgycpdq467c7z65iwx3v44-rust-1.54.0-cargo/bin/cargo&quot; &quot;build&quot; &quot;--target&quot; &quot;i686-unknown-linux-gnu&quot; &quot;-Zdual-proc-macros&quot; &quot;-Zbinary-dep-depinfo&quot; &quot;-j&quot; &quot;24&quot; &quot;--release&quot; &quot;--frozen&quot; &quot;--features&quot; &quot; llvm max_level_info&quot; &quot;--manifest-path&quot; &quot;/tmp/guix-build-rust-i686-linux-cross-1.54.0.drv-0/rustc-1.54.0-src/compiler/rustc/Cargo.toml&quot; &quot;--message-format&quot; &quot;json-render-diagnostics&quot;
</code></pre></div>



<a name="263916777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263916777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263916777">(Dec 06 2021 at 20:13)</a>:</h4>
<p>That looks like you might have built the wrong version? Those are "undefined reference" errors</p>



<a name="263926710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263926710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263926710">(Dec 06 2021 at 21:24)</a>:</h4>
<p>Strange; I've rebuilt llvm against those same  zlib static libs</p>



<a name="263952043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263952043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263952043">(Dec 07 2021 at 02:37)</a>:</h4>
<p>Does Rust requires libffi support in LLVM?</p>



<a name="263952098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263952098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263952098">(Dec 07 2021 at 02:38)</a>:</h4>
<p>(still asking in the context of building a minimal rustc/cargo bootstrap)</p>



<a name="263956842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/263956842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#263956842">(Dec 07 2021 at 04:18)</a>:</h4>
<p>I'm not sure if libffi is actually required, but beware <a href="https://github.com/rust-lang/rust/issues/34486">#34486</a>.</p>



<a name="266135903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/building%20rustc%20statically/near/266135903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/building.20rustc.20statically.html#266135903">(Dec 27 2021 at 00:35)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I've had to drop the ball on this for now, but this PR should be ready: <a href="https://github.com/rust-lang/rust/pull/91375#pullrequestreview-822228813">https://github.com/rust-lang/rust/pull/91375#pullrequestreview-822228813</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>