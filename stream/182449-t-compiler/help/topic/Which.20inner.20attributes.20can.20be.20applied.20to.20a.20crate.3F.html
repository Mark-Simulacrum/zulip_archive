<html>
<head><meta charset="utf-8"><title>Which inner attributes can be applied to a crate? · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Which.20inner.20attributes.20can.20be.20applied.20to.20a.20crate.3F.html">Which inner attributes can be applied to a crate?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256716494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Which%20inner%20attributes%20can%20be%20applied%20to%20a%20crate%3F/near/256716494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom Farmer <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Which.20inner.20attributes.20can.20be.20applied.20to.20a.20crate.3F.html#256716494">(Oct 08 2021 at 10:06)</a>:</h4>
<p>Hi All, as per <a href="https://github.com/rust-lang/rust/issues/89566">issue 89566</a> the current compiler parser takes all inner attributes at the top of a crate and applies them as crate attributes - I would like to be able to generate an error message if any incorrect attributes (for example #![derive]) are at the top of a crate so we don't end up with a confusing error message further down the line.</p>
<p>Is there a list of attributes that can be applied to a crate as an inner attribute?</p>



<a name="256756897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Which%20inner%20attributes%20can%20be%20applied%20to%20a%20crate%3F/near/256756897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Which.20inner.20attributes.20can.20be.20applied.20to.20a.20crate.3F.html#256756897">(Oct 08 2021 at 15:26)</a>:</h4>
<p>Everything with a <code>CrateLevel</code> <a href="https://github.com/rust-lang/rust/blob/e0aaffd8a45cd0e9f331ec7734713e9de11aa6c8/compiler/rustc_feature/src/builtin_attrs.rs#L168">here</a> is a crate-level only attribute.  rustc already checks for these, but some attributes are special, like <code>derive</code>, <code>test</code>, <code>bench</code>, etc. These attributes run during expansion, before most of the validation is done.  I'm not sure the best way to approach this, <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> might have an idea.  I'm guessing something in resolution, since that is where it is getting stuck.</p>
<p>Something seems off though.  Putting any unknown attribute at the crate level seems to cause a cascade of "resolution is stuck" errors further down the line.  I don't think that should be happening.</p>



<a name="256760507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Which%20inner%20attributes%20can%20be%20applied%20to%20a%20crate%3F/near/256760507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom Farmer <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Which.20inner.20attributes.20can.20be.20applied.20to.20a.20crate.3F.html#256760507">(Oct 08 2021 at 15:51)</a>:</h4>
<p>From what I can tell during std injection it's placing these unknown attributes in between the <code>#![feature(prelude_import)]</code> and the actual std prelude injection inside the <code>standard_library_injection::inject()</code> function because when it parses the initial crate for the ast it assumes that any internal attribute (specified with # ! | ATTRIBUTE) at the top of the crate is a crate attribute. </p>
<p>The output of macro expansion is: </p>
<div class="codehilite"><pre><span></span><code>#![feature(prelude_import)]
#![derive(Debug)]
#[prelude_import]
use std::prelude::rust_2018::*;
#[macro_use]
extern crate std;
struct Test {
    s: String,
}

fn main() { }
</code></pre></div>
<p>The only reason I can see why it is doing this is because it appends the injection onto the start of the crate items which come after the crate attributes in the crate representation of the ast </p>
<div class="codehilite"><pre><span></span><code>pub struct Crate {
    pub attrs: Vec&lt;Attribute&gt;,
    pub items: Vec&lt;P&lt;Item&gt;&gt;,
    pub span: Span,
}
</code></pre></div>



<a name="256760744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Which%20inner%20attributes%20can%20be%20applied%20to%20a%20crate%3F/near/256760744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom Farmer <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Which.20inner.20attributes.20can.20be.20applied.20to.20a.20crate.3F.html#256760744">(Oct 08 2021 at 15:53)</a>:</h4>
<p>The location it injects the std prelude is here in <code>Compiler::rustc_builtin_macros::src::standard_library_imports::inject</code></p>



<a name="256761019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Which%20inner%20attributes%20can%20be%20applied%20to%20a%20crate%3F/near/256761019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom Farmer <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Which.20inner.20attributes.20can.20be.20applied.20to.20a.20crate.3F.html#256761019">(Oct 08 2021 at 15:55)</a>:</h4>
<p>So I think the issue is likely that we're just incorrectly parsing attributes at the top of the crate as all being crate level attributes when in fact only a few of the inner attributes actually are</p>



<a name="256767105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Which%20inner%20attributes%20can%20be%20applied%20to%20a%20crate%3F/near/256767105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom Farmer <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Which.20inner.20attributes.20can.20be.20applied.20to.20a.20crate.3F.html#256767105">(Oct 08 2021 at 16:34)</a>:</h4>
<p>And just for completeness despite the wall of text - this is the parser function for the initial <code>Crate</code> ast token: </p>
<div class="codehilite"><pre><span></span><code>pub fn parse_mod(
        &amp;mut self,
        term: &amp;TokenKind,
    ) -&gt; PResult&lt;&#39;a, (Vec&lt;Attribute&gt;, Vec&lt;P&lt;Item&gt;&gt;, Span)&gt; {
        let lo = self.token.span;
        let attrs = self.parse_inner_attributes()?;

        let mut items = vec![];
        while let Some(item) = self.parse_item(ForceCollect::No)? {
            items.push(item);
            self.maybe_consume_incorrect_semicolon(&amp;items);
        }

        if !self.eat(term) {
            let token_str = super::token_descr(&amp;self.token);
            if !self.maybe_consume_incorrect_semicolon(&amp;items) {
                let msg = &amp;format!(&quot;expected item, found {}&quot;, token_str);
                let mut err = self.struct_span_err(self.token.span, msg);
                err.span_label(self.token.span, &quot;expected item&quot;);
                return Err(err);
            }
        }

        Ok((attrs, items, lo.to(self.prev_token.span)))
    }
</code></pre></div>
<p>You can see it's just parsing all inner attributes at the top of the crate and then assigning them to the crate attributes</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>