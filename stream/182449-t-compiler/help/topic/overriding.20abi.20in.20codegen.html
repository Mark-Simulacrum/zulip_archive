<html>
<head><meta charset="utf-8"><title>overriding abi in codegen · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html">overriding abi in codegen</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259808260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/259808260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#259808260">(Oct 31 2021 at 21:02)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> for overriding a certain ABI like C (like you mentioned some time ago), do i need to reimplement <code>fn_abi_new_uncached</code> from LayoutCx or is there a way to only override the pass mode for each arg?</p>



<a name="259809333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/259809333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#259809333">(Oct 31 2021 at 21:31)</a>:</h4>
<p>take a look at what rust-gpu does: <a href="https://github.com/EmbarkStudios/rust-gpu/blob/c4eb7af88ee0baf556cc6b46389a2e71b34919bf/crates/rustc_codegen_spirv/src/abi.rs#L57">https://github.com/EmbarkStudios/rust-gpu/blob/c4eb7af88ee0baf556cc6b46389a2e71b34919bf/crates/rustc_codegen_spirv/src/abi.rs#L57</a></p>



<a name="259809456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/259809456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#259809456">(Oct 31 2021 at 21:35)</a>:</h4>
<p>Oh great</p>



<a name="261347465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261347465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261347465">(Nov 13 2021 at 08:02)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> Weird, i tried overriding any aggregates to pass by value, but that makes rustc ICE:</p>
<div class="codehilite"><pre><span></span><code>internal compiler error: /rustc/1f12ac87296ac61ec002e0243e7ad5a50364da35\compiler\rustc_codegen_ssa\src\mir\block.rs:1381:21: place local already assigned to
</code></pre></div>
<p>using </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="fm">matches!</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">arg</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">abi</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">abi</span>::<span class="n">Abi</span>::<span class="n">ScalarPair</span><span class="p">(</span><span class="o">..</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">abi</span>::<span class="n">Abi</span>::<span class="n">Aggregate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">arg</span><span class="p">.</span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PassMode</span>::<span class="n">Direct</span><span class="p">(</span><span class="n">ArgAttributes</span>::<span class="n">new</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Is this the incorrect way of doing this? i could not find anything in rustc's abi stuff that makes arguments direct, only indirect, and im writing this at like 2 am so this might be very wrong <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="261347603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261347603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261347603">(Nov 13 2021 at 08:06)</a>:</h4>
<p>oh wait, it works if i check if the passmode is indirect before overriding, im guessing some scalar or aggregate is using an exotic pass mode and it doesnt like me overriding it, nevermind, sorry <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="261347748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261347748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261347748">(Nov 13 2021 at 08:10)</a>:</h4>
<p>also why is <code>is_aggregate()</code> private? it means i can't use it and i need to make my own scuffed version :(</p>



<a name="261352232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261352232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261352232">(Nov 13 2021 at 10:01)</a>:</h4>
<p>If the pass mode is Pair, it probably must not be overriden. This pass mode can't exist for repr(C) types, but it is used for fat pointers. Especially in case of pointers/references to trait objects the compiler assumes that Pair is used as pass mode.</p>



<a name="261370168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261370168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261370168">(Nov 13 2021 at 17:08)</a>:</h4>
<p>I would like to guarantee that slices are passed as two parameters, but im not sure if rustc always passes slices as a scalar pair</p>



<a name="261370211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261370211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261370211">(Nov 13 2021 at 17:08)</a>:</h4>
<p>Because id like to make the gpu kernels “compatible” with how you would expect CUDA C++ to pass certain things</p>



<a name="261370271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261370271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261370271">(Nov 13 2021 at 17:10)</a>:</h4>
<p>And cuda expects everything to be passed directly, by value, for the kernels that is, for “intermediate” functions thats no issue. Which is why i overrode the passmode for structs in there</p>



<a name="261370928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261370928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261370928">(Nov 13 2021 at 17:25)</a>:</h4>
<blockquote>
<p>would like to guarantee that slices are passed as two parameters</p>
</blockquote>
<p>That is what a pass mode of <code>Pair</code> does.</p>



<a name="261371030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261371030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261371030">(Nov 13 2021 at 17:28)</a>:</h4>
<p>But is it guaranteed that rustc will always pass slices as scalar pairs?</p>



<a name="261371095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261371095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261371095">(Nov 13 2021 at 17:29)</a>:</h4>
<p>ohh you mean override any slice Ty as a Pair passmode?</p>



<a name="261371119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261371119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261371119">(Nov 13 2021 at 17:29)</a>:</h4>
<p>That should guarantee that it’s always passed as a pair even if rustc already tries passing it as a pair, right?</p>



<a name="261371223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261371223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261371223">(Nov 13 2021 at 17:32)</a>:</h4>
<p>if im doing that, should i worry about ArgAttributes or do they not cause issues in this case?</p>



<a name="261371417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261371417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261371417">(Nov 13 2021 at 17:38)</a>:</h4>
<p>Current rustc versions always use <code>Pair</code> for fat pointers, including <code>&amp;[T]</code>, <code>&amp;mut [T]</code>, <code>Box&lt;[T]&gt;</code> and <code>Rc&lt;[T]&gt;</code>.</p>



<a name="261371465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261371465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261371465">(Nov 13 2021 at 17:38)</a>:</h4>
<p>For any newer rustc versions that may or may not do this, you will likely have to change the backend anyway to make it compile.</p>



<a name="261371539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261371539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261371539">(Nov 13 2021 at 17:40)</a>:</h4>
<p>Well if it changed it would make kernels segfault (well, the gpu equivalent), so id rather not have that happen randomly across updates, so should manually setting the pair mode for slices and stuff be enough to guarantee this does not change?</p>



<a name="261371600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261371600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261371600">(Nov 13 2021 at 17:42)</a>:</h4>
<p>If it changes, you will notice it quickly enough, right? I believe it has been the case for many years (I think even before rust 1.0) and I don't think it will change anytime soon.</p>



<a name="261371610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261371610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261371610">(Nov 13 2021 at 17:43)</a>:</h4>
<p>Well gpu segfaults can be caused by many things, a parameter change would probably not be on my list of potential causes</p>



<a name="261371661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/overriding%20abi%20in%20codegen/near/261371661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/overriding.20abi.20in.20codegen.html#261371661">(Nov 13 2021 at 17:44)</a>:</h4>
<p>although if rustc ever changed this we would probably have ptx validation done or have some form of the backend upstreamed by that point</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>