<html>
<head><meta charset="utf-8"><title>ABI weirdness · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html">ABI weirdness</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253163997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253163997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253163997">(Sep 13 2021 at 21:32)</a>:</h4>
<p>Hello! I am having some odd behavior with calling conventions in a custom codegen i am working on. <br>
CUDA C seems to pass a pointer and a <code>vec2&lt;usize&gt;</code> as a 16 byte array in the ptx file:</p>
<div class="codehilite"><pre><span></span><code>.visible .entry _Z3fooP4vec34vec2(
    .param .u64 _Z3fooP4vec34vec2_param_0,
    .param .align 8 .b8 _Z3fooP4vec34vec2_param_1[16]
)
</code></pre></div>
<p>which works fine, however, when i attempt to replicate this function with my codegen, using a vek <code>Vec3</code> struct (a repr C struct of x, y, and z), rustc seems to want to pass the second parameter as two distinct parameters:</p>
<div class="codehilite"><pre><span></span><code>#[kernel]
pub unsafe fn render(fb: *mut Vec3&lt;f32&gt;, bounds: Vec2&lt;usize&gt;) {
    let idx = thread::index_2d();
    if idx.x &gt;= bounds.x || idx.y &gt;= bounds.y {
        return;
    }
    *fb.offset(idx.product() as isize) =
        (idx.numcast().unwrap() - bounds.numcast().unwrap()).with_z(0.2);
}
</code></pre></div>
<p>nvvm ir snippet generated by my codegen (ABI code taken from cg_llvm):</p>
<div class="codehilite"><pre><span></span><code>define void @render(%&quot;cuda_std::vek::Vec3&lt;f32&gt;&quot;* nocapture, i64, i64) unnamed_addr {
</code></pre></div>
<p>ptx:</p>
<div class="codehilite"><pre><span></span><code>.visible .entry render(
    .param .u64 render_param_0,
    .param .u64 render_param_1,
    .param .u64 render_param_2
)
</code></pre></div>
<p>This causes a big issue, because when you launch the cuda kernel, cuda expects an extra param instead of a single parameter, which causes a segfault. </p>
<p>For some reason i cannot get rustc (with my backend) to generate code akin to the CUDA C version, telling rustc to use <code>ptx-kernel</code> or <code>C</code> just makes it pass both things as pointers, which is not what i want (pretty sure it would segfault too). I doubt its my codegen's fault because libnvvm says that it ignores any calling convention markers on functions, rustc seems to decide this before the codegen step.</p>



<a name="253164806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253164806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253164806">(Sep 13 2021 at 21:38)</a>:</h4>
<p>Is <code>Vec2</code> <code>#[repr(C)]</code>?</p>



<a name="253164813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253164813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253164813">(Sep 13 2021 at 21:39)</a>:</h4>
<p>Yep</p>



<a name="253165034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253165034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253165034">(Sep 13 2021 at 21:40)</a>:</h4>
<p>What does attaching <code>#[rustc_layout(debug)]</code> to the type definition show? You need <code>#![feature(rustc_attrs)]</code> for it to work too.</p>



<a name="253165094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253165094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253165094">(Sep 13 2021 at 21:41)</a>:</h4>
<p>Hmm the type def is in the vek crate, lemme try replicating the type and see</p>



<a name="253165254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253165254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253165254">(Sep 13 2021 at 21:42)</a>:</h4>
<p>Attaching it to a type alias for <code>Vec2</code> may work too. (<code>#[...] type MyVec2 = Vec2&lt;f32&gt;</code>)</p>



<a name="253165272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253165272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253165272">(Sep 13 2021 at 21:42)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span><span class="w"></span>
<span class="cp">#[rustc_layout(debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Vec2ButBetter</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">y</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>error: layout_of(Vec2ButBetter) = Layout {
    fields: Arbitrary {
        offsets: [
            Size {
                raw: 0,
            },
            Size {
                raw: 8,
            },
        ],
        memory_index: [
            0,
            1,
        ],
    },
    variants: Single {
        index: 0,
    },
    abi: ScalarPair(
        Scalar {
            value: Int(
                I64,
                false,
            ),
            valid_range: 0..=18446744073709551615,
        },
        Scalar {
            value: Int(
                I64,
                false,
            ),
            valid_range: 0..=18446744073709551615,
        },
    ),
    largest_niche: None,
    align: AbiAndPrefAlign {
        abi: Align {
            pow2: 3,
        },
        pref: Align {
            pow2: 3,
        },
    },
    size: Size {
        raw: 16,
    },
}
</code></pre></div>



<a name="253165328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253165328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253165328">(Sep 13 2021 at 21:42)</a>:</h4>
<p>yeah it seems the abi wants to pass it as a scalar pair</p>



<a name="253165377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253165377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253165377">(Sep 13 2021 at 21:43)</a>:</h4>
<p><code>#[repr(C)]</code> should force ByRef afaik.</p>



<a name="253165409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253165409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253165409">(Sep 13 2021 at 21:43)</a>:</h4>
<p>if i mark the function as extern C it forces it to be passed as a pointer</p>



<a name="253165429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253165429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253165429">(Sep 13 2021 at 21:44)</a>:</h4>
<p>but i don't think thats the wanted outcome, it should be passed as a byte array</p>



<a name="253165503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253165503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253165503">(Sep 13 2021 at 21:44)</a>:</h4>
<p>this is the calling convention that libnvvm wants btw: <a href="https://docs.nvidia.com/cuda/nvvm-ir-spec/index.html#rules-and-restrictions">https://docs.nvidia.com/cuda/nvvm-ir-spec/index.html#rules-and-restrictions</a></p>



<a name="253165550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253165550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253165550">(Sep 13 2021 at 21:44)</a>:</h4>
<p>unfortunately i cannot check the llvm ir that nvcc generates for the cuda c version because its closed source but i expect it just passes it by value</p>



<a name="253166093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253166093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253166093">(Sep 13 2021 at 21:49)</a>:</h4>
<p>I think you will have to write your own abi calculation code like in rustc_target/src/abi/call You will have to make the functions <code>extern "C"</code> too as otherwise the rust abi is used, details of which various parts of the backend depend on. <a href="https://github.com/rust-lang/rust/pull/88575">https://github.com/rust-lang/rust/pull/88575</a> will make it possible to override the abi calculation code from a codegen backend if it lands.</p>



<a name="253166220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253166220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253166220">(Sep 13 2021 at 21:50)</a>:</h4>
<p>I was correct, using</p>
<div class="codehilite"><pre><span></span><code>%&quot;cuda_std::vek::Vec3&lt;f32&gt;&quot; = type { [0 x i32], float, [0 x i32], float, [0 x i32], float, [0 x i32] }

define void @foo(%&quot;cuda_std::vek::Vec3&lt;f32&gt;&quot;* nocapture, { i64, i64 }) unnamed_addr #1 {
start:
  ret void
}
</code></pre></div>
<p>makes libnvvm generate the code as </p>
<div class="codehilite"><pre><span></span><code>.visible .entry foo(
    .param .u64 foo_param_0,
    .param .align 8 .b8 foo_param_1[16]
)
</code></pre></div>



<a name="253166350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253166350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253166350">(Sep 13 2021 at 21:51)</a>:</h4>
<p>hmm, interesting</p>



<a name="253166558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253166558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253166558">(Sep 13 2021 at 21:52)</a>:</h4>
<p>What would the abi calculation code entail? just passing everything by value?</p>



<a name="253166754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253166754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253166754">(Sep 13 2021 at 21:54)</a>:</h4>
<p>it sounds kind of cursed but can't i modify the function types/params that i give back to cg_ssa?</p>



<a name="253167182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253167182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253167182">(Sep 13 2021 at 21:58)</a>:</h4>
<p>in <code>FnAbiLlvmExt::llvm_type</code> i treat <code>PassMode::Pair</code> as <code>PassMode::Direct</code>, and keep track of these mappings in cgcx, then in the get_param functions i keep track of that mapping and do the remapping myself</p>



<a name="253167399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253167399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253167399">(Sep 13 2021 at 22:00)</a>:</h4>
<p>because extern functions arent really a thing in libnvvm, this should be safe because the code is only interacting with code generated by the same backend</p>



<a name="253181065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253181065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253181065">(Sep 14 2021 at 00:27)</a>:</h4>
<p><code>extern "C"</code> is not about “extern” its about the "C" (or other values) primarily.</p>



<a name="253181076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253181076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253181076">(Sep 14 2021 at 00:27)</a>:</h4>
<p>i.e. its a mechanism to specify the calling convention.</p>



<a name="253181183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253181183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253181183">(Sep 14 2021 at 00:28)</a>:</h4>
<blockquote>
<p>cuda expects an extra param instead of a single parameter, which causes a segfault. </p>
</blockquote>
<p>This sounds like a need for a well specified calling convention, which <code>"Rust"</code> (the default in absence of a different specification) is not.</p>



<a name="253181230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253181230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253181230">(Sep 14 2021 at 00:29)</a>:</h4>
<p>So you must do what <span class="user-mention" data-user-id="133247">@bjorn3</span> said, pretty much.</p>



<a name="253184560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253184560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253184560">(Sep 14 2021 at 01:19)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> im pretty sure ptx-kernel is supposed to be the calling convention that cuda uses, but that makes rustc try to pass it as a pointer, not by value, which is very confusing</p>



<a name="253184613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253184613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253184613">(Sep 14 2021 at 01:20)</a>:</h4>
<p>this is the nvvm documentation for the calling convention <a href="https://docs.nvidia.com/cuda/nvvm-ir-spec/index.html#argument-passing-and-return">https://docs.nvidia.com/cuda/nvvm-ir-spec/index.html#argument-passing-and-return</a></p>



<a name="253184641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253184641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253184641">(Sep 14 2021 at 01:20)</a>:</h4>
<p>it doesn't actually tell you how to pass arguments, it just tells you what they will be translated to in the ptx</p>



<a name="253184672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253184672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253184672">(Sep 14 2021 at 01:21)</a>:</h4>
<p>so i personally think its a backend problem not a calling convention problem, but this is confusing overall</p>



<a name="253184945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253184945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253184945">(Sep 14 2021 at 01:25)</a>:</h4>
<p>although the ptx interop guide also says all aggregates and unions are supported using byte arrays <a href="https://docs.nvidia.com/cuda/ptx-writers-guide-to-interoperability/index.html#aggregates-unions">https://docs.nvidia.com/cuda/ptx-writers-guide-to-interoperability/index.html#aggregates-unions</a></p>



<a name="253184995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253184995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253184995">(Sep 14 2021 at 01:26)</a>:</h4>
<p>so is rustc generating the wrong pass mode for the ptx-kernel calling convention?</p>



<a name="253221411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253221411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253221411">(Sep 14 2021 at 09:21)</a>:</h4>
<p>I am not sure that's necessarily the case. It may be that llvm's ptx backend actually expects pointers and knows how to deal with them (e.g. by making them byval implicitly)</p>



<a name="253281340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253281340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253281340">(Sep 14 2021 at 16:35)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> this is not llvm’s ptx backend, this is my custom codegen backend which uses libnvvm, libnvvm uses a subset of llvm 7 IR and generates PTX from it, along with doing some proprietary opts on it, it well defines how params are passed in one of those docs</p>



<a name="253281537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253281537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253281537">(Sep 14 2021 at 16:36)</a>:</h4>
<p>My abi handling code is taken mostly from rustc, and double checking, its generating the correct function types if it receives scalarpair, so the issue is that rustc is asking for scalarpair when it should just be passing everything by value per the ptx-kernel call conv</p>



<a name="253281920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253281920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253281920">(Sep 14 2021 at 16:38)</a>:</h4>
<p>Since the ptx abi outlines that all aggregates and unions are supported natively using byte arrays, shouldnt rustc be passing them always by value instead of transforming them to indirect or scalarpair?</p>



<a name="253282139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253282139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253282139">(Sep 14 2021 at 16:40)</a>:</h4>
<blockquote>
<p>I think you will have to write your own abi calculation code like in rustc_target/src/abi/call You will have to make the functions extern "C" too as otherwise the rust abi is used, details of which various parts of the backend depend on. <a href="https://github.com/rust-lang/rust/pull/88575">https://github.com/rust-lang/rust/pull/88575</a> will make it possible to override the abi calculation code from a codegen backend if it lands.</p>
</blockquote>
<p>this</p>



<a name="253282221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253282221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253282221">(Sep 14 2021 at 16:40)</a>:</h4>
<p>Right im just wondering why rustc isnt doing this for ptx-kernel in the first place <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="253282327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253282327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253282327">(Sep 14 2021 at 16:41)</a>:</h4>
<p>The llvm ptx backend doesnt really work on windows but i would expect this would also generate the same wrong code which would segfault, so is this not an issue in rustc too?</p>



<a name="253282476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253282476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253282476">(Sep 14 2021 at 16:43)</a>:</h4>
<p>would the fix be making <a href="https://github.com/rust-lang/rust/blob/ec9a1bdc4586eec99acbe34df3717b3fd1277b06/compiler/rustc_target/src/abi/call/nvptx64.rs#L16">https://github.com/rust-lang/rust/blob/ec9a1bdc4586eec99acbe34df3717b3fd1277b06/compiler/rustc_target/src/abi/call/nvptx64.rs#L16</a> make_indirect_by_val?</p>



<a name="253282567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253282567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253282567">(Sep 14 2021 at 16:43)</a>:</h4>
<p>I believe so, it should be passing everything by value in ptx</p>



<a name="253282766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253282766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253282766">(Sep 14 2021 at 16:45)</a>:</h4>
<p>I will try to see if that fixes it later</p>



<a name="253282936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253282936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253282936">(Sep 14 2021 at 16:46)</a>:</h4>
<p>Although id rather not require users to rely on the abi_ptx feature, so ill prob go the route of modifying the extern c handling code once that pr lands</p>



<a name="253283256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253283256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253283256">(Sep 14 2021 at 16:48)</a>:</h4>
<p>although, im still curious as to why implicitly treating everything as Direct in the backend <em>wouldnt</em> work, because to cg_ssa, its basically opaque, and there is technically no concept of a calling convention in ptx, everything uses the ptx calling convention</p>



<a name="253291759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253291759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253291759">(Sep 14 2021 at 17:39)</a>:</h4>
<p>For example fat pointers must be scalar pair. Anything else will cause miscompilations or tripping assertions.</p>



<a name="253291851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253291851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253291851">(Sep 14 2021 at 17:40)</a>:</h4>
<p><code>Direct</code> is only meant for primitive types, not composite types.</p>



<a name="253295317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253295317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253295317">(Sep 14 2021 at 18:03)</a>:</h4>
<p>I see, <span class="user-mention" data-user-id="133247">@bjorn3</span> how would that PR allow overriding? would i override the query or something?</p>



<a name="253302284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253302284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253302284">(Sep 14 2021 at 18:46)</a>:</h4>
<p>besides, why does rustc extend ints less than 64 bits to 64 bits? according to the <a href="https://docs.nvidia.com/cuda/ptx-writers-guide-to-interoperability/#parameter-passing">ref</a> params should be extended to 32 bits if they are below 32 bits, not 64 </p>
<blockquote>
<p>Values shorter than 32-bits are sign extended or zero extended, depending on whether they are signed or unsigned types.</p>
</blockquote>



<a name="253302417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253302417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253302417">(Sep 14 2021 at 18:47)</a>:</h4>
<p>should i submit a bug report for this? it seems rustc is doing some <del>sus</del> odd things for ptx-kernel</p>



<a name="253302612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253302612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253302612">(Sep 14 2021 at 18:48)</a>:</h4>
<p>It is extending to 32 bits for nvptx, but this should not change across nvptx/nvptx64, its always 32 bit extension</p>



<a name="253305978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253305978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253305978">(Sep 14 2021 at 19:08)</a>:</h4>
<blockquote>
<p>would i override the query or something?</p>
</blockquote>
<p>yes</p>
<blockquote>
<p>besides, why does rustc extend ints less than 64 bits to 64 bits? according to the ref params should be extended to 32 bits if they are below 32 bits, not 64 </p>
</blockquote>
<p>I have no idea.</p>
<blockquote>
<p>should i submit a bug report for this? it seems rustc is doing some sus odd things for ptx-kernel</p>
</blockquote>
<p>I think so.</p>



<a name="253306052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253306052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253306052">(Sep 14 2021 at 19:09)</a>:</h4>
<p>do you happen to know how? i thought queries were made and set in place when tyctxt is made?</p>



<a name="253307418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253307418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253307418">(Sep 14 2021 at 19:18)</a>:</h4>
<p>The <code>CodegenBackend</code> trait has a <code>provide</code> method which allows you to override any query just before the <code>TyCtxt</code> is created.</p>



<a name="253307483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253307483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253307483">(Sep 14 2021 at 19:18)</a>:</h4>
<p>oh thats what that method is for! <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> i thought it was only for attrs</p>



<a name="253307519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253307519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253307519">(Sep 14 2021 at 19:18)</a>:</h4>
<p>thank you so much for your continued help <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="253307955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253307955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253307955">(Sep 14 2021 at 19:21)</a>:</h4>
<p>have a picture i made with the codegen as thanks <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span> <a href="/user_uploads/4715/Vncdaxs0NLxNSNwlyWsaO_lM/out.png">out.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/Vncdaxs0NLxNSNwlyWsaO_lM/out.png" title="out.png"><img src="/user_uploads/4715/Vncdaxs0NLxNSNwlyWsaO_lM/out.png"></a></div>



<a name="253308575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ABI%20weirdness/near/253308575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ABI.20weirdness.html#253308575">(Sep 14 2021 at 19:25)</a>:</h4>
<p>it aint much but it was made 100% in rust, rust wrapper for the cuda driver API, rust gpu kernel, rust everything <span aria-label="crab" class="emoji emoji-1f980" role="img" title="crab">:crab:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>