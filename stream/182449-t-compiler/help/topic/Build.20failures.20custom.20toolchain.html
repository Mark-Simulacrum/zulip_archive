<html>
<head><meta charset="utf-8"><title>Build failures custom toolchain · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Build.20failures.20custom.20toolchain.html">Build failures custom toolchain</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257258230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Build%20failures%20custom%20toolchain/near/257258230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hudson Ayers <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Build.20failures.20custom.20toolchain.html#257258230">(Oct 12 2021 at 19:25)</a>:</h4>
<p>Hello, I am trying to work on <a href="https://github.com/rust-lang/rust/issues/70579">https://github.com/rust-lang/rust/issues/70579</a> . I am specifically interested in measuring the size impact of implicit caller location on embedded devices, so I am using Tock as an example application which I want to profile with/without my changes to the compiler. Unfortunately I am finding I am unable to compile Tock using a local build of the current Rust master branch, even though using the latest nightly works fine. I built the rust compiler using  <code>$ ./x.py build library/std</code>. My config.toml looks as follows:</p>
<div class="codehilite"><pre><span></span><code>profile = &quot;codegen&quot;
changelog-seen = 2
[llvm]
download-ci-llvm = false
[rust]
lld = true
</code></pre></div>
<p>I then ran <code>$ rustup toolchain link stage1 build/x86_64-unknown-linux-gnu/stage1</code></p>
<p>I then modified the top-level rust-toolchain file for Tock to contain only <code>stage1</code></p>
<p>Finally, I attempted to build the Imix board by running </p>
<div class="codehilite"><pre><span></span><code>~/tock/boards/imix$ cargo build -Z build-std=core,compiler_builtins --target=thumb7em-none-eabi --release
</code></pre></div>
<p>Which resulted in the following output:</p>
<div class="codehilite"><pre><span></span><code>   Compiling imix v0.1.0 (/home/hudson/tock/boards/imix)
rustc: /home/hudson/rust/src/llvm-project/llvm/lib/MC/MCStreamer.cpp:1216: virtual void llvm::MCStreamer::SwitchSection(llvm::MCSection*, const llvm::MCExpr*): Assertion `!Section-&gt;hasEnded() &amp;&amp; &quot;Section already ended&quot;&#39; failed.
error: could not compile `imix`

Caused by:
  process didn&#39;t exit successfully: `rustc --crate-name imix --edition=2021 boards/imix/src/main.rs --error-format=json --json=diagnostic-rendered-ansi --crate-type bin --emit=dep-info,link -C opt-level=z -C panic=abort -C lto -C codegen-units=1 -C debuginfo=2 -C metadata=a60892fa540b861c -C extra-filename=-a60892fa540b861c --out-dir /home/hudson/tock/target/thumbv7em-none-eabi/release/deps --target thumbv7em-none-eabi -L dependency=/home/hudson/tock/target/thumbv7em-none-eabi/release/deps -L dependency=/home/hudson/tock/target/release/deps --extern capsules=/home/hudson/tock/target/thumbv7em-none-eabi/release/deps/libcapsules-abdae21b93eb95a2.rlib --extern &#39;noprelude:compiler_builtins=/home/hudson/tock/target/thumbv7em-none-eabi/release/deps/libcompiler_builtins-4c91ccfbbd617e01.rlib&#39; --extern components=/home/hudson/tock/target/thumbv7em-none-eabi/release/deps/libcomponents-24cd32845ffaa22b.rlib --extern &#39;noprelude:core=/home/hudson/tock/target/thumbv7em-none-eabi/release/deps/libcore-4ad4f239c6ff3e95.rlib&#39; --extern cortexm4=/home/hudson/tock/target/thumbv7em-none-eabi/release/deps/libcortexm4-3052ba132d692bbd.rlib --extern kernel=/home/hudson/tock/target/thumbv7em-none-eabi/release/deps/libkernel-7a37aabeccd96c4a.rlib --extern sam4l=/home/hudson/tock/target/thumbv7em-none-eabi/release/deps/libsam4l-19b359ab02edf7fb.rlib -Z unstable-options` (signal: 6, SIGABRT: process abort signal)
</code></pre></div>
<p>Any advice is appreciated :) I suspect the possible culprits are:<br>
a) something went wrong building LLVM locally, but x.py did not report it to me<br>
b) something to do with building lld is causing issues. Unfortunately Tock requires using lld<br>
c) Something to do with -Z build-std is causing issues. Unfortunately if I do not use -Z build-std I get an error "can't find crate for core". Also, I would like to profile my changes with a rebuilt std library using opt-level=s<br>
d) something has changed between latest nightly and current master that broke something (unlikely)</p>



<a name="257268610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Build%20failures%20custom%20toolchain/near/257268610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Build.20failures.20custom.20toolchain.html#257268610">(Oct 12 2021 at 20:39)</a>:</h4>
<p>it's also possible that no one's built llvm with assertions in a while, and this fails for everyone</p>



<a name="257268629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Build%20failures%20custom%20toolchain/near/257268629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Build.20failures.20custom.20toolchain.html#257268629">(Oct 12 2021 at 20:39)</a>:</h4>
<p>consider setting <code>[llvm] assertions = false</code></p>



<a name="257268863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Build%20failures%20custom%20toolchain/near/257268863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Build.20failures.20custom.20toolchain.html#257268863">(Oct 12 2021 at 20:41)</a>:</h4>
<blockquote>
<p>Unfortunately if I do not use -Z build-std I get an error "can't find crate for core".</p>
</blockquote>
<p>I think you need to enable other targets for the standard library in config.toml.</p>



<a name="257269607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Build%20failures%20custom%20toolchain/near/257269607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hudson Ayers <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Build.20failures.20custom.20toolchain.html#257269607">(Oct 12 2021 at 20:46)</a>:</h4>
<p>The config.toml example seems to suggest that assertions = false is the default for llvm, so I am a little surprised that leaving it unspecified would turn them on. I am trying a fresh build w/ assertions = false and w/ the appropriate target enabled to build the standard library. Thanks for the tips!</p>



<a name="257269674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Build%20failures%20custom%20toolchain/near/257269674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Build.20failures.20custom.20toolchain.html#257269674">(Oct 12 2021 at 20:47)</a>:</h4>
<p><span class="user-mention" data-user-id="301759">@Hudson Ayers</span> you set <code>profile = "codegen"</code> which enables them by default</p>



<a name="257269899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Build%20failures%20custom%20toolchain/near/257269899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hudson Ayers <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Build.20failures.20custom.20toolchain.html#257269899">(Oct 12 2021 at 20:48)</a>:</h4>
<p>ah, that makes sense, thanks. I only used "codegen" because it was unclear to me if I needed to do so in order to for lld to be compiled and made available in the sysroot</p>



<a name="257277589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Build%20failures%20custom%20toolchain/near/257277589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hudson Ayers <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Build.20failures.20custom.20toolchain.html#257277589">(Oct 12 2021 at 21:52)</a>:</h4>
<p>Building with assertions disabled got things working. Thanks for the help!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>