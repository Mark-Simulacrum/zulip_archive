<html>
<head><meta charset="utf-8"><title>cargo + llvm-c · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html">cargo + llvm-c</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273376589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273376589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273376589">(Feb 27 2022 at 02:28)</a>:</h4>
<p>Heya. Kind of fringe, but I have a target I want to run Rust on (Blackfin) which LLVM cannot target, however I can use <code>rustc</code> to emit LLVM bitcode or IR and use llvm-c to generate C code and use GCC to build that code for my target. Would there be a good way to use this workflow with cargo? Effectively, I would want cargo to invoke llvm-c on the LLVM bitcode to create the C files, compile it with the GCC I specify, and then it can continue on with the object files as it normally would (or just give them to me so I can link them)</p>



<a name="273376597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273376597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273376597">(Feb 27 2022 at 02:29)</a>:</h4>
<p>I do have it working if I manually invoke rustc, but that's a bit "annoying" when I have multiple codegen units and object files, especially with building something like libcore</p>



<a name="273378440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273378440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273378440">(Feb 27 2022 at 03:15)</a>:</h4>
<p>Wow! Got it!</p>
<div class="codehilite"><pre><span></span><code>pleb@gamey ~/foopietest $ make
RUSTFLAGS=&quot;--emit=llvm-ir&quot; cargo build --target riscv32i-unknown-none-elf -Zbuild-std=core --release
   Compiling core v0.0.0 (/home/pleb/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core)
   Compiling compiler_builtins v0.1.70
   Compiling rustc-std-workspace-core v1.99.0 (/home/pleb/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/rustc-std-workspace-core)
   Compiling foopietest v0.1.0 (/home/pleb/foopietest)
    Finished release [optimized] target(s) in 12.00s
llvm-link target/riscv32i-unknown-none-elf/release/deps/*.ll -o=whole_image.bc
llvm-extract whole_image.bc --func=_start --recursive -o=dced.bc
~/llvm-cbe/build/tools/llvm-cbe/llvm-cbe dced.bc
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![no_std]</span><span class="w"></span>
<span class="cp">#![no_main]</span><span class="w"></span>

<span class="cp">#[panic_handler]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">panic</span><span class="p">(</span><span class="n">_</span>: <span class="kp">&amp;</span><span class="nc">core</span>::<span class="n">panic</span>::<span class="n">PanicInfo</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">_start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">core</span>::<span class="n">ptr</span>::<span class="n">write_volatile</span><span class="p">(</span><span class="mh">0x1337</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x69</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/* Provide Declarations */</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="cp">#ifndef __cplusplus</span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="kt">bool</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="cp">#if defined(__GNUC__)</span>
<span class="cp">#define  __ATTRIBUTELIST__(x) __attribute__(x)</span>
<span class="cp">#else</span>
<span class="cp">#define  __ATTRIBUTELIST__(x)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef _MSC_VER  </span><span class="cm">/* Can only support "linkonce" vars with GCC */</span><span class="cp"></span>
<span class="cp">#define __attribute__(X)</span>
<span class="cp">#endif</span>



<span class="cm">/* Global Declarations */</span><span class="w"></span>

<span class="cm">/* Types Declarations */</span><span class="w"></span>

<span class="cm">/* Function definitions */</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">l_fptr_1</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>


<span class="cm">/* Types Definitions */</span><span class="w"></span>

<span class="cm">/* Function Declarations */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">__ATTRIBUTELIST__</span><span class="p">((</span><span class="n">nothrow</span><span class="p">));</span><span class="w"></span>


<span class="cm">/* LLVM Intrinsic Builtin Function Bodies */</span><span class="w"></span>


<span class="cm">/* Function Bodies */</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="o">*</span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)((</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="mi">4919</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">105u</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>



<a name="273378876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273378876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273378876">(Feb 27 2022 at 03:26)</a>:</h4>
<p>maybe mrustc could also work for your case. <a href="https://github.com/thepowersgang/mrustc">https://github.com/thepowersgang/mrustc</a></p>



<a name="273378885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273378885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273378885">(Feb 27 2022 at 03:27)</a>:</h4>
<p>I don't have an answer for you (I suspect there's no clean way to do this), but I'm interested in llvm-c, are you doing this with <a href="https://github.com/JuliaComputingOSS/llvm-cbe">https://github.com/JuliaComputingOSS/llvm-cbe</a> ? I hadn't realized that had gotten to the point where it was broadly usable, neat</p>



<a name="273378894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273378894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273378894">(Feb 27 2022 at 03:27)</a>:</h4>
<p>Also yeah, mrustc targets C, although it is of course less flexible than rustc in several ways.</p>



<a name="273379296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273379296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273379296">(Feb 27 2022 at 03:34)</a>:</h4>
<p>Wild! Safe language on a "weird" architecture</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![no_std]</span><span class="w"></span>
<span class="cp">#![no_main]</span><span class="w"></span>

<span class="cp">#[panic_handler]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">panic</span><span class="p">(</span><span class="n">_</span>: <span class="kp">&amp;</span><span class="nc">core</span>::<span class="n">panic</span>::<span class="n">PanicInfo</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">_start</span><span class="p">(</span><span class="n">idx</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">test_arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">test_arr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>00000004 &lt;__start&gt;:
   4:   10 32           P2 = R0;
   6:   49 e1 00 00     P1.H = 0x0;             /* (  0)        P1=0x0 &lt;_rust_begin_unwind&gt; */
   a:   67 01           [--SP] = RETS;
   c:   09 e1 00 00     P1.L = 0x0;             /* (  0)        P1=0x0 &lt;_rust_begin_unwind&gt; */
  10:   26 6f           SP += -0x1c;            /* (-28) */
  12:   08 91           R0 = [P1];
  14:   b0 b1           [SP + 0x18] = R0;
  16:   08 60           R0 = 0x1 (X);           /*              R0=0x1(  1) */
  18:   f0 b0           [SP + 0xc] = R0;
  1a:   10 60           R0 = 0x2 (X);           /*              R0=0x2(  2) */
  1c:   30 b1           [SP + 0x10] = R0;
  1e:   52 0e           CC = P2 &lt;= 0x2 (IU);
  20:   18 60           R0 = 0x3 (X);           /*              R0=0x3(  3) */
  22:   70 b1           [SP + 0x14] = R0;
  24:   0c 10           IF !CC JUMP 0x3c &lt;__start+0x38&gt;;
  26:   e0 68           P0 = 0x1c (X);          /*              P0=0x1c( 28) */
  28:   b2 a1           R2 = [SP + 0x18];
  2a:   30 5a           P0 = P0 + SP;
  2c:   09 91           R1 = [P1];
  2e:   90 5e           P2 = P0 + (P2 &lt;&lt; 0x2);
  30:   0a 08           CC = R2 == R1;
  32:   10 e4 fc ff     R0 = [P2 + -0x10];
  36:   0b 1c           IF CC JUMP 0x4c &lt;__start+0x48&gt; (BP);
  38:   ff e3 e4 ff     CALL 0x0 &lt;_rust_begin_unwind&gt;;
  3c:   42 e1 00 00     R2.H = 0x0;             /* (  0)        R2=0x0 &lt;_rust_begin_unwind&gt;(  0) */
  40:   02 e1 00 00     R2.L = 0x0;             /* (  0)        R2=0x0 &lt;_rust_begin_unwind&gt;(  0) */
  44:   19 60           R1 = 0x3 (X);           /*              R1=0x3(  3) */
  46:   42 30           R0 = P2;
  48:   ff e3 e0 ff     CALL 0x8 &lt;__start+0x4&gt;;
  4c:   e6 6c           SP += 0x1c;             /* ( 28) */
  4e:   27 01           RETS = [SP++];
  50:   10 00           RTS;
        ...

Disassembly of section .text.unlikely:

00000000 &lt;__ZN4core9panicking9panic_fmt17h364a8c8c4589d4d7E.constprop.0&gt;:
   0:   00 20           JUMP.S 0x0 &lt;__ZN4core9panicking9panic_fmt17h364a8c8c4589d4d7E.constprop.0&gt;;
        ...

00000004 &lt;__ZN4core9panicking9panic_fmt17h364a8c8c4589d4d7E&gt;:
   4:   00 20           JUMP.S 0x4 &lt;__ZN4core9panicking9panic_fmt17h364a8c8c4589d4d7E&gt;;
        ...

00000008 &lt;__ZN4core9panicking18panic_bounds_check17ha97f2ab1edbcca49E&gt;:
   8:   67 01           [--SP] = RETS;
   a:   a6 6f           SP += -0xc;             /* (-12) */
   c:   ff e3 fa ff     CALL 0x0 &lt;__ZN4core9panicking9panic_fmt17h364a8c8c4589d4d7E.constprop.0&gt;;
</code></pre></div>



<a name="273379323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273379323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273379323">(Feb 27 2022 at 03:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="209168">Thom Chiovoloni</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cargo.20.2B.20llvm-c/near/273378885">said</a>:</p>
<blockquote>
<p>I don't have an answer for you (I suspect there's no clean way to do this), but I'm interested in llvm-c, are you doing this with <a href="https://github.com/JuliaComputingOSS/llvm-cbe">https://github.com/JuliaComputingOSS/llvm-cbe</a> ? I hadn't realized that had gotten to the point where it was broadly usable, neat</p>
</blockquote>
<p>Yep, exactly! It fails on _many_ intrinsics, so the only reason this is really working is because of <code>llvm-extract</code> which removes anything that isn't used. I would suspect there would be early failure if you were to just dev normally, but if you're okay with dodging certain code shapes that result in certain intrinsics being emit you might be fine</p>



<a name="273379430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273379430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273379430">(Feb 27 2022 at 03:38)</a>:</h4>
<p>I don't think that <code>llvm-extract</code> works exactly as I expect here, but I could write something pretty fast to manually DCE the LLVM IR. <code>llvm-link</code> will produce one massive IR blob of the Rust code, and up to that point it should be universally supportive of anything done in Rust. The main part is pruning that down such that it doesn't use any unimplemented opcodes/intrinsics when it's passed to llvm-cbe</p>



<a name="273379444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273379444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273379444">(Feb 27 2022 at 03:39)</a>:</h4>
<p>By default, the resulting IL after <code>llvm-link</code> is pretty massive (contains all of core and compiler-builtins). I'm sure there's a good tool to remove anything that isn't used (perhaps it's a problem with functions being marked <code>no_mangle</code> and thus they don't get removed from the IL). Ultimately, for basic operations I think this should work fine. As long as you just use Rust as effectively... C with bounds checking :P</p>



<a name="273379526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273379526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273379526">(Feb 27 2022 at 03:41)</a>:</h4>
<p>I'm not familiar with LLVM IR, but if I try to <code>llvm-cbe</code> the whole blob, I get <code>LLVM ERROR: Code generator does not support intrinsic function 'llvm.abs.i32'</code>. This is technically never actually used if I were to DCE the entire IL, so I'm hoping there's some tool/thing I can do to rip this out (even if it's a regex to remove a "do not remove" flag or something on the IL)</p>



<a name="273379580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273379580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273379580">(Feb 27 2022 at 03:42)</a>:</h4>
<p>I'm not sure if there's a way to do <code>-Zbuild-std=core</code> _without_ having it pull in compiler builtins anymore, but that seems to be the main issue here</p>



<a name="273379593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273379593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273379593">(Feb 27 2022 at 03:43)</a>:</h4>
<div class="codehilite"><pre><span></span><code>; Function Attrs: minsize nofree nosync nounwind optsize readnone
define hidden double @__powidf2(double %a, i32 %b) unnamed_addr #4 {
start:
  %0 = tail call double @_ZN17compiler_builtins5float3pow9__powidf217h9848cde383b918e7E(double %a, i32 %b) #33
  ret double %0
}
</code></pre></div>
<p>This is the top-level function which results in <code>abs</code> being pulled in, and this function isn't used, nor is it referenced in a global anywhere. I'm not quite sure at what stage LLVM would be okay with removing a function like this</p>



<a name="273380124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380124">(Feb 27 2022 at 03:57)</a>:</h4>
<p><span class="user-mention" data-user-id="356799">@Brandon Falk</span> If LLVM can't target your architecture but GCC can, I think it'd be easier to port <code>rustc_codegen_gcc</code> to your architecture.</p>



<a name="273380184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380184">(Feb 27 2022 at 03:58)</a>:</h4>
<p>Ah, I was offput by it being a WIP, didn't know if it would be able to generate code yet, wasn't sure of its stage of dev</p>



<a name="273380445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380445">(Feb 27 2022 at 04:01)</a>:</h4>
<p>It generates code, and passes almost all of the testsuite.</p>



<a name="273380460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380460">(Feb 27 2022 at 04:01)</a>:</h4>
<p>I wouldn't call it production-ready, but I think it's likely to produce usable results more easily than trying to go by way of an LLVM C backend (which would <em>still</em> require porting Rust to understand your architecture's nuances).</p>



<a name="273380461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380461">(Feb 27 2022 at 04:01)</a>:</h4>
<p>Oh awesome. How much needs to be ported to a new architecture, given I can already build a gcc toolchain and such for my target?</p>



<a name="273380499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380499">(Feb 27 2022 at 04:02)</a>:</h4>
<p>Can you build libgccjit for your target?</p>



<a name="273380502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380502">(Feb 27 2022 at 04:02)</a>:</h4>
<p>Yeah, for sure. In this case it's just for a small hobby project</p>



<a name="273380505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380505">(Feb 27 2022 at 04:02)</a>:</h4>
<p>Not sure, trying now</p>



<a name="273380509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380509">(Feb 27 2022 at 04:02)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="404242">@antoyo</span></p>



<a name="273380523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380523">(Feb 27 2022 at 04:03)</a>:</h4>
<p>I tried to backpotr old LLVM blackfin codegen to modern LLVM and it was a mess :P I got LLVM to build, but it was definitely not "working"</p>



<a name="273380570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380570">(Feb 27 2022 at 04:03)</a>:</h4>
<p>What is the <code>jit</code> option for GCC? Is that emitting some form of IL from GCC which this consumes? I've never seen that option for <code>--enable-languages</code></p>



<a name="273380577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380577">(Feb 27 2022 at 04:03)</a>:</h4>
<p>Despite the name <code>libgccjit</code>, it's not JIT-specific; it's just the GCC code generation facilities pulled out into a library.</p>



<a name="273380632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380632">(Feb 27 2022 at 04:04)</a>:</h4>
<p>It's not a language, it's a separate library.</p>



<a name="273380634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380634">(Feb 27 2022 at 04:04)</a>:</h4>
<p>Ahhh, I see</p>



<a name="273380646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273380646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273380646">(Feb 27 2022 at 04:05)</a>:</h4>
<p>You'll need to build your toolchain with <code>--enable-host-shared</code> if you haven't already.</p>



<a name="273381246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273381246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273381246">(Feb 27 2022 at 04:22)</a>:</h4>
<p>No problem building with <code>--enable-host-shared</code> and <code>--enable-languages=c,jit</code>. Haven't tried the patches yet</p>



<a name="273383285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273383285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273383285">(Feb 27 2022 at 05:08)</a>:</h4>
<p>Seems to build fine with the patches, getting an error with <code>error occurred: Failed to find tool. Is </code>mips-linux-gnu-gcc<code> installed?</code> but I think it's due to some hackiness around using the MIPS target spec, so I'm installing that toolchain now</p>



<a name="273383357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273383357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273383357">(Feb 27 2022 at 05:11)</a>:</h4>
<p>I thought you were using blackfin, not MIPS?</p>



<a name="273383415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273383415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273383415">(Feb 27 2022 at 05:12)</a>:</h4>
<p>just following <a href="https://github.com/rust-lang/rustc_codegen_gcc#configuring-rustc_codegen_gcc">https://github.com/rust-lang/rustc_codegen_gcc#configuring-rustc_codegen_gcc</a></p>



<a name="273383428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273383428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273383428">(Feb 27 2022 at 05:13)</a>:</h4>
<p>my target is still bfin for the linker, the m68k example also sets it as mips in <a href="http://config.sh">config.sh</a></p>



<a name="273383684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273383684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273383684">(Feb 27 2022 at 05:19)</a>:</h4>
<p>Yeah, you might prefer a <a href="https://book.avr-rust.com/005.1-the-target-specification-json-file.html">target spec JSON file</a>.<br>
Also, those instructions might be a bit outdated, but the general idea is there.<br>
Feel free to ask any question.</p>



<a name="273383801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273383801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273383801">(Feb 27 2022 at 05:22)</a>:</h4>
<p>How would I go about building only core in this case, the target I have is technically <code>bfin-elf</code> where it's not actually Linux</p>



<a name="273383869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273383869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273383869">(Feb 27 2022 at 05:24)</a>:</h4>
<p><code>libgccjit.so: error: gcc_jit_context_new_call: mismatching types for argument 1 of function "__builtin_usub_overflow": assignment to param arg0 (type: unsigned int) from (unsigned long long)39 (type: unsigned long long)</code></p>



<a name="273383973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273383973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273383973">(Feb 27 2022 at 05:27)</a>:</h4>
<p>Seems to be the first error I'm hitting now that I'm starting to build the sysroot (past the mips error). Technically I haven't built a libc for the target in this case (just gcc) but I don't think that would cause this yet</p>



<a name="273384800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273384800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273384800">(Feb 27 2022 at 05:48)</a>:</h4>
<p>feels like a host vs target confusion</p>



<a name="273418972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273418972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> antoyo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273418972">(Feb 27 2022 at 18:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="356799">Brandon Falk</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cargo.20.2B.20llvm-c/near/273384800">said</a>:</p>
<blockquote>
<p>feels like a host vs target confusion</p>
</blockquote>
<p>Indeed. Can you please open an issue about this?</p>



<a name="273428177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273428177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273428177">(Feb 27 2022 at 22:12)</a>:</h4>
<p>Done <a href="https://github.com/rust-lang/rustc_codegen_gcc/issues/134">https://github.com/rust-lang/rustc_codegen_gcc/issues/134</a></p>



<a name="273428194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273428194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273428194">(Feb 27 2022 at 22:13)</a>:</h4>
<p>Building a toolchain for <code>m68k-unknown-linux-gnu</code> now so I can make sure it's not a weird issue in my environment. It sounds like this target should work?</p>



<a name="273428321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273428321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273428321">(Feb 27 2022 at 22:16)</a>:</h4>
<p>How important is a linux target with linux headers + glibc for this setup? Ideally I want to target embedded systems with just libcore + alloc</p>



<a name="273428539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273428539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273428539">(Feb 27 2022 at 22:22)</a>:</h4>
<p>It appears I have the same issue with m68k, so it must be some environment issue</p>



<a name="273429328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cargo%20%2B%20llvm-c/near/273429328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brandon Falk <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cargo.20.2B.20llvm-c.html#273429328">(Feb 27 2022 at 22:41)</a>:</h4>
<p>I'm building a very partial toolchain, only binutils <code>make &amp;&amp; make install</code> and then GCC with <code>make -j40 all-gcc &amp;&amp; make install-gcc</code>. Not sure if the lack of Linux headers, libc, etc would be the cause of this? I should have a complete m68k, I don't think that would lead to this problem</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>