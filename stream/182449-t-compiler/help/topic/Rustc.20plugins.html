<html>
<head><meta charset="utf-8"><title>Rustc plugins · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html">Rustc plugins</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249866126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/249866126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zie1ony <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#249866126">(Aug 18 2021 at 15:23)</a>:</h4>
<p>I'm exploring how to write a custom compiler plugin, but I can't find how to call rustc with the plugin file like this one: <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui-fulldeps/auxiliary/lint-for-crate.rs">https://github.com/rust-lang/rust/blob/master/src/test/ui-fulldeps/auxiliary/lint-for-crate.rs</a> I have found that building a clippy lint could help, but it would be better to have it as rustc plugin. Could someone help?</p>



<a name="249875486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/249875486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#249875486">(Aug 18 2021 at 16:29)</a>:</h4>
<p><span class="user-mention" data-user-id="433805">@zie1ony</span> The plugin interface is being phased out. It only exists yet because servo uses it. You should prefer using a custom rustc driver instead. This is what for example clippy does.</p>



<a name="249876444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/249876444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#249876444">(Aug 18 2021 at 16:36)</a>:</h4>
<p>If you want a relatively small example of a custom rustc driver, you can look at my codebase: <a href="https://github.com/willcrichton/flowistry">https://github.com/willcrichton/flowistry</a></p>
<p>In short, the general steps are:</p>
<ol>
<li>Define a top-level script that invokes <code>cargo check</code> with <code>RUSTC_WRAPPER</code> set to another script that will run your plugin. See <a href="https://github.com/willcrichton/flowistry/blob/a108bf67b01ad527b23d80ce2d9d6071564715af/src/bin/cargo-flowistry.rs"><code>cargo-flowistry.rs</code></a>.</li>
<li>Define a second-level script that prepares arguments from <code>cargo check</code> to give to your actual driver. See <a href="https://github.com/willcrichton/flowistry/blob/a108bf67b01ad527b23d80ce2d9d6071564715af/src/bin/flowistry-rustc.rs"><code>flowistry-rustc.rs</code></a>. </li>
<li>Define a final script that can either (a) act exactly like rustc, or (b) run your plugin. See <a href="https://github.com/willcrichton/flowistry/blob/a108bf67b01ad527b23d80ce2d9d6071564715af/src/bin/flowistry-driver.rs"><code>flowistry-driver.rs</code></a>.</li>
</ol>
<p>Then you can run <code>cargo flowistry --whatever --custom --args</code> within a codebase and your plugin will execute.</p>



<a name="250034306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250034306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> zie1ony <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250034306">(Aug 19 2021 at 19:12)</a>:</h4>
<p>Thanks.</p>



<a name="250812827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250812827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250812827">(Aug 26 2021 at 17:52)</a>:</h4>
<p>Has anyone figured out a good technique to figure out if the wrapper is being invoked on a top-level crate vs a dependency?</p>



<a name="250813156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250813156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250813156">(Aug 26 2021 at 17:54)</a>:</h4>
<p>what do you mean by top-level crate? in a workspace there are many crates written by the user</p>



<a name="250813196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250813196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250813196">(Aug 26 2021 at 17:55)</a>:</h4>
<p>if you want "not dependencies" you could hack it and check for <code>--cap-lints=allow</code>, since cargo only passes that to dependencies</p>



<a name="250814880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250814880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250814880">(Aug 26 2021 at 18:06)</a>:</h4>
<p>Yea I mean not dependency, a workspace member</p>



<a name="250814949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250814949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250814949">(Aug 26 2021 at 18:07)</a>:</h4>
<p>I only want to present the user with output for the workspace they are working on, not every transitive dependency</p>



<a name="250815227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250815227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250815227">(Aug 26 2021 at 18:08)</a>:</h4>
<p>all of these are cargo concepts, I don't think you can do this without depending on cargo's behavior in some way</p>



<a name="250815669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250815669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyd-dev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250815669">(Aug 26 2021 at 18:11)</a>:</h4>
<p>I think you can set  both <code>RUSTC</code> and <code>RUSTC_WORKSPACE_WRAPPER</code> to your wrapper and check if <code>std::env::args_os().nth(1)</code> is the value of <code>std::env::var_os("RUSTC")</code>.</p>



<a name="250817621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250817621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250817621">(Aug 26 2021 at 18:26)</a>:</h4>
<p>Sure; that still assumes you're using cargo</p>



<a name="250817684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250817684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250817684">(Aug 26 2021 at 18:26)</a>:</h4>
<p><span class="user-mention" data-user-id="312719">@Xavier Denis</span> if you make this a lint cargo will do it automatically, that's what cap-lints is for</p>



<a name="250818770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250818770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250818770">(Aug 26 2021 at 18:34)</a>:</h4>
<p>Yea this when I’m using cargo</p>



<a name="250818803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250818803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250818803">(Aug 26 2021 at 18:35)</a>:</h4>
<p>I just want to figure out a way for cargo to signal my wrapper</p>



<a name="250818855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250818855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250818855">(Aug 26 2021 at 18:35)</a>:</h4>
<p>Though perhaps I’ll just see if cargo asks for metadata output from rustc</p>



<a name="250818881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Rustc%20plugins/near/250818881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Rustc.20plugins.html#250818881">(Aug 26 2021 at 18:35)</a>:</h4>
<p>Or if it asks for binary output</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>