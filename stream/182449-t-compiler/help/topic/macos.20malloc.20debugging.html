<html>
<head><meta charset="utf-8"><title>macos malloc debugging · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html">macos malloc debugging</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263955993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/263955993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#263955993">(Dec 07 2021 at 04:00)</a>:</h4>
<p>Is anyone around here knowledgeable about debugging malloc issues with the default macOS allocator? Several users (and myself) are reporting a problem where rustc built without jemalloc often crashes with SIGABORT with the following:</p>
<p>rustc(74427,0x700008ae8000) malloc: *** error for object 0x60000400bc00: pointer being realloc'd was not allocated<br>
rustc(74427,0x700008ae8000) malloc: *** set a breakpoint in malloc_error_break to debug</p>
<p>We have a backtrace, with the relevant frames being:</p>
<div class="codehilite"><pre><span></span><code>frame #5: 0x00007ff8197b1542 libsystem_malloc.dylib`realloc + 328
frame #6: 0x000000010b3df6f4 librustc_driver-e74dfddec80dd206.dylib`alloc::raw_vec::finish_grow::h95b47d0479269564 + 52
frame #7: 0x000000010beaaaad librustc_driver-e74dfddec80dd206.dylib`alloc::raw_vec::RawVec$LT$T$C$A$GT$::reserve::do_reserve_and_handle::h9a25a6cccb7e4cb0 + 125
frame #8: 0x000000010b35053e librustc_driver-e74dfddec80dd206.dylib`rustc_expand::mbe::quoted::parse::h1bce1dc409525940 + 910
frame #9: 0x000000010b35033b librustc_driver-e74dfddec80dd206.dylib`rustc_expand::mbe::quoted::parse::h1bce1dc409525940 + 395
</code></pre></div>

<p>I can easily reproduce.  However, I haven't been able to reproduce with debug enabled.  I've been playing with the various Malloc* environment variables, but they haven't provided any insight.</p>



<a name="263956542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/263956542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#263956542">(Dec 07 2021 at 04:11)</a>:</h4>
<p>Smells like a problem where there are two different allocators in play, and a pointer produced by one gets given to the other. But I don't know how/why that would occur in the scenario you described</p>



<a name="263956663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/263956663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#263956663">(Dec 07 2021 at 04:14)</a>:</h4>
<p>There's a rayon issue like that too:<br>
<a href="https://github.com/rayon-rs/rayon/issues/901">https://github.com/rayon-rs/rayon/issues/901</a></p>



<a name="263959865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/263959865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#263959865">(Dec 07 2021 at 05:19)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> That message is created in a use-after-free.  I think that is a more likely candidate than multiple allocators being involved.</p>



<a name="263959889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/263959889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#263959889">(Dec 07 2021 at 05:19)</a>:</h4>
<p>Yep, that'll do it too</p>



<a name="263959944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/263959944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#263959944">(Dec 07 2021 at 05:20)</a>:</h4>
<p>Weird combination to have a vector that is freed and then resized</p>



<a name="263962597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/263962597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#263962597">(Dec 07 2021 at 06:08)</a>:</h4>
<p>Not sure if this is the issue but... it's very hard to swap out the default allocator on macOS.</p>
<p>System APIs will allocate memory out of the zones and pass it to free (one example: <a href="https://github.com/opensource-apple/objc4/blob/master/runtime/hashtable2.mm#L64-L68">https://github.com/opensource-apple/objc4/blob/master/runtime/hashtable2.mm#L64-L68</a>). The allocations here often happen inside DYLD and run prior to process startup, before you have a chance to replace the default zone.</p>
<p>Note that this is more-or-less documented here: <a href="https://opensource.apple.com/source/Libc/Libc-825.26/include/malloc/malloc.h.auto.html">https://opensource.apple.com/source/Libc/Libc-825.26/include/malloc/malloc.h.auto.html</a> on the doc for <code>size</code>:</p>
<blockquote>
<p>returns the size of a block or 0 if not in this zone; must be fast, especially for negative answers</p>
</blockquote>
<p>The expectation is:</p>
<ul>
<li>
<p>If you replace <code>free</code>, it has to do the same thing as the default <code>free</code>, and walk the list of all registered zones and ask each one if it's the owner of the allocation, freeing it with the first one that  returns a positive size. This is very slow, and is why <code>free</code> on macOS has such terrible perf.</p>
<p>In practice you can <em>sometimes</em> get around it by interposing more aggressively, e.g. <a href="https://github.com/microsoft/mimalloc/issues/313">https://github.com/microsoft/mimalloc/issues/313</a>, but I suspect there could still be system APIs which walk the zone list, grab some non-default zone (the purgeable zone or something, perhaps), and then free with global free.</p>
</li>
<li>
<p>If you replace the global allocator by installing a zone, it must be able to detect when the pointer being freed did not come from it. This is unlike most fast mallocs, which treat it as UB to free something not allocated.</p>
</li>
</ul>
<p>This is a pretty abysmal situation for the userspace allocation on macOS, and I believe is part of why the swift compiler just leaks all allocations. Free is too slow (unlikely to be viable for us, ofc).</p>



<a name="264003866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/264003866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#264003866">(Dec 07 2021 at 13:54)</a>:</h4>
<p>It would be interesting to see how much the max RSS changes by just never dropping anything - rustc already uses an arena allocator so I can believe it might not increase it that much</p>



<a name="264015263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/264015263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#264015263">(Dec 07 2021 at 15:19)</a>:</h4>
<p>Compiling the <code>core</code> crate did 8.46GiB malloc allocations on my system.  Not as much as I expected, though I suspect that doesn't include mmap stuff.</p>



<a name="264020218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/264020218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#264020218">(Dec 07 2021 at 15:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/macos.20malloc.20debugging/near/264003866">said</a>:</p>
<blockquote>
<p>It would be interesting to see how much the max RSS changes by just never dropping anything - rustc already uses an arena allocator so I can believe it might not increase it that much</p>
</blockquote>
<p>That would make rls leak memory.</p>



<a name="264021829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/264021829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#264021829">(Dec 07 2021 at 16:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/macos.20malloc.20debugging/near/264020218">said</a>:</p>
<blockquote>
<p>That would make rls leak memory.</p>
</blockquote>
<p>I believe RLS on linux already has very significant leaks (<a href="https://github.com/rust-lang/rust/issues/56980">#56980</a>).</p>



<a name="264025440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/264025440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#264025440">(Dec 07 2021 at 16:23)</a>:</h4>
<p>I just read that issue and it looks like it was caused by an allocator update and not by a leak inside rustc itself.</p>



<a name="264049745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/macos%20malloc%20debugging/near/264049745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/macos.20malloc.20debugging.html#264049745">(Dec 07 2021 at 18:32)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> sure - I think the experiment alone is interesting though. If it's feasible for rustc we could make it opt-out so RLS can turn it off.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>