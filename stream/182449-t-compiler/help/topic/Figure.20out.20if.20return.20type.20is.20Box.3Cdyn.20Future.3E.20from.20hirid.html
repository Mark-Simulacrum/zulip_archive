<html>
<head><meta charset="utf-8"><title>Figure out if return type is Box&lt;dyn Future&gt; from hirid · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Figure.20out.20if.20return.20type.20is.20Box.3Cdyn.20Future.3E.20from.20hirid.html">Figure out if return type is Box&lt;dyn Future&gt; from hirid</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256480897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Figure%20out%20if%20return%20type%20is%20Box%3Cdyn%20Future%3E%20from%20hirid/near/256480897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Figure.20out.20if.20return.20type.20is.20Box.3Cdyn.20Future.3E.20from.20hirid.html#256480897">(Oct 06 2021 at 20:43)</a>:</h4>
<p>Best way to figure out if fn's return type is Box&lt;dyn Future&gt; or impl Future in check_attrs(so from a HirId)</p>
<p>context: <a href="https://github.com/rust-lang/rust/pull/89610/files">https://github.com/rust-lang/rust/pull/89610/files</a></p>
<p>I have this working for checking if the fn is async, and from <a href="https://github.com/rust-lang/rust/pull/76765/files">https://github.com/rust-lang/rust/pull/76765/files</a> I can even unpack and check what type the async fn is returning, but I am unsure how to check if I am returning a Box&lt;dyn Future&gt; or an impl Future without doing path shenanigans in hir. As far as I can tell, check_attrs and typechecking are both Providers, is there some way I can get access to the rustc_middle::Ty of a function's return value from the hirid?</p>



<a name="256483067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Figure%20out%20if%20return%20type%20is%20Box%3Cdyn%20Future%3E%20from%20hirid/near/256483067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Figure.20out.20if.20return.20type.20is.20Box.3Cdyn.20Future.3E.20from.20hirid.html#256483067">(Oct 06 2021 at 20:55)</a>:</h4>
<p>Hmm it seems that perhaps <code>clippy</code> is the best place to place this lint?</p>



<a name="256484163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Figure%20out%20if%20return%20type%20is%20Box%3Cdyn%20Future%3E%20from%20hirid/near/256484163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Figure.20out.20if.20return.20type.20is.20Box.3Cdyn.20Future.3E.20from.20hirid.html#256484163">(Oct 06 2021 at 21:02)</a>:</h4>
<p>s/lint/warning</p>



<a name="256486409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Figure%20out%20if%20return%20type%20is%20Box%3Cdyn%20Future%3E%20from%20hirid/near/256486409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Figure.20out.20if.20return.20type.20is.20Box.3Cdyn.20Future.3E.20from.20hirid.html#256486409">(Oct 06 2021 at 21:17)</a>:</h4>
<p>It's not incorrect for a function returning <code>Box&lt;dyn Future&gt;</code> to use<code>#[must_use]</code></p>



<a name="256486685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Figure%20out%20if%20return%20type%20is%20Box%3Cdyn%20Future%3E%20from%20hirid/near/256486685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Figure.20out.20if.20return.20type.20is.20Box.3Cdyn.20Future.3E.20from.20hirid.html#256486685">(Oct 06 2021 at 21:19)</a>:</h4>
<p>It's unnecessary since <code>Future</code> is already <code>#[must_use]</code>, but we don't warn about unnecessary <code>#[must_use]</code>s on functions returning <code>Result</code> either.</p>



<a name="256490838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Figure%20out%20if%20return%20type%20is%20Box%3Cdyn%20Future%3E%20from%20hirid/near/256490838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Figure.20out.20if.20return.20type.20is.20Box.3Cdyn.20Future.3E.20from.20hirid.html#256490838">(Oct 06 2021 at 21:54)</a>:</h4>
<p>Hmm, I suppose you are right, async fn's make it look like must_use works on the returned value, but <code>impl Future</code> and boxed dyn futures look less so. However, it would be nice to warn on a must use on a trait method annotated by the <code>async-trait</code> macro</p>



<a name="256491223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Figure%20out%20if%20return%20type%20is%20Box%3Cdyn%20Future%3E%20from%20hirid/near/256491223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Figure.20out.20if.20return.20type.20is.20Box.3Cdyn.20Future.3E.20from.20hirid.html#256491223">(Oct 06 2021 at 21:58)</a>:</h4>
<p>I think async_trait could just recognize<code>#[must_use]</code> and add it to the async function, then your lint in <a href="https://github.com/rust-lang/rust/issues/89610">#89610</a> will fire.</p>



<a name="256492901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Figure%20out%20if%20return%20type%20is%20Box%3Cdyn%20Future%3E%20from%20hirid/near/256492901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Figure.20out.20if.20return.20type.20is.20Box.3Cdyn.20Future.3E.20from.20hirid.html#256492901">(Oct 06 2021 at 22:13)</a>:</h4>
<p>Oh add it to the async fn it generates?</p>



<a name="256493782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Figure%20out%20if%20return%20type%20is%20Box%3Cdyn%20Future%3E%20from%20hirid/near/256493782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Figure.20out.20if.20return.20type.20is.20Box.3Cdyn.20Future.3E.20from.20hirid.html#256493782">(Oct 06 2021 at 22:20)</a>:</h4>
<p>Yep</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>