<html>
<head><meta charset="utf-8"><title>Bootstrapping with new lints · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html">Bootstrapping with new lints</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="249635485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249635485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249635485">(Aug 16 2021 at 19:27)</a>:</h4>
<p>I'm adding a new compiler lint, and it happens to trigger a warning for a method in <code>core</code> when building with stage 1. I can't <code>#[allow(my_lint)]</code>, because then I get "unknown lint" when compiling stage 0. Is there a way to work around this?</p>



<a name="249635738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249635738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249635738">(Aug 16 2021 at 19:29)</a>:</h4>
<p><code>#[allow(warnings)]</code> works for my testing purposes, but I doubt that's the preferred solution.</p>



<a name="249636377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249636377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249636377">(Aug 16 2021 at 19:34)</a>:</h4>
<p>You can use <code>#[cfg_attr(not(bootstrap), allow(my_lint))]</code>.</p>



<a name="249682042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249682042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249682042">(Aug 17 2021 at 06:10)</a>:</h4>
<p><span class="user-mention" data-user-id="363998">@Ibraheem Ahmed</span> In general, I don't think we would want a lint enabled by default if it triggers on code in the standard library. Would it be possible to just fix the standard library first to not trigger the lint?</p>



<a name="249682102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249682102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249682102">(Aug 17 2021 at 06:10)</a>:</h4>
<p>Or alternatively, introduce it as allow-by-default first and then upgrade it to warn or deny later?</p>



<a name="249734161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249734161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249734161">(Aug 17 2021 at 15:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Bootstrapping.20with.20new.20lints/near/249682042">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="363998">Ibraheem Ahmed</span> In general, I don't think we would want a lint enabled by default if it triggers on code in the standard library. Would it be possible to just fix the standard library first to not trigger the lint?</p>
</blockquote>
<p>Oh, it's a lint for duplicate bounds, and it triggered on a weird try trait bound that was meant to reduce breakage on nightly.</p>



<a name="249734208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249734208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249734208">(Aug 17 2021 at 15:20)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">try_find</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="bp">Self</span>::<span class="n">Item</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="bp">Self</span>: <span class="nb">Sized</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">Self</span>::<span class="n">Item</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">R</span>: <span class="nc">Try</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="c1">// FIXME: This bound is rather strange, but means minimal breakage on nightly.</span>
<span class="w">    </span><span class="c1">// See #85115 for the issue tracking a holistic solution for this and try_map.</span>
<span class="w">    </span><span class="n">R</span>: <span class="nc">crate</span>::<span class="n">ops</span>::<span class="n">TryV2</span><span class="o">&lt;</span><span class="n">Residual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="k">crate</span>::<span class="n">convert</span>::<span class="n">Infallible</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="249736458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249736458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249736458">(Aug 17 2021 at 15:36)</a>:</h4>
<p>I'm not sure why it triggered the lint, because the bounds are different.</p>



<a name="249736599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249736599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249736599">(Aug 17 2021 at 15:37)</a>:</h4>
<p>I actually realized that this is a bug in the lint, it compares the resolution of the trait bound's path to check equality.</p>



<a name="249736691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249736691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249736691">(Aug 17 2021 at 15:38)</a>:</h4>
<p>And I think I would have to check the path segments instead?</p>



<a name="249737141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249737141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249737141">(Aug 17 2021 at 15:41)</a>:</h4>
<p>Checking the resolution of the path seems like the right thing to do</p>



<a name="249737381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249737381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249737381">(Aug 17 2021 at 15:43)</a>:</h4>
<p><span class="user-mention" data-user-id="363998">@Ibraheem Ahmed</span> I think that's a legitimate case being caught by our lint - at least under <code>cfg(not(bootstrap))</code>, you should be able to get rid of the <code>TryV2</code> bound</p>



<a name="249737491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249737491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249737491">(Aug 17 2021 at 15:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Bootstrapping.20with.20new.20lints/near/249737141">said</a>:</p>
<blockquote>
<p>Checking the resolution of the path seems like the right thing to do</p>
</blockquote>
<p>That triggers false positives when different generics are inolved <code>fn foo&lt;T: AsRef&lt;str&gt; + AsRef&lt;OsStr&gt;() {}</code></p>



<a name="249737567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249737567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249737567">(Aug 17 2021 at 15:44)</a>:</h4>
<p>Can you compare the resolved generic parameters as well?</p>



<a name="249738049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249738049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249738049">(Aug 17 2021 at 15:48)</a>:</h4>
<p>That would be <code>Path.segments.args.args</code> right?</p>



<a name="249738110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249738110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249738110">(Aug 17 2021 at 15:48)</a>:</h4>
<p><code>GenericArg</code> doesn't seem to implement <code>Eq</code></p>



<a name="249738190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249738190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249738190">(Aug 17 2021 at 15:49)</a>:</h4>
<p>are you looking at the HIR <code>GenericArg</code>? You'll want the one from <code>rustc_middle</code></p>



<a name="249738236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249738236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249738236">(Aug 17 2021 at 15:49)</a>:</h4>
<p>how are you currently resolving the trait path?</p>



<a name="249738331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249738331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249738331">(Aug 17 2021 at 15:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Bootstrapping.20with.20new.20lints/near/249738190">said</a>:</p>
<blockquote>
<p>are you looking at the HIR <code>GenericArg</code>? You'll want the one from <code>rustc_middle</code></p>
</blockquote>
<p>Oh, how do I get access to rustc_middle from a <code>LateLintPass</code>?</p>



<a name="249738360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249738360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249738360">(Aug 17 2021 at 15:50)</a>:</h4>
<p>Can you share your current code?</p>



<a name="249738389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249738389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249738389">(Aug 17 2021 at 15:50)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/88096">https://github.com/rust-lang/rust/pull/88096</a></p>



<a name="249738420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/249738420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#249738420">(Aug 17 2021 at 15:50)</a>:</h4>
<p>It's mostly based of the clippy lint.</p>



<a name="250021680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/250021680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#250021680">(Aug 19 2021 at 17:51)</a>:</h4>
<p><span class="user-mention" data-user-id="125294">@Aaron Hill</span> any thoughts on how I can get this to work?</p>



<a name="250021703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Bootstrapping%20with%20new%20lints/near/250021703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Bootstrapping.20with.20new.20lints.html#250021703">(Aug 19 2021 at 17:51)</a>:</h4>
<p>I'll take a look</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>