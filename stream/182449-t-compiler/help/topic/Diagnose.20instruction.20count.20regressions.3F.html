<html>
<head><meta charset="utf-8"><title>Diagnose instruction count regressions? · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html">Diagnose instruction count regressions?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252527895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252527895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252527895">(Sep 08 2021 at 20:31)</a>:</h4>
<p>I have two PRs with instruction count regressions. Can anyone offer tips for diagnosing these? Is there a way to narrow down where in the code more instructions are generated?</p>



<a name="252529795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252529795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252529795">(Sep 08 2021 at 20:45)</a>:</h4>
<p>if they're big then the timing breakdown when you click on the results can be informative</p>



<a name="252530171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252530171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252530171">(Sep 08 2021 at 20:47)</a>:</h4>
<p>If they're small then running the benchmarks under perf locally and diff the results can work, but that's very fickle due to inlining changes, PGO etc. I have had success with that but also "i don't know, inlining probably changed" non-results.</p>



<a name="252530239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252530239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252530239">(Sep 08 2021 at 20:48)</a>:</h4>
<p>they are pretty small<br>
<a href="https://perf.rust-lang.org/compare.html?start=a3956106d12cebec91be0637759e29ab6908b4cd&amp;end=c2a408840ad18f74280805535f0b7193528ff3df&amp;stat=instructions:u">https://perf.rust-lang.org/compare.html?start=a3956106d12cebec91be0637759e29ab6908b4cd&amp;end=c2a408840ad18f74280805535f0b7193528ff3df&amp;stat=instructions:u</a><br>
<a href="https://perf.rust-lang.org/compare.html?start=a49e38e672c60da788360e088f00ad12353e3913&amp;end=de42550d0ac525f44ec79300a1cb349ade181c1a&amp;stat=instructions:u">https://perf.rust-lang.org/compare.html?start=a49e38e672c60da788360e088f00ad12353e3913&amp;end=de42550d0ac525f44ec79300a1cb349ade181c1a&amp;stat=instructions:u</a></p>



<a name="252530434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252530434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252530434">(Sep 08 2021 at 20:49)</a>:</h4>
<p>What about a MIR dump of a whole crate?</p>



<a name="252530482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252530482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252530482">(Sep 08 2021 at 20:49)</a>:</h4>
<p>3% for incr-patched isn't small. style-servo-debug details seem to be clear enough, it's spending more time in llvm. comparing IR or llvm-lines can help</p>



<a name="252530795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252530795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252530795">(Sep 08 2021 at 20:51)</a>:</h4>
<p>Sometimes that can be fine because llvm just sees more that it can optimize. do you have runtime benchmarks that might justify the compile time regression?</p>



<a name="252531327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252531327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252531327">(Sep 08 2021 at 20:56)</a>:</h4>
<p>I posted a local benchmark in the pr <a href="https://github.com/rust-lang/rust/pull/83302">https://github.com/rust-lang/rust/pull/83302</a></p>



<a name="252531391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252531391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252531391">(Sep 08 2021 at 20:56)</a>:</h4>
<p>I always wonder about the helpfulness of the perf run.</p>



<a name="252531429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252531429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252531429">(Sep 08 2021 at 20:56)</a>:</h4>
<p>On one hand we do want fast compilation, but on the other hand most of time we care more about runtime of the compiled binary.</p>



<a name="252531619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252531619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252531619">(Sep 08 2021 at 20:58)</a>:</h4>
<p>I've seen quite a few cases where only LLVM time regresses.</p>



<a name="252531630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252531630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252531630">(Sep 08 2021 at 20:58)</a>:</h4>
<p>Those benches don't seem informative. Anything smaller than 1.5x improvement is suspicious imo because they measure wall-time so turbo-clocks or even minor changes in compilation can change the results.</p>



<a name="252531814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252531814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252531814">(Sep 08 2021 at 20:59)</a>:</h4>
<p><span class="user-mention" data-user-id="303710">@Gary Guo</span> compile time regressions can be acceptable if you get something significant for them in exchange, e.g. new features, critical bug fixes or runtime performance.</p>



<a name="252531890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252531890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252531890">(Sep 08 2021 at 21:00)</a>:</h4>
<p>but especially the last point needs to be demonstrated</p>



<a name="252531974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252531974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252531974">(Sep 08 2021 at 21:00)</a>:</h4>
<p>Do we have a tool to measure that though?</p>



<a name="252532350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252532350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252532350">(Sep 08 2021 at 21:02)</a>:</h4>
<p>well, sometimes library improvements that improve runtime also improve compiler runtime if it's heavily used in the compiler. if that's not the case you need benchmarks and we only have <code>#[bench]</code> for that out of the box. you could write external benchmarks with a crate that does instruction/cycle counts.</p>



<a name="252532455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252532455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252532455">(Sep 08 2021 at 21:03)</a>:</h4>
<p>There has been talk about adding runtime benchmarks in <a class="stream" data-stream-id="247081" href="/#narrow/stream/247081-t-compiler.2Fperformance">#t-compiler/performance</a> but idk how concrete the plans are.</p>



<a name="252534012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252534012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252534012">(Sep 08 2021 at 21:14)</a>:</h4>
<p>oh so there actually are two changes in that PR? one that changes the write! impl and one that changes the macro expansion? if the expansion makes things worse without a benefit then is there any reason to not limit the PR to the former?</p>



<a name="252534431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252534431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252534431">(Sep 08 2021 at 21:15)</a>:</h4>
<p>Maybe. Changing the write impl made <code>Arguments</code> more unsafe, so <code>Arguments::new_v1</code> was made unsafe, and then <code>format_args!</code> was changed to add an unsafe block.</p>



<a name="252534758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252534758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252534758">(Sep 08 2021 at 21:18)</a>:</h4>
<p>So maybe we can get away without <code>unsafe</code> since it's already an unstable feature.</p>



<a name="252534816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252534816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252534816">(Sep 08 2021 at 21:18)</a>:</h4>
<p>you could at least do a perf run in isolation to see what the impact is on its own</p>



<a name="252534847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252534847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252534847">(Sep 08 2021 at 21:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="360405">Cameron Steffen</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Diagnose.20instruction.20count.20regressions.3F/near/252534758">said</a>:</p>
<blockquote>
<p>So maybe we can get away without <code>unsafe</code> since it's already an unstable feature.</p>
</blockquote>
<p>Ideally we shouldn't rely on feature gating for safety</p>



<a name="252534877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252534877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252534877">(Sep 08 2021 at 21:19)</a>:</h4>
<p>I did that here <a href="https://github.com/rust-lang/rust/pull/88571">https://github.com/rust-lang/rust/pull/88571</a></p>



<a name="252535125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252535125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252535125">(Sep 08 2021 at 21:21)</a>:</h4>
<p>I meant the <code>write!</code> changes</p>



<a name="252535129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252535129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252535129">(Sep 08 2021 at 21:21)</a>:</h4>
<p>well that is a test of reverting the macro change. I didn't do a run testing just the write impl change.</p>



<a name="252535142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Diagnose%20instruction%20count%20regressions%3F/near/252535142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Cameron Steffen <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Diagnose.20instruction.20count.20regressions.3F.html#252535142">(Sep 08 2021 at 21:21)</a>:</h4>
<p>ya...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>