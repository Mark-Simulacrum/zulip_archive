<html>
<head><meta charset="utf-8"><title>auto traits + specialization = problem with trait selection · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/auto.20traits.20.2B.20specialization.20.3D.20problem.20with.20trait.20selection.html">auto traits + specialization = problem with trait selection</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260558779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/auto%20traits%20%2B%20specialization%20%3D%20problem%20with%20trait%20selection/near/260558779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/auto.20traits.20.2B.20specialization.20.3D.20problem.20with.20trait.20selection.html#260558779">(Nov 07 2021 at 07:06)</a>:</h4>
<p>Hey all, I've opened <a href="https://github.com/rust-lang/rust/issues/90665">#90655</a> to track a shortcoming in the compiler diagnostics that I believe has much deeper roots in the trait selection system. There seems to be a bad interaction between auto traits and specialization that causes trait selection to fail to see that there is a missing auto trait obligation.</p>



<a name="260558782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/auto%20traits%20%2B%20specialization%20%3D%20problem%20with%20trait%20selection/near/260558782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/auto.20traits.20.2B.20specialization.20.3D.20problem.20with.20trait.20selection.html#260558782">(Nov 07 2021 at 07:07)</a>:</h4>
<p>I'm in <em>way</em> over my head with all of this. I had initially hoped that the diagnostic could be improved by just beefing up <code>rustc_trait_selection::traits::error_reporting</code>, but I found out that the problem exists somewhere in trait fulfillment.</p>



<a name="260558838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/auto%20traits%20%2B%20specialization%20%3D%20problem%20with%20trait%20selection/near/260558838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/auto.20traits.20.2B.20specialization.20.3D.20problem.20with.20trait.20selection.html#260558838">(Nov 07 2021 at 07:08)</a>:</h4>
<p>Getting this fixed is somewhat urgent for me. I first encountered this problem when working with a hacked version of <code>std::result::Result</code> that has a specialized <code>FromResidual</code> implementation. You can see a minimal reproduction of that use case in Example 4 of <a href="https://github.com/rust-lang/rust/issues/90601">#90601</a>. This specialized <code>Result</code> type is going to power <a href="https://ziglang.org/documentation/master/#Error-Return-Traces">return</a> <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate">tracing</a> for errors in our Rust code at Qumulo (where I work). But until these error messages are improved, our developers will be scratching their heads any time they forget to add the proper <code>From</code> impl for their error types, because all they will get from the compiler is:</p>
<blockquote>
<p>the <code>?</code> operator can only be used in a function that returns <code>Result</code> or <code>Option</code></p>
</blockquote>



<a name="260558841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/auto%20traits%20%2B%20specialization%20%3D%20problem%20with%20trait%20selection/near/260558841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/auto.20traits.20.2B.20specialization.20.3D.20problem.20with.20trait.20selection.html#260558841">(Nov 07 2021 at 07:08)</a>:</h4>
<p>So with all that said, I'm hoping there's somebody who knows roughly how this could be improved and could guide me to the proper places in the trait fulfillment code. What I really want to know is, is this even going to be possible to improve without major changes?</p>



<a name="260722510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/auto%20traits%20%2B%20specialization%20%3D%20problem%20with%20trait%20selection/near/260722510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/auto.20traits.20.2B.20specialization.20.3D.20problem.20with.20trait.20selection.html#260722510">(Nov 08 2021 at 21:38)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <span class="user-mention" data-user-id="116118">@Matthew Jasper</span> I'm told that you would be pretty knowledgeable on trait selection. I understand it may take some time until you can look more closely at this, but I would really appreciate your input on what could be done to improve things here, whenever you get a chance.</p>
<p>The impact of this has spread beyond my place of work and into <a class="stream" data-stream-id="257204" href="/#narrow/stream/257204-project-error-handling">#project-error-handling</a>, where I'm trying to put together a crate that combines auto traits and specialization to enable easy return tracing for errors: <a href="#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/260720556">https://rust-lang.zulipchat.com/#narrow/stream/257204-project-error-handling/topic/track_caller.20error.20crate/near/260720556</a></p>



<a name="260985708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/auto%20traits%20%2B%20specialization%20%3D%20problem%20with%20trait%20selection/near/260985708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/auto.20traits.20.2B.20specialization.20.3D.20problem.20with.20trait.20selection.html#260985708">(Nov 10 2021 at 13:05)</a>:</h4>
<p>It's hard to give a good answer to this. This isn't the only problem with the current specialization implementation and any fix would only really make sense as part of a larger rework. Unfortunately I don't think there's anyone on the lang or compiler teams that's trying to move this forwards. I'm not even sure if the extent of the problems with the current version of specialization is either well know or agreed upon.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>