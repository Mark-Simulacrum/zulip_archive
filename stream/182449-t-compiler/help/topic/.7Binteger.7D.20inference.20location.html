<html>
<head><meta charset="utf-8"><title>{integer} inference location · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html">{integer} inference location</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276811581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276811581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276811581">(Mar 27 2022 at 22:34)</a>:</h4>
<p>Can anyone point me to the code that turns <code>{integer}</code> into a concrete type? For unsuffixed values if it matters.</p>



<a name="276811587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276811587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276811587">(Mar 27 2022 at 22:34)</a>:</h4>
<p>I'd like to play around with the possibility of nonzero integer literals.</p>



<a name="276811608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276811608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276811608">(Mar 27 2022 at 22:35)</a>:</h4>
<p>at what point? There's code that defaults uninferred <code>{integer}</code>s to i32, and then there's regular inference which simply equates a type variable to some concrete type the same way as every other uninferred type variable is.</p>



<a name="276811675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276811675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276811675">(Mar 27 2022 at 22:37)</a>:</h4>
<p>The latter, I think. I certainly don't intend on changing the fallback type <em>but</em> would like to be able to choose which type if multiple are possible. That's not a strict requirement for now, at least.</p>



<a name="276811783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276811783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276811783">(Mar 27 2022 at 22:40)</a>:</h4>
<p>I don't know the infer code super well, but AFAIK there isn't a specific part of the code you can change here, since it just goes through the regular full blown InferCx code.</p>



<a name="276811790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276811790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276811790">(Mar 27 2022 at 22:40)</a>:</h4>
<p>First: I would love to have better literal functionality.</p>
<p>Here's the (officially minor) breaking change that I expect you'll run into, though:</p>
<p>This compiles today, as <code>{integer}</code> can only be <code>u32</code>: &lt;<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=a475948b9de717c62c31dda8f941ab33">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=a475948b9de717c62c31dda8f941ab33</a>&gt;</p>
<p>But I suspect it would break if <code>{integer}</code> could also be <code>NonZeroU32</code>, the same way this similar example breaks when <code>{integer}</code> could be <code>u32</code> or <code>u64</code>: &lt;<a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=f8803efdfbf0d1adc0999593f01e0a75">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=f8803efdfbf0d1adc0999593f01e0a75</a>&gt;</p>



<a name="276811808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276811808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276811808">(Mar 27 2022 at 22:41)</a>:</h4>
<p>I absolutely expect to run into that case, which is why I mention a potential fallback (being to the zero-able integer). I know fallback is a touchy subject that's been long-considered.</p>



<a name="276811855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276811855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276811855">(Mar 27 2022 at 22:42)</a>:</h4>
<p>I guess one way to approach this would be to tell the compiler that <code>NonZeroX</code> is an <code>{integer}</code>?</p>



<a name="276811943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276811943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276811943">(Mar 27 2022 at 22:45)</a>:</h4>
<p>The keyword you're looking for is <code>IntVar</code> and <code>fn is_integral</code>, if you want to do that.</p>



<a name="276811991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276811991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276811991">(Mar 27 2022 at 22:46)</a>:</h4>
<p>Also <code>fn unify_integral_variable</code> I guess.</p>



<a name="276812000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276812000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276812000">(Mar 27 2022 at 22:46)</a>:</h4>
<p>Thanks. Gives me a starting point <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="276845767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276845767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276845767">(Mar 28 2022 at 09:13)</a>:</h4>
<p>I think we should not allow implicit fallback to more types. Instead we could add ranges to IntVar and allow what would currently be a type mismatch error between <code>{integer}</code> and <code>NonZero</code> if the range does not contain zero. It's a bit iffy if you'd have generic nonzero types, but for the explicit ones this seems like it would not cause problems and allow literals for the nonzero types</p>



<a name="276915044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276915044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276915044">(Mar 28 2022 at 18:41)</a>:</h4>
<p>Honestly the first problem for me is figuring out how to permit nonzero literals <em>at all</em>. Fallback is a secondary thing imo.</p>



<a name="276919537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276919537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276919537">(Mar 28 2022 at 19:22)</a>:</h4>
<p>Well, I think the place to look is <code>TypeRelation</code>. You can look at the <code>sub</code> module. Basically afaict you want to make <code>NonZeroU8</code> to be a subtype of <code>{integer}</code> if that inference var excludes zero</p>



<a name="276919557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276919557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276919557">(Mar 28 2022 at 19:22)</a>:</h4>
<p>But there may be other designs</p>



<a name="276919581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/276919581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#276919581">(Mar 28 2022 at 19:22)</a>:</h4>
<p>It could be done as a coercion I guess</p>



<a name="277094241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277094241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277094241">(Mar 30 2022 at 04:47)</a>:</h4>
<p>After digging around more than I care to admit, it seems like a coercion would be the simplest to implement.<br>
Any solution will necessitate making the nonzero types becoming lang items, correct? Does this need a bootstrap before it can be used?</p>



<a name="277094316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277094316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277094316">(Mar 30 2022 at 04:49)</a>:</h4>
<p>Any place where libstd depends on nightly changes to the compiler requires cfg(bootstrap), yes</p>



<a name="277094675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277094675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277094675">(Mar 30 2022 at 04:57)</a>:</h4>
<p>A test does not, though, correct?</p>



<a name="277094681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277094681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277094681">(Mar 30 2022 at 04:57)</a>:</h4>
<p>Trying to determine if I should preemptively ask for these to be lang items.</p>



<a name="277096752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277096752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277096752">(Mar 30 2022 at 05:42)</a>:</h4>
<p>Nah, just use ui tests, then you can make them lang items whenever you need</p>



<a name="277096784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277096784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277096784">(Mar 30 2022 at 05:42)</a>:</h4>
<p>Yeah I meant UI tests, not "regular" tests. Thanks for the info <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="277237639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277237639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277237639">(Mar 31 2022 at 06:18)</a>:</h4>
<p>Little update: it's possible! While I have not extensively tested this, a naïve implementation <strong>does</strong> work. I have managed to get this test to pass.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// compile-flags: --crate-type=lib</span>

<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">num</span>::<span class="p">{</span><span class="n">NonZeroI8</span><span class="p">,</span><span class="w"> </span><span class="n">NonZeroU8</span><span class="p">};</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Alpha</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span>: <span class="nc">NonZeroU8</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Beta</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span>: <span class="nc">NonZeroI8</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">_</span>: <span class="nc">NonZeroU8</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bar</span><span class="p">(</span><span class="n">_</span>: <span class="nc">NonZeroI8</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="nc">NonZeroU8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="nc">NonZeroI8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alpha</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="mi">1</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bar</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Beta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Beta</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">value</span>: <span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="p">};</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="nc">NonZeroU8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">//~ ERROR expected non-zero value</span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="nc">NonZeroI8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">//~ ERROR expected non-zero value</span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">//~ ERROR expected non-zero value</span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bar</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="c1">//~ ERROR expected non-zero value</span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Alpha</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">//~ ERROR expected non-zero value</span>
<span class="p">};</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Beta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Beta</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">value</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">//~ ERROR expected non-zero value</span>
<span class="p">};</span><span class="w"></span>
</code></pre></div>



<a name="277237983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277237983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277237983">(Mar 31 2022 at 06:23)</a>:</h4>
<p>Cool!</p>



<a name="277238055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277238055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277238055">(Mar 31 2022 at 06:24)</a>:</h4>
<p>Obviously needs an RFC and far more thorough testing, but it's neat to see that a coercion to <code>unsafe { NonZeroX::new_unchecked(val as _) }</code> is possible.</p>



<a name="277344890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277344890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277344890">(Mar 31 2022 at 21:53)</a>:</h4>
<p><span class="user-mention" data-user-id="245610">@Jacob Pratt</span> When you have a PR you're comfortable with, let me know and I can try a crater run.</p>



<a name="277344911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277344911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277344911">(Mar 31 2022 at 21:53)</a>:</h4>
<p>I'm impressed that it's this feasible.</p>



<a name="277347524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277347524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277347524">(Mar 31 2022 at 22:18)</a>:</h4>
<p>I'm just completely baffled that we never thought to try coercions for custom literals... in hindsight after Jacob said how he did it it's so obvious</p>



<a name="277360486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277360486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277360486">(Apr 01 2022 at 01:23)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="239881">@Josh Triplett</span> — it's a ways off but good to know.</p>



<a name="277360594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277360594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277360594">(Apr 01 2022 at 01:25)</a>:</h4>
<p>FWIW right now I added <strong>24</strong> new lang items (12 for the nonzero types and 12 for their constructors). What I want to do is to introduce <code>#[rustc_custom_literal]</code> attribute (name?) that would register a type with the compiler. That should largely avoid the need for new lang items.</p>



<a name="277366866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277366866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277366866">(Apr 01 2022 at 03:30)</a>:</h4>
<p>I would love one day to have a <code>FromIntegerLiteral</code> trait or something one day, using CTFE to turn an <code>{integer}</code> literal into instance -- fallibly, so it can show an error message.  But for now a <code>rustc_*</code> attribute seems plausible (to me from the peanut gallery).</p>
<p><em>Also, day 472 of wishing we just had one generic integer type.</em></p>



<a name="277366997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277366997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277366997">(Apr 01 2022 at 03:33)</a>:</h4>
<p>One of these days, I do intend on writing an RFC for ranged integers. The benefits would be wonderful.</p>



<a name="277367062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277367062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277367062">(Apr 01 2022 at 03:34)</a>:</h4>
<p>Problem is I have other things to do as well. Including starting a new job <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="277367580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277367580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277367580">(Apr 01 2022 at 03:44)</a>:</h4>
<p>Congrats on the job!!</p>



<a name="277383419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277383419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277383419">(Apr 01 2022 at 08:19)</a>:</h4>
<p>Instead of the new lang items, you could create a single attribute for all of them and just check if it's there. Constructing the coercion can probably be done off the destination type's info without looking up lang items (I hope)</p>



<a name="277383446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277383446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277383446">(Apr 01 2022 at 08:19)</a>:</h4>
<p>But... if you already got it working this way, I am tempted to stay with it and refactor later</p>



<a name="277391623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277391623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277391623">(Apr 01 2022 at 09:37)</a>:</h4>
<p>I think a lang item <code>FromIntegerLiteral</code> trait as <span class="user-mention" data-user-id="125270">@scottmcm</span> suggested would be the best.</p>



<a name="277394592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277394592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277394592">(Apr 01 2022 at 10:04)</a>:</h4>
<p>wow, wait <span class="user-mention" data-user-id="245610">@Jacob Pratt</span> , would this allow a rustc driver to define a custom integer literal type??</p>



<a name="277394605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277394605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277394605">(Apr 01 2022 at 10:04)</a>:</h4>
<p>like one for unbounded integers?</p>



<a name="277394852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277394852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277394852">(Apr 01 2022 at 10:07)</a>:</h4>
<p>ah, I see, you haven't yet implemented <code>rustc_custom_literal</code>, if you do I would be so so happy. sorry about the ping!</p>



<a name="277493692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277493692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277493692">(Apr 02 2022 at 00:22)</a>:</h4>
<p><span class="user-mention" data-user-id="312719">@Xavier Denis</span> not quite — unbounded integers would still have to be accepted elsewhere. Right now everything is parsed into a <code>u128</code> internally.</p>



<a name="277493856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277493856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277493856">(Apr 02 2022 at 00:24)</a>:</h4>
<p>For those suggesting a trait, one concern I have is const compatibility. It would effectively prohibit us from stabilizing nonzero literals until <code>impl_const_trait</code> becomes stable, unless we're willing to explicitly permit the unstable expansion.</p>



<a name="277493929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277493929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277493929">(Apr 02 2022 at 00:26)</a>:</h4>
<p>Personally I'd like to guarantee that the expansion can always be used in a const context, regardless of type.</p>



<a name="277508646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277508646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277508646">(Apr 02 2022 at 05:47)</a>:</h4>
<p>That limitation is fine for me, I have it already with my current hacks solution</p>



<a name="277508975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277508975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277508975">(Apr 02 2022 at 05:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="245610">Jacob Pratt</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/.7Binteger.7D.20inference.20location/near/277493856">said</a>:</p>
<blockquote>
<p>For those suggesting a trait, one concern I have is const compatibility. It would effectively prohibit us from stabilizing nonzero literals until <code>impl_const_trait</code> becomes stable, unless we're willing to explicitly permit the unstable expansion.</p>
</blockquote>
<p>well... more motivation for finding a way to stabilize that <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="277509064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277509064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277509064">(Apr 02 2022 at 05:56)</a>:</h4>
<p>Agreed, but I think it's important to note. I'd love to see <code>impl_const_trait</code> for wholly unrelated reasons.</p>



<a name="277509134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277509134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277509134">(Apr 02 2022 at 05:58)</a>:</h4>
<p>I'm still likely to move ahead with attempting that. Namely if the types don't match <em>and</em> the target type implements the trait, expand to the fully-qualified trait method call. I am fairly certain it's possible to query if a type implements a (lang item) trait?</p>



<a name="277510299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277510299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277510299">(Apr 02 2022 at 06:25)</a>:</h4>
<p>Yeah, look at how the <code>is_copy_raw</code> and <code>is_sized_raw</code> and such queries work.  IIRC they wrap a "does that type implement this particular DefId" query, and you just pass the one from the lang item.</p>



<a name="277548750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277548750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277548750">(Apr 02 2022 at 20:02)</a>:</h4>
<p>neat, I wonder how much breakage would be caused by allow them in <code>#[repr(NonZeroU8)] enum</code>, etc, given macros hard coding the list of types they expect in repr.  I've got a proc macro which hacks around this ability to set NZ reprs which would be obviated by such a thing...</p>



<a name="277548863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277548863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277548863">(Apr 02 2022 at 20:05)</a>:</h4>
<p>I guess it probably doesn't matter, just that those macros wouldn't work with enums that currently don't exist or so...</p>



<a name="277548918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277548918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277548918">(Apr 02 2022 at 20:06)</a>:</h4>
<p>That wouldn't be covered by this, fyi</p>



<a name="277548944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277548944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277548944">(Apr 02 2022 at 20:07)</a>:</h4>
<p>Indeed, just mentioning it because it would be a nice extension to it</p>



<a name="277550975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277550975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277550975">(Apr 02 2022 at 20:52)</a>:</h4>
<p>Note that on an <em>enum</em> you don't need <code>repr(NonZeroU8)</code>.  <code>repr(u8)</code> is fine, and it'll look at the discriminants to find the niche.</p>
<p>(Which is the trick I'm using in <a href="https://github.com/rust-lang/rust/pull/95361/files#diff-48ffeec3fb2dca955c1866b0c2caa8e6e784b12efba56f9e782655f484df107dR173">https://github.com/rust-lang/rust/pull/95361/files#diff-48ffeec3fb2dca955c1866b0c2caa8e6e784b12efba56f9e782655f484df107dR173</a>)</p>



<a name="277552800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277552800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277552800">(Apr 02 2022 at 21:31)</a>:</h4>
<p>Where i've been using it, it isn't really about niche's, or compilation, but just a logical precondition that (In my case some iterator) relies on their not being a zero repr'd variant, in that regard the derive macro I wrote <code>#[derive(NonZeroRepr)</code> has actually caught bugs, and works but requires jumping through a trait to convert from <code>u8</code> to <code>NonZeroU8</code> or whatever primitive type.</p>



<a name="277553156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277553156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277553156">(Apr 02 2022 at 21:39)</a>:</h4>
<p>fwiw, the entirety of the proc macro <a href="https://github.com/ratmice/enum_extra/blob/main/derive/src/lib.rs">https://github.com/ratmice/enum_extra/blob/main/derive/src/lib.rs</a></p>



<a name="277553331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277553331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matt rice <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277553331">(Apr 02 2022 at 21:42)</a>:</h4>
<p>The actual NonZeroRepr associated type isn't very useful, because you need to rely on trait bounds, but there aren't nonzero num traits, so I basically don't use it beyond a compile time check.</p>



<a name="277588322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277588322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277588322">(Apr 03 2022 at 07:15)</a>:</h4>
<p>Implementation question! I need to construct <code>&lt;NonZeroX as FromIntegerLiteral&gt;::from_integer_literal</code> to call. I have access to both <code>NonZeroX</code> and <code>FromIntegerLiteral</code> (from which I get the method). This expands to <code>&lt;Self as FromIntegerLiteral&gt;::from_integer_literal</code>, which isn't what I want — it's actually an ICE because it doesn't know what <code>Self</code> is. How can I construct <code>&lt;NonZeroX as FromIntegerLiteral&gt;::from_integer_literal</code>?</p>
<p>What I currently have:</p>
<ul>
<li><code>DefId</code> for <code>FromIntegerLiteral</code> trait</li>
<li><code>DefId</code> for <code>FromIntegerLiteral::from_integer_literal</code></li>
<li><code>DefId</code> for <code>NonZeroX</code> (this is the target type of the coercion/adjustment</li>
<li><code>DefId</code> for <code>X</code> (I don't think this is needed here)</li>
</ul>



<a name="277588677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277588677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277588677">(Apr 03 2022 at 07:19)</a>:</h4>
<p>Unrelated question that is likely for <span class="user-mention" data-user-id="124288">@oli</span>. The trait returns <code>Result&lt;Self, &amp;'static str&gt;</code>. The error value is intended to be used for diagnostics. Is it possible to have const eval evaluate the expression and get the <code>Result</code> back? The trait definition I have is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">FromIntegerLiteral</span>: <span class="nb">Sized</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Input</span><span class="p">;</span><span class="w"> </span><span class="c1">// this is what the compiler will pass</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">from_integer_literal</span><span class="p">(</span><span class="bp">Self</span>::<span class="n">Input</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Am I approaching this the correct way in general?</p>



<a name="277589562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277589562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277589562">(Apr 03 2022 at 07:26)</a>:</h4>
<p>I think you need to substitute the call with substs containing only the NonZeroX type</p>



<a name="277589753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277589753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277589753">(Apr 03 2022 at 07:28)</a>:</h4>
<p>Is this parsing always happening at compile time? In that case, maybe make the trait generic over a <code>const LITERAL: u128</code> for now and use an associated const instead of a method</p>



<a name="277589983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277589983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277589983">(Apr 03 2022 at 07:30)</a>:</h4>
<p>Call as in this?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">fn_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">method_callee</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">hir_expr</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">Some</span><span class="p">((</span><span class="w"></span>
<span class="w">        </span><span class="n">from_integer_literal_method_did</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">ty</span>::<span class="n">List</span>::<span class="n">identity_for_item</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">adjustment</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">ty_adt_def</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">did</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">)),</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>That's what I had originally and it's still ICE'ing. My suspicion is that it's doing <code>&lt;Self as FromIntegerLiteral&gt;::from_integer_literal::&lt;NonZeroX&gt;</code>, which isn't what I want.</p>



<a name="277590021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590021">(Apr 03 2022 at 07:31)</a>:</h4>
<p>And yes, my intent is for it to <em>always</em> be done at compile-time. That way the type validation can be done in the relevant library as opposed to the compiler.</p>



<a name="277590111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590111">(Apr 03 2022 at 07:32)</a>:</h4>
<p>The library code would just have a choice of which integer type the compiler would pass as a parameter.</p>



<a name="277590130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590130">(Apr 03 2022 at 07:32)</a>:</h4>
<p>Right</p>



<a name="277590150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590150">(Apr 03 2022 at 07:32)</a>:</h4>
<p>Hmm</p>



<a name="277590171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590171">(Apr 03 2022 at 07:32)</a>:</h4>
<p>We don't have a good infrastructure for this yet</p>



<a name="277590216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590216">(Apr 03 2022 at 07:33)</a>:</h4>
<p>Intuitively it feels like the same problem as having proc macros in the same crate (in terms of diagnostics)</p>



<a name="277590242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590242">(Apr 03 2022 at 07:33)</a>:</h4>
<p>The best I can come up with right now would be to add a new const eval intrinsic that unwraps a result and specially prints the string</p>



<a name="277590272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590272">(Apr 03 2022 at 07:33)</a>:</h4>
<p>Well for now you can just do a const panic and live with weird diagnostics</p>



<a name="277590334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590334">(Apr 03 2022 at 07:34)</a>:</h4>
<p>We can figure out the diagnostics later</p>



<a name="277590335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590335">(Apr 03 2022 at 07:34)</a>:</h4>
<p>I thought of const panic, but that doesn't seem ideal. Intrinsic is an interesting possibility.</p>



<a name="277590417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590417">(Apr 03 2022 at 07:35)</a>:</h4>
<p>We can use this as the proving ground for improving const panic diagnostics</p>



<a name="277590552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590552">(Apr 03 2022 at 07:36)</a>:</h4>
<p>On your ICE problem I'll have to have a look at your current code</p>



<a name="277590564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590564">(Apr 03 2022 at 07:36)</a>:</h4>
<p>True. And diagnostics later is a valid point. So I'll change that, which should be quite quick. It's constructing the trait call that's the primary issue.</p>



<a name="277590596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590596">(Apr 03 2022 at 07:37)</a>:</h4>
<p>Can you push your changes to a draft PR</p>



<a name="277590610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590610">(Apr 03 2022 at 07:37)</a>:</h4>
<p>I was heading to bed soon, but I'll push what I have now up tomorrow/today.</p>



<a name="277590645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277590645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277590645">(Apr 03 2022 at 07:37)</a>:</h4>
<p>Gives me a chance to make the minor signature change.</p>



<a name="277656462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277656462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277656462">(Apr 03 2022 at 19:25)</a>:</h4>
<p><span class="user-mention" data-user-id="245610">@Jacob Pratt</span> One simple way might just be to make a separate perma-unstable function be the lang item that you call.</p>
<p>That worked great for my <code>yeet</code> experiment, at least: <a href="https://github.com/scottmcm/rust/commit/do-yeet#diff-55ca2bad04d574c9b9d2b0ea41dc8e3825970da85fd2fd853446e01715f1c024R342">https://github.com/scottmcm/rust/commit/do-yeet#diff-55ca2bad04d574c9b9d2b0ea41dc8e3825970da85fd2fd853446e01715f1c024R342</a></p>



<a name="277667858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277667858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277667858">(Apr 03 2022 at 23:42)</a>:</h4>
<p>I just pushed up my attempt so far: <a href="https://github.com/jhpratt/rust/tree/nonzero-literals2">https://github.com/jhpratt/rust/tree/nonzero-literals2</a></p>



<a name="277667889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277667889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277667889">(Apr 03 2022 at 23:43)</a>:</h4>
<p>Making a separate helper function resulted in the same error. It's a matter of how to provide the generic type, I think.</p>



<a name="277695637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277695637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277695637">(Apr 04 2022 at 08:09)</a>:</h4>
<p>I think what should work is to not provide the type at all and instead use an inference var</p>



<a name="277695678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277695678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277695678">(Apr 04 2022 at 08:09)</a>:</h4>
<p>You wouldn't even have to check if the target type implements the trait</p>



<a name="277695743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277695743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277695743">(Apr 04 2022 at 08:10)</a>:</h4>
<p>Just always lower to the function call if it's not a primitive type</p>



<a name="277822457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277822457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277822457">(Apr 05 2022 at 03:06)</a>:</h4>
<p>How would that work? The adjustment has to return <code>ExprKind</code>, which is in thir.</p>



<a name="277829939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277829939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277829939">(Apr 05 2022 at 05:43)</a>:</h4>
<p>Oooh, that's where you're doing this. I thought this was still in typeck's coercion code.</p>
<p>Yea, you need to fetch the real type, but that should be available due to being the expression's type. What type are you using and what is the exact ICE you're getting?</p>



<a name="277830798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277830798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277830798">(Apr 05 2022 at 05:53)</a>:</h4>
<p>I'm on mobile now, but the ICE has something to do with it being generic. I could double back into the coercion code if it makes more sense there? I'd have to check the types to see what's possible.</p>



<a name="277973797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277973797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277973797">(Apr 06 2022 at 04:15)</a>:</h4>
<p>The code I currently have (which is what's pushed up) is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">fn_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">method_callee</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">hir_expr</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">Some</span><span class="p">((</span><span class="w"></span>
<span class="w">        </span><span class="n">from_integer_literal_method_did</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">ty</span>::<span class="n">List</span>::<span class="n">identity_for_item</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">adjustment</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">ty_adt_def</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">did</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">)),</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="fm">dbg!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn_call</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">fn_call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">thir</span><span class="p">.</span><span class="n">exprs</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">fn_call</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>With the result of that being logged:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>[compiler/rustc_mir_build/src/thir/cx/expr.rs:160] &amp;fn_call = Expr {
    ty: {"message":"compiler/rustc_middle/src/ty/subst.rs:634:17: type parameter `T/#0` (T/0) out of range when substituting, substs=[]","code":null,"level":"error: internal compiler error","spans":[{"file_name":"/home/jhpratt/code/rust/src/test/ui/inference/nonzero-literal-runtime.rs","byte_start":0,"byte_end":0,"line_start":1,"line_end":1,"column_start":1,"column_end":1,"is_primary":true,"text":[],"label":null,"suggested_replacement":null,"suggestion_applicability":null,"expansion":null}],"children":[],"rendered":"error: internal compiler error: compiler/rustc_middle/src/ty/subst.rs:634:17: type parameter `T/#0` (T/0) out of range when substituting, substs=[]\n\n"}
thread 'rustc' panicked at 'Box&lt;dyn Any&gt;', /home/jhpratt/code/rust/compiler/rustc_errors/src/lib.rs:1223:9
stack backtrace:
   0:     0x7f995873a2c3 - &lt;std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display&gt;::fmt::h2f808f62c293eacc
   1:     0x7f99587c3f8e - core::fmt::write::h1a03e421df9a5c87
(rest appears to be the backtrace for write, which is irrelevant)
</code></pre></div>
<p>I tried your suggestion of building it in the coercion part, but I don't see how to get the <em>value</em> of the type. Nor do I see how I could lower the HIR code I manually built to the necessary MIR (in this part of code, which is what's necessary).</p>



<a name="277973845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277973845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277973845">(Apr 06 2022 at 04:16)</a>:</h4>
<p>The JSON formatted:</p>
<div class="codehilite" data-code-language="JSON"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"compiler/rustc_middle/src/ty/subst.rs:634:17: type parameter `T/#0` (T/0) out of range when substituting, substs=[]"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"code"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"error: internal compiler error"</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">"spans"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">"file_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/home/jhpratt/code/rust/src/test/ui/inference/nonzero-literal-runtime.rs"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"byte_start"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"byte_end"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"line_start"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"line_end"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"column_start"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"column_end"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"is_primary"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"text"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"></span>
<span class="w">            </span><span class="nt">"label"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"suggested_replacement"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"suggestion_applicability"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">"expansion"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="nt">"children"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"></span>
<span class="w">    </span><span class="nt">"rendered"</span><span class="p">:</span><span class="w"> </span><span class="s2">"error: internal compiler error: compiler/rustc_middle/src/ty/subst.rs:634:17: type parameter `T/#0` (T/0) out of range when substituting, substs=[]\n\n"</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="277977148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277977148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277977148">(Apr 06 2022 at 05:28)</a>:</h4>
<p>The identity for item builds generics for the type, not the method. I think you just want a single element list that contains <code>adjustment.target</code>?</p>



<a name="277977484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277977484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277977484">(Apr 06 2022 at 05:36)</a>:</h4>
<p>How do I create that? That's the problem I was running into that led me to what I have now. The method signature is</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">method_callee</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">expr</span>: <span class="kp">&amp;</span><span class="nc">Expr</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">span</span>: <span class="nc">Span</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">overloaded_callee</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="p">(</span><span class="n">DefId</span><span class="p">,</span><span class="w"> </span><span class="n">SubstsRef</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Expr</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"></span>
</code></pre></div>



<a name="277978240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277978240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277978240">(Apr 06 2022 at 05:53)</a>:</h4>
<p>Hmm... if I read this right you should just use <code>None</code></p>



<a name="277978312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277978312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277978312">(Apr 06 2022 at 05:55)</a>:</h4>
<p>The only place using Some is Deref: <a href="https://github.com/rust-lang/rust/blob/a40c595695bff3bfb373a8a3355ae4bd4ea64608/compiler/rustc_mir_build/src/thir/cx/expr.rs#L127">https://github.com/rust-lang/rust/blob/a40c595695bff3bfb373a8a3355ae4bd4ea64608/compiler/rustc_mir_build/src/thir/cx/expr.rs#L127</a></p>



<a name="277978325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277978325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277978325">(Apr 06 2022 at 05:55)</a>:</h4>
<p>Trying that now. I'd have sworn I tried it previously.</p>



<a name="277978443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277978443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277978443">(Apr 06 2022 at 05:57)</a>:</h4>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>error: internal compiler error: compiler/rustc_mir_build/src/thir/cx/expr.rs:865:25: no type-dependent def for method callee
  --&gt; /home/jhpratt/code/rust/src/test/ui/inference/nonzero-literal-runtime.rs:15:22
   |
LL | const _: NonZeroU8 = 1;
   |                      ^

thread 'rustc' panicked at 'Box&lt;dyn Any&gt;', /home/jhpratt/code/rust/compiler/rustc_errors/src/lib.rs:1223:9
</code></pre></div>



<a name="277978644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277978644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277978644">(Apr 06 2022 at 06:00)</a>:</h4>
<p>Wait I think it's because I'm using <code>hir_expr</code> as a parameter to <code>method_callee</code></p>



<a name="277978685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277978685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277978685">(Apr 06 2022 at 06:00)</a>:</h4>
<p>Should be the lang item method I think</p>



<a name="277978827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%7Binteger%7D%20inference%20location/near/277978827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.7Binteger.7D.20inference.20location.html#277978827">(Apr 06 2022 at 06:02)</a>:</h4>
<p>Anyways headed to bed right now. I'll look at it tomorrow</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>