<html>
<head><meta charset="utf-8"><title>Generating native rustc/cargo binaries? · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html">Generating native rustc/cargo binaries?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264926365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/264926365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#264926365">(Dec 14 2021 at 21:14)</a>:</h4>
<p><code>mips64-unknown-linux-muslabi64</code> is a Tier 2 tuple (w/std), and I am creating a custom tuple based off of it.  i generate the stage0/stage1/stage2 <code>dist</code> packages, but a MIPS64 rustc/cargo host tools never get generated, just the x86_64 binaries able to cross-compile. </p>
<p>I'm missing a build flag somewhere on the compile (I'm not using <code>rustup</code>) and I'm not having any luck in the Target section (<a href="https://doc.rust-lang.org/nightly/rustc/platform-support.html">https://doc.rust-lang.org/nightly/rustc/platform-support.html</a>).  Any help would be appreciated!</p>



<a name="264927106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/264927106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#264927106">(Dec 14 2021 at 21:20)</a>:</h4>
<p>Is it just a matter of changing the <code>--host</code>from x86_64 to the Mips64 target?  I set --target, --host, --build.</p>



<a name="264931387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/264931387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#264931387">(Dec 14 2021 at 21:51)</a>:</h4>
<p>You don't need to set --build (it needs to be a triple compatible with the system you are currently building rustc on and will default to such a triple) You should set --host and --target to mips64-unknown-linux-muslabi64. --host indicates for which triple rustc is built and --target for which triple the standard library is built.</p>



<a name="264952734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/264952734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#264952734">(Dec 15 2021 at 01:12)</a>:</h4>
<p>and --build is the architecture of the build machine, correct?</p>



<a name="265055593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265055593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265055593">(Dec 15 2021 at 18:42)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Building stage1 compiler artifacts (x86_64-unknown-linux-gnu -&gt; mips64-openwrt-linux-musl)
   Compiling unicode-xid v0.2.2
   Compiling cfg-if v0.1.10
   Compiling lazy_static v1.4.0
...
   Compiling chalk-derive v0.55.0
   Compiling chalk-ir v0.55.0
   Compiling tracing v0.1.25
   Compiling rustc_index v0.0.0 (/home/grommish/openwrt/build_dir/target-mips64_octeonplus_64_musl/rust-1.56.1/compiler/rustc_index)
   Compiling rustc_data_structures v0.0.0 (/home/grommish/openwrt/build_dir/target-mips64_octeonplus_64_musl/rust-1.56.1/compiler/rustc_data_structures)
error[E0531]: cannot find unit struct, unit variant or constant `ENOTSUP` in crate `libc`
  --&gt; compiler/rustc_data_structures/src/flock.rs:59:57
   |
59 |                 matches!(err.raw_os_error(), Some(libc::ENOTSUP) | Some(libc::ENOSYS))
   |                                                         ^^^^^^^ not found in `libc`

For more information about this error, try `rustc --explain E0531`.
error: could not compile `rustc_data_structures` due to previous error
warning: build failed, waiting for other jobs to finish...
error: build failed
Build completed unsuccessfully in 3:20:47
</code></pre></div>
<p><code>compiler/rustc_data_structures/src/flock.rs:59:57</code></p>
<div class="codehilite"><pre><span></span><code>            pub fn error_unsupported(err: &amp;io::Error) -&gt; bool {
                matches!(err.raw_os_error(), Some(libc::ENOTSUP) | Some(libc::ENOSYS))
            }
</code></pre></div>
<p>Any ideas?</p>



<a name="265056372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265056372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265056372">(Dec 15 2021 at 18:48)</a>:</h4>
<p>The libc crate will probably need to be changed to add the <code>ENOTSUP</code> constant for mips64 musl linux.</p>



<a name="265057243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265057243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265057243">(Dec 15 2021 at 18:54)</a>:</h4>
<p>Ok, I'll post an issue on it.  Thanks!</p>
<p>Edit: <a href="https://github.com/rust-lang/rust/issues/91976">https://github.com/rust-lang/rust/issues/91976</a></p>



<a name="265142514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265142514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265142514">(Dec 16 2021 at 11:31)</a>:</h4>
<p>Ok, MIPS64 will be checked, in the mean time, I moved to <code>aarch64</code>..    Is this a rust or a llvm issue?</p>
<div class="codehilite"><pre><span></span><code>(/home/grommish/openwrt/build_dir/target-aarch64_cortex-a53_musl/rust-1.56.1/compiler/rustc_driver)
error: linking with `aarch64-openwrt-linux-musl-gcc` failed: exit status: 1
...
  = note: /home/grommish/openwrt/staging_dir/toolchain-aarch64_cortex-a53_gcc-10.3.0_musl/lib/gcc/aarch64-openwrt-linux-musl/10.3.0/../../../../aarch64-openwrt-linux-musl/bin/ld: cannot find -lLLVM-13-rust-1.56.1-nightly
          collect2: error: ld returned 1 exit status


error: could not compile `rustc_driver` due to previous error
</code></pre></div>
<p>(full fail string <a href="/user_uploads/4715/SLZuvh3BjBfRm-r6FddZNsMS/aarch64.txt">aarch64.txt</a> )</p>
<p><code>LLVM-13-rust-1.56.1-nightly</code> - What generates this?</p>



<a name="265142777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265142777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265142777">(Dec 16 2021 at 11:34)</a>:</h4>
<p>That is llvm itself. The rust build system should have built it for you.</p>



<a name="265143197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265143197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265143197">(Dec 16 2021 at 11:39)</a>:</h4>
<p>Well, the <code>build/aarch64-openwrt-linux-musl/llvm</code> directory seems to have built (<code>llvm-finished-building</code> is present), but that file isn't in there.</p>



<a name="265331513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265331513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265331513">(Dec 17 2021 at 17:33)</a>:</h4>
<p>Silly question.  rust-lang/libc was updated, but that is pulled internally it seems.  So, how/when does this get updated?   I'm using <code>--enable-locked-deps --enable-vendor</code> to see if that will force the update, but it doesn't seem to.  Suggestions on how to force the update, or is it just a matter of waiting for the next tagged release?</p>



<a name="265332755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265332755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265332755">(Dec 17 2021 at 17:42)</a>:</h4>
<p>You can do <code>cargo update -p libc</code> once a version with the fix gets released.</p>



<a name="265332928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265332928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265332928">(Dec 17 2021 at 17:43)</a>:</h4>
<p>Before that you can add an entry to the <code>[patch.crates-io]</code> section in the root <code>Cargo.toml</code> referencing a local checkout of libc.</p>



<a name="265397236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265397236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265397236">(Dec 18 2021 at 06:46)</a>:</h4>
<p>So, like this?</p>
<div class="codehilite"><pre><span></span><code>[patch.&quot;https://github.com/rust-lang/libc&quot;]
libc = { path = &quot;~/libc&quot; }
</code></pre></div>



<a name="265408396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265408396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265408396">(Dec 18 2021 at 09:31)</a>:</h4>
<p>More like</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[patch.crates-io]</span>
<span class="n">libc</span> <span class="o">=</span> <span class="p">{</span> <span class="n">path</span> <span class="o">=</span> <span class="s">"/path/to/libc"</span> <span class="p">}</span>
</code></pre></div>
<p>I don't think <code>~</code> works in these paths. Also I think toml doesn't allow multiple sections, so you will have to place libc line just below the existing <code>[patch.crates-io]</code>.</p>



<a name="265415316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265415316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265415316">(Dec 18 2021 at 12:16)</a>:</h4>
<p>Ok, I'm stuck.. I'm getting </p>
<div class="codehilite"><pre><span></span><code>warning: Patch `libc v0.2.112 (/home/grommish/libc)` was not used in the crate graph.
Check that the patched package version and available features are compatible
with the dependency requirements. If the patch has a different version from
what is locked in the Cargo.lock file, run `cargo update` to use the new
version. This may also occur with an optional dependency that is not enabled.
</code></pre></div>
<p>Except, I can't run <code>cargo update</code> because <code>cargo</code> hasn't been built yet.</p>
<p>I can temporarily patch <code>Cargo.lock</code> for the revised version in my local repo for testing until it's updated, but I don't know how to generate the checksum hash (or what to generate it against).</p>
<div class="codehilite"><pre><span></span><code>[[package]]
name = &quot;libc&quot;
version = &quot;0.2.108&quot;
source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
checksum = &quot;8521a1b57e76b1ec69af7599e75e38e7b7fad6610f037db8c79b127201b5d119&quot;
dependencies = [
 &quot;rustc-std-workspace-core&quot;,
]
</code></pre></div>



<a name="265415750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265415750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265415750">(Dec 18 2021 at 12:26)</a>:</h4>
<p>Oh, these are just tag tarballs?</p>
<div class="codehilite"><pre><span></span><code>--- a/Cargo.lock
+++ b/Cargo.lock
@@ -1905,9 +1905,9 @@

 [[package]]
 name = &quot;libc&quot;
-version = &quot;0.2.108&quot;
+version = &quot;0.2.112&quot;
 source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
-checksum = &quot;8521a1b57e76b1ec69af7599e75e38e7b7fad6610f037db8c79b127201b5d119&quot;
+checksum = &quot;465130257246408cf32675383c82ecc40f2065ce987e4242b6c8b27e9c703c69&quot;
 dependencies = [
  &quot;rustc-std-workspace-core&quot;,
 ]
</code></pre></div>
<p>So, this should be correct?</p>
<p>Sorry for all the questions.  At this point in the development, it's taking anywhere between 2.5-5 hours per build, so I'm really trying to cut down on test building when possible :D</p>



<a name="265416005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265416005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265416005">(Dec 18 2021 at 12:33)</a>:</h4>
<blockquote>
<p>warning: Patch <code>libc v0.2.112 (/home/grommish/libc)</code> was not used in the crate graph.</p>
</blockquote>
<p>This is normal for <em>some</em> commands because it patches for all crates but not all crates use libc. Hence a warning but not an error. It shouldn't occur while building the std crate since that depends on libc.</p>



<a name="265416132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265416132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265416132">(Dec 18 2021 at 12:36)</a>:</h4>
<p>And you can use the host cargo to update it, no need to build one first since the crate resolution isn't platform-dependent.</p>



<a name="265416245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265416245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265416245">(Dec 18 2021 at 12:39)</a>:</h4>
<p>I'm incorporating <code>rust-lang</code> into the OpenWrt build system, so I can't use host <code>rust-lang</code>, or <code>rustup</code>.  I'm building from source stage0-2 for the host (to cross compile within the fakeroot) and now working on native rustc/cargo for on-device.  It also means I've got to do everything thru <code>./configure</code> and a few other guidelines.  It's why it's being so stubborn in places;</p>



<a name="265416259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265416259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265416259">(Dec 18 2021 at 12:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F/near/265416005">said</a>:</p>
<blockquote>
<blockquote>
<p>warning: Patch <code>libc v0.2.112 (/home/grommish/libc)</code> was not used in the crate graph.</p>
</blockquote>
<p>This is normal for <em>some</em> commands because it patches for all crates but not all crates use libc. Hence a warning but not an error. It shouldn't occur while building the std crate since that depends on libc.</p>
</blockquote>
<p><code>[patch.crates-io]</code> patches it for the crate graph. It doesn't matter that some crates don't use it. For as long as any crate in the workspace uses it, this warning won't be given.</p>



<a name="265416319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265416319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265416319">(Dec 18 2021 at 12:40)</a>:</h4>
<p>But the warning can be ignored?</p>



<a name="265416325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265416325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265416325">(Dec 18 2021 at 12:40)</a>:</h4>
<p>It indicates that the patch wasn't applied.</p>



<a name="265416363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265416363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265416363">(Dec 18 2021 at 12:41)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> hrrm, sure? I'm pretty sure I have seen that warning when overriding smallvec locally in an experiment and then built std which didn't use smallvec or something like that.</p>



<a name="265416408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265416408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265416408">(Dec 18 2021 at 12:42)</a>:</h4>
<p>I'm building all packages via <code>x.py dist</code> call, if that makes a difference</p>



<a name="265416409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265416409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265416409">(Dec 18 2021 at 12:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F/near/265416363">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> hrrm, sure? I'm pretty sure I have seen that warning when overriding smallvec locally in an experiment and then built std which didn't use smallvec or something like that.</p>
</blockquote>
<p>The version of the smallvec you patched it with probably didn't match the one in <code>Cargo.lock</code>.</p>



<a name="265416433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265416433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265416433">(Dec 18 2021 at 12:43)</a>:</h4>
<p><span class="user-mention" data-user-id="332271">@Grommish</span> the patch in <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F/near/265415750">https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F/near/265415750</a> looks like it should be fine I think.</p>



<a name="265416485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265416485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265416485">(Dec 18 2021 at 12:44)</a>:</h4>
<p>Appreciate it.. it's only temp so I can continue testing until the next Cargo.lock update in <code>rust-lang/rust</code> gets rolled out that includes it.</p>



<a name="265479842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265479842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265479842">(Dec 19 2021 at 13:16)</a>:</h4>
<p>Fooled again by <code>build.extended</code>!  <span class="user-mention" data-user-id="133247">@bjorn3</span> Instead of overriding the <code>Cargo.toml</code> or the <code>Cargo.lock</code>, I did enable <code>build.vendor</code> to force it to get the crates upstream.  Granted, in the future I'm sure I'll need to know how to locate a local repo crate, but since the PR was accepted so quickly, I should be able to just ride the system.</p>
<p>I am completely unfamiliar with rust/rust-lang/cargo/etc, but I'm not trying to use it, just set it up setup for the far more knowledgeable folks to use.  The fact I can't use the exceptional rust-lang tools to make it easier just is par for the course :)</p>



<a name="265480121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265480121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265480121">(Dec 19 2021 at 13:22)</a>:</h4>
<p>Ok.. On the CMake portion of the source build.  Is there a way to not have it use <code>$(nproc)</code> to build the LLVM?  Currently, it defaults to:<br>
<code>running: "cmake" "--build" "." "--target" "install" "--config" "Release" "--" "-j" "8"</code></p>
<p>I build with <code>-j4</code> or <code>-j5</code> on the OpenWrt build so I can continue to use the system while it builds. (it's a i7-3xxxm 4 core/8 thread that WSL2 sees as Logical Processors).</p>
<p>Since everything is done via <code>x.py</code>, is there a way to pass the argument to LLVM's CMake?</p>
<p>Aside from:</p>
<div class="codehilite"><pre><span></span><code>        --llvm-cflags=VAL              build LLVM with these extra compiler flags
        --llvm-cxxflags=VAL            build LLVM with these extra compiler flags
        --llvm-ldflags=VAL             build LLVM with these extra linker flags
</code></pre></div>
<p>Since I am going to guess that adding multiple <code>-j</code> defines would be.. bad?</p>



<a name="265480713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265480713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265480713">(Dec 19 2021 at 13:39)</a>:</h4>
<p>You can pass <code>-j</code> to <code>./x.py</code>. I would expect it to be forwarded to <code>cmake</code>.</p>



<a name="265480789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/265480789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#265480789">(Dec 19 2021 at 13:41)</a>:</h4>
<p>I thought I had tried that, but I will test again because I can't be sure.  It could be that I'm just passing it to the build system in the beginning and not further down the line.  I just wonder why it defaults to max processors.  Thanks again!</p>



<a name="266036414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/266036414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#266036414">(Dec 25 2021 at 02:12)</a>:</h4>
<p>Do you have any suggestions on how to get LLVM to build libLLVM-13-rust-1.59.0-nightly in MIPS rather than x86_64?  When I build with <code>--host</code> and <code>--target</code> set to mips64 and <code>--build</code> set to x86_64 it builds:</p>
<div class="codehilite"><pre><span></span><code>./target-mips64_octeonplus_64_musl/rust-1.57.0/build/x86_64-unknown-linux-gnu/llvm/build/lib/libLLVM-13-rust-1.59.0-nightly.so
./target-mips64_octeonplus_64_musl/rust-1.57.0/build/x86_64-unknown-linux-gnu/llvm/lib/libLLVM-13-rust-1.59.0-nightly.so
./target-mips64_octeonplus_64_musl/rust-1.57.0/build/x86_64-unknown-linux-gnu/stage1/lib/libLLVM-13-rust-1.59.0-nightly.so
./target-mips64_octeonplus_64_musl/rust-1.57.0/build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libLLVM-13-rust-1.59.0-nightly.so
./target-mips64_octeonplus_64_musl/rust-1.57.0/build/x86_64-unknown-linux-gnu/stage2/lib/libLLVM-13-rust-1.59.0-nightly.so
./target-mips64_octeonplus_64_musl/rust-1.57.0/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/x86_64-unknown-linux-gnu/lib/libLLVM-13-rust-1.59.0-nightly.so
</code></pre></div>
<p>But never builds out for <code>mips64-openwrt-linux-musl</code> like it's supposed to, but expects it to to link the mips64 native binaries against.  Any suggestions?</p>
<div class="codehilite"><pre><span></span><code>grommish@DESKTOP-AW:~/openwrt/staging_dir$ find ./* -name libLLVM-13-rust-1.59.0-nightly*
./hostpkg/lib/libLLVM-13-rust-1.59.0-nightly.so
./hostpkg/lib/libLLVM-13-rust-1.59.0-nightly.so.old
./hostpkg/lib/rustlib/x86_64-unknown-linux-gnu/lib/libLLVM-13-rust-1.59.0-nightly.so
grommish@DESKTOP-AW:~/openwrt/staging_dir$ file ./hostpkg/lib/libLLVM-13-rust-1.59.0-nightly.so
./hostpkg/lib/libLLVM-13-rust-1.59.0-nightly.so: ELF 64-bit LSB shared object, x86-64, version 1 (GNU/Linux), dynamically linked, BuildID[sha1]=c951f77d4c08d32a48affcea090cd9d409e17994, not stripped
</code></pre></div>



<a name="266206427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/266206427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#266206427">(Dec 27 2021 at 21:30)</a>:</h4>
<p>I have a installed rustc/cargo for x86_64-unknown-linux-gnu that <code>rustc --print target-list</code> shows me the <code>mips64-openwrt-linux-musl</code></p>
<p>In essence, I've got Stage 2 artifacts installed to the Mips64 MUSL tookchain for the host (these files are <code>x86_64</code> formatted able to cross-compile to <code>mips64</code>.</p>
<p>Is there a way to run <code>./configure</code> / <code>x.py</code> that I can tell it where rustc/cargo is installed and use that to keep from having to build Stage 0/1 in order to build for native mips64 binaries?</p>



<a name="266218223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/266218223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#266218223">(Dec 28 2021 at 00:17)</a>:</h4>
<p>Also! I may have figured out the LLVM issue.  I think it wasn't building a MIPS LLVM Library because I didn't have <code>--experimental-targets="AArch64;ARM;Mips;PowerPC;X86"</code> set.   I'm testing to see if that makes a difference or not.</p>



<a name="266470052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/266470052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#266470052">(Dec 31 2021 at 00:39)</a>:</h4>
<p>Ok, so rust-lang uses a forked LLVM, correct?  Does it take all of the same <code>-D</code> args standard <code>LLVM-project</code> uses and does anyone know where in the build system any defaults it uses might be?  I know I can pass <code> --set=llvm.cxxflags=</code> to the system, I just need to know which, if any, are provided by default.</p>
<p>I am passing the following to a stand-along LLVM, for example:</p>
<div class="codehilite"><pre><span></span><code>CMAKE_HOST_OPTIONS += \
                 -DLLVM_ENABLE_BINDINGS=OFF \
                 -DLLVM_INCLUDE_DOCS=OFF \
                 -DLLVM_INCLUDE_EXAMPLES=OFF \
                 -DLLVM_INCLUDE_TESTS=OFF \
                 -DLLVM_ENABLE_PROJECTS=&quot;clang;lld&quot; \
                 -DCLANG_BUILD_EXAMPLES=OFF \
                 -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
                 -DLLVM_LINK_LLVM_DYLIB=ON \
                 -DLLVM_TOOLCHAIN_TOOLS=&quot;llvm-objcopy;llvm-objdump;llvm-readelf;llvm-strip;llvm-ar;llvm-as;llvm-dis;llvm-link;llvm-nm;llvm-ranlib;llc;op&gt;                 -DCMAKE_SKIP_RPATH=OFF

CMAKE_OPTIONS += \
                 -I$(STAGING_DIR_HOSTPKG)/include/ncurses \
                 -DCMAKE_CROSSCOMPILING=True \
                 -DLLVM_TABLEGEN=$(STAGING_DIR_HOSTPKG)/bin/llvm-tblgen \
                 -DCLANG_TABLEGEN=$(STAGING_DIR_HOSTPKG)/bin/clang-tblgen \
                 -DLLVM_DEFAULT_TARGET_TRIPLE=mips64-linux-musl \
                 -DLLVM_TARGET_ARCH=Mips \
                 -DLLVM_TARGETS_TO_BUILD=&#39;AArch64;ARM;Mips;PowerPC;X86&#39; \
                 -DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD=&#39;AArch64;ARM;Mips;PowerPC;X86&#39; \
                 -DLLVM_ENABLE_BINDINGS=OFF \
                 -DLLVM_INCLUDE_DOCS=OFF \
                 -DLLVM_INCLUDE_EXAMPLES=OFF \
                 -DLLVM_INCLUDE_TESTS=OFF \
                 -DLLVM_ENABLE_PROJECTS=&quot;clang;lld&quot; \
                 -DCLANG_BUILD_EXAMPLES=OFF \
                 -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
                 -DLLVM_LINK_LLVM_DYLIB=ON \
                 -DLLVM_TOOLCHAIN_TOOLS=&quot;llvm-objcopy;llvm-objdump;llvm-readelf;llvm-strip;llvm-ar;llvm-as;llvm-dis;llvm-link;llvm-nm;llvm-ranlib;llc;op&gt;
                 -DCMAKE_SKIP_RPATH=OFF
</code></pre></div>



<a name="266471405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/266471405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#266471405">(Dec 31 2021 at 01:03)</a>:</h4>
<p>src/bootstrap/native.rs:177</p>
<p>And you can tell it to use a prebuilt llvm instead. It'll lose some fixes and optimization that way but should be good enough to build itself and most rust programs.</p>



<a name="266471634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/266471634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#266471634">(Dec 31 2021 at 01:06)</a>:</h4>
<p>but there is at least one MIPS-specific fix on the patch stack: <a href="https://github.com/rust-lang/llvm-project/commits/rustc/13.0-2021-09-30">https://github.com/rust-lang/llvm-project/commits/rustc/13.0-2021-09-30</a></p>



<a name="266472854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/266472854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#266472854">(Dec 31 2021 at 01:30)</a>:</h4>
<p>There is a MIPS64 related <code>libc</code> fix I sent in, as well, so I'd rather use the intrinsic LLVM (plus, unless there is a need to generate OpenWrt specific LLVM triples, I don't see a huge advantage for it).  My issues are complicated by everything else.  Thanks for pointing me to <code>src/bootstrap/native.rs:177</code>, I'll take a look!</p>



<a name="266541437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/266541437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#266541437">(Jan 01 2022 at 05:21)</a>:</h4>
<p><a href="https://gist.github.com/Grommish/bc255be620d822506dd53a554f66e318">https://gist.github.com/Grommish/bc255be620d822506dd53a554f66e318</a></p>
<p>Is there a way to tell it to use someplace other than <code>~/.cargo</code>?  I call <code>x.py --config ./config.toml install</code>  and set a <code>--prefix=</code> in the configure call. It shouldn't be in <code>~/.cargo</code> (I don't have rust installed locally on the host) and I'm guessing that's why I'm getting crate errors.  I'm guessing I'm missing setting it somewhere along the line.  Any suggestions on where to look?</p>
<p>Everything else gets installed to the <code>--prefix=</code> directory.. <code>lib/rustlibs</code>, all the <code>bin/</code> etc..  Just not the <code>.cargo</code></p>
<p>Ok, That's just a Fail on me :D  Disregard</p>



<a name="266579786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Generating%20native%20rustc/cargo%20binaries%3F/near/266579786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Grommish <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Generating.20native.20rustc.2Fcargo.20binaries.3F.html#266579786">(Jan 01 2022 at 22:37)</a>:</h4>
<p><a href="/user_uploads/4715/O2VLr3neETK0qiEaBzpjPXra/new-2.txt">new-2.txt</a> </p>
<p>Still failing..  I thought maybe <code>CARGO_HOME</code> not being explicitly set was causing issues, but that doesn't seem to be the case.</p>
<p>Anyone know what these errors actually are?  The system is fine building <code>x86_64-linux-gnu</code>/<code>mips64-openwrt-linux-musl</code>, but these errors happen on the <code>mips64-openwrt-linux-musl</code>/<code>mips64-openwrt-linux-musl</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>