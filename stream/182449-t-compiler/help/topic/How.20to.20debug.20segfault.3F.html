<html>
<head><meta charset="utf-8"><title>How to debug segfault? · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20to.20debug.20segfault.3F.html">How to debug segfault?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275897896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20to%20debug%20segfault%3F/near/275897896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20to.20debug.20segfault.3F.html#275897896">(Mar 19 2022 at 08:29)</a>:</h4>
<p>I'm working on the PR that allows <code>impl Fn() -&gt; impl Trait</code> as a return type. While adding tests I've found out that this function:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">f</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="k">impl</span><span class="w"> </span><span class="n">Debug</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>segfaults the compiler with my patch. Is there a way to debug such cases? I have no idea why it segfaults atm...</p>



<a name="275898072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20to%20debug%20segfault%3F/near/275898072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20to.20debug.20segfault.3F.html#275898072">(Mar 19 2022 at 08:33)</a>:</h4>
<p>The PR in question: <a href="https://github.com/rust-lang/rust/pull/93582">https://github.com/rust-lang/rust/pull/93582</a></p>



<a name="275898132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20to%20debug%20segfault%3F/near/275898132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20to.20debug.20segfault.3F.html#275898132">(Mar 19 2022 at 08:35)</a>:</h4>
<p>I would guess that type check struggles with the <code>for&lt;'a&gt; ... impl Debug + 'a</code>, but I have no idea how to debug this</p>



<a name="275898338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20to%20debug%20segfault%3F/near/275898338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20to.20debug.20segfault.3F.html#275898338">(Mar 19 2022 at 08:39)</a>:</h4>
<p>Logs are getting <strong>very</strong> indented which suggests that there is an infinite recursion <a href="/user_uploads/4715/qU7GGugZnK66iZ0lWPm-B0et/2022-03-19_12-39.png">2022-03-19_12-39.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/qU7GGugZnK66iZ0lWPm-B0et/2022-03-19_12-39.png" title="2022-03-19_12-39.png"><img src="/user_uploads/4715/qU7GGugZnK66iZ0lWPm-B0et/2022-03-19_12-39.png"></a></div>



<a name="275898734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20to%20debug%20segfault%3F/near/275898734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20to.20debug.20segfault.3F.html#275898734">(Mar 19 2022 at 08:48)</a>:</h4>
<p>I've found the start of the recursion in logs:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>┐rustc_infer::infer::opaque_types::fold_opaque_ty ty=impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]), opaque_type_key=OpaqueTypeKey { def_id: DefId(0:7 ~ impl_fn_associativity2[4a39]::f::{opaque#0}), substs: [] }, origin=FnReturn(DefId(0:6 ~ impl_fn_associativity2[4a39]::f))
├─0ms DEBUG rustc_infer::infer::type_variable new_var(index=_#0t, universe=U0, origin=TypeVariableOrigin { kind: TypeInference, span: src/test/ui/impl-trait/impl_fn_associativity2.rs:10:11: 10:55 (#0) })
├─0ms DEBUG rustc_infer::infer::opaque_types generated new type inference var Infer(_#0t)
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]) as std::marker::Sized&gt;, polarity:Positive), [])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]) as std::marker::Sized&gt;, polarity:Positive), [])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;_ as std::marker::Sized&gt;, polarity:Positive), [])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;_ as std::marker::Sized&gt;, polarity:Positive), [])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]) as std::ops::Fn&lt;(&amp;'a u8,)&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]) as std::ops::Fn&lt;(&amp;'a u8,)&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;_ as std::ops::Fn&lt;(&amp;'a u8,)&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;_ as std::ops::Fn&lt;(&amp;'a u8,)&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]), (&amp;'a u8,)], item_def_id: DefId(2:3286 ~ core[5484]::ops::function::FnOnce::Output) }, Ty(impl std::fmt::Debug)), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(ProjectionPredicate(ProjectionTy { substs: [impl Fn(&amp;'a u8)-&gt; for&lt;'a&gt; Opaque(DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })]), (&amp;'a u8,)], item_def_id: DefId(2:3286 ~ core[5484]::ops::function::FnOnce::Output) }, Ty(impl std::fmt::Debug)), [Region(BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a))])
├─┐rustc_infer::infer::opaque_types::fold_opaque_ty ty=impl std::fmt::Debug, opaque_type_key=OpaqueTypeKey { def_id: DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), substs: [ReLateBound(DebruijnIndex(0), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })] }, origin=FnReturn(DefId(0:6 ~ impl_fn_associativity2[4a39]::f))
│ ├─0ms DEBUG rustc_infer::infer::type_variable new_var(index=_#1t, universe=U0, origin=TypeVariableOrigin { kind: TypeInference, span: src/test/ui/impl-trait/impl_fn_associativity2.rs:10:11: 10:55 (#0) })
│ ├─0ms DEBUG rustc_infer::infer::opaque_types generated new type inference var Infer(_#1t)
│ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
│ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
│ ├─┐rustc_infer::infer::opaque_types::fold_opaque_ty ty=impl std::fmt::Debug, opaque_type_key=OpaqueTypeKey { def_id: DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), substs: [ReLateBound(DebruijnIndex(1), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })] }, origin=FnReturn(DefId(0:6 ~ impl_fn_associativity2[4a39]::f))
│ │ ├─0ms DEBUG rustc_infer::infer::type_variable new_var(index=_#2t, universe=U0, origin=TypeVariableOrigin { kind: TypeInference, span: src/test/ui/impl-trait/impl_fn_associativity2.rs:10:11: 10:55 (#0) })
│ │ ├─0ms DEBUG rustc_infer::infer::opaque_types generated new type inference var Infer(_#2t)
│ │ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
│ │ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
│ │ ├─┐rustc_infer::infer::opaque_types::fold_opaque_ty ty=impl std::fmt::Debug, opaque_type_key=OpaqueTypeKey { def_id: DefId(0:9 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::{opaque#0}), substs: [ReLateBound(DebruijnIndex(2), BoundRegion { var: 0, kind: BrNamed(DefId(0:8 ~ impl_fn_associativity2[4a39]::f::{opaque#0}::'a), 'a) })] }, origin=FnReturn(DefId(0:6 ~ impl_fn_associativity2[4a39]::f))
│ │ │ ├─0ms DEBUG rustc_infer::infer::type_variable new_var(index=_#3t, universe=U0, origin=TypeVariableOrigin { kind: TypeInference, span: src/test/ui/impl-trait/impl_fn_associativity2.rs:10:11: 10:55 (#0) })
│ │ │ ├─0ms DEBUG rustc_infer::infer::opaque_types generated new type inference var Infer(_#3t)
│ │ │ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
│ │ │ ├─0ms DEBUG rustc_infer::infer::opaque_types predicate=Binder(TraitPredicate(&lt;impl std::fmt::Debug as std::marker::Sized&gt;, polarity:Positive), [])
</code></pre></div>



<a name="275898829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20to%20debug%20segfault%3F/near/275898829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Waffle Lapkin <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20to.20debug.20segfault.3F.html#275898829">(Mar 19 2022 at 08:51)</a>:</h4>
<p>Hm, I guess I should ask about <code>rustc_infer::infer::opaque_types::fold_opaque_ty </code> in <a class="stream" data-stream-id="144729" href="/#narrow/stream/144729-wg-traits">#wg-traits</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>