<html>
<head><meta charset="utf-8"><title>clone a function on MIR · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html">clone a function on MIR</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275844937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275844937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shihao Xia <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275844937">(Mar 18 2022 at 18:34)</a>:</h4>
<p>For Rust MIR, do we have any recommended way or example to clone a function (Body) similar to what we can do in LLVM IR?</p>



<a name="275846232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275846232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275846232">(Mar 18 2022 at 18:45)</a>:</h4>
<p><code>mir::Body</code> implements <code>Clone</code>. What do you want to do?</p>



<a name="275854168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275854168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275854168">(Mar 18 2022 at 19:51)</a>:</h4>
<p>Perhaps they mean cause a second version to be codegened?</p>



<a name="275871337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275871337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shihao Xia <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275871337">(Mar 18 2022 at 22:42)</a>:</h4>
<p>Exactly. I want clone a function and modify it, just like second version or extend version of function</p>



<a name="275871478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275871478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shihao Xia <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275871478">(Mar 18 2022 at 22:44)</a>:</h4>
<p>for example, when encounter a call site, let a = hello(b), any way to clone a function hello(the modify some statements) , and update call site to be let a = hello_ext(b)</p>



<a name="275871511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275871511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shihao Xia <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275871511">(Mar 18 2022 at 22:44)</a>:</h4>
<p>assume I want to keep original function implementation also</p>



<a name="275893354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275893354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275893354">(Mar 19 2022 at 06:29)</a>:</h4>
<p>The HIR is immutable so you can't really define new functions at that level.</p>



<a name="275961523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275961523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275961523">(Mar 20 2022 at 11:08)</a>:</h4>
<p>We could add "child functions" to mir bodies that are callable without a def id. Similar to how promoteds used to work</p>



<a name="275961537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275961537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275961537">(Mar 20 2022 at 11:08)</a>:</h4>
<p>Or allow mir opts to generate additional mir bodies and return a vec from optimized_mir</p>



<a name="275961552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275961552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275961552">(Mar 20 2022 at 11:09)</a>:</h4>
<p>Can you tell us more about your use case?</p>



<a name="275976220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275976220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275976220">(Mar 20 2022 at 16:48)</a>:</h4>
<p>God I wish it were possible to create new <code>DefId</code>s during compilation</p>



<a name="275978943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275978943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275978943">(Mar 20 2022 at 17:46)</a>:</h4>
<p>I.... have ideas for that, but need to flesh out an MCP for experimentation first</p>



<a name="275984760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275984760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275984760">(Mar 20 2022 at 19:56)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/88186">#88186</a> will introduce this possibility.</p>



<a name="275992287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275992287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shihao Xia <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275992287">(Mar 20 2022 at 23:00)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> what is MCP?</p>



<a name="275992442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/275992442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shihao Xia <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#275992442">(Mar 20 2022 at 23:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/clone.20a.20function.20on.20MIR/near/275961523">said</a>:</p>
<blockquote>
<p>We could add "child functions" to mir bodies that are callable without a def id. Similar to how promoteds used to work</p>
</blockquote>
<p>Yeah, this way can achieve a similar effect, however, more flexibility in MIR (convenient APIs may? ) could allow more instrumentation and analysis. So we can do a lot of things in MIR instead of in LLVM.</p>



<a name="276014509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/276014509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#276014509">(Mar 21 2022 at 07:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="382085">Shihao Xia</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/clone.20a.20function.20on.20MIR/near/275992287">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="124288">oli</span> what is MCP?</p>
</blockquote>
<p>a Major Change Proposal, a lightweight way to inform people about big changes and get some feedback and discussion going on whether the change should be done, more info here: <a href="https://forge.rust-lang.org/compiler/mcp.html">https://forge.rust-lang.org/compiler/mcp.html</a></p>



<a name="276023869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/clone%20a%20function%20on%20MIR/near/276023869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/clone.20a.20function.20on.20MIR.html#276023869">(Mar 21 2022 at 09:27)</a>:</h4>
<p>Hmm... can you elaborate on his you think that a different scheme will enable more analyses?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>