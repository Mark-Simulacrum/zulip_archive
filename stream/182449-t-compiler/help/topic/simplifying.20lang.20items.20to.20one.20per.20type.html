<html>
<head><meta charset="utf-8"><title>simplifying lang items to one per type · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html">simplifying lang items to one per type</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272043905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272043905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272043905">(Feb 15 2022 at 21:56)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> Continuing from the thread on <a class="stream" data-stream-id="213817" href="/#narrow/stream/213817-t-lang">#t-lang</a>: if someone wanted to work on that idea of having just one lang item per type rather than one per impl block, what might they be likely to run into in trying to do that? (Ignoring the coherence issue of the std/alloc/core split for the moment.)</p>



<a name="272044126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272044126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272044126">(Feb 15 2022 at 21:58)</a>:</h4>
<p>Lang items are name -&gt; Option&lt;DefId&gt; at the moment, so you can't have duplicate definitions.</p>



<a name="272044168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272044168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272044168">(Feb 15 2022 at 21:59)</a>:</h4>
<p>I think I'm more generally talking about a rework where "types are special, impl blocks are not".</p>



<a name="272044179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272044179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272044179">(Feb 15 2022 at 21:59)</a>:</h4>
<p>It could get attached to a different attribute temporarily, if needed.</p>



<a name="272044225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272044225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272044225">(Feb 15 2022 at 21:59)</a>:</h4>
<p>Not sure.</p>



<a name="272044296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272044296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272044296">(Feb 15 2022 at 22:00)</a>:</h4>
<p>For instance:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[lang = </span><span class="s">"u32"</span><span class="cp">]</span><span class="w"> </span><span class="k">type</span> <span class="kt">u32</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">functions</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">functions</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272044440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272044440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272044440">(Feb 15 2022 at 22:01)</a>:</h4>
<p>If u32 is considered as defined in that crate it may just work.</p>



<a name="272044666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272044666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272044666">(Feb 15 2022 at 22:02)</a>:</h4>
<p>Might be worth a try, at least for things that <em>don't</em> have the coherence problem across core/alloc/std. Thanks, that helps!</p>



<a name="272068592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272068592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272068592">(Feb 16 2022 at 03:06)</a>:</h4>
<p>I suspect the lack of a <code>= ...</code> on the type definition is going to be a bit awkward -- it may be easier to define with <code>struct u32;</code> or similar, though even that may cause some lints etc trouble if they're not reading the lang item appropriately</p>



<a name="272068596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272068596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272068596">(Feb 16 2022 at 03:06)</a>:</h4>
<p>it seems a little tricky and I'm not sure how much value it buys, necessarily</p>



<a name="272068614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272068614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272068614">(Feb 16 2022 at 03:07)</a>:</h4>
<p>I might rather suggest special casing core/std/alloc with <code>#![iamcore]</code> or something and letting those crates define inherent impls without lang items, perhaps.</p>



<a name="272069131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272069131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272069131">(Feb 16 2022 at 03:17)</a>:</h4>
<p>I think long-term there's a general desire to merge the crates into one. But short-term that seems plausible.</p>



<a name="272071700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272071700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272071700">(Feb 16 2022 at 04:12)</a>:</h4>
<p>I think there might be a place for a separation for reusability, actually.  It might turn out, for example, that re-using <code>std</code> across implementations is completely reasonable but re-using <code>core</code> isn't.  But of course it's likely that "exactly three crates" isn't the perfect split either.</p>



<a name="272072092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272072092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272072092">(Feb 16 2022 at 04:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/simplifying.20lang.20items.20to.20one.20per.20type/near/272068592">said</a>:</p>
<blockquote>
<p>I suspect the lack of a <code>= ...</code> on the type definition is going to be a bit awkward -- it may be easier to define with <code>struct u32;</code> or similar, though even that may cause some lints etc trouble if they're not reading the lang item appropriately</p>
</blockquote>
<p>The exact syntax of the definition doesn't seem important, only that it has something marking it as a lang item and has the type name.</p>



<a name="272085363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272085363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272085363">(Feb 16 2022 at 08:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/simplifying.20lang.20items.20to.20one.20per.20type/near/272068614">said</a>:</p>
<blockquote>
<p>I might rather suggest special casing core/std/alloc with <code>#![iamcore]</code> or something and letting those crates define inherent impls without lang items, perhaps.</p>
</blockquote>
<p>adding inherent impls doesn't cause coherence issues and unsoundness, so i've been considering that solution for quite a while myself. Never got around to implementing it though <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> this seems like the prefered solution for me here</p>



<a name="272085769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272085769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272085769">(Feb 16 2022 at 08:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/simplifying.20lang.20items.20to.20one.20per.20type/near/272068592">said</a>:</p>
<blockquote>
<p>I suspect the lack of a <code>= ...</code> on the type definition is going to be a bit awkward -- it may be easier to define with <code>struct u32;</code> or similar, though even that may cause some lints etc trouble if they're not reading the lang item appropriately</p>
</blockquote>
<p>It could also be <code>extern type u32;</code>, since this actually is an extern type in some sense</p>



<a name="272093522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272093522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272093522">(Feb 16 2022 at 09:49)</a>:</h4>
<p><code>extern "C" { type u32; }</code> would result in an unsized type.</p>



<a name="272095716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272095716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272095716">(Feb 16 2022 at 10:09)</a>:</h4>
<p>Only if compiler magic didn't intercede. The idea is that the <code>#[lang]</code> attribute will make it act like a rust builtin type instead of an extern C type. Plus that could also be <code>extern "Rust"</code> or something else with specific semantics</p>



<a name="272095822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272095822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272095822">(Feb 16 2022 at 10:10)</a>:</h4>
<p>"extern" here is to be read as "not defined in rust code", not "unknown to the rust compiler"</p>



<a name="272096095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272096095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272096095">(Feb 16 2022 at 10:12)</a>:</h4>
<p>the main pragmatic advantage is that it works with the existing rust grammar, and it is a little closer to the truth than a magic attribute on <code>struct u32;</code></p>



<a name="272100559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272100559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272100559">(Feb 16 2022 at 10:56)</a>:</h4>
<p>Considering that we implement <code>Add</code> for integers via the <code>+</code> operation on said integers, we could also do <code>struct u32(u32);</code>. Same recursion, but avoided because the language gives it special meaning</p>



<a name="272101029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/simplifying%20lang%20items%20to%20one%20per%20type/near/272101029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/simplifying.20lang.20items.20to.20one.20per.20type.html#272101029">(Feb 16 2022 at 11:01)</a>:</h4>
<p>Actually the <code>Add</code> impls are not recursive. If you write <code>Add::add(a, b)</code> or <code>+</code> in a generic context it will call the <code>add</code> method. If you write <code>+</code> in a non-generic context it will lower to an <code>Add</code> MIR operation. So if you were to implement <code>Add</code> as <code>-</code> on an integer, doing <code>a + b</code> in a non-generic context will do addition, but <code>Add::add(a, b)</code> will do substraction.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>