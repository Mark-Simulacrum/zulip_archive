<html>
<head><meta charset="utf-8"><title>libcore cross comp abi issues · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/libcore.20cross.20comp.20abi.20issues.html">libcore cross comp abi issues</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265468276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/libcore%20cross%20comp%20abi%20issues/near/265468276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dominic DeMarco <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/libcore.20cross.20comp.20abi.20issues.html#265468276">(Dec 19 2021 at 08:18)</a>:</h4>
<p>I'm in the process of hooking rustc up to an llvm backend containing an experimental target for an (old) 8 bit cpu. Things are going well, but I'm running into a problem trying to compile libcore.<br>
<code>LLVM ERROR: unable to translate instruction: call (in function: _ZN4core3fmt3num12GenericRadix7fmt_int17h0225deeec0744d34E)</code></p>
<p>I did some poking around with the llvm intermediary output by passing save-temps to rustc, and ran llvm-dis on the problematic bc file to get some llvm-asm out of it to analyze.</p>
<p>I believe the root of my problem is the fact that the calling convention for a return value for this LLVM target looks like this:</p>
<div class="codehilite"><pre><span></span><code>def RetCC_Z80_C : CallingConv&lt;[
  CCIfType&lt;[ i16 ], CCAssignToReg&lt;[ HL, DE, BC, IY ]&gt;&gt;,
  CCIfType&lt;[ i8 ], CCAssignToReg&lt;[ A, L, H, E, D, C, B, IYL, IYH ]&gt;&gt;
]&gt;;
</code></pre></div>
<p>Only accepting an 8 or 16 bit value, and several of the call instructions from the llvm disassembler look like this:</p>
<div class="codehilite"><pre><span></span><code>%55 = call i128 @&quot;_ZN54_$LT$u128$u20$as$u20$core..num..FromStrRadixHelper$GT$8from_u3217he575bc60f15078e9E&quot;(i32 0)
</code></pre></div>
<p>and this:</p>
<div class="codehilite"><pre><span></span><code> %164 = call { i8, i32 } @&quot;_ZN4core4char7methods22_$LT$impl$u20$char$GT$8to_digit17h6ccd7676ad861346E&quot;(i32 %162, i32 %163)
</code></pre></div>
<p>So I'm blowing up because I can't translate that call instruction with a 128 bit return value.</p>
<p>I went ahead and wrote a <code>compute_abi_info</code> routine for my new target triple in <code>compiler/rustc_target/src/abi/call/</code> to take those large return values and <code>make_indirect()</code> them to a pointer to satisfy my llvm calling conventions.</p>
<p>However, this compute_abi_info function is never getting run, because when compiling libcore (even with a --target specified), it seems that core always compiles with the <code>Rust</code> or <code>RustIntrinsic</code> ABI specified, and so we hit a rule in <code>fn_abi_adjust_for_abi()</code> in <code>compiler/rustc_middle/src/ty/layout.rs</code> that performs some simple blanket abi adjustments and skips any custom adjustments for my target triple.</p>
<p>I'm assuming that I need to try to get libcore compiled with my custom ABI in mind, but I can't figure out a good way to do that.</p>
<p>Is this Rust ABI target truly the issue I'm running into? Or is there a deeper problem I'm not understanding?</p>



<a name="265479657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/libcore%20cross%20comp%20abi%20issues/near/265479657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/libcore.20cross.20comp.20abi.20issues.html#265479657">(Dec 19 2021 at 13:13)</a>:</h4>
<blockquote>
<p>Is this Rust ABI target truly the issue I'm running into?</p>
</blockquote>
<p>Probably</p>
<blockquote>
<p>I'm assuming that I need to try to get libcore compiled with my custom ABI in mind, but I can't figure out a good way to do that.</p>
</blockquote>
<p>There are several requirements an abi has to satisfy to be usable as rust abi. This includes but I think is not limited to that all zst (zero sized type) arguments are skipped (for casting closures to function pointers), all arguments with the <code>ScalarPair</code> abi in the layout are passed as two separate values and all pointer arguments as a single value (for dynamic dispatch).</p>



<a name="265480576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/libcore%20cross%20comp%20abi%20issues/near/265480576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/libcore.20cross.20comp.20abi.20issues.html#265480576">(Dec 19 2021 at 13:35)</a>:</h4>
<p>Backend impl in LLVM should know how to translate these kinds of signatures by itself.</p>



<a name="265526306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/libcore%20cross%20comp%20abi%20issues/near/265526306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dominic DeMarco <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/libcore.20cross.20comp.20abi.20issues.html#265526306">(Dec 20 2021 at 06:49)</a>:</h4>
<p>Thanks for the replies all.<br>
<span class="user-mention" data-user-id="133247">@bjorn3</span> , is there documentation somewhere of rusts hard abi requirements? Or will I have to do some digging in <code>layout.rs</code> to figure it out?<br>
<span class="user-mention" data-user-id="123586">@nagisa</span> , I imagine they normally do, but this is an experimental target for an old 8 bit cpu, (we're talking 9 usable registers). If the logic to reduce these llvm-asm call arguments is target based, they likely weren't implemented by the original author for some reason or another.<br>
Evidently in my scenario, something isn't reducing correctly. Offhand, do you know where this logic lives? I haven't worked directly with LLVM before this project.</p>
<p>As an aside... if anyone knows how to get llvm to spit out some more information on that <code>unable to translate instruction call</code> without me having to write some debug output and recompile, that would be most helpful</p>



<a name="265534491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/libcore%20cross%20comp%20abi%20issues/near/265534491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/libcore.20cross.20comp.20abi.20issues.html#265534491">(Dec 20 2021 at 08:39)</a>:</h4>
<p>I don't think there is any documentation. They are assumptions backed into the codegen backend code.</p>



<a name="265553323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/libcore%20cross%20comp%20abi%20issues/near/265553323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/libcore.20cross.20comp.20abi.20issues.html#265553323">(Dec 20 2021 at 11:59)</a>:</h4>
<p>So here's how you'd debug LLVM side of things: build llvm-project with <code>-DLLVM_ENABLE_ASSERTIONS=1</code> enabled.  Then you can feed LLVM IR to <code>llc -debug</code> to get more info out of it as to what it was doing and where.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>