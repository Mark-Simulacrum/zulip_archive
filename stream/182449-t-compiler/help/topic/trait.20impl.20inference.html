<html>
<head><meta charset="utf-8"><title>trait impl inference · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html">trait impl inference</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255771083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255771083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom Farmer <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255771083">(Oct 01 2021 at 16:29)</a>:</h4>
<p>Hi All, I've been trying my best to understand this <a href="https://github.com/rust-lang/rust/issues/89275">issue</a> for a couple of days now and I think I'm getting to the point where I believe that the compiler is doing its job correctly but seems to be trying to run through all the trait impl in scope to figure out what type Foo.downcast() is. </p>
<p>Am I on the right track or is the compiler doing something else I'm not aware of (I'm mostly using logs/source code however it seems to be doing this inferral via the cannonical trait system which I am struggling to follow)?</p>



<a name="255775786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255775786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255775786">(Oct 01 2021 at 17:02)</a>:</h4>
<p>It doesn't look like this is a method resolution issue, the following has the same bug:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">num_traits</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">;</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Ratio</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">);</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Pow</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">pow</span><span class="p">(</span><span class="bp">self</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Pow</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">Ratio</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">T</span>: <span class="nc">Pow</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">pow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">unimplemented!</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">downcast</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">W</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">W</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">todo!</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Other</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">other</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Other</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">downcast</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I'll try to work out when the compiler is actually doing the check that overflows</p>



<a name="255781562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255781562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom Farmer <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255781562">(Oct 01 2021 at 17:43)</a>:</h4>
<p>Cool thanks, I don't think it's method resolution myself but it seems to be recursing through every trait trying to fulfil some kind of obligation for the &amp;_ type then it hits the &lt;num_traits::Pow::pow&gt;  trait and seems try to compare &amp;_ against &lt;_as num_traits::Pow:pow&gt; which ends up resolving into a Ratio&lt;T&gt; as num_traits::Pow:pow &amp; recursing from there</p>



<a name="255781761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255781761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom Farmer <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255781761">(Oct 01 2021 at 17:45)</a>:</h4>
<p>It only happens when you have an implementation of Pow on Ratio&lt;T&gt; so I expect it's a circular implementation when it's ambiguous what type you want and that check seems to happen before the mutability check so it errors on the trait</p>



<a name="255782303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255782303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255782303">(Oct 01 2021 at 17:49)</a>:</h4>
<p>It's error reporting that's trying to check every method in scope though.</p>



<a name="255782890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255782890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom Farmer <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255782890">(Oct 01 2021 at 17:53)</a>:</h4>
<p>Ahh right I hadn't got that from my poking around, how were you able to see that error reporting was causing it?</p>



<a name="255783402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255783402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255783402">(Oct 01 2021 at 17:56)</a>:</h4>
<p>You can look for callers of <code>prove_op</code> with <code>None</code> as the <code>method_name</code> and follow that back to <code>suggest_deref_ref_or_into</code>.</p>



<a name="255784072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255784072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom Farmer <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255784072">(Oct 01 2021 at 18:01)</a>:</h4>
<p>I assume you're doing that through some kind of tracing of the compiler too?</p>



<a name="255784618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255784618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255784618">(Oct 01 2021 at 18:04)</a>:</h4>
<p>To find call sites I'm looking at the code (using Rust Analyzer to search for usages). To know that <code>probe_op</code> is the function I should be looking at is from previous experience with this part of the compiler, the tracing output would show this too though.</p>



<a name="255784652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255784652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255784652">(Oct 01 2021 at 18:05)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/86506">#86506</a> might be worth looking at here.</p>



<a name="255784725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255784725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255784725">(Oct 01 2021 at 18:05)</a>:</h4>
<p>although it's not intended for the same issue.</p>



<a name="255788631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/trait%20impl%20inference/near/255788631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom Farmer <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/trait.20impl.20inference.html#255788631">(Oct 01 2021 at 18:33)</a>:</h4>
<p>Cool okay I'll do a bit more looking around then thanks for the pointers!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>