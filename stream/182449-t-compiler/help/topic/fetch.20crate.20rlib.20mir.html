<html>
<head><meta charset="utf-8"><title>fetch crate rlib mir · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html">fetch crate rlib mir</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262427704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262427704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anciety <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262427704">(Nov 23 2021 at 08:56)</a>:</h4>
<p>HI, I'm new to this zulip thing, hope I'm not doing this wrong. I'm currently working on a project which requires a rustc plugin (or something alike) to fetch the compiled rlib's mir. But not sure how I can do this. I know how to fetch mir for current crate and some of the "std", "core" and "alloc", but still many crates are missing. What am I missing?</p>



<a name="262434056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262434056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anciety <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262434056">(Nov 23 2021 at 10:02)</a>:</h4>
<p>I found that by using <code>exported_symbols</code> I can get the symbol of dependency crates, but <code>is_mir_available</code> tells me that the mir is not available somehow</p>



<a name="262438032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262438032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262438032">(Nov 23 2021 at 10:41)</a>:</h4>
<p>You can compile everything with <code>-Zalways-encode-mir</code>. MIR is by default only encoded in the crate metadata when necessary. It is only necessary for generic and <code>#[inline]</code> functions.</p>



<a name="262438057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262438057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262438057">(Nov 23 2021 at 10:41)</a>:</h4>
<p>Make sure to also compile the standard library with <code>-Zalways-encode-mir</code>.</p>



<a name="262438722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262438722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anciety <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262438722">(Nov 23 2021 at 10:49)</a>:</h4>
<p>It seems to be working! Thanks. BTW, I have one more question. When generating the rlibs, what are actually included? I mean, I've tried to write a simple snippet like this:</p>
<div class="codehilite"><pre><span></span><code>pub trait Needed {
    fn needed(&amp;self);
}

pub struct Test&lt;T: Needed&gt; {
    x: T
}

impl&lt;T: Needed&gt; Test&lt;T&gt; {
    pub fn print(&amp;self)  {
        self.x.needed()
    }

    pub fn new(x: T) -&gt; Self {
        Self {
            x
        }
    }
}
</code></pre></div>



<a name="262438749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262438749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anciety <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262438749">(Nov 23 2021 at 10:49)</a>:</h4>
<p>I was expecting that the Test::print should be generated to mir (or rlib), but it seems not</p>



<a name="262438939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262438939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262438939">(Nov 23 2021 at 10:51)</a>:</h4>
<p>It's mir should be encoded in the crate metadata. <code>exported_symbols</code> won't list it though as it isn't locally codegened. You need <code>tcx.mir_keys()</code> I believe.</p>



<a name="262439091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262439091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anciety <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262439091">(Nov 23 2021 at 10:52)</a>:</h4>
<p>This snippet is included in what I call "testlib", while I also write a "testbin" to reference this testlib.</p>



<a name="262439214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262439214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anciety <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262439214">(Nov 23 2021 at 10:53)</a>:</h4>
<p>So, I'm a little bit confused about the difference of <code>mir_keys</code> and <code>exported_symbols</code>. I thought in this case, since it is a lib, it should be in the exported symbols?</p>



<a name="262439564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262439564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262439564">(Nov 23 2021 at 10:57)</a>:</h4>
<p>exported_symbols only lists the symbols exported from the codegened object files of the library. In your case <code>Test::&lt;T&gt;::print</code> is not codegened in the library as it is generic and there are no generic instantiations of it inside the library. If the binary were to use it, exported_symbols of the binary will list it as it is codegened to an object file when compiling the binary.</p>



<a name="262440862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262440862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anciety <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262440862">(Nov 23 2021 at 11:07)</a>:</h4>
<p>So, if I get it right, the mir of this <code>Test::&lt;T&gt;::print</code> thing is generated but not listed in the <code>exported_symbols</code>, since my <code>testbin</code> need the mir of it to generate actual code, right? My case is like, I want to extract out the <code>mir</code> included in the <code>rlib</code>(rmeta) file.. Like already presented <code>.rlib</code> of the std libs or so. Is there any hack I can do by using rustc plugin to achieve that?</p>



<a name="262444962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262444962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262444962">(Nov 23 2021 at 11:49)</a>:</h4>
<p>mir_keys returns all defids in the local crate with mir associated to them. to get it for other crates you will need to do something like what hacspec does (see <a href="https://github.com/rust-lang/rust/issues/85889">#85889</a>) I think.</p>



<a name="262451819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/fetch%20crate%20rlib%20mir/near/262451819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/fetch.20crate.20rlib.20mir.html#262451819">(Nov 23 2021 at 13:01)</a>:</h4>
<p>mir_keys returns all defids in the local crate with mir associated to them. to get it for other crates you will need to do something like what hacspec does (see <a href="https://github.com/rust-lang/rust/issues/85889">#85889</a>) I think.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>