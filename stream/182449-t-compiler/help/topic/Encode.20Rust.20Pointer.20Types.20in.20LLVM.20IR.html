<html>
<head><meta charset="utf-8"><title>Encode Rust Pointer Types in LLVM IR · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Encode.20Rust.20Pointer.20Types.20in.20LLVM.20IR.html">Encode Rust Pointer Types in LLVM IR</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266688810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Encode%20Rust%20Pointer%20Types%20in%20LLVM%20IR/near/266688810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Encode.20Rust.20Pointer.20Types.20in.20LLVM.20IR.html#266688810">(Jan 03 2022 at 14:02)</a>:</h4>
<p>In some cases there isn't even a rust type in the first place. For example for vtable pointers. Function pointers also sometimes need to be pointer casted. What exactly do you need the rust type for?</p>



<a name="266689428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Encode%20Rust%20Pointer%20Types%20in%20LLVM%20IR/near/266689428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Braunsdorf <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Encode.20Rust.20Pointer.20Types.20in.20LLVM.20IR.html#266689428">(Jan 03 2022 at 14:08)</a>:</h4>
<p>I'm experimenting with an LLVM pass for memory-safety. I want to implement a mechanism to elide safety-checks for pointers whose validity is already handled by Rust</p>



<a name="267801133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Encode%20Rust%20Pointer%20Types%20in%20LLVM%20IR/near/267801133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Braunsdorf <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Encode.20Rust.20Pointer.20Types.20in.20LLVM.20IR.html#267801133">(Jan 12 2022 at 23:17)</a>:</h4>
<p>Hey Rustaceans,<br>
I'm still seeking help here. Does anybody have some advice on which location in rustc's codegen I should implement emitting LLVM metadata nodes for instructions with pointer operands?</p>
<p>To me it seems like the calls to the <code>BuilderMethods</code> Trait are scattered over a lot of code parts (<a href="http://place.rs">place.rs</a>, <a href="http://rvalue.rs">rvalue.rs</a>, <a href="http://operand.rs">operand.rs</a> within rustc_codgen_ssa/mir) and I have trouble finding the right location for getting startet.<br>
Could someone please give me a hint?</p>



<a name="267808237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Encode%20Rust%20Pointer%20Types%20in%20LLVM%20IR/near/267808237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Encode.20Rust.20Pointer.20Types.20in.20LLVM.20IR.html#267808237">(Jan 13 2022 at 00:27)</a>:</h4>
<p>I think you may want the <code>impl BuilderMethods</code> in <code>compiler/rustc_codegen_llvm/src/builder.rs</code></p>



<a name="267808337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Encode%20Rust%20Pointer%20Types%20in%20LLVM%20IR/near/267808337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Encode.20Rust.20Pointer.20Types.20in.20LLVM.20IR.html#267808337">(Jan 13 2022 at 00:28)</a>:</h4>
<p>or is that already too deep for the type info you want?</p>



<a name="267808886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Encode%20Rust%20Pointer%20Types%20in%20LLVM%20IR/near/267808886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Braunsdorf <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Encode.20Rust.20Pointer.20Types.20in.20LLVM.20IR.html#267808886">(Jan 13 2022 at 00:34)</a>:</h4>
<p>yes, unfortunately that is too deep because most of the functions there take "Self::Value" (=reference to an LLVM value) as an argument. I think that it's not possible to get the type info at this point.</p>



<a name="267809295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Encode%20Rust%20Pointer%20Types%20in%20LLVM%20IR/near/267809295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Braunsdorf <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Encode.20Rust.20Pointer.20Types.20in.20LLVM.20IR.html#267809295">(Jan 13 2022 at 00:40)</a>:</h4>
<p>And one level above: it seems like the BuilderMethods' functions like <code>load()</code>or <code>store()</code> are getting called from multiple locations in <code>rustc_codegen_ssa</code>....which makes it hard to get full coverage of all call sites</p>



<a name="267810279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Encode%20Rust%20Pointer%20Types%20in%20LLVM%20IR/near/267810279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Encode.20Rust.20Pointer.20Types.20in.20LLVM.20IR.html#267810279">(Jan 13 2022 at 00:55)</a>:</h4>
<p>can you do it where the LLVM types are constructed? like <code>LayoutTypeMethods</code>, where <code>TyAndLayout</code> has the inner <code>Ty</code></p>



<a name="267812345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Encode%20Rust%20Pointer%20Types%20in%20LLVM%20IR/near/267812345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oliver Braunsdorf <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Encode.20Rust.20Pointer.20Types.20in.20LLVM.20IR.html#267812345">(Jan 13 2022 at 01:25)</a>:</h4>
<p>mhh..it seems like this location isn't suited either.<br>
I think what I am looking for is a location where have an <code>rustc::codegen_llvm::Value</code> and access to the type of the MIR value it is representing. Do you know if there is some kind of map, that i could draw this information from?<br>
Some mapping between <code>Value</code>s and  <code>PlaceRef</code>s or <code>OperandRef</code>s ?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>