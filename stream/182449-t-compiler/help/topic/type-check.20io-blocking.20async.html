<html>
<head><meta charset="utf-8"><title>type-check io-blocking async · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/type-check.20io-blocking.20async.html">type-check io-blocking async</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269184384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/type-check%20io-blocking%20async/near/269184384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bojan Serafimov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/type-check.20io-blocking.20async.html#269184384">(Jan 24 2022 at 22:52)</a>:</h4>
<p>A big difficulty when working with async rust is not knowing up-front the cost of a migration to async (who knows if my dependencies use blocking syscalls). The second biggest difficulty is not being sure if my program will get stuck in production because I used task::spawn instead of task::spawn_blocking somewhere.</p>
<p>Maybe this is a naive suggestion, but seems like a solveable problem. What if all io-blocking functions take <code>&amp;mut ThreadToken</code> as input while all non-blocking functions take <code>&amp;ThreadToken</code>? Here <code>ThreadToken</code> is an empty enum that doesn't implement <code>Copy</code> or <code>Clone</code> and would be unsafely be constructed only by <code>std::thread::spawn</code>.</p>
<p>This effectively ensures at compile time that all blocking calls reserve their own thread.</p>
<p>I would be down to build a rough demo for this. But before I dig in, I'm curious if there's existing work or a well-known reason that this is a bad idea. Or maybe an irrelevant RFC that obviates this?</p>



<a name="269184984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/type-check%20io-blocking%20async/near/269184984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bojan Serafimov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/type-check.20io-blocking.20async.html#269184984">(Jan 24 2022 at 22:59)</a>:</h4>
<p>Side note: For now let's ignore CPU-blocking functions. If we really want them in the type system, that can be done with a non-mandatory <code>&amp;mut ThreadToken</code> input argument.</p>



<a name="269203029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/type-check%20io-blocking%20async/near/269203029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/type-check.20io-blocking.20async.html#269203029">(Jan 25 2022 at 02:57)</a>:</h4>
<p>I think this discussion might be a better fit for the standard library team in <a class="stream" data-stream-id="219381" href="/#narrow/stream/219381-t-libs">#t-libs</a>?</p>



<a name="269203054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/type-check%20io-blocking%20async/near/269203054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/type-check.20io-blocking.20async.html#269203054">(Jan 25 2022 at 02:58)</a>:</h4>
<p>Also, by "empty enum", I assume you mean "empty struct"? An empty enum has no possible values, so you'd never be able to call a function taking it as a parameter.</p>



<a name="269217159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/type-check%20io-blocking%20async/near/269217159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bojan Serafimov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/type-check.20io-blocking.20async.html#269217159">(Jan 25 2022 at 07:13)</a>:</h4>
<p>Yes that's the point, that safe code can't instantiate an empty enum :) Only the spawn function can create the token, using some unsafe code. Playground example: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=1b45843c812ae18483b75615f2f8cb5d">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=1b45843c812ae18483b75615f2f8cb5d</a></p>



<a name="269243505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/type-check%20io-blocking%20async/near/269243505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/type-check.20io-blocking.20async.html#269243505">(Jan 25 2022 at 11:31)</a>:</h4>
<p>unsafe code also cannot create a value of <code>enum Void {}</code> that is UB</p>



<a name="269244512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/type-check%20io-blocking%20async/near/269244512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/type-check.20io-blocking.20async.html#269244512">(Jan 25 2022 at 11:43)</a>:</h4>
<p>I don't see all libraries changing their APIs to take additional arguments to label effects of their functions. So I'm not sure how this would help in practice.</p>



<a name="269244672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/type-check%20io-blocking%20async/near/269244672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/type-check.20io-blocking.20async.html#269244672">(Jan 25 2022 at 11:45)</a>:</h4>
<p>It seems more like something that could be done with a linting system. Label entire crates/modules/functions as #[asynclinter::blocking] or #[asynclinter::nonblocking] (anything unlabeled can emit hint that additional annotations are needed or something) and then warn if non-blocking code calls blocking code without spawn_blocking.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>