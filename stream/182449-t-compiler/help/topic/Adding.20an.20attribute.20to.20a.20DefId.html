<html>
<head><meta charset="utf-8"><title>Adding an attribute to a DefId · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html">Adding an attribute to a DefId</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250565059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250565059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250565059">(Aug 24 2021 at 23:51)</a>:</h4>
<p>Is there anyway to <strong>add</strong> an attribute to a <code>DefId</code> during compilation? I've been searching the docs but it seems like you can only <strong>read</strong> attributes, I haven't found a way to extend them.</p>



<a name="250579389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250579389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250579389">(Aug 25 2021 at 04:39)</a>:</h4>
<p>Honestly, any mechanism to store metadata during compilation so I can read it from another crate would be perfect</p>



<a name="250579395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250579395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250579395">(Aug 25 2021 at 04:39)</a>:</h4>
<p>I'd like to avoid having to handle it myself so I can easily benefit from fingerprints / integrate with cargo clean etc..</p>



<a name="250587576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250587576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250587576">(Aug 25 2021 at 07:28)</a>:</h4>
<p>No, the HIR is immutable. That is necessary for the query system and incremental compilation to work correctly.</p>



<a name="250587640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250587640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250587640">(Aug 25 2021 at 07:29)</a>:</h4>
<p>You can change the AST before lowering to HIR though, but the lowering to HIR happens before the TyCtxt is created. (HIR is one of the inputs of the TyCtxt constructor)</p>



<a name="250587733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250587733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250587733">(Aug 25 2021 at 07:30)</a>:</h4>
<p>If you want to store extra things in the crate metadata you will have to change rustc_metadata to add an extra field for it.</p>



<a name="250646444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250646444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250646444">(Aug 25 2021 at 16:48)</a>:</h4>
<p>I imagine that will require an MCP</p>



<a name="250646765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250646765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250646765">(Aug 25 2021 at 16:51)</a>:</h4>
<p>I wonder what the best api would be? Allow user key value pairs in the metadata?</p>



<a name="250675533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250675533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250675533">(Aug 25 2021 at 20:09)</a>:</h4>
<p><span class="user-mention" data-user-id="312719">@Xavier Denis</span> <br>
Could you tell in more detail what you want to achieve in the end?<br>
Also, is it something in rustc or in a third-party rustc driver or plugin?</p>



<a name="250676639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250676639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250676639">(Aug 25 2021 at 20:18)</a>:</h4>
<p>(I'm asking because for questions from the "how to do something weird in the implementation" category the answer is often "you don't need to do that, you need to do something else entirely to achieve the observable end goal".)</p>



<a name="250676653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250676653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250676653">(Aug 25 2021 at 20:18)</a>:</h4>
<p>This is for a rustc driver. </p>
<p>I'm building a formal verification tool, and I'm trying to get it to work in a multi-crate project (ie with dependencies). The idea is that when It processes a crate it will save metadata about items, so that dependent crates can load them.</p>



<a name="250676694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250676694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250676694">(Aug 25 2021 at 20:19)</a>:</h4>
<p>yea I figure that is could be an XY-problem situation</p>



<a name="250676758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250676758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250676758">(Aug 25 2021 at 20:19)</a>:</h4>
<p>The end goal is I'd like to have additional build outputs (in a driver), whose storage is ideally managed by rustc infrastructure</p>



<a name="250679232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250679232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250679232">(Aug 25 2021 at 20:39)</a>:</h4>
<p>What kind of <code>DefId</code>s do you want to attach extra data to?<br>
Does "items" mean items in Rust sense?</p>



<a name="250679380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250679380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250679380">(Aug 25 2021 at 20:40)</a>:</h4>
<p>Is it possible to use regular attributes (<code>#[attr(arbitrary token stream)]</code>) for this?<br>
They are already attached to <code>DefId</code>s, encoded into metadata, and can contain pretty arbitrary data.</p>



<a name="250688659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250688659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250688659">(Aug 25 2021 at 21:57)</a>:</h4>
<p>No it's not possible to use normal attributes because I need to add them after typechecking, in fact I need to add them after MIR is generated. I'm using 'item' here in the rustc sense, I need to attach to functions, trait method declarations, potentially even type declarations.</p>



<a name="250688757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250688757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250688757">(Aug 25 2021 at 21:58)</a>:</h4>
<p>Basically, I'm compiling rust functions to logical expressions and I want to save those expressions, just like rustc saves the mir for inlineable functions.</p>



<a name="250734526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250734526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250734526">(Aug 26 2021 at 07:31)</a>:</h4>
<p>You can use <code>-Zalways-encode-mir</code> to always encode mir in the crate metadata for all functions, not just inlineable and generic functions. Maybe you could then do the compilation to logic expressions in the binary crate instead of in every library?</p>



<a name="250734632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250734632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250734632">(Aug 26 2021 at 07:32)</a>:</h4>
<p>Another option would be to make it a custom "codegen" backend and have the logic expressions be the "object files".</p>



<a name="250786072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250786072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250786072">(Aug 26 2021 at 14:59)</a>:</h4>
<p>For fairly complex reasons that wouldn’t work</p>



<a name="250786214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250786214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250786214">(Aug 26 2021 at 15:00)</a>:</h4>
<p>I actually generate functions that don’t have valid mir and read them out as THIR</p>



<a name="250786442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250786442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250786442">(Aug 26 2021 at 15:01)</a>:</h4>
<p>So always encore mir wouldn’t be of any use and similarity for a custom codegen backend</p>



<a name="250786554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250786554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250786554">(Aug 26 2021 at 15:01)</a>:</h4>
<p>For the moment I’m just using <code>output_filenames</code> to recover the storage location for a crate</p>



<a name="250786705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250786705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250786705">(Aug 26 2021 at 15:02)</a>:</h4>
<p>And I can read it back by loading it from the crate source in a dependent crate</p>



<a name="250787479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Adding%20an%20attribute%20to%20a%20DefId/near/250787479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Adding.20an.20attribute.20to.20a.20DefId.html#250787479">(Aug 26 2021 at 15:07)</a>:</h4>
<p>I think I’m pushing the limits of how rustc was meant to be used</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>