<html>
<head><meta charset="utf-8"><title>Type coercion for Traits implemented on fn pointers · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Type.20coercion.20for.20Traits.20implemented.20on.20fn.20pointers.html">Type coercion for Traits implemented on fn pointers</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270302729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Type%20coercion%20for%20Traits%20implemented%20on%20fn%20pointers/near/270302729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Type.20coercion.20for.20Traits.20implemented.20on.20fn.20pointers.html#270302729">(Feb 01 2022 at 22:58)</a>:</h4>
<p>Hi!</p>
<p>I have been trying to come up with a type system to call a certain trait on a function pointer. I first tried what I have also done in the playground below, but then manual type coercion is necessary for multiple trait implementations. This is not really an option for me since this should be in the public API.</p>
<p>I then tried a method using Fn traits, and this worked perfectly for the type system, however it seems to be impossible to retrieve a function pointer from a Fn trait item. (for example a method like <code>fn test&lt;F: Fn()&gt;(f: F) { f as usize };</code>.</p>
<p>Is there any specific reason why the compiler does this type coercion automatically with a single implementation, but once more implementations arise, this has to be done manually?</p>
<p>And then is there any way to work around this issue? I have been trying many different things but every method seems to fall just short of what I would ideally want.</p>
<p>Jasper</p>
<p>I have created the following playground to show my issue, this compiles just fine:<br>
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=fc8821ed4c6124eda772b8ac166137ee">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=fc8821ed4c6124eda772b8ac166137ee</a><br>
While uncommenting a trait implementation gives strange errors:<br>
<a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=4f2338d0139581af3c817a2099fa1ca7">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=4f2338d0139581af3c817a2099fa1ca7</a></p>



<a name="270304350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Type%20coercion%20for%20Traits%20implemented%20on%20fn%20pointers/near/270304350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Type.20coercion.20for.20Traits.20implemented.20on.20fn.20pointers.html#270304350">(Feb 01 2022 at 23:10)</a>:</h4>
<p>So it turns out that type coercion for generic method parameters fails when you have more than one impl that applies to a given caller.</p>



<a name="270304384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Type%20coercion%20for%20Traits%20implemented%20on%20fn%20pointers/near/270304384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Type.20coercion.20for.20Traits.20implemented.20on.20fn.20pointers.html#270304384">(Feb 01 2022 at 23:10)</a>:</h4>
<p>I documented a similar <a href="https://github.com/rust-lang/rust/issues/92178">#92178</a>, where adding a new impl <code>Add&lt;T&gt; for String</code> for a local type <code>T</code> makes it so that there are now _two_ different choices for <code>Add&lt;_&gt; for String</code>, which means <code>&amp;String</code> no longer coerces to <code>&amp;str</code>, causing <code>&amp;String + &amp;String</code> to fail.</p>



<a name="270304608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Type%20coercion%20for%20Traits%20implemented%20on%20fn%20pointers/near/270304608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Type.20coercion.20for.20Traits.20implemented.20on.20fn.20pointers.html#270304608">(Feb 01 2022 at 23:12)</a>:</h4>
<p>The reason your case fails is that a function referenced by name has a distinct type from its function signature. E.g. <code>fn foo() -&gt; usize</code> has the type <code>fn() -&gt; usize {foo}</code> (corresponding to <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/sty/enum.TyKind.html#variant.FnDef"><code>TyKind::FnDef</code></a>), which _usually_ gets coerced into <code>fn() -&gt; usize</code> when needed.</p>



<a name="270306714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Type%20coercion%20for%20Traits%20implemented%20on%20fn%20pointers/near/270306714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Type.20coercion.20for.20Traits.20implemented.20on.20fn.20pointers.html#270306714">(Feb 01 2022 at 23:29)</a>:</h4>
<p>Okay thanks for the explanation.<br>
Should I open some kind of issue for this? I don't know a lot about rustc, so I can't really help with implementation</p>



<a name="270306928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Type%20coercion%20for%20Traits%20implemented%20on%20fn%20pointers/near/270306928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Type.20coercion.20for.20Traits.20implemented.20on.20fn.20pointers.html#270306928">(Feb 01 2022 at 23:31)</a>:</h4>
<p>Sure. If you could minimize this code even further to just capture the issue itself, that would help too. Feel free to cc me on the issue, and I can write some explanation for what's happening on the type checker side.</p>



<a name="270307002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Type%20coercion%20for%20Traits%20implemented%20on%20fn%20pointers/near/270307002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Type.20coercion.20for.20Traits.20implemented.20on.20fn.20pointers.html#270307002">(Feb 01 2022 at 23:31)</a>:</h4>
<p>Okay, I will do that tomorrow then!</p>



<a name="270380214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Type%20coercion%20for%20Traits%20implemented%20on%20fn%20pointers/near/270380214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Type.20coercion.20for.20Traits.20implemented.20on.20fn.20pointers.html#270380214">(Feb 02 2022 at 13:07)</a>:</h4>
<p>I have just created a new bug report and tagged you in it: <a href="https://github.com/rust-lang/rust/issues/93583">https://github.com/rust-lang/rust/issues/93583</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>