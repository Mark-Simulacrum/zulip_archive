<html>
<head><meta charset="utf-8"><title>link error running x.py test for tier 3 target · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/link.20error.20running.20x.2Epy.20test.20for.20tier.203.20target.html">link error running x.py test for tier 3 target</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275325917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/link%20error%20running%20x.py%20test%20for%20tier%203%20target/near/275325917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian Chamberlain <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/link.20error.20running.20x.2Epy.20test.20for.20tier.203.20target.html#275325917">(Mar 15 2022 at 03:34)</a>:</h4>
<p>Hi all, I'm trying to get <code>std</code> tests building for a tier 3 target (armv6k-nintendo-3ds), which involves adding some additional crate dependencies to <code>std</code>/<code>test</code>. I was able to figure out how to add <code>rustc-dep-of-std</code> to those crates to get it to compile, but now I am having trouble on the link step (paths snipped for brevity):</p>
<div class="codehilite"><pre><span></span><code>   = note: [snip]/arm-none-eabi/bin/ld: error: [snip]/build/x86_64-apple-darwin/stage2-std/armv6k-nintendo-3ds/release/deps/env-9bce6c50da19af1c.elf uses VFP register arguments, [snip]/build/x86_64-apple-darwin/stage2/lib/rustlib/armv6k-nintendo-3ds/lib/libcompiler_builtins-26cfa4366ea7e49c.rlib(aeabi_div0.o) does not
          [snip]/arm-none-eabi/bin/ld: failed to merge target specific data of file [snip]/build/x86_64-apple-darwin/stage2/lib/rustlib/armv6k-nintendo-3ds/lib/libcompiler_builtins-26cfa4366ea7e49c.rlib(aeabi_div0.o)
          [snip]/arm-none-eabi/bin/ld: [snip]/build/x86_64-apple-darwin/stage2/lib/rustlib/armv6k-nintendo-3ds/lib/libtest-f10af7a1a033fdd2.rlib(test-f10af7a1a033fdd2.2sf7fgsggypk7nze.rcgu.o): in function `test::stats::Summary::new&#39;:
          2sf7fgsggypk7nze:(.text._ZN4test5stats7Summary3new17hff54412dc9ac41b3E+0x54): undefined reference to `fmin&#39;
          [snip]/arm-none-eabi/bin/ld: 2sf7fgsggypk7nze:(.text._ZN4test5stats7Summary3new17hff54412dc9ac41b3E+0x74): undefined reference to `fmax&#39;
          [snip]/arm-none-eabi/bin/ld: 2sf7fgsggypk7nze:(.text._ZN4test5stats7Summary3new17hff54412dc9ac41b3E+0x110): undefined reference to `floor&#39;

... lots more undefined references...
</code></pre></div>
<p>The only tips so far I have found online are <a href="https://github.com/rust-embedded/book/issues/255">this rust-embedded issue</a>, which seems to be intended for normal (possibly <code>no_std</code>) crates, and I don't need to do any of that stuff when building a normal crate.</p>
<p>For reference I am trying to use <code>./x.py test -v library/std  --stage 1 --no-doc --run never --target armv6k-nintendo-3ds</code> (also tried stage 2 just for fun), and I've tried various incantations using <code>--rustc-args "-C link-arg=..."</code> but have seen no difference in behavior with any of those. </p>
<p>Is there some way I can tell rustbuild to force build <code>compiler_builtins</code> with <code>-mfloat-abi=hard</code> (and probably also other <code>pre_link_args</code> for the target)? I would have thought it would normally just use the defaults for the target like all the other crates, but inspecting files like <code>build/x86_64-apple-darwin/stage2/lib/rustlib/armv6k-nintendo-3ds/lib/libcompiler_builtins-26cfa4366ea7e49c.rlib</code> with <code>arm-none-eabi-readelf -A</code> does not show <code>Tag_ABI_VFP_args: VFP registers</code> like I would expect (and does show <code>VFP Registers</code> for <code>libstd-$HASH.rlib</code>, <code>libtest</code>, etc.)</p>
<p>Thanks in advance if you are able to help me!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>