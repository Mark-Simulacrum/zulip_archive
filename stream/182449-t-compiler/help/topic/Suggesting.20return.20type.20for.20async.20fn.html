<html>
<head><meta charset="utf-8"><title>Suggesting return type for async fn · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Suggesting.20return.20type.20for.20async.20fn.html">Suggesting return type for async fn</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258286728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Suggesting%20return%20type%20for%20async%20fn/near/258286728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jieyou Xu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Suggesting.20return.20type.20for.20async.20fn.html#258286728">(Oct 19 2021 at 23:05)</a>:</h4>
<p>Hi all, new here, so I'm sorry if my question/understanding below is totally flawed.</p>
<p>I'm working on <a href="https://github.com/rust-lang/rust/issues/90027">#90027</a> trying to<br>
make the suggestion of adding a missing return type to an <code>async</code> function declaration when:</p>
<ol>
<li>the function's body block type is not unit (the "found" type), but</li>
<li>the function's declaration is the default return type (unit) and is not <code>main</code> (the "expected"<br>
   type).</li>
</ol>
<p>This suggestion is emitted for regular <code>fn</code>s, but is not emitted for <code>async fn</code>s currently. I'm having trouble<br>
trying to compute the "expected" return type of an <code>async fn</code> that can "see through" the desugaring,<br>
since I <em>think</em> the logic used to check suggestion applicability for regular <code>fn</code>s do not apply to<br>
<code>async fn</code> because of the desugaring into a closure that implements some trait which causes the<br>
"expected type" to change from unit (<code>DefaultReturn</code>) to some opaque type? I think that this means that<br>
an <code>async fn foo()</code> declaration while seemingly is <code>DefaultReturn</code> before desugaring, is no longer so after<br>
desugaring.</p>
<p>In <a href="https://github.com/rust-lang/rust/blob/1af55d19c7a9189374d89472f97dc119659bb67e/compiler/rustc_typeck/src/check/fn_ctxt/suggestions.rs?_pjax=%23js-repo-pjax-container%2C%20div%5Bitemtype%3D%22http%3A%2F%2Fschema.org%2FSoftwareSourceCode%22%5D%20main%2C%20%5Bdata-pjax-container%5D#L502"><code>rustc_typeck::check::fn_ctxt::suggestions::suggest_missing_return_type</code></a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">fn_decl</span><span class="p">.</span><span class="n">output</span><span class="p">,</span><span class="w"> </span><span class="n">found</span><span class="p">.</span><span class="n">is_suggestable</span><span class="p">(),</span><span class="w"> </span><span class="n">can_suggest</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="p">.</span><span class="n">is_unit</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="o">&amp;</span><span class="n">hir</span>::<span class="n">FnRetTy</span>::<span class="n">DefaultReturn</span><span class="p">(</span><span class="n">span</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">err</span><span class="p">.</span><span class="n">span_suggestion</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">span</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s">"try adding a return type"</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="fm">format!</span><span class="p">(</span><span class="s">"-&gt; {} "</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">resolve_vars_with_obligations</span><span class="p">(</span><span class="n">found</span><span class="p">)),</span><span class="w"></span>
<span class="w">            </span><span class="n">Applicability</span>::<span class="n">MachineApplicable</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kc">true</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
</code></pre></div>
<p>I think this suggestion to add a <code>-&gt; FoundReturnType</code> suggestion doesn't get triggered for<br>
<code>async fn</code> because desugaring causes <code>expected.is_unit()</code> to become false?</p>
<p>I would appreciate any guidance on this matter as to how to proceed. I'm not 100% certain of the<br>
<code>impl Trait</code> opaque type post-desugaring, if it is some <code>impl Future&lt;Output = ()&gt;</code> expected type<br>
post-desugaring for the async fn declaration then could we use that to justify the suggestion of<br>
using the found type of the closure generated for the pre-desugaring replacement (seems very hacky)?</p>
<p>If I try to print the pretty HIR dump for a trivial <code>async fn</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">hello</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I get something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">hello</span><span class="p">()</span><span class="w"></span>
<span class="w"> </span>-&gt;
     <span class="cm">/*impl Trait*/</span><span class="w"> </span><span class="cp">#[lang = </span><span class="s">"from_generator"</span><span class="cp">]</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="k">mut</span><span class="w"> </span><span class="n">_task_context</span><span class="o">|</span><span class="w"></span>
<span class="w">                                                   </span><span class="p">{</span><span class="w"></span>
<span class="w">                                                       </span><span class="p">{</span><span class="w"></span>
<span class="w">                                                           </span><span class="kd">let</span><span class="w"> </span><span class="n">_t</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                                                               </span><span class="p">{</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">                                                           </span><span class="n">_t</span><span class="w"></span>
<span class="w">                                                       </span><span class="p">}</span><span class="w"></span>
<span class="w">                                                   </span><span class="p">})</span><span class="w"></span>
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>