<html>
<head><meta charset="utf-8"><title>llvm branch coverage · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html">llvm branch coverage</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="221957585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/221957585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#221957585">(Jan 07 2021 at 15:45)</a>:</h4>
<p><span class="user-mention" data-user-id="296355">@Rich Kadel</span> I recently stumbled upon the <code>llvm-cov</code> tool getting proper branch coverage reporting: <a href="https://github.com/llvm/llvm-project/commit/9f2967bcfe2f7d1fc02281f0098306c90c2c10a5">https://github.com/llvm/llvm-project/commit/9f2967bcfe2f7d1fc02281f0098306c90c2c10a5</a></p>



<a name="221957744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/221957744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#221957744">(Jan 07 2021 at 15:46)</a>:</h4>
<p>will that automatically work with the coverage mappings that rust generates?</p>



<a name="221958009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/221958009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#221958009">(Jan 07 2021 at 15:48)</a>:</h4>
<p>I’m trying to better understand the terminology of llvm, also figuring out how to read the json output format</p>



<a name="221959737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/221959737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#221959737">(Jan 07 2021 at 16:00)</a>:</h4>
<p>skimming through that patch, looks like it indeed introduces a new covmap version, so I guess a patch to rust will be needed to support that.</p>



<a name="222011742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/222011742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#222011742">(Jan 07 2021 at 22:36)</a>:</h4>
<p>Yep, there's an issue already: <a href="https://github.com/rust-lang/rust/issues/79649">https://github.com/rust-lang/rust/issues/79649</a></p>
<p>But from what I can tell, this isn't implemented in a stable build of LLVM yet, and when it is, I assume it will be LLVM 13 or later. Rust is still on LLVM 11. So it will be a while before this can be entertained.</p>



<a name="222059612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/222059612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#222059612">(Jan 08 2021 at 11:01)</a>:</h4>
<p>awesome!</p>



<a name="258214628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/258214628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#258214628">(Oct 19 2021 at 15:25)</a>:</h4>
<p>ah, forgot that I actually created this topic long ago. <span class="user-mention" data-user-id="296355">@Rich Kadel</span> looking at the excellent dev guide docs for coverage instrumentation. I think I can dive a bit deeper into it to try to get branch coverage working</p>



<a name="258214967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/258214967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#258214967">(Oct 19 2021 at 15:26)</a>:</h4>
<p>maybe unrelated, but I have seen a few "malformed instrumentation profile data" error, reported here:<br>
<a href="https://github.com/Swatinem/fucov/issues/3">https://github.com/Swatinem/fucov/issues/3</a><br>
and also here: <a href="https://github.com/getsentry/sentry-rust/runs/3927982670">https://github.com/getsentry/sentry-rust/runs/3927982670</a><br>
do you have any quick hunch as to why that might happen? simpler examples are working fine, like the examples in fucov itself, or the rust compiler tests</p>



<a name="258224249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/258224249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#258224249">(Oct 19 2021 at 16:15)</a>:</h4>
<p>cc: <span class="user-mention" data-user-id="116883">@tmandry</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span></p>



<a name="258224417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/258224417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#258224417">(Oct 19 2021 at 16:16)</a>:</h4>
<p>The "malformed instrumentation profile data" errors are unrelated to this topic (known issue, but let's keep it to a separate thread)</p>



<a name="258225604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/258225604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#258225604">(Oct 19 2021 at 16:22)</a>:</h4>
<p>The only thing I would add, about "branch coverage" is, is it really adding any value to Rust's implementation of LLVM coverage? In the existing implementation, I tried to capture the "else" (and similar) branches as well, for example, I think it appears this way:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">15</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">some_condition</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="mi">5</span><span class="w">    </span><span class="n">some</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">coverage</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s">"true"</span><span class="w"></span>
<span class="mi">15</span><span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="o">^</span><span class="mi">10</span><span class="w"></span>
</code></pre></div>



<a name="258225883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/258225883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#258225883">(Oct 19 2021 at 16:24)</a>:</h4>
<p>From this, I know <code>some_condition</code> was <code>true</code> 5 times and <code>false</code> 10 times.</p>
<p>I haven't explored LLVM's implementation of branch coverage in much detail, so maybe there are some additional improvements that would make a difference. I'm curious to know if that's the case.</p>



<a name="258238793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/258238793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#258238793">(Oct 19 2021 at 17:33)</a>:</h4>
<p>I haven’t looked in too much detail yet, my understanding would be that I can have the actual conditional being flagged with true/false counts</p>



<a name="258238852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/258238852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#258238852">(Oct 19 2021 at 17:33)</a>:</h4>
<p>not quite sure how the current implementation looks like when you have short circuiting conditions</p>



<a name="258392163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/llvm%20branch%20coverage/near/258392163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/llvm.20branch.20coverage.html#258392163">(Oct 20 2021 at 15:50)</a>:</h4>
<p>I think the current results give enough information to understand the coverage counts accurately, even with short circuiting. There should be test results to demonstrate this, in the rustc coverage tests, and it would be easy to construct your own tests to see if you can fool it (to demonstrate if branch coverage really does add value). I'd be very interested in seeing this, and happy if we can improve coverage results, if it turns out the existing results are not sufficient.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>