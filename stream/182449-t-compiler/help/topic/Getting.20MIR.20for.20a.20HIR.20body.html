<html>
<head><meta charset="utf-8"><title>Getting MIR for a HIR body · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Getting.20MIR.20for.20a.20HIR.20body.html">Getting MIR for a HIR body</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253525880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Getting%20MIR%20for%20a%20HIR%20body/near/253525880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jichun Wu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Getting.20MIR.20for.20a.20HIR.20body.html#253525880">(Sep 16 2021 at 04:04)</a>:</h4>
<p>Hi there, I am a bit overwhelmed by the rust compiler so sorry if this is a dumb question. </p>
<p>I am working on a visitor to extract certain information from MIR, so I need to get the MIR for a <code>hir::Body</code>. The code I am using (<a href="https://github.com/rust-corpus/qrates/blob/main/extractor/src/hir_visitor.rs#L421">https://github.com/rust-corpus/qrates/blob/main/extractor/src/hir_visitor.rs#L421</a>) looks like this</p>
<div class="codehilite"><pre><span></span><code>fn visit_body(&amp;mut self, body: &amp;&#39;tcx hir::Body) {
    intravisit::walk_body(self, body);
    let id = body.id();
    let owner = self.hir_map.body_owner_def_id(id);

    let mir_body = if self.tcx.is_ctfe_mir_available(owner) {
        self.tcx.mir_for_ctfe(owner)
    } else {
        self.tcx.optimized_mir(owner)
    };

    self.visit_mir(owner, mir_body);
}
</code></pre></div>
<p>But this crashes with</p>
<div class="codehilite"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;mir_for_ctfe should not be used for runtime functions&#39;, compiler/rustc_mir/src/transform/mod.rs:365:10
stack backtrace:
   0: rust_begin_unwind
             at /rustc/2f391da2e6ac73faa3570b79de239fd8c0edf1a9/library/std/src/panicking.rs:515:5
   1: core::panicking::panic_fmt
             at /rustc/2f391da2e6ac73faa3570b79de239fd8c0edf1a9/library/core/src/panicking.rs:92:14
   2: core::option::expect_failed
             at /rustc/2f391da2e6ac73faa3570b79de239fd8c0edf1a9/library/core/src/option.rs:1577:5
   3: rustc_mir::transform::inner_mir_for_ctfe
   4: rustc_mir::transform::mir_for_ctfe
   5: rustc_query_system::query::plumbing::get_query_impl
   6: &lt;rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine&gt;::mir_for_ctfe
   7: &lt;corpus_extractor::hir_visitor::HirVisitor as rustc_hir::intravisit::Visitor&gt;::visit_body
   8: rustc_hir::intravisit::walk_fn
   9: &lt;corpus_extractor::hir_visitor::HirVisitor as rustc_hir::intravisit::Visitor&gt;::visit_fn
  10: rustc_hir::intravisit::walk_impl_item
  11: rustc_hir::intravisit::walk_item
  12: &lt;corpus_extractor::hir_visitor::HirVisitor as rustc_hir::intravisit::Visitor&gt;::visit_item
  13: &lt;corpus_extractor::hir_visitor::HirVisitor as rustc_hir::intravisit::Visitor&gt;::visit_item
  14: rustc_hir::intravisit::walk_crate
  15: corpus_extractor::analyse_with_tcx
  16: corpus_extractor::analyse
  17: &lt;rustc::CorpusCallbacks as rustc_driver::Callbacks&gt;::after_analysis
  18: rustc_interface::queries::&lt;impl rustc_interface::interface::Compiler&gt;::enter
  19: rustc_span::with_source_map
  20: rustc_interface::interface::create_compiler_and_run
  21: scoped_tls::ScopedKey&lt;T&gt;::set
</code></pre></div>
<p>If I just do</p>
<div class="codehilite"><pre><span></span><code>let mir_body = self.tcx.optimized_mir(owner);
</code></pre></div>
<p>I will get </p>
<div class="codehilite"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;do not use `optimized_mir` for constants: Const&#39;, compiler/rustc_mir/src/transform/mod.rs:585:24
stack backtrace:
   0: rust_begin_unwind
             at /rustc/2f391da2e6ac73faa3570b79de239fd8c0edf1a9/library/std/src/panicking.rs:515:5
   1: std::panicking::begin_panic_fmt
             at /rustc/2f391da2e6ac73faa3570b79de239fd8c0edf1a9/library/std/src/panicking.rs:457:5
   2: rustc_mir::transform::optimized_mir
   3: rustc_query_system::query::plumbing::get_query_impl
   4: &lt;rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine&gt;::optimized_mir
   5: &lt;corpus_extractor::hir_visitor::HirVisitor as rustc_hir::intravisit::Visitor&gt;::visit_body
   6: &lt;corpus_extractor::hir_visitor::HirVisitor as rustc_hir::intravisit::Visitor&gt;::visit_item
   7: rustc_hir::intravisit::walk_stmt
   8: rustc_hir::intravisit::walk_expr
   9: &lt;corpus_extractor::hir_visitor::HirVisitor as rustc_hir::intravisit::Visitor&gt;::visit_body
  10: rustc_hir::intravisit::walk_fn
  11: &lt;corpus_extractor::hir_visitor::HirVisitor as rustc_hir::intravisit::Visitor&gt;::visit_fn
  12: rustc_hir::intravisit::walk_expr
  13: rustc_hir::intravisit::walk_expr
  14: rustc_hir::intravisit::walk_expr
  15: rustc_hir::intravisit::walk_expr
  16: rustc_hir::intravisit::walk_stmt
  17: rustc_hir::intravisit::walk_expr
  18: &lt;corpus_extractor::hir_visitor::HirVisitor as rustc_hir::intravisit::Visitor&gt;::visit_body
  19: rustc_hir::intravisit::walk_fn
  20: &lt;corpus_extractor::hir_visitor::HirVisitor as rustc_hir::intravisit::Visitor&gt;::visit_fn
  21: rustc_hir::intravisit::walk_impl_item
  22: rustc_hir::intravisit::walk_item
  23: &lt;corpus_extractor::hir_visitor::HirVisitor as rustc_hir::intravisit::Visitor&gt;::visit_item
  24: rustc_hir::intravisit::walk_crate
  25: corpus_extractor::analyse_with_tcx
  26: corpus_extractor::analyse
  27: &lt;rustc::CorpusCallbacks as rustc_driver::Callbacks&gt;::after_analysis
  28: rustc_interface::queries::&lt;impl rustc_interface::interface::Compiler&gt;::enter
  29: rustc_span::with_source_map
  30: rustc_interface::interface::create_compiler_and_run
  31: scoped_tls::ScopedKey&lt;T&gt;::set
</code></pre></div>
<p>So, I am looking for a correct way to get the MIR right. Any help will be greatly appreciated. Thanks a lot in advance!</p>



<a name="253633652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Getting%20MIR%20for%20a%20HIR%20body/near/253633652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Getting.20MIR.20for.20a.20HIR.20body.html#253633652">(Sep 16 2021 at 19:04)</a>:</h4>
<p>Being overwhelmed is fairly common. It's not a dumb question.</p>



<a name="253635886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Getting%20MIR%20for%20a%20HIR%20body/near/253635886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Getting.20MIR.20for.20a.20HIR.20body.html#253635886">(Sep 16 2021 at 19:19)</a>:</h4>
<p>That said, it <strong>is</strong> one which leaves me with other questions:</p>
<blockquote>
<p>I am working on a visitor to extract certain information from MIR, so I need to get the MIR for a hir::Body. The code I am using (<a href="https://github.com/rust-corpus/qrates/blob/main/extractor/src/hir_visitor.rs#L421">https://github.com/rust-corpus/qrates/blob/main/extractor/src/hir_visitor.rs#L421</a>) looks like this</p>
</blockquote>
<p>extracting "certain information"? Why do you need to go from hir::Body to MIR? What information is missing in the HIR that requires you to access the MIR? How do you know the MIR exists at this point? Why not literally just running rustc with <code>--emit=mir</code>?</p>
<p>These functions aren't really friendly for out-of-compiler usage, as you have guessed, since they are more... purpose-driven. If it's just "any question", why not nudge the compiler along to drive compilation forward a few steps in creating the MIR? <a href="https://rustc-dev-guide.rust-lang.org/mir/construction.html">https://rustc-dev-guide.rust-lang.org/mir/construction.html</a></p>



<a name="253637608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Getting%20MIR%20for%20a%20HIR%20body/near/253637608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Getting.20MIR.20for.20a.20HIR.20body.html#253637608">(Sep 16 2021 at 19:31)</a>:</h4>
<p>You don't actually have to answer all of those questions: they are just the sort of noise in my brain that is ultimately asking "is this the correct approach for your problem?"<br>
Also possibly useful for you:<br>
A MIR visitor: <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/visit/index.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/visit/index.html</a><br>
A way to find where in the HIR some MIR came from: <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/struct.MirSource.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/struct.MirSource.html</a></p>



<a name="253674301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Getting%20MIR%20for%20a%20HIR%20body/near/253674301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Getting.20MIR.20for.20a.20HIR.20body.html#253674301">(Sep 17 2021 at 01:06)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/86299">https://github.com/rust-lang/rust/issues/86299</a> also there are... kinda multiple MIRs.</p>



<a name="253930535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Getting%20MIR%20for%20a%20HIR%20body/near/253930535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Getting.20MIR.20for.20a.20HIR.20body.html#253930535">(Sep 19 2021 at 09:02)</a>:</h4>
<p>I would locate the part of code that is responsible for throwing error you encountered and replicating its logic to decide between <code>mir_for_ctfe</code> and <code>optimized_mir</code>. (For the local crate <code>is_ctfe_mir_available</code> is the same as <code>is_mir_available</code>, so that cannot be used to make distinction).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>