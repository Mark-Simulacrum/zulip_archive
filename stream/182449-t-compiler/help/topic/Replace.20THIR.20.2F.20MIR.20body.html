<html>
<head><meta charset="utf-8"><title>Replace THIR / MIR body · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html">Replace THIR / MIR body</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250238533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238533">(Aug 21 2021 at 21:43)</a>:</h4>
<p>Is there anyway to replace a THIR / MIR body? In particular I'd like to replace the body of certain DefIds <em>before</em> borrow checking occurs so around the moment that <code>mir_built</code> occurs.</p>



<a name="250238577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238577">(Aug 21 2021 at 21:44)</a>:</h4>
<p>From what I can tell, i can only edit the <code>MIR</code> by stealing it but that would screw up further compilation...</p>



<a name="250238604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238604">(Aug 21 2021 at 21:45)</a>:</h4>
<p>I suppose if a solution exists for <code>HIR</code> that could also work</p>



<a name="250238626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238626">(Aug 21 2021 at 21:45)</a>:</h4>
<p>rustdoc tried this for HIR and it didn't go well <a href="https://github.com/rust-lang/rust/pull/73566">https://github.com/rust-lang/rust/pull/73566</a></p>



<a name="250238689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238689">(Aug 21 2021 at 21:47)</a>:</h4>
<p>ah hmm ok</p>



<a name="250238692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238692">(Aug 21 2021 at 21:47)</a>:</h4>
<p>it might be <em>possible</em> but I would expect it to be hard</p>



<a name="250238898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238898">(Aug 21 2021 at 21:52)</a>:</h4>
<p>In my situation I have a<code>DefId</code> which references other <code>DefIds</code> which I <strong>know</strong> to be invalid, I'd like to either edit the bodies of those <code>DefIds</code> to replace them with <code>abort</code> or edit the original <code>DefId</code> to no longer refer to the 'child' defids</p>



<a name="250238903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238903">(Aug 21 2021 at 21:53)</a>:</h4>
<p>you're saying that its too hard at HIR level but is there any other stage I can intervene at?</p>



<a name="250238911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238911">(Aug 21 2021 at 21:53)</a>:</h4>
<p>I don't know, sorry. FWIW it sounds like your thing is a lot more narrow in scope than what rustdoc is doing, so it might be easier</p>



<a name="250238912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238912">(Aug 21 2021 at 21:53)</a>:</h4>
<p>im ideally looking for a point <em>between</em> typechecking and borrow checking</p>



<a name="250238914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238914">(Aug 21 2021 at 21:53)</a>:</h4>
<p>rustdoc was replacing entire function bodies</p>



<a name="250238921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238921">(Aug 21 2021 at 21:53)</a>:</h4>
<p>yea i mean that is how i was planning on implementing it tbh</p>



<a name="250238965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250238965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250238965">(Aug 21 2021 at 21:54)</a>:</h4>
<p>I just need to replace certain function bodies..</p>



<a name="250239819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250239819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250239819">(Aug 21 2021 at 22:14)</a>:</h4>
<p>You could provide your own implementation of mir_built to the query system, to wrap and modify the output of the original mir_built. Client code would implicitly invoke your implementation and benefit from the modifications.</p>



<a name="250240011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250240011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250240011">(Aug 21 2021 at 22:19)</a>:</h4>
<p>oh wait that's possible?</p>



<a name="250240016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250240016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250240016">(Aug 21 2021 at 22:19)</a>:</h4>
<p>how do I override the query?</p>



<a name="250240081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250240081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250240081">(Aug 21 2021 at 22:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Replace.20THIR.20.2F.20MIR.20body/near/250240016">said</a>:</p>
<blockquote>
<p>how do I override the query?</p>
</blockquote>
<p><a href="https://github.com/rust-lang/rust/blob/b1928aa3b4a8a2df462e408b67ad29737a3f8f31/src/librustdoc/core.rs#L282">https://github.com/rust-lang/rust/blob/b1928aa3b4a8a2df462e408b67ad29737a3f8f31/src/librustdoc/core.rs#L282</a></p>



<a name="250240090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250240090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250240090">(Aug 21 2021 at 22:20)</a>:</h4>
<p>(obviously the bit that comes before <code>DEFAULT_QUERY_PROVIDERS</code> will be different)</p>



<a name="250240124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250240124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250240124">(Aug 21 2021 at 22:21)</a>:</h4>
<p>ok this is sick... time to write more hacks</p>



<a name="250240174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250240174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250240174">(Aug 21 2021 at 22:22)</a>:</h4>
<p>im making poor rustc suffer so much :(</p>



<a name="250242913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250242913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250242913">(Aug 21 2021 at 23:26)</a>:</h4>
<p>hmmm replacing the body in <code>mir_built</code> <em>almost</em> works, but I'm still getting move errors because old, invalid information is leaking through the <code>InfCtx</code></p>



<a name="250243014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250243014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250243014">(Aug 21 2021 at 23:29)</a>:</h4>
<p>i just need to figure out how to clear out the information about captured variables and i'm home free!!!</p>



<a name="250284805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Replace%20THIR%20/%20MIR%20body/near/250284805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Replace.20THIR.20.2F.20MIR.20body.html#250284805">(Aug 22 2021 at 17:35)</a>:</h4>
<p>I've done it! I managed to trick rustc and erase the body of specific functions before borrow checking!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>