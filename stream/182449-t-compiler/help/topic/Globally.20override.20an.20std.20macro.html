<html>
<head><meta charset="utf-8"><title>Globally override an std macro · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html">Globally override an std macro</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268790329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268790329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zyad Hassan <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268790329">(Jan 21 2022 at 03:05)</a>:</h4>
<p>Hi all. We're working on a verification backend for the rust compiler, and we were looking for a way to globally override some of the standard library macros. For instance, if we add a definition for the <code>assert</code> macro in a <code>macro_overrides</code> crate as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[macro_export]</span><span class="w"></span>
<span class="fm">macro_rules!</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="cp">$cond</span>:<span class="nc">expr</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Some debug information"</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span>::<span class="fm">assert!</span><span class="p">(</span><span class="cp">$cond</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and specify <code>--extern macro_overrides</code> when compiling each crate, is there a way to make every call to <code>assert!</code> in a package use the <code>macro_overrides</code> version of the <code>assert</code> without explicitly adding a <code>use macro_overrides::assert;</code> in every crate?</p>



<a name="268795552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268795552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268795552">(Jan 21 2022 at 04:45)</a>:</h4>
<p>I can't infer your use case from this, do you want any user to be able to override a macro, or do you just want to change it for all uses of your compiler backend? What is stopping you from shipping your own standard library?</p>



<a name="268800135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268800135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zyad Hassan <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268800135">(Jan 21 2022 at 06:05)</a>:</h4>
<blockquote>
<p>do you want any user to be able to override a macro, or do you just want to change it for all uses of your compiler backend?</p>
</blockquote>
<p>The latter: we want to change it for all uses of our compiler backend without requiring the user to make any modifications to their code.</p>
<blockquote>
<p>What is stopping you from shipping your own standard library?</p>
</blockquote>
<p>This is an interesting idea. As far as I could see though, the <code>assert</code> macro is not fully defined in the standard library:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="cp">#[rustc_builtin_macro]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[macro_export]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[rustc_diagnostic_item = </span><span class="s">"assert_macro"</span><span class="cp">]</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[allow_internal_unstable(core_panic, edition_panic)]</span><span class="w"></span>
<span class="w">    </span><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">assert</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="cp">$cond</span>:<span class="nc">expr</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="cm">/* compiler built-in */</span><span class="w"> </span><span class="p">}};</span><span class="w"></span>
<span class="w">        </span><span class="p">(</span><span class="cp">$cond</span>:<span class="nc">expr</span><span class="p">,</span><span class="w"> </span><span class="cp">$($arg</span>:<span class="nc">tt</span><span class="p">)</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="cm">/* compiler built-in */</span><span class="w"> </span><span class="p">}};</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><a href="https://github.com/rust-lang/rust/blob/777bb86bcdbc568be7cff6eeeaaf81a89b4aa50b/library/core/src/macros/mod.rs#L1395">Source</a><br>
so it seems that there is some compiler magic done when expanding the macro. I'm not sure what would happen if I modify its definition. I can give that a try.</p>



<a name="268805131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268805131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268805131">(Jan 21 2022 at 07:41)</a>:</h4>
<p>The <code>#[rustc_builtin_macro]</code> attribute causes code built into rustc to be used for expanding it. If you want to replace the definition of this macro you will have to remove the attribute.</p>



<a name="268827845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268827845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268827845">(Jan 21 2022 at 11:16)</a>:</h4>
<p>That is, do:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-   #[rustc_builtin_macro]</span>
    #[macro_export]
    #[rustc_diagnostic_item = "assert_macro"]
    #[allow_internal_unstable(core_panic, edition_panic)]
    macro_rules! assert {
<span class="gd">-       ($cond:expr $(,)?) =&gt; {{ /* compiler built-in */ }};</span>
<span class="gd">-       ($cond:expr, $($arg:tt)+) =&gt; {{ /* compiler built-in */ }};</span>
<span class="gi">+       ( $($input:tt)* ) =&gt; ( ::macro_overrides::assert! { $($input)* } );</span>
    }
</code></pre></div>



<a name="268827918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268827918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268827918">(Jan 21 2022 at 11:17)</a>:</h4>
<p>(and obviously this requires that your own <code>assert!</code> macro not call back into the stdlib's one!)</p>



<a name="268871554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268871554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zyad Hassan <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268871554">(Jan 21 2022 at 17:03)</a>:</h4>
<p>Got it, thanks!</p>



<a name="268872760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268872760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268872760">(Jan 21 2022 at 17:14)</a>:</h4>
<p>Another option would be to add a command line option that lets you inject a <code>use</code>, which would be useful for various purposes.</p>



<a name="268873354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268873354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268873354">(Jan 21 2022 at 17:18)</a>:</h4>
<p>I think you can use <code>--extern noprelude:std=/path/to/std-wrapper.rlib</code>. Where std-wrapper re-exports all of libstd except shadowing assert! with your own implementation. Didn't try it, but -Zbuild-std roughly does this I believe.</p>



<a name="268894140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268894140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zyad Hassan <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268894140">(Jan 21 2022 at 19:50)</a>:</h4>
<blockquote>
<p>a command line option that lets you inject a use</p>
</blockquote>
<p>Can you clarify how a <code>use</code> can be injected? As far as I understand, by the time compilation gets to the backend, it's too late to add any <code>use</code>.</p>



<a name="268895430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268895430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zyad Hassan <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268895430">(Jan 21 2022 at 19:56)</a>:</h4>
<blockquote>
<p>I think you can use --extern noprelude:std=/path/to/std-wrapper.rlib</p>
</blockquote>
<p>This sounds like a great solution! Any pointers on how to re-export libstd symbols?</p>



<a name="268903815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268903815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268903815">(Jan 21 2022 at 21:11)</a>:</h4>
<p><code>pub use std::*;</code> I guess.</p>



<a name="268907163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268907163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268907163">(Jan 21 2022 at 21:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="429403">Zyad Hassan</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Globally.20override.20an.20std.20macro/near/268894140">said</a>:</p>
<blockquote>
<blockquote>
<p>a command line option that lets you inject a use</p>
</blockquote>
<p>Can you clarify how a <code>use</code> can be injected? As far as I understand, by the time compilation gets to the backend, it's too late to add any <code>use</code>.</p>
</blockquote>
<p>You'd need an option in the rustc frontend.</p>



<a name="268907187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268907187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268907187">(Jan 21 2022 at 21:43)</a>:</h4>
<p><code>-C inject-use='mystd as std'</code></p>



<a name="268907210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268907210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268907210">(Jan 21 2022 at 21:43)</a>:</h4>
<p>Or something like that.</p>



<a name="268907274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268907274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268907274">(Jan 21 2022 at 21:44)</a>:</h4>
<p>I'd love to have something like that, for things like:<br>
<code>-C inject-use='std::arch::asm'</code></p>



<a name="268915242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268915242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zyad Hassan <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268915242">(Jan 21 2022 at 23:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Globally.20override.20an.20std.20macro/near/268907163">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="429403">Zyad Hassan</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Globally.20override.20an.20std.20macro/near/268894140">said</a>:</p>
<blockquote>
<blockquote>
<p>a command line option that lets you inject a use</p>
</blockquote>
<p>Can you clarify how a <code>use</code> can be injected? As far as I understand, by the time compilation gets to the backend, it's too late to add any <code>use</code>.</p>
</blockquote>
<p>You'd need an option in the rustc frontend.</p>
</blockquote>
<p>Ah, I see. Having such an option would be great. We're currently using the <code>rustc_driver</code> crate as is though, so we can't add such an option.</p>



<a name="268925104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268925104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268925104">(Jan 22 2022 at 01:03)</a>:</h4>
<p>I'm suggesting that such an option would be useful upstream, in rustc itself.</p>



<a name="268925109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268925109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268925109">(Jan 22 2022 at 01:03)</a>:</h4>
<p>You could propose the addition of such an option.</p>



<a name="268925126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268925126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268925126">(Jan 22 2022 at 01:03)</a>:</h4>
<p><span class="user-mention" data-user-id="429403">@Zyad Hassan</span> Ultimately it'd be a compiler team decision, but libs at least was interested in such an option existing.</p>



<a name="268925169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268925169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268925169">(Jan 22 2022 at 01:04)</a>:</h4>
<p><span class="user-mention" data-user-id="429403">@Zyad Hassan</span> If you proposed something like that, I'd be happy to support it.</p>



<a name="268932391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268932391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zyad Hassan <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268932391">(Jan 22 2022 at 03:06)</a>:</h4>
<p>Cool, yes, I can write a proposal. Is the <a href="https://internals.rust-lang.org/">internals forum</a> the right place to submit a proposal to the compiler team?</p>



<a name="268969770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268969770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268969770">(Jan 22 2022 at 18:03)</a>:</h4>
<p><span class="user-mention" data-user-id="429403">@Zyad Hassan</span> No, you'd want to submit a compiler MCP ("Major Change Proposal"). Despite the name, it's also appropriate for smaller changes like this.</p>



<a name="268969822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268969822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268969822">(Jan 22 2022 at 18:04)</a>:</h4>
<p>Also, you may want to make reference to <code>-Z crate-attr</code>.</p>



<a name="268969859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268969859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268969859">(Jan 22 2022 at 18:05)</a>:</h4>
<p>This should be something like <code>-Z inject-use=val</code>, "inject a <code>use val</code> declaration at the top of every module".</p>



<a name="268978553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268978553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268978553">(Jan 22 2022 at 21:03)</a>:</h4>
<p>Note that globally injecting a <code>use</code> does not seem like such a good idea in practice:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">assert</span><span class="p">;</span><span class="w"></span>
<span class="fm">assert!</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>would become:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span>::<span class="n">your_crate</span>::<span class="n">assert</span><span class="p">;</span><span class="w"> </span><span class="c1">// &lt;- injected</span>
<span class="k">use</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">assert</span><span class="p">;</span><span class="w"></span>
<span class="fm">assert!</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
</code></pre></div>
<p>and if this were made so the injected <code>use</code> had priority, it would still be problematic <em>w.r.t.</em> eponymous but unrelated macros</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span>::<span class="n">trait_impls_assertions</span>::<span class="n">assert</span><span class="p">;</span><span class="w"> </span><span class="c1">// override this with injection?</span>
<span class="fm">assert!</span><span class="p">(</span><span class="w"> </span><span class="p">()</span><span class="w"> </span>: <span class="nb">Copy</span> <span class="p">);</span><span class="w"> </span><span class="c1">// &lt;- problematic for this to become a macro with `core::assert!`'s API</span>
</code></pre></div>



<a name="268981260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/268981260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#268981260">(Jan 22 2022 at 22:07)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span>  I think if you wanted to override core, you would inject a use <code>as core</code>.</p>



<a name="269016942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/269016942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#269016942">(Jan 23 2022 at 13:11)</a>:</h4>
<p><code>--extern noprelude:core=...</code> is used by <code>cargo -Zbuild-std</code> to override the host libcore.</p>



<a name="269016946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/269016946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#269016946">(Jan 23 2022 at 13:11)</a>:</h4>
<p><a href="https://github.com/rust-lang/cargo/blob/03e24bcf67696ba35d3aa2b0dd01f97bcfdf91a7/src/cargo/core/compiler/mod.rs#L1171">https://github.com/rust-lang/cargo/blob/03e24bcf67696ba35d3aa2b0dd01f97bcfdf91a7/src/cargo/core/compiler/mod.rs#L1171</a></p>



<a name="269156183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Globally%20override%20an%20std%20macro/near/269156183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zyad Hassan <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Globally.20override.20an.20std.20macro.html#269156183">(Jan 24 2022 at 19:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Globally.20override.20an.20std.20macro/near/268873354">said</a>:</p>
<blockquote>
<p>I think you can use <code>--extern noprelude:std=/path/to/std-wrapper.rlib</code>. Where std-wrapper re-exports all of libstd except shadowing assert! with your own implementation. Didn't try it, but -Zbuild-std roughly does this I believe.</p>
</blockquote>
<p>Thanks <span class="user-mention" data-user-id="133247">@bjorn3</span>! This worked like a charm! For the record, I used:</p>
<div class="codehilite"><pre><span></span><code>RUSTFLAGS=--crate-type=rlib cargo +nightly build --target x86_64-unknown-linux-gnu
</code></pre></div>
<p>for building the std wrapper, and:</p>
<div class="codehilite"><pre><span></span><code>RUSTFLAGS=&quot;-Z unstable-options --extern noprelude:std=../std-wrapper/target/x86_64-unknown-linux-gnu/debug/deps/libstd_wrapper-4f9d7610b279bf9b.rlib&quot; cargo +nightly run --target x86_64-unknown-linux-gnu
</code></pre></div>
<p>for building/running the package. My implementation of the <code>assert!</code> was invoked.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>