<html>
<head><meta charset="utf-8"><title>Custom  HIR -&gt; THIR desugaring in drivers · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Custom.20.20HIR.20-.3E.20THIR.20desugaring.20in.20drivers.html">Custom  HIR -&gt; THIR desugaring in drivers</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276936104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Custom%20%20HIR%20-%3E%20THIR%20desugaring%20in%20drivers/near/276936104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Custom.20.20HIR.20-.3E.20THIR.20desugaring.20in.20drivers.html#276936104">(Mar 28 2022 at 21:54)</a>:</h4>
<p>Is there any simple way to implement a custom desugaring within a rustc driver? In particular, I would like to change the desugaring of <code>for</code> expressions to include some additional (ghost) operations. I'm wondering if there's a query I could override or some other way for me to intercept the desugaring to add my transformation</p>



<a name="276940163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Custom%20%20HIR%20-%3E%20THIR%20desugaring%20in%20drivers/near/276940163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Custom.20.20HIR.20-.3E.20THIR.20desugaring.20in.20drivers.html#276940163">(Mar 28 2022 at 22:51)</a>:</h4>
<p>That's in AST lowering (&lt;<a href="https://github.com/rust-lang/rust/blob/ee915c34e2f33a07856a9e39be7e35e648bfbd5d/compiler/rustc_ast_lowering/src/expr.rs#L279-L283">https://github.com/rust-lang/rust/blob/ee915c34e2f33a07856a9e39be7e35e648bfbd5d/compiler/rustc_ast_lowering/src/expr.rs#L279-L283</a>&gt;).  I don't know of any hooks for it, though I'm also a beginner in that part of the code.</p>



<a name="276940170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Custom%20%20HIR%20-%3E%20THIR%20desugaring%20in%20drivers/near/276940170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Custom.20.20HIR.20-.3E.20THIR.20desugaring.20in.20drivers.html#276940170">(Mar 28 2022 at 22:51)</a>:</h4>
<p>Does overriding the thir_body query work?<br>
Edit: right, for loop desugaring happens during ast-&gt;hir, not hir-&gt;thir.</p>



<a name="276940416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Custom%20%20HIR%20-%3E%20THIR%20desugaring%20in%20drivers/near/276940416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Custom.20.20HIR.20-.3E.20THIR.20desugaring.20in.20drivers.html#276940416">(Mar 28 2022 at 22:54)</a>:</h4>
<p>there's no easy way to 'patch' / 'wrap' that is there?</p>



<a name="276969905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Custom%20%20HIR%20-%3E%20THIR%20desugaring%20in%20drivers/near/276969905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Custom.20.20HIR.20-.3E.20THIR.20desugaring.20in.20drivers.html#276969905">(Mar 29 2022 at 07:59)</a>:</h4>
<p>Nope, right now it's all one big operation. The best thing you can do right now is add a mir opt that looks for loop desugarings and insert your changes in the mir</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>