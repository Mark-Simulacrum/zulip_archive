<html>
<head><meta charset="utf-8"><title>Trait substs from callsite · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trait.20substs.20from.20callsite.html">Trait substs from callsite</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275044521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trait%20substs%20from%20callsite/near/275044521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aurel Bílý <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trait.20substs.20from.20callsite.html#275044521">(Mar 11 2022 at 22:42)</a>:</h4>
<p>How can I resolve substs of an impl method back to their trait version? Example:</p>
<div class="codehilite"><pre><span></span><code>trait Foo&lt;X, Y&gt; {
    fn foo(&amp;self);
}

struct Dummy;
impl Foo&lt;i32, u32&gt; for Dummy {
    fn foo(&amp;self) { /* ... */ }
}
</code></pre></div>
<p>Now say I have the <code>DefId</code> of <code>Dummy::foo</code>, with <code>substs = []</code>. How do I transform the <code>DefId</code> + its (identity) <code>substs</code> to the substs suitable for the trait method? In this example, I would like to get <code>[Dummy, i32, u32]</code>.</p>
<p>I have found how to do the opposite mapping (from trait + callsite substs to impl substs) using <code>resolve_instance</code>. However, I can't find how to do the opposite. <code>rustc_trait_selection::traits::translate_substs</code> looks promising, but I cannot make it work, esp. because of the last parameter. I tried something based on code in <code>rustc_ty_utils::instance::resolve_associated_item</code>, but I get a variety of errors like <code>expected item, found method foo in &lt;Dummy as Foo&lt;i32, u32&gt;&gt;::foo</code>.</p>



<a name="275109676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trait%20substs%20from%20callsite/near/275109676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trait.20substs.20from.20callsite.html#275109676">(Mar 12 2022 at 18:13)</a>:</h4>
<p>You need to fetch the impl's DefId,  you get that via <code>tcx.parent_of(method_def_id)</code>. I'm not sure where to go from here, but potentially <code>SubstsRef::identity_subst</code> or something similarly named could get you what you're looking for</p>



<a name="275228929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trait%20substs%20from%20callsite/near/275228929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aurel Bílý <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trait.20substs.20from.20callsite.html#275228929">(Mar 14 2022 at 12:35)</a>:</h4>
<p>I don't know, I've looked a lot. The best I can think of is, for an example like:</p>
<div class="codehilite"><pre><span></span><code>trait Foo&lt;X, Y, ...&gt; { fn method&lt;P, Q, ...&gt;(&amp;self); }
impl&lt;A, B, ...&gt; Foo&lt;A, B, ...&gt; for Something { fn method&lt;P, Q, ...&gt;(&amp;self) {} }
</code></pre></div>
<p>I can ignore the generics on the method itself, as the type parameters of the impl method and the trait method must match, or at least there must be the same number of them. So, focusing on the trait and the impl block itself, I need some way to get the substs <code>[Foo&lt;A, B, ...&gt;, A, B, ...]</code> (where the trait's identity is <code>[Self, X, Y, ...]</code>).</p>



<a name="275229092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trait%20substs%20from%20callsite/near/275229092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aurel Bílý <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trait.20substs.20from.20callsite.html#275229092">(Mar 14 2022 at 12:37)</a>:</h4>
<p>Oh, and this might be something I can get with <code>TyCtxt::impl_trait_ref</code>!</p>



<a name="275230285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trait%20substs%20from%20callsite/near/275230285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trait.20substs.20from.20callsite.html#275230285">(Mar 14 2022 at 12:48)</a>:</h4>
<p>Are you just attempting to get the substs relevant to the trait itself?</p>



<a name="275230358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trait%20substs%20from%20callsite/near/275230358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trait.20substs.20from.20callsite.html#275230358">(Mar 14 2022 at 12:49)</a>:</h4>
<p><code>impl_trait_ref</code> gives you a trait + substs that match the impl</p>



<a name="275230369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trait%20substs%20from%20callsite/near/275230369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trait.20substs.20from.20callsite.html#275230369">(Mar 14 2022 at 12:49)</a>:</h4>
<p>but if your method has other generics on top, those wouldn't be included</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>