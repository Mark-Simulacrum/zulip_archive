<html>
<head><meta charset="utf-8"><title>Strange behaviour from omitting a `is_copy_raw` call · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Strange.20behaviour.20from.20omitting.20a.20.60is_copy_raw.60.20call.html">Strange behaviour from omitting a `is_copy_raw` call</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274284133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Strange%20behaviour%20from%20omitting%20a%20%60is_copy_raw%60%20call/near/274284133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Strange.20behaviour.20from.20omitting.20a.20.60is_copy_raw.60.20call.html#274284133">(Mar 06 2022 at 04:27)</a>:</h4>
<p>As was <a href="https://github.com/rust-lang/rust/pull/94276#discussion_r817919798">suggested in a PR comment</a>, I made a change to short-circuit in <code>is_copy_modulo_regions</code> for obvious types.  To my surprise, though, that caused an ICE in a test.</p>
<p>Even just the following is sufficient to cause it:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>    pub fn is_copy_modulo_regions(<span class="w"></span>
<span class="w"> </span>        self,<span class="w"></span>
<span class="w"> </span>        tcx_at: TyCtxtAt&lt;'tcx&gt;,<span class="w"></span>
<span class="w"> </span>        param_env: ty::ParamEnv&lt;'tcx&gt;,<span class="w"></span>
<span class="w"> </span>    ) -&gt; bool {<span class="w"></span>
<span class="gd">-        tcx_at.is_copy_raw(param_env.and(self))</span><span class="w"></span>
<span class="gi">+        if let ty::Uint(ty::UintTy::U32) = self.kind() {</span><span class="w"></span>
<span class="gi">+            true</span><span class="w"></span>
<span class="gi">+        } else {</span><span class="w"></span>
<span class="gi">+            tcx_at.is_copy_raw(param_env.and(self))</span><span class="w"></span>
<span class="gi">+        }</span><span class="w"></span>
<span class="w"> </span>    }<span class="w"></span>
</code></pre></div>
<p>Which confuses me, as I'm confident that <code>u32</code> is definitely <code>Copy</code>, and I thought that, because it's a query, skipping a call to <code>is_copy_raw</code> should be fine (modulo lints, perhaps).</p>
<p>Is this actually a problem?  Or am I misunderstanding something?</p>
<p>I've put the minimal change up at <a href="https://github.com/rust-lang/rust/pull/94660">https://github.com/rust-lang/rust/pull/94660</a> to show the failure:</p>
<div class="codehilite"><pre><span></span><code>error: internal compiler error: broken MIR in DefId(0:3 ~ params_on_registers[6840]::entry_function) (NoSolution): could not prove Binder(TraitPredicate(&lt;u32 as Copy&gt;, polarity:Positive), [])
   = note: delayed at compiler/rustc_borrowck/src/type_check/canonical.rs:150:13
</code></pre></div>
<p>(I'm not blocked by this, just puzzled.)</p>



<a name="274285629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Strange%20behaviour%20from%20omitting%20a%20%60is_copy_raw%60%20call/near/274285629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Strange.20behaviour.20from.20omitting.20a.20.60is_copy_raw.60.20call.html#274285629">(Mar 06 2022 at 05:04)</a>:</h4>
<p><code>impl Copy for u32 {}</code> should be part of the core. Failing <code>no_core</code> test doesn't contain the impl.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>