<html>
<head><meta charset="utf-8"><title>List&lt;Ty&gt; · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html">List&lt;Ty&gt;</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263547755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263547755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263547755">(Dec 03 2021 at 08:24)</a>:</h4>
<p>I've looked at the code for <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_middle/src/ty/list.rs#L21-L36"><code>List&lt;Ty&gt;</code></a> lots of times, but never understood it. Can anyone explain?</p>



<a name="263547767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263547767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263547767">(Dec 03 2021 at 08:24)</a>:</h4>
<p>It feels to me like it has insufficient comments given how magical it is</p>



<a name="263552625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263552625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263552625">(Dec 03 2021 at 09:17)</a>:</h4>
<p>i understand that code fairly well, so i should helpfully be able to help here. Feel free to ping me on any question you have here or if you just want a general overview of what should happen here</p>



<a name="263554412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263554412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263554412">(Dec 03 2021 at 09:35)</a>:</h4>
<p>Just a general overview would be great. A starting point is how the zero-length slice works. A follow-up is what the  <code>OpaqueListContents</code> does. Once I know those I think reading the code will be easier</p>



<a name="263554426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263554426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263554426">(Dec 03 2021 at 09:35)</a>:</h4>
<p>Thanks <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="263591180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263591180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263591180">(Dec 03 2021 at 14:59)</a>:</h4>
<p>wrt zero length: we compare lists using pointer comparision, so there must only be one empty <code>List&lt;T&gt;</code> for each <code>T</code> ( we actually only use one empty <code>List&lt;T&gt;</code> for all <code>T</code>)</p>



<a name="263591807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263591807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263591807">(Dec 03 2021 at 15:02)</a>:</h4>
<p>the empty list has to be</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">List</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">len</span>: <span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>tbh I am not completely sure why <code>EmptySlice</code> is a <code>[u8; 64]</code> instead of a single <code>usize</code>. But that doesn'T really matter as only the first <code>mem::size_of::&lt;usize&gt;()</code> bytes of <code>EmptySlice</code> are used.</p>



<a name="263592745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263592745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263592745">(Dec 03 2021 at 15:09)</a>:</h4>
<p>about <code>OpaqueListContents</code>: <code>&amp;List&lt;T&gt;</code> is pretty much an ordinary interned <code>&amp;[T]</code> with two differences:</p>
<ul>
<li>the size of the list is stored as part of the list, this means that<br>
    - <code>&amp;List&lt;T&gt;</code> is only a single <code>usize</code><br>
    - you cannot get <code>List</code> which is a subslice of another list, as the length is at the start of each list</li>
<li>lists are interned and have to be unique, meanign that<ul>
<li>you can eq and hash its ptr instead of the whole list</li>
<li>you must not get a subslice of a list as a <code>List</code>, as otherwise you could get a list for <code>[a, b]</code> and <code>[b]</code> and then use <code>[a, b][1..]</code> (if that were to return another list) to get two lists with different pointers to the same elements</li>
</ul>
</li>
</ul>



<a name="263592997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263592997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263592997">(Dec 03 2021 at 15:11)</a>:</h4>
<p>the <code>data: [T; 0],  opaque: OpaqueListContents</code> is currently the best way to represent a variable sized array of unknown length. Using <code>data: [T]</code> without <code>OpaqueListContents</code> would mean that the len is stored both at the start of the list and as part of its pointer which is not what we want here</p>



<a name="263593152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263593152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263593152">(Dec 03 2021 at 15:12)</a>:</h4>
<p>i feel like I am mostly repeating the existing comments here '^^ this already feels quite intuitive to me so I am currently missing what you're struggling with <span aria-label="bow" class="emoji emoji-1f647" role="img" title="bow">:bow:</span></p>



<a name="263593764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263593764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263593764">(Dec 03 2021 at 15:17)</a>:</h4>
<p>The u8 array is probably to make sure we have no padding before it so that lists of less than usize-aligned elements are still ok, Id guess, but this is without looking closely.</p>



<a name="263667112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263667112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263667112">(Dec 03 2021 at 23:32)</a>:</h4>
<p>Regarding the <code>[u8; 64]</code>, imagine a <code>T</code> where <code>mem::size_of::&lt;usize&gt;() &lt; mem::align_of::&lt;T&gt;() &lt;= 64</code> then a <code>List&lt;T&gt;</code> is an <code>align_of::&lt;T&gt;()</code>-aligned structure that starts with <code>mem::size_of::&lt;usize&gt;()</code> bytes for the <code>.len</code>, and then <code>mem::align_of::&lt;T&gt;() - mem::size_of::&lt;usize&gt;()</code> padding bytes.</p>
<p>Tbf, I'd find it clearer if it had done:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[inline(always)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">empty</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span> <span class="nc">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">mem</span>::<span class="n">align_of</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">64</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[repr(align(64)]</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MaxAlign</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[repr(C)]</span><span class="w"> </span><span class="k">struct</span> <span class="nc">InOrder</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">U</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="n">EMPTY_SLICE</span>: <span class="nc">InOrder</span><span class="o">&lt;</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">MaxAlign</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InOrder</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MaxAlign</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;*</span><span class="p">(</span><span class="o">&amp;</span><span class="n">EMPTY_SLICE</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="263943209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263943209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263943209">(Dec 07 2021 at 00:14)</a>:</h4>
<p>Thanks everyone for the explanations! That does clear it up a bit. Very much like the old trick in C of writing a struct that ends with a zero-length array to allow variable lengths.</p>



<a name="263946620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263946620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263946620">(Dec 07 2021 at 01:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/List.3CTy.3E/near/263591807">said</a>:</p>
<blockquote>
<p>the empty list has to be</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">List</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">len</span>: <span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">..</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>One question: does the <code>..</code> here mean "anything"? Including emptiness?</p>
</blockquote>



<a name="263946990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263946990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263946990">(Dec 07 2021 at 01:08)</a>:</h4>
<p>Oh, this is important: it's meant to be an interned type, and various operations (e.g. <code>PartialEq</code>) rely on this, but it doesn't provide the interning itself, that comes from outside!</p>



<a name="263947058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263947058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263947058">(Dec 07 2021 at 01:08)</a>:</h4>
<p>This is the only place <code>List</code>s are constructed: <a href="https://github.com/rust-lang/rust/blob/e5038e20999eef35260b070189883edc2a8a34b2/compiler/rustc_middle/src/ty/context.rs#L2094-L2104">https://github.com/rust-lang/rust/blob/e5038e20999eef35260b070189883edc2a8a34b2/compiler/rustc_middle/src/ty/context.rs#L2094-L2104</a></p>



<a name="263947092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263947092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263947092">(Dec 07 2021 at 01:09)</a>:</h4>
<p>There's nothing to stop someone from unintentionally calling <code>List::from_arena</code> and then getting themselves into trouble</p>



<a name="263947337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263947337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263947337">(Dec 07 2021 at 01:12)</a>:</h4>
<p>/me starts writing a PR with better comments</p>



<a name="263950627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263950627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263950627">(Dec 07 2021 at 02:08)</a>:</h4>
<p>Hmm, <code>List&lt;T&gt;</code> is an interned (unique) type, so to hash it we can just hash the pointer. We have lots of other interned types (<code>Ty</code>, <code>Substs</code>) that are also always interned(?) but which we hash normally, via the contents.</p>



<a name="263950659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263950659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263950659">(Dec 07 2021 at 02:09)</a>:</h4>
<p>So now I'm wondering if we could hash them by address instead</p>



<a name="263950674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263950674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263950674">(Dec 07 2021 at 02:09)</a>:</h4>
<p>I guess not if they are <code>Copy</code> types...</p>



<a name="263952321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263952321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263952321">(Dec 07 2021 at 02:43)</a>:</h4>
<p>Wait, <code>context.rs</code> has this code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="sd">/// An entry in an interner.</span>
<span class="k">struct</span> <span class="nc">Interned</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="o">?</span><span class="nb">Sized</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">tcx</span><span class="w"> </span><span class="n">T</span><span class="p">);</span><span class="w"></span>

<span class="c1">// N.B., an `Interned&lt;Ty&gt;` compares and hashes as a `TyKind`.</span>
<span class="k">impl</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">PartialEq</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Interned</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">TyS</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">eq</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span>: <span class="kp">&amp;</span><span class="nc">Interned</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">TyS</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">kind</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="mf">0.</span><span class="n">kind</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Hash</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Interned</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">TyS</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">hash</span><span class="o">&lt;</span><span class="n">H</span>: <span class="nc">Hasher</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">s</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">H</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mf">0.</span><span class="n">kind</span><span class="p">().</span><span class="n">hash</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// N.B., an `Interned&lt;List&lt;T&gt;&gt;` compares and hashes as its elements.</span>
<span class="k">impl</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="nb">PartialEq</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">PartialEq</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Interned</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">eq</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span>: <span class="kp">&amp;</span><span class="nc">Interned</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">[</span><span class="o">..</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="mi">0</span><span class="p">[</span><span class="o">..</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">T</span>: <span class="nc">Hash</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Hash</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Interned</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">hash</span><span class="o">&lt;</span><span class="n">H</span>: <span class="nc">Hasher</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">s</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">H</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">[</span><span class="o">..</span><span class="p">].</span><span class="n">hash</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="263952325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263952325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263952325">(Dec 07 2021 at 02:43)</a>:</h4>
<p>!!</p>



<a name="263952394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263952394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263952394">(Dec 07 2021 at 02:44)</a>:</h4>
<p>A <code>List&lt;T&gt;</code> uses its address for <code>Eq</code> and <code>Hash</code>, but <code>Interned&lt;List&lt;T&gt;&gt;</code> uses the contents!</p>



<a name="263952437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263952437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263952437">(Dec 07 2021 at 02:45)</a>:</h4>
<p>This seems entirely backwards. <code>List&lt;T&gt;</code> has this silent uniqueness requirement that's not even documented. But <code>Interned&lt;List&lt;T&gt;&gt;</code>, whose uniqueness is implied by its name, doesn't take advantage of the uniqueness provided by interning?</p>



<a name="263952536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263952536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263952536">(Dec 07 2021 at 02:47)</a>:</h4>
<p>Seems like <code>List&lt;T&gt;</code> could be changed to not have the uniqueness requirement, and then use <code>Interned&lt;List&lt;T&gt;&gt;</code> in the places where we do have uniqueness</p>



<a name="263953086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263953086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263953086">(Dec 07 2021 at 02:58)</a>:</h4>
<p>Ok, <a href="https://github.com/rust-lang/rust/pull/91617">https://github.com/rust-lang/rust/pull/91617</a> is my PR for comments and readability. <span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> , I used your <code>empty()</code> formulation (with minor modifications), I hope you don't mind</p>



<a name="263954418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263954418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263954418">(Dec 07 2021 at 03:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/List.3CTy.3E/near/263952437">said</a>:</p>
<blockquote>
<p>This seems entirely backwards. <code>List&lt;T&gt;</code> has this silent uniqueness requirement that's not even documented. But <code>Interned&lt;List&lt;T&gt;&gt;</code>, whose uniqueness is implied by its name, doesn't take advantage of the uniqueness provided by interning?</p>
</blockquote>
<p>Oh... <code>Interned</code> is used within <code>InternedSet</code>. When you're looking to see if a slice has already been interned, the <code>Interned&lt;List&lt;T&gt;&gt;</code> is in the interner, and for that lookup we do need to look at the contents.</p>



<a name="263954453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263954453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263954453">(Dec 07 2021 at 03:27)</a>:</h4>
<p>I find that naming non-intuitive, I assumed <code>Interned&lt;T&gt;</code> basically meant <code>Unique&lt;T&gt;</code>, i.e. it was an interned value for use by the outside world</p>



<a name="263954465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263954465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263954465">(Dec 07 2021 at 03:27)</a>:</h4>
<p><code>Interned&lt;T&gt;</code> is more like <code>InterningKey&lt;T&gt;</code>, the interned value as used when doing interning lookups</p>



<a name="263957683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263957683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263957683">(Dec 07 2021 at 04:38)</a>:</h4>
<p>As opposed to the result you get from an <code>intern()</code> call, which is what I expected</p>



<a name="263993165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263993165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263993165">(Dec 07 2021 at 12:25)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> nice PR, I like the clarifications very much. Thanks for doing this!</p>



<a name="263993965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263993965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263993965">(Dec 07 2021 at 12:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/List.3CTy.3E/near/263946620">said</a>:</p>
<blockquote>
<p>One question: does the <code>..</code> here mean "anything"? Including emptiness?</p>
</blockquote>
<p><code>...</code> was meant to represent that we don't care about the rest, so yes, anything including emptiness</p>



<a name="263994053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/263994053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lcnr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#263994053">(Dec 07 2021 at 12:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/List.3CTy.3E/near/263954465">said</a>:</p>
<blockquote>
<p><code>Interned&lt;T&gt;</code> is more like <code>InterningKey&lt;T&gt;</code>, the interned value as used when doing interning lookups</p>
</blockquote>
<p>yeah, think i am in favor of renaming that</p>



<a name="264063785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/264063785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#264063785">(Dec 07 2021 at 20:05)</a>:</h4>
<p>Thanks for the info!</p>



<a name="264063924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/264063924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#264063924">(Dec 07 2021 at 20:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="216206">lcnr</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/List.3CTy.3E/near/263994053">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/List.3CTy.3E/near/263954465">said</a>:</p>
<blockquote>
<p><code>Interned&lt;T&gt;</code> is more like <code>InterningKey&lt;T&gt;</code>, the interned value as used when doing interning lookups</p>
</blockquote>
<p>yeah, think i am in favor of renaming that</p>
</blockquote>
<p><code>ForInterning&lt;T&gt;</code> might be a better name</p>



<a name="264188220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/264188220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#264188220">(Dec 08 2021 at 17:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/List.3CTy.3E/near/263950659">said</a>:</p>
<blockquote>
<p>So now I'm wondering if we could hash them by address instead</p>
</blockquote>
<p>Note that <code>Ty</code> is already hashed by address. This works because <code>TyS</code> doesn't implement <code>Copy</code> and <code>type Ty&lt;'tcx&gt; = &amp;'tcx TyS&lt;'tcx&gt;</code>.</p>
<p>I had an attempt to do the same for <code>ty::Const</code>: <a href="https://github.com/rust-lang/rust/issues/90951">#90951</a></p>
<p>I think the best thing is to have a <code>rustc_middle::ty::P&lt;'tcx, T&gt;</code> smart pointer that can only be constructed with an interned reference. That way we could eliminate <code>&amp;'tcx List&lt;T&gt;</code> and migrate to <code>P&lt;'tcx, [T]&gt;</code>.</p>



<a name="268792237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/268792237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#268792237">(Jan 21 2022 at 03:42)</a>:</h4>
<p><span class="user-mention" data-user-id="361356">@fee1-dead</span> <code>&amp;'tcx List&lt;T&gt;</code> has the additional property that it's a single word, because the length is stored within the list. In contrast, <code>P&lt;'tcx, [T]&gt;</code> would be a fat pointer, no?</p>



<a name="268793372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/268793372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#268793372">(Jan 21 2022 at 04:02)</a>:</h4>
<p>That's true. So we can't just do <code>P&lt;'tcx, [T]&gt;</code>, but I'd like to see all other interned objects to use <code>P&lt;'tcx, T&gt;</code> though.</p>



<a name="268799296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/268799296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#268799296">(Jan 21 2022 at 05:50)</a>:</h4>
<p>Check out <a href="https://github.com/rust-lang/rust/issues/93148">#93148</a>, it's a start on this idea</p>



<a name="268799316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/List%3CTy%3E/near/268799316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/List.3CTy.3E.html#268799316">(Jan 21 2022 at 05:50)</a>:</h4>
<p>Also, <a href="https://github.com/rust-lang/rust/issues/93147">#93147</a> has some comments and other readability improvements that I think are worthwhile</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>