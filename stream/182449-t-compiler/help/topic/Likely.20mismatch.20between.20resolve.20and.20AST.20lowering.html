<html>
<head><meta charset="utf-8"><title>Likely mismatch between resolve and AST lowering · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Likely.20mismatch.20between.20resolve.20and.20AST.20lowering.html">Likely mismatch between resolve and AST lowering</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="266588167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Likely%20mismatch%20between%20resolve%20and%20AST%20lowering/near/266588167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> inquisitivecrystal <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Likely.20mismatch.20between.20resolve.20and.20AST.20lowering.html#266588167">(Jan 02 2022 at 02:05)</a>:</h4>
<p>I've been looking into <a href="https://github.com/rust-lang/rust/issues/91370">#91370</a>. I'm not 100% sure yet, but I think I might know what's going on. It seems like resolve is treating the impl as real, so it's appearing in <code>tcx.all_local_trait_impls(())</code>, but  AST lowering ignores it, because it's in the body of a foreign function item, and that sort of body isn't getting lowered because it shouldn't exist. If I'm correct, the way to fix the ICE is to resolve the mismatch. </p>
<p>I guess I have two questions. First, does my theory sound plausible? I've checked the AST lowering end, but haven't checked the resolve end completely yet. Second, what's the best way to deal with this? I'm guessing it would be to make resolve ignore it, although I'm not entirely sure.</p>



<a name="266605062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Likely%20mismatch%20between%20resolve%20and%20AST%20lowering/near/266605062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Likely.20mismatch.20between.20resolve.20and.20AST.20lowering.html#266605062">(Jan 02 2022 at 09:39)</a>:</h4>
<p>I agree with your theory.<br>
There are two ways to deal with this:</p>
<ol>
<li>change lowering to deal with foreign fn bodies;</li>
<li>change the late resolver to ignore them.</li>
</ol>
<p>I believe (1) would just move the issue.  HIR is manipulated by visitors, so having an item somewhere which is not reachable by a visitor (for instance in a body that we ignore) would just ICE elsewhere.  We had the case not long ago when lowering attempted to deal with expressions inside attributes.</p>
<p>Therefore, I think the proper solution is (2): modify LateResolutionVisitor to ignore foreign fn bodies like ItemLowerer does.</p>



<a name="266664845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Likely%20mismatch%20between%20resolve%20and%20AST%20lowering/near/266664845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> inquisitivecrystal <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Likely.20mismatch.20between.20resolve.20and.20AST.20lowering.html#266664845">(Jan 03 2022 at 09:12)</a>:</h4>
<p>Do you know why things are set up with AST lowering and resolve both working with the AST independently of each other? I've had it make things complicated for me in the past, and here it actually caused a bug. It must be setup this way for a reason.</p>



<a name="266665052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Likely%20mismatch%20between%20resolve%20and%20AST%20lowering/near/266665052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> inquisitivecrystal <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Likely.20mismatch.20between.20resolve.20and.20AST.20lowering.html#266665052">(Jan 03 2022 at 09:15)</a>:</h4>
<p>Also, thank you the helpful advice! I've now fixed the problem and opened a PR.</p>



<a name="266665067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Likely%20mismatch%20between%20resolve%20and%20AST%20lowering/near/266665067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> inquisitivecrystal <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Likely.20mismatch.20between.20resolve.20and.20AST.20lowering.html#266665067">(Jan 03 2022 at 09:15)</a>:</h4>
<p>I <code>r?</code>ed you on it. I hope you don't mind.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>