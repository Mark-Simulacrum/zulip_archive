<html>
<head><meta charset="utf-8"><title>manipulating mir from rustc_driver · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html">manipulating mir from rustc_driver</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258722363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258722363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258722363">(Oct 22 2021 at 14:50)</a>:</h4>
<p>Hey all! I'm creating some prototypes interacting with the compiler's internal APIs (for example analyzing the generated HIR/MIR), and now I'd need to programmatically manipulate the MIR of a function. So far I've been using <code>rustc_driver</code> with a custom <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_driver/trait.Callbacks.html"><code>Callbacks</code></a> to hook into the right points of the compiler.</p>
<p>Unless I'm overlooking something obvious I can't seem to find a way to manipulate the MIR by just linking to the driver and providing custom callbacks: the list of MIR passes is <a href="https://github.com/rust-lang/rust/blob/68a698baf6bfc61d85ce6e25122a092c60c7f21a/compiler/rustc_mir_transform/src/lib.rs#L484-L571">hardcoded</a>, and <code>tcx.optimized_mir()</code> returns a read-only reference preventing mutations once MIR passes are executed.</p>
<p>Of course I can fork the compiler each time I need to write a prototype and hardcode the additional MIR pass, but that's way less convenient than downloading a pinned <code>rustc-dev</code> and linking to <code>rustc_driver</code> with <code>#![feature(rustc_private)]</code>, as I'd need to rebuild the compiler whenever I make changes instead of just linking to the prebuilt compiler.</p>
<p>Is there another way to manipulate the generated MIR through <code>rustc_driver</code>, or what would be the process (just a PR, MCP...) to add a way to register custom MIR passes from <code>rustc_driver</code> like it's currently possible for lints (happy to do the impl work)?</p>



<a name="258728901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258728901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258728901">(Oct 22 2021 at 15:35)</a>:</h4>
<p><span class="user-mention" data-user-id="121055">@Pietro Albini</span> you could override the optimized_mir query with your own function</p>



<a name="258729051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258729051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258729051">(Oct 22 2021 at 15:36)</a>:</h4>
<p>rustdoc does that for <code>typeck</code>: <a href="https://github.com/rust-lang/rust/blob/68a698baf6bfc61d85ce6e25122a092c60c7f21a/src/librustdoc/core.rs#L280">https://github.com/rust-lang/rust/blob/68a698baf6bfc61d85ce6e25122a092c60c7f21a/src/librustdoc/core.rs#L280</a></p>



<a name="258729163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258729163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258729163">(Oct 22 2021 at 15:37)</a>:</h4>
<p>hmm, but then I wouldn't be able to invoke the rest of the mir passes I think</p>



<a name="258729191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258729191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258729191">(Oct 22 2021 at 15:37)</a>:</h4>
<p>because those are all private items inside the <code>rustc_mir_transform</code> crate</p>



<a name="258729325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258729325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258729325">(Oct 22 2021 at 15:38)</a>:</h4>
<p>you could call the default provider first, but then you're limited to adding passes to the end of the list.</p>



<a name="258729432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258729432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258729432">(Oct 22 2021 at 15:39)</a>:</h4>
<p>I think that adding a way to customize passes directly would be good. I guess an MCP would be how to go about this.</p>



<a name="258730179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258730179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258730179">(Oct 22 2021 at 15:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116118">Matthew Jasper</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/manipulating.20mir.20from.20rustc_driver/near/258729325">said</a>:</p>
<blockquote>
<p>you could call the default provider first, but then you're limited to adding passes to the end of the list.</p>
</blockquote>
<p>hmm, I'm not sure if that's possible? the provider for <code>optimized_mir</code> returns a <code>&amp;Body&lt;'tcx&gt;</code>, so even if I override that query the result I'll get from the previous one will be immutable</p>



<a name="258730576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258730576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258730576">(Oct 22 2021 at 15:47)</a>:</h4>
<p>oh, right I thought that it was a <code>Steal&lt;Body&gt;</code> like some of the earlier passes.</p>



<a name="258737081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258737081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258737081">(Oct 22 2021 at 16:34)</a>:</h4>
<p><code>Body</code> implements <code>Clone</code>.</p>



<a name="258738503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258738503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258738503">(Oct 22 2021 at 16:44)</a>:</h4>
<p>yes, but then I can't use that body for codegen, right?</p>



<a name="258747281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/manipulating%20mir%20from%20rustc_driver/near/258747281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/manipulating.20mir.20from.20rustc_driver.html#258747281">(Oct 22 2021 at 17:46)</a>:</h4>
<p>You can clone it, run the MIR pass and then use <code>tcx.arena.alloc()</code> to get a <code>&amp;'tcx Body&lt;'tcx&gt;</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>