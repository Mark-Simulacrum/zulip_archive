<html>
<head><meta charset="utf-8"><title>rustc_private cross-compilation · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html">rustc_private cross-compilation</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273000039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273000039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273000039">(Feb 23 2022 at 19:33)</a>:</h4>
<p>I am trying to build <a href="https://github.com/willcrichton/flowistry">a rustc_private library</a> for multiple platforms. I'm using Github Actions with a matrix of targets: <a href="https://github.com/willcrichton/flowistry/blob/master/.github/workflows/release.yml#L24-L60">https://github.com/willcrichton/flowistry/blob/master/.github/workflows/release.yml#L24-L60</a></p>
<p>I'm running into an issue where the generated binary for M1 Macs has the wrong dylib path for rustc crates. I believe the issue is that Github Actions is cross-compiling for an ARM target on an x86_64 machine, and rustc doesn't know that so it embeds the x86_64 dylib paths into the ARM binary.</p>
<p>Has anyone encountered this before? Any way to solve this besides creating my own ARM runner, which Github Actions doesn't support?</p>



<a name="273000945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273000945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273000945">(Feb 23 2022 at 19:40)</a>:</h4>
<p>At <a href="https://github.com/willcrichton/flowistry/blob/584dbd8c783e58e7c6aef325e8bff30766f968b7/.github/workflows/release.yml#L54">https://github.com/willcrichton/flowistry/blob/584dbd8c783e58e7c6aef325e8bff30766f968b7/.github/workflows/release.yml#L54</a> you need to add <code>--target ${{ matrix.target }}</code>. In addition you need to use <code>rustc-dev-${{ matrix.target }}</code> instead of rustc-dev at <a href="https://github.com/willcrichton/flowistry/blob/584dbd8c783e58e7c6aef325e8bff30766f968b7/.github/workflows/release.yml#L47">https://github.com/willcrichton/flowistry/blob/584dbd8c783e58e7c6aef325e8bff30766f968b7/.github/workflows/release.yml#L47</a> I believe.</p>



<a name="273002598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273002598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273002598">(Feb 23 2022 at 19:53)</a>:</h4>
<p>When I tried this, the build failed saying the <code>rustc-dev-*</code> component was missing:</p>
<div class="codehilite"><pre><span></span><code>error: component &#39;rustc-dev-x86_64-unknown-linux-gnu&#39; for target &#39;x86_64-unknown-linux-gnu&#39; is unavailable for download for channel &#39;nightly-2022-02-17&#39;
</code></pre></div>



<a name="273002716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273002716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273002716">(Feb 23 2022 at 19:54)</a>:</h4>
<p>That might be a manifest bug -- I would expect the file to exist, at least for x86_64-unknown-linux-gnu</p>



<a name="273002754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273002754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273002754">(Feb 23 2022 at 19:55)</a>:</h4>
<p>Though I'm seeing rustc-dev-x86_64-unknown-linux-gnu in <code>rustup component list</code>?</p>



<a name="273002842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273002842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273002842">(Feb 23 2022 at 19:55)</a>:</h4>
<p>and <code>rustup component add rustc-dev-x86_64-unknown-linux-gnu</code> seems to work for me</p>



<a name="273003007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273003007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273003007">(Feb 23 2022 at 19:56)</a>:</h4>
<p>Perhaps it doesn't exist for nightlies? The specific command being run is:</p>
<div class="codehilite"><pre><span></span><code> rustup toolchain install nightly-2022-02-17 --component rust-src --component rustc-dev-x86_64-unknown-linux-gnu --component llvm-tools-preview
</code></pre></div>
<p>And I can reproduce the installation error running on my laptop.</p>



<a name="273003295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273003295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273003295">(Feb 23 2022 at 19:58)</a>:</h4>
<p>hm</p>



<a name="273003307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273003307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273003307">(Feb 23 2022 at 19:59)</a>:</h4>
<p>rustup component add rustc-dev-x86_64-unknown-linux-gnu --toolchain nightly works for me</p>



<a name="273003347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273003347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273003347">(Feb 23 2022 at 19:59)</a>:</h4>
<p>rustup toolchain install nightly-2022-02-17 --component rust-src --component rustc-dev-x86_64-unknown-linux-gnu --component llvm-tools-preview does fail</p>



<a name="273003369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273003369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273003369">(Feb 23 2022 at 19:59)</a>:</h4>
<p>I suspect rustup toolchain install is using different component discovery logic, perhaps?</p>



<a name="273003513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273003513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273003513">(Feb 23 2022 at 20:00)</a>:</h4>
<p>You can probably rewrite to manually rustup component install</p>



<a name="273004104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273004104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273004104">(Feb 23 2022 at 20:05)</a>:</h4>
<p>Is it important to specify <code>--target ${{ matrix.target }}</code> in the <code>component add</code> command?</p>



<a name="273005095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273005095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273005095">(Feb 23 2022 at 20:12)</a>:</h4>
<p>Also I'm still getting errors if I go through <code>component add</code>.</p>
<div class="codehilite"><pre><span></span><code>rustup component add rustc-dev-x86_64-apple-darwin --toolchain nightly-2022-02-17
error: toolchain &#39;nightly-2022-02-17-x86_64-apple-darwin&#39; does not contain component &#39;rustc-dev-x86_64-apple-darwin&#39; for target &#39;x86_64-apple-darwin&#39;
</code></pre></div>



<a name="273005391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273005391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273005391">(Feb 23 2022 at 20:15)</a>:</h4>
<p>hm</p>



<a name="273005402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273005402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273005402">(Feb 23 2022 at 20:15)</a>:</h4>
<p>it works fine for me with just nightly</p>



<a name="273005429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273005429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273005429">(Feb 23 2022 at 20:15)</a>:</h4>
<p>oh, but not for a different target maybe?</p>



<a name="273005593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273005593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273005593">(Feb 23 2022 at 20:16)</a>:</h4>
<p>It seems like rustup component add should not error if rustup component list has it in there</p>



<a name="273005606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273005606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273005606">(Feb 23 2022 at 20:16)</a>:</h4>
<p>so that sounds like a rustup bug to me.</p>



<a name="273009736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273009736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273009736">(Feb 23 2022 at 20:51)</a>:</h4>
<p>so after chatting in wg-rustdoc on the discord, kinnison suggested running</p>
<div class="codehilite"><pre><span></span><code>rustup component add --toolchain nightly-2022-02-17-x86_64-apple-darwin --target aarch64-apple-darwin rustc-dev
</code></pre></div>
<p>I tried this, and now when I try to compile my project, instead of getting "can't find crate for rustc_borrowck", i get "can't find crate for <code>rustc_macros</code> which <code>rustc_borrowck</code> depends on"</p>



<a name="273011301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc_private%20cross-compilation/near/273011301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc_private.20cross-compilation.html#273011301">(Feb 23 2022 at 21:04)</a>:</h4>
<p>Right, proc macros are a hard case. To make rustc-dev work at all when cross-compiling rustc, <code>-Zdual-proc-macros</code> was introduced which basically makes both host and target version of a proc macro accepted by rustc despite having a different crate hash. The host version is likely not shipped with the target rustc-dev component. Maybe the proc macro in the host rustc-dev component is identical? In that case running <code>rustup component add rustc-dev</code> in addition to the one with <code>--target</code> may work. If not, you are probably out of luck. You could try running a rustc version compiled for aarch64 in qemu in the later case. (full system emulation or with some fiddling to make cargo use qemu as wrapper, with user mode emulation)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>