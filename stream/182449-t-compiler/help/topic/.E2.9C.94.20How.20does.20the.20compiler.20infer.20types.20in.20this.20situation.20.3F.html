<html>
<head><meta charset="utf-8"><title>✔ How does the compiler infer types in this situation ? · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html">✔ How does the compiler infer types in this situation ?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271544331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271544331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271544331">(Feb 11 2022 at 08:31)</a>:</h4>
<p>In general each variable’s type starts out as a fresh unknown variable</p>



<a name="271544409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271544409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271544409">(Feb 11 2022 at 08:32)</a>:</h4>
<p>As the type checker scans the code it will apply a rule specific to each bit of syntax which will constrain those unknown types</p>



<a name="271544455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271544455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271544455">(Feb 11 2022 at 08:32)</a>:</h4>
<p>In the case of languages like Rust, those constraints may also involve trait resolution, which is another layer of rules</p>



<a name="271544501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271544501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271544501">(Feb 11 2022 at 08:33)</a>:</h4>
<p>In your example <code>à</code> starts out as an unknown, say <code>?t</code></p>



<a name="271544753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271544753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271544753">(Feb 11 2022 at 08:36)</a>:</h4>
<p>Then on the following line we see a call to <code>St::f</code>, whose type is something like <code>fn f&lt;Tr&lt;a,b&gt;&gt;(a) -&gt; b</code></p>



<a name="271544828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271544828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271544828">(Feb 11 2022 at 08:37)</a>:</h4>
<p>So we generate fresh unknowns for a and b in the type call them <code>?b</code> and <code>?c</code></p>



<a name="271544951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271544951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271544951">(Feb 11 2022 at 08:38)</a>:</h4>
<p>Then we apply the rule for calls which will unify the arguments with their expected type</p>



<a name="271544972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271544972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271544972">(Feb 11 2022 at 08:38)</a>:</h4>
<p>So we get a constraint saying that <code>?a = ?b</code></p>



<a name="271545024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545024">(Feb 11 2022 at 08:39)</a>:</h4>
<p>We can continue this process to see that <code>?c = u16</code></p>



<a name="271545157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545157">(Feb 11 2022 at 08:41)</a>:</h4>
<p>And finally we can discharge the constraint <code>Tr&lt;?b,?c&gt;</code> which I forgot to mention was generated by the call</p>



<a name="271545189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545189">(Feb 11 2022 at 08:41)</a>:</h4>
<p>Doing so we see that <code>?b</code> must be <code>u8</code></p>



<a name="271545220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545220">(Feb 11 2022 at 08:41)</a>:</h4>
<p>The specific algorithm rust uses is more complex and different ofc</p>



<a name="271545313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teln0 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545313">(Feb 11 2022 at 08:42)</a>:</h4>
<p>Ok so when we look at the call we store a constraint and when we see something that's part of the constraint we "reprocess" the constraint ?</p>



<a name="271545327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545327">(Feb 11 2022 at 08:42)</a>:</h4>
<p>Xavier is correct, but while they were giving their explanation, I had already mostly written this out...... so this is my take (added some places in code if you want to dig):</p>
<ol>
<li>
<p>First, we need to determine what trait that method call corresponds to. Not exactly sure what the rules are, but inherent methods are preferred, and if a two traits apply to a type, we just give up and say it's ambiguous. <br>
 believe that is handled in <code>rustc_typeck::check::method::probe</code>.</p>
</li>
<li>
<p>Once we have determined that <code>St::f</code> means <code>&lt;St as Tr&lt;_, _&gt;&gt;::f</code>, then we take the function signature according to the trait, give it fresh inference variables, and use the types we gave to the method call to infer those type variables. <br>
I believe this is handled somewhere in <code>rustc_typeck::check::callee</code> (<code>confirm_overloaded_call</code>?)<br>
In this case, it doesn't really give us much information, since the only relevant type is a number, but we don't know what _kind_ of number.</p>
</li>
<li>
<p>We continue typechecking, and eventually end up learning that the return type is constrained by the let statement. Substituting that, we have <code>St</code> must implement <code>Tr&lt;_, u16&gt;</code>. </p>
</li>
</ol>
<p>To prove that, we do trait selection.</p>
<ol start="4">
<li>
<p>During trait selection, we gather all of the relevant impls that might apply to our type. We process through this list of impls, removing ones that we can prove will never apply (because types are not compatible). <br>
This all lives in <code>rustc_trait_selection::traits::select</code>. <br>
Specifically in <code>rustc_trait_selection::traits::select::candidate_assembly</code>.<br>
If there's only one obvious <code>impl</code> left, we "confirm" it by adding any extra where clauses it might then imply to our required list of things to solve.<br>
This lives in <code>rustc_trait_selection::traits::select::confirm</code>.</p>
</li>
<li>
<p>We iterate trait selection ("fulfillment") until we're done solving the program. In this case, the impl has no extra where clauses, so we're done.</p>
</li>
</ol>
<p>In reality, there's a bit more complication. Trait selection and type inference interleave in practice. We have to normalize things like projection types too, and then things like closures, dyn unsizing, etc all add extra layers.</p>



<a name="271545336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545336">(Feb 11 2022 at 08:42)</a>:</h4>
<p>But if you want to learn the basics of this kind of stuff, you should look for “Hindley-Milner type systems” and algorithm W</p>



<a name="271545531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545531">(Feb 11 2022 at 08:45)</a>:</h4>
<p>Seconded ^, understanding H-M type systems at least gives you a good foundation to understanding what's going on in the <code>rustc_typeck</code> crate.</p>



<a name="271545532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545532">(Feb 11 2022 at 08:45)</a>:</h4>
<p>Thanks for the detailed answer <span class="user-mention" data-user-id="426609">@Michael Goulet (compiler-errors)</span>, much more precise on Rust's implementation than I could ever be.</p>



<a name="271545600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545600">(Feb 11 2022 at 08:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312985">Teln0</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F/near/271545313">said</a>:</p>
<blockquote>
<p>Ok so when we look at the call we store a constraint and when we see something that's part of the constraint we "reprocess" the constraint ?</p>
</blockquote>
<p>Typically we perform inference / checking and <em>then</em> discharge all constraints</p>



<a name="271545633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545633">(Feb 11 2022 at 08:46)</a>:</h4>
<p>and we go back and replace all the inferred types with their answers</p>



<a name="271545643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teln0 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545643">(Feb 11 2022 at 08:46)</a>:</h4>
<p>Ok, I think I understand now</p>



<a name="271545657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Teln0 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545657">(Feb 11 2022 at 08:47)</a>:</h4>
<p>Thank you very much to everyone who replied !</p>



<a name="271545916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20How%20does%20the%20compiler%20infer%20types%20in%20this%20situation%20%3F/near/271545916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20How.20does.20the.20compiler.20infer.20types.20in.20this.20situation.20.3F.html#271545916">(Feb 11 2022 at 08:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312985">Teln0</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>