<html>
<head><meta charset="utf-8"><title>Breaking coherence with new `#[lang_item]`s · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Breaking.20coherence.20with.20new.20.60.23.5Blang_item.5D.60s.html">Breaking coherence with new `#[lang_item]`s</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264595811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Breaking%20coherence%20with%20new%20%60%23%5Blang_item%5D%60s/near/264595811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Breaking.20coherence.20with.20new.20.60.23.5Blang_item.5D.60s.html#264595811">(Dec 12 2021 at 01:20)</a>:</h4>
<p>Hello! I define <code>Simd&lt;T, N&gt;</code> in the crate <code>core::simd::Simd</code>, but am looking into options for having impls for <code>std::simd::Simd</code> for the same reasons that <code>f32</code> and <code>f64</code> do... actually for exactly the same reasons, heh, it's for <code>Simd&lt;f32, N&gt;</code>... and am investigating my options.<br>
I am seeing that the code in ./compiler/rustc_typeck/src/coherence/inherent_impls.rs seems to handle this, around</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">visit_item</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">item</span>: <span class="kp">&amp;</span><span class="nc">hir</span>::<span class="n">Item</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>but <code>core::simd::Simd</code> is defined as a <code>ty::Adt</code> that contain a <code>ty::Array</code>, with a <code>#[repr_simd]</code> annotation...<br>
It looks like I am going to have to do most of the check in ./compiler/rustc_typeck/src/check/check.rs for</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_simd</span><span class="p">(</span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">sp</span>: <span class="nc">Span</span><span class="p">,</span><span class="w"> </span><span class="n">def_id</span>: <span class="nc">LocalDefId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</code></pre></div>
<p>here to make sure I have the right <code>ty::Adt</code>? Or should I do something else tricky like check for a symbol? I am not sure where coherence checking comes in exactly.</p>



<a name="264595960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Breaking%20coherence%20with%20new%20%60%23%5Blang_item%5D%60s/near/264595960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Breaking.20coherence.20with.20new.20.60.23.5Blang_item.5D.60s.html#264595960">(Dec 12 2021 at 01:24)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="220273">@Jane Lusby [she/her]</span> ? ^^;</p>



<a name="264598360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Breaking%20coherence%20with%20new%20%60%23%5Blang_item%5D%60s/near/264598360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Breaking.20coherence.20with.20new.20.60.23.5Blang_item.5D.60s.html#264598360">(Dec 12 2021 at 02:27)</a>:</h4>
<p>Using lang items?</p>



<a name="264598367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Breaking%20coherence%20with%20new%20%60%23%5Blang_item%5D%60s/near/264598367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jane Lusby [she/her] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Breaking.20coherence.20with.20new.20.60.23.5Blang_item.5D.60s.html#264598367">(Dec 12 2021 at 02:27)</a>:</h4>
<p>Do you have a PR of what you're describing?</p>



<a name="264600074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Breaking%20coherence%20with%20new%20%60%23%5Blang_item%5D%60s/near/264600074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Breaking.20coherence.20with.20new.20.60.23.5Blang_item.5D.60s.html#264600074">(Dec 12 2021 at 03:20)</a>:</h4>
<p>Not yet, was drafting things.</p>



<a name="264608269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Breaking%20coherence%20with%20new%20%60%23%5Blang_item%5D%60s/near/264608269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Breaking.20coherence.20with.20new.20.60.23.5Blang_item.5D.60s.html#264608269">(Dec 12 2021 at 07:00)</a>:</h4>
<p>Here we go. <a href="https://github.com/rust-lang/rust/pull/91826">https://github.com/rust-lang/rust/pull/91826</a></p>



<a name="264613651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Breaking%20coherence%20with%20new%20%60%23%5Blang_item%5D%60s/near/264613651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Breaking.20coherence.20with.20new.20.60.23.5Blang_item.5D.60s.html#264613651">(Dec 12 2021 at 09:34)</a>:</h4>
<blockquote>
<p>here to make sure I have the right ty::Adt?</p>
</blockquote>
<p>You will probably need to add a lang item for <code>Simd</code> too.</p>



<a name="264638942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Breaking%20coherence%20with%20new%20%60%23%5Blang_item%5D%60s/near/264638942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Breaking.20coherence.20with.20new.20.60.23.5Blang_item.5D.60s.html#264638942">(Dec 12 2021 at 19:17)</a>:</h4>
<p>oh geez.</p>



<a name="264639515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Breaking%20coherence%20with%20new%20%60%23%5Blang_item%5D%60s/near/264639515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Breaking.20coherence.20with.20new.20.60.23.5Blang_item.5D.60s.html#264639515">(Dec 12 2021 at 19:31)</a>:</h4>
<p>starting to think "maybe I should just do an extension trait for now and write libmvec".</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>