<html>
<head><meta charset="utf-8"><title>Testing codegen fn args · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html">Testing codegen fn args</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274369602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274369602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kjetil Kjeka <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274369602">(Mar 07 2022 at 09:58)</a>:</h4>
<p>I recently found a codegen bug related to codegen of function arguments of ptx kernels (unstable abi). I have located the bug and have a local fix of the bug. </p>
<p>I'm now working on writing tests of the output format and was looking at test/codegen/riscv-abi.rs and test/codegen/avr-func-addrspace.rs in particular. I found the // CHECK stuff and have managed to create a test. </p>
<p>The problem is that the test uses a .ll file as input. To me, it seems like it would better to use the .ptx file as input. Are there any ways to do this? Or is it unnecessary?</p>



<a name="274377952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274377952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274377952">(Mar 07 2022 at 11:23)</a>:</h4>
<p>That would be an assembly test, not an llvm ir test. Llvm ir tests are in codegen/. Assembly tests in assembly/.</p>



<a name="274378042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274378042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274378042">(Mar 07 2022 at 11:24)</a>:</h4>
<p>There are already several nvptx tests in assembly/</p>



<a name="274379846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274379846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kjetil Kjeka <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274379846">(Mar 07 2022 at 11:43)</a>:</h4>
<p>Is it better to use "only-nvptx64" or "--target=nvptx64-nvidia-cuda" for tests that are only relevant for nvptx? I assume "only-nvptx64" since it may give better ability to filter out the tests if irrelevant?</p>



<a name="274380183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274380183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kjetil Kjeka <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274380183">(Mar 07 2022 at 11:46)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> it seems like these tests are marked with both "//only-nvptx64" and "//ignore-nvptx64". Doesn't that mean that these tests always will be ignored?</p>



<a name="274380349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274380349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274380349">(Mar 07 2022 at 11:48)</a>:</h4>
<p>It should be only-nvptx. --target=nvptx64-nvidia-cuda wouldn't work if libcore isn't compiled for nvptx which is almost always the case.</p>



<a name="274380380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274380380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274380380">(Mar 07 2022 at 11:49)</a>:</h4>
<p>I think combining only-nvptx64 and ignore-nvptx64 will indeed ignore the tests.</p>



<a name="274380405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274380405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274380405">(Mar 07 2022 at 11:49)</a>:</h4>
<p>We don't have any ci builder to check them anyway afaik.</p>



<a name="274382607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274382607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kjetil Kjeka <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274382607">(Mar 07 2022 at 12:13)</a>:</h4>
<p>Thanks a lot for the help. I've been able to fix the layout and create tests for the nvptx64-nvidia-cuda target. Just a question about the 32bit stuff.</p>
<p>It seems to me that the 32 bit target "nvptx-nvidia-cuda" is not listed in "Platform support". There's not a specification for the target shipped together with the rust compiler either, meaning "--target  nvptx-nvidia-cuda" will not work.</p>
<p>Would it be beneficial to do some housekeeping and removing the layout stuff for the 32bit target while I'm at it? Or should it be done separately in case there are someone using custom targets that will actually use parts of this code?</p>



<a name="274383001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274383001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274383001">(Mar 07 2022 at 12:17)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> do you know the answer to that question?</p>



<a name="274383633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274383633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274383633">(Mar 07 2022 at 12:24)</a>:</h4>
<p>32 bit cuda is basically unused AFAIK</p>



<a name="274383651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274383651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274383651">(Mar 07 2022 at 12:24)</a>:</h4>
<p>its kinda useless nowadays and rust-cuda doesnt support it either</p>



<a name="274383704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274383704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274383704">(Mar 07 2022 at 12:25)</a>:</h4>
<p>it complicates codegen in a lot of areas and especially when it comes to launching kernels cause AFAIK you cannot use cuda on 32-bit arches, at least not modern cuda</p>



<a name="274383809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274383809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274383809">(Mar 07 2022 at 12:26)</a>:</h4>
<p>So i would be in agreement in removing the target entirely from everywhere, but idk how other people feel about that</p>



<a name="274383855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274383855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274383855">(Mar 07 2022 at 12:27)</a>:</h4>
<p>Also yes ptx-kernel is super broken, it should be passing everything as a value</p>



<a name="274384101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274384101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274384101">(Mar 07 2022 at 12:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Testing.20codegen.20fn.20args/near/274383809">said</a>:</p>
<blockquote>
<p>So i would be in agreement in removing the target entirely from everywhere, but idk how other people feel about that</p>
</blockquote>
<p>It may need an MCP just like adding a target. Not sure though.</p>



<a name="274384293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274384293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274384293">(Mar 07 2022 at 12:31)</a>:</h4>
<p>yeah</p>



<a name="274384548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274384548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274384548">(Mar 07 2022 at 12:34)</a>:</h4>
<p>32-bit cuda doesnt even support unified memory, its a thing of the past that doesnt really have uses nowadays</p>



<a name="274395822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274395822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kjetil Kjeka <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274395822">(Mar 07 2022 at 14:07)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> This is a bugfix in an unstable feature that seems to be broken to the degree that nobody should have been able to sensibly use it as it currently stand. I don't really find the suitable approach in the rustc-dev-guild. Should I simply open a PR or are there anything I should do in addition (tracking issue, etc) to get it into the correct process?</p>



<a name="274398411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Testing%20codegen%20fn%20args/near/274398411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Testing.20codegen.20fn.20args.html#274398411">(Mar 07 2022 at 14:27)</a>:</h4>
<p>I think the removal of the 32bit cuda arch needs an MCP. Fixing the 64bit version can be a direct PR.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>