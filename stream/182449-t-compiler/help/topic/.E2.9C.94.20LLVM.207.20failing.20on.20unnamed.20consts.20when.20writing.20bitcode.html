<html>
<head><meta charset="utf-8"><title>✔ LLVM 7 failing on unnamed consts when writing bitcode · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html">✔ LLVM 7 failing on unnamed consts when writing bitcode</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257860621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257860621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257860621">(Oct 16 2021 at 20:55)</a>:</h4>
<p>I am running into an odd problem in my custom codegen, LLVM 7, when writing bitcode (through ThinBuffer) does not seem to like unnamed consts, it throws an assertion failure (index out of bounds for string ref) for something like</p>
<div class="codehilite"><pre><span></span><code>@0 = private unnamed_addr constant &lt;{ [16 x i8] }&gt; &lt;{ [16 x i8] c&quot;8c\ED&gt;\DA\0FI?^\98{?\DA\0F\C9?&quot; }&gt;, align 4
</code></pre></div>
<p>Renaming it to <code>@foo</code> fixes it. I was wondering, does anyone know what the issue here is?<br>
According to the llvm 7 ref, this should be fine:</p>
<blockquote>
<p>Unnamed values are represented as an unsigned numeric value with their prefix. For example, %12, @2, %44.</p>
</blockquote>
<p>Should i work around it somehow, generating a unique id instead of an unnamed const? I don't see any special handling for it inside of librustc_codegen_llvm (back when it used llvm 7).</p>



<a name="257860756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257860756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257860756">(Oct 16 2021 at 20:57)</a>:</h4>
<p>Ignoring the assertion does not do anything either, and it builds just fine. This only happens on libcore and libm because they are the only modules that actually use such consts.</p>



<a name="257862881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257862881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257862881">(Oct 16 2021 at 21:29)</a>:</h4>
<p>not assigning names to variables has caused problems in older versions of LLVM.</p>



<a name="257862888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257862888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257862888">(Oct 16 2021 at 21:29)</a>:</h4>
<p>e.g.. SROA would explode.</p>



<a name="257862949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257862949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257862949">(Oct 16 2021 at 21:30)</a>:</h4>
<p>Hmmm thats odd</p>



<a name="257862958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257862958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257862958">(Oct 16 2021 at 21:30)</a>:</h4>
<p>Do you mean like all variables or just constants?</p>



<a name="257862993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257862993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257862993">(Oct 16 2021 at 21:31)</a>:</h4>
<p>various situations.</p>



<a name="257863003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257863003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257863003">(Oct 16 2021 at 21:31)</a>:</h4>
<p>do you happen to know how older rustc dealt with it?</p>



<a name="257863018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257863018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257863018">(Oct 16 2021 at 21:31)</a>:</h4>
<p>in the future i will switch to using rustc's llvm version but for now im stuck with llvm 7 :/</p>



<a name="257864122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257864122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257864122">(Oct 16 2021 at 21:49)</a>:</h4>
<p>We disabled -Zfewer-names in various situations, and still do IIRC.</p>



<a name="257864197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257864197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257864197">(Oct 16 2021 at 21:50)</a>:</h4>
<p>hmm im pretty sure i implemented fewer-names already, it seems to be generating unnamed constants either ways</p>



<a name="257865807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257865807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257865807">(Oct 16 2021 at 22:15)</a>:</h4>
<p>yeah it seems to account for fewer-names just fine:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">sess</span><span class="p">().</span><span class="n">fewer_names</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                            </span><span class="n">llvm</span>::<span class="n">set_value_name</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"{:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">alloc_id</span><span class="p">).</span><span class="n">as_bytes</span><span class="p">());</span><span class="w"></span>
<span class="w">                        </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>However, its generating a lot of alloc names too, so i dont think this is the culprit, is it?</p>



<a name="257865837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257865837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257865837">(Oct 16 2021 at 22:15)</a>:</h4>
<p>should i just ignore fewer-names altogether?</p>



<a name="257866954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257866954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257866954">(Oct 16 2021 at 22:33)</a>:</h4>
<p>ignoring fewer_names does not seem to help, im guessing that private globals just are not accepted at all</p>



<a name="257867228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257867228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257867228">(Oct 16 2021 at 22:38)</a>:</h4>
<p>Yeah it seems like rustc with llvm 7 does not declare private globals at all, it generates a unique symbol for it</p>



<a name="257867466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257867466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257867466">(Oct 16 2021 at 22:42)</a>:</h4>
<p>Although, it seems like in older rustc, <code>kind</code> is always there, while in latest its optional, should i just use something like <code>private</code> if its None then generate a unique symbol?</p>



<a name="257867689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257867689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257867689">(Oct 16 2021 at 22:46)</a>:</h4>
<p>Yep i was correct, not using declare_private_global does in fact work flawlessly and it builds the gpu crates perfectly, so i guess ill count this as resolved, thank you for your help <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="257867690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20LLVM%207%20failing%20on%20unnamed%20consts%20when%20writing%20bitcode/near/257867690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20LLVM.207.20failing.20on.20unnamed.20consts.20when.20writing.20bitcode.html#257867690">(Oct 16 2021 at 22:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>