<html>
<head><meta charset="utf-8"><title>Blanket impl obligation mismatch · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html">Blanket impl obligation mismatch</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272404633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272404633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272404633">(Feb 18 2022 at 14:00)</a>:</h4>
<p>Hi! I need some help for an invalid predicate check on blanket impls in rustdoc (done <a href="https://github.com/rust-lang/rust/blob/master/src/librustdoc/clean/blanket_impl.rs#L39-L93">here</a>). So with the following code:</p>
<div class="codehilite"><pre><span></span><code>pub struct Foo(*const i8);
pub trait Whatever: Send {}
impl&lt;T: Send + ?Sized&gt; Whatever for T {}
</code></pre></div>
<p>It considers that <code>Whatever</code> is implemented on <code>Foo</code> whereas <code>Foo</code> is <code>!Send</code>. I think the obligations are incomplete but I'm bit lost at how to force the compiler to check "better". I replaced the drop from here with the following code (following <span class="user-mention" data-user-id="124288">@oli</span> recommendation):</p>
<div class="codehilite"><pre><span></span><code>for obligation in obligations {
    match infcx.evaluate_obligation(&amp;obligation) {
        Ok(eval_result) if eval_result.may_apply() =&gt; {}
        Err(traits::OverflowError::Canonical) =&gt; {}
        Err(traits::OverflowError::ErrorReporting) =&gt; {}
        _ =&gt; {
            return false;
        }
    }
}
</code></pre></div>
<p>Unfortunately, it didn't solve the issue. Any idea why? Any help would be very appreciated <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="272408696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272408696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272408696">(Feb 18 2022 at 14:34)</a>:</h4>
<p>Is the problem that it returns false wrongly or that it returns true wrongly?</p>



<a name="272412423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272412423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272412423">(Feb 18 2022 at 15:05)</a>:</h4>
<p>It returns true wrongly. It shouldn't be validated.</p>



<a name="272412469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272412469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272412469">(Feb 18 2022 at 15:05)</a>:</h4>
<p>I guess the <code>may_apply</code> is wrong and should be <code>false</code> instead.</p>



<a name="272419055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272419055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272419055">(Feb 18 2022 at 15:58)</a>:</h4>
<p>Well... <code>may_apply</code> does not mean <code>applies</code> so there are indeed some things that hit the may_apply path that should return false, but not sure without a deeper review if we can get a proper answer</p>



<a name="272419110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272419110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272419110">(Feb 18 2022 at 15:58)</a>:</h4>
<p>You may have to spin up a selectioncontext and put all the obligations into it and see if we can resolve everything</p>



<a name="272420153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272420153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272420153">(Feb 18 2022 at 16:06)</a>:</h4>
<p>By using <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_trait_selection/traits/struct.SelectionContext.html#method.confirm_candidate">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_trait_selection/traits/struct.SelectionContext.html#method.confirm_candidate</a> ?</p>



<a name="272420169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272420169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272420169">(Feb 18 2022 at 16:06)</a>:</h4>
<p>Or do you have another method in mind?</p>



<a name="272507038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272507038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272507038">(Feb 19 2022 at 09:42)</a>:</h4>
<p>Ah, I gave you the low level interface, sorry. Use <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_infer/traits/trait.TraitEngine.html#tymethod.register_predicate_obligation">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_infer/traits/trait.TraitEngine.html#tymethod.register_predicate_obligation</a> to register all obligations and <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_infer/traits/trait.TraitEngine.html#tymethod.select_all_or_error">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_infer/traits/trait.TraitEngine.html#tymethod.select_all_or_error</a> to solve them all together.</p>



<a name="272507060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272507060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272507060">(Feb 19 2022 at 09:43)</a>:</h4>
<p>If you get a nonempty vec, then it didnt apply</p>



<a name="272507194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272507194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272507194">(Feb 19 2022 at 09:46)</a>:</h4>
<p>You get a trait engine via <code>&lt;dyn TraitEngine&lt;'_&gt;&gt;::new(tcx</code></p>



<a name="272516639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272516639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272516639">(Feb 19 2022 at 12:51)</a>:</h4>
<p>Nice, thanks for the explanations! I will give it a try shortly</p>



<a name="272518120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272518120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272518120">(Feb 19 2022 at 13:21)</a>:</h4>
<p>So I replaced the <code>drop(obligations)</code> with:</p>
<div class="codehilite"><pre><span></span><code>let mut fcx = FulfillmentContext::new();
for obligation in obligations {
    fcx.register_predicate_obligation(&amp;infcx, obligation);
}
if !fcx.select_all_or_error(&amp;infcx).is_empty() {
    return false;
}
</code></pre></div>
<p>Still not working. I gave a try to use <code>register_predicate_obligation</code> in the loop below, but the only result was the removal of a few other blanket impls (which are valid) but not the one we're trying to remove. So my main hypothesis is that I badly used the code you provided to me. Any idea what I did badly?</p>



<a name="272520649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272520649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272520649">(Feb 19 2022 at 14:09)</a>:</h4>
<p>Huh, more got removed? Did you duplicate the select_all_or_error? If so, try only having a single one after you added all obligations</p>



<a name="272520663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272520663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272520663">(Feb 19 2022 at 14:09)</a>:</h4>
<p>In any case, I don't see a way forward but to dig into some logs and figure out where things go sideways</p>



<a name="272590128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272590128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> GuillaumeGomez <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272590128">(Feb 20 2022 at 12:44)</a>:</h4>
<p>No, didn't duplicate, simply changed where it was filled and called (in the loop below the drop). I'll gather some logs if you want :)</p>



<a name="272592615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Blanket%20impl%20obligation%20mismatch/near/272592615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Blanket.20impl.20obligation.20mismatch.html#272592615">(Feb 20 2022 at 13:33)</a>:</h4>
<p>This is more of a case of me or you needing to read logs and source at the same time and figuring out what's going on, less of a you producing logs and me being any use in reading them</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>