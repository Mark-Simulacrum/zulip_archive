<html>
<head><meta charset="utf-8"><title>str::from_utf8 in rustc_serialize · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/str.3A.3Afrom_utf8.20in.20rustc_serialize.html">str::from_utf8 in rustc_serialize</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251138777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/str%3A%3Afrom_utf8%20in%20rustc_serialize/near/251138777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/str.3A.3Afrom_utf8.20in.20rustc_serialize.html#251138777">(Aug 29 2021 at 15:15)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/compiler/rustc_serialize/src/opaque.rs#L659">https://github.com/rust-lang/rust/blob/59ce76548484806ac4970c57c0bb6ad9e53b80f6/compiler/rustc_serialize/src/opaque.rs#L659</a></p>
<p>The utf8 validation there is needed because the serialized data isn't type-tagged and therefore it has to guard against <code>read_str</code> being called at the wrong time, right?</p>



<a name="251141344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/str%3A%3Afrom_utf8%20in%20rustc_serialize/near/251141344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/str.3A.3Afrom_utf8.20in.20rustc_serialize.html#251141344">(Aug 29 2021 at 16:02)</a>:</h4>
<p>Yeah, the serializer and deserializer may get mismatched or the data could get corrupted.</p>



<a name="263303086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/str%3A%3Afrom_utf8%20in%20rustc_serialize/near/263303086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/str.3A.3Afrom_utf8.20in.20rustc_serialize.html#263303086">(Dec 01 2021 at 15:00)</a>:</h4>
<p>I've done a perf run in <a href="https://github.com/rust-lang/rust/issues/91407">#91407</a> to get a baseline how much we'd save by not doing the validation.<br>
<a href="https://perf.rust-lang.org/compare.html?start=207c80f105282245d93024c95ac408c622f70114&amp;end=ae738380b413f7adb5c0254e2c1dc1430fb4e8dd">https://perf.rust-lang.org/compare.html?start=207c80f105282245d93024c95ac408c622f70114&amp;end=ae738380b413f7adb5c0254e2c1dc1430fb4e8dd</a></p>
<p>Up to 3% on rustdoc, up to 2.3% on check builds. I think it's worth it.</p>
<p>Maybe we can retain a little bit of sanity checking by adding a sentinel byte at the end of the string when serializing. Then the encoded length + seeking to the sentinel byte would at least detect cases where we're trying to decode something that wasn't encoded by the matching routine. It doesn't protect against data corruption but neither do most of the other read functions.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>