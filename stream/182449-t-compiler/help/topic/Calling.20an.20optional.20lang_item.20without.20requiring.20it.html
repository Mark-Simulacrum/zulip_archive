<html>
<head><meta charset="utf-8"><title>Calling an optional lang_item without requiring it · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html">Calling an optional lang_item without requiring it</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="259031052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259031052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Paoliello <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259031052">(Oct 25 2021 at 22:50)</a>:</h4>
<p>Currently I'm working on an experiment to add <code>panic::catch_unwind</code> to libcore. To make it compatible with the existing panic runtimes (specifically <code>panic_unwind</code>), I've need to add a new <code>lang_item</code> that gives the runtime a chance to cleanup any state allocated when the panic exception is thrown (one can consider it like an empty catch).</p>
<p>It was easy enough to add this <code>lang_item</code> and then expose it via a new intrinsic - but my issue is how to make it "pay for play", that is the <code>lang_item</code> is only required <em>if</em> <code>panic::catch_unwind</code> is called. Currently I have it "working" by relying on <code>catch_unwind</code> being a generic, so the intrinsic is only actually used if <code>catch_unwind</code> is instantiated - but this seems fragile...</p>
<p>Is there a better way to do this? Or does Rust make any guarantees about uninstantiated code?</p>



<a name="259038778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259038778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259038778">(Oct 26 2021 at 00:43)</a>:</h4>
<p>I don't think catch_unwind belongs to the libcore.</p>



<a name="259038841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259038841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259038841">(Oct 26 2021 at 00:44)</a>:</h4>
<p>It needs to return a boxed error.</p>



<a name="259039451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259039451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259039451">(Oct 26 2021 at 00:55)</a>:</h4>
<p>It might be possible to put it in alloc</p>



<a name="259043522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259043522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259043522">(Oct 26 2021 at 02:06)</a>:</h4>
<p>It's still not useful though; any crate using <code>catch_unwind</code> will need to link to the std anyway.</p>



<a name="259129079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259129079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Paoliello <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259129079">(Oct 26 2021 at 17:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it/near/259043522">said</a>:</p>
<blockquote>
<p>It's still not useful though; any crate using <code>catch_unwind</code> will need to link to the std anyway.</p>
</blockquote>
<p>Why do you say that? The <code>panic_unwind</code> runtime depends on libcore and liballoc: so it is entirely reasonable for someone to want <code>catch_unwind</code> in a <code>no_std</code> environment.</p>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it/near/259038841">said</a>:</p>
<blockquote>
<p>It needs to return a boxed error.</p>
</blockquote>
<p>If we are keeping the same API shape, then yes. If we wanted to break the dependency on liballoc, then it could return an empty error.</p>



<a name="259131859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259131859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259131859">(Oct 26 2021 at 17:28)</a>:</h4>
<blockquote>
<p>Why do you say that?</p>
</blockquote>
<p>The only way to include the panic runtime is through libstd. The panic runtime is an implementation detail of libstd and may just as well be merged into libstd.</p>



<a name="259132012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259132012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259132012">(Oct 26 2021 at 17:29)</a>:</h4>
<blockquote>
<p>so it is entirely reasonable for someone to want catch_unwind in a no_std environment.</p>
</blockquote>
<p>Catching panics requires throwing them in the first place. no_std doesn't allow throwing panics, it requires an aborting panic handler.</p>



<a name="259138722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259138722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259138722">(Oct 26 2021 at 18:16)</a>:</h4>
<p>The one case I could think of would be a core + alloc library that needs to be compatible with panics, but doesn't want to add a separate <code>no-std</code> feature and <code>#[cfg]</code>s</p>



<a name="259138829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259138829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259138829">(Oct 26 2021 at 18:17)</a>:</h4>
<p>such a library could unconditionally call <code>catch_unwind</code>, even though it might be effectively a no-op if the final build artifact is also <code>no_std</code></p>



<a name="259142310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259142310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Paoliello <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259142310">(Oct 26 2021 at 18:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it/near/259132012">said</a>:</p>
<blockquote>
<p>Catching panics requires throwing them in the first place. no_std doesn't allow throwing panics, it requires an aborting panic handler.</p>
</blockquote>
<p>What prevents a throwing panic in no_std (other than the lack of a prebuilt no_std panic runtime)? Could someone build their own throwing panic for whatever no_std environment they are working in?</p>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it/near/259131859">said</a>:</p>
<blockquote>
<p>The only way to include the panic runtime is through libstd.</p>
</blockquote>
<p>Currently, yes, but if there is nothing that fundamentally prevents a throwing panic in no_std then one could imagine completely splitting the panic runtimes out of libstd and allowing them in a libcore+liballoc environment (just as one can pull in liballoc without all of libstd).</p>



<a name="259156241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259156241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259156241">(Oct 26 2021 at 20:26)</a>:</h4>
<p>We don't guarantee any particular unwinding mechanism, so no you can't write your own throwing panic on stable.</p>



<a name="259163571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259163571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259163571">(Oct 26 2021 at 21:23)</a>:</h4>
<p>The only <code>catch_unwind</code> implementation that makes sense in <code>#![no_std]</code> is one that unconditionally drops the error; even that would require delegating the cleanup work to the panic runtime.</p>



<a name="259424276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259424276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Paoliello <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259424276">(Oct 28 2021 at 17:31)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> I agree that this may not be possible on stable, but if you are using no_std you quickly end up needing unstable features anyway. Also, just to prove out that panic unwind (and, therefore, <code>catch_unwind</code>) are usable in a libcore+liballoc environment, here is a prototype that demonstrates it: <a href="https://github.com/dpaoliello/catch_unwind_in_no_std">https://github.com/dpaoliello/catch_unwind_in_no_std</a></p>



<a name="259424376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Calling%20an%20optional%20lang_item%20without%20requiring%20it/near/259424376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Paoliello <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Calling.20an.20optional.20lang_item.20without.20requiring.20it.html#259424376">(Oct 28 2021 at 17:32)</a>:</h4>
<p>Makes me wonder if there should be a <code>core::panic::catch_unwind</code> in the <code>panic_unwind</code> crate (since it has access to <code>Box</code>, thus the function signature can be the same)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>