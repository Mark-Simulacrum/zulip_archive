<html>
<head><meta charset="utf-8"><title>Determine if a FrameInfo/DefId is crate under test? · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Determine.20if.20a.20FrameInfo.2FDefId.20is.20crate.20under.20test.3F.html">Determine if a FrameInfo/DefId is crate under test?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275109972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Determine%20if%20a%20FrameInfo/DefId%20is%20crate%20under%20test%3F/near/275109972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Determine.20if.20a.20FrameInfo.2FDefId.20is.20crate.20under.20test.3F.html#275109972">(Mar 12 2022 at 18:20)</a>:</h4>
<p>I am working on Miri diagnostics. One of the things Miri really wants to know is whether telling the user about a Frame is likely to be actionable. Currently, the heuristic for this is <code>FrameInfo.instance.def_id().is_local()</code>. The problem is that this seems to be false for the crate under test, when I'm running integration tests or doctests.</p>
<p>I'm down for any kind of hackery. Currently I'm considering inverting the approach and taking the <code>CrateNum</code> from the <code>DefId</code> and putting that into <code>TyCtxt::crate_name</code> and checking if that's one of <code>core</code>, <code>std</code>, <code>alloc</code>, etc.</p>



<a name="275113134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Determine%20if%20a%20FrameInfo/DefId%20is%20crate%20under%20test%3F/near/275113134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Determine.20if.20a.20FrameInfo.2FDefId.20is.20crate.20under.20test.3F.html#275113134">(Mar 12 2022 at 19:30)</a>:</h4>
<p>Random ideas: </p>
<ul>
<li><code>used_crate_source</code> could be None for the sysroot crates</li>
<li>add a diagnostic item to the crate root of the crates you want to exclude</li>
<li>check if <code>lookup_stability</code> of the crate root is <code>None</code> (true for all crates not in the sysroot)</li>
</ul>



<a name="275113149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Determine%20if%20a%20FrameInfo/DefId%20is%20crate%20under%20test%3F/near/275113149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Determine.20if.20a.20FrameInfo.2FDefId.20is.20crate.20under.20test.3F.html#275113149">(Mar 12 2022 at 19:31)</a>:</h4>
<p>I guess also filter out any kind of shims?</p>



<a name="275114167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Determine%20if%20a%20FrameInfo/DefId%20is%20crate%20under%20test%3F/near/275114167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Determine.20if.20a.20FrameInfo.2FDefId.20is.20crate.20under.20test.3F.html#275114167">(Mar 12 2022 at 19:54)</a>:</h4>
<p>Interesting. But if possible, I would rather figure out what crate's tests I'm running.</p>



<a name="275114986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Determine%20if%20a%20FrameInfo/DefId%20is%20crate%20under%20test%3F/near/275114986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Determine.20if.20a.20FrameInfo.2FDefId.20is.20crate.20under.20test.3F.html#275114986">(Mar 12 2022 at 20:13)</a>:</h4>
<p>Right... maybe the test crate's name gives something away? Probably doesn't work for integration tests just inline tests.</p>



<a name="275115153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Determine%20if%20a%20FrameInfo/DefId%20is%20crate%20under%20test%3F/near/275115153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Determine.20if.20a.20FrameInfo.2FDefId.20is.20crate.20under.20test.3F.html#275115153">(Mar 12 2022 at 20:16)</a>:</h4>
<p>Hmm... this backtrace filtering seems like something that regular backtraces could also benefit from. Maybe we should have something in rustc itself that both backtraces and miri backtraces can use</p>



<a name="275117418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Determine%20if%20a%20FrameInfo/DefId%20is%20crate%20under%20test%3F/near/275117418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Determine.20if.20a.20FrameInfo.2FDefId.20is.20crate.20under.20test.3F.html#275117418">(Mar 12 2022 at 21:10)</a>:</h4>
<p>I don't think we should hide anything more than what libstd already does currently. Unlike for miri errors, panics often originate in dependencies without the user crate being at fault. In those cases hiding the dependency frames would throw away valuable information and possibly confuse people.</p>



<a name="275120527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Determine%20if%20a%20FrameInfo/DefId%20is%20crate%20under%20test%3F/near/275120527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Determine.20if.20a.20FrameInfo.2FDefId.20is.20crate.20under.20test.3F.html#275120527">(Mar 12 2022 at 22:39)</a>:</h4>
<p>It looks like crate names may give away that they are an integration test or doctest. Integration tests seem to be called <code>test</code> and doctests seem to be called <code>rust_out</code>. But I'm not sure how to work out the name of the crate that's being tested</p>



<a name="275124025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Determine%20if%20a%20FrameInfo/DefId%20is%20crate%20under%20test%3F/near/275124025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Kimock (Saethlin) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Determine.20if.20a.20FrameInfo.2FDefId.20is.20crate.20under.20test.3F.html#275124025">(Mar 13 2022 at 00:21)</a>:</h4>
<p>I came up with something, but it's pretty unholy. I'm running <code>cargo metadata</code> inside <code>cargo-miri</code> at startup to grab all the workspace crate names, then converting them to <code>CrateNum</code> when the machine starts up. Then I check if <code>def_id.is_local() || local_crates.contains(&amp;def_id.krate)</code> to see if we should consider the frame as local.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>