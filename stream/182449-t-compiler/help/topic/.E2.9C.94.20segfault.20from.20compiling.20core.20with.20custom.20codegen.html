<html>
<head><meta charset="utf-8"><title>✔ segfault from compiling core with custom codegen · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html">✔ segfault from compiling core with custom codegen</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="245751432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245751432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245751432">(Jul 12 2021 at 21:18)</a>:</h4>
<p>I have finished most of my custom codegen, and i am now trying to compile core but running into a bit of a major issue. cargo manages to build <code>compiler_builtins</code> and <code>rustc-std-workspace-core</code> just fine:</p>
<div class="codehilite"><pre><span></span><code>Compiling compiler_builtins v0.1.46
   Compiling rustc-std-workspace-core v1.99.0 (C:\Users\caval\Documents\Github\rust\build\x86_64-pc-windows-msvc\stage2\lib\rustlib\src\rust\library\rustc-std-workspace-core)
</code></pre></div>
<p>I have some debugs here and there and i can see that it finishes linking rustc-std-workspace just fine (<a href="http://link.rs">link.rs</a> 64), then it tries to start codegenning core im guessing, because <code>lib.rs:95</code> is codegen_crate where it calls rustc_codegen_ssa:</p>
<div class="codehilite"><pre><span></span><code>[crates\rustc_codegen_nvvm\src\lib.rs:95]  Codegen crate (compiler_builtins?)
[crates\rustc_codegen_nvvm\src\lib.rs:95] Codegen crate (rustc-std-workspace-core?)
[crates\rustc_codegen_nvvm\src\lib.rs:201] WriteBackendMethods::codegen
[crates\rustc_codegen_nvvm\src\lib.rs:110] join_codegen
[crates\rustc_codegen_nvvm\src\lib.rs:127] link
[crates\rustc_codegen_nvvm\src\link.rs:28] start linking
[crates\rustc_codegen_nvvm\src\link.rs:51] link rlib
[crates\rustc_codegen_nvvm\src\link.rs:106] grab files, begin making archive
[crates\rustc_codegen_nvvm\src\link.rs:113] archive created
[crates\rustc_codegen_nvvm\src\link.rs:60] finish linking
[crates\rustc_codegen_nvvm\src\link.rs:62] same as above
[crates\rustc_codegen_nvvm\src\link.rs:64] same as above
[crates\rustc_codegen_nvvm\src\lib.rs:95] Codegen crate (core)
</code></pre></div>
<p>However, after this it segfaults:</p>
<div class="codehilite"><pre><span></span><code>error: could not compile `core`

Caused by:
  process didn&#39;t exit successfully: `rustc --crate-name core --edition=2018 C:\Users\caval\Documents\Github\rust\build\x86_64-pc-windows-msvc\stage2\lib\rustlib\src\rust\library\core\src\lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts
--crate-type lib --emit=dep-info,metadata,link -C embed-bitcode=no -C debuginfo=2 -C metadata=0d7c196550ba8193 -C extra-filename=-0d7c196550ba8193 --out-dir C:\Users\caval\Documents\Github\cuda_test\target\nvptx64-nvidia-cuda\debug\deps --target
nvptx64-nvidia-cuda -Z force-unstable-if-unmarked -L dependency=C:\Users\caval\Documents\Github\cuda_test\target\nvptx64-nvidia-cuda\debug\deps -L dependency=C:\Users\caval\Documents\Github\cuda_test\target\debug\deps --cap-lints allow -Z
codegen-backend=C:\Users\caval\Documents\Github\rustc_codegen_nvvm\target\release\rustc_codegen_nvvm.dll --emit=llvm-ir` (exit code: 0xc0000005, STATUS_ACCESS_VIOLATION)

warning: build failed, waiting for other jobs to finish...
error: build failed
</code></pre></div>
<p>While i do actually call libnvvm functions that are unsafe, that only happens during linking, the only things i call before that are llvm context creation and llvm builders, not even llvm codegen/opt. Therefore i am a bit lost on why rustc is dying all the sudden here. Even stranger, if i run the command on my own, it does not segfault but it does not get past codegen_crate either (debug only prints <code>lib.rs:95</code>)</p>
<p>I have built rustc with debug info, and no backtrace happens, and rustc_log yields nothing helpful, so i am a bit lost and would appreciate any ideas on why this is dying</p>



<a name="245751568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245751568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245751568">(Jul 12 2021 at 21:19)</a>:</h4>
<p>attaching a debugger does not yield anything helpful either, attaching it on both the cargo command and the manual rustc command</p>



<a name="245751708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245751708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245751708">(Jul 12 2021 at 21:20)</a>:</h4>
<p>I'm not very familiar with windows debugging - is it possible to get a bscktradh from a crashed process?</p>



<a name="245751765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245751765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245751765">(Jul 12 2021 at 21:21)</a>:</h4>
<p>I knoe that on Linux, a core dump file gets written</p>



<a name="245751801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245751801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245751801">(Jul 12 2021 at 21:21)</a>:</h4>
<p>well usually its possible to attach a debugger and the debugger gives you at least something to work off, but in my case absolutely nothing, it prints that the process died and thats it</p>



<a name="245751805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245751805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245751805">(Jul 12 2021 at 21:21)</a>:</h4>
<p><code>ulimit -c unlimited</code> is often necessary to get a coredump.</p>



<a name="245751840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245751840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245751840">(Jul 12 2021 at 21:22)</a>:</h4>
<p>Does <code>bt</code> not give a backtrace?</p>



<a name="245751889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245751889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245751889">(Jul 12 2021 at 21:22)</a>:</h4>
<p>and usually if a command dies from a segfault you see it, but it says nothing if i try to run the rustc command on my own</p>



<a name="245752011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245752011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245752011">(Jul 12 2021 at 21:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/segfault.20from.20compiling.20core.20with.20custom.20codegen/near/245751840">said</a>:</p>
<blockquote>
<p>Does <code>bt</code> not give a backtrace?</p>
</blockquote>
<p>you mean try getting a backtrace with windbg? ive never heard of <code>bt</code> on windows</p>



<a name="245752220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245752220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245752220">(Jul 12 2021 at 21:25)</a>:</h4>
<p>i havent tried enabling rustc_log then running the rustc command manually, lemme see if that gives me anything useful</p>



<a name="245752244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245752244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245752244">(Jul 12 2021 at 21:25)</a>:</h4>
<p>although rustc_log was enabled for the cargo command so it should have rustc_log already</p>



<a name="245752336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245752336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245752336">(Jul 12 2021 at 21:26)</a>:</h4>
<p>Yeah I meant the command to get a backtrace using the debugger you use. bt is a gdb or lldb command.</p>



<a name="245752396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245752396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245752396">(Jul 12 2021 at 21:26)</a>:</h4>
<p>im using the C++ windows debugger in vsc, which usually works just fine, but it does not "stop" at the segfault oddly enough</p>



<a name="245752664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245752664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245752664">(Jul 12 2021 at 21:28)</a>:</h4>
<p>oh boy rustc just dumped a 1.7gb large log file from rustc_log, this was a mistake</p>



<a name="245752834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245752834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245752834">(Jul 12 2021 at 21:30)</a>:</h4>
<p>if rustc_log doesnt give me anything ill try running the rustc command under lldb</p>



<a name="245752880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245752880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> danii <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245752880">(Jul 12 2021 at 21:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/segfault.20from.20compiling.20core.20with.20custom.20codegen/near/245752664">said</a>:</p>
<blockquote>
<p>oh boy rustc just dumped a 1.7gb large log file from rustc_log, this was a mistake</p>
</blockquote>
<p>You can add the name of the module you're debugging for in the environment variable; <code>RUSTC_LOG=rustc_mid_whatever::some::module=debug</code></p>



<a name="245752914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245752914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245752914">(Jul 12 2021 at 21:30)</a>:</h4>
<p>yeah the issue is im not completely sure where its dying, so if i only enable it on one crate, it wont catch the others</p>



<a name="245753129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245753129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245753129">(Jul 12 2021 at 21:32)</a>:</h4>
<p>i mean i know its getting to codegen, because its calling <code>codegen_crate</code>, but its dying soon after that</p>



<a name="245753982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245753982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245753982">(Jul 12 2021 at 21:40)</a>:</h4>
<p>haha ok yeah im definitely going to limit it to rustc_codegen_ssa because its at 6gb <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="245754084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245754084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245754084">(Jul 12 2021 at 21:41)</a>:</h4>
<p>the last lines it prints are</p>
<div class="codehilite"><pre><span></span><code>DEBUG rustc_codegen_ssa::mir::block codegen_block(bb5=BasicBlockData { statements: [_6 = _1], terminator: Some(Terminator { source_info: SourceInfo { span:
C:\Users\caval\.rustup\toolchains\nightly-x86_64-pc-windows-msvc\lib\rustlib\src\rust\library\core\src\sync\atomic.rs:2355:23: 2355:51 (#0), scope: scope[0] }, kind: _0 = intrinsics::atomic_load::&lt;T&gt;(move _6) -&gt; bb7 }), is_cleanup: false })
DEBUG rustc_codegen_ssa::mir::statement codegen_statement(statement=_6 = _1)
DEBUG rustc_codegen_ssa::mir::operand codegen_operand(operand=_1)
DEBUG rustc_codegen_ssa::mir::operand codegen_consume(place_ref=PlaceRef { local: _1, projection: [] })
DEBUG rustc_codegen_ssa::mir monomorphize: self.instance=Instance { def: Item(WithOptConstParam { did: DefId(0:8500 ~ core[caec]::sync::atomic::atomic_load), const_param_did: None }), substs: [isize] }
DEBUG rustc_codegen_ssa::mir::operand maybe_codegen_consume_direct(place_ref=PlaceRef { local: _1, projection: [] })
DEBUG rustc_codegen_ssa::mir::block codegen_terminator: Terminator { source_info: SourceInfo { span: C:\Users\caval\.rustup\toolchains\nightly-x86_64-pc-windows-msvc\lib\rustlib\src\rust\library\core\src\sync\atomic.rs:2355:23: 2355:51 (#0), scope: scope[0] },
kind: _0 = intrinsics::atomic_load::&lt;T&gt;(move _6) -&gt; bb7 }
DEBUG rustc_codegen_ssa::mir::operand codegen_operand(operand=intrinsics::atomic_load::&lt;T&gt;)
DEBUG rustc_codegen_ssa::mir monomorphize: self.instance=Instance { def: Item(WithOptConstParam { did: DefId(0:8500 ~ core[caec]::sync::atomic::atomic_load), const_param_did: None }), substs: [isize] }
DEBUG rustc_codegen_ssa::mir monomorphize: self.instance=Instance { def: Item(WithOptConstParam { did: DefId(0:8500 ~ core[caec]::sync::atomic::atomic_load), const_param_did: None }), substs: [isize] }
DEBUG rustc_codegen_ssa::mir::operand codegen_operand(operand=move _6)
DEBUG rustc_codegen_ssa::mir::operand codegen_consume(place_ref=PlaceRef { local: _6, projection: [] })
DEBUG rustc_codegen_ssa::mir monomorphize: self.instance=Instance { def: Item(WithOptConstParam { did: DefId(0:8500 ~ core[caec]::sync::atomic::atomic_load), const_param_did: None }), substs: [isize] }
DEBUG rustc_codegen_ssa::mir::operand maybe_codegen_consume_direct(place_ref=PlaceRef { local: _6, projection: [] })
</code></pre></div>
<p>which doesnt seem very helpful <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="245754131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245754131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245754131">(Jul 12 2021 at 21:41)</a>:</h4>
<p>the only potentially dangerous things i see are the atomic loads which i handle by generating a print then an abort but other than that... im not quite sure</p>



<a name="245754432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245754432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> danii <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245754432">(Jul 12 2021 at 21:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/segfault.20from.20compiling.20core.20with.20custom.20codegen/near/245752914">said</a>:</p>
<blockquote>
<p>yeah the issue is im not completely sure where its dying, so if i only enable it on one crate, it wont catch the others</p>
</blockquote>
<p>unfortunately i don't think there's any other way to debug.<br>
Maybe there's a way to run a debugger? Nothing on the rustc guide says anything about using a debugger though.</p>



<a name="245754552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245754552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245754552">(Jul 12 2021 at 21:46)</a>:</h4>
<p>the only thing i can think of is that maybe i give rustc_codegen_ssa an incorrect value,  then it does something with that and llvm maybe segfaults with it</p>



<a name="245754597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245754597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245754597">(Jul 12 2021 at 21:47)</a>:</h4>
<p>because i handle loads using this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">fn</span> <span class="nf">atomic_load</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_ptr</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">ll</span> <span class="nc">Value</span><span class="p">,</span><span class="w"> </span><span class="n">_order</span>: <span class="nc">AtomicOrdering</span><span class="p">,</span><span class="w"> </span><span class="n">_size</span>: <span class="nc">Size</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="o">'</span><span class="na">ll</span> <span class="nc">Value</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_intrinsic</span><span class="p">(</span><span class="s">"llvm.trap"</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[],</span><span class="w"> </span><span class="nb">None</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The reason being that core seems to think nvptx supports atomic loads, which it doesnt, so i am kind of forced to give it a garbage value</p>



<a name="245755114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245755114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245755114">(Jul 12 2021 at 21:52)</a>:</h4>
<p>haha that was it, i am so dumb <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="245755130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245755130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245755130">(Jul 12 2021 at 21:52)</a>:</h4>
<p>thanks everyone <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="245755133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245755133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245755133">(Jul 12 2021 at 21:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> has marked this topic as resolved.</p>



<a name="245755992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245755992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245755992">(Jul 12 2021 at 22:01)</a>:</h4>
<blockquote>
<p>error[E0463]: can't find crate for <code>core</code><br>
consider building the standard library from source with <code>cargo build -Zbuild-std</code><br>
<code>-Zbuild-std=core</code></p>
</blockquote>
<p>o.O did i not just ask cargo to do that? lol</p>



<a name="245756811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245756811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245756811">(Jul 12 2021 at 22:10)</a>:</h4>
<p>TIL you can mark a conversation as resolved</p>



<a name="245756919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245756919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245756919">(Jul 12 2021 at 22:11)</a>:</h4>
<p>yeah it seems to be added for a couple of days, and surprisingly anyone can mark convos as resolved for some reason lol</p>



<a name="245756965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245756965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245756965">(Jul 12 2021 at 22:11)</a>:</h4>
<p>Whatever works I suppose. Good to know. It's a simple way to indicate all is done.</p>



<a name="245757780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245757780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245757780">(Jul 12 2021 at 22:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> has marked this topic as unresolved.</p>



<a name="245757801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245757801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245757801">(Jul 12 2021 at 22:21)</a>:</h4>
<p>yeah this is pretty odd, even giving rustc a place to look for libcore doesnt seem to work</p>



<a name="245757872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245757872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245757872">(Jul 12 2021 at 22:22)</a>:</h4>
<p>i can see the <code>libcore-xxxxxx.rlib</code> and rmeta files in deps, so it definitely built it</p>



<a name="245758640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245758640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245758640">(Jul 12 2021 at 22:32)</a>:</h4>
<p>perhaps rustc recognizes nvptx64-nvidia-cuda and it tries to find core as it would with other targets, although build-std should take care of this automatically</p>



<a name="245758886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245758886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245758886">(Jul 12 2021 at 22:36)</a>:</h4>
<p>oh, apparently just not giving it -Z build-std works now, lol, i presume this isnt reliable though and only works because i have core built from -Z build-std</p>



<a name="245804363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245804363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245804363">(Jul 13 2021 at 10:24)</a>:</h4>
<p>If you use LLVM, make sure to build it with assertions enabled.</p>



<a name="245804400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245804400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245804400">(Jul 13 2021 at 10:24)</a>:</h4>
<p>because assertions become traps = sigsegvs otherwise for perf reasons. And invalid uses of the API trigger asserts.</p>



<a name="245804475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245804475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245804475">(Jul 13 2021 at 10:25)</a>:</h4>
<p>when you're trying to debug and obtain a stack trace with a debugger, make sure to attach the debugger to the rustc process, not cargo or one of the wrappers that <code>x.py</code> calls.</p>



<a name="245804610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245804610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245804610">(Jul 13 2021 at 10:26)</a>:</h4>
<p>actual rustcs tend to be put into <code>build/&lt;target&gt;/stage1/bin/rustc</code>.</p>



<a name="245856774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245856774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245856774">(Jul 13 2021 at 17:14)</a>:</h4>
<p>haha yeah i forgot to do that because i thought id be fine, since im just using the IR builder items from llvm, not using the actual codegen</p>



<a name="245856802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245856802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245856802">(Jul 13 2021 at 17:14)</a>:</h4>
<p>Now i need to fix this issue of rustc not finding libcore though, pretty odd</p>



<a name="245856960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245856960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245856960">(Jul 13 2021 at 17:15)</a>:</h4>
<p>What does <code>RUSTC_LOG=rustc_metadata</code> give when rustc can't find libcore?</p>



<a name="245857142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857142">(Jul 13 2021 at 17:17)</a>:</h4>
<p>oh why didnt i think of logging that lol</p>



<a name="245857160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857160">(Jul 13 2021 at 17:17)</a>:</h4>
<div class="codehilite"><pre><span></span><code>   Compiling cuda_test v0.1.0 (C:\Users\caval\Documents\Github\cuda_test)
warning: some trace filter directives would enable traces that are disabled statically
 | `rustc_metadata=trace` would enable the TRACE level for the `rustc_metadata` target
 = note: the static max level is `info`
 = help: to enable DEBUG logging, remove the `max_level_info` feature
INFO rustc_metadata::creader resolving crate `core`
INFO rustc_metadata::creader falling back to a load
INFO rustc_metadata::locator rlib reading metadata from: \\?\C:\Users\caval\Documents\Github\cuda_test\target\nvptx64-nvidia-cuda\debug\deps\libcore-bd9e89878f1cb465.rlib
WARN rustc_metadata::locator no metadata found: failed to parse rlib &#39;\\?\C:\Users\caval\Documents\Github\cuda_test\target\nvptx64-nvidia-cuda\debug\deps\libcore-bd9e89878f1cb465.rlib&#39;: Unsupported archive identifier
INFO rustc_metadata::locator rlib reading metadata from: \\?\C:\Users\caval\Documents\Github\cuda_test\target\nvptx64-nvidia-cuda\debug\deps\libcore-bd9e89878f1cb465.rlib
WARN rustc_metadata::locator no metadata found: failed to parse rlib &#39;\\?\C:\Users\caval\Documents\Github\cuda_test\target\nvptx64-nvidia-cuda\debug\deps\libcore-bd9e89878f1cb465.rlib&#39;: Unsupported archive identifier
INFO rustc_metadata::creader resolving crate `core`
INFO rustc_metadata::creader falling back to a load
INFO rustc_metadata::locator rlib reading metadata from: \\?\C:\Users\caval\Documents\Github\cuda_test\target\nvptx64-nvidia-cuda\debug\deps\libcore-bd9e89878f1cb465.rlib
WARN rustc_metadata::locator no metadata found: failed to parse rlib &#39;\\?\C:\Users\caval\Documents\Github\cuda_test\target\nvptx64-nvidia-cuda\debug\deps\libcore-bd9e89878f1cb465.rlib&#39;: Unsupported archive identifier
INFO rustc_metadata::locator rlib reading metadata from: \\?\C:\Users\caval\Documents\Github\cuda_test\target\nvptx64-nvidia-cuda\debug\deps\libcore-bd9e89878f1cb465.rlib
WARN rustc_metadata::locator no metadata found: failed to parse rlib &#39;\\?\C:\Users\caval\Documents\Github\cuda_test\target\nvptx64-nvidia-cuda\debug\deps\libcore-bd9e89878f1cb465.rlib&#39;: Unsupported archive identifier
error[E0463]: can&#39;t find crate for `core`
  |
  = note: the `nvptx64-nvidia-cuda` target may not be installed
  = help: consider downloading the target with `rustup target add nvptx64-nvidia-cuda`
  = help: consider building the standard library from source with `cargo build -Zbuild-std`
</code></pre></div>



<a name="245857227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857227">(Jul 13 2021 at 17:17)</a>:</h4>
<p>uh is it expecting a metadata rlib? i remember handling that but maybe i forgot it somewhere</p>



<a name="245857383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857383">(Jul 13 2021 at 17:18)</a>:</h4>
<p>What format is used for rlibs by your backend? (<code>ArchiveBuilder</code>) Does the <code>object</code> crate support it?</p>



<a name="245857478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857478">(Jul 13 2021 at 17:19)</a>:</h4>
<p>im kind of confused on what rlibs in this case are, arent rlibs just mir dumps? or am i confusing them with something else</p>



<a name="245857522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857522">(Jul 13 2021 at 17:19)</a>:</h4>
<p>Rlibs contain crate metadata and compiled object files.</p>



<a name="245857523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857523">(Jul 13 2021 at 17:19)</a>:</h4>
<p>i use tar to package the rlibs, my modules are llvm bitcode modules</p>



<a name="245857585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857585">(Jul 13 2021 at 17:20)</a>:</h4>
<p>then yes they are metadata + llvm bitcode</p>



<a name="245857628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857628">(Jul 13 2021 at 17:20)</a>:</h4>
<p>and i use tar to archive everything</p>



<a name="245857640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857640">(Jul 13 2021 at 17:20)</a>:</h4>
<p>same method rust-gpu uses</p>



<a name="245857664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857664">(Jul 13 2021 at 17:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/segfault.20from.20compiling.20core.20with.20custom.20codegen/near/245857523">said</a>:</p>
<blockquote>
<p>i use tar to package the rlibs, my modules are llvm bitcode modules</p>
</blockquote>
<p>Then you need to use a <code>MetadataLoader</code> that supports tar archives. The default one only supports ar archives.</p>



<a name="245857723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857723">(Jul 13 2021 at 17:21)</a>:</h4>
<p>s/use/write</p>



<a name="245857727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857727">(Jul 13 2021 at 17:21)</a>:</h4>
<p>oh i remember that haha, it was one of the first things i handled in the codegen and wasnt sure what it did <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="245857746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857746">(Jul 13 2021 at 17:21)</a>:</h4>
<p>yeah that makes sense</p>



<a name="245857959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245857959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245857959">(Jul 13 2021 at 17:22)</a>:</h4>
<p>so are rlibs that store mir and rlibs that store obj files different things or are they the same thing at different stages of compilation?</p>



<a name="245858175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245858175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245858175">(Jul 13 2021 at 17:24)</a>:</h4>
<p>because i knew about rlibs that store mir, cause thats how rustc gets type info from dependencies, but then got kind of confused because they were later referred to in the codegen as files that store object files <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="245859830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245859830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245859830">(Jul 13 2021 at 17:35)</a>:</h4>
<p>Rlibs store both. The crate metadata contains MIR for generic, <code>#[inline]</code> and <code>const</code> functions. The crate metadata also contains all other information necessary to compile against a crate. In addition to the crate metadata rlibs contain object files and or bitcode files. (both by default. only object when using <code>-Cembed-bitcode=no</code> and only bitcode when using <code>-Clto</code>)</p>



<a name="245859994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245859994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245859994">(Jul 13 2021 at 17:36)</a>:</h4>
<p>Ah ok, so its only the mir thats strictly required</p>



<a name="245860098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245860098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245860098">(Jul 13 2021 at 17:37)</a>:</h4>
<p>now it works and it can find core <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="245860132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245860132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245860132">(Jul 13 2021 at 17:38)</a>:</h4>
<p>surprisingly, core and friends build completely fine</p>



<a name="245860223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245860223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245860223">(Jul 13 2021 at 17:38)</a>:</h4>
<p>now i just need to add some special attributes for adding nvvm annotations for kernels and ill be able to compile rust code as a gpu kernel <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="245860438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/%E2%9C%94%20segfault%20from%20compiling%20core%20with%20custom%20codegen/near/245860438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/.E2.9C.94.20segfault.20from.20compiling.20core.20with.20custom.20codegen.html#245860438">(Jul 13 2021 at 17:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="276242">Riccardo D'Ambrosio</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>