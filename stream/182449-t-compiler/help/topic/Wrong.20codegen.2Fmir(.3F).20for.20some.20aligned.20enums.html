<html>
<head><meta charset="utf-8"><title>Wrong codegen/mir(?) for some aligned enums · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html">Wrong codegen/mir(?) for some aligned enums</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267614014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Wrong%20codegen/mir%28%3F%29%20for%20some%20aligned%20enums/near/267614014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html#267614014">(Jan 11 2022 at 17:15)</a>:</h4>
<p>Hi, I been after the issue <a href="https://github.com/rust-lang/rust/issues/92464">#92464</a> for quite some time now as a new contributor this was a quite issue to trying to solve. What I have been able to find is these:<br>
It crashes while trying to optimize  <code>ConstProp</code> which starts <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_mir_transform/const_prop.rs.html#72-161">here</a> , after following this function which hops around a lot.<br>
I think crash happens because of this  <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_const_eval/interpret/operand.rs.html#492-519">function</a> as the program doesn't move beyond <a href="https://doc.rust-lang.org/nightly/nightly-rustc/src/rustc_const_eval/interpret/step.rs.html#298-301">this</a> place.</p>
<p>I got <code>OpTy</code> of the two code that posted in the thread one that compiles and one that crashes its <a href="https://www.textcompare.org/?id=61ddb342665908001322a082">here</a> .<br>
What seems weird to me is that first change appears when <code>abi</code> of these programs get assigned to <code>Scalar</code> and <code>Aggregate</code> then after few more loops whole <code>Layout</code> and then <code>OpTy</code> changes. I was not able to find which function assigns this <code>abi</code> then I lost my way around compiler and got confused so I am asking here for some enlightenment <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<a name="267696441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Wrong%20codegen/mir%28%3F%29%20for%20some%20aligned%20enums/near/267696441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html#267696441">(Jan 12 2022 at 08:54)</a>:</h4>
<p>Which line exactly causes the error? Is it <code> let src = self.eval_operand(operand, None)?;</code> ?</p>



<a name="267701316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Wrong%20codegen/mir%28%3F%29%20for%20some%20aligned%20enums/near/267701316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html#267701316">(Jan 12 2022 at 09:41)</a>:</h4>
<p>Yes that line</p>



<a name="267727245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Wrong%20codegen/mir%28%3F%29%20for%20some%20aligned%20enums/near/267727245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html#267727245">(Jan 12 2022 at 13:57)</a>:</h4>
<p>I don't think this issue is a great first issue for a new contributor, and i don't know what work you've done to find the source of the bug, but I would start by getting the stack trace to figure out what the call stack that leads to the illegal <code>read_immediate</code> is</p>



<a name="267728285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Wrong%20codegen/mir%28%3F%29%20for%20some%20aligned%20enums/near/267728285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html#267728285">(Jan 12 2022 at 14:04)</a>:</h4>
<p>unfortunately the interesting bit of the callstack is lost</p>



<a name="267728324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Wrong%20codegen/mir%28%3F%29%20for%20some%20aligned%20enums/near/267728324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html#267728324">(Jan 12 2022 at 14:04)</a>:</h4>
<p>im not sure how <code>eval_operand</code> reaches down and calls <code>read_immediate</code></p>



<a name="267728588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Wrong%20codegen/mir%28%3F%29%20for%20some%20aligned%20enums/near/267728588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html#267728588">(Jan 12 2022 at 14:06)</a>:</h4>
<p>reading over it some more, this seems like it requires a rather subtle understanding of the layout machinery to solve. you may find a better issue looking through: <a href="https://github.com/rust-lang/rust/issues?q=is%3Aopen+is%3Aissue+label%3AE-help-wanted">https://github.com/rust-lang/rust/issues?q=is%3Aopen+is%3Aissue+label%3AE-help-wanted</a></p>



<a name="267730683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Wrong%20codegen/mir%28%3F%29%20for%20some%20aligned%20enums/near/267730683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html#267730683">(Jan 12 2022 at 14:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="312719">Xavier Denis</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Wrong.20codegen.2Fmir.28.3F.29.20for.20some.20aligned.20enums/near/267727245">said</a>:</p>
<blockquote>
<p>I don't think this issue is a great first issue for a new contributor, and i don't know what work you've done to find the source of the bug, but I would start by getting the stack trace to figure out what the call stack that leads to the illegal <code>read_immediate</code> is</p>
</blockquote>
<p>I spent so much time on it giving up here would be waste <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> yeah somewhere along the compiler Layout starts being wrong and program ICEs</p>



<a name="267731690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Wrong%20codegen/mir%28%3F%29%20for%20some%20aligned%20enums/near/267731690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html#267731690">(Jan 12 2022 at 14:29)</a>:</h4>
<p>I understand that it's frustrating after spending time, but I think there's a ways to go before coming out at the other end of this ICE. You may find it more stimulating to knock out several smaller issues and at the same time gain a better understanding of compiler internals and its compilation model.</p>



<a name="267732449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Wrong%20codegen/mir%28%3F%29%20for%20some%20aligned%20enums/near/267732449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html#267732449">(Jan 12 2022 at 14:35)</a>:</h4>
<p>Yes its kinda frustrating I am always on the lookout for simpler ICE issues they are either too hard or get fixed before I could barge in <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> . Thanks for the advice!</p>



<a name="267732747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Wrong%20codegen/mir%28%3F%29%20for%20some%20aligned%20enums/near/267732747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Wrong.20codegen.2Fmir(.3F).20for.20some.20aligned.20enums.html#267732747">(Jan 12 2022 at 14:37)</a>:</h4>
<p>Though I think chipping away one ICE for some time rewards in a way smaller issues couldn't <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> so I will see how it goes.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>