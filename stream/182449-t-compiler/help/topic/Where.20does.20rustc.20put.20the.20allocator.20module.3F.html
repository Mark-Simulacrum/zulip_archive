<html>
<head><meta charset="utf-8"><title>Where does rustc put the allocator module? · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html">Where does rustc put the allocator module?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253457704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253457704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253457704">(Sep 15 2021 at 17:46)</a>:</h4>
<p>Running into a small issue trying to get my codegen to build crates with an allocator, the final ptx ends up having an unresolved extern function <code>__rust_alloc</code> and <code>__rust_realloc</code>, and more. These are supposed to be created by codegen_allocator, which ive verified does in fact run, but for some odd reason, i cannot find the definitions for those functions anywhere during linking. Emitting llvm ir, the definitions are not found anywhere in the IR emitted. </p>
<p>The way rustc seems to do allocator stuff is odd, because it forms a very irregular dependency graph, where a dependency is able to depend on a function defined in a dependent, which didn't really work with my method of lazily loading functions from dependencies. So i have resorted to using llvm.used to tell llvm/libnvvm to keep around things like rust_begin_panic and __rg methods. However, i can't seem to sort out the allocator functions, they seem to just be kind of gone, and trying to trace where the module is put through cg_ssa is a bit hard because cg_ssa sends it through random channels <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="253458711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253458711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253458711">(Sep 15 2021 at 17:52)</a>:</h4>
<p>You can have a look at <a href="https://github.com/rust-lang/rust/issues/86844">#86844</a></p>



<a name="253458821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253458821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253458821">(Sep 15 2021 at 17:53)</a>:</h4>
<p>These are currently automagically generated by the backend, but <a href="https://github.com/rust-lang/rust/issues/86844">#86844</a> tries to change that so that #[global_allocator] generates these instead</p>



<a name="253459015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253459015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253459015">(Sep 15 2021 at 17:54)</a>:</h4>
<p>yeah that would be much better than the current system of making a random cgu module for allocator</p>



<a name="253459270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253459270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253459270">(Sep 15 2021 at 17:55)</a>:</h4>
<p>But i find it odd that the allocator module is just straight gone, either cg_ssa is doing some very odd things and bypassing the expected pipeline for modules, or... im not quite sure</p>



<a name="253460112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253460112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253460112">(Sep 15 2021 at 18:00)</a>:</h4>
<p>I presume maybe cg_ssa implicitly wants you to find it somewhere? because i am currently only loading rlibs and the object files (which are in reality llvm bitcode files) when linking</p>



<a name="253476071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476071">(Sep 15 2021 at 19:46)</a>:</h4>
<p>The allocator shim is only created for bin, cdylib and dylib's.</p>



<a name="253476084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476084">(Sep 15 2021 at 19:46)</a>:</h4>
<p>Rlibs don't need the allocator shim as they are not directly linked.</p>



<a name="253476304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476304">(Sep 15 2021 at 19:48)</a>:</h4>
<p>Note that <code>--emit obj</code> never gives the allocator shim. It can only output a single object file, but the allocator shim has to be in a different object file from the main crate code for multiple crate types at the same time to work.</p>



<a name="253476385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476385">(Sep 15 2021 at 19:48)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span></p>



<a name="253476451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476451">(Sep 15 2021 at 19:49)</a>:</h4>
<p>hmmm, i currently compile the gpu crates as cdylib</p>



<a name="253476516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476516">(Sep 15 2021 at 19:49)</a>:</h4>
<p>So where is the shim? Like where does rustc get it? Or should i make my own shim and link it in?</p>



<a name="253476518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476518">(Sep 15 2021 at 19:49)</a>:</h4>
<p>Then <code>CodegenResults</code> should contain the path to the allocator shim in one of it's fields.</p>



<a name="253476600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476600">(Sep 15 2021 at 19:50)</a>:</h4>
<p>Oh ok, im not at my desk rn but ill check that out later</p>



<a name="253476609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476609">(Sep 15 2021 at 19:50)</a>:</h4>
<p>The shim is produced by the codegen backend and passed to the linking code using said field in <code>CodegenResults</code>.</p>



<a name="253476643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476643">(Sep 15 2021 at 19:50)</a>:</h4>
<p>What format should it be, just llvm ir like everything else?</p>



<a name="253476781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476781">(Sep 15 2021 at 19:51)</a>:</h4>
<p>Presumably it would call codegen crate or something and treat it like a normal module, although the type will prob give hints, but i cant see it rn</p>



<a name="253476783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476783">(Sep 15 2021 at 19:52)</a>:</h4>
<p>Yes, whatever format the linker requires.</p>



<a name="253476857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476857">(Sep 15 2021 at 19:52)</a>:</h4>
<p>Alright that sounds good</p>



<a name="253476887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476887">(Sep 15 2021 at 19:52)</a>:</h4>
<p>Whats like, the point of it though? If __rg already exists</p>



<a name="253476926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476926">(Sep 15 2021 at 19:52)</a>:</h4>
<p>Is it just so you dont have to distinguish between __rg and __rgl?</p>



<a name="253476945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253476945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253476945">(Sep 15 2021 at 19:53)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_llvm/src/allocator.rs">https://github.com/rust-lang/rust/blob/master/compiler/rustc_codegen_llvm/src/allocator.rs</a></p>



<a name="253477016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477016">(Sep 15 2021 at 19:53)</a>:</h4>
<p>Right thats mostly what i use in my codegen too, but i still dont see why rustc couldnt do this for you</p>



<a name="253477161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477161">(Sep 15 2021 at 19:54)</a>:</h4>
<p>The thing is that the global allocator may either be defined by libstd or by a <code>#[global_allocator]</code>. We don't know in advance until we are producing the bin, cdylib or dylib. So we need a generic __rust_alloc to reference before we know if it should dispatch to __rg_alloc or __rdl_alloc.</p>



<a name="253477187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477187">(Sep 15 2021 at 19:54)</a>:</h4>
<p>And other than rust_begin_panic, rust_oom, and the __rust/__rg functions, are there any others i should be aware about that i should put in llvm.used?</p>



<a name="253477203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477203">(Sep 15 2021 at 19:54)</a>:</h4>
<p>Oh ok</p>



<a name="253477267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477267">(Sep 15 2021 at 19:55)</a>:</h4>
<p>Or actually, i might just mark anything that isnt mangled as used, that should work much better</p>



<a name="253477276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477276">(Sep 15 2021 at 19:55)</a>:</h4>
<p>You don't have to put them in llvm.used. You just need to export them.</p>



<a name="253477314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477314">(Sep 15 2021 at 19:55)</a>:</h4>
<p>That doesnt quite work here though, because i lazy load the modules using the dep graph :/</p>



<a name="253477379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477379">(Sep 15 2021 at 19:56)</a>:</h4>
<p>So a module being loaded only loads the functions used by previous loaded modules</p>



<a name="253477444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477444">(Sep 15 2021 at 19:56)</a>:</h4>
<p>So if the main crate doesnt use __rust_alloc, then it wont be loaded, but a downstream dep might use it</p>



<a name="253477467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477467">(Sep 15 2021 at 19:56)</a>:</h4>
<p>Same problem with rust_begin_panic</p>



<a name="253477515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477515">(Sep 15 2021 at 19:57)</a>:</h4>
<p>Because core uses it, but nvvm doesnt know this when i am loading the crate with the panic handler</p>



<a name="253477532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477532">(Sep 15 2021 at 19:57)</a>:</h4>
<p>Right, in that case you need to load all <code>#[no_mangle]</code> and lang items I think.</p>



<a name="253477583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477583">(Sep 15 2021 at 19:57)</a>:</h4>
<p>How do i know something is a lang item?</p>



<a name="253477591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477591">(Sep 15 2021 at 19:57)</a>:</h4>
<p>s/lang items/weak lang items</p>



<a name="253477715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477715">(Sep 15 2021 at 19:58)</a>:</h4>
<p>wym?</p>



<a name="253477962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253477962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253477962">(Sep 15 2021 at 20:00)</a>:</h4>
<p>A weak lang item is one which can be used before it is defined by another crate. For example the panic handler. Normal lang items must be defined by a dependency before they can be used.</p>



<a name="253478056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478056">(Sep 15 2021 at 20:00)</a>:</h4>
<p>You can iterate over all lang items like in <a href="https://github.com/rust-lang/rust/blob/e2750baf53aaa60db95f10759f6cf9463dc5a6bd/compiler/rustc_codegen_ssa/src/base.rs#L862">https://github.com/rust-lang/rust/blob/e2750baf53aaa60db95f10759f6cf9463dc5a6bd/compiler/rustc_codegen_ssa/src/base.rs#L862</a></p>



<a name="253478072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478072">(Sep 15 2021 at 20:00)</a>:</h4>
<p>Ah ok, do u mean i should put things with weak linkage in used?</p>



<a name="253478099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478099">(Sep 15 2021 at 20:01)</a>:</h4>
<p>Oh awesome</p>



<a name="253478159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478159">(Sep 15 2021 at 20:01)</a>:</h4>
<p>Thanks <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="253478232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478232">(Sep 15 2021 at 20:01)</a>:</h4>
<p>No, weak lang items don't have weak linkage.</p>



<a name="253478336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478336">(Sep 15 2021 at 20:02)</a>:</h4>
<p>They still need to be defined. The only difference is that they can be defined by any crate, not just dependencies of the crate that needs them.</p>



<a name="253478397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478397">(Sep 15 2021 at 20:02)</a>:</h4>
<p>also, to know if i am compiling the “main” crate, does LOCAL_CRATE have a “correct” value when compiling in the backend?</p>



<a name="253478493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478493">(Sep 15 2021 at 20:03)</a>:</h4>
<p>Yes, <code>LOCAL_CRATE</code> refers to the "main" crate in that case.</p>



<a name="253478506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478506">(Sep 15 2021 at 20:03)</a>:</h4>
<p>sounds good</p>



<a name="253478522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478522">(Sep 15 2021 at 20:03)</a>:</h4>
<p>Thanks for ur help again <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="253478538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478538">(Sep 15 2021 at 20:03)</a>:</h4>
<p>no problem</p>



<a name="253478596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Where%20does%20rustc%20put%20the%20allocator%20module%3F/near/253478596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Where.20does.20rustc.20put.20the.20allocator.20module.3F.html#253478596">(Sep 15 2021 at 20:04)</a>:</h4>
<p>Ill see if i can finally get gpu panics to work… thankfully cuda’s printing function is atomic 😅</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>