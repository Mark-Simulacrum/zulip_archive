<html>
<head><meta charset="utf-8"><title>Arenas · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html">Arenas</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261572500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261572500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261572500">(Nov 15 2021 at 22:55)</a>:</h4>
<p>I'm looking at arena code, particularly <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_arena/src/lib.rs#L654-L667">https://github.com/rust-lang/rust/blob/master/compiler/rustc_arena/src/lib.rs#L654-L667</a>.</p>
<p>I think that means you can arena-allocate any type that impls <code>Copy</code>, and it'll be put into a <code>DroplessArena</code>. Does <code>Copy</code>always imply <code>!std::mem::needs_drop</code>?</p>



<a name="261572836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261572836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261572836">(Nov 15 2021 at 22:56)</a>:</h4>
<p>Copy always means !Drop, but not necessarily !std::mem::needs_drop because the latter is allowed to return true when it's not the case.</p>



<a name="261572922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261572922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261572922">(Nov 15 2021 at 22:57)</a>:</h4>
<p><a href="https://doc.rust-lang.org/std/ops/trait.Drop.html#copy-and-drop-are-exclusive">https://doc.rust-lang.org/std/ops/trait.Drop.html#copy-and-drop-are-exclusive</a></p>



<a name="261573448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261573448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261573448">(Nov 15 2021 at 23:02)</a>:</h4>
<p>Makes sense, thanks!</p>



<a name="261576862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261576862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261576862">(Nov 15 2021 at 23:36)</a>:</h4>
<p><code>TypedArena</code> allocates the normal way: in chunks, from start to end.</p>



<a name="261576871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261576871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261576871">(Nov 15 2021 at 23:36)</a>:</h4>
<p><code>DroplessArena</code> allocates in chunks from the chunk end backwards to the start(!)</p>



<a name="261576995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261576995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261576995">(Nov 15 2021 at 23:38)</a>:</h4>
<p>For no obvious reason. I wonder if going backwards could hurt performance... IIRC CPUs tend to be happier with forward access patterns in memory, e.g. prefetching</p>



<a name="261577909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261577909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261577909">(Nov 15 2021 at 23:49)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> Current CPU prefetchers can be remarkably good at both, but nonetheless it's worth trying to see if forwards gives any improvement.</p>



<a name="261577992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261577992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261577992">(Nov 15 2021 at 23:50)</a>:</h4>
<p>Thanks for the info. If nothing else, going forward is the obvious thing to do, so should be chosen to minimize surprises unless there's a compelling reason not to <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="261578619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261578619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261578619">(Nov 15 2021 at 23:56)</a>:</h4>
<p>it's better from an instructions perspective to go back, IIRC</p>



<a name="261578625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261578625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261578625">(Nov 15 2021 at 23:57)</a>:</h4>
<p><a href="https://github.com/fitzgen/bumpalo/commit/2f33d058e0d560e105e960d828a03b0cb2c792e9">https://github.com/fitzgen/bumpalo/commit/2f33d058e0d560e105e960d828a03b0cb2c792e9</a></p>



<a name="261578650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261578650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261578650">(Nov 15 2021 at 23:57)</a>:</h4>
<p>this has a pretty good explanation why bumping backwards can be better.</p>



<a name="261578751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261578751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261578751">(Nov 15 2021 at 23:58)</a>:</h4>
<p>heh, was looking for <a href="https://fitzgeraldnick.com/2019/11/01/always-bump-downwards.html">https://fitzgeraldnick.com/2019/11/01/always-bump-downwards.html</a> myself :)</p>



<a name="261578856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261578856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261578856">(Nov 15 2021 at 23:59)</a>:</h4>
<p>Oh, interesting!</p>



<a name="261578882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261578882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261578882">(Nov 15 2021 at 23:59)</a>:</h4>
<p>That sounds like an argument to try going backwards in <code>TypedArena</code> to see if it goes faster.</p>



<a name="261579216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261579216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261579216">(Nov 16 2021 at 00:01)</a>:</h4>
<p>TypedArena only allocates fixed size objects, right? In that case you don't need aligning if you ensure that the allocation size is a multiple of the alignment. (computation of this should const fold away I think)</p>



<a name="261580263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261580263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261580263">(Nov 16 2021 at 00:12)</a>:</h4>
<p>Huh, interesting</p>



<a name="261580361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261580361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261580361">(Nov 16 2021 at 00:14)</a>:</h4>
<p>I don't think arena allocation is hot enough in the compiler that the handful of instructions saved by bumping downwards would make much difference. But it's enough justification to leave the downward allocation in place... though I'll add a comment <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="261628734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261628734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261628734">(Nov 16 2021 at 11:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Arenas/near/261572836">said</a>:</p>
<blockquote>
<p>Copy always means !Drop, but not necessarily !std::mem::needs_drop because the latter is allowed to return true when it's not the case.</p>
</blockquote>
<p>The <code>Copy</code> should in fact imply <code>!std::mem::needs_drop</code>. It is a documented guarantee. AFAIK, the implementation does in fact guarantee that.</p>



<a name="261628805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261628805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261628805">(Nov 16 2021 at 11:39)</a>:</h4>
<p><a href="https://doc.rust-lang.org/std/mem/fn.needs_drop.html">https://doc.rust-lang.org/std/mem/fn.needs_drop.html</a></p>
<blockquote>
<p>This is purely an optimization hint, and may be implemented conservatively: it may return true for types that don’t actually need to be dropped. As such always returning true would be a valid implementation of this function.</p>
</blockquote>



<a name="261628881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261628881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261628881">(Nov 16 2021 at 11:40)</a>:</h4>
<p>Ah, sorry I was thinking about the intrinsic:</p>
<blockquote>
<p>Returns true if the actual type given as T requires drop glue; returns false if the actual type provided for T implements Copy.</p>
</blockquote>



<a name="261629004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261629004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261629004">(Nov 16 2021 at 11:42)</a>:</h4>
<p>And </p>
<blockquote>
<p>The stabilized version of this intrinsic is mem::needs_drop.</p>
</blockquote>
<p>Taken together these statements are inconsistent.</p>



<a name="261629213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261629213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261629213">(Nov 16 2021 at 11:45)</a>:</h4>
<p>The intrinsic is the current implementation of <code>std::mem::needs_drop</code>. The implementation may be changed to <code>true</code> according to the docs on <code>std::mem::needs_drop</code>.</p>



<a name="261629398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261629398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261629398">(Nov 16 2021 at 11:47)</a>:</h4>
<p>Wouldn't that break the "stabilized version" promise?</p>



<a name="261629438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261629438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261629438">(Nov 16 2021 at 11:47)</a>:</h4>
<p>It seems meaningless to write that if the function could do something else.</p>



<a name="261647541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261647541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261647541">(Nov 16 2021 at 14:24)</a>:</h4>
<p>The docs explicitly allow it:</p>
<blockquote>
<p>This is purely an optimization hint, and may be implemented conservatively: it may return true for types that don’t actually need to be dropped. As such always returning true would be a valid implementation of this function.</p>
</blockquote>
<p>It would be meaningless for rustc, but it could be a shortcut when implementing an alternative rust compiler, albeit a tiny one.</p>



<a name="261648648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261648648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261648648">(Nov 16 2021 at 14:32)</a>:</h4>
<p>Is that a non-guarantee that's worth preserving, at the expense of people being able to rely on it more?</p>



<a name="261648742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Arenas/near/261648742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Arenas.html#261648742">(Nov 16 2021 at 14:32)</a>:</h4>
<p>It might be worth updating the documentation to guarantee that property, and we could do an FCP to confirm that we want to guarantee it.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>