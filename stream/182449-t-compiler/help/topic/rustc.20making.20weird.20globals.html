<html>
<head><meta charset="utf-8"><title>rustc making weird globals · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc.20making.20weird.20globals.html">rustc making weird globals</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261080893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc%20making%20weird%20globals/near/261080893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc.20making.20weird.20globals.html#261080893">(Nov 11 2021 at 01:23)</a>:</h4>
<p>Hello!<br>
I am running into a weird issue in my rustc CUDA backend, rustc is making some weird globals that are not supported by the OptiX library (hardware raytracing), and i am a bit clueless as to why rustc is doing this. It is making some globals that seem to reference other globals' addresses. This is what it is in LLVM IR:</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="vg">@alloc137</span> <span class="p">=</span> <span class="k">private</span> <span class="k">unnamed_addr</span> <span class="k">constant</span> <span class="p">&lt;{</span> <span class="p">[</span><span class="m">36</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="p">}&gt;</span> <span class="p">&lt;{</span> <span class="p">[</span><span class="m">36</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="k">c</span><span class="s">"crates\5Ckernels\5Csrc\5Crender_kernels.rs"</span> <span class="p">}&gt;,</span> <span class="k">align</span> <span class="m">1</span>
<span class="vg">@alloc138</span> <span class="p">=</span> <span class="k">private</span> <span class="k">unnamed_addr</span> <span class="k">constant</span> <span class="p">&lt;{</span> <span class="kt">i8</span><span class="p">*,</span> <span class="p">[</span><span class="m">16</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="p">}&gt;</span> <span class="p">&lt;{</span> <span class="kt">i8</span><span class="p">*</span> <span class="k">getelementptr</span> <span class="k">inbounds</span> <span class="p">(&lt;{</span> <span class="p">[</span><span class="m">36</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="p">}&gt;,</span> <span class="p">&lt;{</span> <span class="p">[</span><span class="m">36</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="p">}&gt;*</span> <span class="vg">@alloc137</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">0</span><span class="p">,</span> <span class="kt">i32</span> <span class="m">0</span><span class="p">),</span> <span class="p">[</span><span class="m">16</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="k">c</span><span class="s">"$\00\00\00\00\00\00\007\00\00\00\0A\00\00\00"</span> <span class="p">}&gt;,</span> <span class="k">align</span> <span class="m">8</span>
</code></pre></div>
<p>The only use of it seems to be when calling panic code:</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code>  <span class="k">tail</span> <span class="k">call</span> <span class="k">void</span> <span class="vg">@_ZN4core9panicking5panic17ha994e0951cbb3712E</span><span class="p">([</span><span class="m">0</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]*</span> <span class="k">noalias</span> <span class="k">nonnull</span> <span class="k">readonly</span> <span class="k">align</span> <span class="m">1</span> <span class="k">bitcast</span> <span class="p">(&lt;{</span> <span class="p">[</span><span class="m">43</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="p">}&gt;*</span> <span class="vg">@alloc128</span> <span class="k">to</span> <span class="p">[</span><span class="m">0</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]*),</span> <span class="kt">i64</span> <span class="m">43</span><span class="p">,</span> <span class="nv">%"core::panic::Location"</span><span class="p">*</span> <span class="k">noalias</span> <span class="k">readonly</span> <span class="k">align</span> <span class="m">8</span> <span class="k">dereferenceable</span><span class="p">(</span><span class="m">24</span><span class="p">)</span> <span class="k">bitcast</span> <span class="p">(&lt;{</span> <span class="kt">i8</span><span class="p">*,</span> <span class="p">[</span><span class="m">16</span> <span class="k">x</span> <span class="kt">i8</span><span class="p">]</span> <span class="p">}&gt;*</span> <span class="vg">@alloc138</span> <span class="k">to</span> <span class="nv">%"core::panic::Location"</span><span class="p">*))</span>
</code></pre></div>
<p>Why is it going through a second global instead of just using the first global?</p>
<p>Then this gets turned into this PTX by libnvvm:</p>
<div class="codehilite"><pre><span></span><code>.global .align 1 .b8 alloc137[36] = {99, 114, 97, 116, 101, 115, 92, 107, 101, 114, 110, 101, 108, 115, 92, 115, 114, 99, 92, 114, 101, 110, 100, 101, 114, 95, 107, 101, 114, 110, 101, 108, 115, 46, 114, 115};
.global .align 8 .u8 alloc138[24] = {0XFF(generic(alloc137)), 0xFF00(generic(alloc137)), 0xFF0000(generic(alloc137)), 0xFF000000(generic(alloc137)), 0xFF00000000(generic(alloc137)), 0xFF0000000000(generic(alloc137)), 0xFF000000000000(generic(alloc137)), 0xFF00000000000000(generic(alloc137)), 36, 0, 0, 0, 0, 0, 0, 0, 55, 0, 0, 0, 10, 0, 0, 0};
</code></pre></div>
<p>the <code>generic(X)</code> basically just makes a generic addrspace pointer to the specified global, then <code>0X...</code> acts as a bitmask for the given value (the address).</p>
<p>Now, i have no idea why rustc would be needing to make such a global, masking off addresses just seems weird. But this makes the generated ptx code not work with the OptiX library:</p>
<div class="codehilite"><pre><span></span><code>[COMPILE FEEDBACK]: COMPILE ERROR: Invalid PTX input: ptx2llvm-module-001: error: Failed to translate PTX input to LLVM
Invalid pointer cast in array/struct initializer for symbol &quot;alloc138&quot;
Target architecture invalid
</code></pre></div>
<p>This is because OptiX PTX code cannot use PTX symbols as values, so no dynamic dispatch or things like that.</p>
<p>Why exactly is rustc making such a weird global and is there some way of working around it inside my codegen?</p>



<a name="261081143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc%20making%20weird%20globals/near/261081143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc.20making.20weird.20globals.html#261081143">(Nov 11 2021 at 01:26)</a>:</h4>
<p>Oh if i am not mistaken this is a global with the file data as well as other location data. Which would make sense if it is needing to use a pointer. Although this kind of causes an issue.</p>



<a name="261083534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/rustc%20making%20weird%20globals/near/261083534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/rustc.20making.20weird.20globals.html#261083534">(Nov 11 2021 at 02:00)</a>:</h4>
<p>Ok for now, using <code>panic_immediate_abort</code> seems to work, although im not sure if this can be a great permanent solution</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>