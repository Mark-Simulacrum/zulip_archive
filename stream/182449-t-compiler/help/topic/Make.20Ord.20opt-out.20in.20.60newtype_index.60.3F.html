<html>
<head><meta charset="utf-8"><title>Make Ord opt-out in `newtype_index`? · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html">Make Ord opt-out in `newtype_index`?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271218160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271218160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271218160">(Feb 09 2022 at 01:18)</a>:</h4>
<p>cc <span class="user-group-mention" data-user-group-id="3282">@wg-incr-comp</span> <span aria-label="innocent" class="emoji emoji-1f607" role="img" title="innocent">:innocent:</span></p>



<a name="271221104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271221104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271221104">(Feb 09 2022 at 02:01)</a>:</h4>
<p>I would take a look at the logic for <code>ENCODABLE = custom</code></p>



<a name="271221206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271221206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271221206">(Feb 09 2022 at 02:02)</a>:</h4>
<p>but I think that macro is approaching the point where it would be better off as a proc-macro</p>



<a name="271222679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271222679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271222679">(Feb 09 2022 at 02:27)</a>:</h4>
<p>it hurts my head just to look at this code</p>



<a name="271223013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271223013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271223013">(Feb 09 2022 at 02:32)</a>:</h4>
<p>Also this has always bugged me: <a href="https://github.com/rust-lang/rust/issues/93792">https://github.com/rust-lang/rust/issues/93792</a></p>



<a name="271340877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271340877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271340877">(Feb 09 2022 at 20:14)</a>:</h4>
<p>In practical terms, I have no idea how to proceed. I'm even considering just pulling <code>Ord</code>,<code>PartialOrd</code> out of the macro and adding them in manually to the 50 or so places it's used :(</p>



<a name="271344667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271344667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271344667">(Feb 09 2022 at 20:44)</a>:</h4>
<p>I'll take a look at converting that into a proc-macro</p>



<a name="271365334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271365334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271365334">(Feb 09 2022 at 23:49)</a>:</h4>
<p><code>newtype_index!</code> uses <code>#[allow_internal_unstable]</code> which is only available for decl macros.</p>



<a name="271367556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271367556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271367556">(Feb 10 2022 at 00:11)</a>:</h4>
<p>could those specific parts be in decl macros that the proc macro can invoke?</p>



<a name="271378540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271378540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271378540">(Feb 10 2022 at 02:26)</a>:</h4>
<p>Surprisingly, it works for proc macros as well</p>



<a name="271378557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271378557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271378557">(Feb 10 2022 at 02:27)</a>:</h4>
<p>I've got a working proc-macro version locally</p>



<a name="271380129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271380129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271380129">(Feb 10 2022 at 02:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="316352">pierwill</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F/near/271340877">said</a>:</p>
<blockquote>
<p>In practical terms, I have no idea how to proceed. I'm even considering just pulling <code>Ord</code>,<code>PartialOrd</code> out of the macro and adding them in manually to the 50 or so places it's used :(</p>
</blockquote>
<p>Hey, so while I'm glad <span class="user-mention" data-user-id="125294">@Aaron Hill</span> took the reins here, I wanted to just quickly ask: Was the option of making two versions of the original macro ever considered: One that injects the <code>Ord</code>/<code>PartialOrd</code> impls, and a second version that leaves them out? (I guess whether that's a reasonable option depends on how hard it would have been to add the manual impls that <span class="user-mention" data-user-id="316352">@pierwill</span> was referencing.)</p>



<a name="271499959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/271499959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#271499959">(Feb 10 2022 at 21:48)</a>:</h4>
<p>Opened <a href="https://github.com/rust-lang/rust/pull/93878">https://github.com/rust-lang/rust/pull/93878</a></p>



<a name="273359481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273359481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273359481">(Feb 26 2022 at 19:51)</a>:</h4>
<p>I saw this merged! Looking now at how to remove Ord and PartialOrd from LocalExpnId...</p>



<a name="273359553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273359553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273359553">(Feb 26 2022 at 19:53)</a>:</h4>
<p>Any advice <span class="user-mention" data-user-id="125294">@Aaron Hill</span> <span aria-label="laughter tears" class="emoji emoji-1f602" role="img" title="laughter tears">:laughter_tears:</span> <span aria-label="innocent" class="emoji emoji-1f607" role="img" title="innocent">:innocent:</span></p>



<a name="273359706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273359706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273359706">(Feb 26 2022 at 19:56)</a>:</h4>
<p>Is there a way to override this line? <a href="https://github.com/rust-lang/rust/blob/8604ef0878b42c1b89e87d42382319dceef5f01f/compiler/rustc_macros/src/newtype.rs#L155">https://github.com/rust-lang/rust/blob/8604ef0878b42c1b89e87d42382319dceef5f01f/compiler/rustc_macros/src/newtype.rs#L155</a></p>



<a name="273360206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273360206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273360206">(Feb 26 2022 at 20:04)</a>:</h4>
<p>Exactly.</p>



<a name="273360322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273360322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273360322">(Feb 26 2022 at 20:07)</a>:</h4>
<p>Here's what I'm doing now but this feels wrong: <a href="https://github.com/pierwill/rust/commit/91924692169aa265690ba38af904e214e1a73d49">https://github.com/pierwill/rust/commit/91924692169aa265690ba38af904e214e1a73d49</a></p>



<a name="273360336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273360336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273360336">(Feb 26 2022 at 20:07)</a>:</h4>
<p>(Removing Ord from the macro and readding it by hand to everything)</p>



<a name="273360404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273360404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273360404">(Feb 26 2022 at 20:08)</a>:</h4>
<p>Oh wait. Can i just specify certain attributes on LocalExpnId, and the macro will only derive those?</p>



<a name="273360416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273360416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273360416">(Feb 26 2022 at 20:08)</a>:</h4>
<p>Is that what this line does? <a href="https://github.com/rust-lang/rust/blob/8604ef0878b42c1b89e87d42382319dceef5f01f/compiler/rustc_macros/src/newtype.rs#L154">https://github.com/rust-lang/rust/blob/8604ef0878b42c1b89e87d42382319dceef5f01f/compiler/rustc_macros/src/newtype.rs#L154</a></p>



<a name="273360741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273360741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273360741">(Feb 26 2022 at 20:16)</a>:</h4>
<p>This diff</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>rustc_index::newtype_index! {<span class="w"></span>
<span class="w"> </span>    /// A unique ID associated with a macro invocation and expansion.<span class="w"></span>
<span class="gi">+    #[derive(Clone, Copy, PartialEq, Eq, Hash)]</span><span class="w"></span>
<span class="w"> </span>    pub struct LocalExpnId {<span class="w"></span>
<span class="w"> </span>        ENCODABLE = custom<span class="w"></span>
<span class="w"> </span>        DEBUG_FORMAT = "expn{}"<span class="w"></span>
</code></pre></div>
<p>gives </p>
<div class="codehilite"><pre><span></span><code>error[E0119]: conflicting implementations of trait `std::marker::StructuralEq` for type `hygiene::LocalExpnId`
   --&gt; compiler/rustc_span/src/hygiene.rs:84:1
    |
84  |   rustc_index::newtype_index! {
    |   -^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   |
    |  _conflicting implementation for `hygiene::LocalExpnId`
    | |
85  | |     /// A unique ID associated with a macro invocation and expansion.
86  | |     #[derive(Clone, Copy, PartialEq, Eq, Hash)]
    | |                                      -- first implementation here
87  | |     pub struct LocalExpnId {
...   |
90  | |     }
91  | | }
    | | -
    | | |
    | |_in this macro invocation (#1)
    |   in this derive macro expansion (#2)
    |
   ::: /Users/will/repos/rust/compiler/rustc_macros/src/lib.rs:46:1
    |
46  |   pub fn newtype_index(input: TokenStream) -&gt; TokenStream {
    |   ------------------------------------------------------- in this expansion of `rustc_index::newtype_index!` (#1)
    |
   ::: /Users/will/repos/rust/library/core/src/cmp.rs:305:1
    |
305 | / pub macro Eq($item:item) {
306 | |     /* compiler built-in */
307 | | }
    | |_- in this expansion of `#[derive(Eq)]` (#2)

error[E0119]: conflicting implementations of trait `std::cmp::Eq` for type `hygiene::LocalExpnId`
   --&gt; compiler/rustc_span/src/hygiene.rs:84:1
    |
84  |   rustc_index::newtype_index! {
    |   -^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   |
    |  _conflicting implementation for `hygiene::LocalExpnId`
    | |
85  | |     /// A unique ID associated with a macro invocation and expansion.
86  | |     #[derive(Clone, Copy, PartialEq, Eq, Hash)]
    | |                                      -- first implementation here
87  | |     pub struct LocalExpnId {
...   |
90  | |     }
91  | | }
    | | -
    | | |
    | |_in this macro invocation (#1)
    |   in this derive macro expansion (#2)
    |
   ::: /Users/will/repos/rust/compiler/rustc_macros/src/lib.rs:46:1
    |
46  |   pub fn newtype_index(input: TokenStream) -&gt; TokenStream {
    |   ------------------------------------------------------- in this expansion of `rustc_index::newtype_index!` (#1)
    |
   ::: /Users/will/repos/rust/library/core/src/cmp.rs:305:1
    |
305 | / pub macro Eq($item:item) {
306 | |     /* compiler built-in */
307 | | }
    | |_- in this expansion of `#[derive(Eq)]` (#2)

error[E0119]: conflicting implementations of trait `std::marker::StructuralPartialEq` for type `hygiene::LocalExpnId`
   --&gt; compiler/rustc_span/src/hygiene.rs:84:1
    |
84  |   rustc_index::newtype_index! {
    |   -^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   |
    |  _conflicting implementation for `hygiene::LocalExpnId`
    | |
85  | |     /// A unique ID associated with a macro invocation and expansion.
86  | |     #[derive(Clone, Copy, PartialEq, Eq, Hash)]
    | |                           --------- first implementation here
87  | |     pub struct LocalExpnId {
...   |
90  | |     }
91  | | }
    | | -
    | | |
    | |_in this macro invocation (#1)
    |   in this derive macro expansion (#2)
    |
   ::: /Users/will/repos/rust/compiler/rustc_macros/src/lib.rs:46:1
    |
46  |   pub fn newtype_index(input: TokenStream) -&gt; TokenStream {
    |   ------------------------------------------------------- in this expansion of `rustc_index::newtype_index!` (#1)
    |
   ::: /Users/will/repos/rust/library/core/src/cmp.rs:239:1
    |
239 | / pub macro PartialEq($item:item) {
240 | |     /* compiler built-in */
241 | | }
    | |_- in this expansion of `#[derive(PartialEq)]` (#2)

error[E0119]: conflicting implementations of trait `std::cmp::PartialEq` for type `hygiene::LocalExpnId`
   --&gt; compiler/rustc_span/src/hygiene.rs:84:1
    |
84  |   rustc_index::newtype_index! {
    |   -^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   |
    |  _conflicting implementation for `hygiene::LocalExpnId`
    | |
85  | |     /// A unique ID associated with a macro invocation and expansion.
86  | |     #[derive(Clone, Copy, PartialEq, Eq, Hash)]
    | |                           --------- first implementation here
87  | |     pub struct LocalExpnId {
...   |
90  | |     }
91  | | }
    | | -
    | | |
    | |_in this macro invocation (#1)
    |   in this derive macro expansion (#2)
    |
   ::: /Users/will/repos/rust/compiler/rustc_macros/src/lib.rs:46:1
    |
46  |   pub fn newtype_index(input: TokenStream) -&gt; TokenStream {
    |   ------------------------------------------------------- in this expansion of `rustc_index::newtype_index!` (#1)
    |
   ::: /Users/will/repos/rust/library/core/src/cmp.rs:239:1
    |
239 | / pub macro PartialEq($item:item) {
240 | |     /* compiler built-in */
241 | | }
    | |_- in this expansion of `#[derive(PartialEq)]` (#2)

error[E0119]: conflicting implementations of trait `std::clone::Clone` for type `hygiene::LocalExpnId`
   --&gt; compiler/rustc_span/src/hygiene.rs:84:1
    |
84  |   rustc_index::newtype_index! {
    |   -^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   |
    |  _conflicting implementation for `hygiene::LocalExpnId`
    | |
85  | |     /// A unique ID associated with a macro invocation and expansion.
86  | |     #[derive(Clone, Copy, PartialEq, Eq, Hash)]
    | |              ----- first implementation here
87  | |     pub struct LocalExpnId {
...   |
90  | |     }
91  | | }
    | | -
    | | |
    | |_in this macro invocation (#1)
    |   in this derive macro expansion (#2)
    |
   ::: /Users/will/repos/rust/compiler/rustc_macros/src/lib.rs:46:1
    |
46  |   pub fn newtype_index(input: TokenStream) -&gt; TokenStream {
    |   ------------------------------------------------------- in this expansion of `rustc_index::newtype_index!` (#1)
    |
   ::: /Users/will/repos/rust/library/core/src/clone.rs:139:1
    |
139 | / pub macro Clone($item:item) {
140 | |     /* compiler built-in */
141 | | }
    | |_- in this expansion of `#[derive(Clone)]` (#2)

error[E0119]: conflicting implementations of trait `std::hash::Hash` for type `hygiene::LocalExpnId`
   --&gt; compiler/rustc_span/src/hygiene.rs:84:1
    |
84  |   rustc_index::newtype_index! {
    |   -^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   |
    |  _conflicting implementation for `hygiene::LocalExpnId`
    | |
85  | |     /// A unique ID associated with a macro invocation and expansion.
86  | |     #[derive(Clone, Copy, PartialEq, Eq, Hash)]
    | |                                          ---- first implementation here
87  | |     pub struct LocalExpnId {
...   |
90  | |     }
91  | | }
    | | -
    | | |
    | |_in this macro invocation (#1)
    |   in this derive macro expansion (#2)
    |
   ::: /Users/will/repos/rust/compiler/rustc_macros/src/lib.rs:46:1
    |
46  |   pub fn newtype_index(input: TokenStream) -&gt; TokenStream {
    |   ------------------------------------------------------- in this expansion of `rustc_index::newtype_index!` (#1)
    |
   ::: /Users/will/repos/rust/library/core/src/hash/mod.rs:253:5
    |
253 | /     pub macro Hash($item:item) {
254 | |         /* compiler built-in */
255 | |     }
    | |_____- in this expansion of `#[derive(Hash)]` (#2)

error[E0119]: conflicting implementations of trait `std::marker::Copy` for type `hygiene::LocalExpnId`
   --&gt; compiler/rustc_span/src/hygiene.rs:84:1
    |
84  |   rustc_index::newtype_index! {
    |   -^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   |
    |  _conflicting implementation for `hygiene::LocalExpnId`
    | |
85  | |     /// A unique ID associated with a macro invocation and expansion.
86  | |     #[derive(Clone, Copy, PartialEq, Eq, Hash)]
    | |                     ---- first implementation here
87  | |     pub struct LocalExpnId {
...   |
90  | |     }
91  | | }
    | | -
    | | |
    | |_in this macro invocation (#1)
    |   in this derive macro expansion (#2)
    |
   ::: /Users/will/repos/rust/compiler/rustc_macros/src/lib.rs:46:1
    |
46  |   pub fn newtype_index(input: TokenStream) -&gt; TokenStream {
    |   ------------------------------------------------------- in this expansion of `rustc_index::newtype_index!` (#1)
    |
   ::: /Users/will/repos/rust/library/core/src/marker.rs:391:1
    |
391 | / pub macro Copy($item:item) {
392 | |     /* compiler built-in */
393 | | }
    | |_- in this expansion of `#[derive(Copy)]` (#2)

For more information about this error, try `rustc --explain E0119`.
error: could not compile `rustc_span` due to 7 previous errors
warning: build failed, waiting for other jobs to finish...
error: build failed
Build completed unsuccessfully in 0:00:01
</code></pre></div>



<a name="273360826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273360826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273360826">(Feb 26 2022 at 20:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="316352">pierwill</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F/near/273360416">said</a>:</p>
<blockquote>
<p>Is that what this line does? <a href="https://github.com/rust-lang/rust/blob/8604ef0878b42c1b89e87d42382319dceef5f01f/compiler/rustc_macros/src/newtype.rs#L154">https://github.com/rust-lang/rust/blob/8604ef0878b42c1b89e87d42382319dceef5f01f/compiler/rustc_macros/src/newtype.rs#L154</a></p>
</blockquote>
<p>This line reapplies all the attributes that appear before the call to the macro.</p>



<a name="273360848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273360848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273360848">(Feb 26 2022 at 20:19)</a>:</h4>
<p>So there is still no way to opt-out of <code>Ord</code>?</p>



<a name="273360907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273360907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273360907">(Feb 26 2022 at 20:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F/near/271380129">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="316352">pierwill</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F/near/271340877">said</a>:</p>
<blockquote>
<p>In practical terms, I have no idea how to proceed. I'm even considering just pulling <code>Ord</code>,<code>PartialOrd</code> out of the macro and adding them in manually to the 50 or so places it's used :(</p>
</blockquote>
<p>Hey, so while I'm glad <span class="user-mention silent" data-user-id="125294">Aaron Hill</span> took the reins here, I wanted to just quickly ask: Was the option of making two versions of the original macro ever considered: One that injects the <code>Ord</code>/<code>PartialOrd</code> impls, and a second version that leaves them out? (I guess whether that's a reasonable option depends on how hard it would have been to add the manual impls that <span class="user-mention silent" data-user-id="316352">pierwill</span> was referencing.)</p>
</blockquote>
<p>Maybe this is still the way to go: two versions</p>



<a name="273360930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273360930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273360930">(Feb 26 2022 at 20:21)</a>:</h4>
<p>You could add an <code>ORD = None</code> statement (like <code>ENCODABLE = CUSTOM</code> statements in the macro).  If this statement does not appear, you put the <code>derive(PartialOrd, Ord)</code> in the macro.</p>



<a name="273360986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273360986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273360986">(Feb 26 2022 at 20:22)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> I can give that a try</p>



<a name="273361098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273361098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273361098">(Feb 26 2022 at 20:25)</a>:</h4>
<p>Any tips on where to start? Macros totally freak me out. I feel hopeless about ever learning them <span aria-label="anguish" class="emoji emoji-1f62b" role="img" title="anguish">:anguish:</span></p>



<a name="273361166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273361166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273361166">(Feb 26 2022 at 20:27)</a>:</h4>
<p>Although at least now I can read the code lol</p>



<a name="273361497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273361497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273361497">(Feb 26 2022 at 20:33)</a>:</h4>
<p>Something like <a href="https://github.com/pierwill/rust/commit/03ce0f48509d7ee3a13fa46be69638e7fd6f15f4">https://github.com/pierwill/rust/commit/03ce0f48509d7ee3a13fa46be69638e7fd6f15f4</a> ?</p>



<a name="273361509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273361509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273361509">(Feb 26 2022 at 20:33)</a>:</h4>
<p>I have no idea really <span aria-label="rolling on the floor laughing" class="emoji emoji-1f923" role="img" title="rolling on the floor laughing">:rolling_on_the_floor_laughing:</span></p>



<a name="273361727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273361727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273361727">(Feb 26 2022 at 20:38)</a>:</h4>
<p>This might be better</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>        let mut max = None;<span class="w"></span>
<span class="w"> </span>        let mut consts = Vec::new();<span class="w"></span>
<span class="w"> </span>        let mut encodable = true;<span class="w"></span>
<span class="gi">+        let mut ord = true;</span><span class="w"></span>

<span class="w"> </span>        // Parse an optional trailing comma<span class="w"></span>
<span class="w"> </span>        let try_comma = || -&gt; Result&lt;()&gt; {<span class="w"></span>
<span class="gu">@@ -100,6 +101,15 @@ fn parse(input: ParseStream&lt;'_&gt;) -&gt; Result&lt;Self&gt; {</span><span class="w"></span>
<span class="w"> </span>                    continue;<span class="w"></span>
<span class="w"> </span>                }<span class="w"></span>

<span class="gi">+                if body.lookahead1().peek(kw::ORD_IMPL) {</span><span class="w"></span>
<span class="gi">+                    body.parse::&lt;kw::ORD_IMPL&gt;()?;</span><span class="w"></span>
<span class="gi">+                    body.parse::&lt;Token![=]&gt;()?;</span><span class="w"></span>
<span class="gi">+                    body.parse::&lt;kw::custom&gt;()?;</span><span class="w"></span>
<span class="gi">+                    try_comma()?;</span><span class="w"></span>
<span class="gi">+                    ord = true;</span><span class="w"></span>
<span class="gi">+                    continue;</span><span class="w"></span>
<span class="gi">+                }</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>                // We've parsed everything that the user provided, so we're done<span class="w"></span>
<span class="w"> </span>                if body.is_empty() {<span class="w"></span>
<span class="w"> </span>                    break;<span class="w"></span>
<span class="gu">@@ -152,7 +162,7 @@ fn fmt(&amp;self, fmt: &amp;mut ::std::fmt::Formatter&lt;'_&gt;) -&gt; ::std::fmt::Result {</span><span class="w"></span>

<span class="w"> </span>        Ok(Self(quote! {<span class="w"></span>
<span class="w"> </span>            #(#attrs)*<span class="w"></span>
<span class="gd">-            #[derive(Clone, Copy, PartialEq, Eq, Hash, PartialOrd, Ord, #(#derive_paths),*)]</span><span class="w"></span>
<span class="gi">+            #[derive(#(#derive_paths),*)]</span><span class="w"></span>
<span class="w"> </span>            #[rustc_layout_scalar_valid_range_end(#max)]<span class="w"></span>
<span class="w"> </span>            #vis struct #name {<span class="w"></span>
<span class="w"> </span>                private: u32,<span class="w"></span>
</code></pre></div>



<a name="273361967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20Ord%20opt-out%20in%20%60newtype_index%60%3F/near/273361967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20Ord.20opt-out.20in.20.60newtype_index.60.3F.html#273361967">(Feb 26 2022 at 20:44)</a>:</h4>
<p>Another attempt: <a href="https://github.com/pierwill/rust/commit/c7aac1f74e2c64b32b63460305a60f03de407781">https://github.com/pierwill/rust/commit/c7aac1f74e2c64b32b63460305a60f03de407781</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>