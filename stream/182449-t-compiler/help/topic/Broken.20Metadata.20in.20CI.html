<html>
<head><meta charset="utf-8"><title>Broken Metadata in CI · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html">Broken Metadata in CI</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272773898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272773898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272773898">(Feb 22 2022 at 08:44)</a>:</h4>
<p>Hi! I'm having a <em>very</em> strange issue, my custom rustc driver is producing invalid metadata for a crate but <em>only</em> in CI. It seems like the type of a function gets changed! I don't do anything that should affect how rustc generates its metadata, nor can I repoduce it locally, but it occurs <em>systematically</em> in CI.</p>



<a name="272774071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272774071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272774071">(Feb 22 2022 at 08:46)</a>:</h4>
<p>The problem manifests as follows, I have a trait like this in a crate:</p>
<div class="codehilite"><pre><span></span><code>pub trait OrdLogic: EqLogic {
    #[logic]
    fn cmp_log(self, _: Self) -&gt; Ordering;

    #[predicate]
    fn le_log(self, o: Self) -&gt; bool {
        pearlite! { !(self.cmp_log(o) === Ordering::Greater) }
    }
}
</code></pre></div>
<p>When my driver compiles the crate it sees the type of <code>cmp_log</code> successfully as <code>fn(Self, Self) -&gt; Ordering</code></p>



<a name="272774127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272774127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272774127">(Feb 22 2022 at 08:47)</a>:</h4>
<p>but when I load that crate in a dependent crate, the type of <code>cmp_log</code> becomes <code>fn(Self, Self) -&gt; fn(Self, Self) -&gt; bool { le_log }</code></p>



<a name="272774146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272774146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272774146">(Feb 22 2022 at 08:47)</a>:</h4>
<p>which, what???</p>



<a name="272774312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272774312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272774312">(Feb 22 2022 at 08:48)</a>:</h4>
<p>I'm aware that given that this is in a custom driver there's probably not a ton external people could do for me, but the fact that this bug is triggered by a seemingly harmless change and can't be reproduced locally is driving me insane</p>



<a name="272784500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272784500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272784500">(Feb 22 2022 at 10:30)</a>:</h4>
<p>Is your CI caching something maybe?</p>



<a name="272799177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272799177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272799177">(Feb 22 2022 at 13:04)</a>:</h4>
<p>I tried clearing the cache, even going so far as to <code>rm</code> everything to no avail</p>



<a name="272799196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272799196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272799196">(Feb 22 2022 at 13:04)</a>:</h4>
<p>and re-ordering the execution of some queries solved the issue...</p>



<a name="272799732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272799732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272799732">(Feb 22 2022 at 13:09)</a>:</h4>
<p>that sounds like you have global state somewhere <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="272799782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272799782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272799782">(Feb 22 2022 at 13:10)</a>:</h4>
<p>(or rustc has, which it does, but it should be mostly fine)</p>



<a name="272799858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272799858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272799858">(Feb 22 2022 at 13:10)</a>:</h4>
<p>could that global state be sccache by any chance?</p>



<a name="272799901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272799901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> matthiaskrgr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272799901">(Feb 22 2022 at 13:11)</a>:</h4>
<p>I had a similar problem recently where stage 1 libstd ICE rustc during build which was solved by wiping sccache and building from scratch <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="272815497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272815497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272815497">(Feb 22 2022 at 15:08)</a>:</h4>
<p>I don't use sccache, to me it sounds like an issue with how metadata is being (de)-serialized</p>



<a name="272815537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272815537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272815537">(Feb 22 2022 at 15:08)</a>:</h4>
<p>it's particularily weird that the malformed type uses the type of the <em>following</em> item in the trait as the return type</p>



<a name="272815555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272815555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272815555">(Feb 22 2022 at 15:09)</a>:</h4>
<p>but what's doubly weird is that this is just normal <code>rustc</code> metadata, ie the result of <code>tcx.type_of(def_id)</code></p>



<a name="272815649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Broken%20Metadata%20in%20CI/near/272815649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Broken.20Metadata.20in.20CI.html#272815649">(Feb 22 2022 at 15:09)</a>:</h4>
<p>So I wonder if i'm not somehow breaking an invariant of rustc..</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>