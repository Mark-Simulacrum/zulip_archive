<html>
<head><meta charset="utf-8"><title>View optimized MIR · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html">View optimized MIR</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265767093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/View%20optimized%20MIR/near/265767093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html#265767093">(Dec 22 2021 at 05:12)</a>:</h4>
<p>This seems simple, but I can't figure out a way to view the optimized MIR on either <a href="http://play.rust-lang.org">play.rust-lang.org</a> or godbolt. Any tips?</p>



<a name="265767166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/View%20optimized%20MIR/near/265767166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html#265767166">(Dec 22 2021 at 05:14)</a>:</h4>
<p>Go to the ... by "Run" and click "MIR"</p>



<a name="265767484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/View%20optimized%20MIR/near/265767484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html#265767484">(Dec 22 2021 at 05:21)</a>:</h4>
<p>Is that post-opt though?</p>



<a name="265767655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/View%20optimized%20MIR/near/265767655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html#265767655">(Dec 22 2021 at 05:25)</a>:</h4>
<p>Yes, just like the LLVM one is post-opt.</p>



<a name="265767776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/View%20optimized%20MIR/near/265767776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html#265767776">(Dec 22 2021 at 05:27)</a>:</h4>
<p>I probably am misunderstanding something then. Here's the source of my confusion:</p>
<p>Take a peek at this playground (taken from <a href="https://github.com/rust-lang/rust/issues/92174">https://github.com/rust-lang/rust/issues/92174</a>): <a href="https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=4ad0b34c54086f780aeed757ac3d411a">https://play.rust-lang.org/?version=stable&amp;mode=release&amp;edition=2021&amp;gist=4ad0b34c54086f780aeed757ac3d411a</a></p>
<p>Set it to <code>Release</code>, and look at the LLVM IR. For the function <code>good</code>, it's a single <code>ret</code>. For the function <code>bad</code>, it's not optimized at all. But if you look at the MIR for each function, they're basically identical.</p>
<p>This made me think that I was seeing the MIR before optimization.</p>



<a name="265768021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/View%20optimized%20MIR/near/265768021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html#265768021">(Dec 22 2021 at 05:32)</a>:</h4>
<p>This was my understanding:</p>
<p>AST<br>
&lt;ast lowering&gt;<br>
HIR<br>
&lt;middle&gt;<br>
MIR<br>
&lt;MIR opt&gt;<br>
Optimized MIR<br>
&lt;codegen&gt;<br>
LLVM IR<br>
Machine code</p>
<p>Is there an LLVM IR optimization step in addition to that? That goes from LLVM IR to more optimized LLVM IR before going to machine code?</p>



<a name="265771067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/View%20optimized%20MIR/near/265771067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html#265771067">(Dec 22 2021 at 06:42)</a>:</h4>
<p>Oh, maybe it's occurring during const evaluation. Is there any option on <code>rustc</code> to spit out the MIR after const evaluation?</p>



<a name="265774708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/View%20optimized%20MIR/near/265774708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hans Kratz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html#265774708">(Dec 22 2021 at 07:48)</a>:</h4>
<p><code>good</code> is optimized to <code>ret</code> in an LLVM optimization, see <a href="https://godbolt.org/z/KWh4da1TM">https://godbolt.org/z/KWh4da1TM</a></p>



<a name="265793886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/View%20optimized%20MIR/near/265793886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html#265793886">(Dec 22 2021 at 11:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="435059">Ben Reeves</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/View.20optimized.20MIR/near/265768021">said</a>:</p>
<blockquote>
<p>Is there an LLVM IR optimization step in addition to that? That goes from LLVM IR to more optimized LLVM IR before going to machine code?</p>
</blockquote>
<p>Yes.  LLVM is multiple steps internally.  First it does LLVM-&gt;LLVM optimizations, and the LLVM you see from <code>--emit=llvm</code> is after those.  Then LLVM-to-machine-code is another step.</p>



<a name="265794070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/View%20optimized%20MIR/near/265794070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html#265794070">(Dec 22 2021 at 11:36)</a>:</h4>
<p>Here's a more direct demonstration of what happens without the LLVM-LLVM level optimizations, but with the MIR ones: <a href="https://godbolt.org/z/xTfa4oE83">https://godbolt.org/z/xTfa4oE83</a></p>



<a name="265794318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/View%20optimized%20MIR/near/265794318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/View.20optimized.20MIR.html#265794318">(Dec 22 2021 at 11:40)</a>:</h4>
<p>There are some bugs that come from which things happen in which step, too -- see &lt;<a href="https://github.com/llvm/llvm-project/issues/52701#issuecomment-994710278">https://github.com/llvm/llvm-project/issues/52701#issuecomment-994710278</a>&gt; for example.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>