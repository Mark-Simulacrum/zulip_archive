<html>
<head><meta charset="utf-8"><title>defpath printing · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html">defpath printing</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254876116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876116">(Sep 25 2021 at 22:38)</a>:</h4>
<p>I'm using -Zself-profile with query keys enabled and it looks like we generate e.g. core::ops::bit::{{impl}}[1000] for defids here.</p>
<p>I have two questions:</p>
<ul>
<li>Is that index stable across compilations? What needs to change inside the crate to alter it, if so? (e.g., does adding any impl change the indexing or just in that module...?)</li>
<li>Can I get a more helpful output than the index?</li>
</ul>



<a name="254876265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876265">(Sep 25 2021 at 22:41)</a>:</h4>
<p>Hm, ok, digging into it it looks like that index comes from <a href="https://github.com/rust-lang/rust/blob/9620f3a84b079decfdc2e557be007580b097fe43/compiler/rustc_hir/src/definitions.rs#L166">https://github.com/rust-lang/rust/blob/9620f3a84b079decfdc2e557be007580b097fe43/compiler/rustc_hir/src/definitions.rs#L166</a></p>



<a name="254876374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876374">(Sep 25 2021 at 22:43)</a>:</h4>
<p>which is set <a href="https://github.com/rust-lang/rust/blob/9620f3a84b079decfdc2e557be007580b097fe43/compiler/rustc_resolve/src/lib.rs#L1213-L1218">https://github.com/rust-lang/rust/blob/9620f3a84b079decfdc2e557be007580b097fe43/compiler/rustc_resolve/src/lib.rs#L1213-L1218</a></p>



<a name="254876388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876388">(Sep 25 2021 at 22:43)</a>:</h4>
<p>not sure what that means for stabiliity</p>



<a name="254876395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876395">(Sep 25 2021 at 22:43)</a>:</h4>
<p>It seems like the parent + defpathdata need to match for the index to incremetn</p>



<a name="254876587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876587">(Sep 25 2021 at 22:46)</a>:</h4>
<p>The index is not stable across compilations, it is sequentially assigned by traversing the AST, in rustc_resolve::def_collector.</p>



<a name="254876618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876618">(Sep 25 2021 at 22:46)</a>:</h4>
<p>However, the DefPathHash is stable, and is used to translate indices from one compilation to another.</p>



<a name="254876703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876703">(Sep 25 2021 at 22:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/defpath.20printing/near/254876587">said</a>:</p>
<blockquote>
<p>The index is not stable across compilations, it is sequentially assigned by traversing the AST, in rustc_resolve::def_collector.</p>
</blockquote>
<p>Hm, shouldn't this be stable on equivalent input?</p>



<a name="254876720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876720">(Sep 25 2021 at 22:48)</a>:</h4>
<p>FWIW I'm trying to figure out what's causing the extra specializes queries here - <a href="https://perf.rust-lang.org/detailed-query.html?commit=67365d64bcdfeae1334bf2ff49587c27d1c973f0&amp;base_commit=30278d3cf92b581550933546370443a5d5700002&amp;benchmark=ctfe-stress-4-check&amp;run_name=full">https://perf.rust-lang.org/detailed-query.html?commit=67365d64bcdfeae1334bf2ff49587c27d1c973f0&amp;base_commit=30278d3cf92b581550933546370443a5d5700002&amp;benchmark=ctfe-stress-4-check&amp;run_name=full</a></p>



<a name="254876723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876723">(Sep 25 2021 at 22:48)</a>:</h4>
<p>The order is deterministic, so it should not change as long as no definition is added anywhere in the crate.</p>



<a name="254876739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876739">(Sep 25 2021 at 22:49)</a>:</h4>
<p>That includes lifetimes and generic parameters.</p>



<a name="254876749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876749">(Sep 25 2021 at 22:49)</a>:</h4>
<p>Aha</p>



<a name="254876754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876754">(Sep 25 2021 at 22:49)</a>:</h4>
<p>so it's crate-dependent?</p>



<a name="254876781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876781">(Sep 25 2021 at 22:49)</a>:</h4>
<p>then it makes some sense, I suppose, that <a href="https://github.com/rust-lang/rust/pull/89139/">https://github.com/rust-lang/rust/pull/89139/</a> made the core::ops::bit impls differ</p>



<a name="254876862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876862">(Sep 25 2021 at 22:50)</a>:</h4>
<p>Yes, a DefId is a compound of a CrateNum and a definition index inside that crate.</p>



<a name="254876934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254876934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254876934">(Sep 25 2021 at 22:52)</a>:</h4>
<p>I suppose you probably don't have a good sense of why that would cause more specializes queries, though, on unrelated(?) impls</p>



<a name="254878235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254878235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254878235">(Sep 25 2021 at 23:14)</a>:</h4>
<p>Sorry, I don't kown anything about specialization</p>



<a name="254908189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/defpath%20printing/near/254908189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/defpath.20printing.html#254908189">(Sep 26 2021 at 07:22)</a>:</h4>
<p>are these new queries from coherence checking ? if that’s the case, maybe comparing the specialization graph for libcore before/after the PR could help pinpoint the cause ?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>