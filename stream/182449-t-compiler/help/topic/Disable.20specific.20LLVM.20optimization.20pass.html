<html>
<head><meta charset="utf-8"><title>Disable specific LLVM optimization pass · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Disable.20specific.20LLVM.20optimization.20pass.html">Disable specific LLVM optimization pass</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258247505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Disable%20specific%20LLVM%20optimization%20pass/near/258247505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sol Boucher <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Disable.20specific.20LLVM.20optimization.20pass.html#258247505">(Oct 19 2021 at 18:22)</a>:</h4>
<p>Is it possible to instruct rustc to skip running a specific LLVM optimization pass?</p>



<a name="258247883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Disable%20specific%20LLVM%20optimization%20pass/near/258247883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sol Boucher <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Disable.20specific.20LLVM.20optimization.20pass.html#258247883">(Oct 19 2021 at 18:25)</a>:</h4>
<p>I have already used <code>-Cllvm-args=-opt-bisect-limit</code> to confirm that the pass I need to skip is <code>-prune-eh</code> ("Remove unused exception handling info"). But it seems that switch can only be used to skip that pass _and all subsequent ones_, not just that pass.</p>



<a name="258264118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Disable%20specific%20LLVM%20optimization%20pass/near/258264118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sol Boucher <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Disable.20specific.20LLVM.20optimization.20pass.html#258264118">(Oct 19 2021 at 20:13)</a>:</h4>
<p>Put another way, is there a way to add the <em>negation</em> of a pass to the list? I want something like <code>-Cpasses=no-prune-eh</code>.</p>



<a name="258273210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Disable%20specific%20LLVM%20optimization%20pass/near/258273210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sol Boucher <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Disable.20specific.20LLVM.20optimization.20pass.html#258273210">(Oct 19 2021 at 21:14)</a>:</h4>
<p>It looks like I can get a list of the arguments to opt by doing <code>rustc -Cllvm-args=-debug-pass=Arguments -Ccodegen-units=1</code>. I would think that I could then iteratively call lib/rustlib/x86_64-unknown-linux-gnu/bin/opt with the provided arguments, omitting the undesirable one. However, the very first invocation fails with the following unrecognized command-line arguments:</p>
<ul>
<li><code>-machinemoduleinfo</code></li>
<li><code>-collector-metadata</code></li>
<li><code>-gc-lowering</code></li>
<li><code>-shadow-stack-gc-lowering</code></li>
<li><code>-finalize-isel</code></li>
<li><code>-localstackalloc</code></li>
</ul>
<p>Is there some shared object I need to <code>-load</code> first?</p>



<a name="258273501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Disable%20specific%20LLVM%20optimization%20pass/near/258273501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Disable.20specific.20LLVM.20optimization.20pass.html#258273501">(Oct 19 2021 at 21:16)</a>:</h4>
<p><code>-debug-pass=Arguments</code> prints machine (llc) passes too</p>



<a name="258273779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Disable%20specific%20LLVM%20optimization%20pass/near/258273779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sol Boucher <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Disable.20specific.20LLVM.20optimization.20pass.html#258273779">(Oct 19 2021 at 21:18)</a>:</h4>
<p>Hmm. The first set isn't accepted by llc either, though. All lines begin with the same label, "Pass arguments:"<br>
Is there any way to tell how they're supposed to be used?</p>



<a name="258274731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Disable%20specific%20LLVM%20optimization%20pass/near/258274731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sol Boucher <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Disable.20specific.20LLVM.20optimization.20pass.html#258274731">(Oct 19 2021 at 21:23)</a>:</h4>
<p>I guess I can just skip any sets of arguments that opt doesn't accept wholesale...<br>
My idea for getting the original LLVM IR to manually run opt on was to call rustc with <code>-Cno-prepopulate-passes</code>; will that skip non-opt passes, though?</p>



<a name="258278997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Disable%20specific%20LLVM%20optimization%20pass/near/258278997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Disable.20specific.20LLVM.20optimization.20pass.html#258278997">(Oct 19 2021 at 21:56)</a>:</h4>
<p>I just copy all of them arguments and them delete the specific ones that opt complains about.</p>



<a name="258375103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Disable%20specific%20LLVM%20optimization%20pass/near/258375103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sol Boucher <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Disable.20specific.20LLVM.20optimization.20pass.html#258375103">(Oct 20 2021 at 14:12)</a>:</h4>
<p>I'm still confused about this first line of <code>-debug-pass=Arguments</code> output. The opt command doesn't accept them all, but I thought rustc would. But when I do <code>rustc --emit llvm-ir -Cno-prepopulate-passes -Cpasses="tti targetlibinfo targetpassconfig machinemoduleinfo collector-metadata assumption-cache-tracker profile-summary-info machine-branch-prob pre-isel-intrinsic-lowering atomic-expand lower-amx-type verify gc-lowering shadow-stack-gc-lowering lower-constant-intrinsics unreachableblockelim post-inline-ee-instrument scalarize-masked-mem-intrin expand-reductions indirectbr-expand rewrite-symbols dwarfehprepare safe-stack stack-protector verify finalize-isel localstackalloc x86-slh machinedomtree x86-flags-copy-lowering phi-node-elimination twoaddressinstruction regallocfast edge-bundles x86-codegen fixup-statepoint-caller-saved lazy-machine-block-freq machine-opt-remark-emitter prologepilog postrapseudos x86-pseudo gc-analysis fentry-insert xray-instrumentation patchable-function x86-evex-to-vex-compress funclet-layout stackmap-liveness livedebugvalues x86-seses cfi-instr-inserter x86-lvi-ret lazy-machine-block-freq machine-opt-remark-emitter" -O minimal.rs</code>, I get this:<br>
<code>LLVM ERROR: Trying to construct TargetPassConfig without a target machine. Scheduling a CodeGen pass without a target triple set?</code><br>
Any ideas?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>