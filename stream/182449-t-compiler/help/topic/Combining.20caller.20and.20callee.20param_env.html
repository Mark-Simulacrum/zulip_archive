<html>
<head><meta charset="utf-8"><title>Combining caller and callee param_env · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Combining.20caller.20and.20callee.20param_env.html">Combining caller and callee param_env</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264625596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Combining%20caller%20and%20callee%20param_env/near/264625596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Combining.20caller.20and.20callee.20param_env.html#264625596">(Dec 12 2021 at 14:15)</a>:</h4>
<p>I'm trying to fortify the detection of recursive calls for MIR inlining. The current implementation works well for shallow call chains, but ICEs for longer call chains: normalization failure or failure to resolve trait bounds.  Consider <a href="https://godbolt.org/z/bnjGdq15q">https://godbolt.org/z/bnjGdq15q</a>, extracted from <code>rustc_query_system</code>.  The ICE happens when trying find recursive calls in <code>get_query</code>. My understanding is:</p>
<ul>
<li><code>get_query&lt;Q, T&gt;</code> has a param_env which proves the call to <code>try_execute_query&lt;&lt;Q as Query&gt;::C&gt;</code> is well-formed;</li>
<li>the call to <code>mk_cycle</code> is resolved as <code>mk_cycle&lt;&lt;&lt;Q as Query&gt;::C as Cache&gt;::V</code> and normalized to <code>mk_cycle&lt;&lt;Q as Query&gt;::V&gt;</code>;</li>
<li>when attempting to resolve the call to <code>store_nocache</code>, trait selection attempts to verify <code>&lt;&lt;Q as Query&gt;::V as Debug&gt;</code> and fails.</li>
</ul>
<p>One solution would be to keep track of <code>try_execute_query</code> and <code>mk_cycle</code>'s param envs when recursing.  This would introduce the required bound in the param-env for the resolution of <code>store_nocache</code>.  However, this creates duplicated bounds and I'm not confident how to clean-up everything.<br>
Is there a better solution?</p>



<a name="264625728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Combining%20caller%20and%20callee%20param_env/near/264625728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Combining.20caller.20and.20callee.20param_env.html#264625728">(Dec 12 2021 at 14:19)</a>:</h4>
<p>(And duplicate bounds creates another ICE in instance resolution because it's ambiguous.)</p>



<a name="264649722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Combining%20caller%20and%20callee%20param_env/near/264649722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Combining.20caller.20and.20callee.20param_env.html#264649722">(Dec 12 2021 at 23:26)</a>:</h4>
<p>On a related note: what is the role of the <code>delay_span_bug</code> in <code>drain_fulfillment_cx_or_panic</code>?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>