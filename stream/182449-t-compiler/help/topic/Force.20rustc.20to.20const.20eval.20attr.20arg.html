<html>
<head><meta charset="utf-8"><title>Force rustc to const eval attr arg · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Force.20rustc.20to.20const.20eval.20attr.20arg.html">Force rustc to const eval attr arg</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256497998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Force%20rustc%20to%20const%20eval%20attr%20arg/near/256497998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Force.20rustc.20to.20const.20eval.20attr.20arg.html#256497998">(Oct 06 2021 at 23:02)</a>:</h4>
<p>I have a custom codegen backend which needs an internal attribute that is registered by the user. I  want to have something like <code>#[foo(bar(5 + 5))]</code>. Is there a way to force rustc to const eval the value inside <code>bar()</code> from the codegen when codegenning functions?</p>
<p>I know that intrinsic functions that internally force rustc to const eval the arguments exist, but i am not sure thats the best option, and im not sure how to declare one. Help appreciated!</p>



<a name="256498192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Force%20rustc%20to%20const%20eval%20attr%20arg/near/256498192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Force.20rustc.20to.20const.20eval.20attr.20arg.html#256498192">(Oct 06 2021 at 23:04)</a>:</h4>
<p>And note, i need this to be evaluated as a "normal" const expr, as in, all const vars available in scope can be used as normal</p>



<a name="256498969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Force%20rustc%20to%20const%20eval%20attr%20arg/near/256498969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Force.20rustc.20to.20const.20eval.20attr.20arg.html#256498969">(Oct 06 2021 at 23:12)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> macro expansion happens before constant evaluation, so I doubt this is possible. Rustc doesn't even parse anything inside <code>foo(...)</code>, which is how proc macros can have custom syntax.</p>



<a name="256499017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Force%20rustc%20to%20const%20eval%20attr%20arg/near/256499017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Force.20rustc.20to.20const.20eval.20attr.20arg.html#256499017">(Oct 06 2021 at 23:13)</a>:</h4>
<p>Right im thinking that an intrinsic is the only way, but im not sure how to tell rustc to always const eval arguments to a function</p>



<a name="256499030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Force%20rustc%20to%20const%20eval%20attr%20arg/near/256499030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Force.20rustc.20to.20const.20eval.20attr.20arg.html#256499030">(Oct 06 2021 at 23:13)</a>:</h4>
<p>because rustc does it for SIMD intrinsics</p>



<a name="256499172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Force%20rustc%20to%20const%20eval%20attr%20arg/near/256499172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Force.20rustc.20to.20const.20eval.20attr.20arg.html#256499172">(Oct 06 2021 at 23:15)</a>:</h4>
<p>I would have to intercept the call to the intrinsic from the codegen during the builder's call method, then convert the <code>&amp;'ll Value</code> into a constant number value, which would work if rustc codegenned the argument to be a const value</p>



<a name="260679900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Force%20rustc%20to%20const%20eval%20attr%20arg/near/260679900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Force.20rustc.20to.20const.20eval.20attr.20arg.html#260679900">(Nov 08 2021 at 16:17)</a>:</h4>
<p>Perhaps you can extract <code>5 + 5</code> from the attribute, and put that in a <code>const </code> item.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>