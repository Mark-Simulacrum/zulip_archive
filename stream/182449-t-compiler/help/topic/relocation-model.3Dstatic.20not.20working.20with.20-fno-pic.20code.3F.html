<html>
<head><meta charset="utf-8"><title>relocation-model=static not working with -fno-pic code? · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/relocation-model.3Dstatic.20not.20working.20with.20-fno-pic.20code.3F.html">relocation-model=static not working with -fno-pic code?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263741118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/relocation-model%3Dstatic%20not%20working%20with%20-fno-pic%20code%3F/near/263741118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Casey <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/relocation-model.3Dstatic.20not.20working.20with.20-fno-pic.20code.3F.html#263741118">(Dec 05 2021 at 00:58)</a>:</h4>
<p>I have a repro of something I'd expect to link but does not: rust binary using relocation-model=static linking with .a containing -fno-pic code, where the rust code uses serde (proc_macro?). I noticed that relocation-model=dynamic-no-pic does work but it is specifically mentioned in the rustc book not to use this to link against non-pic code. I see this issue on rhel &amp; wsl(ubuntu).<br>
I was hoping to open an issue and also start digging into the issue a bit more but I don't know where to start - is this a cargo thing, or a rustc thing, or something else? Does anyone have any thoughts on where would be a good place to start digging?</p>
<p>Small reproducible example: <a href="https://github.com/adamncasey/rust-static-link-serde">https://github.com/adamncasey/rust-static-link-serde</a><br>
Relevant rustc book docs: <a href="https://doc.rust-lang.org/rustc/codegen-options/index.html#special-relocation-models">https://doc.rust-lang.org/rustc/codegen-options/index.html#special-relocation-models</a></p>



<a name="263756488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/relocation-model%3Dstatic%20not%20working%20with%20-fno-pic%20code%3F/near/263756488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/relocation-model.3Dstatic.20not.20working.20with.20-fno-pic.20code.3F.html#263756488">(Dec 05 2021 at 08:17)</a>:</h4>
<p>You are passing -Crelocation-model to all crates, including the proc macro. The proc macro is a dylib amd thus needs a dynamic relocation model. You can try explicitly specifying a target using --target to avoid rustflags applying to host crates.</p>



<a name="263785377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/relocation-model%3Dstatic%20not%20working%20with%20-fno-pic%20code%3F/near/263785377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Casey <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/relocation-model.3Dstatic.20not.20working.20with.20-fno-pic.20code.3F.html#263785377">(Dec 05 2021 at 19:43)</a>:</h4>
<p>Ah interesting thank you. <code>[build] target = "x86_64-unknown-linux-gnu" rustflags = ["-C", "relocation-model=static"]</code> worked. For my use case it mostly works to pin the target to this platform, but do you think there is/should be a way to specify relocation-model=static just for the bin crate?</p>



<a name="263785444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/relocation-model%3Dstatic%20not%20working%20with%20-fno-pic%20code%3F/near/263785444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/relocation-model.3Dstatic.20not.20working.20with.20-fno-pic.20code.3F.html#263785444">(Dec 05 2021 at 19:45)</a>:</h4>
<p>You can use <code>cargo rustc -- -Crelocation-model=static</code> when compiling. (you may need <code>--bin name_of_binary</code> if there is also a library or multiple binaries in the same package)</p>



<a name="263785474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/relocation-model%3Dstatic%20not%20working%20with%20-fno-pic%20code%3F/near/263785474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/relocation-model.3Dstatic.20not.20working.20with.20-fno-pic.20code.3F.html#263785474">(Dec 05 2021 at 19:45)</a>:</h4>
<p>By the way compiling only the binary with <code>-Crelocation-model=static</code> is not very useful as all dependencies would still use the default relocation model.</p>



<a name="263839540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/relocation-model%3Dstatic%20not%20working%20with%20-fno-pic%20code%3F/near/263839540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Casey <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/relocation-model.3Dstatic.20not.20working.20with.20-fno-pic.20code.3F.html#263839540">(Dec 06 2021 at 11:57)</a>:</h4>
<p>Thanks again - I think I'm getting somewhere. Unfortunately the <code>.cargo/config: build.target, build.rustflags</code> method doesn't work since the place I'm hitting this issue is depending on a crate (hyper) which specifies <code>crate-type = ["lib", "staticlib", "cdylib"]</code> - cargo tries to but cannot build the <code>cdylib</code> with relocation-model=static.</p>
<p><code>cargo rustc -- -Crelocation-model=static</code> is promising and, at least from my perspective, seems more like what I need - I only really care that the final binary is built without PIE since I don't require zero dynamic link dependencies &amp; I'd prefer my build wasn't fragile to an upstream package extending their <code>crate-type</code>. If there was a way I could configure <code>cargo build</code> to pass this to rustc for just my binary I'd be happy :) Thanks again for your help!</p>



<a name="264491677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/relocation-model%3Dstatic%20not%20working%20with%20-fno-pic%20code%3F/near/264491677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/relocation-model.3Dstatic.20not.20working.20with.20-fno-pic.20code.3F.html#264491677">(Dec 10 2021 at 18:51)</a>:</h4>
<p>You can create a <code>.cargo/config</code> alias for this:</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="c1"># .cargo/config</span>
<span class="k">[alias]</span>
<span class="n">build-pie</span> <span class="o">=</span> <span class="p">[</span><span class="s">"rustc"</span><span class="p">,</span> <span class="s">"--"</span><span class="p">,</span> <span class="s">"-Crelocation-model=static"</span><span class="p">]</span> <span class="c1"># Maybe add a `--bin …` target as well</span>
</code></pre></div>
<p>so that <code>cargo build-pie</code> works.</p>



<a name="264491679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/relocation-model%3Dstatic%20not%20working%20with%20-fno-pic%20code%3F/near/264491679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/relocation-model.3Dstatic.20not.20working.20with.20-fno-pic.20code.3F.html#264491679">(Dec 10 2021 at 18:51)</a>:</h4>
<p>Another  (untested!) option, maybe, would be to do something along the lines of:</p>
<ul>
<li>creating a <code>rustc-static-reloc.sh</code>:</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span> -Crelocation-model<span class="o">=</span>static
</code></pre></div>
<ul>
<li>and then doing:</li>
</ul>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nv">RUSTC_WORKSPACE_WRAPPER</span><span class="o">=</span><span class="s2">"path/to/rustc-static-reloc.sh"</span> cargo build …
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>