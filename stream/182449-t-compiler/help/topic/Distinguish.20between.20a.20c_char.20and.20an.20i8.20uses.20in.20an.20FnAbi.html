<html>
<head><meta charset="utf-8"><title>Distinguish between a c_char and an i8 uses in an FnAbi · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Distinguish.20between.20a.20c_char.20and.20an.20i8.20uses.20in.20an.20FnAbi.html">Distinguish between a c_char and an i8 uses in an FnAbi</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276742204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Distinguish%20between%20a%20c_char%20and%20an%20i8%20uses%20in%20an%20FnAbi/near/276742204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ramon de C Valle <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Distinguish.20between.20a.20c_char.20and.20an.20i8.20uses.20in.20an.20FnAbi.html#276742204">(Mar 26 2022 at 19:41)</a>:</h4>
<p>I'm currently working on a couple different type metadata identifier encodings for <a href="https://github.com/rust-lang/rust/issues/89653">https://github.com/rust-lang/rust/issues/89653</a>, and one of these encodings need to be able to distinguish between c_char and i8 uses at the time types are encoded. The types are encoded from a rustc_target::abi::call::FnAbi. Is there a way to identify when a ty:Ty in an FnAbi was used as a c_char type alias instead of directly as an i8?</p>



<a name="276742415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Distinguish%20between%20a%20c_char%20and%20an%20i8%20uses%20in%20an%20FnAbi/near/276742415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Distinguish.20between.20a.20c_char.20and.20an.20i8.20uses.20in.20an.20FnAbi.html#276742415">(Mar 26 2022 at 19:46)</a>:</h4>
<p>If all you have is a <code>Ty</code> I'd be very surprised if that was visible, since there's a number of cases where that kind of distinction is fundamentally lost in inference because it's just a type alias.</p>
<p>Do you have the FnDef or anything for it?</p>



<a name="276742494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Distinguish%20between%20a%20c_char%20and%20an%20i8%20uses%20in%20an%20FnAbi/near/276742494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Distinguish.20between.20a.20c_char.20and.20an.20i8.20uses.20in.20an.20FnAbi.html#276742494">(Mar 26 2022 at 19:48)</a>:</h4>
<p>c_char is defined as alias for i8 or u8 depending on the target. There is exactly zero difference between them after typechecking.</p>



<a name="276742583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Distinguish%20between%20a%20c_char%20and%20an%20i8%20uses%20in%20an%20FnAbi/near/276742583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ramon de C Valle <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Distinguish.20between.20a.20c_char.20and.20an.20i8.20uses.20in.20an.20FnAbi.html#276742583">(Mar 26 2022 at 19:50)</a>:</h4>
<p>The ty::FnDef may be available at the call sites to the function that does the encoding--I need to check all of them.</p>



<a name="276742709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Distinguish%20between%20a%20c_char%20and%20an%20i8%20uses%20in%20an%20FnAbi/near/276742709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ramon de C Valle <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Distinguish.20between.20a.20c_char.20and.20an.20i8.20uses.20in.20an.20FnAbi.html#276742709">(Mar 26 2022 at 19:52)</a>:</h4>
<p>I was able to identify c_void because it's an enum (and thus a ty::Adt that has a name and a crate name). Is there a way to do something similar for c_char? Or maybe add an attribute or mark it somehow?</p>



<a name="276742778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Distinguish%20between%20a%20c_char%20and%20an%20i8%20uses%20in%20an%20FnAbi/near/276742778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Distinguish.20between.20a.20c_char.20and.20an.20i8.20uses.20in.20an.20FnAbi.html#276742778">(Mar 26 2022 at 19:54)</a>:</h4>
<p>No.  Because it's a <em>type alias</em> (as <span class="user-mention silent" data-user-id="133247">bjorn3</span> said), it's fundamentally not a different thing from <code>i8</code> (or <code>u8</code>, depending on platform).</p>



<a name="276742791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Distinguish%20between%20a%20c_char%20and%20an%20i8%20uses%20in%20an%20FnAbi/near/276742791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Distinguish.20between.20a.20c_char.20and.20an.20i8.20uses.20in.20an.20FnAbi.html#276742791">(Mar 26 2022 at 19:54)</a>:</h4>
<p>If it were instead a <em>newtype</em> (like <code>struct c_char(i8);</code>) then it would be possible, but that would also break everything using <code>c_char</code> today.</p>



<a name="276742943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Distinguish%20between%20a%20c_char%20and%20an%20i8%20uses%20in%20an%20FnAbi/near/276742943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ramon de C Valle <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Distinguish.20between.20a.20c_char.20and.20an.20i8.20uses.20in.20an.20FnAbi.html#276742943">(Mar 26 2022 at 19:58)</a>:</h4>
<p>Is there a path from either the ty::FnAbi or ty::FnDef (instead of the ty::Ty) to a higher abstraction level where I can identify it?</p>



<a name="276742968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Distinguish%20between%20a%20c_char%20and%20an%20i8%20uses%20in%20an%20FnAbi/near/276742968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Distinguish.20between.20a.20c_char.20and.20an.20i8.20uses.20in.20an.20FnAbi.html#276742968">(Mar 26 2022 at 20:00)</a>:</h4>
<p>No, if the function is defined in another crate there is absolutely no information left to distinguish them. Only the <code>ty::Ty</code> is encoded in the crate metadata.</p>



<a name="276743574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Distinguish%20between%20a%20c_char%20and%20an%20i8%20uses%20in%20an%20FnAbi/near/276743574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ramon de C Valle <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Distinguish.20between.20a.20c_char.20and.20an.20i8.20uses.20in.20an.20FnAbi.html#276743574">(Mar 26 2022 at 20:12)</a>:</h4>
<p>I'm just thinking about the options: would a transitional new type (i.e., struct c_char(i8)) for use when CFI is enabled and interoperating with foreign code written in C be a viable option? (The reason I'm exploring this encoding is because it'll provide a much more comprehensive protection than the alternative encoding.)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>