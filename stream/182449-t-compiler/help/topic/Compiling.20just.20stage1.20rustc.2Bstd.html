<html>
<head><meta charset="utf-8"><title>Compiling just stage1 rustc+std · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html">Compiling just stage1 rustc+std</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="244095176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/244095176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#244095176">(Jun 28 2021 at 01:47)</a>:</h4>
<p>What's the <code>x.py</code> incantation needed to build just the stage1 rustc and stdlib, not rustdoc, and nothing from stage2?</p>



<a name="244096594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/244096594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#244096594">(Jun 28 2021 at 02:29)</a>:</h4>
<p>I'm pretty sure <code>./x.py build library/std</code> does that (at least, that's what I usually use).</p>



<a name="244099628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/244099628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#244099628">(Jun 28 2021 at 03:56)</a>:</h4>
<p>You might need --stage 1 depending on the profile you're using</p>



<a name="244117317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/244117317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#244117317">(Jun 28 2021 at 08:53)</a>:</h4>
<p>Aah, right, thanks!</p>



<a name="251712984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251712984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251712984">(Sep 02 2021 at 13:18)</a>:</h4>
<p>When I try this, I get: <code>thread 'main' panicked at 'Error: no rules matched library/std.', src/bootstrap/builder.rs:232:21</code>.  My rustc stage 0 at this point is that built by mrustc, if that matters.</p>



<a name="251713169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251713169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251713169">(Sep 02 2021 at 13:19)</a>:</h4>
<p>More context:</p>
<div class="codehilite"><pre><span></span><code>starting phase `build&#39;
   Compiling proc-macro2 v0.4.30
   Compiling unicode-xid v0.1.0
   Compiling syn v0.15.35
   Compiling libc v0.2.64
   Compiling serde v1.0.99
   Compiling ryu v1.0.0
   Compiling cfg-if v0.1.8
   Compiling cc v1.0.37
   Compiling unicode-width v0.1.6
   Compiling fixedbitset v0.1.9
   Compiling itoa v0.4.4
   Compiling ordermap v0.3.5
   Compiling build_helper v0.1.0 (/tmp/guix-build-rust-1.40.0.drv-0/rustc-1.40.0-src/src/build_helper)
   Compiling lazy_static v1.3.0
   Compiling getopts v0.2.21
   Compiling petgraph v0.4.13
   Compiling cmake v0.1.38
   Compiling quote v0.6.12
   Compiling num_cpus v1.8.0
   Compiling time v0.1.40
   Compiling filetime v0.2.4
   Compiling serde_derive v1.0.81
   Compiling toml v0.5.3
   Compiling serde_json v1.0.40
   Compiling bootstrap v0.0.0 (/tmp/guix-build-rust-1.40.0.drv-0/rustc-1.40.0-src/src/bootstrap)
    Finished dev [unoptimized] target(s) in 29.19s
thread &#39;main&#39; panicked at &#39;Error: no rules matched library/std.&#39;, src/bootstrap/builder.rs:232:21
failed to run: /tmp/guix-build-rust-1.40.0.drv-0/rustc-1.40.0-src/build/bootstrap/debug/bootstrap -j24 build library/std
Build completed unsuccessfully in 0:00:30
error: in phase &#39;build&#39;: uncaught exception:
%exception #&lt;&amp;invoke-error program: &quot;./x.py&quot; arguments: (&quot;-j24&quot; &quot;build&quot; &quot;library/std&quot;) exit-status: 1 term-signal: #f stop-signal: #f&gt;
phase `build&#39; failed after 30.4 seconds
command &quot;./x.py&quot; &quot;-j24&quot; &quot;build&quot; &quot;library/std&quot; failed with status 1
</code></pre></div>



<a name="251713243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251713243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251713243">(Sep 02 2021 at 13:20)</a>:</h4>
<p>You will need <code>src/libstd</code> instead of <code>library/std</code> for rustc 1.39.</p>



<a name="251713297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251713297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251713297">(Sep 02 2021 at 13:20)</a>:</h4>
<p>ah!  At which point did it change?</p>



<a name="251713621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251713621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251713621">(Sep 02 2021 at 13:22)</a>:</h4>
<p>Not sure. Basically when the directory <code>src/libstd</code> got moved to <code>library/std</code>. You are passing the location of the standard library source. It may be possible that <code>./x.py build std</code> works with 1.39 and up. Aka passing the crate name instead of location.</p>



<a name="251713686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251713686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251713686">(Sep 02 2021 at 13:22)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/commit/9e5f7d5631b8f4009ac1c693e585d4b7108d4275">https://github.com/rust-lang/rust/commit/9e5f7d5631b8f4009ac1c693e585d4b7108d4275</a></p>
<p>changed with 1.48.0</p>



<a name="251713737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251713737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251713737">(Sep 02 2021 at 13:23)</a>:</h4>
<p>er, that was the compiler, not the standard library.</p>



<a name="251713800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251713800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251713800">(Sep 02 2021 at 13:23)</a>:</h4>
<p>standard library moved one version earlier in 1.47.0: <a href="https://github.com/rust-lang/rust/commit/2c31b45ae878b821975c4ebd94cc1e49f6073fd0#diff-2e1fbbc12622c46bb4a8e390ce8f68377f90a726844d0b9fab49d3fd1dc7e38c">https://github.com/rust-lang/rust/commit/2c31b45ae878b821975c4ebd94cc1e49f6073fd0#diff-2e1fbbc12622c46bb4a8e390ce8f68377f90a726844d0b9fab49d3fd1dc7e38c</a></p>



<a name="251714912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251714912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251714912">(Sep 02 2021 at 13:31)</a>:</h4>
<p>OK! Thanks a lot for the research!</p>



<a name="251715068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251715068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251715068">(Sep 02 2021 at 13:32)</a>:</h4>
<p>Is it possible to build, install cargo from stage 1 only also?</p>



<a name="251715517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251715517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251715517">(Sep 02 2021 at 13:35)</a>:</h4>
<p><code>./x.py build src/tools/cargo</code>?</p>



<a name="251715859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251715859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251715859">(Sep 02 2021 at 13:37)</a>:</h4>
<p><code>./x.py build --stage 1 src/tools/cargo</code> or build the whole toolchain and configure the tools in cargo.toml. There also is <code>RUST_CONFIGURE_ARGS</code> but idk where that's documented.</p>



<a name="251717137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251717137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251717137">(Sep 02 2021 at 13:45)</a>:</h4>
<p>This is what I thought too, but in the output I can see: <code>Building stage2 tool cargo (x86_64-unknown-linux-gnu)</code></p>



<a name="251717355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251717355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251717355">(Sep 02 2021 at 13:46)</a>:</h4>
<p>oh wait, I didn't specify --stage 1 as that's supposed to be the default for <code>build</code></p>



<a name="251719952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251719952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251719952">(Sep 02 2021 at 14:02)</a>:</h4>
<p>None of the documentation will be right for a toolchain that old.</p>



<a name="251719976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251719976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251719976">(Sep 02 2021 at 14:03)</a>:</h4>
<p>Why are you trying to build 1.39? For a distro?</p>



<a name="251720192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251720192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251720192">(Sep 02 2021 at 14:04)</a>:</h4>
<p>I would guess bootstrapping, since it's the last one supported by mrustc</p>



<a name="251720370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251720370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251720370">(Sep 02 2021 at 14:05)</a>:</h4>
<p><span class="user-mention" data-user-id="437426">@apteryx</span> I think there's a repo that automates bootstrapping for you so you don't have to figure out the x.py commands</p>



<a name="251720411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251720411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251720411">(Sep 02 2021 at 14:05)</a>:</h4>
<p>Somewhere on dtolnay's GitHub IIRC</p>



<a name="251720723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251720723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251720723">(Sep 02 2021 at 14:07)</a>:</h4>
<p>I'm updating the Rust bootstrap for GNU Guix, starting at 1.39 instead of 1.29</p>



<a name="251720857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251720857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251720857">(Sep 02 2021 at 14:08)</a>:</h4>
<p>I know about the dtolnay repository, I used it originally, but it's still using 1.29.  Anyway, the bootstrap works fine now from 1.39, I'm just polishing it to skip stage 2 :-)</p>



<a name="251721126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251721126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251721126">(Sep 02 2021 at 14:10)</a>:</h4>
<p>Building cargo at stage 1 only worked when explicitly providing the stage level, e.g. <code>x.py build --stage=1 src/tools/cargo</code>; which is a bit of a surprise (the docs says the default stage level for build is 1)</p>



<a name="251724267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251724267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251724267">(Sep 02 2021 at 14:29)</a>:</h4>
<p>Yes, like I said, the docs are only for the latest version</p>



<a name="251725071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251725071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251725071">(Sep 02 2021 at 14:33)</a>:</h4>
<p>Is it OK to paste log output here? Or should I use a pastebin.</p>



<a name="251725186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251725186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251725186">(Sep 02 2021 at 14:34)</a>:</h4>
<p>There seem to be duplicate work between the <code>build</code> and <code>install</code> actions</p>



<a name="251726324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251726324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251726324">(Sep 02 2021 at 14:41)</a>:</h4>
<p>Pasting here is fine</p>



<a name="251726373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251726373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251726373">(Sep 02 2021 at 14:41)</a>:</h4>
<p>I'm not sure what you expect though, old releases are immutable so if there's a bug we can't fix it for 1.39</p>



<a name="251726863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251726863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251726863">(Sep 02 2021 at 14:44)</a>:</h4>
<p>I just want to validate that what I see is expected/that I'm not doing something silly; the commands I run in the recipe are akin to (for rust 1.40 say):</p>
<div class="codehilite"><pre><span></span><code># Build phase
./x.py -j24 build --stage=1 src/libstd
./x.py -j24 build --stage=1 src/tools/cargo
# Install phase
./x.py -j24 install --stage=1
./x.py -j24 install --stage=1 cargo
</code></pre></div>
<p>And the result looks like this: <a href="https://paste.debian.net/1210090/">https://paste.debian.net/1210090/</a></p>



<a name="251727687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251727687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251727687">(Sep 02 2021 at 14:49)</a>:</h4>
<p>For example, <code>Compiling rustc_parse v0.0.0 (/tmp/guix-build-rust-1.41.1.drv-0/rustc-1.41.1-src/src/librustc_parse)</code> seems to occur twice; once during the build, and again during the install.</p>



<a name="251728031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251728031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251728031">(Sep 02 2021 at 14:51)</a>:</h4>
<p>During <code>./x.py build</code> it compiles the compiler to build libstd. During <code>./x.py install</code> it builds the libraries that form the compiler using the newly compiled compiler so that if you want to use the newly compiled compiler to compile a program against the compiler libraries, that is possible. This is the <code>rustc-dev</code> component. I don't know if it is possible to disable it or not.</p>



<a name="251728622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251728622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251728622">(Sep 02 2021 at 14:55)</a>:</h4>
<p>OK! Thanks for the explanation!</p>



<a name="251729259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251729259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251729259">(Sep 02 2021 at 14:59)</a>:</h4>
<p>It may not be possible in 1.39, at least not without specifying every other target explicitly. On master it's off by default and you have to opt-in with <code>build compiler/rustc</code>.</p>



<a name="251730163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251730163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251730163">(Sep 02 2021 at 15:04)</a>:</h4>
<p>OK!  Great!</p>



<a name="251731107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251731107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251731107">(Sep 02 2021 at 15:10)</a>:</h4>
<p>Surprisingly building at stage 1 only doesn't seem much faster at all?</p>



<a name="251731568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251731568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251731568">(Sep 02 2021 at 15:13)</a>:</h4>
<p>does building rustc at stage 2 provide a more optimized (faster) compiler? that would offset the cost of building it?</p>



<a name="251733974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251733974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251733974">(Sep 02 2021 at 15:29)</a>:</h4>
<p>About 3m40 were used out of 16m38 t build the stage 2 artifacts of both rustc and cargo</p>



<a name="251734614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251734614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251734614">(Sep 02 2021 at 15:33)</a>:</h4>
<p>Building stage 2 by default just builds the compiler libraries. Only when you set <code>full-bootstrap</code> does it actually use the compiler again to compile everything I believe.</p>
<p>Let's say the bootstrap compiler has abi A and the final compiler has abi B. stage 0 rustc (bootstrap) compiles stage 0 libstd and stage 0 compiler libraries both with abi A. the rustc produced together with the stage 0 compiler libraries is stage 1 rustc. stage 1 rustc compiles stage 1 libstd and stage 1 compiler libraries both with abi B. the rustc produced with stage 1 compiler libraries is stage 2 rustc. with <code>full-bootstrap</code> stage 2 rustc compiler compiles stage 2 libstd and stage 2 compiler libraries again with abi B. without <code>full-bootstrap</code> the stage 2 libstd and stage 2 compiler libraries are assumed to be identical to the stage 1 versions, so it just copies them. A stage 1 compiler is not capable of compiling programs that link against itself as it only produces executables with abi B, but is compiled with abi A. For this reason a stage 2 compiler is necessary.</p>



<a name="251736250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251736250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251736250">(Sep 02 2021 at 15:44)</a>:</h4>
<p>Thanks for explaining.  The ABI problem doesn't seem problematic when we use a stage 1 compiler to build the next Rust with it (in a bootstrap context 1.39 -&gt; 1.40 -&gt; 1.41 ... -&gt; 1.54)</p>



<a name="251736309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251736309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251736309">(Sep 02 2021 at 15:44)</a>:</h4>
<p>But it's surprising that skipping stage 2 rustc and cargo results is slower builds</p>



<a name="251736365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251736365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251736365">(Sep 02 2021 at 15:44)</a>:</h4>
<p>I built 1.41 in just 11 minutes (stage 2) compared to 16 minutes (stage 1)</p>



<a name="251741538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251741538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251741538">(Sep 02 2021 at 16:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Compiling.20just.20stage1.20rustc.2Bstd/near/251736365">said</a>:</p>
<blockquote>
<p>I built 1.41 in just 11 minutes (stage 2) compared to 16 minutes (stage 1)</p>
</blockquote>
<blockquote>
<p>Building stage1 compiler artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)</p>
</blockquote>
<p>^ this is why it's slow, you're not actually saving any work</p>



<a name="251741549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251741549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251741549">(Sep 02 2021 at 16:15)</a>:</h4>
<p>it should never be <em>slower</em> than stage 2 though</p>



<a name="251741674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251741674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251741674">(Sep 02 2021 at 16:16)</a>:</h4>
<p>are you sure it's not caching bootstrap tools between stage1 and stage2? that could explain the difference</p>



<a name="251745079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251745079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251745079">(Sep 02 2021 at 16:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Compiling.20just.20stage1.20rustc.2Bstd/near/251741538">said</a>:</p>
<blockquote>
<blockquote>
<p>Building stage1 compiler artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)</p>
</blockquote>
<p>^ this is why it's slow, you're not actually saving any work</p>
</blockquote>
<p>Oh! Is there something I can do to change this?</p>
<p>About caching when building with stage 2,  I'm not doing anything special other than invoking the commands:</p>
<div class="codehilite"><pre><span></span><code>./x.py -j24 build
./x.py -j24 build src/tools/cargo
./x.py install
./x.py install cargo
</code></pre></div>



<a name="251745320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251745320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251745320">(Sep 02 2021 at 16:40)</a>:</h4>
<blockquote>
<p>Oh! Is there something I can do to change this?</p>
</blockquote>
<blockquote>
<p>It may not be possible in 1.39, at least not without specifying every other target explicitly. On master it's off by default and you have to opt-in with build compiler/rustc.</p>
</blockquote>
<p>If you only need enough to bootstrap the next compiler, I think <code>x.py build --stage 1 library/std src/tools/cargo</code> may be enough.</p>



<a name="251745375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251745375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251745375">(Sep 02 2021 at 16:40)</a>:</h4>
<p>I'll try, thanks</p>



<a name="251745424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251745424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251745424">(Sep 02 2021 at 16:41)</a>:</h4>
<p>(I assume you care so much because you have 15 more bootstrap runs to go <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> )</p>



<a name="251745459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251745459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251745459">(Sep 02 2021 at 16:41)</a>:</h4>
<p>exactly :-D</p>



<a name="251745616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251745616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251745616">(Sep 02 2021 at 16:42)</a>:</h4>
<p>and this being a functional package management based distro (Guix), every time something changes in the dependency graph of Rust it's going to trigger a rebuild of the full chain.</p>



<a name="251745745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251745745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251745745">(Sep 02 2021 at 16:43)</a>:</h4>
<p>oh big oof, yeah that's unfortunate</p>



<a name="251745791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251745791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251745791">(Sep 02 2021 at 16:43)</a>:</h4>
<p>and you can't really cache it either because the build artifacts for 15 toolchains will be enormous</p>



<a name="251746060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251746060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251746060">(Sep 02 2021 at 16:45)</a>:</h4>
<p>I wonder if you could hash the toolchain at least and skip further builds if it's the same output as before</p>



<a name="251746096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251746096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251746096">(Sep 02 2021 at 16:45)</a>:</h4>
<p>and that way you have to do a minimum of 1 build instead of 15</p>



<a name="251746221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251746221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251746221">(Sep 02 2021 at 16:46)</a>:</h4>
<p>I think Nix is doing this these days</p>



<a name="251746608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251746608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251746608">(Sep 02 2021 at 16:48)</a>:</h4>
<p>To be clear, did you mean I shoudn't invoke the <code>install</code> part?</p>



<a name="251746773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251746773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251746773">(Sep 02 2021 at 16:49)</a>:</h4>
<p>I think <code>install</code> shouldn't be strictly necessary; I don't know enough about your setup to know if it will make things easier or harder</p>



<a name="251746880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251746880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251746880">(Sep 02 2021 at 16:50)</a>:</h4>
<p>if you're only using this once then <a href="https://rustc-dev-guide.rust-lang.org/building/how-to-build-and-run.html#creating-a-rustup-toolchain">https://rustc-dev-guide.rust-lang.org/building/how-to-build-and-run.html#creating-a-rustup-toolchain</a> may be easier</p>



<a name="251746959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251746959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251746959">(Sep 02 2021 at 16:50)</a>:</h4>
<p>OK, <code>install</code> is useful to copy the built artifacts (rustc and library) to the correct locations; perhaps I can call install without calling build</p>



<a name="251746967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251746967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251746967">(Sep 02 2021 at 16:50)</a>:</h4>
<p>(I don't know if mrustc supports building rustup but I would expect so, it's not particularly complicated from a compiler POV)</p>



<a name="251747035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251747035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251747035">(Sep 02 2021 at 16:51)</a>:</h4>
<p>also <code>install</code> is slow in general IME</p>



<a name="251747393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251747393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251747393">(Sep 02 2021 at 16:53)</a>:</h4>
<p>yeah install isn't needed if you just pull the things you want out of the build directory</p>



<a name="251747471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251747471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251747471">(Sep 02 2021 at 16:54)</a>:</h4>
<p>OK! That should hasten the build</p>



<a name="251747572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251747572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251747572">(Sep 02 2021 at 16:55)</a>:</h4>
<p>is cargo necessary to bootstrap rustc?</p>



<a name="251747591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251747591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251747591">(Sep 02 2021 at 16:55)</a>:</h4>
<p>yes</p>



<a name="251747607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251747607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251747607">(Sep 02 2021 at 16:55)</a>:</h4>
<p>OK</p>



<a name="251747629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251747629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251747629">(Sep 02 2021 at 16:55)</a>:</h4>
<p>(it shouldn't take long to compile compared to rustc)</p>



<a name="251747894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251747894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251747894">(Sep 02 2021 at 16:57)</a>:</h4>
<p>also, currently bootstrap is unnecessarily sequential at some steps, executing one subgoal at a time. I was working on parallelizing things that don't have a dependency on each other but didn't finish it. not sure how much it would help with a minimal build though. it's more for testing where a bunch of stage 0 test tool stuff could get recompiled in parallel</p>



<a name="251748095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251748095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251748095">(Sep 02 2021 at 16:58)</a>:</h4>
<p>it mostly shows up on many-core systems where there are bottlenecks in the crate-graph that lead to underutilization</p>



<a name="251748238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251748238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251748238">(Sep 02 2021 at 16:59)</a>:</h4>
<p>cranking up the codegen units a bit might help, since you're using <code>-j24</code></p>



<a name="251748371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251748371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251748371">(Sep 02 2021 at 16:59)</a>:</h4>
<p>it results in a less optimal compiler but maybe the savings in build time are worth it, you'll have to measure</p>



<a name="251749007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251749007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251749007">(Sep 02 2021 at 17:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Compiling.20just.20stage1.20rustc.2Bstd/near/251747894">said</a>:</p>
<blockquote>
<p>also, currently bootstrap is unnecessarily sequential at some steps, executing one subgoal at a time. I was working on parallelizing things that don't have a dependency on each other but didn't finish it. not sure how much it would help with a minimal build though. it's more for testing where a bunch of stage 0 test tool stuff could get recompiled in parallel</p>
</blockquote>
<p>yeah, I can imagine it speeds up bootstrap tools quite a bit</p>



<a name="251749061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251749061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251749061">(Sep 02 2021 at 17:03)</a>:</h4>
<p>and hopefully it shouldn't be too much maintenance since everything is centralized in <code>builder.ensure</code></p>



<a name="251753159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251753159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251753159">(Sep 02 2021 at 17:29)</a>:</h4>
<p>How can that be done?</p>



<a name="251753173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251753173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251753173">(Sep 02 2021 at 17:29)</a>:</h4>
<p>(cranking up the codegen units)</p>



<a name="251753280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251753280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251753280">(Sep 02 2021 at 17:29)</a>:</h4>
<p>there should be a setting in config.toml somewhere</p>



<a name="251753389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251753389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251753389">(Sep 02 2021 at 17:30)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/fcce644119cf4e8e36001368e514bb5ed67cb855/config.toml.example#L388">https://github.com/rust-lang/rust/blob/fcce644119cf4e8e36001368e514bb5ed67cb855/config.toml.example#L388</a></p>



<a name="251754566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251754566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251754566">(Sep 02 2021 at 17:37)</a>:</h4>
<p>OK! I may try it after I sort out the manual install phase</p>



<a name="251754712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251754712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251754712">(Sep 02 2021 at 17:38)</a>:</h4>
<p>How is the 'x86_64-unknown-linux-gnu' directory name formed?  Does it uses the GNU "standard" for a system tuple?  I need to programatically derive it</p>



<a name="251754772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251754772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251754772">(Sep 02 2021 at 17:38)</a>:</h4>
<p>I'm talking about that <code>build/x86_64-unknown-linux-gnu/</code> build directory</p>



<a name="251754942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251754942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251754942">(Sep 02 2021 at 17:39)</a>:</h4>
<p>Ah, the answer was in the code I'm looking at.  We already have a <code>nix-system-&gt;gnu-triplet-for-rust</code> procedure.  Nevermind :-).</p>



<a name="251755151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251755151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251755151">(Sep 02 2021 at 17:41)</a>:</h4>
<blockquote>
<p>Does it uses the GNU "standard" for a system tuple? I need to programatically derive it</p>
</blockquote>
<p>in general, no: <a href="https://github.com/rust-lang/compiler-team/issues/441">https://github.com/rust-lang/compiler-team/issues/441</a></p>



<a name="251757006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251757006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251757006">(Sep 02 2021 at 17:53)</a>:</h4>
<p>OK! Good to know that there is some movement toward standardization</p>



<a name="251762707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251762707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251762707">(Sep 02 2021 at 18:26)</a>:</h4>
<p>Finally succeeded with the manual install phase: <code>real    9m0.112s</code> for 1.40.  That's good!</p>



<a name="251765178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251765178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251765178">(Sep 02 2021 at 18:41)</a>:</h4>
<p>I tried the <code>codegen-units = 256</code> tip, but that doesn't seem to exist for 1.40: </p>
<div class="codehilite"><pre><span></span><code>failed to parse TOML configuration &#39;config.toml&#39;: unknown field `codegen-units`, expected one of `build`, `host`, `target`, `cargo`, `rustc`, `docs`, `compiler-docs`, `submodules`, `fast-submodules`, `gdb`, `nodejs`, `python`, `locked-deps`, `vendor`, `full-bootstrap`, `extended`, `tools`, `verbose`, `sanitizers`, `profiler`, `cargo-native-static`, `low-priority`, `configure-args`, `local-rebuild`, `print-step-timings` for key `build` at line 24 column 1
failed to run: /tmp/guix-build-rust-1.40.0.drv-0/rustc-1.40.0-src/build/bootstrap/debug/bootstrap -j24 build --stage=1 src/libstd src/tools/cargo
Build completed unsuccessfully in 0:00:27
</code></pre></div>



<a name="251765608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251765608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251765608">(Sep 02 2021 at 18:44)</a>:</h4>
<p>ah, it's for [rust], not [build]</p>



<a name="251770884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251770884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251770884">(Sep 02 2021 at 19:17)</a>:</h4>
<p>It seems about 10 minutes per Rust now.  That's going to come out at 100 min for the initial mrustc 1.39 build, then 10 minutes x 15 for the remaining ones, then perhaps 10 minutes extra to build extra tools for 1.54; totalizing ~4h20 on a Ryzen 3900X CPU.  Much better than the slow 16 h + Rust bootstrap that we've had on the Guix master branch!</p>



<a name="251771854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251771854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251771854">(Sep 02 2021 at 19:24)</a>:</h4>
<p>for the final build you might want to do 1CGU and maybe PGO on top. That's what official builds do. It'll take longer but yield a faster compiler for your users.</p>



<a name="251774504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251774504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251774504">(Sep 02 2021 at 19:41)</a>:</h4>
<p>What does that involve?  Invoking LLVM commands manually?</p>



<a name="251776019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251776019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251776019">(Sep 02 2021 at 19:51)</a>:</h4>
<p>see <code>src/ci/pgo.sh</code></p>



<a name="251776117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251776117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251776117">(Sep 02 2021 at 19:52)</a>:</h4>
<p>the <code>codegen-units</code> doesn't seem to meaningfully change the result.  I returned it to 16 from 256 (the default) and the build time remained at 10 m</p>



<a name="251776269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251776269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251776269">(Sep 02 2021 at 19:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330154">The 8472</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Compiling.20just.20stage1.20rustc.2Bstd/near/251776019">said</a>:</p>
<blockquote>
<p>see <code>src/ci/pgo.sh</code></p>
</blockquote>
<p>Thanks!</p>



<a name="251776525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251776525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251776525">(Sep 02 2021 at 19:55)</a>:</h4>
<p>256 is only the default for incremental builds. for bootstrapping there's no point in doing incremental</p>



<a name="251776732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251776732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251776732">(Sep 02 2021 at 19:56)</a>:</h4>
<p>We thought that bumping it up from the default 16 might have hastened things on a 24 cores machine.</p>



<a name="251776914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251776914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251776914">(Sep 02 2021 at 19:57)</a>:</h4>
<p>yeah. ok, too bad it didn't help.</p>



<a name="251777011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251777011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251777011">(Sep 02 2021 at 19:58)</a>:</h4>
<p>Would you know whether PGO is deterministic? It's important for reproducible builds.</p>



<a name="251778089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251778089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251778089">(Sep 02 2021 at 20:05)</a>:</h4>
<p>I don't know. The original issue for it raised the same question and assumes that it's the same given the same profile data but whether generating profile data is deterministic isn't answered.</p>



<a name="251779491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251779491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251779491">(Sep 02 2021 at 20:15)</a>:</h4>
<p>OK!  I'll punt on that for now, but should we ever try it in Guix, we'd be able to tell quickly (<code>guix build rust --rounds=2 --keep-failed</code>)</p>



<a name="251779569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Compiling%20just%20stage1%20rustc%2Bstd/near/251779569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Compiling.20just.20stage1.20rustc.2Bstd.html#251779569">(Sep 02 2021 at 20:15)</a>:</h4>
<p>I don't think it is completely deterministic. I believe we use a PRNG for the names of temp dirs. This happens relatively late during compilation though, so it probably doesn't cascade all the way. It is also possible that it doesn't cause any control dependencies. cc <span class="user-mention" data-user-id="119009">@eddyb</span> as you worked on instruction precise reproducability of a rustc invocations a while ago.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>