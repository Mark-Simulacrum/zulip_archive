<html>
<head><meta charset="utf-8"><title>Codegenning statics with addrspaces · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20statics.20with.20addrspaces.html">Codegenning statics with addrspaces</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263107379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Codegenning%20statics%20with%20addrspaces/near/263107379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20statics.20with.20addrspaces.html#263107379">(Nov 30 2021 at 06:55)</a>:</h4>
<p>Ive ran into an issue trying to codegen address spaces in my CUDA codegen. I am a bit confused on exactly how the statics codegen process happens in cg_ssa. This is basically what i need to do:</p>
<ul>
<li>CUDA allows you to define what memory space a global is in by using LLVM address spaces.</li>
<li>Anything not in a specific addrspace is in a generic address space where it is unknown what address space the thing relies in.</li>
<li>I can't use specific addrspaces everywhere because rustc does not track addrspaces.</li>
<li>I can declare a global in a specific addrspace but then treat it as generic with a const addrspace cast, then run an InferAddressSpaces pass to make the addrspaces more specific in their use.</li>
</ul>
<p>But the issue is, i am not sure what the right place to return a const addrspace cast is. cg_ssa has a super confusing static codegen process im not quite sure about. I thought <code>get_static</code> was the place for "fetch me the value of this static", but looking at its uses in cg_ssa, it seems to only be used for thread local refs. I can't do it in <code>predefine_static</code> because <code>codegen_static</code> tries grabbing info about the original static, which obviously fails if done on a const addrspace cast. So im just wondering what the best way of doing this is.</p>



<a name="263108488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Codegenning%20statics%20with%20addrspaces/near/263108488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20statics.20with.20addrspaces.html#263108488">(Nov 30 2021 at 07:18)</a>:</h4>
<p>Also, rustc seems to be inlining statics into their value, which is not really "correct" with address spaces and certain things in CUDA, is there a way to disable this from user code and/or from the codegen?</p>



<a name="263387113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Codegenning%20statics%20with%20addrspaces/near/263387113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20statics.20with.20addrspaces.html#263387113">(Dec 02 2021 at 02:47)</a>:</h4>
<p>I got it to work after a lot of debugging random const bitcast failures, we now have statics being put in const addrspaces by default <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
<div class="codehilite"><pre><span></span><code>    // .globl    foo
.const .align 1 .b8 _ZN7add_gpu3FOO17h7d38b143314c0523E[1] = {25};

.visible .func  (.param .b32 func_retval0) foo()
{
    .reg .b32     %r&lt;2&gt;;


    ld.const.u8     %r1, [_ZN7add_gpu3FOO17h7d38b143314c0523E];
    st.param.b32     [func_retval0+0], %r1;
    ret;

}
</code></pre></div>



<a name="263387130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Codegenning%20statics%20with%20addrspaces/near/263387130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20statics.20with.20addrspaces.html#263387130">(Dec 02 2021 at 02:48)</a>:</h4>
<p>Not for <code>allocXX</code> or <code>privateXX</code> globals though, those are a bit weird</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>