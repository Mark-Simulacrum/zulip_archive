<html>
<head><meta charset="utf-8"><title>Add external optimisation into rustc_mir_transform · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html">Add external optimisation into rustc_mir_transform</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278032237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278032237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Janis Peyer [he/him] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278032237">(Apr 06 2022 at 14:33)</a>:</h4>
<p>Hello t-compiler</p>
<p>I'm working with the Rust compiler for my master's thesis. More concretely I am to add one or more MirPass implementations to rustc_mir_transform. My supervisors suggested, that I create my own crate to develop the MirPass implementation in for a faster workflow.</p>
<p>I have a working proof-of-concept for adding my externally developed MirPass into rustc_mir_transform. I'm using public static state with the SyncLazy from once_cell to do so. Here are the minimal commits of my proof-of-concept:<br>
Rust: <a href="https://github.com/janispeyer/rust/commit/5fdeee8d71503ac6b87d292854ff2e2b22a8d590">https://github.com/janispeyer/rust/commit/5fdeee8d71503ac6b87d292854ff2e2b22a8d590</a><br>
My Project: <a href="https://github.com/janispeyer/rustc_alias/commit/dc34c1c226555d6d1dd0679bba20ac7580b39dc3">https://github.com/janispeyer/rustc_alias/commit/dc34c1c226555d6d1dd0679bba20ac7580b39dc3</a></p>
<p>Note: I don't intend to ever merge these changes to the compiler back into the main repo. For merging I would add the code from my project back into rust and remove the (public static) injection point.</p>
<p>What I wanted to ask here: is this a good approach for injecting my MirPass? Or is there a better option?<br>
We considered adding it over the Config and Session types, but I didn't figure out a good solution that wouldn't require a lot of refactoring.</p>



<a name="278056070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278056070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278056070">(Apr 06 2022 at 17:10)</a>:</h4>
<p>You can override the optimized_mir query using the <code>override_queries</code> field of <code>rustc_interface::interface::Config</code> (you can modify it in the <code>config</code> method of your <code>rustc_driver::Callbacks</code> impl. In the optimized_mir query you can then call the original optimized_mir query and run your own pass.</p>



<a name="278056238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278056238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278056238">(Apr 06 2022 at 17:12)</a>:</h4>
<p>By the way I found a typo in the readme of rustc_alias: rustc +<strong>nigthly</strong> instead of rustc +<strong>nightly</strong>.</p>



<a name="278056262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278056262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278056262">(Apr 06 2022 at 17:12)</a>:</h4>
<p><span class="user-mention" data-user-id="492138">@Janis Peyer [he/him]</span></p>



<a name="278057787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278057787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Janis Peyer [he/him] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278057787">(Apr 06 2022 at 17:25)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> <br>
I tried doing something like that. (I've been looking at the following to do so: <a href="https://github.com/viperproject/prusti-dev/blob/8678e8faf214768535677c72b4f50b22abc6b83b/analysis/src/bin/analysis-driver.rs">https://github.com/viperproject/prusti-dev/blob/8678e8faf214768535677c72b4f50b22abc6b83b/analysis/src/bin/analysis-driver.rs</a>)</p>
<p>The problem I was having with this approach was, that I did not have control over where my pass was added. I could only add it before any of the other optimisation passes or after, but not in between. Do you know how I could do that with the described approach?</p>



<a name="278057810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278057810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Janis Peyer [he/him] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278057810">(Apr 06 2022 at 17:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Add.20external.20optimisation.20into.20rustc_mir_transform/near/278056238">said</a>:</p>
<blockquote>
<p>By the way I found a typo in the readme of rustc_alias: rustc +<strong>nigthly</strong> instead of rustc +<strong>nightly</strong>.</p>
</blockquote>
<p>Thanks, fixed it <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="278059120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278059120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278059120">(Apr 06 2022 at 17:34)</a>:</h4>
<blockquote>
<p>The problem I was having with this approach was, that I did not have control over where my pass was added.</p>
</blockquote>
<p>We don't have any way to control which passes run and in which other except for changing the <code>run_optimization_passes</code> function. I believe there is some work on a mir pass manager, but I'm not sure if adding extra passes is planned.</p>



<a name="278059425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278059425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278059425">(Apr 06 2022 at 17:36)</a>:</h4>
<p>If you really want to avoid compiling your own rustc you could copy the entire <code>rustc_mir_transform</code> crate to your project and use it to provide the <code>optimized_mir</code> query after adding your pass. Make sure to update it if you update the rustc nightly though. It is also not the least cumbersome approach.</p>



<a name="278060355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278060355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Janis Peyer [he/him] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278060355">(Apr 06 2022 at 17:44)</a>:</h4>
<p>I didn't consider this option yet. Do you think copying the whole <code>rustc_mir_transform</code> crate would be preferable to what I'm currently doing with the injection over global static state?</p>



<a name="278060543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278060543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278060543">(Apr 06 2022 at 17:45)</a>:</h4>
<p>A global static is not something upstreamable at least. There can be multiple compilation sessions inside the same process. Global statics would conflict between such compilation sessions.</p>



<a name="278060644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278060644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278060644">(Apr 06 2022 at 17:46)</a>:</h4>
<p>It may be possible to have a more local api using eg a custom query.</p>



<a name="278061525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278061525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Janis Peyer [he/him] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278061525">(Apr 06 2022 at 17:53)</a>:</h4>
<p>Yes, I completely understand, that this is not something that can be merged upstream. The main purpose ist to improve compile time of my additions while I work on them. I tried incrementel compilation (e.g. <code>x test -i &lt;concrete-test&gt; --keep-stage 1</code>) but every test still took minutes to run.</p>



<a name="278062100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278062100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Janis Peyer [he/him] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278062100">(Apr 06 2022 at 17:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Add.20external.20optimisation.20into.20rustc_mir_transform/near/278060644">said</a>:</p>
<blockquote>
<p>It may be possible to have a more local api using eg a custom query.</p>
</blockquote>
<p>I might try to add something like that. I didn't fully understand how querries are added to be honest. I've looked at the macro that generates them, but couldn't yet figure out where the querry definitions reside.</p>



<a name="278068993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278068993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278068993">(Apr 06 2022 at 18:48)</a>:</h4>
<p>Queries are defined in compiler/rustc_middle/src/query/mod.rs</p>



<a name="278070087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20external%20optimisation%20into%20rustc_mir_transform/near/278070087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Janis Peyer [he/him] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20external.20optimisation.20into.20rustc_mir_transform.html#278070087">(Apr 06 2022 at 18:57)</a>:</h4>
<p>Thanks. And thanks generally for your help and suggestions :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>