<html>
<head><meta charset="utf-8"><title>How does Coercion work · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html">How does Coercion work</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264218155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264218155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264218155">(Dec 08 2021 at 20:49)</a>:</h4>
<p>While trying to fix issue <a href="https://github.com/rust-lang/rust/issues/91636">#91636</a> I found this Compiler-Coercion interaction:<br>
When compiling code like this: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">_a</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">type_of</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"type -&gt; {}"</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">any</span>::<span class="n">type_name</span>::<span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">str</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">" type of foo {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">type_of</span><span class="p">(</span><span class="n">foo</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">str</span><span class="p">)));</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">foo</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>everything works fine it compiles, I think it's because as we println! foo implicitly coerces.</p>
<p>Meanwhile this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">_a</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">str</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// println!(" type of foo {:?}", type_of(foo)); // if I do this it prints foo's type as error::foo</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">foo</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>panics and throws ICE because there is no coercion and foo is zero sized type and stuff goes wrong. <br>
Everything makes sense till this point.But error message is this : <code>'Unexpected types for BinOp: fn(&amp;str) bin op Eq for&lt;'r&gt; fn(&amp;'r str)', rust/compiler/rustc_const_eval/src/interpret/operator.rs:332:17</code> how does compiler know <code>foo</code> is <code>for&lt;'r&gt; fn(&amp;'r str)</code> without coercion and if it does how come assertion fails ? Aren't these two types are the same. <br>
And if this is a bug what should expected behavior be ?</p>



<a name="264384385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264384385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264384385">(Dec 09 2021 at 23:52)</a>:</h4>
<p>Looks HRTB related</p>



<a name="264393372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264393372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264393372">(Dec 10 2021 at 01:43)</a>:</h4>
<p>the two types are certainly not the same. both are <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/enum.TyKind.html#variant.FnPtr">FnPtr</a> but their <code>PolyFnSig</code> will be different.</p>



<a name="264393433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264393433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264393433">(Dec 10 2021 at 01:44)</a>:</h4>
<p>I have no idea how this <code>println!</code>, which does not even mention <code>x</code>, can somehow affect the code that follows -- that is very odd, and it might be worth looking at the MIR to figure out what happens</p>



<a name="264393490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264393490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264393490">(Dec 10 2021 at 01:45)</a>:</h4>
<p>however, I think that is mostly orthogonal to fixing the ICE: clearly, <code> right.layout.ty == left.layout.ty || right.layout.ty.is_integral()</code> needs to be replaced by some weaker condition. I am inlined to just make it <code>right.laouy.ty.is_any_pointer() || right.layout.ty.is_integral()</code>. then the code that follows, in particular <code>binary_ptr_op</code>, needs to be checked to ensure that it can handle this.</p>



<a name="264393635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264393635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264393635">(Dec 10 2021 at 01:47)</a>:</h4>
<p>and looking at the implementation of that code in Miri, I think it is fine</p>



<a name="264393643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264393643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264393643">(Dec 10 2021 at 01:47)</a>:</h4>
<p>so figuring out what happens with the coercions is interesting, but not required to fix the ICE :)</p>



<a name="264451628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264451628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264451628">(Dec 10 2021 at 14:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/How.20does.20Coercion.20work/near/264393490">said</a>:</p>
<blockquote>
<p>however, I think that is mostly orthogonal to fixing the ICE: clearly, <code> right.layout.ty == left.layout.ty || right.layout.ty.is_integral()</code> needs to be replaced by some weaker condition. I am inlined to just make it <code>right.laouy.ty.is_any_pointer() || right.layout.ty.is_integral()</code>. then the code that follows, in particular <code>binary_ptr_op</code>, needs to be checked to ensure that it can handle this.</p>
</blockquote>
<p>I ran <code>./x.py test -i src/test/ui</code> with the changes you mentioned and test ran without any errors so we can assume this is the fix ?</p>



<a name="264451988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264451988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264451988">(Dec 10 2021 at 14:09)</a>:</h4>
<p>Now I am planning to look at what is happening with <code>println!</code> I will post here if I <em>can</em> find something</p>



<a name="264472878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264472878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264472878">(Dec 10 2021 at 16:37)</a>:</h4>
<p>If <code>foo</code> is not printed in the <code>main</code> function, statement enters <code>Rvalue::BinaryOp</code> then it enters <code>overflowing_binary_op</code>.<br>
If <code>foo</code> gets printed statement never enters <code>overflowing_binary_op</code>.  Printing <code>foo</code> totally changes how program behaves <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="264473920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264473920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264473920">(Dec 10 2021 at 16:45)</a>:</h4>
<p>I also printed <code>Miri</code> graph of these two but I don't know what I am  looking at.<br>
<a href="http://tinyurl.com/3yvss453">The one with print</a> ,  <a href="http://tinyurl.com/ybm9v5vj">other one</a></p>



<a name="264493550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264493550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Troy <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264493550">(Dec 10 2021 at 19:04)</a>:</h4>
<blockquote>
<p>printing <code>foo</code> totally changes how program behaves</p>
</blockquote>
<p>Is this true even after your fix to the assertion?</p>



<a name="264502316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264502316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264502316">(Dec 10 2021 at 20:18)</a>:</h4>
<p>it never enters to that assertion in the first place</p>



<a name="264502419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264502419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264502419">(Dec 10 2021 at 20:19)</a>:</h4>
<p>so <em>fixing</em> the assertion only fixes the program when there is no print</p>



<a name="264538082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264538082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264538082">(Dec 11 2021 at 03:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="460107">Oguz</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/How.20does.20Coercion.20work/near/264473920">said</a>:</p>
<blockquote>
<p>I also printed <code>Miri</code> graph of these two but I don't know what I am  looking at.<br>
<a href="http://tinyurl.com/3yvss453">The one with print</a> ,  <a href="http://tinyurl.com/ybm9v5vj">other one</a></p>
</blockquote>
<p>the 'other one' does not even have a comparison in it any more...?</p>



<a name="264549859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264549859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264549859">(Dec 11 2021 at 08:26)</a>:</h4>
<p>Well because it panics I couldn't get it to output <code>Miri</code> graph <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>  , <a href="https://tinyurl.com/2p8u2xc8">here</a> is the graph with the change you mentioned . Also code only compiles when I add <code>+stage1</code> option.</p>



<a name="264549930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264549930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264549930">(Dec 11 2021 at 08:28)</a>:</h4>
<p>Otherwise it ICEs and dumps query stack: <br>
<code>query stack during panic:
#0 [optimized_mir] optimizing MIR for </code>main<code>
#1 [collect_and_partition_mono_items] collect_and_partition_mono_items
end of query stack</code></p>



<a name="264552156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264552156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264552156">(Dec 11 2021 at 09:24)</a>:</h4>
<p>The ICE was triggered by constant propagation. The interaction with line containing <code>println!</code> is  probably because it introduces a separate basic block and then definition of x will not be available in the other block, so constant propagation will bail out earlier. Adding <code>if true { .. }</code> has similar effect.</p>



<a name="264558290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264558290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264558290">(Dec 11 2021 at 11:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="352985">tm</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/How.20does.20Coercion.20work/near/264552156">said</a>:</p>
<blockquote>
<p>The ICE was triggered by constant propagation. The interaction with line containing <code>println!</code> is  probably because it introduces a separate basic block and then the definition of x will not be available in the other block, so constant propagation will bail out earlier. Adding <code>if true { .. }</code> has similar effect.</p>
</blockquote>
<p>I think this can cause other issues in the future, any idea where should I look to properly fix this ?</p>



<a name="264558457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264558457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264558457">(Dec 11 2021 at 11:52)</a>:</h4>
<p>another thing <code>assert!(foo == x)</code> gives out proper error instead of ICE</p>



<a name="264562152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264562152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264562152">(Dec 11 2021 at 13:12)</a>:</h4>
<p>What I was trying to say, that if you are testing this through rustc, where evaluation happens for const propagation purposes, it is completely normal for evaluation to stop early without reaching <code>overflowing_binary_op</code>.<br>
Though, if you are observing this difference in behaviour when executing program using Miri the tool, that would be surprising indeed.</p>



<a name="264562598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264562598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264562598">(Dec 11 2021 at 13:22)</a>:</h4>
<p>What I am trying to understand is why const propagation makes this a <em>normal</em> behavior, and why it causes ICE when it's ran through 'rustc error.rs`</p>



<a name="264562912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264562912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264562912">(Dec 11 2021 at 13:28)</a>:</h4>
<p>To clarify, the question is why the second code snippet causes ICE when compiled with rustc, while the first one compiles successfully?</p>



<a name="264563078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264563078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264563078">(Dec 11 2021 at 13:34)</a>:</h4>
<p>I literally have no idea, first one always compiles successfully , I think it must be something to do with <code>constant propagation</code>. But as I said if I do <code>foo == x</code> instead of <code>x == foo</code> it gives out proper error message not ICE</p>



<a name="264563141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264563141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264563141">(Dec 11 2021 at 13:35)</a>:</h4>
<p>Or this could be something to do with what RalfJ said <a href="https://github.com/rust-lang/rust/issues/91636#issuecomment-990064294">here</a></p>



<a name="264563400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264563400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264563400">(Dec 11 2021 at 13:41)</a>:</h4>
<p>Oh, so the question is about the difference between <code>foo == x</code> and <code>x == foo</code>?</p>



<a name="264563491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264563491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264563491">(Dec 11 2021 at 13:43)</a>:</h4>
<p>Actually there are 2 questions 1- Why there is ICE when <code>x == foo</code> but not in vice versa (why compiler treats these two differently) 2- How do I fix this ICE <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<a name="264564044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264564044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264564044">(Dec 11 2021 at 13:56)</a>:</h4>
<p>I see. I thought the question was still about significance of <code>println!</code>, which can be understood by comparing logs for both variants with <code>env RUSTC_LOG=rustc_mir_transform::const_prop,rustc_const_eval=trace</code> (assuming one has a build with debug logging).</p>



<a name="264564595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264564595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264564595">(Dec 11 2021 at 14:08)</a>:</h4>
<p>I did look at those logs to understand why <code>println!</code> caused it to not ICE in the first place but those logs are humongous I am not sure where to look to compare them</p>



<a name="264565084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264565084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264565084">(Dec 11 2021 at 14:20)</a>:</h4>
<p>Version that ICEs would be first starting point, since the interesting part log logs is just before the panic:</p>
<div class="codehilite"><pre><span></span><code>├─12ms TRACE rustc_mir_transform::const_prop visit_statement: _3 = Eq(move _4, move _5)
├─12ms TRACE rustc_mir_transform::const_prop checking BinaryOp(op = Eq, left = move _4, right = move _5)
├─12ms TRACE rustc_const_eval::interpret::operand eval_place_to_op: got Immediate(Scalar(alloc1))
├─12ms TRACE rustc_const_eval::interpret::operand move _5: Immediate(Scalar(alloc1))
├─12ms TRACE rustc_const_eval::interpret::operand eval_place_to_op: got Immediate(Scalar(alloc1))
├─12ms TRACE rustc_const_eval::interpret::operand move _4: Immediate(Scalar(alloc1))
├─12ms TRACE rustc_const_eval::interpret::operator Running binary op Eq: ImmTy { imm: Scalar(alloc1), layout: TyAndLayout { ty: fn(&amp;str), layout: Layout { fields: Primitive, variants: Single { index: 0 }, abi: Scalar(Scalar { value: Pointer, valid_range: 1..=18446744073709551615 }), largest_niche: Some(Niche { offset: Size { raw: 0 }, scalar: Scalar { value: Pointer, valid_range: 1..=18446744073709551615 } }), align: AbiAndPrefAlign { abi: Align { pow2: 3 }, pref: Align { pow2: 3 } }, size: Size { raw: 8 } } } } (fn(&amp;str)), ImmTy { imm: Scalar(alloc1), layout: TyAndLayout { ty: for&lt;&#39;r&gt; fn(&amp;&#39;r str), layout: Layout { fields: Primitive, variants: Single { index: 0 }, abi: Scalar(Scalar { value: Pointer, valid_range: 1..=18446744073709551615 }), largest_niche: Some(Niche { offset: Size { raw: 0 }, scalar: Scalar { value: Pointer, valid_range: 1..=18446744073709551615 } }), align: AbiAndPrefAlign { abi: Align { pow2: 3 }, pref: Align { pow2: 3 } }, size: Size { raw: 8 } } } } (for&lt;&#39;r&gt; fn(&amp;&#39;r str))
thread &#39;rustc&#39; panicked at &#39;Unexpected types for BinOp: fn(&amp;str) Eq for&lt;&#39;r&gt; fn(&amp;&#39;r str)&#39;, /home/tm/rust/compiler/rustc_const_eval/src/interpret/operator.rs:332:17
</code></pre></div>
<p>Then we can run the second version and locate corresponding <code>visit_statement</code> and <code>checking BinaryOp</code>, which suggest that we never reached "Running binary op", because operands to <code>Eq</code> were uninitialized:</p>
<div class="codehilite"><pre><span></span><code>├─35ms TRACE rustc_mir_transform::const_prop checking BinaryOp(op = Eq, left = move _24, right = move _25)
├─35ms TRACE rustc_const_eval::interpret::operand eval_place_to_op: got Immediate(Scalar(alloc1))
├─35ms TRACE rustc_const_eval::interpret::operand move _25: Immediate(Scalar(alloc1))
├─35ms TRACE rustc_mir_transform::const_prop InterpCx operation failed: InterpErrorInfo(InterpErrorInfoInner { kind: tried to access an uninitialized local, backtrace: None })
├─35ms TRACE rustc_const_eval::interpret::place _23: is uninitialized:
├─35ms TRACE rustc_mir_transform::const_prop InterpCx operation failed: InterpErrorInfo(InterpErrorInfoInner { kind: tried to access an uninitialized local, backtrace: None })
├─35ms TRACE rustc_mir_transform::const_prop propagation into _23 failed.
│                         Nuking the entire site from orbit, it&#39;s the only way to be sure
</code></pre></div>



<a name="264565455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264565455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264565455">(Dec 11 2021 at 14:28)</a>:</h4>
<p>That's actually very helpful thanks a lot! It seems there are a lot more errors in the second version but compiler gives up and just runs the program without crashing so this is definitely unwanted behavior <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<a name="264565587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264565587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264565587">(Dec 11 2021 at 14:32)</a>:</h4>
<p>There seems to be 3 errors/bugs(?):<br>
1- ICE<br>
2- <code>==</code> is behaves differently in a case where it shouldn't<br>
3- <code>println!</code> causes behavioral change in a program where it shouldn't</p>



<a name="264639506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264639506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264639506">(Dec 12 2021 at 19:31)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span>  I been working on this for a while and it looks like allowing <code>eq</code> between supertypes and subtypes is required to build the <code>core</code> and compiler behavior is this: if <code>lhs</code> is supertype of <code>rhs</code> coercion happens and <code>eq</code> is successful other wise it's not.<br>
I don't know if this behavior is sound or not. Also should I open a <code>pr</code> for this your suggested change fixes the <code>ICE</code> or you would like to do it yourself.</p>



<a name="264648420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264648420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264648420">(Dec 12 2021 at 22:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="460107">Oguz</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/How.20does.20Coercion.20work/near/264549859">said</a>:</p>
<blockquote>
<p>Well because it panics I couldn't get it to output <code>Miri</code> graph <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>  , <a href="https://tinyurl.com/2p8u2xc8">here</a> is the graph with the change you mentioned . Also code only compiles when I add <code>+stage1</code> option.</p>
</blockquote>
<p>btw I think you mean the MIR graph. MIR is the name of the intermediate representation. Miri is a tool that works on that representation. :)</p>



<a name="264649030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264649030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264649030">(Dec 12 2021 at 23:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="460107">Oguz</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/How.20does.20Coercion.20work/near/264639506">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span>  I been working on this for a while and it looks like allowing <code>eq</code> between supertypes and subtypes is required to build the <code>core</code> and compiler behavior is this: if <code>lhs</code> is supertype of <code>rhs</code> coercion happens and <code>eq</code> is successful other wise it's not.<br>
I don't know if this behavior is sound or not. Also should I open a <code>pr</code> for this, your suggested change fixes the <code>ICE</code> or you would like to do it yourself.</p>
</blockquote>
<p>I dont know either how coercions are supposed to behave, but having a slight difference in the inferred types between <code>x == foo</code> and <code>foo == x</code> does not seem surprising to me.<br>
feel free to make a PR with the suggested change to fix the ICE :)</p>



<a name="264650355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/How%20does%20Coercion%20work/near/264650355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oguz <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/How.20does.20Coercion.20work.html#264650355">(Dec 12 2021 at 23:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120791">RalfJ</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/How.20does.20Coercion.20work/near/264648420">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="460107">Oguz</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/How.20does.20Coercion.20work/near/264549859">said</a>:</p>
<blockquote>
<p>Well because it panics I couldn't get it to output <code>Miri</code> graph <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>  , <a href="https://tinyurl.com/2p8u2xc8">here</a> is the graph with the change you mentioned . Also code only compiles when I add <code>+stage1</code> option.</p>
</blockquote>
<p>btw I think you mean the MIR graph. MIR is the name of the intermediate representation. Miri is a tool that works on that representation. :)</p>
</blockquote>
<p>I am new to <code>rustc</code>and there are too many terms so yes I probably meant that <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> . Thanks going to make a PR tomorrow <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>