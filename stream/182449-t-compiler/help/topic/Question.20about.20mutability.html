<html>
<head><meta charset="utf-8"><title>Question about mutability · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Question.20about.20mutability.html">Question about mutability</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268329039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Question%20about%20mutability/near/268329039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Poitras <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Question.20about.20mutability.html#268329039">(Jan 18 2022 at 00:37)</a>:</h4>
<p>Hello, </p>
<p>I have a question about how the mutability of variables is handled by the compiler.</p>
<p>Let's say I have:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="n">something_complicated</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">other_complicated_function</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>In the last line, is the value in the first x copied to the second x, or is the mutability of the first x just removed?</p>



<a name="268329141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Question%20about%20mutability/near/268329141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Patrick Poitras <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Question.20about.20mutability.html#268329141">(Jan 18 2022 at 00:38)</a>:</h4>
<p>I like this pattern because you can have variables that are only mutable for the period where the mutability is needed, and then removed to make it unmutable. I was wondering if the compiler also does this in the background.</p>



<a name="268334400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Question%20about%20mutability/near/268334400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Question.20about.20mutability.html#268334400">(Jan 18 2022 at 02:03)</a>:</h4>
<p>It usually won't copy, as the copy gets optimized away.</p>
<p>Internally it introduces a new binding that does not have <code>mut</code>.  The lower-level optimizations are responsible for figuring out what needs to be copied or moved around or kept in place.</p>
<p>If you're curious, you could start looking at the MIR output to see what the mid-level intermediate representation looks like in the compiler.  On a nightly, run <code>rustc</code> with <code>-Zunpretty=mir</code>.  </p>
<p>If you're even more curious, you could look up SSA (single static assignment). At the lower levels, the code is transformed into a form where variables are only assigned once.</p>



<a name="268335688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Question%20about%20mutability/near/268335688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyabean <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Question.20about.20mutability.html#268335688">(Jan 18 2022 at 02:25)</a>:</h4>
<p>You can print out the address of variables. </p>
<div class="codehilite"><pre><span></span><code>    fn something_complicated() -&gt; bool{
        true
    }

    fn other_complicated_function() -&gt; i32 {
        1
    }

    let mut x = 500;

    if something_complicated() {
        x += other_complicated_function();
    }
    println!(&quot;x1: 0x{:X}&quot;, (&amp;x as * const i32) as usize);

    let mut x = x;

    if something_complicated() {
        x += other_complicated_function();
    }
    println!(&quot;x2: 0x{:X}&quot;, (&amp;x as * const i32) as usize);

    let x = x;
    println!(&quot;x3: 0x{:X}&quot;, (&amp;x as * const i32) as usize);
</code></pre></div>
<p>Output on my machine:<br>
x1: 0xD47FF0F2DC<br>
x2: 0xD47FF0F2D8<br>
x3: 0xD47FF0F2CC</p>



<a name="268339590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Question%20about%20mutability/near/268339590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Question.20about.20mutability.html#268339590">(Jan 18 2022 at 03:40)</a>:</h4>
<p>Printing the addresses of the different variables forces the compiler to keep them separate. If you remove the <code>println!</code>s and the compiler will likely use a single stack slot for the different <code>x</code> variables</p>



<a name="268394276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Question%20about%20mutability/near/268394276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Question.20about.20mutability.html#268394276">(Jan 18 2022 at 14:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="451171">Patrick Poitras</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Question.20about.20mutability/near/268329141">said</a>:</p>
<blockquote>
<p>I like this pattern because you can have variables that are only mutable for the period where the mutability is needed, and then removed to make it unmutable. I was wondering if the compiler also does this in the background.</p>
</blockquote>
<p>Btw, to get that pattern in an even more ligthweight fashion, the <code>.tap_mut()</code>-like patterns (<a href="https://docs.rs/ext-trait/1.0.0/ext_trait/index.html#also">an example called <code>also</code></a>), allow writing:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashMap</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">also</span><span class="p">(</span><span class="o">|</span><span class="n">m</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">m</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">"foo"</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">m</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">"bar"</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">);</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
<span class="c1">// immutable `map`</span>
</code></pre></div>
<p>This, in your case, would give:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">500.</span><span class="n">also</span><span class="p">(</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">something_complicated</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">other_complicated_function</span><span class="p">();</span><span class="w"></span>
<span class="p">});</span><span class="w"></span>
</code></pre></div>



<a name="268398128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Question%20about%20mutability/near/268398128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> hyabean <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Question.20about.20mutability.html#268398128">(Jan 18 2022 at 14:28)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> I checked the assembly code in debug mode, the address of x is different. I know the code may be different in release mode. But I can't understand the assembly code in release mode. Can you explain at what stage did this optimization occur? How can I observe the address without modifying the generated code in release mode?</p>



<a name="268441523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Question%20about%20mutability/near/268441523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Question.20about.20mutability.html#268441523">(Jan 18 2022 at 19:15)</a>:</h4>
<p>Run the program under a debugger and inspect the variables?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>