<html>
<head><meta charset="utf-8"><title>Eliminate dead functions without LTO · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Eliminate.20dead.20functions.20without.20LTO.html">Eliminate dead functions without LTO</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252033784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Eliminate%20dead%20functions%20without%20LTO/near/252033784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Eliminate.20dead.20functions.20without.20LTO.html#252033784">(Sep 04 2021 at 23:27)</a>:</h4>
<p>So, my rustc codegen for making PTX to run rust as gpu kernels works, but i am running into a small issue. LLVM is not eliminating dead functions from core, which means the final ptx file is 10mb on debug (and this is before implementing ptx debug info!) and 12mb on release. How does rustc normally eliminate dead functions like this? does it always run thin/fat LTO just for DCE? or does it do it some other way. A 10mb ptx file is a bit of a problem since the ptx file needs to be shipped with any executable which wants to run the cuda kernel.</p>



<a name="252033995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Eliminate%20dead%20functions%20without%20LTO/near/252033995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Eliminate.20dead.20functions.20without.20LTO.html#252033995">(Sep 04 2021 at 23:31)</a>:</h4>
<p>I believe most dead code removal is done by the linker.  See <code>gc_sections</code> in the linker trait.</p>



<a name="252034159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Eliminate%20dead%20functions%20without%20LTO/near/252034159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Eliminate.20dead.20functions.20without.20LTO.html#252034159">(Sep 04 2021 at 23:34)</a>:</h4>
<p>Yeah that would make sense</p>



<a name="252034170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Eliminate%20dead%20functions%20without%20LTO/near/252034170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Eliminate.20dead.20functions.20without.20LTO.html#252034170">(Sep 04 2021 at 23:35)</a>:</h4>
<p>I basically need to cull any function that is not a kernel function AND is not transiently called by a kernel</p>



<a name="252034268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Eliminate%20dead%20functions%20without%20LTO/near/252034268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Eliminate.20dead.20functions.20without.20LTO.html#252034268">(Sep 04 2021 at 23:37)</a>:</h4>
<p>I guess i could do this myself by just recursively collecting the functions that are called, but that seems like something llvm could do</p>



<a name="252034274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Eliminate%20dead%20functions%20without%20LTO/near/252034274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Eliminate.20dead.20functions.20without.20LTO.html#252034274">(Sep 04 2021 at 23:37)</a>:</h4>
<p>Or maybe once i have ptx parsing set up i can do this on the PTX itself</p>



<a name="252034279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Eliminate%20dead%20functions%20without%20LTO/near/252034279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Eliminate.20dead.20functions.20without.20LTO.html#252034279">(Sep 04 2021 at 23:37)</a>:</h4>
<p>that should be faster</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>