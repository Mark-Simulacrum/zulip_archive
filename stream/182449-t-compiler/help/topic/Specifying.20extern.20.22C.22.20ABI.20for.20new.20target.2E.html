<html>
<head><meta charset="utf-8"><title>Specifying extern &quot;C&quot; ABI for new target. · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Specifying.20extern.20.22C.22.20ABI.20for.20new.20target.2E.html">Specifying extern &quot;C&quot; ABI for new target.</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256583013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Specifying%20extern%20%22C%22%20ABI%20for%20new%20target./near/256583013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Brouwers-Harries <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Specifying.20extern.20.22C.22.20ABI.20for.20new.20target.2E.html#256583013">(Oct 07 2021 at 14:06)</a>:</h4>
<p>Hi again! I have a working compiler for my architecture, built from a fork of LLVM, and I'm attempting to compile parts of the <code>core</code> library so that I can build a very simple  PoC app. Unfortunately, I'm hitting errors (specifically, ICEs) as the rust compiler seems to think that my target doesn't support the <code>extern "C"</code> ABI. </p>
<p>For instance: </p>
<div class="codehilite"><pre><span></span><code>   Compiling core v0.0.0 (/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/src/rust/library/core)
   Compiling rustc-std-workspace-core v1.99.0 (/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/src/rust/library/rustc-std-workspace-core)
   Compiling compiler_builtins v0.1.49
error: internal compiler error: compiler/rustc_codegen_llvm/src/context.rs:889:21: `fn_abi_of_instance(slice::cmp::memcmp, [])` failed: target architecture &quot;dpu&quot; does not support `extern &quot;C&quot;` ABI
  --&gt; /home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage2/lib/rustlib/src/rust/library/core/src/slice/cmp.rs:18:5
   |
18 |     fn memcmp(s1: *const u8, s2: *const u8, n: usize) -&gt; i32;
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

thread &#39;rustc&#39; panicked at &#39;Box&lt;dyn Any&gt;&#39;, /home/aharries/experimental/ruststuff/rust/compiler/rustc_errors/src/lib.rs:1092:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

note: the compiler unexpectedly panicked. this is a bug.

note: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&amp;template=ice.md

note: rustc 1.57.0-dev running on x86_64-unknown-linux-gnu

note: compiler flags: -Z force-unstable-if-unmarked -C embed-bitcode=no -C debuginfo=2 --crate-type lib

note: some of the compiler flags provided by cargo are hidden

query stack during panic:
end of query stack
error: could not compile `core`
warning: build failed, waiting for other jobs to finish...
error: internal compiler error: compiler/rustc_codegen_llvm/src/context.rs:889:21: `fn_abi_of_instance(conv::__floatsisf, [])` failed: target architecture &quot;dpu&quot; does not support `extern &quot;C&quot;` ABI
   --&gt; /home/aharries/.cargo/registry/src/github.com-1ecc6299db9ec823/compiler_builtins-0.1.49/src/macros.rs:278:9
    |
278 |           pub extern $abi fn $name( $($argname: $ty),* ) -&gt; $ret {
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |
   ::: /home/aharries/.cargo/registry/src/github.com-1ecc6299db9ec823/compiler_builtins-0.1.49/src/float/conv.rs:77:1
    |
77  | / intrinsics! {
78  | |     #[arm_aeabi_alias = __aeabi_i2f]
79  | |     pub extern &quot;C&quot; fn __floatsisf(i: i32) -&gt; f32 {
80  | |         int_to_float(i)
...   |
152 | |     }
153 | | }
    | |_- in this macro invocation
    |
    = note: this error: internal compiler error originates in the macro `intrinsics` (in Nightly builds, run with -Z macro-backtrace for more info)

thread &#39;rustc&#39; panicked at &#39;Box&lt;dyn Any&gt;&#39;, /home/aharries/experimental/ruststuff/rust/compiler/rustc_errors/src/lib.rs:1092:9
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

note: the compiler unexpectedly panicked. this is a bug.

note: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&amp;template=ice.md

note: rustc 1.57.0-dev running on x86_64-unknown-linux-gnu

note: compiler flags: -Z force-unstable-if-unmarked -C embed-bitcode=no -C debuginfo=2 --crate-type lib

note: some of the compiler flags provided by cargo are hidden

query stack during panic:
end of query stack
error: build failed
</code></pre></div>
<p>My presumption is that there is one more place (that I have missed) in the compiler where I need to add architecture-specific details, but I'm not sure exactly where that might be, and I've struggled to find anything that I've missed. Any advice would be very welcome!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>