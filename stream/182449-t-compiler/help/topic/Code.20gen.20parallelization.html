<html>
<head><meta charset="utf-8"><title>Code gen parallelization · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html">Code gen parallelization</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251950616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/251950616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Timothy Maloney <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#251950616">(Sep 03 2021 at 22:34)</a>:</h4>
<p>In the dev guide it says that code gen is the only stage of the compiler that is already parallel. Does this mean that code gen is parallel by default in rustc?</p>



<a name="251953022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/251953022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#251953022">(Sep 03 2021 at 23:05)</a>:</h4>
<p>Yes.  The parallelism will depend on the number of codegen units.</p>



<a name="251955485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/251955485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ben Reeves <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#251955485">(Sep 03 2021 at 23:38)</a>:</h4>
<p>Is one codegen unit a crate? Or something smaller like a module?</p>



<a name="251955638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/251955638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#251955638">(Sep 03 2021 at 23:41)</a>:</h4>
<p>Smaller than that, actually. The compiler splits code from modules up into codegen units.</p>



<a name="251955647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/251955647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#251955647">(Sep 03 2021 at 23:41)</a>:</h4>
<p>(As far as I know.)</p>



<a name="251955737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/251955737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#251955737">(Sep 03 2021 at 23:42)</a>:</h4>
<p>I think that's <a href="https://rustc-dev-guide.rust-lang.org/backend/monomorph.html#codegen-unit-cgu-partitioning">https://rustc-dev-guide.rust-lang.org/backend/monomorph.html#codegen-unit-cgu-partitioning</a></p>



<a name="251955760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/251955760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#251955760">(Sep 03 2021 at 23:43)</a>:</h4>
<p>Long-term, it would be great to push parallelism all the way down into LLVM, so that CGUs aren't required, but that would be a very long-term project and much more difficult than making the rest of the rust compiler parallel.</p>



<a name="251955780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/251955780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#251955780">(Sep 03 2021 at 23:43)</a>:</h4>
<p>Short-term, the parallel rustc effort doesn't need to change the CGU handling, it just needs to make the rest of the compiler parallel.</p>



<a name="251955857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/251955857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#251955857">(Sep 03 2021 at 23:44)</a>:</h4>
<p>do you happen to know exactly what is being made parallel? I heard that the query system is involved somehow, but doesn't it still have to invoke each query in sequence to find what its dependencies are?</p>



<a name="251956437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/251956437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#251956437">(Sep 03 2021 at 23:54)</a>:</h4>
<p>Yes but some queries do some work in a loop and you can parallelize that. Once you've started that parallelization, each thread of execution runs serially but overall the system is running different queries in parallel.</p>



<a name="252034949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/252034949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#252034949">(Sep 04 2021 at 23:50)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I dont really see how thats possible <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> , is it really llvm's job to understand what functions should be grouped together? I think rustc deciding will always be better because it actually logically knows what is together. And cg_llvm doesnt only do llvm stuff in parallel for CGUs, so i think CGUs will always be required</p>



<a name="252089155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/252089155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#252089155">(Sep 05 2021 at 17:12)</a>:</h4>
<p><span class="user-mention" data-user-id="276242">@Riccardo D'Ambrosio</span> That's not what I mean. It still makes sense for rustc to decide what work goes on what thread. But in theory, LLVM could share state, such as only needing one copy of inline-able functions rather than one copy per CGU, and in general not duplicating work or requiring duplication of code.</p>



<a name="252095625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Code%20gen%20parallelization/near/252095625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Code.20gen.20parallelization.html#252095625">(Sep 05 2021 at 19:10)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> ah i understand, yeah that would be great, perhaps also being able to do more without strictly relying on LTO</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>