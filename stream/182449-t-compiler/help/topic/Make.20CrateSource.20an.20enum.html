<html>
<head><meta charset="utf-8"><title>Make CrateSource an enum · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20CrateSource.20an.20enum.html">Make CrateSource an enum</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256503486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20CrateSource%20an%20enum/near/256503486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20CrateSource.20an.20enum.html#256503486">(Oct 07 2021 at 00:07)</a>:</h4>
<p>While working on <a href="https://github.com/rust-lang/rust/issues/89587">#89587</a>, I noticed that <code>CrateSource</code> is a struct where each field is an <code>Option</code>, and according to the docs, one (or at least one, I'm unsure which) has to be <code>Some</code>. That made me wonder if <code>CrateSource</code> could be made into an enum. To that end, I opened <a href="https://github.com/rust-lang/rust/issues/89613">#89613</a> as an experiment, mostly because I'm curious if it could work.</p>
<p>CI failed on that PR while building stage1 std with this error:</p>
<div class="codehilite"><pre><span></span><code>error: crate `rustc_std_workspace_core` required to be available in rlib format, but was not found in this form

error: crate `cfg_if` required to be available in rlib format, but was not found in this form

error: crate `rustc_std_workspace_alloc` required to be available in rlib format, but was not found in this form

error: crate `gimli` required to be available in rlib format, but was not found in this form

error: crate `memchr` required to be available in rlib format, but was not found in this form

error: crate `adler` required to be available in rlib format, but was not found in this form

error: could not compile `std` due to 6 previous errors
</code></pre></div>
<p>I'm guessing this is because after my change the loader finds an rmeta and stops early instead of loading the rlib too. There's a comment in the loader saying:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// Order here matters, rmeta should come first. See comment in</span>
<span class="c1">// `extract_one` below.</span>
</code></pre></div>
<p>I looked at the comment it references, but it was a bit over my head. Why is it that rmeta files should be loaded first?</p>
<p>And, would it be reasonable to make <code>CrateSource</code> an enum, or does it have to allow multiple sources (rlib, rmeta, and dylib)?</p>
<p>Thanks! Mostly I'm experimenting with this just because I'm curious about metadata loading :)</p>



<a name="256505021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20CrateSource%20an%20enum/near/256505021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20CrateSource.20an.20enum.html#256505021">(Oct 07 2021 at 00:24)</a>:</h4>
<p><span class="user-mention" data-user-id="307537">@Noah Lev</span> it probably has something to do with pipelined compilation</p>



<a name="256505034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20CrateSource%20an%20enum/near/256505034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20CrateSource.20an.20enum.html#256505034">(Oct 07 2021 at 00:24)</a>:</h4>
<p>Ah, interesting.</p>



<a name="256505035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20CrateSource%20an%20enum/near/256505035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20CrateSource.20an.20enum.html#256505035">(Oct 07 2021 at 00:24)</a>:</h4>
<p><a href="https://github.com/rust-lang/cargo/issues/6660">https://github.com/rust-lang/cargo/issues/6660</a></p>



<a name="256505065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20CrateSource%20an%20enum/near/256505065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20CrateSource.20an.20enum.html#256505065">(Oct 07 2021 at 00:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Make.20CrateSource.20an.20enum/near/256505021">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="307537">Noah Lev</span> it probably has something to do with pipelined compilation</p>
</blockquote>
<p>By "it", do you mean the comment I referenced?</p>



<a name="256505410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20CrateSource%20an%20enum/near/256505410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20CrateSource.20an.20enum.html#256505410">(Oct 07 2021 at 00:29)</a>:</h4>
<blockquote>
<p>Why is it that rmeta files should be loaded first?</p>
</blockquote>
<p>^ this is what I meant by "it"</p>



<a name="256505602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20CrateSource%20an%20enum/near/256505602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20CrateSource.20an.20enum.html#256505602">(Oct 07 2021 at 00:31)</a>:</h4>
<p>Ok, that's what I thought. Thanks, pipelined compilation as the cause sounds reasonable.</p>



<a name="256505756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20CrateSource%20an%20enum/near/256505756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20CrateSource.20an.20enum.html#256505756">(Oct 07 2021 at 00:33)</a>:</h4>
<p>Looks like <a href="https://github.com/rust-lang/rust/commit/4bb68828de9c424c572a7ec11417660478ca7501">4bb68828de9c424c572a7ec11417660478ca7501</a> added that comment (and behavior), so it seems like pipelined compilation is definitely related.</p>



<a name="256544862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20CrateSource%20an%20enum/near/256544862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20CrateSource.20an.20enum.html#256544862">(Oct 07 2021 at 09:01)</a>:</h4>
<p><code>CrateSource</code> is certainly not an enum.<br>
Yes, at least one of the fields must be <code>Some</code>, but two (or three) of them can also be <code>Some</code> if a library is found in both rlib and dylib (and rmeta) flavors.</p>



<a name="256625902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Make%20CrateSource%20an%20enum/near/256625902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Make.20CrateSource.20an.20enum.html#256625902">(Oct 07 2021 at 18:26)</a>:</h4>
<p>Well, at least it was an interesting experiment. Now I know more about metadata loading <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>