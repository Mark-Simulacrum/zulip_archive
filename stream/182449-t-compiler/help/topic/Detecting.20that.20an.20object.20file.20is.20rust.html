<html>
<head><meta charset="utf-8"><title>Detecting that an object file is rust · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html">Detecting that an object file is rust</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251650759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251650759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Xu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251650759">(Sep 02 2021 at 00:48)</a>:</h4>
<p>Hi, I'm hacking on some of the rust-for-linux project. I'm trying to fix an issue where kbuild (kernel build system) tries to generate metadata (BTF) from DWARF. However, it only works for C -- not rust. I'm going to teach the build system to skip BTF generation for rust modules. </p>
<p>Is it possible to detect if an object file is built from rust code? Alternatively I could add some magic symbol into the symbol table.</p>



<a name="251651205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251651205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251651205">(Sep 02 2021 at 00:54)</a>:</h4>
<p>One way would be check if it contains symbols mangled in Rust mangling scheme.</p>



<a name="251651252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251651252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251651252">(Sep 02 2021 at 00:55)</a>:</h4>
<p>rust-for-linux uses v0 mangling scheme so basically just check if any symbol starts with <code>_R</code></p>



<a name="251653380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251653380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Xu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251653380">(Sep 02 2021 at 01:27)</a>:</h4>
<p>Hmm, could work, but nothing stops a module from having a function called <code>_RemoveFoo</code> or something</p>



<a name="251653761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251653761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251653761">(Sep 02 2021 at 01:33)</a>:</h4>
<p>Well, technically that's not allowed since underscore followed by a capital letter is a reserved identifier in C.</p>



<a name="251653815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251653815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251653815">(Sep 02 2021 at 01:34)</a>:</h4>
<p>But if you want to guard against that you can try to demangle it with Rust mangling scheme, and only count as Rust symbol if it demangles.</p>



<a name="251654075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251654075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Xu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251654075">(Sep 02 2021 at 01:38)</a>:</h4>
<p>A 3rd alternative is add a 1 byte note (eg <code>ELFNOTE</code>) . This is pretty easy to do in the <code>module!</code> macro and has the advantage of being easily checked in non-rust parts of the codebase</p>



<a name="251654117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251654117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Xu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251654117">(Sep 02 2021 at 01:39)</a>:</h4>
<p>Good point about the reserved identifier, though</p>



<a name="251654183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251654183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Xu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251654183">(Sep 02 2021 at 01:40)</a>:</h4>
<p>(Although I'm guessing that restriction does not exist for assembly)</p>



<a name="251654383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251654383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251654383">(Sep 02 2021 at 01:43)</a>:</h4>
<p>I think it'll be sufficient in practice to check the third character for a symbol starting with <code>_R</code>. In v0 mangling scheme it'll be decimal number of a capital letter.</p>



<a name="251657656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251657656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Xu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251657656">(Sep 02 2021 at 02:35)</a>:</h4>
<p>Ok, I'll give that a try</p>



<a name="251665445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251665445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251665445">(Sep 02 2021 at 04:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="316820">Daniel Xu</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Detecting.20that.20an.20object.20file.20is.20rust/near/251650759">said</a>:</p>
<blockquote>
<p>Hi, I'm hacking on some of the rust-for-linux project. I'm trying to fix an issue where kbuild (kernel build system) tries to generate metadata (BTF) from DWARF. However, it only works for C -- not rust. I'm going to teach the build system to skip BTF generation for rust modules. </p>
<p>Is it possible to detect if an object file is built from rust code? Alternatively I could add some magic symbol into the symbol table.</p>
</blockquote>
<p>I'm curious, why does BTF generation fail?</p>



<a name="251665488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251665488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251665488">(Sep 02 2021 at 04:46)</a>:</h4>
<p>Because ideally that's something that should be possible to do.</p>



<a name="251672095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251672095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251672095">(Sep 02 2021 at 06:35)</a>:</h4>
<p>BTF seems to not support enums with data (tagged unions).</p>



<a name="251672329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251672329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251672329">(Sep 02 2021 at 06:39)</a>:</h4>
<p>In any case I think it makes sense to skip rust object files as rust emits debuginfo for various internal datastructures like vtables and trait objects where not just the field offsets, but also the complete format is unstable. By not emitting BTF for them it becomes harder for BPF programs to depend on these implementation details. Another hard thing would be niche filling. I don't think a BPF program can switch between the tagged and niche filling layout of an enum at load time.</p>



<a name="251682414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251682414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251682414">(Sep 02 2021 at 08:32)</a>:</h4>
<p>Doesn't rust always generate <code>rust_begin_unwind</code> as a symbol? can't you check for that? Although i am not certain if it always makes it and if its going to be in every object file, my intuition says it wont make it for every object file</p>



<a name="251692638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251692638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251692638">(Sep 02 2021 at 10:07)</a>:</h4>
<p>That symbol is only defined in a single object file and declared in other object files only when a panicking function exists.</p>



<a name="251739462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251739462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Xu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251739462">(Sep 02 2021 at 16:03)</a>:</h4>
<p>Right, BTF only understands C constructs. To actually support rust, we would most likely need to change BTF spec and teach rest of the ecosystem about rust. Not impossible but unlikely to be well received at the moment.</p>



<a name="251739684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251739684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Xu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251739684">(Sep 02 2021 at 16:04)</a>:</h4>
<p>(I pitched a similar idea for C++)</p>



<a name="251747460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251747460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251747460">(Sep 02 2021 at 16:54)</a>:</h4>
<p>Would it make sense to generate BTF for <code>#[repr(C)]</code> structs and ignore <code>#[repr(Rust)]</code> ones?</p>



<a name="251762262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/251762262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Xu <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#251762262">(Sep 02 2021 at 18:23)</a>:</h4>
<p>Assuming there's enough info in DWARF to know which structs are <code>#[repr(C)]</code>, maybe, maybe not. I'm not sure how the verifier would like only knowing about _some_ types. </p>
<p>If it's something that would be useful to do, we can bring it up in bpf list and see what people think.</p>



<a name="252003839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/252003839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#252003839">(Sep 04 2021 at 14:17)</a>:</h4>
<p>What about the .note.rustc section?</p>



<a name="252007882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Detecting%20that%20an%20object%20file%20is%20rust/near/252007882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Detecting.20that.20an.20object.20file.20is.20rust.html#252007882">(Sep 04 2021 at 15:26)</a>:</h4>
<p>The <code>.rustc</code> section only exists in dylibs, not object files.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>