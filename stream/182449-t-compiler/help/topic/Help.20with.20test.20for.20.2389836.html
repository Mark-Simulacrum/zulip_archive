<html>
<head><meta charset="utf-8"><title>Help with test for #89836 · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html">Help with test for #89836</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260013414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260013414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260013414">(Nov 02 2021 at 15:38)</a>:</h4>
<p>Maybe this has something to do with the stages involved here? <span class="user-mention" data-user-id="116122">@simulacrum</span> If you have a chance, could you look at this attempt to build and run a dylib in a test? (Your post <a href="https://github.com/rust-lang/rustc-dev-guide/pull/1239#discussion_r735162039">here</a> made me think of this..)</p>



<a name="260014194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260014194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260014194">(Nov 02 2021 at 15:43)</a>:</h4>
<p>RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER is going to affect upstream crates as well, I'd expect, which means they likely can't be found -- probably the code around that isn't expecting stable crate IDs to be shifting from what's on disk? I think it will be difficult to write this test such that it works as you want it to, and I don't personally have the bandwidth to help with that in a direct way.</p>



<a name="260015860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260015860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260015860">(Nov 02 2021 at 15:53)</a>:</h4>
<p>No problem! Thanks for looking. <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="260161850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260161850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260161850">(Nov 03 2021 at 16:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Help.20with.20test.20for.20.2389836/near/260014194">said</a>:</p>
<blockquote>
<p>RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER is going to affect upstream crates as well, I'd expect, which means they likely can't be found -- probably the code around that isn't expecting stable crate IDs to be shifting from what's on disk? I think it will be difficult to write this test such that it works as you want it to, and I don't personally have the bandwidth to help with that in a direct way.</p>
</blockquote>
<p>@bjorn3 Have any thoughts on how to proceed here?</p>



<a name="260162130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260162130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260162130">(Nov 03 2021 at 16:44)</a>:</h4>
<p>I don't think <code>RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER</code> affects upstream crates. As of your PR it will only affect the incremental compilation cache (not used in this case) and the <code>StableCrateId</code> calculation of the current crate. The <code>StableCrateId</code> of upstream crates is stored in the metadata and we don't store all information necessary to recalculate it anyway. (<code>-Cmetadata</code> arguments are not stored in the metadata)</p>



<a name="260162273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260162273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260162273">(Nov 03 2021 at 16:45)</a>:</h4>
<p>The error seems to happen for the <code>$(RUSTC) b.rs --extern a --crate-type=bin # b.rs is bin</code> call before <code>RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER</code> is used.</p>



<a name="260162748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260162748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260162748">(Nov 03 2021 at 16:49)</a>:</h4>
<p>Can you try</p>
<div class="codehilite" data-code-language="Makefile"><pre><span></span><code><span class="cp">-include ../../run-make-fulldeps/tools.mk</span>

<span class="nf">all</span><span class="o">:</span>
    <span class="k">$(</span>RUSTC<span class="k">)</span> a.rs --crate-type<span class="o">=</span>dylib -o <span class="k">$(</span>TMPDIR<span class="k">)</span>/liba.dylib <span class="c1"># a.rs is a dylib</span>
    <span class="k">$(</span>RUSTC<span class="k">)</span> b.rs --extern <span class="nv">a</span><span class="o">=</span><span class="k">$(</span>TMPDIR<span class="k">)</span>/liba.dylib --crate-type<span class="o">=</span>bin -Crpath <span class="c1"># b.rs is bin</span>
    <span class="k">$(</span>call RUN, b<span class="k">)</span>
<span class="c">    # Now re-compile a with another rustc version</span>
    <span class="nv">RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER</span><span class="o">=</span>bar <span class="k">$(</span>RUSTC<span class="k">)</span> a.rs --crate-type<span class="o">=</span>dylib -o <span class="k">$(</span>TMPDIR<span class="k">)</span>/liba.dylib
<span class="c">    # Verify that this fails to find symbols</span>
    <span class="k">$(</span>call RUN, b<span class="k">)</span>
</code></pre></div>



<a name="260174457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260174457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260174457">(Nov 03 2021 at 18:10)</a>:</h4>
<p>Trying now <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="260176444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260176444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260176444">(Nov 03 2021 at 18:25)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span>: With the Makefile as above, I'm getting:</p>
<div class="codehilite"><pre><span></span><code>---- [run-make] run-make/crate-hash-rustc-version stdout ----

error: make failed
status: exit status: 2
command: &quot;make&quot;
stdout:
------------------------------------------
DYLD_LIBRARY_PATH=&quot;/Users/wpierce/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version:/Users/wpierce/repos/rust/build/x86_64-apple-darwin/stage1/lib:&quot; &#39;/Users/wpierce/repos/rust/build/x86_64-apple-darwin/stage1/bin/rustc&#39; --out-dir /Users/wpierce/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version -L /Users/wpierce/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version  a.rs --crate-type=dylib -o /Users/wpierce/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/liba.dylib # a.rs is a dylib
DYLD_LIBRARY_PATH=&quot;/Users/wpierce/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version:/Users/wpierce/repos/rust/build/x86_64-apple-darwin/stage1/lib:&quot; &#39;/Users/wpierce/repos/rust/build/x86_64-apple-darwin/stage1/bin/rustc&#39; --out-dir /Users/wpierce/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version -L /Users/wpierce/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version  b.rs --extern a=/Users/wpierce/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/liba.dylib --crate-type=bin -Crpath # b.rs is bin

------------------------------------------
stderr:
------------------------------------------
warning: ignoring --out-dir flag due to -o flag

warning: 1 warning emitted

error: cannot satisfy dependencies so `std` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `core` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `compiler_builtins` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `rustc_std_workspace_core` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `alloc` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `libc` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `unwind` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `cfg_if` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `hashbrown` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `rustc_std_workspace_alloc` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `rustc_demangle` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `std_detect` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `addr2line` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `gimli` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `object` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `memchr` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: cannot satisfy dependencies so `panic_unwind` only shows up once
  |
  = help: having upstream crates all available in one format will likely make this go away

error: aborting due to 17 previous errors

make: *** [all] Error 1

------------------------------------------



failures:
    [run-make] run-make/crate-hash-rustc-version

test result: FAILED. 0 passed; 1 failed; 43 ignored; 0 measured; 0 filtered out; finished in 1.81s
</code></pre></div>



<a name="260177170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260177170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260177170">(Nov 03 2021 at 18:30)</a>:</h4>
<p>Is it possible we need to specify -Z v0 mangling somewhere?</p>



<a name="260177272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260177272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260177272">(Nov 03 2021 at 18:31)</a>:</h4>
<p>This has nothing to do with the symbol mangling. Somehow the metadata loader thinks it needs multiple versions of the sysroot crate.</p>



<a name="260177572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260177572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260177572">(Nov 03 2021 at 18:33)</a>:</h4>
<p>This got me really confused.</p>



<a name="260177758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260177758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260177758">(Nov 03 2021 at 18:34)</a>:</h4>
<p>I can locally reproduce it.</p>



<a name="260177885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260177885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260177885">(Nov 03 2021 at 18:35)</a>:</h4>
<div class="codehilite"><pre><span></span><code> INFO rustc_metadata::dependency_format adding dylib: std
 INFO rustc_metadata::dependency_format adding RequireStatic: core
 INFO rustc_metadata::dependency_format adding RequireStatic: compiler_builtins
 INFO rustc_metadata::dependency_format adding RequireStatic: rustc_std_workspace_core
 INFO rustc_metadata::dependency_format adding RequireStatic: alloc
 INFO rustc_metadata::dependency_format adding RequireStatic: libc
 INFO rustc_metadata::dependency_format adding RequireStatic: unwind
 INFO rustc_metadata::dependency_format adding RequireStatic: cfg_if
 INFO rustc_metadata::dependency_format adding RequireStatic: hashbrown
 INFO rustc_metadata::dependency_format adding RequireStatic: rustc_std_workspace_alloc
 INFO rustc_metadata::dependency_format adding RequireStatic: rustc_demangle
 INFO rustc_metadata::dependency_format adding RequireStatic: std_detect
 INFO rustc_metadata::dependency_format adding RequireStatic: addr2line
 INFO rustc_metadata::dependency_format adding RequireStatic: gimli
 INFO rustc_metadata::dependency_format adding RequireStatic: object
 INFO rustc_metadata::dependency_format adding RequireStatic: memchr
 INFO rustc_metadata::dependency_format adding RequireStatic: miniz_oxide
 INFO rustc_metadata::dependency_format adding RequireStatic: adler
 INFO rustc_metadata::dependency_format adding RequireStatic: panic_unwind
 INFO rustc_metadata::dependency_format adding dylib: a
 INFO rustc_metadata::dependency_format adding RequireStatic: std
</code></pre></div>
<p>Why does it add all sysroot crates ad <code>RequireStatic</code>?</p>



<a name="260178041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260178041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260178041">(Nov 03 2021 at 18:36)</a>:</h4>
<p>Passing <code>-Cprefer-dynamic</code> to all rustc invocations seems to fix it though.</p>



<a name="260178278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260178278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260178278">(Nov 03 2021 at 18:38)</a>:</h4>
<p>Trying with -Cprefer-dynamic now...</p>



<a name="260179350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260179350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260179350">(Nov 03 2021 at 18:46)</a>:</h4>
<p>I get this on my machine:</p>
<div class="codehilite"><pre><span></span><code>rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/: Permission denied
</code></pre></div>



<a name="260179375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260179375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260179375">(Nov 03 2021 at 18:46)</a>:</h4>
<p>maybe a chmod will fix?</p>



<a name="260179680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260179680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260179680">(Nov 03 2021 at 18:48)</a>:</h4>
<p>What is the content of that directory?</p>



<a name="260179740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260179740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260179740">(Nov 03 2021 at 18:49)</a>:</h4>
<div class="codehilite"><pre><span></span><code>b*
liba.dylib*
</code></pre></div>



<a name="260179825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260179825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260179825">(Nov 03 2021 at 18:50)</a>:</h4>
<p>What is the full <code>Makefile</code> you have right now?</p>



<a name="260179883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260179883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260179883">(Nov 03 2021 at 18:50)</a>:</h4>
<div class="codehilite"><pre><span></span><code>-include ../../run-make-fulldeps/tools.mk

all:
    # a.rs is a dylib
    $(RUSTC) a.rs --crate-type=dylib -o $(TMPDIR)/liba.dylib -Cprefer-dynamic
    # b.rs is bin
    $(RUSTC) b.rs --extern a=$(TMPDIR)/liba.dylib --crate-type=bin -Crpath -Cprefer-dynamic
    $(call RUN, b)
    # Now re-compile a with another rustc version
    RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER=bar $(RUSTC) a.rs --crate-type=dylib -o $(TMPDIR)/liba.dylib -Cprefer-dynamic
    # Verify that this fails to find symbols
    $(call RUN, b)
</code></pre></div>



<a name="260180048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260180048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260180048">(Nov 03 2021 at 18:51)</a>:</h4>
<p>What does it say before the error line?</p>



<a name="260180171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260180171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260180171">(Nov 03 2021 at 18:52)</a>:</h4>
<div class="codehilite"><pre><span></span><code>---- [run-make] run-make/crate-hash-rustc-version stdout ----

error: make failed
status: exit status: 2
command: &quot;make&quot;
stdout:
------------------------------------------
# a.rs is a dylib
DYLD_LIBRARY_PATH=&quot;/Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version:/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/lib:&quot; &#39;/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/bin/rustc&#39; --out-dir /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version -L /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version  a.rs --crate-type=dylib -o /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/liba.dylib -Cprefer-dynamic
# b.rs is bin
DYLD_LIBRARY_PATH=&quot;/Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version:/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/lib:&quot; &#39;/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/bin/rustc&#39; --out-dir /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version -L /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version  b.rs --extern a=/Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/liba.dylib --crate-type=bin -Crpath -Cprefer-dynamic
DYLD_LIBRARY_PATH=&quot;/Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version:/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/lib/rustlib/x86_64-apple-darwin/lib:&quot; /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/ b

------------------------------------------
stderr:
------------------------------------------
warning: ignoring --out-dir flag due to -o flag

warning: 1 warning emitted

/bin/dash: 1: /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/: Permission denied
make: *** [all] Error 126

------------------------------------------



failures:
    [run-make] run-make/crate-hash-rustc-version
</code></pre></div>



<a name="260180279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260180279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260180279">(Nov 03 2021 at 18:53)</a>:</h4>
<p>Try <code>$(call RUN,b)</code> without space after the comma.</p>



<a name="260180343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260180343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260180343">(Nov 03 2021 at 18:53)</a>:</h4>
<p>okay</p>



<a name="260180378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260180378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260180378">(Nov 03 2021 at 18:53)</a>:</h4>
<p>okay it worked. it <em>passed</em></p>



<a name="260180497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260180497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260180497">(Nov 03 2021 at 18:54)</a>:</h4>
<p>For the second <code>$(call RUN,b)</code> you can do <code>$(call FAIL,b)</code> I think to test that it fails.</p>



<a name="260180649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260180649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260180649">(Nov 03 2021 at 18:55)</a>:</h4>
<div class="codehilite"><pre><span></span><code>---- [run-make] run-make/crate-hash-rustc-version stdout ----

error: make failed
status: exit status: 2
command: &quot;make&quot;
stdout:
------------------------------------------
# a.rs is a dylib
DYLD_LIBRARY_PATH=&quot;/Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version:/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/lib:&quot; &#39;/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/bin/rustc&#39; --out-dir /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version -L /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version  a.rs --crate-type=dylib -o /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/liba.dylib -Cprefer-dynamic
# b.rs is bin
DYLD_LIBRARY_PATH=&quot;/Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version:/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/lib:&quot; &#39;/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/bin/rustc&#39; --out-dir /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version -L /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version  b.rs --extern a=/Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/liba.dylib --crate-type=bin -Crpath -Cprefer-dynamic
DYLD_LIBRARY_PATH=&quot;/Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version:/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/lib/rustlib/x86_64-apple-darwin/lib:&quot; /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/b
Hello
# Now re-compile a with another rustc version
RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER=bar DYLD_LIBRARY_PATH=&quot;/Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version:/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/lib:&quot; &#39;/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/bin/rustc&#39; --out-dir /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version -L /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version  a.rs --crate-type=dylib -o /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/liba.dylib -Cprefer-dynamic
# Verify that this fails to find symbols
DYLD_LIBRARY_PATH=&quot;/Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version:/Users/user/repos/rust/build/x86_64-apple-darwin/stage1/lib/rustlib/x86_64-apple-darwin/lib:&quot; /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/b &amp;&amp; exit 1 || exit 0
Hello

------------------------------------------
stderr:
------------------------------------------
warning: ignoring --out-dir flag due to -o flag

warning: 1 warning emitted

warning: ignoring --out-dir flag due to -o flag

warning: 1 warning emitted

make: *** [all] Error 1

------------------------------------------



failures:
    [run-make] run-make/crate-hash-rustc-version

test result: FAILED. 0 passed; 1 failed; 43 ignored; 0 measured; 0 filtered out; finished in 1.75s

Some tests failed in compiletest suite=run-make mode=run-make host=x86_64-apple-darwin target=x86_64-apple-darwin
</code></pre></div>



<a name="260180796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260180796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260180796">(Nov 03 2021 at 18:56)</a>:</h4>
<p>That output is with <code>($call FAIL,b)</code></p>



<a name="260180917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260180917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260180917">(Nov 03 2021 at 18:57)</a>:</h4>
<p>I will be afk for a bit. You can try using <code>nm -D /Users/user/repos/rust/build/x86_64-apple-darwin/test/run-make/crate-hash-rustc-version/crate-hash-rustc-version/liba.dylib</code> before and after the recompilation of liba to see if the symbol name changes.</p>



<a name="260180938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260180938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260180938">(Nov 03 2021 at 18:57)</a>:</h4>
<p>Okay. Thank you!</p>



<a name="260194616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260194616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260194616">(Nov 03 2021 at 20:40)</a>:</h4>
<p>I think I got it... <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span>  <a href="https://github.com/rust-lang/rust/blob/b3659cfbcfe3cc2e0380f84e591fb2bff2c01ebc/src/test/run-make/crate-hash-rustc-version/Makefile">https://github.com/rust-lang/rust/blob/b3659cfbcfe3cc2e0380f84e591fb2bff2c01ebc/src/test/run-make/crate-hash-rustc-version/Makefile</a></p>



<a name="260212932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260212932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260212932">(Nov 03 2021 at 23:47)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> I think it got it working :)</p>



<a name="260305396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20with%20test%20for%20%2389836/near/260305396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20with.20test.20for.20.2389836.html#260305396">(Nov 04 2021 at 17:23)</a>:</h4>
<p>We're almost there....</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>