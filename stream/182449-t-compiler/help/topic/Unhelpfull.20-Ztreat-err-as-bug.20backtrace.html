<html>
<head><meta charset="utf-8"><title>Unhelpfull -Ztreat-err-as-bug backtrace · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unhelpfull.20-Ztreat-err-as-bug.20backtrace.html">Unhelpfull -Ztreat-err-as-bug backtrace</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254562417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Unhelpfull%20-Ztreat-err-as-bug%20backtrace/near/254562417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nixon Enraght-Moony <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unhelpfull.20-Ztreat-err-as-bug.20backtrace.html#254562417">(Sep 23 2021 at 16:16)</a>:</h4>
<p>I'm trying to improve the diagnostic for illformed <code>macro_rules! ident</code>.</p>
<p>However when using <code>-Ztreat-err-as-bug</code>,  the backtrace seemingly doesnt include the parser code. </p>
<p><code>RUST_BACKTRACE=1 rustc +stage1 foo.rs -Ztreat-err-as-bug</code></p>
<div class="codehilite"><pre><span></span><code>error: expected one of `(`, `[`, or `{`, found `!`
 --&gt; foo.rs:1:17
  |
1 | macro_rules! foo! {}
  |                 ^ expected one of `(`, `[`, or `{`

thread &#39;rustc&#39; panicked at &#39;aborting due to `-Z treat-err-as-bug=1`&#39;, compiler/rustc_errors/src/lib.rs:1181:27
stack backtrace:
   0: rust_begin_unwind
             at /home/nixon/upstreams/rust/rust/library/std/src/panicking.rs:517:5
   1: core::panicking::panic_fmt
             at /home/nixon/upstreams/rust/rust/library/core/src/panicking.rs:100:14
   2: rustc_errors::HandlerInner::panic_if_treat_err_as_bug
   3: rustc_errors::HandlerInner::bump_err_count
             at /home/nixon/upstreams/rust/rust/compiler/rustc_errors/src/lib.rs:1171:9
   4: rustc_errors::HandlerInner::emit_diagnostic
             at /home/nixon/upstreams/rust/rust/compiler/rustc_errors/src/lib.rs:981:13
   5: rustc_errors::Handler::emit_diagnostic
             at /home/nixon/upstreams/rust/rust/compiler/rustc_errors/src/lib.rs:894:9
   6: rustc_errors::diagnostic_builder::DiagnosticBuilder::emit
             at /home/nixon/upstreams/rust/rust/compiler/rustc_errors/src/diagnostic_builder.rs:103:9
   7: rustc_interface::queries::Queries::parse::{{closure}}::{{closure}}
             at /home/nixon/upstreams/rust/rust/compiler/rustc_interface/src/queries.rs:126:17
   8: core::result::Result&lt;T,E&gt;::map_err
             at /home/nixon/upstreams/rust/rust/library/core/src/result.rs:853:27
   9: rustc_interface::queries::Queries::parse::{{closure}}
             at /home/nixon/upstreams/rust/rust/compiler/rustc_interface/src/queries.rs:125:13
  10: rustc_interface::queries::Query&lt;T&gt;::compute
             at /home/nixon/upstreams/rust/rust/compiler/rustc_interface/src/queries.rs:38:28
  11: rustc_driver::run_compiler::{{closure}}::{{closure}}
             at /home/nixon/upstreams/rust/rust/compiler/rustc_driver/src/lib.rs:314:13
  12: rustc_interface::queries::&lt;impl rustc_interface::interface::Compiler&gt;::enter
             at /home/nixon/upstreams/rust/rust/compiler/rustc_interface/src/queries.rs:390:19
  13: rustc_driver::run_compiler::{{closure}}
             at /home/nixon/upstreams/rust/rust/compiler/rustc_driver/src/lib.rs:312:22
  14: rustc_interface::interface::create_compiler_and_run::{{closure}}
             at /home/nixon/upstreams/rust/rust/compiler/rustc_interface/src/interface.rs:209:13
  15: rustc_span::with_source_map
             at /home/nixon/upstreams/rust/rust/compiler/rustc_span/src/lib.rs:976:5
  16: rustc_interface::interface::create_compiler_and_run
             at /home/nixon/upstreams/rust/rust/compiler/rustc_interface/src/interface.rs:203:5
  17: rustc_interface::interface::run_compiler::{{closure}}
             at /home/nixon/upstreams/rust/rust/compiler/rustc_interface/src/interface.rs:225:12
  18: rustc_interface::util::setup_callbacks_and_run_in_thread_pool_with_globals::{{closure}}::{{closure}}
             at /home/nixon/upstreams/rust/rust/compiler/rustc_interface/src/util.rs:158:13
  19: scoped_tls::ScopedKey&lt;T&gt;::set
             at /home/nixon/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:137:9
  20: rustc_span::create_session_globals_then
             at /home/nixon/upstreams/rust/rust/compiler/rustc_span/src/lib.rs:109:5
  21: rustc_interface::util::setup_callbacks_and_run_in_thread_pool_with_globals::{{closure}}
             at /home/nixon/upstreams/rust/rust/compiler/rustc_interface/src/util.rs:156:9
  22: rustc_interface::util::scoped_thread::{{closure}}
             at /home/nixon/upstreams/rust/rust/compiler/rustc_interface/src/util.rs:131:24
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.

error: internal compiler error: unexpected panic

note: the compiler unexpectedly panicked. this is a bug.

note: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&amp;template=ice.md

note: rustc 1.57.0-dev running on x86_64-unknown-linux-gnu

note: compiler flags: -Z treat-err-as-bug

query stack during panic:
end of query stack
</code></pre></div>
<p>Is their a way to figure out where I need to go from this? Or am I missing something?</p>



<a name="254571539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Unhelpfull%20-Ztreat-err-as-bug%20backtrace/near/254571539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unhelpfull.20-Ztreat-err-as-bug.20backtrace.html#254571539">(Sep 23 2021 at 17:18)</a>:</h4>
<p><span class="user-mention" data-user-id="268539">@Nixon Enraght-Moony</span> is the closure in rustc_interface/queries.rs the one you're looking for? This looks like some function is returning a result before the diagnostic is emitted</p>



<a name="254571601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Unhelpfull%20-Ztreat-err-as-bug%20backtrace/near/254571601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unhelpfull.20-Ztreat-err-as-bug.20backtrace.html#254571601">(Sep 23 2021 at 17:19)</a>:</h4>
<p>(line 126, 7th frame)</p>



<a name="254571891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Unhelpfull%20-Ztreat-err-as-bug%20backtrace/near/254571891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nixon Enraght-Moony <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unhelpfull.20-Ztreat-err-as-bug.20backtrace.html#254571891">(Sep 23 2021 at 17:21)</a>:</h4>
<p>So the backtrace only shows where the error is emited, which is not where the error was constructed in this case, right?</p>



<a name="254572317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Unhelpfull%20-Ztreat-err-as-bug%20backtrace/near/254572317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unhelpfull.20-Ztreat-err-as-bug.20backtrace.html#254572317">(Sep 23 2021 at 17:23)</a>:</h4>
<p>Correct, this is a panic backtrace, not an error backtrace</p>



<a name="254574051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Unhelpfull%20-Ztreat-err-as-bug%20backtrace/near/254574051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unhelpfull.20-Ztreat-err-as-bug.20backtrace.html#254574051">(Sep 23 2021 at 17:35)</a>:</h4>
<blockquote>
<p>I'm trying to improve the diagnostic for illformed macro_rules! ident.</p>
<p>However when using -Ztreat-err-as-bug, the backtrace seemingly doesnt include the parser code. </p>
</blockquote>
<p>I'd recommend just searching for <code>MacroDef</code> in <code>compiler/rustc_parse</code>; that should bring up all the places where <code>macro_rules!</code> items are created, and then you can find where they're parsed.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>