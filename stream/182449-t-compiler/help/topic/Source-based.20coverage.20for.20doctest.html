<html>
<head><meta charset="utf-8"><title>Source-based coverage for doctest · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html">Source-based coverage for doctest</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="218937061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/218937061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#218937061">(Dec 05 2020 at 14:21)</a>:</h4>
<p>Hi all, I've been playing with the somewhat recently announced source-based code coverage (<a href="https://doc.rust-lang.org/nightly/unstable-book/compiler-flags/source-based-code-coverage.html">https://doc.rust-lang.org/nightly/unstable-book/compiler-flags/source-based-code-coverage.html</a>) and I was wondering if it was possible to use it with doc tests. I tried a little hack: first, I export <code>RUSTFLAGS="-Zinstrument-coverage"</code> just like with the regular tests. then, I run <code>cargo test --doc</code> and extract the <code>rustdoc</code> command just to be sure I'm not messing it up. then, I append <code>--persist-doctests target/rustdoc -Z unstable-options</code> to create the binaries for the doctests. I execute each and then add them to the <code>llvm-cov</code> as input, along with the profdata output accumulated from all the binaries. but it doesn't seem to be working. this procedure worked when I accumulated tests and other binaries, like examples, but I'm not sure if <code>rustdoc</code> uses that instrument coverage flag at all. It's possible I made some mistakes but just wanted to see if anyone can confirm whether <code>rustdoc</code> is capable of producing this profdata or not before I spend way too much time on that. Any help would be appreciated!</p>



<a name="218937456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/218937456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#218937456">(Dec 05 2020 at 14:33)</a>:</h4>
<p>I have not tested it, your guess is as good as mine <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="218937458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/218937458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#218937458">(Dec 05 2020 at 14:33)</a>:</h4>
<p>My guess is that rustdoc probably isn't passing the flag into rustc somewhere</p>



<a name="218937503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/218937503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#218937503">(Dec 05 2020 at 14:34)</a>:</h4>
<p>Let me know if you're interested in fixing that, it would be somewhere in <a href="https://github.com/rust-lang/rust/blob/master/src/librustdoc/core.rs"><code>core.rs</code></a></p>



<a name="218939730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/218939730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#218939730">(Dec 05 2020 at 15:33)</a>:</h4>
<p>Thanks, I'll try to find some time to investigate over the weekend and report back</p>



<a name="218951315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/218951315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#218951315">(Dec 05 2020 at 20:12)</a>:</h4>
<p>I've built the compiler from <code>master</code>, set it as my local toolchain in the dir of the project I want to test it on, and -- without touching any code yet -- I get quite different coverage on the <code>--lib</code> test alone than on nightly. looking at the stats, it's both which lines are covered and how many lines are even discovered to be covered. it's sometimes higher, sometimes lower, doesn't seem to be a pattern. is it plausible that there's been some change/fix/regression or I most likely just messed something up while setting up my local toolchain?</p>



<a name="218953846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/218953846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#218953846">(Dec 05 2020 at 21:13)</a>:</h4>
<p>for example, nightly will mark only the function body while local will include the function signature in the coverage</p>



<a name="219082454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219082454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219082454">(Dec 07 2020 at 13:59)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> I investigated this a little further, and I need a little help on the next steps. in particular, how to file issues/submit PRs. the issue I set out to investigate is how to include doctests in the code coverage report, but I think of it now as two separate issues. first, when doctests are compiled, the <code>RUSTFLAGS</code> variable is not taken into account, and the arguments there are not populated. I suppose this could be considered a but, right? In any case, the fix appears to be simple, and I can submit a PR but I was wondering if I needed to file a bug report first, it's not clear to me from what I've read in the docs so far. now, this doesn't fix the original issue because even though the flags are populated, the coverage report ends up being incorrect because the code from the tests is considered in the coverage and it maps into the lines of the source file but it does so incorrectly. this  is more complicated and I don't yet fully understand it, so I figured I could create an issue and describe what I have found out and maybe someone can help me out with understanding certain things. is this a bug, though? or a feature? I don't have a good understanding what needs to go through feature request process, etc. I'd appreciate some help with figuring this out.</p>



<a name="219082623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219082623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219082623">(Dec 07 2020 at 14:01)</a>:</h4>
<p>Doctests are compiled by rustdoc, so you need <code>RUSTDOCFLAGS</code>.</p>



<a name="219084520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219084520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219084520">(Dec 07 2020 at 14:16)</a>:</h4>
<p>You're right!</p>



<a name="219084591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219084591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219084591">(Dec 07 2020 at 14:17)</a>:</h4>
<p>it still leaves the second problem, e.g., <a href="/user_uploads/4715/WvuvyGuUDQmipnPKXu-GyNDl/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/WvuvyGuUDQmipnPKXu-GyNDl/image.png" title="image.png"><img src="/user_uploads/4715/WvuvyGuUDQmipnPKXu-GyNDl/image.png"></a></div>



<a name="219084741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219084741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219084741">(Dec 07 2020 at 14:18)</a>:</h4>
<p>seems like the lines are not mapped correctly</p>



<a name="219085001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219085001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219085001">(Dec 07 2020 at 14:21)</a>:</h4>
<p>if I have two doctests, then I get a warning: 1 functions have mismatched data, and the following coverage <a href="/user_uploads/4715/OLrlqEV0eyD1_DsFm8QTE4U9/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/OLrlqEV0eyD1_DsFm8QTE4U9/image.png" title="image.png"><img src="/user_uploads/4715/OLrlqEV0eyD1_DsFm8QTE4U9/image.png"></a></div>



<a name="219085105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219085105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219085105">(Dec 07 2020 at 14:22)</a>:</h4>
<p>I'm not sure if that's something easy to fix but it's clearly incorrect</p>



<a name="219085481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219085481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219085481">(Dec 07 2020 at 14:25)</a>:</h4>
<p>it probably has something to do with the fact that the code is taken from the stdin but tbh I don't fully understand what's exactly happening</p>



<a name="219086869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219086869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219086869">(Dec 07 2020 at 14:35)</a>:</h4>
<p>what do you <em>expect</em> this to do?</p>



<a name="219086978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219086978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219086978">(Dec 07 2020 at 14:36)</a>:</h4>
<p>anyway I don't know what's going on here, maybe <span class="user-mention" data-user-id="296355">@Rich Kadel</span> has ideas</p>



<a name="219087412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219087412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219087412">(Dec 07 2020 at 14:40)</a>:</h4>
<p>for one, I'd expect <code>sub</code> to be covered. I'm not sure what I expect exactly but one of the following: (1) the code is covered and the comments are not treated as code at all, (2) both code and doctest code are fully covered, as everything should be executed.</p>



<a name="219089042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219089042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219089042">(Dec 07 2020 at 14:53)</a>:</h4>
<p>The code blocks in the doc comments are compiled into actual functions whose spans and thus coverage info should cover exactly those lines that are the code blocks.</p>



<a name="219089168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219089168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219089168">(Dec 07 2020 at 14:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="270883">Michal Siedlaczek</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Source-based.20coverage.20for.20doctest/near/219085001">said</a>:</p>
<blockquote>
<p>if I have two doctests, then I get a warning: 1 functions have mismatched data, and the following coverage <a href="/user_uploads/4715/OLrlqEV0eyD1_DsFm8QTE4U9/image.png">image.png</a></p>
</blockquote>
<p>Does it give any more info? "1 functions have mismatched data" may be the reason the second function isn't shown as covered at all.</p>



<a name="219090424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219090424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219090424">(Dec 07 2020 at 15:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Source-based.20coverage.20for.20doctest/near/219089168">said</a>:</p>
<blockquote>
<p>Does it give any more info? "1 functions have mismatched data" may be the reason the second function isn't shown as covered at all.</p>
</blockquote>
<p>No, it didn't give any more information.</p>



<a name="219090768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219090768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219090768">(Dec 07 2020 at 15:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Source-based.20coverage.20for.20doctest/near/219089042">said</a>:</p>
<blockquote>
<p>The code blocks in the doc comments are compiled into actual functions whose spans and thus coverage info should cover exactly those lines that are the code blocks.</p>
</blockquote>
<p>So basically you're saying it should be working as I expect in (1), right? ok, so maybe then I'm doing something wrong there. I'll try to find some time later tonight to investigate further. thanks for your help so far!</p>



<a name="219091288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219091288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219091288">(Dec 07 2020 at 15:10)</a>:</h4>
<blockquote>
<p>So basically you're saying it should be working as I expect in (1), right?</p>
</blockquote>
<p>Almost. I would expect lines 6, 7 and 8 to get covered.</p>



<a name="219092820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219092820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219092820">(Dec 07 2020 at 15:21)</a>:</h4>
<p>In the first image?</p>



<a name="219092906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219092906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219092906">(Dec 07 2020 at 15:22)</a>:</h4>
<p>Yes</p>



<a name="219093446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219093446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219093446">(Dec 07 2020 at 15:26)</a>:</h4>
<p>right, okay, I'll double-check this, thanks.</p>



<a name="219107136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219107136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219107136">(Dec 07 2020 at 17:04)</a>:</h4>
<p>This is a known issue, <a href="https://github.com/rust-lang/rust/issues/79417">#79417</a>.</p>
<p>@Swatinem is working on a couple of PRs to fix it though.</p>



<a name="219111840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219111840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219111840">(Dec 07 2020 at 17:39)</a>:</h4>
<p><span class="user-mention" data-user-id="330205">@Arpad Borsos</span> is his correct username in Zulip I think. (Though he did mention he would be off Zulip for a few days.)</p>



<a name="219114141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219114141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219114141">(Dec 07 2020 at 17:56)</a>:</h4>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> Yes here I am ;-)</p>



<a name="219114390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219114390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219114390">(Dec 07 2020 at 17:58)</a>:</h4>
<p>So yes, basically with persisted doctests, it works just fine to get coverage of <em>the code run by the doctest</em></p>



<a name="219114501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219114501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219114501">(Dec 07 2020 at 17:59)</a>:</h4>
<p>I created a github action that does all this here: <a href="https://github.com/Swatinem/fucov">https://github.com/Swatinem/fucov</a> (its very opinionated so far), but provides good results for the small testcases in the repo itself, as well as in <a href="https://github.com/getsentry/sentry-rust/pull/295">https://github.com/getsentry/sentry-rust/pull/295</a> where I tried things</p>



<a name="219114563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219114563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219114563">(Dec 07 2020 at 17:59)</a>:</h4>
<p>The problem so far is for <em>the code of the doctest itself</em>, which has a couple of issues, I have a list at the bottom of the fucov README tracking my own work</p>



<a name="219114756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219114756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219114756">(Dec 07 2020 at 18:01)</a>:</h4>
<p><a href="https://github.com/rust-lang/cargo/commit/8ff53f6424f32a2f5d71c3b668ba30099fe92570">https://github.com/rust-lang/cargo/commit/8ff53f6424f32a2f5d71c3b668ba30099fe92570</a> this landed just a few minutes ago, and will hopefully give the correct filenames when you are in a workspace</p>



<a name="219114823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219114823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219114823">(Dec 07 2020 at 18:01)</a>:</h4>
<p>then I am about to use the same mechanism that rustdoc itself uses to remap error messages to get the halfway-correct line numbers</p>



<a name="219114899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219114899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219114899">(Dec 07 2020 at 18:02)</a>:</h4>
<p>after that there are a few minor bugs in rustdoc itself when it gets file/line mappings completely wrong, but I will tackle those one after the other</p>



<a name="219119755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219119755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michal Siedlaczek <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219119755">(Dec 07 2020 at 18:39)</a>:</h4>
<p>That's great, I'll follow the progress to get more familiar with it, and also thanks for sharing the github action, I'll make sure to compare it with what I've been doing, this will be a lot of help!</p>



<a name="219188158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219188158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219188158">(Dec 08 2020 at 09:47)</a>:</h4>
<p><span class="user-mention" data-user-id="296355">@Rich Kadel</span> your most recent PR looks very promising, thanks also for adding so many docs! <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> with my latest cargo changes in, I do get correct workspace file paths, and the line remapping looks promising. I am still struggling a bit with the run-make tests, probably a windows specific issue. I might as well just try to do all this in WSL2 as the windows experience is horribly slow anyway. also my native linux machine is sadly not strong enough to compile rust in a reasonable time.</p>



<a name="219230290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219230290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219230290">(Dec 08 2020 at 16:45)</a>:</h4>
<p>Sorry, yes some of these processes can be quite slow on Windows.</p>
<p>I typically use custom scripts when developing, to rebuild only the compiler, compile a single rust test program (with a main()) with coverage and debugging flags, run it (with debug logging environment variables set), and then run the LLVM profdata and cov tools to see the results. My script is pretty hacky and not worth sharing, but you may be able to start with the contents of the <code>run-make-fulldeps/coverage-report</code> Makefile to get an idea how to write your own, if desired.</p>
<p>Not sure if that's helpful.</p>
<p>Looking forward to your fixes!</p>



<a name="219477289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219477289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219477289">(Dec 10 2020 at 14:18)</a>:</h4>
<p><span class="user-mention" data-user-id="296355">@Rich Kadel</span> I had a really hard time to get the run-make tests working, but now I figured out that I had to install msys2 and build llvm with debug assertions. anyway, I got the new testcase running, however, it is only finding one of the doctests in my file for some reason. I have a hunch that maybe its because each of the doctests basically generates the same function name?</p>



<a name="219477502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219477502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219477502">(Dec 10 2020 at 14:20)</a>:</h4>
<p>anyhow, I think I have to further cleanup that makefile, because it adds all the doctest executables to all the other llvm-cov calls thus messing up the counters</p>



<a name="219492004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219492004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219492004">(Dec 10 2020 at 15:57)</a>:</h4>
<p>I think that's not surprising. I'm not sure how rustdoc works exactly, but it compiles each test into its own binary, and then runs it. I assume each test's function name is <code>main()</code>. I think it would be OK if they all had the same function name as long as the line numbers are distinct (which they should be). FYI, I updated the Rust Unstable Book documentation in my last PR, that landed last night. It should be published sometime today, but you can view it here: <a href="https://github.com/rust-lang/rust/blob/master/src/doc/unstable-book/src/compiler-flags/source-based-code-coverage.md">https://github.com/rust-lang/rust/blob/master/src/doc/unstable-book/src/compiler-flags/source-based-code-coverage.md</a></p>



<a name="219492134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219492134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219492134">(Dec 10 2020 at 15:58)</a>:</h4>
<p>It has more examples with doc tests now (and a footnote about the issue you filed).</p>



<a name="219492264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219492264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219492264">(Dec 10 2020 at 15:59)</a>:</h4>
<p>The point is, if each doc test generates a different binary with the same function name but different line numbers, when they are merged with <code>profdata</code>, and then reviewed with <code>cov show</code>, I think it should work.</p>
<p>The compiler must compile one at a time.</p>



<a name="219492891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219492891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219492891">(Dec 10 2020 at 16:03)</a>:</h4>
<p>Yes, rustdoc runs each in a different binary</p>



<a name="219513215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219513215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219513215">(Dec 10 2020 at 18:24)</a>:</h4>
<p>I think it really is the same function name at the same line, unless there are special directives, etc involved</p>



<a name="219513269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219513269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219513269">(Dec 10 2020 at 18:24)</a>:</h4>
<p>or the doctest has its own <code>main</code>, otherwise I think oneliners all end up with the "same" <code>main</code></p>



<a name="219513385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219513385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219513385">(Dec 10 2020 at 18:25)</a>:</h4>
<p>the line remapping so far only works for the error messages, and for the coverage mappings with my change, everything else is relative to the generated file</p>



<a name="219517714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219517714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219517714">(Dec 10 2020 at 18:58)</a>:</h4>
<p>I'm not sure I understand. When you say <code> for the coverage mappings with my change</code> ... does this mean your change will work? Or are you running into a problem you haven't solved yet?</p>



<a name="219524685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219524685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219524685">(Dec 10 2020 at 19:51)</a>:</h4>
<p>I’m running into this problem:<br>
I do get coverage from all the doctest runs combined, so when I run library code, I do get the correct coverage.<br>
BUT: for the doctest code itself, I only get coverage from one run. so when I have 4 different doctests, only one of them gets the <em>correctly offset</em> lines covered</p>



<a name="219525055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219525055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219525055">(Dec 10 2020 at 19:54)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/79762/files#diff-dd0a25f2ec31e1128d583fcc31bfc9840243ad7cab7873f7e84eac4bdd15f18fR16-R18">https://github.com/rust-lang/rust/pull/79762/files#diff-dd0a25f2ec31e1128d583fcc31bfc9840243ad7cab7873f7e84eac4bdd15f18fR16-R18</a> so the highlighted doctest gets coverage, but all the rest does not</p>



<a name="219602339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219602339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219602339">(Dec 11 2020 at 12:59)</a>:</h4>
<p>ok, I posted the PR for review. <span class="user-mention" data-user-id="232545">@Joshua Nelson</span> I also made some changes to the doctest code generation to create unique function names. This all feels very hacky though :-( But I think its good enough for a first step</p>



<a name="219636850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/219636850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#219636850">(Dec 11 2020 at 17:41)</a>:</h4>
<p>I'll take a look today. Thanks!!</p>



<a name="220214275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/220214275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#220214275">(Dec 17 2020 at 07:38)</a>:</h4>
<p><span class="user-mention" data-user-id="296355">@Rich Kadel</span> thanks for the heads up. I will take a look at my changes to the doctest main wrapper again, looks like rustdoc is using the same code for hotlinks to the playground. Seems like I will make that conditional on code coverage</p>



<a name="220214285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/220214285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#220214285">(Dec 17 2020 at 07:39)</a>:</h4>
<p>Also, I’m a bit tied up with work right now, so it might take some time. Also, thanks for all the help ;-)</p>



<a name="220243398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/220243398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#220243398">(Dec 17 2020 at 13:35)</a>:</h4>
<p><span class="user-mention" data-user-id="330205">@Arpad Borsos</span> why are the line numbers different for coverage and the playground?</p>



<a name="220260969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/220260969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rich Kadel <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#220260969">(Dec 17 2020 at 15:54)</a>:</h4>
<p>Thanks Arpad!</p>



<a name="220346460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/220346460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#220346460">(Dec 18 2020 at 08:29)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> I don’t think they are different. I just didn’t realize that the playground button uses the same code that is actually <em>run</em> by the doctests</p>



<a name="220374893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/220374893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#220374893">(Dec 18 2020 at 14:02)</a>:</h4>
<p>sure, but why does that require making your changes conditional on code coverage?</p>



<a name="220380101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/220380101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#220380101">(Dec 18 2020 at 14:49)</a>:</h4>
<p>:-D I rather not put the additional wrapping main (to have unique function names) into the playground snippets</p>



<a name="222190285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222190285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222190285">(Jan 09 2021 at 21:17)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> hey, I just stumbled upon <a href="https://hackmd.io/3eG6OZWHRbSMxoRxzwNhGQ#-Change-the-working-directory-for-doctests">https://hackmd.io/3eG6OZWHRbSMxoRxzwNhGQ#-Change-the-working-directory-for-doctests</a>, nice to see that is something thats at least considered for 2021, although the title should rather be "separate runtime from compile time working directory for doctests".</p>



<a name="222190342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222190342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222190342">(Jan 09 2021 at 21:18)</a>:</h4>
<p>also the point before, compiling doctests into a single executable would be very nice, and maybe something I would want to contribute to ;-)</p>



<a name="222190351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222190351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222190351">(Jan 09 2021 at 21:18)</a>:</h4>
<p><span class="user-mention" data-user-id="330205">@Arpad Borsos</span> feel free to edit it :)</p>



<a name="222190370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222190370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222190370">(Jan 09 2021 at 21:19)</a>:</h4>
<p>speaking of which… I’m kind of hesitant to do the cwd changes, not quite sure whats the approach that would be accepted and where I wouldn’t just be wasting time on a proposal thats not going anywhere</p>



<a name="222190417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222190417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222190417">(Jan 09 2021 at 21:20)</a>:</h4>
<p>also, I recently added a regression test to cargo that makes sure that the <em>runtime cwd</em> is consistent across test types (<a href="https://github.com/rust-lang/cargo/pull/9037">https://github.com/rust-lang/cargo/pull/9037</a>) so thats at least something</p>



<a name="222190489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222190489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222190489">(Jan 09 2021 at 21:22)</a>:</h4>
<p><a href="https://hackmd.io/3eG6OZWHRbSMxoRxzwNhGQ?view#-Separate-compile-time-from-run-time-working-directory-for-doctests">https://hackmd.io/3eG6OZWHRbSMxoRxzwNhGQ?view#-Separate-compile-time-from-run-time-working-directory-for-doctests</a> ah nice, didn’t know I had permission to edit that</p>



<a name="222190935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222190935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222190935">(Jan 09 2021 at 21:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330205">Arpad Borsos</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Source-based.20coverage.20for.20doctest/near/222190370">said</a>:</p>
<blockquote>
<p>speaking of which… I’m kind of hesitant to do the cwd changes, not quite sure whats the approach that would be accepted and where I wouldn’t just be wasting time on a proposal thats not going anywhere</p>
</blockquote>
<p><span class="user-mention" data-user-id="330205">@Arpad Borsos</span>  didn't <span class="user-mention silent" data-user-id="296355">Rich Kadel</span> suggest an approach that doesn't need to change the cwd?</p>



<a name="222190941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222190941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222190941">(Jan 09 2021 at 21:37)</a>:</h4>
<p><a href="https://github.com/rust-lang/cargo/issues/8993#issuecomment-753001081">https://github.com/rust-lang/cargo/issues/8993#issuecomment-753001081</a></p>



<a name="222191231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222191231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222191231">(Jan 09 2021 at 21:45)</a>:</h4>
<p>but yeah, I would be hesistant about a change to the cwd</p>



<a name="222228233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228233">(Jan 10 2021 at 15:57)</a>:</h4>
<blockquote>
<p>prepend the doctest root path with the path from workspace root to doctest root</p>
</blockquote>
<p>well, I only see one way to get this, and thats if cargo can explicitly pass that down. IMO its more of a cargo concern</p>



<a name="222228239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228239">(Jan 10 2021 at 15:58)</a>:</h4>
<p>sure, that seems reasonable</p>



<a name="222228296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228296">(Jan 10 2021 at 15:58)</a>:</h4>
<p>and it's not a breaking change which is the most important thing</p>



<a name="222228307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228307">(Jan 10 2021 at 15:59)</a>:</h4>
<p>IMO, the cleanest solution would really be to split the compilation from running the test. I think thats also what the "compile all doctests into a single executable" task is about</p>



<a name="222228313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228313">(Jan 10 2021 at 15:59)</a>:</h4>
<p>you've made that very clear, yes <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="222228322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228322">(Jan 10 2021 at 15:59)</a>:</h4>
<p>but I still don't see how it can happen without breaking code</p>



<a name="222228425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228425">(Jan 10 2021 at 16:01)</a>:</h4>
<p>hm, I don’t know how the 2021 proposal to "compile a single exe" would work in relation to backwards compat. since 2021 edition is opt-in, that would be a chance to introduce new behavior…</p>



<a name="222228482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228482">(Jan 10 2021 at 16:02)</a>:</h4>
<p>well the other thing is that it has to be reasonably easy to upgrade to 2021, since we want everyone to do it eventually</p>



<a name="222228487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228487">(Jan 10 2021 at 16:02)</a>:</h4>
<p>one sec, let me come up with an example</p>



<a name="222228558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228558">(Jan 10 2021 at 16:04)</a>:</h4>
<p>anyhow, introducing a new flag that cargo passes down:</p>
<ol>
<li>should that be an ENV or rather a CLI flag?</li>
<li>should the flag be for the run-time, or compile-time cwd (the respective other one would come from the cwd of the rustdoc invocation itself)</li>
</ol>



<a name="222228565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228565">(Jan 10 2021 at 16:04)</a>:</h4>
<p>so my work when I'm not doing open source is working on a database, and for tests the crate uses a global database, which means that the tests can see each others state and interfere with one another: <a href="https://gitlab.com/YottaDB/Lang/YDBRust/-/issues/13">https://gitlab.com/YottaDB/Lang/YDBRust/-/issues/13</a>. One of the ideas I thought of to fix it was to have a per-process database, so that the tests wouldn't conflict. If you change doctests to run in a single process, you'll be introducing state conflicts like this that weren't there before, because any test ever can always affect the global state of the process</p>



<a name="222228582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228582">(Jan 10 2021 at 16:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330205">Arpad Borsos</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Source-based.20coverage.20for.20doctest/near/222228558">said</a>:</p>
<blockquote>
<p>anyhow, introducing a new flag that cargo passes down:</p>
<ol>
<li>should that be an ENV or rather a CLI flag?</li>
<li>should the flag be for the run-time, or compile-time cwd (the respective other one would come from the cwd of the rustdoc invocation itself)</li>
</ol>
</blockquote>
<ol>
<li>CLI flag, to be consistent with --crate-version</li>
<li>I would rather not change either, and only pass <code>--workspace-directory</code> or something. Then rustdoc can choose how to use it (i.e, only pass it to LLVM without changing behavior)</li>
</ol>



<a name="222228650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228650">(Jan 10 2021 at 16:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Source-based.20coverage.20for.20doctest/near/222228565">said</a>:</p>
<blockquote>
<p>so my work when I'm not doing open source is working on a database, and for tests the crate uses a global database, which means that the tests can see each others state and interfere with one another: <a href="https://gitlab.com/YottaDB/Lang/YDBRust/-/issues/13">https://gitlab.com/YottaDB/Lang/YDBRust/-/issues/13</a>. One of the ideas I thought of to fix it was to have a per-process database, so that the tests wouldn't conflict. If you change doctests to run in a single process, you'll be introducing state conflicts like this that weren't there before, because any test ever can always affect the global state of the process</p>
</blockquote>
<p><a href="https://github.com/rust-lang/rust/issues/75341#issuecomment-672390765">https://github.com/rust-lang/rust/issues/75341#issuecomment-672390765</a></p>



<a name="222228729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228729">(Jan 10 2021 at 16:08)</a>:</h4>
<p>the other reason to change this in rustdoc with a flag is it allows build systems besides cargo to use it</p>



<a name="222228817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222228817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222228817">(Jan 10 2021 at 16:11)</a>:</h4>
<p>ah true, thats a good reminder</p>



<a name="222229983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222229983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222229983">(Jan 10 2021 at 16:41)</a>:</h4>
<p>libtest has a mode in which it runs every test in a sub-process. You can activate it by compiling with <code>-Zpanic-abort-tests</code>.</p>



<a name="222230057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222230057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222230057">(Jan 10 2021 at 16:43)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> that's the opposite of what we want: right now each rustdoc test is in a separate process, we're trying to figure out how to run them in the same process without breaking the test</p>



<a name="222230082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222230082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222230082">(Jan 10 2021 at 16:44)</a>:</h4>
<p>really what I want is a way to <em>compile</em> them all at once, but <em>run</em> them all in different processes</p>



<a name="222230121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222230121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222230121">(Jan 10 2021 at 16:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Source-based.20coverage.20for.20doctest/near/222230082">said</a>:</p>
<blockquote>
<p>really what I want is a way to <em>compile</em> them all at once, but <em>run</em> them all in different processes</p>
</blockquote>
<p>This flag would help with your usecase of the database tests if all rustdoc tests become part of a single process by default.</p>



<a name="222230137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/222230137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#222230137">(Jan 10 2021 at 16:45)</a>:</h4>
<p>ah hmm, interesting</p>



<a name="223744031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/223744031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#223744031">(Jan 23 2021 at 11:04)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> <a href="https://github.com/rust-lang/rust/pull/81264#discussion_r563098921">https://github.com/rust-lang/rust/pull/81264#discussion_r563098921</a> thats what I meant by "compiletest cwd", did I get this right?</p>



<a name="223744283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/223744283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#223744283">(Jan 23 2021 at 11:11)</a>:</h4>
<p>Also concerning "unstable", I’m a bit surprised I can run this in compiletest without explicitly allowing unstable options. so the plan here would be to have it as unstable, then implement it in cargo to set that flag, but then on the next uplift it needs to be stabilized, right? otherwise when it rides the trains cargo wouldn’t be allowed to set that flag?</p>



<a name="223744353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/223744353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#223744353">(Jan 23 2021 at 11:12)</a>:</h4>
<p>also regarding the cwd, how about I set an explicit one when compiletest invokes rustdoc? I think with an explicit cwd, there would be no need for the manual stdout normalization?</p>



<a name="223757921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/223757921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#223757921">(Jan 23 2021 at 16:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="330205">Arpad Borsos</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Source-based.20coverage.20for.20doctest/near/223744283">said</a>:</p>
<blockquote>
<p>Also concerning "unstable", I’m a bit surprised I can run this in compiletest without explicitly allowing unstable options. so the plan here would be to have it as unstable, then implement it in cargo to set that flag, but then on the next uplift it needs to be stabilized, right? otherwise when it rides the trains cargo wouldn’t be allowed to set that flag?</p>
</blockquote>
<p>Unstable options (<code>-Z</code>) only require nightly, not <code>--unstable-options</code>. Yes, the plan is to implement this in rustdoc, pass the flag in cargo on nightly, make sure it actually solves the issue, and then stabilize in both rustdoc and cargo.</p>
<blockquote>
<p>I think that was why the first build failed on CI, because CI runs with a completely different cwd than my local x test invocation. Either way, I don’t really know what you mean by "default directory".</p>
</blockquote>
<p>Hmm, I thought the directory compiletest used was stable, I guess not. Only having two revisions (one with the directory correctly set, one with it incorrectly set) seems fine then.</p>



<a name="223760303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/223760303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#223760303">(Jan 23 2021 at 17:27)</a>:</h4>
<p>alright, I changed the test to be based on test revisions, works nicely for me locally, and changed the option to unstable</p>



<a name="224352892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/224352892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#224352892">(Jan 28 2021 at 16:35)</a>:</h4>
<p>so I have run my cargo patch with <code>cargo +nightly test</code> again which works apart from some tests that do <code>extern crate rustc_driver</code>, when I do a normal <code>cargo test</code>, it fails because it can’t find the option, so I guess the tests are run with stable rustc? <span class="user-mention" data-user-id="116015">@Alex Crichton</span> can you guide me how I can get this flag into cargo properly?</p>



<a name="224353698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/224353698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#224353698">(Jan 28 2021 at 16:40)</a>:</h4>
<p>Sorry I don't understand I think? It's ok if to just run the tests you added for nightly tests though. Extra setup is needed to run the full nightly test suite with Cargo (you can read <code>.github/workflows/main.yml</code> for the setup we do on CI)</p>



<a name="224354736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/224354736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#224354736">(Jan 28 2021 at 16:46)</a>:</h4>
<p>oh sorry maybe you were missing the context: <a href="https://github.com/rust-lang/cargo/pull/9105#issuecomment-767614139">https://github.com/rust-lang/cargo/pull/9105#issuecomment-767614139</a> ;-)</p>



<a name="224355209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/224355209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#224355209">(Jan 28 2021 at 16:47)</a>:</h4>
<p>my question was basically if the new rustdoc flag would have to ride the train before it can be used by cargo? I thought cargo was basically tied to the same version rustc/rustdoc</p>



<a name="224355661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/224355661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#224355661">(Jan 28 2021 at 16:47)</a>:</h4>
<p>Yes Cargo is tied to the same version but for convenience we test it on stable/beta/nightly</p>



<a name="224355683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/224355683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#224355683">(Jan 28 2021 at 16:47)</a>:</h4>
<p>so we can run <code>cargo test</code> locally</p>



<a name="224355778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/224355778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#224355778">(Jan 28 2021 at 16:48)</a>:</h4>
<p>if a new flag was just added to rustdoc and you want to add support in Cargo then you'll need to do some degree of feature detection for the <code>rustdoc</code> binary, there's similar stuff for <code>rustc</code> right now I believe</p>



<a name="224357154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/224357154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#224357154">(Jan 28 2021 at 16:57)</a>:</h4>
<p>interesting, any suggestions on how to do that? or can you point me in the right direction?</p>



<a name="227076565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/227076565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#227076565">(Feb 20 2021 at 08:21)</a>:</h4>
<p><span class="user-mention" data-user-id="116015">@Alex Crichton</span> so the plan to land these rustdoc changes is here: <a href="https://github.com/rust-lang/cargo/pull/9105#discussion_r575817720">https://github.com/rust-lang/cargo/pull/9105#discussion_r575817720</a> do you agree with these? and can I get a review for the first cargo change? ;-)</p>



<a name="227282953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/227282953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#227282953">(Feb 22 2021 at 15:25)</a>:</h4>
<p>Yes that seems like a reasonable plan, and yeah I can review</p>



<a name="227324505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Source-based%20coverage%20for%20doctest/near/227324505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Arpad Borsos <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Source-based.20coverage.20for.20doctest.html#227324505">(Feb 22 2021 at 19:36)</a>:</h4>
<p>Thanks for the feedback. Added a new unstable cargo option for this now.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>