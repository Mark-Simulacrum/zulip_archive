<html>
<head><meta charset="utf-8"><title>LLVM assertion when writing out bitcode in custom codegen · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html">LLVM assertion when writing out bitcode in custom codegen</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256807845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256807845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256807845">(Oct 08 2021 at 21:21)</a>:</h4>
<p>Hello!</p>
<p>I just wanted to check if anyone was familiar with this LLVM error: <code>Expected forward references to be resolved</code>. According to the LLVM source, it at bitcode writing when it tries to write out some MDNodes (however, according to my logging it doesnt seem to occur when im writing out llvm bitcode for codegenned modules in cg_ssa, but it happens before the rlib is dumped so it is most likely when it tries to pack bitcode inside of the rlib). I recently tried implementing debug info for my codegen, which is a codegen for GPU code using the libnvvm library. It uses a subset of LLVM 7 IR, therefore most of the debug info creation code was taken from cg_llvm, both recent and old cg_llvm (llvm 7). I am not deeply familiar with how DWARF/LLVM debug info works, i presume this error means my codegen tried to generate a forward reference for recursive/cyclic definitions, but at bitcode writing that reference wasnt resolved. Any help would be appreciated <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>
<p>cc <span class="user-mention" data-user-id="123586">@nagisa</span> i was told you might possibly know something about this.</p>



<a name="256812986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256812986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256812986">(Oct 08 2021 at 22:10)</a>:</h4>
<p>It can be the case that you simply have some cyclic metadata and the libnvvm does not call <code>resolveCycles</code> or whatever the function is called.</p>



<a name="256813025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813025">(Oct 08 2021 at 22:11)</a>:</h4>
<p>is debug info something that makes sense for cuda kernels at all?</p>



<a name="256813054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813054">(Oct 08 2021 at 22:11)</a>:</h4>
<p>But otherwise no, it would be my first time seeing this assert.</p>



<a name="256813059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813059">(Oct 08 2021 at 22:11)</a>:</h4>
<p>this is before libnvvm, libnvvm is only the last step where i take all of the rlib bitcode and give it to it</p>



<a name="256813130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813130">(Oct 08 2021 at 22:12)</a>:</h4>
<blockquote>
<p>is debug info something that makes sense for cuda kernels at all?</p>
</blockquote>
<p>absolutely, tools like Nsight compute can use it to show you your source code and performance metrics or assembly side by side</p>



<a name="256813144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813144">(Oct 08 2021 at 22:12)</a>:</h4>
<p>not to mention cuda-memcheck and cuda-gdb use it iirc</p>



<a name="256813200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813200">(Oct 08 2021 at 22:13)</a>:</h4>
<p>Im thinking that theres perhaps some step that got lost in the translation of llvm 13/7 cg_llvm debug info code, that is supposed to resolve the cycles</p>



<a name="256813237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813237">(Oct 08 2021 at 22:13)</a>:</h4>
<p>are these cycles supposed to be resolved manually with some function?</p>



<a name="256813250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813250">(Oct 08 2021 at 22:13)</a>:</h4>
<p>Hm, no, I don't believe rustc needs to call this function itself.</p>



<a name="256813351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813351">(Oct 08 2021 at 22:14)</a>:</h4>
<p>Do you perhaps not call <code>DIBuilder::finalize</code>?</p>



<a name="256813396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813396">(Oct 08 2021 at 22:15)</a>:</h4>
<p>That's the only thing I can think of.</p>



<a name="256813437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813437">(Oct 08 2021 at 22:15)</a>:</h4>
<p>hmm no i implement the function just fine in the cg_ssa trait</p>



<a name="256813563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813563">(Oct 08 2021 at 22:16)</a>:</h4>
<p>ill see if i can perhaps print all of unresolved values to see what they are</p>



<a name="256813591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813591">(Oct 08 2021 at 22:17)</a>:</h4>
<p>should be fairly straightforward if you're in C++ land.</p>



<a name="256813613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813613">(Oct 08 2021 at 22:17)</a>:</h4>
<p>Not sure if its easy from within Rust.</p>



<a name="256813617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813617">(Oct 08 2021 at 22:17)</a>:</h4>
<p>yeah but i havent written C++ in so long, just a couple things for the shim <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="256813640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813640">(Oct 08 2021 at 22:17)</a>:</h4>
<p>Did you see <code>RecursiveTypeDescription</code> in from cg_llvm?</p>



<a name="256813706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813706">(Oct 08 2021 at 22:18)</a>:</h4>
<p>Yeah all of the code is from cg_llvm (latest), except adapted to work with llvm 7 shim stuff</p>



<a name="256813717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813717">(Oct 08 2021 at 22:18)</a>:</h4>
<p>got it.</p>



<a name="256813740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813740">(Oct 08 2021 at 22:18)</a>:</h4>
<p>i also changed the shim a bit... its a mess, im planning on switching to llvm 13 as a whole later on, then just lowering the llvm 13 IR to llvm 7 Ir to give it to nvvm</p>



<a name="256813761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813761">(Oct 08 2021 at 22:18)</a>:</h4>
<p>well, DIBuilder::finalize should in theory resolve all cycles and whatnot fully, and that should be called when you're done with DI building…</p>



<a name="256813772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813772">(Oct 08 2021 at 22:19)</a>:</h4>
<p>let me insert a debug to see if finalize is actually being called</p>



<a name="256813817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813817">(Oct 08 2021 at 22:19)</a>:</h4>
<p>RecursiveTypeDescription's finalize method seems fine too</p>



<a name="256813888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813888">(Oct 08 2021 at 22:20)</a>:</h4>
<p>like <a href="https://github.com/llvm/llvm-project/blob/llvmorg-7.1.0/llvm/lib/IR/DIBuilder.cpp#L120-L128">https://github.com/llvm/llvm-project/blob/llvmorg-7.1.0/llvm/lib/IR/DIBuilder.cpp#L120-L128</a></p>



<a name="256813929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813929">(Oct 08 2021 at 22:20)</a>:</h4>
<p>yeah i dont see why its not resolving it</p>



<a name="256813982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256813982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256813982">(Oct 08 2021 at 22:21)</a>:</h4>
<p>you could sneak in some code after this loop to iterate through everything remaining and see if there are any other unresolved nodes after. Maybe <code>resolveCycles</code> failed? Maybe there's something wrong with how <code>UnresolvedNodes</code> is populated <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> .</p>



<a name="256814017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256814017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256814017">(Oct 08 2021 at 22:21)</a>:</h4>
<p>Or perhaps there could be other DI construction _after_ finalize has been called.</p>



<a name="256814033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256814033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256814033">(Oct 08 2021 at 22:22)</a>:</h4>
<p>I think ill just reimplement the finalize method and see, i really dont want to rebuild llvm or that will destroy my pc</p>



<a name="256814193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256814193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256814193">(Oct 08 2021 at 22:23)</a>:</h4>
<p>the weird thing is... its dumping cgu llvm ir in deps just fine</p>



<a name="256814234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256814234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256814234">(Oct 08 2021 at 22:24)</a>:</h4>
<p>so i dont get why llvm doesnt like dumping it to bitcode but its fine with dumping it to llvm ir</p>



<a name="256814375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256814375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256814375">(Oct 08 2021 at 22:25)</a>:</h4>
<p>huh, i dont see any trace of finalize being called</p>



<a name="256814458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256814458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256814458">(Oct 08 2021 at 22:26)</a>:</h4>
<p>maybe cg_ssa calls codegen <em>before</em> finalizing debug info?</p>



<a name="256815767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256815767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256815767">(Oct 08 2021 at 22:40)</a>:</h4>
<p>Ok so it seems like the final "large" functions being called are first optimize, then codegen</p>



<a name="256815808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256815808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256815808">(Oct 08 2021 at 22:41)</a>:</h4>
<p>so i presume that cg_ssa doesnt call finalize before codegenning (does that even make sense in a non-gpu context?)</p>



<a name="256816100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256816100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256816100">(Oct 08 2021 at 22:44)</a>:</h4>
<p>and it fails at</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_bc_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cgcx</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">prof</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">generic_activity_with_arg</span><span class="p">(</span><span class="s">"NVVM_module_codegen_make_bitcode"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="o">..</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">thin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ThinBuffer</span>::<span class="n">new</span><span class="p">(</span><span class="n">llmod</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thin</span><span class="p">.</span><span class="n">data</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_bc_emit_timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cgcx</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">prof</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">generic_activity_with_arg</span><span class="p">(</span><span class="s">"NVVM_module_codegen_emit_bitcode"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="o">..</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"failed to write bytecode to {}: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">.</span><span class="n">display</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">diag_handler</span><span class="p">.</span><span class="n">err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="256816122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256816122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256816122">(Oct 08 2021 at 22:44)</a>:</h4>
<p>so I think the issue is definitely the fact that cg_ssa is not finalizing before codegen</p>



<a name="256816130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256816130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256816130">(Oct 08 2021 at 22:44)</a>:</h4>
<p><code>cg_llvm</code> calls <code>debuginfo_finalize</code> itself from <code>module_codegen</code>.</p>



<a name="256816148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256816148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256816148">(Oct 08 2021 at 22:44)</a>:</h4>
<p>oh man no way i missed that <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="256816392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256816392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256816392">(Oct 08 2021 at 22:47)</a>:</h4>
<p>yeah that seems like it, thanks <span class="user-mention" data-user-id="123586">@nagisa</span> <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="256816801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256816801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256816801">(Oct 08 2021 at 22:51)</a>:</h4>
<p>if i can get this to work today ill post a picture of what debug info on the gpu can do, its really cool</p>



<a name="256816969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256816969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256816969">(Oct 08 2021 at 22:53)</a>:</h4>
<p>You're welcome ^^</p>



<a name="256817129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256817129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256817129">(Oct 08 2021 at 22:55)</a>:</h4>
<p>oh wow it built and made a ptx file... i didnt expect this to work so soon</p>



<a name="256817375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20assertion%20when%20writing%20out%20bitcode%20in%20custom%20codegen/near/256817375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20assertion.20when.20writing.20out.20bitcode.20in.20custom.20codegen.html#256817375">(Oct 08 2021 at 22:58)</a>:</h4>
<p>especially considering nvvm says that i should technically have a metadata that i do not have</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>