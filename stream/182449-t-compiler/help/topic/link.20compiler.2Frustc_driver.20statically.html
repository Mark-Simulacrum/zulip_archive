<html>
<head><meta charset="utf-8"><title>link compiler/rustc_driver statically · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/link.20compiler.2Frustc_driver.20statically.html">link compiler/rustc_driver statically</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268736296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/link%20compiler/rustc_driver%20statically/near/268736296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Collin Baker <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/link.20compiler.2Frustc_driver.20statically.html#268736296">(Jan 20 2022 at 18:27)</a>:</h4>
<p>compiler/rustc_driver is built as a dylib: <a href="https://github.com/rust-lang/rust/blob/181e91567c9f347e055b33b1d7e9894f769aafe3/compiler/rustc_driver/Cargo.toml#L7">https://github.com/rust-lang/rust/blob/181e91567c9f347e055b33b1d7e9894f769aafe3/compiler/rustc_driver/Cargo.toml#L7</a></p>
<p>is there any option to build and link it statically? if not, how difficult would a patch be to make it static? I'm not sure how deep the assumption that it's a dylib is (e.g. do any other crates 'dlopen' it)</p>
<p>side question: how many crates use rustc_driver? what I've found so far: rustc (obviously), clippy, librustdoc. plus lots of tests</p>



<a name="268738348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/link%20compiler/rustc_driver%20statically/near/268738348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/link.20compiler.2Frustc_driver.20statically.html#268738348">(Jan 20 2022 at 18:41)</a>:</h4>
<blockquote>
<p>is there any option to build and link it statically?</p>
</blockquote>
<p>no</p>
<blockquote>
<p>if not, how difficult would a patch be to make it static?</p>
</blockquote>
<p>Just remove that line.</p>
<blockquote>
<p>e.g. do any other crates 'dlopen' it</p>
</blockquote>
<p>It is compiled with the initial-exec tls model which doesn't allow <code>dlopen</code>. (it may work, but this is not guaranteed and shouldn't be relied upon)</p>
<blockquote>
<p>I'm not sure how deep the assumption that it's a dylib is</p>
</blockquote>
<p>Rustc plugins require it, but they are deprecated and have been gutted almost completely. Only adding a lint from a rustc plugin is still possible as servo depends on this. Custom codegen backends also need rustc_driver to be a dylib. Currently only the llvm backend, which is linked into rustc_driver, is stable, but in the future other codegen backends may be dlopen'ed at runtime in which case they need rustc_driver. There are currently four such codegen backends that I am aware of: cg_clif (created by me, focus on low compile time), cg_gcc (by antoyo, focus on portability across architectures using gcc), cg_spirv (part of rust-gpu, by embark studios, compiles rust code to run on gpu's as shader using vulkan), cg_nvvm (by <br>
RDambrosio016, compiles rust code to run on nvidia gpu's using cuda) Of these the first two (cg_clif and cg_gcc) can be built as part of rustc by changing <code>config.toml</code>.</p>



<a name="268738587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/link%20compiler/rustc_driver%20statically/near/268738587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/link.20compiler.2Frustc_driver.20statically.html#268738587">(Jan 20 2022 at 18:42)</a>:</h4>
<p><span class="user-mention" data-user-id="465034">@Collin Baker</span> Why do you exactly want to statically link it by the way?</p>



<a name="268743370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/link%20compiler/rustc_driver%20statically/near/268743370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Collin Baker <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/link.20compiler.2Frustc_driver.20statically.html#268743370">(Jan 20 2022 at 19:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/link.20compiler.2Frustc_driver.20statically/near/268738587">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="465034">Collin Baker</span> Why do you exactly want to statically link it by the way?</p>
</blockquote>
<p>I'm trying to add rust to my project's existing clang/llvm toolchain. we already statically link everything into our clang tools, and prefer sticking to that for rust too</p>



<a name="268743446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/link%20compiler/rustc_driver%20statically/near/268743446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Collin Baker <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/link.20compiler.2Frustc_driver.20statically.html#268743446">(Jan 20 2022 at 19:18)</a>:</h4>
<p>we also build llvm without PIC, so we'd need to modify how we build llvm to support the normal rust build</p>



<a name="268743505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/link%20compiler/rustc_driver%20statically/near/268743505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Collin Baker <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/link.20compiler.2Frustc_driver.20statically.html#268743505">(Jan 20 2022 at 19:18)</a>:</h4>
<p>I suppose there's a bit of an XY problem here but I'm exploring both options: tweaking our llvm build, or tweaking our future rust build</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>