<html>
<head><meta charset="utf-8"><title>Add rustc version to crate hash · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html">Add rustc version to crate hash</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257385936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257385936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257385936">(Oct 13 2021 at 15:32)</a>:</h4>
<p>Looks like there are tests failing for <a href="https://github.com/rust-lang/rust/pull/89836">https://github.com/rust-lang/rust/pull/89836</a>. I'm not sure where to look for this. Any help would be appreciated!</p>



<a name="257386650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257386650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257386650">(Oct 13 2021 at 15:36)</a>:</h4>
<p>This part of the process is new to me. Is this something I should catch with <code>x.py test</code>?</p>



<a name="257386782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257386782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257386782">(Oct 13 2021 at 15:37)</a>:</h4>
<p><span class="user-mention" data-user-id="316352">@pierwill</span> Those tests are failing because the stdout changed, due to the hash being different with your change. You can use <code>x.py test --bless</code> to automatically update the files</p>



<a name="257386828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257386828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257386828">(Oct 13 2021 at 15:37)</a>:</h4>
<p>Thanks!</p>



<a name="257390503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257390503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257390503">(Oct 13 2021 at 15:58)</a>:</h4>
<p>I got the following:</p>
<div class="codehilite"><pre><span></span><code>test result: FAILED. 12150 passed; 7 failed; 117 ignored; 0 measured; 0 filtered out; finished in 420.95s

Some tests failed in compiletest suite=ui mode=ui host=x86_64-apple-darwin target=x86_64-apple-darwin
</code></pre></div>
<p>And these git changes:</p>
<div class="codehilite"><pre><span></span><code>On branch fix-85142-crate-hash
Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git restore &lt;file&gt;...&quot; to discard changes in working directory)
  (commit or discard the untracked or modified content in submodules)
    modified:   library/backtrace (untracked content)
    modified:   src/test/ui/consts/miri_unleashed/tls.stderr
    modified:   src/test/ui/generator/print/generator-print-verbose-1.stderr
    modified:   src/test/ui/lto-duplicate-symbols.stderr
    modified:   src/test/ui/single-use-lifetime/one-use-in-fn-argument-in-band.stderr
    modified:   src/test/ui/specialization/min_specialization/repeated_projection_type.stderr
    modified:   src/test/ui/symbol-names/basic.legacy.stderr
    modified:   src/test/ui/symbol-names/basic.v0.stderr
    modified:   src/test/ui/symbol-names/const-generics-demangling.stderr
    modified:   src/test/ui/symbol-names/const-generics-str-demangling.stderr
    modified:   src/test/ui/symbol-names/const-generics-structural-demangling.stderr
    modified:   src/test/ui/symbol-names/impl1.v0.stderr
    modified:   src/test/ui/symbol-names/issue-60925.legacy.stderr
    modified:   src/test/ui/symbol-names/issue-60925.v0.stderr
    modified:   src/test/ui/symbol-names/issue-75326.v0.stderr
    modified:   src/test/ui/symbol-names/trait-objects.v0.stderr
    modified:   src/test/ui/thir-tree.stdout
</code></pre></div>



<a name="257390593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257390593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257390593">(Oct 13 2021 at 15:58)</a>:</h4>
<p>Running <code>x test src/test/ui</code>, the tests still fail. Is this expected?</p>



<a name="257390642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257390642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257390642">(Oct 13 2021 at 15:59)</a>:</h4>
<p>Do I need to recompile everything?</p>



<a name="257391979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257391979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257391979">(Oct 13 2021 at 16:06)</a>:</h4>
<p>I'm trying <code>x clean &amp;&amp; x test src/test/ui</code> now :)</p>



<a name="257392130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257392130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257392130">(Oct 13 2021 at 16:07)</a>:</h4>
<p>no, fixing ui test stderr files doesn't require a recompile</p>



<a name="257392273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257392273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257392273">(Oct 13 2021 at 16:08)</a>:</h4>
<p>16 failed before, now only 7 fail. you'll have to examine the errors again</p>



<a name="257392329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257392329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257392329">(Oct 13 2021 at 16:08)</a>:</h4>
<p>I can't say what you need to do to work around this, but I think it is going to take a bit more than just blessing the tests to get that to work.  If the symbol names change with changes in the release version, it is likely going to be problematic for the release process.</p>



<a name="257392450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257392450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257392450">(Oct 13 2021 at 16:09)</a>:</h4>
<p>Ah. I knew this was seeming too easy ;)</p>



<a name="257394646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257394646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257394646">(Oct 13 2021 at 16:23)</a>:</h4>
<p>There's got to be something that is consuming the new hashes and getting unexpected data. Maybe there is "demangling" code that needs to match the new format of the stable crate hash? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="257394865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257394865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257394865">(Oct 13 2021 at 16:24)</a>:</h4>
<p>Trying to make sense of how these tests work:</p>
<div class="codehilite"><pre><span></span><code>failures:
    [ui] ui/symbol-names/basic.rs#v0
    [ui] ui/symbol-names/const-generics-demangling.rs
    [ui] ui/symbol-names/const-generics-str-demangling.rs
    [ui] ui/symbol-names/const-generics-structural-demangling.rs
    [ui] ui/symbol-names/impl1.rs#v0
    [ui] ui/symbol-names/issue-60925.rs#v0
    [ui] ui/symbol-names/issue-75326.rs#v0
</code></pre></div>



<a name="257396461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257396461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257396461">(Oct 13 2021 at 16:35)</a>:</h4>
<p>Ah! These symbol names are different lengths! That can't be good:</p>
<p><a href="https://github.com/pierwill/rust/commit/ea39fbcd55b1be81f437fd01e4abce57db6e7785#diff-842a53185dd31b0cbfcf27607efd3958e5109f814639e48c5f81f4e31365c9adL7-R7">https://github.com/pierwill/rust/commit/ea39fbcd55b1be81f437fd01e4abce57db6e7785#diff-842a53185dd31b0cbfcf27607efd3958e5109f814639e48c5f81f4e31365c9adL7-R7</a></p>



<a name="257400521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257400521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257400521">(Oct 13 2021 at 16:59)</a>:</h4>
<p>Another possible clue: <a href="https://github.com/pierwill/rust/blob/ea39fbcd55b1be81f437fd01e4abce57db6e7785/src/tools/rust-demangler/src/lib.rs#L7-L11">https://github.com/pierwill/rust/blob/ea39fbcd55b1be81f437fd01e4abce57db6e7785/src/tools/rust-demangler/src/lib.rs#L7-L11</a></p>



<a name="257401788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257401788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257401788">(Oct 13 2021 at 17:06)</a>:</h4>
<p>Maybe the rustc version has to be an argument to this function instead of dynamically gotten from environment? <a href="https://github.com/pierwill/rust/blob/ea39fbcd55b1be81f437fd01e4abce57db6e7785/compiler/rustc_span/src/def_id.rs#L148">https://github.com/pierwill/rust/blob/ea39fbcd55b1be81f437fd01e4abce57db6e7785/compiler/rustc_span/src/def_id.rs#L148</a></p>



<a name="257404763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257404763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257404763">(Oct 13 2021 at 17:26)</a>:</h4>
<p>My latest theory is that something is wrong with handling generics either in this test or the code it uses: <a href="https://github.com/pierwill/rust/blob/ea39fbcd55b1be81f437fd01e4abce57db6e7785/compiler/rustc_symbol_mangling/src/test.rs#L34-L60">https://github.com/pierwill/rust/blob/ea39fbcd55b1be81f437fd01e4abce57db6e7785/compiler/rustc_symbol_mangling/src/test.rs#L34-L60</a></p>



<a name="257408858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257408858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257408858">(Oct 13 2021 at 17:53)</a>:</h4>
<blockquote>
<p>If the symbol names change with changes in the release version, it is likely going to be problematic for the release process.</p>
</blockquote>
<p><span class="user-mention" data-user-id="120518">@Eric Huss</span> I'm starting to understand the implications of this... <span aria-label="see no evil" class="emoji emoji-1f648" role="img" title="see no evil">:see_no_evil:</span></p>



<a name="257412180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257412180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257412180">(Oct 13 2021 at 18:14)</a>:</h4>
<p>I've been thinking out loud here, <span class="user-mention" data-user-id="133247">@bjorn3</span> <span aria-label="innocent" class="emoji emoji-1f607" role="img" title="innocent">:innocent:</span></p>



<a name="257452124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257452124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257452124">(Oct 13 2021 at 22:59)</a>:</h4>
<p>Wow. This PR got big. This is the first time I've taken on an issue with any real tentacles at all.</p>



<a name="257713243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257713243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257713243">(Oct 15 2021 at 15:09)</a>:</h4>
<p>HUUUUGE shout out to <span class="user-mention" data-user-id="133247">@bjorn3</span> for his help and patience with this is the DMs <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="257718227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257718227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257718227">(Oct 15 2021 at 15:39)</a>:</h4>
<p>Huh. With <code>--bless</code>, my changes are affecting the <code>.stderr</code> for <code>basic.legacy.stderr</code>... Shouldn't this only affect v0?</p>



<a name="257718260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257718260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257718260">(Oct 15 2021 at 15:39)</a>:</h4>
<p>And not just the line numbers.</p>



<a name="257724623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257724623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257724623">(Oct 15 2021 at 16:20)</a>:</h4>
<p>The <code>StableCrateId</code> likely ends up in the hash for legacy symbol names too.</p>



<a name="257725321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257725321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257725321">(Oct 15 2021 at 16:25)</a>:</h4>
<p>I figured as much.</p>



<a name="257725424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257725424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257725424">(Oct 15 2021 at 16:25)</a>:</h4>
<p>I cannot seem to get the regex normalization to actually work! I keep getting things like </p>
<div class="codehilite"><pre><span></span><code>unexpected errors (from JSON output): [
    Error {
        line_num: 10,
        kind: Some(
            Error,
        ),
        msg: &quot;10:1: 10:21: symbol-name(_RNvCshNHOqfMlC59_5basic4main)&quot;,
    },
    Error {
        line_num: 10,
        kind: Some(
            Error,
        ),
        msg: &quot;10:1: 10:21: demangling(basic[cf58ff788efc81d1]::main)&quot;,
    },
]

not found errors (from test file): [
    Error {
        line_num: 10,
        kind: Some(
            Error,
        ),
        msg: &quot;symbol-name(_RNv$CRATE_HASH5basic4main)&quot;,
    },
    Error {
        line_num: 10,
        kind: Some(
            Error,
        ),
        msg: &quot;demangling(basic[$HASH]::main)&quot;,
    },
]
</code></pre></div>



<a name="257725440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257725440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257725440">(Oct 15 2021 at 16:25)</a>:</h4>
<p>Looking to see how other tests do it...</p>



<a name="257725879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257725879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257725879">(Oct 15 2021 at 16:28)</a>:</h4>
<p>Interesting... this test seems to truncate the error in the <code>.rs</code> file <a href="https://github.com/rust-lang/rust/blob/9c53bd24f8724529de6dd92459340706957a07cc/src/test/ui/layout/debug.rs#L6">https://github.com/rust-lang/rust/blob/9c53bd24f8724529de6dd92459340706957a07cc/src/test/ui/layout/debug.rs#L6</a></p>



<a name="257726165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257726165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257726165">(Oct 15 2021 at 16:30)</a>:</h4>
<p>Yeah, that is used relatively common.</p>



<a name="257735908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257735908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257735908">(Oct 15 2021 at 17:36)</a>:</h4>
<p>Ah! I think I finally got one of the tests to work <em>correctly</em>: <a href="https://github.com/rust-lang/rust/pull/89836/commits/a9601c82234dc7b2b3cfa84be780bd229c7cf408">https://github.com/rust-lang/rust/pull/89836/commits/a9601c82234dc7b2b3cfa84be780bd229c7cf408</a></p>



<a name="257801054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257801054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257801054">(Oct 16 2021 at 04:44)</a>:</h4>
<p>These symbols are changing in <code>mir-opt</code>: <a href="https://github.com/rust-lang/rust/runs/3911501632#step:26:1684">https://github.com/rust-lang/rust/runs/3911501632#step:26:1684</a></p>
<p>Is there normalization for the <code>mir-opt</code> tests? If not, should/could we have that?</p>



<a name="257801286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257801286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257801286">(Oct 16 2021 at 04:48)</a>:</h4>
<p>Or is that unnecessary?</p>



<a name="257951964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257951964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257951964">(Oct 17 2021 at 21:58)</a>:</h4>
<p>From @nagisa <a href="https://github.com/rust-lang/rust/pull/89836#discussion_r730403951">here</a>:</p>
<blockquote>
<p>Yeah you may need to implement something in the test runner for this, or alternatively change the MIR output code to print def_ids in a different way that does not expose the hash.</p>
</blockquote>



<a name="257952155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257952155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257952155">(Oct 17 2021 at 22:01)</a>:</h4>
<p>Which would people prefer? Which is easier to implement? Not sure where to start on the test runner code. Looks like maybe some regex logic in here might work? <a href="https://github.com/rust-lang/rust/blob/8db8f48ea8c2443e969050fe4b6c829585048d5c/src/tools/compiletest/src/runtest.rs#L3243">https://github.com/rust-lang/rust/blob/8db8f48ea8c2443e969050fe4b6c829585048d5c/src/tools/compiletest/src/runtest.rs#L3243</a></p>



<a name="257953546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257953546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257953546">(Oct 17 2021 at 22:23)</a>:</h4>
<p>It can't be this easy, can it?  <a href="https://github.com/rust-lang/rust/commit/02f042261d3e98d4df865fb343bcee2e96ce40b7">https://github.com/rust-lang/rust/commit/02f042261d3e98d4df865fb343bcee2e96ce40b7</a></p>



<a name="257953751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257953751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257953751">(Oct 17 2021 at 22:26)</a>:</h4>
<p>I would suggest enabling the necessary normalization by default for mir-opt tests, rather than repeating the rule in each file.</p>



<a name="257953921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257953921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257953921">(Oct 17 2021 at 22:30)</a>:</h4>
<p>Ah that could work. As long as we can find the right regex...</p>
<p>Would have to match foo[bar] in <code>// + def_id: DefId(0:14 ~ foo[bar]::main::{closure#0})</code></p>



<a name="257953978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257953978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257953978">(Oct 17 2021 at 22:30)</a>:</h4>
<p>and lots of that is liable to change... Also not sure it's only def ids to consider <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="257954020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257954020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257954020">(Oct 17 2021 at 22:31)</a>:</h4>
<p>This didn't work anyway <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span>  <a href="https://github.com/rust-lang/rust/commit/02f042261d3e98d4df865fb343bcee2e96ce40b7">https://github.com/rust-lang/rust/commit/02f042261d3e98d4df865fb343bcee2e96ce40b7</a></p>



<a name="257954146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257954146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257954146">(Oct 17 2021 at 22:33)</a>:</h4>
<p>ah wait, need to normalize the output, not the expected output <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="257954813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257954813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257954813">(Oct 17 2021 at 22:45)</a>:</h4>
<p>Huh. This is in the existing code. Wonder what it does?</p>
<p><a href="https://github.com/rust-lang/rust/blob/1f12ac87296ac61ec002e0243e7ad5a50364da35/src/tools/compiletest/src/runtest.rs#L3344">https://github.com/rust-lang/rust/blob/1f12ac87296ac61ec002e0243e7ad5a50364da35/src/tools/compiletest/src/runtest.rs#L3344</a></p>



<a name="257954847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/257954847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#257954847">(Oct 17 2021 at 22:45)</a>:</h4>
<p>Looks like it's something that can be reused with the custom normalization rules...</p>



<a name="258111621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258111621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258111621">(Oct 18 2021 at 22:37)</a>:</h4>
<p>This might just do it! <a href="https://github.com/rust-lang/rust/pull/89836/commits/399a6fcc389be39c272675058b6b8e17d3a7bdb0">https://github.com/rust-lang/rust/pull/89836/commits/399a6fcc389be39c272675058b6b8e17d3a7bdb0</a></p>



<a name="258115932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258115932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258115932">(Oct 18 2021 at 23:07)</a>:</h4>
<p>Almost...</p>



<a name="258129593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258129593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258129593">(Oct 19 2021 at 01:58)</a>:</h4>
<p>We made it much further this time: <a href="https://github.com/rust-lang/rust/pull/89836/checks?check_run_id=3933757100#step:25:3664">https://github.com/rust-lang/rust/pull/89836/checks?check_run_id=3933757100#step:25:3664</a></p>



<a name="258129768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258129768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258129768">(Oct 19 2021 at 02:00)</a>:</h4>
<p>Made it all the way through stage1</p>



<a name="258129992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258129992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258129992">(Oct 19 2021 at 02:03)</a>:</h4>
<p>The failures are all in <code>mir-opt</code> tests that have 32 and 64 bit versions...</p>



<a name="258213551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258213551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258213551">(Oct 19 2021 at 15:19)</a>:</h4>
<p>I can't figure out what's up with this error! <a href="https://github.com/rust-lang/rust/pull/89836/checks?check_run_id=3940911038#step:25:1685">https://github.com/rust-lang/rust/pull/89836/checks?check_run_id=3940911038#step:25:1685</a></p>
<p>This file was updated when I did a <code>--bless</code>. But upstream doesn't like it :( And it doesn't have an obvious relation to the work I'm doing in this branch...</p>



<a name="258214347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258214347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258214347">(Oct 19 2021 at 15:23)</a>:</h4>
<p>Reverting <code>src/test/ui/single-use-lifetime/one-use-in-fn-argument-in-band.stderr</code> to master, it keeps wanting to change with <code>--bless</code>, but then fails CI. Guess I'll just ignore the <code>--bless</code></p>



<a name="258227713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258227713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258227713">(Oct 19 2021 at 16:35)</a>:</h4>
<p><span class="user-mention" data-user-id="316352">@pierwill</span> Have you rebased against the later master?</p>



<a name="258236271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258236271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258236271">(Oct 19 2021 at 17:19)</a>:</h4>
<p>I do believe so :)</p>



<a name="258236315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258236315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258236315">(Oct 19 2021 at 17:19)</a>:</h4>
<p>Always worth another shot</p>



<a name="258237967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258237967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258237967">(Oct 19 2021 at 17:28)</a>:</h4>
<p><span class="user-mention" data-user-id="125294">@Aaron Hill</span> Yep, the branch is up-to-date</p>



<a name="258240349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258240349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258240349">(Oct 19 2021 at 17:41)</a>:</h4>
<p>In GH (sorry to bounce back and forth <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span> )</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> I think the test incorrectly depends on the sort order of DefId. It may need a .sort_by_key() somewhere.</p>
</blockquote>
<p><del>Maybe defids need to be sorted in <a href="https://github.com/rust-lang/rust/blob/6bc80bd8c2b37900e78061f4bf64f525e4dfd3ac/compiler/rustc_resolve/src/late/lifetimes.rs#L1905">https://github.com/rust-lang/rust/blob/6bc80bd8c2b37900e78061f4bf64f525e4dfd3ac/compiler/rustc_resolve/src/late/lifetimes.rs#L1905</a>? </del></p>



<a name="258240566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258240566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258240566">(Oct 19 2021 at 17:42)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="258243472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258243472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258243472">(Oct 19 2021 at 17:59)</a>:</h4>
<p>There is sorting of defids going on here <a href="https://github.com/rust-lang/rust/blob/6bc80bd8c2b37900e78061f4bf64f525e4dfd3ac/compiler/rustc_resolve/src/late/lifetimes.rs#L2028">https://github.com/rust-lang/rust/blob/6bc80bd8c2b37900e78061f4bf64f525e4dfd3ac/compiler/rustc_resolve/src/late/lifetimes.rs#L2028</a> before the call to <code>suggest_eliding_single_use_lifetime</code>...</p>



<a name="258245159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258245159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258245159">(Oct 19 2021 at 18:08)</a>:</h4>
<p>Maybe the <code>sort_by_cached_key</code> is not deterministic enough?</p>



<a name="258245191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258245191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258245191">(Oct 19 2021 at 18:08)</a>:</h4>
<p>(I'm just thinking out loud)</p>



<a name="258245518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258245518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258245518">(Oct 19 2021 at 18:10)</a>:</h4>
<p>Okay wow this worked:</p>
<div class="codehilite"><pre><span></span><code>modified   compiler/rustc_resolve/src/late/lifetimes.rs
@@ -2025,7 +2025,7 @@ fn check_uses_for_lifetimes_defined_by_scope(&amp;mut self) {
             .collect();

         // ensure that we issue lints in a repeatable order
-        def_ids.sort_by_cached_key(|&amp;def_id| self.tcx.def_path_hash(def_id));
+        def_ids.sort();
</code></pre></div>
<p>Wonder if this'll affect performance, though, or cause other problems...</p>



<a name="258250508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258250508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258250508">(Oct 19 2021 at 18:41)</a>:</h4>
<p>You need to sort decide using the hash - otherwise, you'll cause problems with incremental compilation</p>



<a name="258251000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258251000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258251000">(Oct 19 2021 at 18:45)</a>:</h4>
<p>In that case, I wonder how else to work around this issue... Why is the original sorting causing problems for the elided lifetime test?</p>



<a name="258252075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258252075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258252075">(Oct 19 2021 at 18:52)</a>:</h4>
<p>Ah. Maybe <code>sort_by_key</code> will work after all...</p>



<a name="258252275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258252275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258252275">(Oct 19 2021 at 18:53)</a>:</h4>
<p>Nope :(</p>



<a name="258271514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258271514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258271514">(Oct 19 2021 at 21:02)</a>:</h4>
<p>Reverted back to original code of sorting DefIds. It passes CI this time when it was failing before. But I'm suspicious...</p>



<a name="258271624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258271624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258271624">(Oct 19 2021 at 21:03)</a>:</h4>
<p>Still fails locally.</p>



<a name="258272432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258272432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258272432">(Oct 19 2021 at 21:08)</a>:</h4>
<p>What error are you getting locally?</p>



<a name="258278386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258278386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258278386">(Oct 19 2021 at 21:51)</a>:</h4>
<div class="codehilite"><pre><span></span><code>failures:

---- [ui] ui/single-use-lifetime/one-use-in-fn-argument-in-band.rs stdout ----
diff of stderr:

-   error: lifetime parameter `&#39;a` only used once
-     --&gt; $DIR/one-use-in-fn-argument-in-band.rs:11:10
+   error: lifetime parameter `&#39;b` only used once
+     --&gt; $DIR/one-use-in-fn-argument-in-band.rs:11:22
3      |
4   LL | fn a(x: &amp;&#39;a u32, y: &amp;&#39;b u32) {
-      |          ^^-
-      |          |
-      |          this lifetime is only used here
-      |          help: elide the single-use lifetime
+      |                      ^^-
+      |                      |
+      |                      this lifetime is only used here
+      |                      help: elide the single-use lifetime
9      |
10  note: the lint level is defined here
11    --&gt; $DIR/one-use-in-fn-argument-in-band.rs:4:9

13  LL | #![deny(single_use_lifetimes)]
14     |         ^^^^^^^^^^^^^^^^^^^^
15
-   error: lifetime parameter `&#39;b` only used once
-     --&gt; $DIR/one-use-in-fn-argument-in-band.rs:11:22
+   error: lifetime parameter `&#39;a` only used once
+     --&gt; $DIR/one-use-in-fn-argument-in-band.rs:11:10
18     |
19  LL | fn a(x: &amp;&#39;a u32, y: &amp;&#39;b u32) {
-      |                      ^^-
-      |                      |
-      |                      this lifetime is only used here
-      |                      help: elide the single-use lifetime
+      |          ^^-
+      |          |
+      |          this lifetime is only used here
+      |          help: elide the single-use lifetime
24
25  error: aborting due to 2 previous errors
26


The actual stderr differed from the expected stderr.
Actual stderr saved to /Users/wpierce/repos/rust/build/x86_64-apple-darwin/test/ui/single-use-lifetime/one-use-in-fn-argument-in-band/one-use-in-fn-argument-in-band.stderr
To update references, rerun the tests and pass the `--bless` flag
To only update this specific test, also pass `--test-args single-use-lifetime/one-use-in-fn-argument-in-band.rs`

error: 1 errors occurred comparing output.
status: exit status: 1
command: &quot;/Users/wpierce/repos/rust/build/x86_64-apple-darwin/stage1/bin/rustc&quot; &quot;/Users/wpierce/repos/rust/src/test/ui/single-use-lifetime/one-use-in-fn-argument-in-band.rs&quot; &quot;-Zthreads=1&quot; &quot;--target=x86_64-apple-darwin&quot; &quot;--error-format&quot; &quot;json&quot; &quot;-Ccodegen-units=1&quot; &quot;-Zui-testing&quot; &quot;-Zdeduplicate-diagnostics=no&quot; &quot;-Zemit-future-incompat-report&quot; &quot;--emit&quot; &quot;metadata&quot; &quot;-C&quot; &quot;prefer-dynamic&quot; &quot;--out-dir&quot; &quot;/Users/wpierce/repos/rust/build/x86_64-apple-darwin/test/ui/single-use-lifetime/one-use-in-fn-argument-in-band&quot; &quot;-A&quot; &quot;unused&quot; &quot;-Crpath&quot; &quot;-O&quot; &quot;-Cdebuginfo=0&quot; &quot;-Lnative=/Users/wpierce/repos/rust/build/x86_64-apple-darwin/native/rust-test-helpers&quot; &quot;-L&quot; &quot;/Users/wpierce/repos/rust/build/x86_64-apple-darwin/test/ui/single-use-lifetime/one-use-in-fn-argument-in-band/auxiliary&quot;
stdout:
------------------------------------------

------------------------------------------
stderr:
------------------------------------------
error: lifetime parameter `&#39;b` only used once
  --&gt; /Users/wpierce/repos/rust/src/test/ui/single-use-lifetime/one-use-in-fn-argument-in-band.rs:11:22
   |
LL | fn a(x: &amp;&#39;a u32, y: &amp;&#39;b u32) {
   |                      ^^-
   |                      |
   |                      this lifetime is only used here
   |                      help: elide the single-use lifetime
   |
note: the lint level is defined here
  --&gt; /Users/wpierce/repos/rust/src/test/ui/single-use-lifetime/one-use-in-fn-argument-in-band.rs:4:9
   |
LL | #![deny(single_use_lifetimes)]
   |         ^^^^^^^^^^^^^^^^^^^^

error: lifetime parameter `&#39;a` only used once
  --&gt; /Users/wpierce/repos/rust/src/test/ui/single-use-lifetime/one-use-in-fn-argument-in-band.rs:11:10
   |
LL | fn a(x: &amp;&#39;a u32, y: &amp;&#39;b u32) {
   |          ^^-
   |          |
   |          this lifetime is only used here
   |          help: elide the single-use lifetime

error: aborting due to 2 previous errors


------------------------------------------



failures:
    [ui] ui/single-use-lifetime/one-use-in-fn-argument-in-band.rs

test result: FAILED. 12191 passed; 1 failed; 117 ignored; 0 measured; 0 filtered out; finished in 459.74s

Some tests failed in compiletest suite=ui mode=ui host=x86_64-apple-darwin target=x86_64-apple-darwin
</code></pre></div>



<a name="258279393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258279393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258279393">(Oct 19 2021 at 21:59)</a>:</h4>
<p>The lints are in the wrong order</p>



<a name="258410866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258410866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258410866">(Oct 20 2021 at 17:38)</a>:</h4>
<p>Summary: I <em>think</em> <a href="https://github.com/rust-lang/rust/blob/d6d824f7890922185bd3a0a5dc120b1f4e8bb426/compiler/rustc_resolve/src/late/lifetimes.rs#L2028">this line</a> is not doing its job when it comes <a href="https://github.com/rust-lang/rust/blob/d6d824f7890922185bd3a0a5dc120b1f4e8bb426/compiler/rustc_resolve/src/late/lifetimes.rs#L2097-L2120">to this lint code</a>.</p>



<a name="258418133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258418133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258418133">(Oct 20 2021 at 18:23)</a>:</h4>
<p>Does <code>CFG_VERSION</code> contain anything platform-specific?</p>



<a name="258418986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258418986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258418986">(Oct 20 2021 at 18:28)</a>:</h4>
<p>Last time I added a println for this somewhere during this test, mine said only <code>rustc-1.58-dev</code> or something similar.</p>



<a name="258419052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419052">(Oct 20 2021 at 18:29)</a>:</h4>
<p>It can contain also arbitrary metadata set at compile-time (config.toml description, e.g., "debian")</p>



<a name="258419102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419102">(Oct 20 2021 at 18:29)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/3d71e749a244890cd370d49963e747cf92f4a037/src/bootstrap/lib.rs#L1214-L1222">https://github.com/rust-lang/rust/blob/3d71e749a244890cd370d49963e747cf92f4a037/src/bootstrap/lib.rs#L1214-L1222</a></p>



<a name="258419117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419117">(Oct 20 2021 at 18:29)</a>:</h4>
<p>Ah okay. Does that account for this lifetime lint order problem, though?</p>



<a name="258419242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419242">(Oct 20 2021 at 18:30)</a>:</h4>
<p>Maybe if it's being updated between bootstrapping and test exec?</p>



<a name="258419306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419306">(Oct 20 2021 at 18:30)</a>:</h4>
<p>It feels like including this string into the crate hash <em>shouldn't</em> be good enough: at the very least, that implies bad behavior when building locally with ignore-git=true, which we want to avoid</p>



<a name="258419448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419448">(Oct 20 2021 at 18:31)</a>:</h4>
<p>I guess this is just aiming for a maybe-we-catch-a-bug fix?</p>



<a name="258419571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419571">(Oct 20 2021 at 18:32)</a>:</h4>
<p>TBH, I understood <span class="user-mention" data-user-id="133247">@bjorn3</span> 's original issue for this as a <em>security</em> issue</p>



<a name="258419577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419577">(Oct 20 2021 at 18:32)</a>:</h4>
<p>but the main thing this contains is e.g. the -beta or -stable string, not to mention the version number, all of which can change as we produce different rustc binaries</p>



<a name="258419626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419626">(Oct 20 2021 at 18:32)</a>:</h4>
<p>and so if our test suite relies on that string it's generally painful, we shouldn't</p>



<a name="258419717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419717">(Oct 20 2021 at 18:33)</a>:</h4>
<p>It is not entirely a security issue. More of a mitigation to prevent potential security issues if someone tries to incorrectly interpose rust dylibs.</p>



<a name="258419736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419736">(Oct 20 2021 at 18:33)</a>:</h4>
<p>Right, right</p>



<a name="258419953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258419953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258419953">(Oct 20 2021 at 18:35)</a>:</h4>
<p>I feel like this reduces our reproducibility across different compiler versions, which generally makes e.g. perf work harder and requires normalization in the test suite -- I'm not convinced it's worth the possible benefits</p>



<a name="258420223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258420223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258420223">(Oct 20 2021 at 18:36)</a>:</h4>
<p>FWIW I was able to implement some fairly robust normalization of these symbol hashes for mir-opt. Should be able to do the same for ui tests</p>



<a name="258420337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258420337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258420337">(Oct 20 2021 at 18:37)</a>:</h4>
<p>(Instead of ad hoc approach to ui tests in the PR currently)</p>



<a name="258420926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258420926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258420926">(Oct 20 2021 at 18:41)</a>:</h4>
<p>This just sounds spooky to me: "This makes it possible to replace a rust dylib compiled with one version of rustc with one compiled by another version of rustc even if the ABI doesn't match." (<a href="https://github.com/rust-lang/rust/issues/85142">https://github.com/rust-lang/rust/issues/85142</a>) <span aria-label="innocent" class="emoji emoji-1f607" role="img" title="innocent">:innocent:</span> <span aria-label="ghost" class="emoji emoji-1f47b" role="img" title="ghost">:ghost:</span></p>



<a name="258421571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258421571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258421571">(Oct 20 2021 at 18:45)</a>:</h4>
<p>Sure, I don't disagree that it's not <em>great</em>, but it's also only the case if you're manually linking -- rustc itself will look at metadata when loading the dylib and err out</p>



<a name="258421757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258421757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258421757">(Oct 20 2021 at 18:46)</a>:</h4>
<p>I don't think it's something we generally try to protect you against, though, beyond pushing people to use extern "C" and repr(C) structs for any FFI (even rust&lt;&gt;rust)</p>



<a name="258422036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258422036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258422036">(Oct 20 2021 at 18:48)</a>:</h4>
<p>Ah okay, interesting.</p>



<a name="258422169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258422169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258422169">(Oct 20 2021 at 18:49)</a>:</h4>
<p>in some sense this is no different to linking against C code which changed a function signature and you didn't update your headers</p>



<a name="258422353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258422353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258422353">(Oct 20 2021 at 18:50)</a>:</h4>
<p>anyway, if you can fix CI with sufficient normalization, it seems "OK". It probably hurts efforts to reuse e.g. PGO data across builds, but most people won't be doing that with different compiler versions anyway.</p>



<a name="258422502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258422502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258422502">(Oct 20 2021 at 18:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Add.20rustc.20version.20to.20crate.20hash/near/258421571">said</a>:</p>
<blockquote>
<p>Sure, I don't disagree that it's not <em>great</em>, but it's also only the case if you're manually linking -- rustc itself will look at metadata when loading the dylib and err out</p>
</blockquote>
<p>Rustc can't look at it when changing the dylib at runtime. That is the case I am worried about.</p>



<a name="258422603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258422603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258422603">(Oct 20 2021 at 18:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Add.20rustc.20version.20to.20crate.20hash/near/258422353">said</a>:</p>
<blockquote>
<p>anyway, if you can fix CI with sufficient normalization, it seems "OK". It probably hurts efforts to reuse e.g. PGO data across builds, but most people won't be doing that with different compiler versions anyway.</p>
</blockquote>
<p>Is that even safe in the first place when using different compiler versions? The LLVM version may be different.</p>



<a name="258422712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258422712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258422712">(Oct 20 2021 at 18:52)</a>:</h4>
<p>PGO data embeds the version number and isn't LLVM IR, I'm pretty sure it's intended to work well if the version number doesn't bump</p>



<a name="258422820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258422820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258422820">(Oct 20 2021 at 18:53)</a>:</h4>
<p>Perhaps there should be a team discussion before I continue to fix the CI issues here?</p>



<a name="258422877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258422877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258422877">(Oct 20 2021 at 18:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Add.20rustc.20version.20to.20crate.20hash/near/258422169">said</a>:</p>
<blockquote>
<p>in some sense this is no different to linking against C code which changed a function signature and you didn't update your headers</p>
</blockquote>
<p>That is where my other issue about including a hash of the function signature is about. This issue is about changing the rustc version. People from the C/C++ world may expect this to work as it is allowed just fine with GCC and Clang.</p>



<a name="258423066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258423066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258423066">(Oct 20 2021 at 18:54)</a>:</h4>
<blockquote>
<p>That is where my other issue about including a hash of the function signature is about.</p>
</blockquote>
<p>Note that in this case the legacy symbol mangling scheme already does this for the exact reason of being a safety net.</p>



<a name="258423114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258423114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258423114">(Oct 20 2021 at 18:54)</a>:</h4>
<p>Right, yeah, hashing function signature seems like a not-terrible idea</p>



<a name="258423183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258423183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258423183">(Oct 20 2021 at 18:54)</a>:</h4>
<p>I'd also like to work on that one. I'm assigned at the moment :)</p>



<a name="258423249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258423249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258423249">(Oct 20 2021 at 18:55)</a>:</h4>
<p>Anyway, I have no real objection, just mild reservations.</p>



<a name="258424017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258424017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258424017">(Oct 20 2021 at 18:59)</a>:</h4>
<blockquote>
<p>I'd also like to work on that one. I'm assigned at the moment :)</p>
</blockquote>
<p>cc <span class="user-mention" data-user-id="119009">@eddyb</span> <a href="https://github.com/rust-lang/rust/issues/87223">#87223</a> will require a change to the v0 mangling scheme to include the function signature hash. Or maybe it can be included as "crate disambiguator" for the function name or something like that?</p>



<a name="258424321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258424321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258424321">(Oct 20 2021 at 19:00)</a>:</h4>
<p>wait why do we want that?</p>



<a name="258424544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258424544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258424544">(Oct 20 2021 at 19:01)</a>:</h4>
<p>is that really useful when most of the details hide behind type names?</p>



<a name="258424715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258424715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258424715">(Oct 20 2021 at 19:02)</a>:</h4>
<p>To ensure that if someone (eg distro packager) decides to replace a rust dylib with one compiled from a different source there will be less of a risk that the abi doesn't match, but it still seems to work.</p>



<a name="258424814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258424814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258424814">(Oct 20 2021 at 19:03)</a>:</h4>
<p>But possibly introduce a crash or worse security vulnerability.</p>



<a name="258424877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258424877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258424877">(Oct 20 2021 at 19:03)</a>:</h4>
<p>we decided against this during the RFC...</p>



<a name="258424888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258424888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258424888">(Oct 20 2021 at 19:03)</a>:</h4>
<p>(cc <span class="user-mention" data-user-id="124287">@mw</span>)</p>



<a name="258425036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258425036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258425036">(Oct 20 2021 at 19:04)</a>:</h4>
<p>there are so many wrong things here and I don't really have the spare time to dive into it</p>



<a name="258425133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258425133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258425133">(Oct 20 2021 at 19:05)</a>:</h4>
<p>I can't think of a solution that's not just aesthetic, which isn't "don't let distros abuse dylibs"</p>



<a name="258425319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258425319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258425319">(Oct 20 2021 at 19:06)</a>:</h4>
<p>if the crate disambiguator hash matches, but the source doesn't, then symbol names containing a bit more information won't save you</p>



<a name="258425460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258425460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258425460">(Oct 20 2021 at 19:07)</a>:</h4>
<blockquote>
<p>we decided against this during the RFC...</p>
</blockquote>
<p>I skimmed the rfc discussion and I saw a reference to including the full signature, but not a signature hash.</p>



<a name="258425463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258425463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258425463">(Oct 20 2021 at 19:07)</a>:</h4>
<p>we assume in so many situations that it's an impossible outcode. Cargo and distros have to prevent it, <code>rustc</code> doesn't have enough power (although we could try using SVHs in symbol names, that's the closest thing I think?)</p>



<a name="258425507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258425507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258425507">(Oct 20 2021 at 19:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Add.20rustc.20version.20to.20crate.20hash/near/258425460">said</a>:</p>
<blockquote>
<blockquote>
<p>we decided against this during the RFC...</p>
</blockquote>
<p>I skimmed the rfc discussion and I saw a reference to including the full signature, but not a signature hash.</p>
</blockquote>
<p>ignoring the cost, my issue with it is the <em>futility</em></p>



<a name="258425564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258425564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258425564">(Oct 20 2021 at 19:07)</a>:</h4>
<p>you can keep all function signatures unchanged but change type definitions</p>



<a name="258425826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258425826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258425826">(Oct 20 2021 at 19:09)</a>:</h4>
<p>or some other subtleties</p>



<a name="258425842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258425842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258425842">(Oct 20 2021 at 19:09)</a>:</h4>
<p>Then the function signature hash needs to include the hash of all referenced type definitions. I understand that can quickly get very expensive though.</p>



<a name="258425948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258425948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258425948">(Oct 20 2021 at 19:10)</a>:</h4>
<p>frankly linking against a <code>dylib</code> crate type should somehow embed an SVH at this point</p>



<a name="258426003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258426003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258426003">(Oct 20 2021 at 19:10)</a>:</h4>
<p>can we (ab)use SOVERSION for this?</p>



<a name="258426086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258426086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258426086">(Oct 20 2021 at 19:11)</a>:</h4>
<p>it should be rare enough that making it stricter/slightly more expensive is fine as long as it doesn't impact our use of e.g. <code>librustc_driver.so</code></p>



<a name="258426303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258426303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258426303">(Oct 20 2021 at 19:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Add.20rustc.20version.20to.20crate.20hash/near/258425948">said</a>:</p>
<blockquote>
<p>frankly linking against a <code>dylib</code> crate type should somehow embed an SVH at this point</p>
</blockquote>
<p>(i.e. my point is that trying to split the information that goes into an SVH, into "can cause unsoundness" and "can't cause unsoundness" is futile and we should make it illegal to dynamically load the wrong <code>.so</code>)</p>



<a name="258426333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258426333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258426333">(Oct 20 2021 at 19:12)</a>:</h4>
<p>I guess we should postpone including the function signature hash  until it becomes more important. (eg the mentioned dylib replacements actually happening in practice or if we start to allow replacing dylibs provided that the abi stays the same where the abi includes all the mir of all inline and generic functions)</p>



<a name="258426407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258426407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258426407">(Oct 20 2021 at 19:13)</a>:</h4>
<p>I guess we could generate a global constructor that calls a function from the <code>.so</code> with the SVH in its symbol name</p>



<a name="258426487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258426487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258426487">(Oct 20 2021 at 19:14)</a>:</h4>
<p>the call itself should be cheaper than the dynamic linker's lookup</p>



<a name="258426661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258426661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258426661">(Oct 20 2021 at 19:15)</a>:</h4>
<p>anything else is a compromise that provides a false sense of security while making unnecessary extra work for legitimate usecases, IMO</p>



<a name="258426864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258426864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258426864">(Oct 20 2021 at 19:16)</a>:</h4>
<p>That would be an option. Another would be to have each dylib provide a function with the SVH that calls the functions of their dependent dylibs and have the main shim for the executable call the one functions from all dependent dylibs. That won't work if the main function isn't from rust though.</p>



<a name="258426881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258426881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258426881">(Oct 20 2021 at 19:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Add.20rustc.20version.20to.20crate.20hash/near/258426661">said</a>:</p>
<blockquote>
<p>anything else is a compromise that provides a false sense of security while making unnecessary extra work for legitimate usecases, IMO</p>
</blockquote>
<p>yeah, this is basically my worry</p>



<a name="258426907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258426907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258426907">(Oct 20 2021 at 19:16)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Have you had a chance to look at <a href="https://github.com/rust-lang/rust/pull/89836">https://github.com/rust-lang/rust/pull/89836</a>?</p>



<a name="258427022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258427022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258427022">(Oct 20 2021 at 19:17)</a>:</h4>
<p>haven't seen it until now, but the idea at a glance seems solid</p>



<a name="258427141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258427141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258427141">(Oct 20 2021 at 19:18)</a>:</h4>
<p>I was sad to find that e.g. <code>TypeId</code>s don't always change with compiler version, that would be another thing to look at (unless you've already done so :P)</p>



<a name="258427347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258427347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258427347">(Oct 20 2021 at 19:19)</a>:</h4>
<p>I would probably go further and make <code>StableHasher</code> itself get seeded by a value computed from e.g. <code>CFG_VERSION</code>, but I'm less familiar with its entire set of usecases</p>



<a name="258427448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258427448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258427448">(Oct 20 2021 at 19:19)</a>:</h4>
<p><code>TypeId</code> should already change with that PR for user defined types. For primitive types I think it will still be constant.</p>



<a name="258427489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258427489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258427489">(Oct 20 2021 at 19:20)</a>:</h4>
<p>yeah I was thinking of primitive types</p>



<a name="258433495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258433495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258433495">(Oct 20 2021 at 19:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Add.20rustc.20version.20to.20crate.20hash/near/258418133">said</a>:</p>
<blockquote>
<p>Does <code>CFG_VERSION</code> contain anything platform-specific?</p>
</blockquote>
<p>To return to the mystery ui error, did you have follow-up thoughts here, <span class="user-mention" data-user-id="125294">@Aaron Hill</span> or others?</p>



<a name="258433584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258433584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258433584">(Oct 20 2021 at 19:57)</a>:</h4>
<p>See <a href="https://github.com/rust-lang/rust/runs/3941173894#step:25:1695">https://github.com/rust-lang/rust/runs/3941173894#step:25:1695</a></p>



<a name="258556845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258556845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258556845">(Oct 21 2021 at 14:36)</a>:</h4>
<p>This single-use-lifetime test is now failing in an unpredictable (to me) way:</p>
<ol>
<li><a href="https://github.com/rust-lang/rust/runs/3959909169#step:25:1658">https://github.com/rust-lang/rust/runs/3959909169#step:25:1658</a></li>
<li><a href="https://github.com/rust-lang/rust/runs/3965045272#step:25:1628">https://github.com/rust-lang/rust/runs/3965045272#step:25:1628</a></li>
</ol>
<p>Between these two runs I made a tiny change to a test output and rebased to current master. The first past, the second failed.</p>



<a name="258590112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258590112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258590112">(Oct 21 2021 at 17:57)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span>  Ah! Maybe we need to somehow use the <code>StableCrateId</code> in this sorting operation? <a href="https://github.com/pierwill/rust/blob/c291ec4d0bb6daf52281a0c2304dac0e2d4dc6f8/compiler/rustc_resolve/src/late/lifetimes.rs#L2026">https://github.com/pierwill/rust/blob/c291ec4d0bb6daf52281a0c2304dac0e2d4dc6f8/compiler/rustc_resolve/src/late/lifetimes.rs#L2026</a></p>



<a name="258592540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258592540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258592540">(Oct 21 2021 at 18:12)</a>:</h4>
<p>is something like this crazy? </p>
<div class="codehilite"><pre><span></span><code>        // ensure that we issue lints in a repeatable order
        def_ids.sort_by_key(|&amp;def_id| {
            // append stablecrateid to def_path_hash before sorting
            let fingerprint = self.tcx.def_path_hash(def_id);
            let c = self.tcx.stable_crate_id(def_id.krate).to_u64;
            let (a, b) = fingerprint.0.as_value();
            let sorter = a + b + c;
            sorter
        });
</code></pre></div>



<a name="258593123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258593123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258593123">(Oct 21 2021 at 18:17)</a>:</h4>
<p>The DefPathHash already includes the StableCrateId. I think that is the actual issue. I think two defid's from different crates are compared and because the StableCrateId changes, their relative order changes.</p>



<a name="258593342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258593342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258593342">(Oct 21 2021 at 18:18)</a>:</h4>
<p>Ah. Hm <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="258593725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258593725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258593725">(Oct 21 2021 at 18:21)</a>:</h4>
<p>maybe we can use DefPathHash::new with a dummy stable crateid? Is that too much of a hack?</p>



<a name="258593763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258593763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258593763">(Oct 21 2021 at 18:21)</a>:</h4>
<p><a href="https://github.com/pierwill/rust/blob/c291ec4d0bb6daf52281a0c2304dac0e2d4dc6f8/compiler/rustc_span/src/def_id.rs#L117">https://github.com/pierwill/rust/blob/c291ec4d0bb6daf52281a0c2304dac0e2d4dc6f8/compiler/rustc_span/src/def_id.rs#L117</a></p>



<a name="258595191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258595191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258595191">(Oct 21 2021 at 18:30)</a>:</h4>
<p>Maybe</p>
<div class="codehilite"><pre><span></span><code>        // ensure that we issue lints in a repeatable order
        def_ids.sort_by_cached_key(|&amp;def_id| {
            self.tcx.def_path_hash(def_id.as_local().unwrap().to_def_id())
        });
</code></pre></div>
<p>would "forget" the stablecrateid?</p>



<a name="258596186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258596186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258596186">(Oct 21 2021 at 18:36)</a>:</h4>
<blockquote>
<p>"forget" the stablecrateid?</p>
</blockquote>
<p>Giving this a try in CI now <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span> <a href="https://github.com/rust-lang/rust/runs/3967697881?check_suite_focus=true">https://github.com/rust-lang/rust/runs/3967697881?check_suite_focus=true</a></p>



<a name="258597760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258597760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258597760">(Oct 21 2021 at 18:48)</a>:</h4>
<p>Looks like the only other <code>sort_by_cached_key</code> of defpathhashes are for traits:</p>
<div class="codehilite"><pre><span></span><code>rustc_metadata/src/rmeta/encoder.rs
1791:        all_impls.sort_by_cached_key(|&amp;(trait_def_id, _)| tcx.def_path_hash(trait_def_id));
rustc_trait_selection/src/traits/object_safety.rs
571:    associated_types.sort_by_cached_key(|(_, item)| tcx.def_path_hash(item.def_id));
</code></pre></div>
<p>Will these be affected by the changing crate hashes?</p>



<a name="258600961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258600961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258600961">(Oct 21 2021 at 19:11)</a>:</h4>
<p>it worked! <span aria-label="champagne" class="emoji emoji-1f37e" role="img" title="champagne">:champagne:</span>  <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <a href="https://github.com/rust-lang/rust/runs/3967697881">https://github.com/rust-lang/rust/runs/3967697881</a></p>



<a name="258602186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258602186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258602186">(Oct 21 2021 at 19:20)</a>:</h4>
<p>This will cause issues for incr comp if two crates have a definition with the same local part of the defpathhash.</p>



<a name="258602221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258602221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258602221">(Oct 21 2021 at 19:20)</a>:</h4>
<p>Oh no!</p>



<a name="258602286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258602286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258602286">(Oct 21 2021 at 19:21)</a>:</h4>
<p>"This" meaning the sorting I did in the lifetime lint?</p>



<a name="258602342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258602342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258602342">(Oct 21 2021 at 19:21)</a>:</h4>
<p>yes</p>



<a name="258602430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258602430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258602430">(Oct 21 2021 at 19:22)</a>:</h4>
<p>Darn. Have any thoughts on other ways to handle this?</p>



<a name="258602487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258602487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258602487">(Oct 21 2021 at 19:22)</a>:</h4>
<p>There's got to be some sorting logic that will work for this, right?</p>



<a name="258602506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258602506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258602506">(Oct 21 2021 at 19:22)</a>:</h4>
<p>a bit of a hack, but maybe you could reverse the order in which the fields are compared. that is first compare the local part and if it is equal compare the stablecrateid.</p>



<a name="258602557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258602557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258602557">(Oct 21 2021 at 19:23)</a>:</h4>
<p>Ah that doesn't sound too bad, really</p>



<a name="258602641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258602641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258602641">(Oct 21 2021 at 19:23)</a>:</h4>
<p>Thank you. Will try that</p>



<a name="258604606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258604606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258604606">(Oct 21 2021 at 19:37)</a>:</h4>
<p>Will this require iterating over the def_ids? Seems like the need to compare means it can't be done just in the closure...</p>



<a name="258605278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258605278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258605278">(Oct 21 2021 at 19:42)</a>:</h4>
<p>You could use <code>(local_part, stable_crate_id)</code> as return value of the closure.</p>



<a name="258605657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258605657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258605657">(Oct 21 2021 at 19:45)</a>:</h4>
<p>Huh, so you can pass tuples to the sort method and it'll do the right thing?</p>



<a name="258605793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258605793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258605793">(Oct 21 2021 at 19:46)</a>:</h4>
<p>I'm still lost on the logic inside the closure. I'll need two def_ids to compare, right?</p>



<a name="258606060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258606060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258606060">(Oct 21 2021 at 19:48)</a>:</h4>
<p><code>sort_by_cached_key</code> requires the closure to return the key to sort by. It will then do the key comparisons for you.</p>



<a name="258606126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258606126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258606126">(Oct 21 2021 at 19:48)</a>:</h4>
<p>ah i think i see</p>



<a name="258606208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258606208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258606208">(Oct 21 2021 at 19:49)</a>:</h4>
<p>It's not really that hard. basically:</p>
<div class="codehilite"><pre><span></span><code>        // ensure that we issue lints in a repeatable order
        def_ids.sort_by_cached_key(|&amp;def_id| -&gt; (u64 /*local_part*/, StableCrateId) {
            (self.tcx.def_path_hash(def_id).local_hash(), stablecrateid)

        });
</code></pre></div>



<a name="258606380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258606380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258606380">(Oct 21 2021 at 19:50)</a>:</h4>
<p>Pretty much. The stablecrateid is part of the def_path_hash though.</p>



<a name="258606437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258606437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258606437">(Oct 21 2021 at 19:51)</a>:</h4>
<p>oh right... there's some other field or method for what i want...</p>



<a name="258606594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258606594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258606594">(Oct 21 2021 at 19:52)</a>:</h4>
<p><code>def_path_hash.0.as_value()</code> will give you a tuple. The first item is the stabledefid, the second the local part. Swapping both items should do the trick.</p>



<a name="258606919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258606919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258606919">(Oct 21 2021 at 19:54)</a>:</h4>
<div class="codehilite"><pre><span></span><code>    // To ensure that we issue lints in a repeatable order,
    // we sort the def_ids first by local part, then by crate hash.
    def_ids.sort_by_cached_key(|&amp;def_id| -&gt; (/*crate_hash*/ u64, /*local_part*/ u64) {
        let (crate_hash, local_part) = self.tcx.def_path_hash(def_id).0.as_value();
        (local_part, crate_hash)
    });
</code></pre></div>



<a name="258633211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258633211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258633211">(Oct 21 2021 at 23:24)</a>:</h4>
<p>This doesn't look like it worked :( <a href="https://github.com/rust-lang/rust/runs/3968545149">https://github.com/rust-lang/rust/runs/3968545149</a></p>
<p>At least, the order of these lifetime lints has changed in my branch vs master. Maybe there's a chance it won't change again? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="258637884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258637884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258637884">(Oct 22 2021 at 00:15)</a>:</h4>
<p>Could the defids also be ordered by span????</p>



<a name="258638571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258638571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258638571">(Oct 22 2021 at 00:23)</a>:</h4>
<div class="codehilite"><pre><span></span><code>        def_ids.sort_by_cached_key(|&amp;def_id| {
            let hirid = self.tcx.hir().local_def_id_to_hir_id(def_id.as_local().unwrap());
            let s = self.tcx.hir().span(hirid);
            let (crate_hash, local_part) = self.tcx.def_path_hash(def_id).0.as_value();
            (local_part, crate_hash, s)
        });
</code></pre></div>



<a name="258640089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258640089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258640089">(Oct 22 2021 at 00:41)</a>:</h4>
<p>My next wild guess:</p>
<div class="codehilite"><pre><span></span><code>        def_ids.sort_by_key(|&amp;def_id| {
            let hirid = self.tcx.hir().local_def_id_to_hir_id(def_id.as_local().unwrap());
            let pos = self.tcx.hir().span(hirid).data().lo;
            let (crate_hash, local_part) = self.tcx.def_path_hash(def_id).0.as_value();
            (local_part, crate_hash, pos)
        });
</code></pre></div>



<a name="258640954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258640954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258640954">(Oct 22 2021 at 00:52)</a>:</h4>
<p>This is going to break incremental comp, isn't it <span aria-label="distraught" class="emoji emoji-1f629" role="img" title="distraught">:distraught:</span></p>



<a name="258645316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258645316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258645316">(Oct 22 2021 at 01:44)</a>:</h4>
<p>Update: maybe it'll work after all?</p>



<a name="258663775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258663775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258663775">(Oct 22 2021 at 05:11)</a>:</h4>
<p><span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p>



<a name="258708267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258708267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258708267">(Oct 22 2021 at 13:03)</a>:</h4>
<p>My idea here <a href="https://github.com/rust-lang/rust/pull/89836/commits/291c50db9adb552d8efeba49dfce4b4b64aecd63">https://github.com/rust-lang/rust/pull/89836/commits/291c50db9adb552d8efeba49dfce4b4b64aecd63</a> was to see if we could simply fall back on the order in which the defsid appear in the source</p>



<a name="258736966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258736966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258736966">(Oct 22 2021 at 16:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="316352">pierwill</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Add.20rustc.20version.20to.20crate.20hash/near/258708267">said</a>:</p>
<blockquote>
<p>My idea here <a href="https://github.com/rust-lang/rust/pull/89836/commits/291c50db9adb552d8efeba49dfce4b4b64aecd63">https://github.com/rust-lang/rust/pull/89836/commits/291c50db9adb552d8efeba49dfce4b4b64aecd63</a> was to see if we could simply fall back on the order in which the defids appear in the source</p>
</blockquote>
<p>I was thinking that this would make cases <a href="https://github.com/pierwill/rust/blob/291c50db9adb552d8efeba49dfce4b4b64aecd63/src/test/ui/single-use-lifetime/one-use-in-fn-argument-in-band.stderr">like the one that's been failing</a> be deterministic in the order of lints. I'm naively thinking "okay, if there are multiple lifetime lints that cannot be sorted by hashes, then let's always print them in the order they appear in the source."</p>
<p>Two questions:</p>
<ol>
<li>Am I wrong in thinking that this produces the desired behavior, at least in terms of UI output?</li>
<li>Are there side-effects that disqualify this approach? (perf, incr comp, etc.)</li>
</ol>



<a name="258747315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Add%20rustc%20version%20to%20crate%20hash/near/258747315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Add.20rustc.20version.20to.20crate.20hash.html#258747315">(Oct 22 2021 at 17:47)</a>:</h4>
<p>^ I posted this in the PR as well <a href="https://github.com/rust-lang/rust/pull/89836#issuecomment-949815804">https://github.com/rust-lang/rust/pull/89836#issuecomment-949815804</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>