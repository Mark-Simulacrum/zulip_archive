<html>
<head><meta charset="utf-8"><title>Building the compiler for wasm · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html">Building the compiler for wasm</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268193773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268193773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268193773">(Jan 16 2022 at 16:25)</a>:</h4>
<p>I'm trying to build rustc to be invoked in a WebAssembly environment. The end goal here is to be able to compile Rust code from within a web browser. Has there been any previous effort on this? How did it go? I imagine it would be harder then just running <code>./x.py build --target wasm32-unknown-unknown</code></p>



<a name="268194983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268194983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268194983">(Jan 16 2022 at 16:52)</a>:</h4>
<p>See <a href="https://github.com/rust-lang/miri/issues/722">https://github.com/rust-lang/miri/issues/722</a>. tl;dr: it is possible to compile for wasm32-wasi (not wasm32-unknown-unknown as that doesn't have fs support) with a couple of patches when you aren't using llvm as backend.</p>



<a name="268198109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198109">(Jan 16 2022 at 17:52)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> I wouldn't be able to run it in browser though. Is that literally impossible or just needs some work that no one has put in yet?</p>



<a name="268198207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198207">(Jan 16 2022 at 17:55)</a>:</h4>
<p>I wrote a wasm32-wasi shim capable enough of running rustc: <a href="https://github.com/bjorn3/browser_wasi_shim">https://github.com/bjorn3/browser_wasi_shim</a> You can set the arguments at <a href="https://github.com/bjorn3/browser_wasi_shim/blob/ecf3286faf4081749a40577f2b6e6505dd76ff1f/rustc.html#L20">https://github.com/bjorn3/browser_wasi_shim/blob/ecf3286faf4081749a40577f2b6e6505dd76ff1f/rustc.html#L20</a> and you will need to change the filenames at <a href="https://github.com/bjorn3/browser_wasi_shim/blob/ecf3286faf4081749a40577f2b6e6505dd76ff1f/rustc.html#L40-L53">https://github.com/bjorn3/browser_wasi_shim/blob/ecf3286faf4081749a40577f2b6e6505dd76ff1f/rustc.html#L40-L53</a> to match those in the <code>lib/rustlib/x86_64-unknown-linux-gnu/lib</code> directory of the rustc build directory.</p>



<a name="268198273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198273">(Jan 16 2022 at 17:56)</a>:</h4>
<p>Rustc needs a filesystem presented to it one way or another.</p>



<a name="268198280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198280">(Jan 16 2022 at 17:57)</a>:</h4>
<p>Great, thanks. So if I'm building rustc to work with it, <code>./x.py build --target wasm32-wasi --host wasm32-wasi</code> would work? or are there some tweaks needed</p>



<a name="268198336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198336">(Jan 16 2022 at 17:58)</a>:</h4>
<p>I imagine we could emulate a file system by using the file system API and provide it to rustc</p>



<a name="268198370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198370">(Jan 16 2022 at 17:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="455331">Hamza</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Building.20the.20compiler.20for.20wasm/near/268198336">said</a>:</p>
<blockquote>
<p>I imagine we could emulate a file system by using the file system API and provide it to rustc</p>
</blockquote>
<p>My browser_wasi_shim could be changed to use the filesystem api of the browser, however I don't use chrome so my browser doesn't support it. For this reason I wrote my own vfs for it.</p>



<a name="268198508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198508">(Jan 16 2022 at 18:01)</a>:</h4>
<p>I also don't use chrome. I'll use your shim and see how it goes</p>



<a name="268198525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198525">(Jan 16 2022 at 18:01)</a>:</h4>
<p>What about building rustc though? Can I build it using the command I mentioned above</p>



<a name="268198687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198687">(Jan 16 2022 at 18:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="455331">Hamza</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Building.20the.20compiler.20for.20wasm/near/268198280">said</a>:</p>
<blockquote>
<p>Great, thanks. So if I'm building rustc to work with it, <code>./x.py build --target wasm32-wasi --host wasm32-wasi</code> would work? or are there some tweaks needed</p>
</blockquote>
<p>There are a couple of patches that need to be applied. If you want to run miri in the browser you can use apply <a href="https://github.com/rust-lang/rust/commit/bb6d1d0a0966c04a75389348642e11ae44c86514">https://github.com/rust-lang/rust/commit/bb6d1d0a0966c04a75389348642e11ae44c86514</a> (part of the changes in this commit are already upstreamed) If you want to compile code in the browser you will have to use cg_clif and<code>--target x86_64-unknown-linux-gnu</code> (as cg_clif can't compile for wasm currently) This would roughly entail applying part of the aforementioned commit, removing <code>crate-type = ["dylib"]</code> from <code>compiler/rustc_codegen_cranelift/Cargo.toml</code>, adding all necessary rustc dependencies to this file, adding <code>compiler/rustc_codegen_cranelift</code> as dependency in <code>compiler/rustc_interface/Cargo.toml</code> and replacing <code>_ =&gt; get_codegen_sysroot(backend_name),</code> in <code>rustc_interface::util::get_builtin_codegen_backend</code> with <code>_ =&gt; rustc_codegen_cranelift::__rustc_codegen_backend()</code>.</p>



<a name="268198704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198704">(Jan 16 2022 at 18:05)</a>:</h4>
<p>And also adding <code>codegen-backends = []</code> to <code>config.toml</code> to prevent building cg_llvm.</p>



<a name="268198841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198841">(Jan 16 2022 at 18:08)</a>:</h4>
<p>Wait, that would attempt to build rustc for wasm using cg_clif which isn't supported yet. I believe you have to roughly follow the instructions in <a href="https://github.com/rust-lang/miri/issues/722#issuecomment-819831196">https://github.com/rust-lang/miri/issues/722#issuecomment-819831196</a> to actually build it. (the instructions are for miri, but can be adapted for cg_clif)</p>



<a name="268198853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198853">(Jan 16 2022 at 18:08)</a>:</h4>
<p>What's <code>cg_clif</code>?</p>



<a name="268198866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198866">(Jan 16 2022 at 18:08)</a>:</h4>
<p>rustc_codegen_cranelift (<a href="https://github.com/bjorn3/rustc_codegen_cranelift">https://github.com/bjorn3/rustc_codegen_cranelift</a>)</p>



<a name="268198867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198867">(Jan 16 2022 at 18:08)</a>:</h4>
<p>(This is my first time working with compiler)</p>



<a name="268198876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198876">(Jan 16 2022 at 18:09)</a>:</h4>
<p>It is an alternative and experimental codegen backend based on Cranelift instead of LLVM.</p>



<a name="268198878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198878">(Jan 16 2022 at 18:09)</a>:</h4>
<p>LLVM can't be used for this?</p>



<a name="268198880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198880">(Jan 16 2022 at 18:09)</a>:</h4>
<p>Cranelift is written in pure rust and can easily be compiled for wasm.</p>



<a name="268198947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268198947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268198947">(Jan 16 2022 at 18:10)</a>:</h4>
<p>It is possible LLVM can be compiled for wasm too, but afaik the way rustc uses it mmap is used which wasm doesn't support.</p>



<a name="268199087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268199087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268199087">(Jan 16 2022 at 18:13)</a>:</h4>
<p>Ah, understandable. I'm waiting for <code>src/llvm-project</code> submodule to finish updating. I'll try applying these patches:</p>
<ol>
<li>remove <code>crate-type = ["dylib"]</code> from <code>compiler/rustc_codegen_cranelift/Cargo.toml</code></li>
<li>add all necessary rustc dependencies to <code>compiler/rustc_codegen_cranelift/Cargo.toml</code> file</li>
<li>adding <code>compiler/rustc_codegen_cranelift</code> as dependency in <code>compiler/rustc_interface/Cargo.toml</code>.</li>
<li>replace <code>_ =&gt; get_codegen_sysroot(backend_name</code>), in <code>rustc_interface::util::get_builtin_codegen_backend</code> with <code>_ =&gt; rustc_codegen_cranelift::__rustc_codegen_backend()</code>.</li>
</ol>
<p>then build with <code>./x.py --target x86_64-unknown-linux-gnu --host wasm32-wasi</code></p>
<p>For point 2, what are the necessary dependencies?</p>



<a name="268199160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268199160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268199160">(Jan 16 2022 at 18:15)</a>:</h4>
<p>rustc_middle, rustc_ast, rustc_codegen_ssa, rustc_data_structures, rustc_errors, rustc_fs_util, rustc_hir, rustc_incremental, rustc_index, rustc_interface, rustc_metadata, rustc_session, rustc_span, rustc_target</p>
<p>Also I forgot that</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[allow(unused_extern_crates)]</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">rustc_driver</span><span class="p">;</span><span class="w"></span>
</code></pre></div>
<p>needs to be removed from <code>compiler/rustc_codegen_cranelift/lib.rs</code>.</p>



<a name="268199812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268199812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268199812">(Jan 16 2022 at 18:30)</a>:</h4>
<p>rustc_codegen_cranelift can't depend on rustc_interface because in step 3, it was added as a dependency</p>



<a name="268199816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268199816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268199816">(Jan 16 2022 at 18:30)</a>:</h4>
<p>causes a cyclic dependency</p>



<a name="268199846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268199846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268199846">(Jan 16 2022 at 18:31)</a>:</h4>
<p>Right. The only use is in <code>compiler/rustc_codegen_cranelift/src/debuginfo/mod.rs</code> (<code>rustc_interface::util::version_str().unwrap_or("unknown version")</code>). Replacing it with <code>""</code> is fine.</p>



<a name="268199988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268199988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268199988">(Jan 16 2022 at 18:34)</a>:</h4>
<p>Great, it's compiling. This is the patch that I ended up with: <a href="https://github.com/hamza1311/rust/commit/702c995a6739d2771f63b60e7b4dd3b95f33c980">https://github.com/hamza1311/rust/commit/702c995a6739d2771f63b60e7b4dd3b95f33c980</a></p>



<a name="268200008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268200008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268200008">(Jan 16 2022 at 18:35)</a>:</h4>
<p>I think you will also need to comment out the <code>extern crate rustc_interface;</code> in <a href="http://lib.rs">lib.rs</a>.</p>



<a name="268200080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268200080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268200080">(Jan 16 2022 at 18:36)</a>:</h4>
<p>In addition <code>rustc_interface::util::scoped_thread</code> needs to be replaced with a simple <code>f()</code> call. Otherwise it will panic at runtime trying to spawn a thread.</p>



<a name="268200157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268200157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268200157">(Jan 16 2022 at 18:38)</a>:</h4>
<p>And <code>crate-type = ["dylib"]</code> needs to be removed from <code>compiler/rustc_driver/Cargo.toml</code> too.</p>



<a name="268200173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268200173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268200173">(Jan 16 2022 at 18:38)</a>:</h4>
<p>Other than that I think the patch is fine.</p>



<a name="268200217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268200217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268200217">(Jan 16 2022 at 18:40)</a>:</h4>
<p>Great. Just pushed those changes here at: <a href="https://github.com/hamza1311/rust/commit/9faaeb0de3621889bcb80da3ba665dbdf5f9c504">https://github.com/hamza1311/rust/commit/9faaeb0de3621889bcb80da3ba665dbdf5f9c504</a></p>



<a name="268200437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268200437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268200437">(Jan 16 2022 at 18:44)</a>:</h4>
<p><code>x.py</code> fails because of warnings. Instead of going though and fixing the warnings, how can I remove the <code>-D warnings</code></p>



<a name="268200631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268200631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268200631">(Jan 16 2022 at 18:49)</a>:</h4>
<p>You can set <code>deny-warnings = false</code> in <code>config.toml</code>.</p>



<a name="268200863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268200863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268200863">(Jan 16 2022 at 18:54)</a>:</h4>
<p>One of those changes is giving me an error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0308</span><span class="p">]</span>: <span class="err">`</span><span class="k">match</span><span class="err">`</span><span class="w"> </span><span class="n">arms</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">incompatible</span><span class="w"> </span><span class="n">types</span><span class="w"></span>
<span class="w">   </span><span class="o">-</span>-&gt; <span class="nc">compiler</span><span class="o">/</span><span class="n">rustc_interface</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">util</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">261</span>:<span class="mi">18</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="mi">256</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="w">         </span><span class="k">match</span><span class="w"> </span><span class="n">backend_name</span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="n">DEFAULT_CODEGEN_BACKEND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="mi">257</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">filename</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">filename</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="sc">'.'</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">load_backend_from_dylib</span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()),</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">                                                   </span><span class="o">------------------------------------------</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="o">&lt;</span><span class="p">(</span><span class="k">dyn</span><span class="w"> </span><span class="n">CodegenBackend</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="o">&gt;</span><span class="err">`</span><span class="w"></span>
<span class="mi">258</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="cp">#[cfg(feature = </span><span class="s">"llvm"</span><span class="cp">)]</span><span class="w"></span>
<span class="mi">259</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="s">"llvm"</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">rustc_codegen_llvm</span>::<span class="n">LlvmCodegenBackend</span>::<span class="n">new</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">                       </span><span class="o">-------------------------------------------</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="k">type</span> <span class="err">`</span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="o">&lt;</span><span class="p">(</span><span class="k">dyn</span><span class="w"> </span><span class="n">CodegenBackend</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="o">&gt;</span><span class="err">`</span><span class="w"></span>
<span class="mi">260</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="c1">// backend_name =&gt; get_codegen_sysroot(maybe_sysroot, backend_name),</span>
<span class="mi">261</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">rustc_codegen_cranelift</span>::<span class="n">__rustc_codegen_backend</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">                  </span><span class="o">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="k">fn</span> <span class="nf">pointer</span><span class="p">,</span><span class="w"> </span><span class="n">found</span><span class="w"> </span><span class="k">struct</span> <span class="err">`</span><span class="n">std</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="err">`</span><span class="w"></span>
<span class="mi">262</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="n">_________</span><span class="o">-</span><span class="w"> </span><span class="err">`</span><span class="k">match</span><span class="err">`</span><span class="w"> </span><span class="n">arms</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">incompatible</span><span class="w"> </span><span class="n">types</span><span class="w"></span>
<span class="w">    </span><span class="o">|</span><span class="w"></span>
<span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">note</span>: <span class="nc">expected</span><span class="w"> </span><span class="k">fn</span> <span class="nf">pointer</span><span class="w"> </span><span class="err">`</span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">std</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="o">&lt;</span><span class="p">(</span><span class="k">dyn</span><span class="w"> </span><span class="n">CodegenBackend</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="o">&gt;</span><span class="err">`</span><span class="w"></span>
<span class="w">                   </span><span class="n">found</span><span class="w"> </span><span class="k">struct</span> <span class="err">`</span><span class="n">std</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="o">&lt;</span><span class="p">(</span><span class="k">dyn</span><span class="w"> </span><span class="n">CodegenBackend</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="nb">static</span><span class="p">)</span><span class="o">&gt;</span><span class="err">`</span><span class="w"></span>
</code></pre></div>



<a name="268200901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268200901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268200901">(Jan 16 2022 at 18:55)</a>:</h4>
<p>Wait, seems like i don't need to call the function</p>



<a name="268201043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268201043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268201043">(Jan 16 2022 at 18:58)</a>:</h4>
<p>More error...</p>
<div class="codehilite"><pre><span></span><code>CMake Error at /usr/share/cmake/Modules/CMakeTestCCompiler.cmake:69 (message):
  The C compiler

    &quot;/usr/bin/clang&quot;

  is not able to compile a simple test program.

  It fails with the following output:

    Change Dir: /home/hamza/code/rust-lang/rust/build/wasm32-unknown-unknown/llvm/build/CMakeFiles/CMakeTmp

    Run Build Command(s):/usr/bin/ninja cmTC_80bf3 &amp;&amp; [1/2] Building C object CMakeFiles/cmTC_80bf3.dir/testCCompiler.c.o
    [2/2] Linking C executable cmTC_80bf3
    FAILED: cmTC_80bf3
    : &amp;&amp; /usr/bin/clang -ffunction-sections -fdata-sections -fPIC --target=wasm32-unknown-unknown  CMakeFiles/cmTC_80bf3.dir/testCCompiler.c.o -o cmTC_80bf3   &amp;&amp; :
    clang-13: error: unable to execute command: Executable &quot;wasm-ld&quot; doesn&#39;t exist!
    clang-13: error: linker command failed with exit code 1 (use -v to see invocation)
    ninja: build stopped: subcommand failed.





  CMake will not be able to correctly generate this project.
Call Stack (most recent call first):
  CMakeLists.txt:44 (project)```
</code></pre></div>



<a name="268201249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268201249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268201249">(Jan 16 2022 at 19:02)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> how do I resolve this? seems like an issue with compiling C(or C++) to WASM</p>



<a name="268201265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268201265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268201265">(Jan 16 2022 at 19:03)</a>:</h4>
<p>I got no clue how to solve this issue (never worked with C/C++ before for wasm)</p>



<a name="268201403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268201403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268201403">(Jan 16 2022 at 19:06)</a>:</h4>
<p>This is the patch that I'm working with: <a href="https://github.com/rust-lang/rust/compare/master...hamza1311:wasm-build?expand=1">https://github.com/rust-lang/rust/compare/master...hamza1311:wasm-build?expand=1</a></p>



<a name="268201642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268201642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268201642">(Jan 16 2022 at 19:12)</a>:</h4>
<p>Installed lld package, getting a different error now</p>



<a name="268201645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268201645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268201645">(Jan 16 2022 at 19:12)</a>:</h4>
<div class="codehilite"><pre><span></span><code>    Run Build Command(s):/usr/bin/ninja cmTC_0da33 &amp;&amp; [1/2] Building C object CMakeFiles/cmTC_0da33.dir/testCCompiler.c.o
    [2/2] Linking C executable cmTC_0da33
    FAILED: cmTC_0da33
    : &amp;&amp; /usr/bin/clang -ffunction-sections -fdata-sections -fPIC --target=wasm32-unknown-unknown  CMakeFiles/cmTC_0da33.dir/testCCompiler.c.o -o cmTC_0da33   &amp;&amp; :
    wasm-ld: error: unknown file type: /lib/crt1.o
    wasm-ld: error: cannot open /usr/lib/clang/13.0.0/lib/libclang_rt.builtins-wasm32.a: No such file or directory
    clang-13: error: linker command failed with exit code 1 (use -v to see invocation)
    ninja: build stopped: subcommand failed.
</code></pre></div>



<a name="268202226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268202226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268202226">(Jan 16 2022 at 19:28)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> pinging here so you can take a look at the error</p>



<a name="268202252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268202252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268202252">(Jan 16 2022 at 19:29)</a>:</h4>
<p>sorry, I haven't actually tried to build the compiler for wasm before myself</p>



<a name="268202329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268202329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268202329">(Jan 16 2022 at 19:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138448">cuviper</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Building.20the.20compiler.20for.20wasm/near/268202252">said</a>:</p>
<blockquote>
<p>sorry, I haven't actually tried to build the compiler for wasm before myself</p>
</blockquote>
<p>ah it's alright. i was just wondering if you knew a way to solve the clang issue</p>



<a name="268202911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268202911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268202911">(Jan 16 2022 at 19:44)</a>:</h4>
<p>I think you have to disable whichever option in <code>config.toml</code> causes lld to be built.</p>



<a name="268203087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268203087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268203087">(Jan 16 2022 at 19:48)</a>:</h4>
<p>I set both <code>lld = false</code> and <code>use-lld = false</code> in <code>config.toml</code></p>



<a name="268203088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268203088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268203088">(Jan 16 2022 at 19:48)</a>:</h4>
<p>same result</p>



<a name="268203193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268203193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268203193">(Jan 16 2022 at 19:50)</a>:</h4>
<p>I did manage to reduce one error by taking <a href="https://github.com/WebAssembly/wasi-sdk/releases/tag/wasi-sdk-14">https://github.com/WebAssembly/wasi-sdk/releases/tag/wasi-sdk-14</a> and putting it where it wanted it to be</p>



<a name="268203198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268203198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268203198">(Jan 16 2022 at 19:50)</a>:</h4>
<p><code>cp libclang_rt.builtins-wasm32.a^Cusr/lib/clang/13.0.0/lib/</code></p>



<a name="268203218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268203218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268203218">(Jan 16 2022 at 19:51)</a>:</h4>
<p>gives ended up with this error</p>
<div class="codehilite"><pre><span></span><code>Copying stage0 std from stage0 (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu / wasm32-unknown-unknown)
Building LLVM for wasm32-unknown-unknown
running: &quot;cmake&quot; &quot;/home/hamza/code/rust-lang/rust/src/llvm-project/llvm&quot; &quot;-G&quot; &quot;Ninja&quot; &quot;-DLLVM_ENABLE_ASSERTIONS=OFF&quot; &quot;-DLLVM_ENABLE_PLUGINS=OFF&quot; &quot;-DLLVM_TARGETS_TO_BUILD=AArch64;ARM;BPF;Hexagon;MSP430;Mips;NVPTX;PowerPC;RISCV;Sparc;SystemZ;WebAssembly;X86&quot; &quot;-DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD=AVR;M68k&quot; &quot;-DLLVM_INCLUDE_EXAMPLES=OFF&quot; &quot;-DLLVM_INCLUDE_DOCS=OFF&quot; &quot;-DLLVM_INCLUDE_BENCHMARKS=OFF&quot; &quot;-DLLVM_INCLUDE_TESTS=OFF&quot; &quot;-DLLVM_ENABLE_TERMINFO=OFF&quot; &quot;-DLLVM_ENABLE_LIBEDIT=OFF&quot; &quot;-DLLVM_ENABLE_BINDINGS=OFF&quot; &quot;-DLLVM_ENABLE_Z3_SOLVER=OFF&quot; &quot;-DLLVM_PARALLEL_COMPILE_JOBS=8&quot; &quot;-DLLVM_TARGET_ARCH=wasm32&quot; &quot;-DLLVM_DEFAULT_TARGET_TRIPLE=wasm32-unknown-unknown&quot; &quot;-DLLVM_INSTALL_UTILS=ON&quot; &quot;-DLLVM_ENABLE_ZLIB=ON&quot; &quot;-DLLVM_ENABLE_LIBXML2=OFF&quot; &quot;-DCMAKE_CROSSCOMPILING=True&quot; &quot;-DLLVM_TABLEGEN=/home/hamza/code/rust-lang/rust/build/x86_64-unknown-linux-gnu/llvm/bin/llvm-tblgen&quot; &quot;-DLLVM_NM=/home/hamza/code/rust-lang/rust/build/x86_64-unknown-linux-gnu/llvm/bin/llvm-nm&quot; &quot;-DLLVM_CONFIG_PATH=/home/hamza/code/rust-lang/rust/build/x86_64-unknown-linux-gnu/llvm/bin/llvm-config&quot; &quot;-DLLVM_VERSION_SUFFIX=-rust-dev&quot; &quot;-DCMAKE_INSTALL_MESSAGE=LAZY&quot; &quot;-DCMAKE_C_COMPILER=clang&quot; &quot;-DCMAKE_CXX_COMPILER=clang&quot; &quot;-DCMAKE_ASM_COMPILER=clang&quot; &quot;-DCMAKE_C_FLAGS=-ffunction-sections -fdata-sections -fPIC --target=wasm32-unknown-unknown&quot; &quot;-DCMAKE_CXX_FLAGS=-ffunction-sections -fdata-sections -fPIC --target=wasm32-unknown-unknown&quot; &quot;-DCMAKE_INSTALL_PREFIX=/home/hamza/code/rust-lang/rust/build/wasm32-unknown-unknown/llvm&quot; &quot;-DCMAKE_ASM_FLAGS= -ffunction-sections -fdata-sections -fPIC --target=wasm32-unknown-unknown&quot; &quot;-DCMAKE_BUILD_TYPE=Release&quot;
-- The C compiler identification is Clang 13.0.0
-- The CXX compiler identification is Clang 13.0.0
-- The ASM compiler identification is Clang with GNU-like command-line
-- Found assembler: /usr/bin/clang
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - failed
-- Check for working C compiler: /usr/bin/clang
-- Check for working C compiler: /usr/bin/clang - broken
CMake Error at /usr/share/cmake/Modules/CMakeTestCCompiler.cmake:69 (message):
  The C compiler

    &quot;/usr/bin/clang&quot;

  is not able to compile a simple test program.

  It fails with the following output:

    Change Dir: /home/hamza/code/rust-lang/rust/build/wasm32-unknown-unknown/llvm/build/CMakeFiles/CMakeTmp

    Run Build Command(s):/usr/bin/ninja cmTC_f4ebe &amp;&amp; [1/2] Building C object CMakeFiles/cmTC_f4ebe.dir/testCCompiler.c.o
    [2/2] Linking C executable cmTC_f4ebe
    FAILED: cmTC_f4ebe
    : &amp;&amp; /usr/bin/clang -ffunction-sections -fdata-sections -fPIC --target=wasm32-unknown-unknown  CMakeFiles/cmTC_f4ebe.dir/testCCompiler.c.o -o cmTC_f4ebe   &amp;&amp; :
    wasm-ld: error: unknown file type: /lib/crt1.o
    clang-13: error: linker command failed with exit code 1 (use -v to see invocation)
    ninja: build stopped: subcommand failed.





  CMake will not be able to correctly generate this project.
Call Stack (most recent call first):
  CMakeLists.txt:44 (project)


-- Configuring incomplete, errors occurred!
</code></pre></div>



<a name="268203276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268203276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268203276">(Jan 16 2022 at 19:52)</a>:</h4>
<p>This seems to do something with clang/cmake. no idea what</p>



<a name="268203334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268203334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268203334">(Jan 16 2022 at 19:54)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> any idea how to solve this?</p>



<a name="268204035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268204035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268204035">(Jan 16 2022 at 20:05)</a>:</h4>
<p>Just to clarify, <code>./x.py build --target x86_64-unknown-linux-gnu --host wasm32-unknown-unknown</code> is what I should be running, right?</p>



<a name="268204098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268204098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268204098">(Jan 16 2022 at 20:07)</a>:</h4>
<p>Cmake is used to build lld.</p>



<a name="268204101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268204101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268204101">(Jan 16 2022 at 20:07)</a>:</h4>
<p>yes</p>



<a name="268204201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268204201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268204201">(Jan 16 2022 at 20:09)</a>:</h4>
<p>how would I solve this issue?</p>



<a name="268206652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268206652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268206652">(Jan 16 2022 at 21:02)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> do you know why it is even building llvm? shouldn't it be using cranelift?</p>



<a name="268207060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268207060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268207060">(Jan 16 2022 at 21:10)</a>:</h4>
<p>did you set <code>codegen-backend = []</code> and <code>lld = false</code> in <code>config.toml</code>.</p>



<a name="268207171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268207171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268207171">(Jan 16 2022 at 21:13)</a>:</h4>
<p>Not <code>codegen-backend = []</code>. Trying that right now</p>



<a name="268207229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268207229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268207229">(Jan 16 2022 at 21:14)</a>:</h4>
<p>got this error:</p>
<div class="codehilite" data-code-language="compiling"><pre><span></span><code>    Finished release [optimized] target(s) in 53.75s
Copying stage0 rustc from stage0 (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu / x86_64-unknown-linux-gnu)
Assembling stage1 compiler (x86_64-unknown-linux-gnu)
Building stage1 std artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)
   Compiling cc v1.0.69
   Compiling core v0.0.0 (/home/hamza/code/rust-lang/rust/library/core)
   Compiling libc v0.2.108
   Compiling memchr v2.4.1
   Compiling std v0.0.0 (/home/hamza/code/rust-lang/rust/library/std)
   Compiling compiler_builtins v0.1.66
   Compiling unwind v0.0.0 (/home/hamza/code/rust-lang/rust/library/unwind)
   Compiling rustc-std-workspace-core v1.99.0 (/home/hamza/code/rust-lang/rust/library/rustc-std-workspace-core)
   Compiling alloc v0.0.0 (/home/hamza/code/rust-lang/rust/library/alloc)
   Compiling cfg-if v0.1.10
   Compiling adler v0.2.3
   Compiling rustc-demangle v0.1.21
error: asm! and global_asm! support is disabled while compiling rustc_codegen_cranelift

error: could not compile `compiler_builtins` due to previous error
warning: build failed, waiting for other jobs to finish...
error: build failed
Build completed unsuccessfully in 0:01:16
</code></pre></div>



<a name="268207276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268207276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268207276">(Jan 16 2022 at 21:16)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> how do i make compiler_builtins compile now?</p>



<a name="268207669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268207669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268207669">(Jan 16 2022 at 21:24)</a>:</h4>
<p>Right, forgot that it needs a couple of changes. First of it needs the no-asm feature enabled at it's dependency specification in <code>library/alloc/Cargo.toml</code>. And second this patch needs to be applied to the source of compiler-builtins: <a href="https://github.com/bjorn3/rustc_codegen_cranelift/blob/master/patches/0001-compiler-builtins-Disable-128bit-atomic-operations.patch">https://github.com/bjorn3/rustc_codegen_cranelift/blob/master/patches/0001-compiler-builtins-Disable-128bit-atomic-operations.patch</a></p>



<a name="268207739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268207739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268207739">(Jan 16 2022 at 21:25)</a>:</h4>
<p>Also it seems that rustbuild is trying to build rustc using the cg_clif patched rustc which is going to fail when it goes to compile the final wasm rustc.</p>



<a name="268207829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268207829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268207829">(Jan 16 2022 at 21:27)</a>:</h4>
<p>I believe I last time avoided x.py to build rustc. I don't remember the right cargo invocation though unfortunately.</p>



<a name="268207852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268207852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268207852">(Jan 16 2022 at 21:27)</a>:</h4>
<p>what's the <code>src/mem/mod.rs</code> file modified in the patch?</p>



<a name="268207897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268207897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268207897">(Jan 16 2022 at 21:28)</a>:</h4>
<p>i can't apply the patch because it says the file doesn't exist</p>



<a name="268207902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268207902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268207902">(Jan 16 2022 at 21:28)</a>:</h4>
<p><code>$ git apply 0001-compiler-builtins-Disable-128bit-atomic-operations.patch
error: src/mem/mod.rs: No such file or directory</code></p>



<a name="268207923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268207923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268207923">(Jan 16 2022 at 21:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Building.20the.20compiler.20for.20wasm/near/268207739">said</a>:</p>
<blockquote>
<p>Also it seems that rustbuild is trying to build rustc using the cg_clif patched rustc which is going to fail when it goes to compile the final wasm rustc.</p>
</blockquote>
<p>I think we can modify it when we get to that step. let's first reach there</p>



<a name="268208369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268208369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268208369">(Jan 16 2022 at 21:39)</a>:</h4>
<p>the file is in the compiler-builtins dependency. you will need to clonebit from <a href="https://github.com/rust/compiler-builtins">https://github.com/rust/compiler-builtins</a> and apply the patch to this clone. To make the build system use the patched version you can add it to the <code>[patch.crates-io]</code> section in the <code>Cargo.toml</code> file at the root of the rust checkout.</p>



<a name="268208390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268208390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268208390">(Jan 16 2022 at 21:39)</a>:</h4>
<p><a href="https://github.com/rust/compiler-builtins">https://github.com/rust/compiler-builtins</a> 404s?</p>



<a name="268208440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268208440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268208440">(Jan 16 2022 at 21:40)</a>:</h4>
<p>ah the url is <a href="https://github.com/rust-lang/compiler-builtins">https://github.com/rust-lang/compiler-builtins</a></p>



<a name="268208443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268208443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268208443">(Jan 16 2022 at 21:40)</a>:</h4>
<p>Hang on. That specific patch is only necessary on macos. Just enabling the no-asm feature of compiler-builtins should be enough.</p>



<a name="268208579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268208579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268208579">(Jan 16 2022 at 21:42)</a>:</h4>
<p>ahh so that's why it was compiling fine on arch linux</p>



<a name="268208584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268208584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268208584">(Jan 16 2022 at 21:43)</a>:</h4>
<p>i thought i was gonna run into issue later on</p>



<a name="268208671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268208671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268208671">(Jan 16 2022 at 21:45)</a>:</h4>
<p>ran into more errors</p>



<a name="268208678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268208678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268208678">(Jan 16 2022 at 21:45)</a>:</h4>
<p>too big to send here so <a href="https://pastify-app.web.app/show/4FT0ixjcM4L62mR8xN3R">https://pastify-app.web.app/show/4FT0ixjcM4L62mR8xN3R</a></p>



<a name="268208826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268208826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268208826">(Jan 16 2022 at 21:48)</a>:</h4>
<p>i applied the patch anyway. lets see what happens</p>



<a name="268208911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268208911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268208911">(Jan 16 2022 at 21:50)</a>:</h4>
<p>That linker error is because the llvm backend doesn't like no-asm as the stack probe function isn't defined with no-asm.</p>



<a name="268208926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268208926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268208926">(Jan 16 2022 at 21:51)</a>:</h4>
<p>so how to fix it?</p>



<a name="268209054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268209054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268209054">(Jan 16 2022 at 21:53)</a>:</h4>
<p>something along the lines of <a href="https://github.com/rust-lang/miri/issues/722#issuecomment-819831196">https://github.com/rust-lang/miri/issues/722#issuecomment-819831196</a> instead of usinf x.py may work. these specific instructions are written for miri though.</p>



<a name="268209116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268209116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268209116">(Jan 16 2022 at 21:54)</a>:</h4>
<p>i may take a look tomorrow if i remember to.</p>



<a name="268209188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268209188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268209188">(Jan 16 2022 at 21:56)</a>:</h4>
<p>I'll also continue tomorrow (It's almost 3am here)</p>



<a name="268209197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268209197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268209197">(Jan 16 2022 at 21:56)</a>:</h4>
<p>If you have discord, I can text you over there. Otherwise, I guess I'll just message/ping you here</p>



<a name="268209203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268209203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268209203">(Jan 16 2022 at 21:56)</a>:</h4>
<p>I can't figure out the miri instructions, mostly because i've never worked with this before</p>



<a name="268209220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268209220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268209220">(Jan 16 2022 at 21:57)</a>:</h4>
<p>i have a discord, but i prefer zulip.</p>



<a name="268209266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268209266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268209266">(Jan 16 2022 at 21:58)</a>:</h4>
<blockquote>
<p>I can't figure out the miri instructions, mostly because i've never worked with this before</p>
</blockquote>
<p>I can understand that.</p>



<a name="268262993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268262993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268262993">(Jan 17 2022 at 12:19)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> did you have a look at it?</p>



<a name="268263014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268263014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268263014">(Jan 17 2022 at 12:19)</a>:</h4>
<p>I'm hoping to find a way to solve the linker error</p>



<a name="268269052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268269052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268269052">(Jan 17 2022 at 13:18)</a>:</h4>
<p>I think this will work but I will try it out myself too:</p>
<div class="codehilite"><pre><span></span><code>TOOLCHAIN=$(git cat-file -p HEAD | grep -oP -m1 &#39;(?&lt;=^parent ).+&#39;)
rustup-toolchain-install-master -t wasm32-wasi -- &quot;$TOOLCHAIN&quot;
rustup override set -- &quot;$TOOLCHAIN&quot;

HOST=$(rustc -vV | grep -oP &#39;(?&lt;=^host: ).+&#39;)
VERSION=$(&lt;src/version)

export RUSTC_STAGE= RUSTC_INSTALL_BINDIR= CFG_RELEASE=&quot;$VERSION-dev&quot; CFG_RELEASE_CHANNEL=dev

readonly TARGET_DIR=&quot;$PWD/target/wasi-rustc&quot;

build() {
    CFG_COMPILER_HOST_TRIPLE=$1 cargo build \
        --manifest-path src/tools/miri/Cargo.toml --target=&quot;$1&quot; --release --locked \
        --target-dir=&quot;$TARGET_DIR/rustc&quot;
}

build wasm32-wasi
build &quot;$HOST&quot;

readonly TARGET=x86_64-unknown-linux-gnu

RUSTC=&quot;$TARGET_DIR/rustc/$HOST/release/rustc&quot; CARGO_PROFILE_RELEASE_PANIC=abort cargo check \
    --manifest-path=library/std/Cargo.toml --target-dir=&quot;$TARGET_DIR/std&quot; --release \
    --target=&quot;$TARGET&quot; --locked --no-default-features

rm -rf -- &quot;$TARGET_DIR/sysroot/&quot;
readonly SYSROOT_LIB=&quot;$TARGET_DIR/sysroot/lib/rustlib/$TARGET/lib/&quot;
mkdir -p -- &quot;$SYSROOT_LIB&quot;
ln -- &quot;$TARGET_DIR/std/$TARGET/release/deps/&quot;*.{rmeta,rlib,so} &quot;$SYSROOT_LIB&quot;
ln -f -- &quot;$TARGET_DIR/rustc/wasm32-wasi/release/miri.wasm&quot; &quot;$TARGET_DIR/&quot;

echo &quot;Rustc has been built sucessfully: $TARGET_DIR/rustc-main.wasm
It need to use this sysroot: $TARGET_DIR/sysroot&quot;
</code></pre></div>



<a name="268270339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268270339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268270339">(Jan 17 2022 at 13:29)</a>:</h4>
<p>Looks like the libloading dependencies need to be patched away too. Working on a patch now.</p>



<a name="268270910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268270910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268270910">(Jan 17 2022 at 13:35)</a>:</h4>
<p>This works:</p>
<div class="spoiler-block"><div class="spoiler-header">
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/Cargo.lock b/Cargo.lock</span>
<span class="gh">index c3c73099965..d9a0ae7a6ec 100644</span>
<span class="gd">--- a/Cargo.lock</span>
<span class="gi">+++ b/Cargo.lock</span>
<span class="gu">@@ -3962,7 +3962,6 @@ name = "rustc_interface"</span>
 version = "0.0.0"
 dependencies = [
  "libc",
<span class="gd">- "libloading",</span>
  "rustc-rayon",
  "rustc-rayon-core",
  "rustc_ast",
<span class="gu">@@ -4087,7 +4086,6 @@ dependencies = [</span>
 name = "rustc_metadata"
 version = "0.0.0"
 dependencies = [
<span class="gd">- "libloading",</span>
  "odht",
  "rustc_ast",
  "rustc_attr",
<span class="gu">@@ -4279,7 +4277,6 @@ dependencies = [</span>
 name = "rustc_plugin_impl"
 version = "0.0.0"
 dependencies = [
<span class="gd">- "libloading",</span>
  "rustc_ast",
  "rustc_errors",
  "rustc_hir",
<span class="gh">diff --git a/compiler/rustc_interface/Cargo.toml b/compiler/rustc_interface/Cargo.toml</span>
<span class="gh">index 39dd7e917a2..4bcff24f2c6 100644</span>
<span class="gd">--- a/compiler/rustc_interface/Cargo.toml</span>
<span class="gi">+++ b/compiler/rustc_interface/Cargo.toml</span>
<span class="gu">@@ -8,7 +8,6 @@ doctest = false</span>

 [dependencies]
 libc = "0.2"
<span class="gd">-libloading = "0.7.1"</span>
 tracing = "0.1"
 rustc-rayon-core = "0.3.2"
 rayon = { version = "0.3.2", package = "rustc-rayon" }
<span class="gh">diff --git a/compiler/rustc_interface/src/util.rs b/compiler/rustc_interface/src/util.rs</span>
<span class="gh">index dd5bf847777..3fdf7b7840b 100644</span>
<span class="gd">--- a/compiler/rustc_interface/src/util.rs</span>
<span class="gi">+++ b/compiler/rustc_interface/src/util.rs</span>
<span class="gu">@@ -1,4 +1,3 @@</span>
<span class="gd">-use libloading::Library;</span>
 use rustc_ast::mut_visit::{visit_clobber, MutVisitor, *};
 use rustc_ast::ptr::P;
 use rustc_ast::{self as ast, AttrVec, BlockCheckMode};
<span class="gu">@@ -209,26 +208,6 @@ pub fn setup_callbacks_and_run_in_thread_pool_with_globals&lt;F: FnOnce() -&gt; R + Se</span>
     })
 }

<span class="gd">-fn load_backend_from_dylib(path: &amp;Path) -&gt; MakeBackendFn {</span>
<span class="gd">-    let lib = unsafe { Library::new(path) }.unwrap_or_else(|err| {</span>
<span class="gd">-        let err = format!("couldn't load codegen backend {:?}: {}", path, err);</span>
<span class="gd">-        early_error(ErrorOutputType::default(), &amp;err);</span>
<span class="gd">-    });</span>
<span class="gd">-</span>
<span class="gd">-    let backend_sym = unsafe { lib.get::&lt;MakeBackendFn&gt;(b"__rustc_codegen_backend") }</span>
<span class="gd">-        .unwrap_or_else(|e| {</span>
<span class="gd">-            let err = format!("couldn't load codegen backend: {}", e);</span>
<span class="gd">-            early_error(ErrorOutputType::default(), &amp;err);</span>
<span class="gd">-        });</span>
<span class="gd">-</span>
<span class="gd">-    // Intentionally leak the dynamic library. We can't ever unload it</span>
<span class="gd">-    // since the library can make things that will live arbitrarily long.</span>
<span class="gd">-    let backend_sym = unsafe { backend_sym.into_raw() };</span>
<span class="gd">-    mem::forget(lib);</span>
<span class="gd">-</span>
<span class="gd">-    *backend_sym</span>
<span class="gd">-}</span>
<span class="gd">-</span>
 /// Get the codegen backend based on the name and specified sysroot.
 ///
 /// A name of `None` indicates that the default backend should be used.
<span class="gu">@@ -246,7 +225,6 @@ pub fn get_codegen_backend(</span>
         const DEFAULT_CODEGEN_BACKEND: &amp;str = "cranelift";

         match backend_name.unwrap_or(DEFAULT_CODEGEN_BACKEND) {
<span class="gd">-            filename if filename.contains('.') =&gt; load_backend_from_dylib(filename.as_ref()),</span>
             #[cfg(feature = "llvm")]
             "llvm" =&gt; rustc_codegen_llvm::LlvmCodegenBackend::new,
             _ =&gt; rustc_codegen_cranelift::__rustc_codegen_backend,
<span class="gu">@@ -374,6 +352,7 @@ fn current_dll_path() -&gt; Option&lt;PathBuf&gt; {</span>
     }
 }

<span class="gi">+/*</span>
 pub fn get_codegen_sysroot(maybe_sysroot: &amp;Option&lt;PathBuf&gt;, backend_name: &amp;str) -&gt; MakeBackendFn {
     // For now we only allow this function to be called once as it'll dlopen a
     // few things, which seems to work best if we only do that once. In
<span class="gu">@@ -465,6 +444,7 @@ pub fn get_codegen_sysroot(maybe_sysroot: &amp;Option&lt;PathBuf&gt;, backend_name: &amp;str)</span>
         }
     }
 }
<span class="gi">+*/</span>

 pub(crate) fn check_attr_crate_type(
     sess: &amp;Session,
<span class="gh">diff --git a/compiler/rustc_metadata/Cargo.toml b/compiler/rustc_metadata/Cargo.toml</span>
<span class="gh">index 59796dd6529..65b8444bef9 100644</span>
<span class="gd">--- a/compiler/rustc_metadata/Cargo.toml</span>
<span class="gi">+++ b/compiler/rustc_metadata/Cargo.toml</span>
<span class="gu">@@ -7,7 +7,6 @@ edition = "2021"</span>
 doctest = false

 [dependencies]
<span class="gd">-libloading = "0.7.1"</span>
 odht = { version = "0.3.1", features = ["nightly"] }
 snap = "1"
 tracing = "0.1"
<span class="gh">diff --git a/compiler/rustc_metadata/src/creader.rs b/compiler/rustc_metadata/src/creader.rs</span>
<span class="gh">index 36a1798cd6a..eed77978cad 100644</span>
<span class="gd">--- a/compiler/rustc_metadata/src/creader.rs</span>
<span class="gi">+++ b/compiler/rustc_metadata/src/creader.rs</span>
<span class="gu">@@ -658,24 +658,10 @@ fn resolve_crate_deps(</span>

     fn dlsym_proc_macros(
         &amp;self,
<span class="gd">-        path: &amp;Path,</span>
<span class="gd">-        stable_crate_id: StableCrateId,</span>
<span class="gi">+        _path: &amp;Path,</span>
<span class="gi">+        _stable_crate_id: StableCrateId,</span>
     ) -&gt; Result&lt;&amp;'static [ProcMacro], CrateError&gt; {
<span class="gd">-        // Make sure the path contains a / or the linker will search for it.</span>
<span class="gd">-        let path = env::current_dir().unwrap().join(path);</span>
<span class="gd">-        let lib = unsafe { libloading::Library::new(path) }</span>
<span class="gd">-            .map_err(|err| CrateError::DlOpen(err.to_string()))?;</span>
<span class="gd">-</span>
<span class="gd">-        let sym_name = self.sess.generate_proc_macro_decls_symbol(stable_crate_id);</span>
<span class="gd">-        let sym = unsafe { lib.get::&lt;*const &amp;[ProcMacro]&gt;(sym_name.as_bytes()) }</span>
<span class="gd">-            .map_err(|err| CrateError::DlSym(err.to_string()))?;</span>
<span class="gd">-</span>
<span class="gd">-        // Intentionally leak the dynamic library. We can't ever unload it</span>
<span class="gd">-        // since the library can make things that will live arbitrarily long.</span>
<span class="gd">-        let sym = unsafe { sym.into_raw() };</span>
<span class="gd">-        std::mem::forget(lib);</span>
<span class="gd">-</span>
<span class="gd">-        Ok(unsafe { **sym })</span>
<span class="gi">+        self.sess.fatal("proc macros aren't supported by wasi-rustc");</span>
     }

     fn inject_panic_runtime(&amp;mut self, krate: &amp;ast::Crate) {
<span class="gh">diff --git a/compiler/rustc_plugin_impl/Cargo.toml b/compiler/rustc_plugin_impl/Cargo.toml</span>
<span class="gh">index f5071eb6e8f..4e666e7e93d 100644</span>
<span class="gd">--- a/compiler/rustc_plugin_impl/Cargo.toml</span>
<span class="gi">+++ b/compiler/rustc_plugin_impl/Cargo.toml</span>
<span class="gu">@@ -8,7 +8,6 @@ edition = "2021"</span>
 doctest = false

 [dependencies]
<span class="gd">-libloading = "0.7.1"</span>
 rustc_middle = { path = "../rustc_middle" }
 rustc_errors = { path = "../rustc_errors" }
 rustc_hir = { path = "../rustc_hir" }
<span class="gh">diff --git a/compiler/rustc_plugin_impl/src/load.rs b/compiler/rustc_plugin_impl/src/load.rs</span>
<span class="gh">index 618682da4e5..d3c6da542cd 100644</span>
<span class="gd">--- a/compiler/rustc_plugin_impl/src/load.rs</span>
<span class="gi">+++ b/compiler/rustc_plugin_impl/src/load.rs</span>
<span class="gu">@@ -1,7 +1,6 @@</span>
 //! Used by `rustc` when loading a plugin.

 use crate::Registry;
<span class="gd">-use libloading::Library;</span>
 use rustc_ast::Crate;
 use rustc_errors::struct_span_err;
 use rustc_metadata::locator;
<span class="gu">@@ -51,34 +50,11 @@ pub fn load_plugins(</span>
 }

 fn load_plugin(
<span class="gd">-    plugins: &amp;mut Vec&lt;PluginRegistrarFn&gt;,</span>
<span class="gi">+    _plugins: &amp;mut Vec&lt;PluginRegistrarFn&gt;,</span>
     sess: &amp;Session,
<span class="gd">-    metadata_loader: &amp;dyn MetadataLoader,</span>
<span class="gi">+    _metadata_loader: &amp;dyn MetadataLoader,</span>
     ident: Ident,
 ) {
<span class="gd">-    let lib = locator::find_plugin_registrar(sess, metadata_loader, ident.span, ident.name);</span>
<span class="gd">-    let fun = dylink_registrar(lib).unwrap_or_else(|err| {</span>
<span class="gd">-        // This is fatal: there are almost certainly macros we need inside this crate, so</span>
<span class="gd">-        // continuing would spew "macro undefined" errors.</span>
<span class="gd">-        sess.span_fatal(ident.span, &amp;err.to_string());</span>
<span class="gd">-    });</span>
<span class="gd">-    plugins.push(fun);</span>
<span class="gi">+    sess.span_fatal(ident.span, "rustc plugins aren't supported by wasi-rustc");</span>
 }

<span class="gd">-/// Dynamically link a registrar function into the compiler process.</span>
<span class="gd">-fn dylink_registrar(lib_path: PathBuf) -&gt; Result&lt;PluginRegistrarFn, libloading::Error&gt; {</span>
<span class="gd">-    // Make sure the path contains a / or the linker will search for it.</span>
<span class="gd">-    let lib_path = env::current_dir().unwrap().join(&amp;lib_path);</span>
<span class="gd">-</span>
<span class="gd">-    let lib = unsafe { Library::new(&amp;lib_path) }?;</span>
<span class="gd">-</span>
<span class="gd">-    let registrar_sym = unsafe { lib.get::&lt;PluginRegistrarFn&gt;(b"__rustc_plugin_registrar") }?;</span>
<span class="gd">-</span>
<span class="gd">-    // Intentionally leak the dynamic library. We can't ever unload it</span>
<span class="gd">-    // since the library can make things that will live arbitrarily long</span>
<span class="gd">-    // (e.g., an Rc cycle or a thread).</span>
<span class="gd">-    let registrar_sym = unsafe { registrar_sym.into_raw() };</span>
<span class="gd">-    mem::forget(lib);</span>
<span class="gd">-</span>
<span class="gd">-    Ok(*registrar_sym)</span>
<span class="gd">-}</span>
</code></pre></div>
</div></div>



<a name="268276827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268276827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268276827">(Jan 17 2022 at 14:24)</a>:</h4>
<p>can you send the patch as a file?</p>



<a name="268276918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268276918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268276918">(Jan 17 2022 at 14:25)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ git apply pat.patch
error: patch failed: compiler/rustc_interface/src/util.rs:246
error: compiler/rustc_interface/src/util.rs: patch does not apply
</code></pre></div>



<a name="268277574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268277574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268277574">(Jan 17 2022 at 14:30)</a>:</h4>
<p><a href="/user_uploads/4715/HYpJdOMLDULkEdne5cvMdvE_/wasi-rustc.patch">wasi-rustc.patch</a> works as patch on commit <a href="https://github.com/rust-lang/rust/commit/a34c0797528172ede89480e3033f7a5e71ea4735">a34c0797528172ede89480e3033f7a5e71ea4735</a> (which is the master branch as of an hour ago)</p>



<a name="268277684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268277684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268277684">(Jan 17 2022 at 14:31)</a>:</h4>
<p>I am still working on the right instructions to compile it though. I got a working rustc, but there is still a version mismatch causing it to refuse to load the sysroot.</p>



<a name="268277920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268277920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268277920">(Jan 17 2022 at 14:33)</a>:</h4>
<p>Trying with <code>export CFG_VERSION="1.60.0-nightly (128417f40 2022-01-17)"</code> now.</p>



<a name="268279238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268279238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268279238">(Jan 17 2022 at 14:44)</a>:</h4>
<p>I'm trying to run it but it says <code>toolchain '128417f40f80ce585414bf5a017540447e6be775' is not installed</code></p>



<a name="268279307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268279307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268279307">(Jan 17 2022 at 14:45)</a>:</h4>
<p><code>rustup-toolchain-install-master</code> isn't here for me</p>



<a name="268279341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268279341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268279341">(Jan 17 2022 at 14:45)</a>:</h4>
<p>You will need to install it first using <code>cargo install rustup-toolchain-install-master</code>.</p>



<a name="268279662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268279662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268279662">(Jan 17 2022 at 14:48)</a>:</h4>
<p>that did it</p>



<a name="268279698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268279698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268279698">(Jan 17 2022 at 14:48)</a>:</h4>
<p>btw, if you got compiling, can you try building <code>yew</code> crate from here <a href="https://github.com/yewstack/yew/">https://github.com/yewstack/yew/</a> ?</p>



<a name="268279762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268279762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268279762">(Jan 17 2022 at 14:49)</a>:</h4>
<p>Cranelift doesn't yet have a wasm backend unfortunately.</p>



<a name="268279793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268279793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268279793">(Jan 17 2022 at 14:49)</a>:</h4>
<p>so that means it can't compile code to be run on wasm</p>



<a name="268279921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268279921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268279921">(Jan 17 2022 at 14:50)</a>:</h4>
<p>what if i were to try and build with llvm. would that work?</p>



<a name="268279930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268279930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268279930">(Jan 17 2022 at 14:50)</a>:</h4>
<p>Yeah, so far I have only been able to compile for x86_64 using this.</p>



<a name="268279956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268279956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268279956">(Jan 17 2022 at 14:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="455331">Hamza</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Building.20the.20compiler.20for.20wasm/near/268279921">said</a>:</p>
<blockquote>
<p>what if i were to try and build with llvm. would that work?</p>
</blockquote>
<p>It should if you manage to get llvm to work.</p>



<a name="268280029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268280029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268280029">(Jan 17 2022 at 14:51)</a>:</h4>
<p>I was hoping to build a completely in-browser playground for yew framework</p>



<a name="268280056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268280056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268280056">(Jan 17 2022 at 14:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Building.20the.20compiler.20for.20wasm/near/268279956">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="455331">Hamza</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Building.20the.20compiler.20for.20wasm/near/268279921">said</a>:</p>
<blockquote>
<p>what if i were to try and build with llvm. would that work?</p>
</blockquote>
<p>It should if you manage to get llvm to work.</p>
</blockquote>
<p>any previous effort on it?</p>



<a name="268280297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268280297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268280297">(Jan 17 2022 at 14:54)</a>:</h4>
<p>Llvm + rustc? Not that I know of. Llvm + clang, yes someone succeeded. I don't have any clue how it was built though. <a href="https://wapm.io/package/clang">https://wapm.io/package/clang</a></p>



<a name="268280652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268280652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268280652">(Jan 17 2022 at 14:56)</a>:</h4>
<p>any pointers on where to start?</p>



<a name="268280667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268280667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268280667">(Jan 17 2022 at 14:57)</a>:</h4>
<p><a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Building.20the.20compiler.20for.20wasm/near/268203218">https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/Building.20the.20compiler.20for.20wasm/near/268203218</a></p>



<a name="268280692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268280692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268280692">(Jan 17 2022 at 14:57)</a>:</h4>
<p>I was trying to build and reached this point</p>



<a name="268280714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268280714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268280714">(Jan 17 2022 at 14:57)</a>:</h4>
<p>*accidentally</p>



<a name="268280851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268280851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268280851">(Jan 17 2022 at 14:58)</a>:</h4>
<p>You could try installing <a href="https://github.com/WebAssembly/wasi-sdk">https://github.com/WebAssembly/wasi-sdk</a> and using the included clang and linker for wasm32-wasi by adding a <code>[target.wasm32-wasi]</code> section to <code>config.toml</code>.</p>



<a name="268283112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268283112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268283112">(Jan 17 2022 at 15:14)</a>:</h4>
<p>Is this normal</p>
<div class="codehilite"><pre><span></span><code>   Compiling rustc-main v0.0.0 (/home/hamza/code/rust-lang/rust/compiler/rustc)
    Finished release [optimized] target(s) in 12m 28s
error: process didn&#39;t exit successfully: `/home/hamza/code/rust-lang/rust/target/wasi-rustc/rustc.sh -vV` (exit status: 127)
--- stderr
/home/hamza/code/rust-lang/rust/target/wasi-rustc/rustc.sh: line 16: exec: : not found

ln: failed to access &#39;/home/hamza/code/rust-lang/rust/target/wasi-rustc/std/x86_64-unknown-linux-gnu/release/deps/*.rmeta&#39;: No such file or directory
ln: failed to access &#39;/home/hamza/code/rust-lang/rust/target/wasi-rustc/std/x86_64-unknown-linux-gnu/release/deps/*.rlib&#39;: No such file or directory
ln: failed to access &#39;/home/hamza/code/rust-lang/rust/target/wasi-rustc/std/x86_64-unknown-linux-gnu/release/deps/*.so&#39;: No such file or directory
Rustc has been built successfully: /home/hamza/code/rust-lang/rust/target/wasi-rustc/rustc-main.wasm
It need to use this sysroot: /home/hamza/code/rust-lang/rust/target/wasi-rustc/sysroot
</code></pre></div>
<p>from the built script you sent above</p>



<a name="268287141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268287141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268287141">(Jan 17 2022 at 15:47)</a>:</h4>
<p>Looks like llvm is building for wasm target</p>



<a name="268287152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268287152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268287152">(Jan 17 2022 at 15:47)</a>:</h4>
<p><a href="https://pastify-app.web.app/show/c2AoyrcSXfe9WIRean3A">https://pastify-app.web.app/show/c2AoyrcSXfe9WIRean3A</a> looks like a good sign to me</p>



<a name="268287442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268287442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268287442">(Jan 17 2022 at 15:50)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> can you send the build files you ended up with (ones needed to be used with your browser wasi shim). For some reason, they weren't build for me:</p>
<div class="codehilite"><pre><span></span><code>08:48 PM hamza wasi-rustc $ ls
rustc/  rustc-main.wasm*  rustc.sh*  sysroot/
08:48 PM hamza wasi-rustc $ ls sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib/
08:49 PM hamza wasi-rustc $
</code></pre></div>



<a name="268288097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268288097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268288097">(Jan 17 2022 at 15:55)</a>:</h4>
<p>I didn't manage to get rustc to accept the sysroot rlibs due to a version mismatch. I can give you a wasm file for just rustc I built quite a while ago though. This is the one I tested browser_wasi_shim with:  <a href="/user_uploads/4715/UO9VXwX4uUjus7iWSukCqNE5/rustc_binary.wasm.gz">rustc_binary.wasm.gz</a></p>



<a name="268288317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268288317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268288317">(Jan 17 2022 at 15:57)</a>:</h4>
<p>I'll try that later</p>



<a name="268288362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268288362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268288362">(Jan 17 2022 at 15:58)</a>:</h4>
<p>btw for llvm, i'm running <code> ./x.py build --target wasm32-unknown-unknown --host wasm32-unknown-unknown</code></p>



<a name="268288405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268288405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268288405">(Jan 17 2022 at 15:58)</a>:</h4>
<p>does it seem correct to you</p>



<a name="268288425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268288425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268288425">(Jan 17 2022 at 15:58)</a>:</h4>
<p>or should it be <code>./x.py build --target wasm32-wasi --host wasm32-wasi</code>?</p>



<a name="268291470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268291470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268291470">(Jan 17 2022 at 16:27)</a>:</h4>
<p>It will have to be wasm32-wasi.</p>



<a name="268292028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268292028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268292028">(Jan 17 2022 at 16:33)</a>:</h4>
<p>oof i spent like almost an hour building for wasm32-unknown-unknown</p>



<a name="268292096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268292096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268292096">(Jan 17 2022 at 16:34)</a>:</h4>
<p>will recompile once this one is finished</p>



<a name="268292449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268292449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268292449">(Jan 17 2022 at 16:38)</a>:</h4>
<p>from where can I download prebuilt <code>wasi-root</code> build?</p>



<a name="268292456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268292456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268292456">(Jan 17 2022 at 16:38)</a>:</h4>
<p>it's built by CI</p>



<a name="268292458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268292458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268292458">(Jan 17 2022 at 16:38)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/ci/docker/host-x86_64/dist-various-2/build-wasi-toolchain.sh">https://github.com/rust-lang/rust/blob/master/src/ci/docker/host-x86_64/dist-various-2/build-wasi-toolchain.sh</a></p>



<a name="268293394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268293394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268293394">(Jan 17 2022 at 16:48)</a>:</h4>
<p>Here I believe: <a href="https://github.com/WebAssembly/wasi-sdk/releases/tag/wasi-sdk-14">https://github.com/WebAssembly/wasi-sdk/releases/tag/wasi-sdk-14</a></p>



<a name="268293421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268293421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268293421">(Jan 17 2022 at 16:48)</a>:</h4>
<p>I think you need <code>wasi-sdk-14.0-linux.tar.gz</code>.</p>



<a name="268294080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268294080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268294080">(Jan 17 2022 at 16:55)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ ./x.py build --target wasm32-wasi --host wasm32-wasi
Updating only changed submodules
  Submodules updated in 0.00 seconds
Building rustbuild
    Finished dev [unoptimized] target(s) in 0.14s
Building stage0 std artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)
    Finished release [optimized] target(s) in 0.13s
Copying stage0 std from stage0 (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu / x86_64-unknown-linux-gnu)
Building stage0 compiler artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)
    Finished release [optimized] target(s) in 0.18s
Copying stage0 rustc from stage0 (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu / x86_64-unknown-linux-gnu)
Assembling stage1 compiler (x86_64-unknown-linux-gnu)
thread &#39;main&#39; panicked at &#39;src.symlink_metadata() failed with No such file or directory (os error 2)&#39;, src/bootstrap/lib.rs:1319:24
stack backtrace:
   0: rust_begin_unwind
             at /rustc/426b94d7df183ac00ed4492541d92855181e9c4e/library/std/src/panicking.rs:498:5
   1: core::panicking::panic_fmt
             at /rustc/426b94d7df183ac00ed4492541d92855181e9c4e/library/core/src/panicking.rs:107:14
   2: bootstrap::Build::copy
             at ./src/bootstrap/lib.rs:1319:24
   3: bootstrap::compile::copy_and_stamp
             at ./src/bootstrap/compile.rs:141:5
   4: bootstrap::compile::copy_self_contained_objects
             at ./src/bootstrap/compile.rs:240:13
   5: &lt;bootstrap::compile::Std as bootstrap::builder::Step&gt;::run
             at ./src/bootstrap/compile.rs:106:28
   6: bootstrap::builder::Builder::ensure
             at ./src/bootstrap/builder.rs:1603:23
   7: &lt;bootstrap::compile::Std as bootstrap::builder::Step&gt;::make_run
             at ./src/bootstrap/compile.rs:52:9
   8: bootstrap::builder::StepDescription::maybe_run
             at ./src/bootstrap/builder.rs:175:13
   9: bootstrap::builder::StepDescription::run
             at ./src/bootstrap/builder.rs:211:25
  10: bootstrap::builder::Builder::run_step_descriptions
             at ./src/bootstrap/builder.rs:619:9
  11: bootstrap::builder::Builder::execute_cli
             at ./src/bootstrap/builder.rs:599:9
  12: bootstrap::Build::build
             at ./src/bootstrap/lib.rs:618:13
  13: bootstrap::main
             at ./src/bootstrap/bin/main.rs:33:5
  14: core::ops::function::FnOnce::call_once
             at /rustc/426b94d7df183ac00ed4492541d92855181e9c4e/library/core/src/ops/function.rs:227:5
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
</code></pre></div>



<a name="268294102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268294102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268294102">(Jan 17 2022 at 16:55)</a>:</h4>
<p>What file doesn't exist?</p>



<a name="268294744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268294744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268294744">(Jan 17 2022 at 17:01)</a>:</h4>
<p>nvm had the wrong path for wasi sysroot</p>



<a name="268294750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268294750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268294750">(Jan 17 2022 at 17:01)</a>:</h4>
<p>it couldn't find libc</p>



<a name="268298012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268298012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268298012">(Jan 17 2022 at 17:36)</a>:</h4>
<p>I'm failing at this step</p>
<div class="codehilite"><pre><span></span><code>-- Performing Test HAVE_CXX_ATOMICS_WITHOUT_LIB
-- Performing Test HAVE_CXX_ATOMICS_WITHOUT_LIB - Failed
-- Looking for __atomic_fetch_add_4 in atomic
-- Looking for __atomic_fetch_add_4 in atomic - not found
CMake Error at cmake/modules/CheckAtomic.cmake:59 (message):
  Host compiler appears to require libatomic, but cannot find it.
Call Stack (most recent call first):
  cmake/config-ix.cmake:374 (include)
  CMakeLists.txt:684 (include)
</code></pre></div>
<p>any idea how to solve this?</p>



<a name="268299057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268299057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268299057">(Jan 17 2022 at 17:48)</a>:</h4>
<p>if I run the command manually (instead of from the x.py), I face this: <a href="https://pastify-app.web.app/show/onYdmaNfGhkGwl3VmGpa">https://pastify-app.web.app/show/onYdmaNfGhkGwl3VmGpa</a></p>
<p><code>CMakeOutput.log</code> Line 1-592:  <a href="https://pastify-app.web.app/show/6GMIljTDxlNxIX8EhiZZ">https://pastify-app.web.app/show/6GMIljTDxlNxIX8EhiZZ</a><br>
<code>CMakeError.log</code> Line 593 - end: <a href="https://pastify-app.web.app/show/6GMIljTDxlNxIX8EhiZZ">https://pastify-app.web.app/show/6GMIljTDxlNxIX8EhiZZ</a></p>



<a name="268299064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268299064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268299064">(Jan 17 2022 at 17:48)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> can you take a look?</p>



<a name="268299264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268299264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268299264">(Jan 17 2022 at 17:50)</a>:</h4>
<p><a href="https://github.com/binji/llvm-project/compare/19a71f6bdf2dddb10764939e7f0ec2b98dba76c9...87f4133a7d61103839fb4591d539476873f1a041">https://github.com/binji/llvm-project/compare/19a71f6bdf2dddb10764939e7f0ec2b98dba76c9...87f4133a7d61103839fb4591d539476873f1a041</a> lists all of the patches that were necessary to compile clang for wasm. It seems that a fix for this specific problem is among the changes.</p>



<a name="268300026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268300026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268300026">(Jan 17 2022 at 17:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/Building.20the.20compiler.20for.20wasm/near/268299264">said</a>:</p>
<blockquote>
<p><a href="https://github.com/binji/llvm-project/compare/19a71f6bdf2dddb10764939e7f0ec2b98dba76c9...87f4133a7d61103839fb4591d539476873f1a041">https://github.com/binji/llvm-project/compare/19a71f6bdf2dddb10764939e7f0ec2b98dba76c9...87f4133a7d61103839fb4591d539476873f1a041</a> lists all of the patches that were necessary to compile clang for wasm. It seems that a fix for this specific problem is among the changes.</p>
</blockquote>
<p>that fixed _this_ problem but there's more. that specific patch doesn't apply because conflicts</p>



<a name="268300100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268300100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268300100">(Jan 17 2022 at 18:00)</a>:</h4>
<p>it starts to compile but fails</p>



<a name="268300167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268300167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268300167">(Jan 17 2022 at 18:00)</a>:</h4>
<div class="codehilite"><pre><span></span><code>[20/2846] Building CXX object lib/Support/CMakeFiles/LLVMSupport.dir/BuryPointer.cpp.o
FAILED: lib/Support/CMakeFiles/LLVMSupport.dir/BuryPointer.cpp.o
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/clang++ -DGTEST_HAS_RTTI=0 -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -I/home/hamza/code/rust-lang/rust/build/wasm32-wasi/llvm/build/lib/Support -I/home/hamza/code/rust-lang/rust/src/llvm-project/llvm/lib/Support -I/home/hamza/code/rust-lang/rust/build/wasm32-wasi/llvm/build/include -I/home/hamza/code/rust-lang/rust/src/llvm-project/llvm/include -ffunction-sections -fdata-sections -fPIC --target=wasm32-wasi -fPIC -fvisibility-inlines-hidden -Werror=date-time -Werror=unguarded-availability-new -Wall -Wextra -Wno-unused-parameter -Wwrite-strings -Wcast-qual -Wmissing-field-initializers -pedantic -Wno-long-long -Wc++98-compat-extra-semi -Wimplicit-fallthrough -Wcovered-switch-default -Wno-noexcept-type -Wnon-virtual-dtor -Wdelete-non-virtual-dtor -Wsuggest-override -Wstring-conversion -Wmisleading-indentation -fdiagnostics-color -ffunction-sections -fdata-sections  -O3 -DNDEBUG -std=c++14  -fno-exceptions -fno-rtti -MD -MT lib/Support/CMakeFiles/LLVMSupport.dir/BuryPointer.cpp.o -MF lib/Support/CMakeFiles/LLVMSupport.dir/BuryPointer.cpp.o.d -o lib/Support/CMakeFiles/LLVMSupport.dir/BuryPointer.cpp.o -c /home/hamza/code/rust-lang/rust/src/llvm-project/llvm/lib/Support/BuryPointer.cpp
In file included from /home/hamza/code/rust-lang/rust/src/llvm-project/llvm/lib/Support/BuryPointer.cpp:11:
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:594:3: error: &lt;atomic&gt; is not supported on this single threaded system
# error &lt;atomic&gt; is not supported on this single threaded system
  ^
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:597:3: error: &lt;atomic&gt; is not implemented
# error &lt;atomic&gt; is not implemented
  ^
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:1545:13: error: use of undeclared identifier &#39;__libcpp_thread_yield&#39;
            __libcpp_thread_yield();
            ^
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:2522:23: error: use of undeclared identifier &#39;_LIBCPP_ATOMIC_FLAG_TYPE&#39;
    __cxx_atomic_impl&lt;_LIBCPP_ATOMIC_FLAG_TYPE&gt; __a_;
                      ^
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:2526:17: error: use of undeclared identifier &#39;_LIBCPP_ATOMIC_FLAG_TYPE&#39;
        {return _LIBCPP_ATOMIC_FLAG_TYPE(true) == __cxx_atomic_load(&amp;__a_, __m);}
                ^
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:2529:17: error: use of undeclared identifier &#39;_LIBCPP_ATOMIC_FLAG_TYPE&#39;
        {return _LIBCPP_ATOMIC_FLAG_TYPE(true) == __cxx_atomic_load(&amp;__a_, __m);}
                ^
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:2533:46: error: use of undeclared identifier &#39;_LIBCPP_ATOMIC_FLAG_TYPE&#39;
        {return __cxx_atomic_exchange(&amp;__a_, _LIBCPP_ATOMIC_FLAG_TYPE(true), __m);}
                                             ^
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:2536:46: error: use of undeclared identifier &#39;_LIBCPP_ATOMIC_FLAG_TYPE&#39;
        {return __cxx_atomic_exchange(&amp;__a_, _LIBCPP_ATOMIC_FLAG_TYPE(true), __m);}
                                             ^
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:2539:36: error: use of undeclared identifier &#39;_LIBCPP_ATOMIC_FLAG_TYPE&#39;
        {__cxx_atomic_store(&amp;__a_, _LIBCPP_ATOMIC_FLAG_TYPE(false), __m);}
                                   ^
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:2542:36: error: use of undeclared identifier &#39;_LIBCPP_ATOMIC_FLAG_TYPE&#39;
        {__cxx_atomic_store(&amp;__a_, _LIBCPP_ATOMIC_FLAG_TYPE(false), __m);}
                                   ^
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:2546:35: error: use of undeclared identifier &#39;_LIBCPP_ATOMIC_FLAG_TYPE&#39;
        {__cxx_atomic_wait(&amp;__a_, _LIBCPP_ATOMIC_FLAG_TYPE(__v), __m);}
                                  ^
/home/hamza/code/rust-lang/wasi-sdk-14.0/bin/../share/wasi-sysroot/include/c++/v1/atomic:2549:35: error: use of undeclared identifier &#39;_LIBCPP_ATOMIC_FLAG_TYPE&#39;
        {__cxx_atomic_wait(&amp;__a_, _LIBCPP_ATOMIC_FLAG_TYPE(__v), __m);}
                                  ^
12 errors generated.
[27/2846] Building CXX object lib/Support/CMakeFiles/LLVMSupport.dir/APInt.cpp.o
ninja: build stopped: subcommand failed.
thread &#39;main&#39; panicked at &#39;
command did not execute successfully, got: exit status: 1
</code></pre></div>



<a name="268300597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268300597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268300597">(Jan 17 2022 at 18:04)</a>:</h4>
<p>I'm afraid I can't help with that.</p>



<a name="268304224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Building%20the%20compiler%20for%20wasm/near/268304224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hamza <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Building.20the.20compiler.20for.20wasm.html#268304224">(Jan 17 2022 at 18:49)</a>:</h4>
<p>Thanks for your so far, <span class="user-mention" data-user-id="133247">@bjorn3</span>. I will see how it goes since I'm totally unfamiliar with LLVM and have not worked with C/C++ before</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>