<html>
<head><meta charset="utf-8"><title>ICE when using get_body_with_borrowck_facts with async · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ICE.20when.20using.20get_body_with_borrowck_facts.20with.20async.html">ICE when using get_body_with_borrowck_facts with async</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256510258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ICE%20when%20using%20get_body_with_borrowck_facts%20with%20async/near/256510258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ICE.20when.20using.20get_body_with_borrowck_facts.20with.20async.html#256510258">(Oct 07 2021 at 01:34)</a>:</h4>
<p>I am calling <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_borrowck/consumers/fn.get_body_with_borrowck_facts.html"><code>get_body_with_borrowck_facts</code></a> on an async function:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>When I do so, I get the following error:</p>
<div class="codehilite"><pre><span></span><code>error: internal compiler error: broken MIR in DefId(0:6 ~ tmp[b158]::test) (bb0[0]): equate_inputs_and_outputs: `impl std::future::Future==impl std::future::Future` failed with `NoSolution`
 --&gt; /tmp/.tmp3QtvUR:3:1
  |
3 | / async fn test() {
4 | |   ();
5 | | }
  | |_^
  |
  = note: delayed at compiler/rustc_borrowck/src/type_check/mod.rs:310:27

thread &#39;rustc&#39; panicked at &#39;no errors encountered even though `delay_span_bug` issued&#39;, compiler/rustc_errors/src/lib.rs:1165:13
stack backtrace:
   0: rust_begin_unwind
             at /rustc/308dffd25cb55bbb4a1fbee9822cf82c6a5d012d/library/std/src/panicking.rs:517:5
   1: core::panicking::panic_fmt
             at /rustc/308dffd25cb55bbb4a1fbee9822cf82c6a5d012d/library/core/src/panicking.rs:103:14
   2: core::panicking::panic_display
   3: rustc_errors::HandlerInner::flush_delayed
   4: &lt;rustc_errors::HandlerInner as core::ops::drop::Drop&gt;::drop
   5: core::ptr::drop_in_place&lt;rustc_session::parse::ParseSess&gt;
   6: &lt;alloc::rc::Rc&lt;T&gt; as core::ops::drop::Drop&gt;::drop
   7: core::ptr::drop_in_place&lt;rustc_interface::interface::Compiler&gt;
   8: rustc_span::with_source_map
   9: scoped_tls::ScopedKey&lt;T&gt;::set
</code></pre></div>
<p>This error does not happen if I call <code>mir_borrowck</code> instead. Any ideas why this might be occurring?</p>



<a name="256510509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ICE%20when%20using%20get_body_with_borrowck_facts%20with%20async/near/256510509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Noah Lev <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ICE.20when.20using.20get_body_with_borrowck_facts.20with.20async.html#256510509">(Oct 07 2021 at 01:37)</a>:</h4>
<p>The docs say this:</p>
<blockquote>
<p>This function should never be invoked during a typical compilation session due to performance issues with Polonius.</p>
<p>Note:</p>
<ul>
<li>This function will panic if the required body was already stolen. This can, for example, happen when requesting a body of a const function because they are evaluated during typechecking. The panic can be avoided by overriding the mir_borrowck query. You can find a complete example that shows how to do this at src/test/run-make/obtain-borrowck/.</li>
<li>Polonius is highly unstable, so expect regular changes in its signature or other details.</li>
</ul>
</blockquote>
<p>Perhaps it's because Polonius is highly unstable? Of course, I don't think it should be panicking on this code, but the instability could be part of the reason.</p>



<a name="256510631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ICE%20when%20using%20get_body_with_borrowck_facts%20with%20async/near/256510631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ICE.20when.20using.20get_body_with_borrowck_facts.20with.20async.html#256510631">(Oct 07 2021 at 01:38)</a>:</h4>
<p>I don't think it's inherently a Polonius problem. If I take the same code and do <code>cargo +nightly rustc --profile check -- -Z polonius</code> then it checks just fine.</p>



<a name="256510922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/ICE%20when%20using%20get_body_with_borrowck_facts%20with%20async/near/256510922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/ICE.20when.20using.20get_body_with_borrowck_facts.20with.20async.html#256510922">(Oct 07 2021 at 01:43)</a>:</h4>
<p>FWIW, this is hitting a path that calls <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_borrowck/src/type_check/mod.rs#L326-L331"><code>mirbug</code></a>, which says:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="c1">// We sometimes see MIR failures (notably predicate failures) due to</span>
<span class="w">    </span><span class="c1">// the fact that we check rvalue sized predicates here. So use `delay_span_bug`</span>
<span class="w">    </span><span class="c1">// to avoid reporting bugs in those cases.</span>
</code></pre></div>
<p>I'm not sure if this means this isn't actually a bug? <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> you're the last person to touch this function, do you know what the issue might be?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>