<html>
<head><meta charset="utf-8"><title>bypassing llvm-libunwind build on musl · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html">bypassing llvm-libunwind build on musl</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268144566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268144566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268144566">(Jan 15 2022 at 20:11)</a>:</h4>
<p>It appears that all of the stuff needed to build rust on s390x-musl has landed and is basically working.</p>
<p>However, there is one problem I have encountered still: rustc <em>really</em> wants to use llvm-libunwind on the musl targets.  Normally, this is fine, as llvm-libunwind supports almost all architectures that anyone could possibly want to support, <em>except</em> it does <em>not</em> support s390x.</p>
<p>In the <code>unwind</code> library source, I note that there is a provision for building without llvm-libunwind support on musl: <a href="https://github.com/rust-lang/rust/blob/master/library/unwind/src/lib.rs#L53-L57">https://github.com/rust-lang/rust/blob/master/library/unwind/src/lib.rs#L53-L57</a></p>
<p>Accordingly, I have tried building with <code>--set=rust.llvm-libunwind=no</code> configure flag, but the build system seems to ignore this.  So, I am wondering how I can get past this last issue with s390x-musl</p>



<a name="268145435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145435">(Jan 15 2022 at 20:27)</a>:</h4>
<p>It seems that llvm-libunwind=no is already the default. <a href="https://github.com/rust-lang/rust/blob/7b13c628a214a03f4f45b80e26313df55654d254/src/bootstrap/config.rs#L207">https://github.com/rust-lang/rust/blob/7b13c628a214a03f4f45b80e26313df55654d254/src/bootstrap/config.rs#L207</a></p>



<a name="268145490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145490">(Jan 15 2022 at 20:28)</a>:</h4>
<p>yeah something seems to flip it for musl, i'm not sure what :/</p>



<a name="268145502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145502">(Jan 15 2022 at 20:28)</a>:</h4>
<p>but on s390x, we definitely need GNU libunwind there, not llvm-libunwind</p>



<a name="268145565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145565">(Jan 15 2022 at 20:30)</a>:</h4>
<p>Can you run the build with <code>-vv</code> and then look at which <code>--cfg</code> arguments are passed to the rustc invocation with <code>--crate-name unwind</code>? And can you also look at which <code>--features</code> argument is passed to the cargo invocation a couple of lines above?</p>



<a name="268145589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145589">(Jan 15 2022 at 20:30)</a>:</h4>
<p>(just to confirm the build system indeed enables the <code>llvm-libunwind</code> feature)</p>



<a name="268145729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145729">(Jan 15 2022 at 20:34)</a>:</h4>
<p>cargo does not seem to be responsible for building it per se</p>



<a name="268145742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145742">(Jan 15 2022 at 20:34)</a>:</h4>
<p>right now i am building a cross-compiler for riscv64, so i can get that one done, i'll circle back to s390x as soon as its done</p>



<a name="268145802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145802">(Jan 15 2022 at 20:36)</a>:</h4>
<p>hmm, actually.  let me do that right quick</p>



<a name="268145839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145839">(Jan 15 2022 at 20:37)</a>:</h4>
<p>however</p>



<a name="268145844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145844">(Jan 15 2022 at 20:37)</a>:</h4>
<p><a href="/user_uploads/4715/MT8YH-nrj9l_jpmMeICNVU6O/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/MT8YH-nrj9l_jpmMeICNVU6O/image.png" title="image.png"><img src="/user_uploads/4715/MT8YH-nrj9l_jpmMeICNVU6O/image.png"></a></div>



<a name="268145852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145852">(Jan 15 2022 at 20:37)</a>:</h4>
<p>this seems to be the build system itself deciding it wants to build it</p>



<a name="268145911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145911">(Jan 15 2022 at 20:38)</a>:</h4>
<p>Indeed. The message comes from <a href="https://github.com/rust-lang/rust/blob/ec4bcaac450279b029f3480b8b8f1b82ab36a5eb/src/bootstrap/native.rs#L998">https://github.com/rust-lang/rust/blob/ec4bcaac450279b029f3480b8b8f1b82ab36a5eb/src/bootstrap/native.rs#L998</a></p>



<a name="268145934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145934">(Jan 15 2022 at 20:39)</a>:</h4>
<p>(past that it is just complaining that it fails to build, the issue of course is "#error unsupported architecture")</p>



<a name="268145990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268145990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268145990">(Jan 15 2022 at 20:40)</a>:</h4>
<p>i'm capturing a build log now, but it will take some time</p>



<a name="268146014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146014">(Jan 15 2022 at 20:41)</a>:</h4>
<p>It is invoked from <a href="https://github.com/rust-lang/rust/blob/a77cc64af491a31db224109a76b9b81cd26cd07c/src/bootstrap/compile.rs#L184">https://github.com/rust-lang/rust/blob/a77cc64af491a31db224109a76b9b81cd26cd07c/src/bootstrap/compile.rs#L184</a> and <a href="https://github.com/rust-lang/rust/blob/a77cc64af491a31db224109a76b9b81cd26cd07c/src/bootstrap/compile.rs#L230">https://github.com/rust-lang/rust/blob/a77cc64af491a31db224109a76b9b81cd26cd07c/src/bootstrap/compile.rs#L230</a> The former has a conditional on llvm-libunwind being used, the later doesn't.</p>



<a name="268146088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146088">(Jan 15 2022 at 20:42)</a>:</h4>
<p>The later location tries to ensure that rustc ships with everything necessary to compile for musl (except for the linker if you don't use the lld shipped with rustc by default)</p>



<a name="268146115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146115">(Jan 15 2022 at 20:43)</a>:</h4>
<p>yes, which makes sense normally :)</p>



<a name="268146187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146187">(Jan 15 2022 at 20:44)</a>:</h4>
<p>we do use <code>dist</code> to generate tarballs, and then repack those into APKs</p>



<a name="268146188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146188">(Jan 15 2022 at 20:44)</a>:</h4>
<p>I think adding a check for s390x before that line would make sense.</p>



<a name="268146203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146203">(Jan 15 2022 at 20:44)</a>:</h4>
<p>which, 230?</p>



<a name="268146207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146207">(Jan 15 2022 at 20:44)</a>:</h4>
<p>yes</p>



<a name="268146230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146230">(Jan 15 2022 at 20:45)</a>:</h4>
<p>alright, i'll try to patch it :)</p>



<a name="268146260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146260">(Jan 15 2022 at 20:45)</a>:</h4>
<p>if llvm-libunwind doesn't support s390x there isn't much we can do to make musl fully self contained on s390x.</p>



<a name="268146313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146313">(Jan 15 2022 at 20:46)</a>:</h4>
<p>in alpine, it winds up being largely defeated anyway with the alpine-specific targets</p>



<a name="268146444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146444">(Jan 15 2022 at 20:49)</a>:</h4>
<p>if target.contains("s390x") {...} should get it done i guess</p>



<a name="268146676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146676">(Jan 15 2022 at 20:54)</a>:</h4>
<p>Pretty much. <code>target.starts_with("s390x")</code> is a bit more specific, but either should be fine I think.</p>



<a name="268146705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146705">(Jan 15 2022 at 20:54)</a>:</h4>
<p>yep</p>



<a name="268146812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268146812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268146812">(Jan 15 2022 at 20:57)</a>:</h4>
<p>i'll send this upstream once i make sure it works</p>



<a name="268147799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268147799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268147799">(Jan 15 2022 at 21:21)</a>:</h4>
<p>alright, that was a success</p>



<a name="268148344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268148344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268148344">(Jan 15 2022 at 21:34)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/92946">https://github.com/rust-lang/rust/pull/92946</a></p>



<a name="268148543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268148543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268148543">(Jan 15 2022 at 21:39)</a>:</h4>
<p>hmm, one other strange issue</p>



<a name="268148546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268148546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268148546">(Jan 15 2022 at 21:39)</a>:</h4>
<p><a href="/user_uploads/4715/locsiglV3p5o5mz53E7Dnw7H/Screen-Shot-2022-01-15-at-3.39.21-PM.png">Screen-Shot-2022-01-15-at-3.39.21-PM.png</a> i suspect something is slightly off with libc crate</p>
<div class="message_inline_image"><a href="/user_uploads/4715/locsiglV3p5o5mz53E7Dnw7H/Screen-Shot-2022-01-15-at-3.39.21-PM.png" title="Screen-Shot-2022-01-15-at-3.39.21-PM.png"><img src="/user_uploads/4715/locsiglV3p5o5mz53E7Dnw7H/Screen-Shot-2022-01-15-at-3.39.21-PM.png"></a></div>



<a name="268148600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268148600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268148600">(Jan 15 2022 at 21:40)</a>:</h4>
<p>though i checked STDOUT_FILENO and ioctl definitions for s390x-musl and they are both <code>::c_int</code> type</p>



<a name="268149142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268149142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268149142">(Jan 15 2022 at 21:55)</a>:</h4>
<p>I think the span isn't correct. <code>TIOCGWINSZ</code> is a <code>c_int</code>, but <code>ioctl</code> expects an <code>c_ulong</code> as argument. <a href="https://github.com/rust-lang/libc/blob/e470e3b6a1f940e0024d40d3b79fc73fe29c7f17/src/unix/linux_like/linux/musl/b64/s390x.rs#L320">https://github.com/rust-lang/libc/blob/e470e3b6a1f940e0024d40d3b79fc73fe29c7f17/src/unix/linux_like/linux/musl/b64/s390x.rs#L320</a></p>



<a name="268149193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268149193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268149193">(Jan 15 2022 at 21:56)</a>:</h4>
<p>For other platforms it seems like it does take <code>c_int</code> as argument.</p>



<a name="268149262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268149262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268149262">(Jan 15 2022 at 21:58)</a>:</h4>
<p>Musl defines it as int for all platforms, so that must be a bug in the libc crate: <a href="https://git.musl-libc.org/cgit/musl/tree/include/sys/ioctl.h#n115">https://git.musl-libc.org/cgit/musl/tree/include/sys/ioctl.h#n115</a></p>



<a name="268149266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268149266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268149266">(Jan 15 2022 at 21:58)</a>:</h4>
<p><span class="user-mention" data-user-id="360752">@Ariadne Conill</span></p>



<a name="268158431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268158431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268158431">(Jan 16 2022 at 01:56)</a>:</h4>
<p>ah</p>



<a name="268158433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268158433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268158433">(Jan 16 2022 at 01:56)</a>:</h4>
<p>i’ll patch the crate</p>



<a name="268158436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268158436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268158436">(Jan 16 2022 at 01:56)</a>:</h4>
<p>thanks</p>



<a name="268160060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268160060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268160060">(Jan 16 2022 at 02:36)</a>:</h4>
<p>hmmph, i patched the crate and its still complaining about argument 1</p>



<a name="268160147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268160147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268160147">(Jan 16 2022 at 02:39)</a>:</h4>
<p>Compiling libc v0.2.106</p>



<a name="268160148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268160148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268160148">(Jan 16 2022 at 02:39)</a>:</h4>
<p>hmm</p>



<a name="268160150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268160150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268160150">(Jan 16 2022 at 02:39)</a>:</h4>
<p>let me check <em>that</em> crate</p>



<a name="268160380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268160380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268160380">(Jan 16 2022 at 02:45)</a>:</h4>
<p>okay, i more forcefully patched that crate, all 3 copies of it</p>



<a name="268163065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268163065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268163065">(Jan 16 2022 at 03:59)</a>:</h4>
<p>hmmph, i think libgcc isn't being linked correctly in all cases</p>



<a name="268163067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268163067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268163067">(Jan 16 2022 at 03:59)</a>:</h4>
<p>error: Error relocating /home/kaniini/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage1-rustc/release/deps/libtracing_attributes-3303d50f7ffdcc56.so: __muloti4: symbol not found</p>



<a name="268163249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268163249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268163249">(Jan 16 2022 at 04:02)</a>:</h4>
<p><a href="https://bugs.gentoo.org/622024">https://bugs.gentoo.org/622024</a> hmm, LTO maybe?</p>



<a name="268163360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268163360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268163360">(Jan 16 2022 at 04:04)</a>:</h4>
<p>though this seems to be a proc macro, weird :)</p>



<a name="268171453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268171453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268171453">(Jan 16 2022 at 07:58)</a>:</h4>
<p><code>__muloti4</code> should be defined by compiler-builtins which is included in every invocation of the linker by rustc: <a href="https://github.com/rust-lang/compiler-builtins/blob/e6fd1b272ff4cc34810e20126ffe17888a708f39/src/int/mul.rs#L124">https://github.com/rust-lang/compiler-builtins/blob/e6fd1b272ff4cc34810e20126ffe17888a708f39/src/int/mul.rs#L124</a></p>



<a name="268181124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268181124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268181124">(Jan 16 2022 at 12:13)</a>:</h4>
<p>hmm, seems not to be in this case :(</p>



<a name="268181567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268181567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268181567">(Jan 16 2022 at 12:24)</a>:</h4>
<p>i think we hit this before.  not sure how to debug it</p>



<a name="268181574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268181574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268181574">(Jan 16 2022 at 12:24)</a>:</h4>
<p>GCC has something like specs files to determine what gets included, maybe we need to adjust something?</p>



<a name="268181738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268181738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268181738">(Jan 16 2022 at 12:28)</a>:</h4>
<p>If you are using linker plugin LTO and BFD linker <a href="https://github.com/rust-lang/rust/issues/74657">#74657</a> might be relevant.</p>



<a name="268181818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268181818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268181818">(Jan 16 2022 at 12:30)</a>:</h4>
<p>i dont think i am using LTO, but how can i check :D</p>



<a name="268182260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268182260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268182260">(Jan 16 2022 at 12:41)</a>:</h4>
<p>Could you share the complete build log? Especially one that shows the linker invocation if possible.</p>



<a name="268185390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268185390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268185390">(Jan 16 2022 at 13:51)</a>:</h4>
<p>you mean <code>-vv</code>?</p>



<a name="268185399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268185399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268185399">(Jan 16 2022 at 13:51)</a>:</h4>
<p>yes, i'll capture one in a bit.</p>



<a name="268187274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268187274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268187274">(Jan 16 2022 at 14:14)</a>:</h4>
<p><code>-vv</code> build running, i'll upload the log when it finishes.  going to grab some lunch.</p>



<a name="268190015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268190015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268190015">(Jan 16 2022 at 15:02)</a>:</h4>
<p><a href="https://distfiles.dereferenced.org/build.log.txt">https://distfiles.dereferenced.org/build.log.txt</a></p>



<a name="268192549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268192549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268192549">(Jan 16 2022 at 16:00)</a>:</h4>
<p>Building tracing_attributes happens using</p>
<div class="codehilite"><pre><span></span><code>rustc-1.58.0-src/build/bootstrap/debug/rustc --crate-name tracing_attributes --edition=2018 rustc-1.58.0-src/vendor/tracing-attributes-0.1.17/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi --crate-type proc-macro --emit=dep-info,link -C prefer-dynamic -C embed-bitcode=no -C debuginfo=0 -C debug-assertions=off -C metadata=043c6496b3b108b1 -C extra-filename=-043c6496b3b108b1 --out-dir rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage0-rustc/release/deps -C linker=gcc --extern proc_macro --cap-lints warn -Z binary-dep-depinfo
</code></pre></div>
<p>(skipping all <code>--extern</code> and <code>-L dependency=...</code>  and shortening paths for brevity.) LTO is not enabled.</p>



<a name="268192715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268192715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268192715">(Jan 16 2022 at 16:02)</a>:</h4>
<p><span class="user-mention" data-user-id="360752">@Ariadne Conill</span> Can you check all symbol imports of <code>/home/kaniini/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage0-rustc/release/deps/libtracing_attributes-043c6496b3b108b1.so</code> to see if <code>__muloti4</code> is the only missing symbol starting with <code>__</code> or if not which others are imported.</p>



<a name="268192812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268192812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268192812">(Jan 16 2022 at 16:04)</a>:</h4>
<p>sure, give me a second</p>



<a name="268193096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193096">(Jan 16 2022 at 16:10)</a>:</h4>
<p>0000000000545410 t __muloti4</p>



<a name="268193101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193101">(Jan 16 2022 at 16:10)</a>:</h4>
<p>that one is defined there</p>



<a name="268193138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193138">(Jan 16 2022 at 16:11)</a>:</h4>
<p><a href="/user_uploads/4715/tEf8pML9UTcJyWc3okqwagzC/E2E81E31-6096-4990-B2F8-7BEAF77A7500.png">E2E81E31-6096-4990-B2F8-7BEAF77A7500.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/tEf8pML9UTcJyWc3okqwagzC/E2E81E31-6096-4990-B2F8-7BEAF77A7500.png" title="E2E81E31-6096-4990-B2F8-7BEAF77A7500.png"><img src="/user_uploads/4715/tEf8pML9UTcJyWc3okqwagzC/E2E81E31-6096-4990-B2F8-7BEAF77A7500.png"></a></div>



<a name="268193141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193141">(Jan 16 2022 at 16:11)</a>:</h4>
<p>yeah definitely there</p>



<a name="268193209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193209">(Jan 16 2022 at 16:13)</a>:</h4>
<p>all the .so in that dir have it</p>



<a name="268193300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193300">(Jan 16 2022 at 16:15)</a>:</h4>
<p>hmm</p>



<a name="268193309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193309">(Jan 16 2022 at 16:15)</a>:</h4>
<p>what if it’s trying to dlopen the s390 libs</p>



<a name="268193411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193411">(Jan 16 2022 at 16:18)</a>:</h4>
<div class="codehilite"><pre><span></span><code>treefort:~/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage1-rustc/s390x-alpine-linux-musl/release/deps$ file libtracing_attributes-eff94e489e646919.so
libtracing_attributes-eff94e489e646919.so: ELF 64-bit MSB shared object, IBM S/390, version 1 (SYSV), dynamically linked, with debug_info, not stripped
treefort:~/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage1-rustc/s390x-alpine-linux-musl/release/deps$ nm libtracing_attributes-eff94e489e646919.so | grep &#39; __mul&#39;
                 U __muloti4
treefort:~/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage1-rustc/s390x-alpine-linux-musl/release/deps$
</code></pre></div>



<a name="268193449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193449">(Jan 16 2022 at 16:18)</a>:</h4>
<p>hmmmmmmmmm</p>



<a name="268193454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193454">(Jan 16 2022 at 16:18)</a>:</h4>
<p>could it be something this silly</p>



<a name="268193464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193464">(Jan 16 2022 at 16:18)</a>:</h4>
<p>cause it’s undefined there</p>



<a name="268193602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193602">(Jan 16 2022 at 16:21)</a>:</h4>
<p>/me looks at musl dynlink sources</p>



<a name="268193767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193767">(Jan 16 2022 at 16:25)</a>:</h4>
<p>i… don’t see any architecture check</p>



<a name="268193774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193774">(Jan 16 2022 at 16:25)</a>:</h4>
<p>it might actually allow this wtf</p>



<a name="268193838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193838">(Jan 16 2022 at 16:27)</a>:</h4>
<p>i’m going to</p>



<a name="268193842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193842">(Jan 16 2022 at 16:27)</a>:</h4>
<p>see if i can dlopen this</p>



<a name="268193946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268193946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268193946">(Jan 16 2022 at 16:29)</a>:</h4>
<p>ok ldd rejects it</p>



<a name="268194745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268194745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268194745">(Jan 16 2022 at 16:47)</a>:</h4>
<p>Rustc checks the triple of a crate before loading it. This applies to normal crates, but also proc macros. It will only open proc macros compiled for the same triple as rustc itself. <a href="https://github.com/rust-lang/rust/blob/7be8693984d32d2f65ce9ded4f65b6b7340bddce/compiler/rustc_metadata/src/locator.rs#L647-L654">https://github.com/rust-lang/rust/blob/7be8693984d32d2f65ce9ded4f65b6b7340bddce/compiler/rustc_metadata/src/locator.rs#L647-L654</a></p>



<a name="268194860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268194860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268194860">(Jan 16 2022 at 16:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="360752">Ariadne Conill</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/bypassing.20llvm-libunwind.20build.20on.20musl/near/268193464">said</a>:</p>
<blockquote>
<p>cause it’s undefined there</p>
</blockquote>
<p>huh. compiler-builtins should unconditionally define <code>__muloti4</code>.</p>



<a name="268195126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268195126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268195126">(Jan 16 2022 at 16:56)</a>:</h4>
<p>yeah i dunno, just noting that its not defined in that .so</p>



<a name="268195189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268195189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268195189">(Jan 16 2022 at 16:57)</a>:</h4>
<p>Just to confirm building rustc 1.58.0 for the x86_64-alpine-linux-musl works fine?</p>



<a name="268195251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268195251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268195251">(Jan 16 2022 at 16:58)</a>:</h4>
<p>yes, building in non-cross configuration works fine.  rustc 1.58 is in the archive :)</p>



<a name="268195263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268195263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268195263">(Jan 16 2022 at 16:58)</a>:</h4>
<p>and, if you check the log, you can see it installing rustc 1.58</p>



<a name="268195626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268195626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268195626">(Jan 16 2022 at 17:04)</a>:</h4>
<p>When you checked for <code>__muloti4</code> in <code>/home/kaniini/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage0-rustc/release/deps/libtracing_attributes-043c6496b3b108b1.so</code> did you pass <code>-D</code> to nm? I believe it defaults to reading <code>.symtab</code> rather than <code>.dynsym</code>.</p>



<a name="268195641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268195641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268195641">(Jan 16 2022 at 17:05)</a>:</h4>
<p>i literally disassembled it</p>



<a name="268195741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268195741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268195741">(Jan 16 2022 at 17:07)</a>:</h4>
<div class="codehilite"><pre><span></span><code>treefort:~/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage0-rustc/release/deps$ nm -D libtracing_attributes-043c6496b3b108b1.so | grep __mul
treefort:~/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage0-rustc/release/deps$
</code></pre></div>



<a name="268195743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268195743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268195743">(Jan 16 2022 at 17:07)</a>:</h4>
<p>nothin'</p>



<a name="268195820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268195820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268195820">(Jan 16 2022 at 17:08)</a>:</h4>
<p>What relocations for <code>__muloti4</code> does <code>readelf --relocs</code> show?</p>



<a name="268195846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268195846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268195846">(Jan 16 2022 at 17:09)</a>:</h4>
<div class="codehilite"><pre><span></span><code>treefort:~/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage0-rustc/release/deps$ readelf --relocs libtracing_attributes-043c6496b3b108b1.so  | grep __muloti4
treefort:~/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage0-rustc/release/deps$
</code></pre></div>



<a name="268195917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268195917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268195917">(Jan 16 2022 at 17:10)</a>:</h4>
<p>??? Why does it have any problems relocating when there are no relocations for the symbol it complains about?</p>



<a name="268196017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196017">(Jan 16 2022 at 17:12)</a>:</h4>
<p>i dunno :D</p>



<a name="268196027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196027">(Jan 16 2022 at 17:13)</a>:</h4>
<p>i wonder if i would be better off trying to cross compile from s390x-glibc</p>



<a name="268196208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196208">(Jan 16 2022 at 17:17)</a>:</h4>
<p>o</p>



<a name="268196212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196212">(Jan 16 2022 at 17:17)</a>:</h4>
<p>/home/kaniini/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage1-rustc/release/deps/libtracing_attributes-3303d50f7ffdcc56.so: __muloti4: symbol not found</p>



<a name="268196215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196215">(Jan 16 2022 at 17:17)</a>:</h4>
<p><em>stage1</em></p>



<a name="268196301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196301">(Jan 16 2022 at 17:19)</a>:</h4>
<p>in <em>stage1</em>, we have</p>
<div class="codehilite"><pre><span></span><code>treefort:~/aports/community/rust/src/rustc-1.58.0-src/build/x86_64-alpine-linux-musl/stage1-rustc/release/deps$ readelf --relocs libtracing_attributes-3303d50f7ffdcc56.so | grep __muloti4
00000065d390  006d00000006 R_X86_64_GLOB_DAT 0000000000000000 __muloti4 + 0
</code></pre></div>



<a name="268196314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196314">(Jan 16 2022 at 17:19)</a>:</h4>
<p>so this is happening between stage0 and stage1</p>



<a name="268196544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196544">(Jan 16 2022 at 17:23)</a>:</h4>
<p>Can you search through the disassembly with objdump and see where that function is getting used within the shared library?</p>



<a name="268196842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196842">(Jan 16 2022 at 17:29)</a>:</h4>
<p>yes</p>



<a name="268196911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196911">(Jan 16 2022 at 17:30)</a>:</h4>
<div class="codehilite"><pre><span></span><code>00000000005209c0 &lt;_ZN4core3num14from_str_radix17h0cfa90d2f56c97feE&gt;:
   ...
   520a7a:       ff 15 10 c9 13 00       call   *0x13c910(%rip)        # 65d390 &lt;__muloti4@Base&gt;
</code></pre></div>



<a name="268196922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196922">(Jan 16 2022 at 17:30)</a>:</h4>
<p>Unrelated to this issue, but I just saw that <code>-Ztls-model=initial-exec</code> is passed to proc macro builds. <code>initial-exec</code> is only allowed for executables and dynamic libraries that aren't dlopen'ed. Proc-macros _are_ dlopen'ed.</p>



<a name="268196963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268196963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268196963">(Jan 16 2022 at 17:31)</a>:</h4>
<p>interesting.  i can check the x86_64 native build log</p>



<a name="268197029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268197029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268197029">(Jan 16 2022 at 17:32)</a>:</h4>
<p><a href="https://build.alpinelinux.org/buildlogs/build-edge-x86_64/community/rust/rust-1.58.0-r0.log">https://build.alpinelinux.org/buildlogs/build-edge-x86_64/community/rust/rust-1.58.0-r0.log</a></p>



<a name="268197139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268197139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268197139">(Jan 16 2022 at 17:34)</a>:</h4>
<p>on the native build, it does not seem to be using -Ztls-model=initial-exec on the proc macro builds</p>



<a name="268197293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268197293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268197293">(Jan 16 2022 at 17:37)</a>:</h4>
<p>hmm!</p>



<a name="268197296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268197296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268197296">(Jan 16 2022 at 17:37)</a>:</h4>
<p>Opened <a href="https://github.com/rust-lang/rust/issues/92976">https://github.com/rust-lang/rust/issues/92976</a></p>



<a name="268197305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268197305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268197305">(Jan 16 2022 at 17:37)</a>:</h4>
<p>the initial-exec seems to happen on stage1 x86_64 -&gt; s390x native</p>



<a name="268197372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268197372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268197372">(Jan 16 2022 at 17:38)</a>:</h4>
<p>Probably related to the fact that cargo ignores <code>RUSTFLAGS</code> when compiling for the host if <code>--target</code> is passed. <code>RUSTFLAGS</code> is used to pass <code>-Ztls-model=initial-exec</code> to rustc.</p>



<a name="268197409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/bypassing%20llvm-libunwind%20build%20on%20musl/near/268197409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ariadne Conill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/bypassing.20llvm-libunwind.20build.20on.20musl.html#268197409">(Jan 16 2022 at 17:39)</a>:</h4>
<p>so, the stage1 intermediate (x86_64 before x86_64 -&gt; s390x phase) compiler is missing <code>__muloti4</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>