<html>
<head><meta charset="utf-8"><title>adding new pass (stability) · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html">adding new pass (stability)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271239042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271239042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271239042">(Feb 09 2022 at 07:19)</a>:</h4>
<p>I'm trying to extend the stability checker to consider the stability of const trait impls. I have a struct that implements <code>Visitor</code>, but it doesn't seem to be called consistently and I can't figure out why.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_impl_const_trait</span><span class="p">(</span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">visitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckStableImplConstTrait</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">tcx</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">walk_toplevel_module</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">visitor</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">visit_all_item_likes</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">visitor</span><span class="p">.</span><span class="n">as_deep_visitor</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This function exists, but <code>&lt;CheckStableImplConstTrait as Visitor&gt;::visit_impl_item</code> isn't called in a UI test that contains</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[stable(feature = </span><span class="s">"rust1"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="cp">#[rustc_const_stable(feature = </span><span class="s">"rust1"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="n">Sub</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Int</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>It's not just that the code is wrong — it's not being called at all. I verified this by adding in <code>dbg!</code> statements, but it's not output from the UI test. I added the pass into <code>compiler/rustc_interface/src/passes.rs</code> under <code>misc_checking_3</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sess</span><span class="p">.</span><span class="n">time</span><span class="p">(</span><span class="s">"stable_impl_const_trait_checking"</span><span class="p">,</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">rustc_passes</span>::<span class="n">stability</span>::<span class="n">check_impl_const_trait</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
</code></pre></div>
<p>What am I missing? As far as I can tell the visitor should be called, but it's not <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="271374518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271374518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271374518">(Feb 10 2022 at 01:26)</a>:</h4>
<p>Anyone have any ideas? Happy to provide additional information as necessary, of course.</p>



<a name="271411378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271411378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271411378">(Feb 10 2022 at 10:23)</a>:</h4>
<p>What does your visitor look like? (What methods are overridden? What's the <code>NestedFilter</code> type?) The <code>walk_toplevel_module</code> + <code>visit_all_item_likes</code> seems a bit redundant, what's the rationale? Does <code>dbg!</code> in the compiler work the way you expect it does?</p>
<p>I tested something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">CheckStableImplConstTrait</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[allow(unused)]</span><span class="w"></span>
<span class="w">    </span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="n">intravisit</span>::<span class="n">Visitor</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">CheckStableImplConstTrait</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">visit_item</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">tcx</span> <span class="nc">Item</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">warn</span><span class="o">!</span><span class="p">(</span><span class="s">"visited item {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">ident</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">visit_trait_item</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">tcx</span> <span class="nc">TraitItem</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">warn</span><span class="o">!</span><span class="p">(</span><span class="s">"visited trait item {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">ident</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">visit_impl_item</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">i</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">tcx</span> <span class="nc">ImplItem</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">warn</span><span class="o">!</span><span class="p">(</span><span class="s">"visited impl item {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">ident</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_impl_const_trait</span><span class="p">(</span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">visitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckStableImplConstTrait</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">tcx</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="c1">// tcx.hir().walk_toplevel_module(&amp;mut visitor);</span>
<span class="w">    </span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">visit_all_item_likes</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">visitor</span><span class="p">.</span><span class="n">as_deep_visitor</span><span class="p">());</span><span class="w"> </span><span class="c1">// might as-well directly use `ItemLikeVisitor` though…</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and it seems to work fine</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(const_trait_impl)]</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Int</span><span class="p">(</span><span class="kt">i32</span><span class="p">);</span><span class="w"></span>

<span class="c1">// #[stable(feature = "rust1", since = "1.0.0")]</span>
<span class="c1">// #[rustc_const_stable(feature = "rust1", since = "1.0.0")]</span>
<span class="k">impl</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="n">Sub</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Int</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>WARN rustc_passes::stability visited item #0
WARN rustc_passes::stability visited item std#1
WARN rustc_passes::stability visited item Int#0
WARN rustc_passes::stability visited item #0
WARN rustc_passes::stability visited impl item Output#0
WARN rustc_passes::stability visited impl item sub#0
    Finished dev [unoptimized + debuginfo] target(s) in 0.15s
</code></pre></div>



<a name="271412517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271412517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271412517">(Feb 10 2022 at 10:33)</a>:</h4>
<p>The two method calls were me copying stuff nearby in an attempt to make it work, basically. I originally only had <code>visit_all_item_likes</code>, which is what I believe should be necessary.</p>
<p>This is the full definition of the struct and its visitor (leaving out comments on the approach I intend to take):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Visitor</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">CheckStableImplConstTrait</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">NestedFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nested_filter</span>::<span class="n">OnlyBodies</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">nested_visit_map</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span>::<span class="n">Map</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">visit_impl_item</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ii</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">tcx</span> <span class="nc">hir</span>::<span class="n">ImplItem</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">tcx</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">def_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">get_parent_item</span><span class="p">(</span><span class="n">ii</span><span class="p">.</span><span class="n">hir_id</span><span class="p">());</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">impl_trait_ref</span><span class="p">(</span><span class="n">def_id</span><span class="p">).</span><span class="n">is_some</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">is_const_trait_impl_raw</span><span class="p">(</span><span class="n">def_id</span><span class="p">.</span><span class="n">to_def_id</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">const_stable</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                    </span><span class="n">tcx</span><span class="p">.</span><span class="n">lookup_const_stability</span><span class="p">(</span><span class="n">def_id</span><span class="p">).</span><span class="n">map_or</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">stab</span><span class="o">|</span><span class="w"> </span><span class="n">stab</span><span class="p">.</span><span class="n">is_const_stable</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">const_stable</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">tcx</span><span class="p">.</span><span class="n">sess</span><span class="p">.</span><span class="n">span_err</span><span class="p">(</span><span class="n">ii</span><span class="p">.</span><span class="n">span</span><span class="p">,</span><span class="w"> </span><span class="s">"trait implementations cannot be const stable yet"</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">intravisit</span>::<span class="n">walk_impl_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ii</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I'm <em>just</em> going to bed now (late…), but I'll try copying what you have later to see if I can figure something out.</p>



<a name="271412591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271412591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271412591">(Feb 10 2022 at 10:34)</a>:</h4>
<p>100% unrelated but I wish Zulip supported <code>_foo_</code> for italics.</p>



<a name="271437275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271437275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Frank Steffahn <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271437275">(Feb 10 2022 at 14:20)</a>:</h4>
<p>Seems to me like instead of finding an <em>impl-item</em> (like e.g. a method implementation) and then jumping to its parent, you should instead find the <em>item</em> that is the trait implementation itself. Also as long as you’re not handling e.g. expressions or other stuff contained in bodies, afaict just using an <code>ItemLikeVisitor</code> is more straightforward / recommended. Compare the documentation on <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_hir/itemlikevisit/trait.ItemLikeVisitor.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_hir/itemlikevisit/trait.ItemLikeVisitor.html</a></p>
<hr>
<p>I agree on _underscore italics_ being a missing feature</p>



<a name="271537891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271537891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271537891">(Feb 11 2022 at 06:57)</a>:</h4>
<p>Heh, this is what happens when you've no idea what to do and aren't familiar with the APIs. Visiting the item itself is obviously better and something I'll try.</p>



<a name="271545377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271545377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271545377">(Feb 11 2022 at 08:43)</a>:</h4>
<p>Alright…after some playing around, I've determined that it's the <code>#[rustc_const_stable]</code> attribute that's actually causing things to break.</p>
<p>With this definition of the struct and impl:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">CheckStableImplConstTrait</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[allow(dead_code)]</span><span class="w"></span>
<span class="w">    </span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ItemLikeVisitor</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">CheckStableImplConstTrait</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">visit_item</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_item</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">tcx</span> <span class="nc">Item</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">warn</span><span class="o">!</span><span class="p">(</span><span class="s">"visit_item"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">visit_trait_item</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_trait_item</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">tcx</span> <span class="nc">hir</span>::<span class="n">TraitItem</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">visit_impl_item</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_impl_item</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">tcx</span> <span class="nc">hir</span>::<span class="n">ImplItem</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">visit_foreign_item</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_foreign_item</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="na">tcx</span> <span class="nc">hir</span>::<span class="n">ForeignItem</span><span class="o">&lt;'</span><span class="na">tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>and this function being  called:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_impl_const_trait</span><span class="p">(</span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">visitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckStableImplConstTrait</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">tcx</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">tcx</span><span class="p">.</span><span class="n">hir</span><span class="p">().</span><span class="n">visit_all_item_likes</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">visitor</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>the following test <em>succeeds</em> in having four warnings emitted:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// compile-flags: --crate-type=lib</span>

<span class="cp">#![no_implicit_prelude]</span><span class="w"> </span><span class="c1">// minimize noise</span>
<span class="cp">#![feature(const_trait_impl)]</span><span class="w"></span>
<span class="cp">#![feature(staged_api)]</span><span class="w"></span>
<span class="cp">#![stable(feature = </span><span class="s">"rust1"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>

<span class="cp">#[stable(feature = </span><span class="s">"rust1"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Int</span><span class="p">(</span><span class="kt">i32</span><span class="p">);</span><span class="w"></span>

<span class="cp">#[stable(feature = </span><span class="s">"rust1"</span><span class="cp">, since = </span><span class="s">"1.0.0"</span><span class="cp">)]</span><span class="w"></span>
<span class="c1">// #[rustc_const_stable(feature = "rust1", since = "1.0.0")]</span>
<span class="cp">#[rustc_const_unstable(feature = </span><span class="s">"const_sub"</span><span class="cp">, issue = </span><span class="s">"none"</span><span class="cp">)]</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span>::<span class="n">ops</span>::<span class="n">Sub</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Int</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">rhs</span>: <span class="nc">Self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rhs</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><strong>BUT</strong> if you switch the const stability attribute (by changing which one is commented out), then suddenly no warnings are emitted. I have absolutely no idea why this is, but it seems like a bug to my untrained eye.</p>



<a name="271545585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271545585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271545585">(Feb 11 2022 at 08:46)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="124288">@oli</span> — I've no idea if you know anything about the way these attributes work, but it can't hurt to ask</p>



<a name="271548149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271548149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271548149">(Feb 11 2022 at 09:14)</a>:</h4>
<p>Are you sure <code>check_impl_const_trait</code> is invoked if the comments are toggled?</p>



<a name="271548375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271548375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271548375">(Feb 11 2022 at 09:16)</a>:</h4>
<p>quick test shows that it is not invoked</p>



<a name="271548461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271548461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271548461">(Feb 11 2022 at 09:17)</a>:</h4>
<p>I added this to the <a href="http://passes.rs">passes.rs</a> file under the "misc_checking_3" section</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sess</span><span class="p">.</span><span class="n">time</span><span class="p">(</span><span class="s">"stable_impl_const_trait_checking"</span><span class="p">,</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">rustc_passes</span>::<span class="n">stability</span>::<span class="n">check_impl_const_trait</span><span class="p">(</span><span class="n">tcx</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
</code></pre></div>



<a name="271548608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271548608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271548608">(Feb 11 2022 at 09:18)</a>:</h4>
<p>wait, I just realized it wasn't at the "top level" of that bit, but was under <code>tcx.ensure().privacy_access_levels(());</code> in that parallel call. Lemme see if that makes a difference</p>



<a name="271548735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271548735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271548735">(Feb 11 2022 at 09:20)</a>:</h4>
<p>It does not make a difference.</p>



<a name="271551262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271551262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271551262">(Feb 11 2022 at 09:41)</a>:</h4>
<p>Ah, I'm suspecting you've run afoul of the test defaulting to just running in check mode. Try adding <code>// build-pass</code> to it</p>



<a name="271551498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271551498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271551498">(Feb 11 2022 at 09:43)</a>:</h4>
<p>Hm. That works. Is it possible to add passes to check-time? The intent is to move the check for stable <code>impl const Trait</code> from a semantic check to a proper stability check (which <em>should</em> happen with <code>cargo check</code>)</p>



<a name="271551996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271551996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271551996">(Feb 11 2022 at 09:47)</a>:</h4>
<p>I think usually they are happening early. Not sure why your comment change changes any of that. I won't be able to dig into that until monday, but I recommend opening a WIP PR so we can talk about the concrete code changes</p>



<a name="271552105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271552105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271552105">(Feb 11 2022 at 09:48)</a>:</h4>
<p>Will do later on. It's definitely something that <em>should</em> happen. It's just that I've never touched this kind of code before <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="271555985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271555985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271555985">(Feb 11 2022 at 10:22)</a>:</h4>
<p>Sorry, didn't mean to say you did anything wrong in your impl. I was referring to the comment changes in the test causing the behaviour</p>



<a name="271556022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/adding%20new%20pass%20%28stability%29/near/271556022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/adding.20new.20pass.20(stability).html#271556022">(Feb 11 2022 at 10:23)</a>:</h4>
<p>Oh I understood :) No worries</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>