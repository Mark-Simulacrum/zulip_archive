<html>
<head><meta charset="utf-8"><title>cross-compiling rustc/stdlib/cargo · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html">cross-compiling rustc/stdlib/cargo</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263057456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263057456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263057456">(Nov 29 2021 at 19:36)</a>:</h4>
<p>Hello!  I'm trying to cross-compile rust for i686-unknown-linux-gnu as an experiment (will move to other targets such as aarch64-linux-gnu after), but so far it seems the x.py build script wants/needs to build for x86_64-unknown-linux-gnu even though I've specified  --target i686-unknown-linux-gnu.  Is this expected/normal?</p>



<a name="263058267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263058267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263058267">(Nov 29 2021 at 19:42)</a>:</h4>
<p>Yes, the build system needs to build the compiler for the host system to be able to cross-compile a standard library suitable for the cross-compiled rustc. It doesn't knoe that an x86_64-unknown-linux host is able to run an i686-unknown-linux-gnu rustc and in fact this may not be true if the required libraries aren't installed as 32bit version.</p>



<a name="263058563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263058563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263058563">(Nov 29 2021 at 19:44)</a>:</h4>
<p>But my bootstrap compiler is necessarily a x86_64-unknown-linux rustc compiler, no?  Why does it insist on rebuilding it?</p>



<a name="263058889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263058889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263058889">(Nov 29 2021 at 19:47)</a>:</h4>
<p>Re-reading your reply, OK, I think I understand; it builds stdlib differently, tuned to work with the cross-compiled rustc.</p>



<a name="263058903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263058903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263058903">(Nov 29 2021 at 19:47)</a>:</h4>
<p><span class="user-mention" data-user-id="437426">@apteryx</span> rustc's build process assumes that it needs to build a fresh host compiler that isn't the bootstrap compiler, and then build a <em>matching</em> std with the host compiler.</p>



<a name="263059022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059022">(Nov 29 2021 at 19:48)</a>:</h4>
<p>Is there a way to force it to <em>not</em> though this? Reading ./x.py --help I thought about --stage 0, but it wasn't enough it seems.</p>



<a name="263059042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059042">(Nov 29 2021 at 19:48)</a>:</h4>
<p>In theory, you could build host tools <em>directly</em> for <code>i686-unknown-linux-gnu</code> first and then use those host tools, but that's not true of everything we could cross-compile host tools for. For instance, you could also cross-compile <code>x86_64-unknown-windows-gnu</code> host tools from your system, but you probably don't want to use those tools under wine to build the stdlib. ;)</p>



<a name="263059045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059045">(Nov 29 2021 at 19:48)</a>:</h4>
<p>with <code>--keep-stage</code>, but idk if that works for cross-compiling</p>



<a name="263059084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059084">(Nov 29 2021 at 19:49)</a>:</h4>
<p>--keep-stage assumes things are already in the build tree; but I'm in a clean environment so it doesn't exist (and fails attempting to copy missing files).</p>



<a name="263059089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059089">(Nov 29 2021 at 19:49)</a>:</h4>
<p>the option is only meant for development, not to create proper builds</p>



<a name="263059117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059117">(Nov 29 2021 at 19:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263059022">said</a>:</p>
<blockquote>
<p>Is there a way to force it to <em>not</em> though this? Reading ./x.py --help I thought about --stage 0, but it wasn't enough it seems.</p>
</blockquote>
<p>Do you have all the necessary libraries and headers installed to build things for <code>i686-unknown-linux-gnu</code>?</p>



<a name="263059134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059134">(Nov 29 2021 at 19:49)</a>:</h4>
<p>And to run those things?</p>



<a name="263059188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059188">(Nov 29 2021 at 19:50)</a>:</h4>
<p>good, question, I simply assumed having a stage 2 rustc/stdlib/cargo installed was enough</p>



<a name="263059258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059258">(Nov 29 2021 at 19:50)</a>:</h4>
<p>(installed for the host -- x86_64-unknown-linux-gnu)</p>



<a name="263059294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059294">(Nov 29 2021 at 19:50)</a>:</h4>
<p>You're trying to build host tools for i686, not just std for i686, right?</p>



<a name="263059313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059313">(Nov 29 2021 at 19:50)</a>:</h4>
<p>You want a <code>rustc</code> that's a 32-bit binary?</p>



<a name="263059402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059402">(Nov 29 2021 at 19:51)</a>:</h4>
<p>I'm basically trying to use my cleanly bootstrapped rust 1.54 (from rustc -&gt; 1.40 -&gt; ... -&gt; 1.54) on x86_64 to cross-build rust (including stdlib and cargo) for another architecture</p>



<a name="263059439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059439">(Nov 29 2021 at 19:51)</a>:</h4>
<p>since mrustc doesn't yet support non-x86_64 architectures</p>



<a name="263059500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059500">(Nov 29 2021 at 19:52)</a>:</h4>
<p>Then in that case, one approach would be to use <code>linux32 ./x.py</code>.</p>



<a name="263059532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059532">(Nov 29 2021 at 19:52)</a>:</h4>
<p>That'll make your host look like i686 to the Rust build process, which will then build host tools for i686.</p>



<a name="263059601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059601">(Nov 29 2021 at 19:53)</a>:</h4>
<p>That won't scale to </p>
<blockquote>
<p>(will move to other targets such as aarch64-linux-gnu after)</p>
</blockquote>



<a name="263059612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059612">(Nov 29 2021 at 19:53)</a>:</h4>
<p><em>nod</em>, I understand.</p>



<a name="263059639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059639">(Nov 29 2021 at 19:53)</a>:</h4>
<p>yeah, I'd like the same recipe to scale to other arches</p>



<a name="263059646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059646">(Nov 29 2021 at 19:53)</a>:</h4>
<p>Ideally you do want the ability to cross-compile host tools for a variety of targets without building <em>on</em> those targets.</p>



<a name="263059674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059674">(Nov 29 2021 at 19:53)</a>:</h4>
<p>I think that ought to be possible, but I'm not sure if it's fully possible with x.py and config.toml today.</p>



<a name="263059717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059717">(Nov 29 2021 at 19:53)</a>:</h4>
<p>The local 're' build is necessary, but it should get shared across any of the N targets you're compiling for. It's not clear to me why you need to avoid it</p>



<a name="263059744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059744">(Nov 29 2021 at 19:54)</a>:</h4>
<p>isn't that what the CI dockers do?</p>



<a name="263059827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263059827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263059827">(Nov 29 2021 at 19:54)</a>:</h4>
<p>It's not generally desirable to cross-compile for the first compiler, because the produced compiler is not ABI-compatible with itself (this is why we need stage 2 builds)</p>



<a name="263060100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263060100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263060100">(Nov 29 2021 at 19:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263059717">said</a>:</p>
<blockquote>
<p>The local 're' build is necessary, but it should get shared across any of the N targets you're compiling for. It's not clear to me why you need to avoid it</p>
</blockquote>
<p>One reason is because of (perceived?) config.toml limitations: I'm setting things that are global to any targets, so in a cross-compiling environment that doesn't work if I don't control explicitly what architecture artifacts get built when.  E.g., I've set default-linker to my i686 cross-gcc; that'll fail it the build system attempts to link on x86_64. Same for the JEMALLOC_OVERRIDE environment variable.</p>



<a name="263060193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263060193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263060193">(Nov 29 2021 at 19:57)</a>:</h4>
<p>If there's anything in config.toml that needs to get moved/get override into the target-specific section, I'm happy to review patches for it</p>



<a name="263060343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263060343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263060343">(Nov 29 2021 at 19:59)</a>:</h4>
<p>I wouldn't try to workaround those limitations with avoiding the rebuild though, because it's going to cause you other problems down the line</p>



<a name="263060350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263060350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263060350">(Nov 29 2021 at 19:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263059639">said</a>:</p>
<blockquote>
<p>yeah, I'd like the same recipe to scale to other arches</p>
</blockquote>
<p>You can specify multiple targets to cross-compile for at once. It will only build rustc for the host once and once for each target.</p>



<a name="263060813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263060813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263060813">(Nov 29 2021 at 20:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263060100">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263059717">said</a>:</p>
<blockquote>
<p>The local 're' build is necessary, but it should get shared across any of the N targets you're compiling for. It's not clear to me why you need to avoid it</p>
</blockquote>
<p>One reason is because of (perceived?) config.toml limitations: I'm setting things that are global to any targets, so in a cross-compiling environment that doesn't work if I don't control explicitly what architecture artifacts get built when.  E.g., I've set default-linker to my i686 cross-gcc; that'll fail it the build system attempts to link on x86_64. Same for the JEMALLOC_OVERRIDE environment variable.</p>
</blockquote>
<p>You can set the linker to use in the build system of rustc for each target individually using the <code>[target."&lt;target_name&gt;"]</code> section. That won't change the default linker of the different produced rustc executables though.</p>



<a name="263060957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263060957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263060957">(Nov 29 2021 at 20:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263060350">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263059639">said</a>:</p>
<blockquote>
<p>yeah, I'd like the same recipe to scale to other arches</p>
</blockquote>
<p>You can specify multiple targets to cross-compile for at once. It will only build rustc for the host once and once for each target.</p>
</blockquote>
<p>that'd greatly increase tho amount of things required to carry in the environment though (a cross GCC for each architecture to build for,  and also the target libs used from the system (openssl, libssh2, libcurl, llvm).  It's nice that it's possible though.</p>



<a name="263061598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263061598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263061598">(Nov 29 2021 at 20:09)</a>:</h4>
<p>Also, even if I <code>./x.py build src/libstd src/tools/cargo src/tools/rustfmt</code> without --target (i.e., for the host), then adjust default-linker in <code>config.toml</code> as well as <code>JEMALLOC_OVERRIDE</code> and cross build with --target, it still tries to build things for the host: <a href="https://paste.debian.net/1221258/">https://paste.debian.net/1221258/</a></p>



<a name="263061830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263061830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263061830">(Nov 29 2021 at 20:11)</a>:</h4>
<p>default-linker likely applies to the host rustc as well.</p>



<a name="263061967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263061967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263061967">(Nov 29 2021 at 20:12)</a>:</h4>
<p>in that output, the <code>build</code>phase ran a native build (without --target) for x86_64-unknown-linux-gnu (where default-linker was set to the native gcc), while the <code>cross-build</code> phase ran a cross build for i686-unknown-linux-gnu, with the default-linker option adjusted for the cross gcc.</p>



<a name="263062126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263062126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263062126">(Nov 29 2021 at 20:14)</a>:</h4>
<p>it failed because it proceeded to build for x86_64-unknown-linux-gnu during the cross-build phase (where the default-linker is set to the cross gcc!).</p>



<a name="263062720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263062720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263062720">(Nov 29 2021 at 20:20)</a>:</h4>
<p>It tried to compile it again during the cross-build phase as the config changed. The build system always runs all stages of the build even if some are already finished previously and lets cargo figure out if something needs to be recompiled. Cargo notices that one of the env vars read by rustc (the one containing the default linker) changed and as such considers the old compiled rustc dirty and recompiles it.</p>



<a name="263062810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263062810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263062810">(Nov 29 2021 at 20:21)</a>:</h4>
<p>would sccache help there since it only affects the linker?</p>



<a name="263062814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263062814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263062814">(Nov 29 2021 at 20:21)</a>:</h4>
<p>hmm.  Would --keep-stage help?</p>



<a name="263062957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263062957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263062957">(Nov 29 2021 at 20:22)</a>:</h4>
<p>/me is not sure how --keep-stage behaves in cross-compilation.  It would try to keep the stage for the host, or for the target, or for both?</p>



<a name="263063344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263063344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263063344">(Nov 29 2021 at 20:26)</a>:</h4>
<p>keep-stage is unlikely to be helpful, or at least, I would not rely on it.</p>



<a name="263063653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263063653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263063653">(Nov 29 2021 at 20:28)</a>:</h4>
<p>OK.  Is there a cross-compiled rust somewhere (I've heard the CI?) What do people do to select the default-linker?  Or they don't specify it and it uses /usr/bin/ld or something?</p>



<a name="263063727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263063727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263063727">(Nov 29 2021 at 20:29)</a>:</h4>
<p>The default linker is optional, I'm not sure what the fallback (i.e., actual default) is, but afaik CI doesn't set it</p>



<a name="263063984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263063984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263063984">(Nov 29 2021 at 20:31)</a>:</h4>
<p>It'd be required on my system (Guix) since it doesn't rely on file hiearchy (FHS) such as /usr/bin.  I guess if only the rustc commands needs to be told where it is, I could add the correct <code>ld</code> to PATH in a wrapper script.</p>



<a name="263064267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263064267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263064267">(Nov 29 2021 at 20:34)</a>:</h4>
<p>Well, I mean, it sounds like default-linker is a good thing to add a target-specific override for</p>



<a name="263064333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263064333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263064333">(Nov 29 2021 at 20:34)</a>:</h4>
<p>I would recommend doing that work over trying to hack around it</p>



<a name="263064334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263064334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263064334">(Nov 29 2021 at 20:34)</a>:</h4>
<p>Any idea where this change would need to be made in the sources?  I could try my hand at a simple patch.</p>



<a name="263064371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263064371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263064371">(Nov 29 2021 at 20:35)</a>:</h4>
<p>somewhere in <code>src/bootstrap</code></p>



<a name="263064404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263064404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263064404">(Nov 29 2021 at 20:35)</a>:</h4>
<p>not sure exactly where, but look for the string "target" in <code>config.rs</code></p>



<a name="263064521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263064521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263064521">(Nov 29 2021 at 20:36)</a>:</h4>
<p>Add default_linker to <a href="https://github.com/rust-lang/rust/blob/6db0a0e9a4a2f55b1a85954e114ada0b45c32e45/src/bootstrap/config.rs#L297">https://github.com/rust-lang/rust/blob/6db0a0e9a4a2f55b1a85954e114ada0b45c32e45/src/bootstrap/config.rs#L297</a>, then <a href="https://github.com/rust-lang/rust/blob/8b954910c59a7a362c60959e93110892b6e9a691/src/bootstrap/compile.rs#L675">https://github.com/rust-lang/rust/blob/8b954910c59a7a362c60959e93110892b6e9a691/src/bootstrap/compile.rs#L675</a> will want to make use of that with logic somewhat like <a href="https://github.com/rust-lang/rust/blob/8b954910c59a7a362c60959e93110892b6e9a691/src/bootstrap/lib.rs#L1008">https://github.com/rust-lang/rust/blob/8b954910c59a7a362c60959e93110892b6e9a691/src/bootstrap/lib.rs#L1008</a></p>



<a name="263064555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263064555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263064555">(Nov 29 2021 at 20:36)</a>:</h4>
<p>You'll also want to adjust config.toml.example to document the option.</p>



<a name="263072032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263072032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263072032">(Nov 29 2021 at 21:47)</a>:</h4>
<p>Hmm, I got to the config.toml.example, and now I'm confused whether this change is necessary; it seems <code>default-linker</code> is a fallback in case <code>linker</code> is not set per target?</p>



<a name="263072159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263072159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263072159">(Nov 29 2021 at 21:48)</a>:</h4>
<div class="codehilite"><pre><span></span><code># Linker to be used to bootstrap Rust code. Note that the
# default value is platform specific, and if not specified it may also depend on
# what platform is crossing to what platform.
# Setting this will override the `use-lld` option for Rust code when targeting MSVC.
#linker = &quot;cc&quot; (path)
</code></pre></div>
<p>So this is the linker to use to <em>build</em> rustc?</p>



<a name="263072234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263072234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263072234">(Nov 29 2021 at 21:49)</a>:</h4>
<p>and then</p>
<div class="codehilite"><pre><span></span><code># The default linker that will be hard-coded into the generated compiler for
# targets that don&#39;t specify linker explicitly in their target specifications.
# Note that this is not the linker used to link said compiler.
#
# See https://doc.rust-lang.org/rustc/codegen-options/index.html#linker for more information.
#default-linker = &lt;none&gt; (path)
</code></pre></div>
<p>Also affects the linker used to <em>build</em> rustc, but on top of it, gets baked in rustc as the linker <em>used</em> by it?</p>



<a name="263072544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263072544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263072544">(Nov 29 2021 at 21:52)</a>:</h4>
<p>Just the later, if the comment is accurate</p>



<a name="263072577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263072577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263072577">(Nov 29 2021 at 21:53)</a>:</h4>
<p>So in my cross-compilation example, it seems I should set both per-target <code>linker</code> and <code>default-linker</code> options.</p>



<a name="263072689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263072689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263072689">(Nov 29 2021 at 21:54)</a>:</h4>
<p>Probably, yes.</p>



<a name="263072723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263072723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263072723">(Nov 29 2021 at 21:54)</a>:</h4>
<p>what do you think of:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code>3 files changed, 15 insertions(+), 5 deletions(-)
config.toml.example      |  8 +++++---
src/bootstrap/compile.rs | 11 +++++++++--
src/bootstrap/config.rs  |  1 +

modified   config.toml.example
<span class="gu">@@ -488,9 +488,11 @@ changelog-seen = 2</span>
 # FIXME(#75760): Some UI tests fail when this option is enabled.
 #parallel-compiler = false

<span class="gd">-# The default linker that will be hard-coded into the generated compiler for</span>
<span class="gd">-# targets that don't specify linker explicitly in their target specifications.</span>
<span class="gd">-# Note that this is not the linker used to link said compiler.</span>
<span class="gi">+# The default linker that will be hard-coded into the generated</span>
<span class="gi">+# compiler for targets that don't specify linker explicitly in their</span>
<span class="gi">+# target specifications.  Note that this is not the linker used to</span>
<span class="gi">+# link said compiler.  It can also be set per-target, which may be</span>
<span class="gi">+# useful for example in a cross-compilation setting.</span>
 #
 # See https://doc.rust-lang.org/rustc/codegen-options/index.html#linker for more information.
 #default-linker = &lt;none&gt; (path)
modified   src/bootstrap/compile.rs
<span class="gu">@@ -661,6 +661,8 @@ pub fn rustc_cargo_env(builder: &amp;Builder&lt;'_&gt;, cargo: &amp;mut Cargo, target: TargetS</span>
         .env("CFG_VERSION", builder.rust_version());

     let libdir_relative = builder.config.libdir_relative().unwrap_or_else(|| Path::new("lib"));
<span class="gi">+    let target_config = builder.config.target_config.get(&amp;target);</span>
<span class="gi">+</span>
     cargo.env("CFG_LIBDIR_RELATIVE", libdir_relative);

     if let Some(ref ver_date) = builder.rust_info.commit_date() {
<span class="gu">@@ -672,9 +674,15 @@ pub fn rustc_cargo_env(builder: &amp;Builder&lt;'_&gt;, cargo: &amp;mut Cargo, target: TargetS</span>
     if !builder.unstable_features() {
         cargo.env("CFG_DISABLE_UNSTABLE_FEATURES", "1");
     }
<span class="gd">-    if let Some(ref s) = builder.config.rustc_default_linker {</span>
<span class="gi">+</span>
<span class="gi">+    // Prefer the current target's own default_linker, else a globally</span>
<span class="gi">+    // specified one.</span>
<span class="gi">+    if let Some(s) = target_config.and_then(|c| c.default_linker.as_ref()) {</span>
<span class="gi">+        cargo.env("CFG_DEFAULT_LINKER", s);</span>
<span class="gi">+    } else if let Some(ref s) = builder.config.rustc_default_linker {</span>
         cargo.env("CFG_DEFAULT_LINKER", s);
     }
<span class="gi">+</span>
     if builder.config.rustc_parallel {
         cargo.rustflag("--cfg=parallel_compiler");
         cargo.rustdocflag("--cfg=parallel_compiler");
<span class="gu">@@ -699,7 +707,6 @@ pub fn rustc_cargo_env(builder: &amp;Builder&lt;'_&gt;, cargo: &amp;mut Cargo, target: TargetS</span>
         }
         let llvm_config = builder.ensure(native::Llvm { target });
         cargo.env("LLVM_CONFIG", &amp;llvm_config);
<span class="gd">-        let target_config = builder.config.target_config.get(&amp;target);</span>
         if let Some(s) = target_config.and_then(|c| c.llvm_config.as_ref()) {
             cargo.env("CFG_LLVM_ROOT", s);
         }
modified   src/bootstrap/config.rs
<span class="gu">@@ -294,6 +294,7 @@ pub struct Target {</span>
     pub cxx: Option&lt;PathBuf&gt;,
     pub ar: Option&lt;PathBuf&gt;,
     pub ranlib: Option&lt;PathBuf&gt;,
<span class="gi">+    pub default_linker: Option&lt;PathBuf&gt;,</span>
     pub linker: Option&lt;PathBuf&gt;,
     pub ndk: Option&lt;PathBuf&gt;,
     pub sanitizers: Option&lt;bool&gt;,
</code></pre></div>
<p>(untested)</p>



<a name="263072726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263072726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263072726">(Nov 29 2021 at 21:54)</a>:</h4>
<p>And yes, you're correct on how it's used (though given we self bootstrap there's probably some overlap if you don't set both on the second compilation)</p>



<a name="263074365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263074365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263074365">(Nov 29 2021 at 22:09)</a>:</h4>
<p>oops: failed to parse TOML configuration 'config.toml': unknown field <code>default-linker</code>, expected one of <code>cc</code>, <code>cxx</code>, <code>ar</code>, <code>ranlib</code>, <code>linker</code>, <code>llvm-config</code>, <code>llvm-filecheck</code>, <code>android-ndk</code>, <code>sanitizers</code>, <code>profiler</code>, <code>crt-static</code>, <code>musl-root</code>, <code>musl-libdir</code>, <code>wasi-root</code>, <code>qemu-rootfs</code>, <code>no-std</code> for key <code>target.x86_64-unknown-linux-gnu</code> at line 29 column 1`  <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="263074495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263074495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263074495">(Nov 29 2021 at 22:10)</a>:</h4>
<p>seems I need to register it elsewhere</p>



<a name="263075224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263075224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263075224">(Nov 29 2021 at 22:16)</a>:</h4>
<p>looks like it's just validating the fields of the Target struct.</p>



<a name="263076170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263076170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263076170">(Nov 29 2021 at 22:24)</a>:</h4>
<p>I think I need to register it in TomlTarget as well</p>



<a name="263076875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263076875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263076875">(Nov 29 2021 at 22:31)</a>:</h4>
<p>Ah yeah</p>



<a name="263077025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263077025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263077025">(Nov 29 2021 at 22:33)</a>:</h4>
<p>seems to work better now</p>



<a name="263077035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263077035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263077035">(Nov 29 2021 at 22:33)</a>:</h4>
<p>but I'll need the same thing for jemalloc I think</p>



<a name="263077222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263077222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263077222">(Nov 29 2021 at 22:35)</a>:</h4>
<p>that one seems handled by a crate or something... hmm</p>



<a name="263078005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263078005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263078005">(Nov 29 2021 at 22:43)</a>:</h4>
<p>I'll try disabling jemalloc first</p>



<a name="263080091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263080091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263080091">(Nov 29 2021 at 23:04)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <a href="https://github.com/rust-lang/rust/pull/91375">https://github.com/rust-lang/rust/pull/91375</a></p>



<a name="263092889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263092889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263092889">(Nov 30 2021 at 01:48)</a>:</h4>
<p>oh! Looking at the binary outputs (rustc/cargo) produced by the cross-compilation; I see rustc and cargo are under build/x86_64-unknown-linux-gnu.  IIUC, what I just built is a compiler capable to run on x86_64 to produce i686 executables.  Is this correct?</p>



<a name="263094229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263094229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263094229">(Nov 30 2021 at 02:12)</a>:</h4>
<p>how would I go about not only targetting i686 for the binaries built by the compiler, but for the platform on which the compiler runs?  I'd need to use --host instead of --target, right? Does x.py support --host?</p>



<a name="263094253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263094253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263094253">(Nov 30 2021 at 02:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263060957">said</a>:</p>
<blockquote>
<p>that'd greatly increase tho amount of things required to carry in the environment though (a cross GCC for each architecture to build for,  and also the target libs used from the system (openssl, libssh2, libcurl, llvm).  It's nice that it's possible though.</p>
</blockquote>
<p>If you're going to build host tools for a given target, you need a build of LLVM for that target, which does mean you need a compiler for that target.</p>



<a name="263094276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263094276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263094276">(Nov 30 2021 at 02:13)</a>:</h4>
<p>Though if you want to minimize your bootstrap set, clang only needs to get built <em>once</em> to give you a cross-compiler for all of its targets.</p>



<a name="263094473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263094473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263094473">(Nov 30 2021 at 02:16)</a>:</h4>
<p>OK.  I'm on Guix, so I'd expect GCC to be well supported (already built) for each of the 6 platforms currently supported (armhf-linux, aarch64-linux, powerpc64le, i686-linux, x86_64-linux and i586-gnu), but I'll keep this in mind in case I encounter problems.</p>



<a name="263094528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263094528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263094528">(Nov 30 2021 at 02:17)</a>:</h4>
<p>/me substitutes --target for --host</p>



<a name="263095291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263095291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263095291">(Nov 30 2021 at 02:32)</a>:</h4>
<p>interesting: <code>run pkg_config fail: "Cross compilation detected. Use PKG_CONFIG_ALLOW_CROSS=1 to override"</code> while building with --host=i686-unknown-linux-gnu on the same x86_64 build machine</p>



<a name="263095311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263095311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263095311">(Nov 30 2021 at 02:33)</a>:</h4>
<p>Is it safe to set that environment variable?</p>



<a name="263102051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263102051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263102051">(Nov 30 2021 at 04:59)</a>:</h4>
<p>strange, I have <code>docs = false</code> in config.toml, but doc was generated anyway</p>



<a name="263103553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263103553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263103553">(Nov 30 2021 at 05:31)</a>:</h4>
<p>Also, why is there no ELF32 produced <code>rustc</code> build artifact when running <code>./x.py build --stage=2 --host=i686-unknown-linux-gnu compiler/rustc src/tools/cargo src/tools/rustfmt</code> ?</p>



<a name="263106292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263106292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263106292">(Nov 30 2021 at 06:31)</a>:</h4>
<p>Hmm.  Seems rustc is not build for --host=i686-linux... but for x86_64: <a href="https://paste.debian.net/1221307/">https://paste.debian.net/1221307/</a></p>



<a name="263106300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263106300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263106300">(Nov 30 2021 at 06:31)</a>:</h4>
<p>cargo and the other tools appear to be built correctly though</p>



<a name="263106369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263106369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263106369">(Nov 30 2021 at 06:32)</a>:</h4>
<p>the command ran was something like <code>./x.py build --stage=2 --host=i686-unknown-linux-gnu --target=i686-unknown-linux-gnu \
   library/std src/tools/cargo src/tools/rustfmt</code></p>



<a name="263108111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263108111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263108111">(Nov 30 2021 at 07:10)</a>:</h4>
<p>You need to add compiler/rustc to that command I think.</p>



<a name="263140090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263140090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263140090">(Nov 30 2021 at 13:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263108111">said</a>:</p>
<blockquote>
<p>You need to add compiler/rustc to that command I think.</p>
</blockquote>
<p>Thank you!  Now I have:</p>
<div class="codehilite"><pre><span></span><code>file ./build/i686-unknown-linux-gnu/stage2/bin/rustc
./build/i686-unknown-linux-gnu/stage2/bin/rustc: ELF 32-bit LSB pie executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/ld-linux.so.2, for GNU/Linux 2.6.32, with debug_info, not stripped
</code></pre></div>
<p>:-)</p>



<a name="263143908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263143908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263143908">(Nov 30 2021 at 13:30)</a>:</h4>
<p>ah, no sorry, my previous rustc must have been built by my experiments (./x.py dist)</p>



<a name="263144220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263144220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263144220">(Nov 30 2021 at 13:33)</a>:</h4>
<p>seems <code>x.py build</code> doesn't generate the cross-built build results but x.py install or dist do, IIUC.</p>



<a name="263145718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263145718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263145718">(Nov 30 2021 at 13:44)</a>:</h4>
<p>it'd be neat if <code>x.py install</code> had a --prefix, or alternatively -C prefix=/my/prefix</p>



<a name="263145926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263145926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263145926">(Nov 30 2021 at 13:46)</a>:</h4>
<p>You can specify a prefix in config.toml - it doesn't seem like the kind of thing you're constantly expecting to change?</p>



<a name="263147180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263147180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263147180">(Nov 30 2021 at 13:54)</a>:</h4>
<p>in guix we are so far installing the compilers and tools to different package "outputs", which have different prefixes</p>



<a name="263147215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263147215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263147215">(Nov 30 2021 at 13:55)</a>:</h4>
<p>so currently we hack the config.toml file; call install, hack it again, call install on another target, etc.</p>



<a name="263147281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263147281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263147281">(Nov 30 2021 at 13:55)</a>:</h4>
<p>we may drop these prefixes or reduce them in the future to just an extra "tools" output, but we'd still have a need for 2 prefixes</p>



<a name="263147885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263147885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263147885">(Nov 30 2021 at 13:59)</a>:</h4>
<p>alternatively if <code>x.py build</code> could 'assemble' the cross-compiler, that'd be nice (it doesn't produce the target compiler; only 'dist' or 'install' do)</p>



<a name="263147984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263147984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263147984">(Nov 30 2021 at 14:00)</a>:</h4>
<p>that way I could do the installation of the few files manually</p>



<a name="263148549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263148549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263148549">(Nov 30 2021 at 14:03)</a>:</h4>
<p>x.py build should be assembling the compiler as of fairly recently, I think</p>



<a name="263149112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263149112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263149112">(Nov 30 2021 at 14:07)</a>:</h4>
<p>OK; I'm on 1.54 for now</p>



<a name="263152079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263152079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263152079">(Nov 30 2021 at 14:26)</a>:</h4>
<p>Yeah, I think this patch landed, like, 1.58?</p>



<a name="263152117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263152117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263152117">(Nov 30 2021 at 14:26)</a>:</h4>
<p>just recently yeah, maybe 3 weeks ago</p>



<a name="263162601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263162601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263162601">(Nov 30 2021 at 15:39)</a>:</h4>
<p>so, the cross-built rustc seems to be OK (tested on a Debian 10 32-bit VM); but cargo seems linked incorrectly to a ELF64 libz</p>



<a name="263162819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263162819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263162819">(Nov 30 2021 at 15:41)</a>:</h4>
<p>this is what I see: </p>
<div class="codehilite"><pre><span></span><code>$ /gnu/store/vhfdxbxla54n56qggv975c39vyaa0z91-rust-i686-linux-1.54.0-cargo/bin/cargo --help
/gnu/store/vhfdxbxla54n56qggv975c39vyaa0z91-rust-i686-linux-1.54.0-cargo/bin/cargo: error while loading shared libraries: libz.so: wrong ELF class: ELFCLASS64
user@debian:~/Desktop$ /gnu/store/vhfdxbxla54n56qggv975c39vyaa0z91-rust-i686-linux-1.54.0-cargo/bin/cargo --version
/gnu/store/vhfdxbxla54n56qggv975c39vyaa0z91-rust-i686-linux-1.54.0-cargo/bin/cargo: error while loading shared libraries: libz.so: wrong ELF class: ELFCLASS64
user@debian:~/Desktop$ ldd /gnu/store/vhfdxbxla54n56qggv975c39vyaa0z91-rust-i686-linux-1.54.0-cargo/bin/cargo
    linux-gate.so.1 (0xb7f22000)
    libz.so =&gt; not found
    libcurl.so.4 =&gt; not found
    libssl.so.1.1 =&gt; /lib/i386-linux-gnu/libssl.so.1.1 (0xb71ae000)
    libcrypto.so.1.1 =&gt; /lib/i386-linux-gnu/libcrypto.so.1.1 (0xb6eeb000)
    libgcc_s.so.1 =&gt; /gnu/store/x5y2ngh1asiv3dkcbzaga9ml56xcm3ps-gcc-cross-i686-linux-gnu-10.3.0-lib/lib/gcc/i686-linux-gnu/10.3.0/../../../../i686-linux-gnu/lib/libgcc_s.so.1 (0xb6ecb000)
    libpthread.so.0 =&gt; /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/libpthread.so.0 (0xb6eaa000)
    libm.so.6 =&gt; /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/libm.so.6 (0xb6da8000)
    libdl.so.2 =&gt; /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/libdl.so.2 (0xb6da0000)
    libc.so.6 =&gt; /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/libc.so.6 (0xb6bb0000)
    /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/ld-linux.so.2 =&gt; /lib/ld-linux.so.2 (0xb7f24000)
</code></pre></div>



<a name="263163107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263163107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263163107">(Nov 30 2021 at 15:43)</a>:</h4>
<p>perhaps pkg-config stumbled; there should be both x86_64 and cross-i686 versions of these libs in the build environment</p>



<a name="263164387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263164387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263164387">(Nov 30 2021 at 15:53)</a>:</h4>
<p>can default-linker be made to point to ld instead of gcc?</p>



<a name="263164547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263164547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263164547">(Nov 30 2021 at 15:54)</a>:</h4>
<p>/me tries</p>



<a name="263168806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263168806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263168806">(Nov 30 2021 at 16:21)</a>:</h4>
<p>No, rustc doesn't know about all the flags it need to pass to ld to produce a working linux executable. It doesn't pass the crt objects, and doesn't pass any of the other required flags.</p>



<a name="263169032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263169032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263169032">(Nov 30 2021 at 16:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263168806">said</a>:</p>
<blockquote>
<p>No, rustc doesn't know about all the flags it need to pass to ld to produce a working linux executable. It doesn't pass the crt objects, and doesn't pass any of the other required flags.</p>
</blockquote>
<p><a href="https://github.com/rust-lang/rust/issues/11937">https://github.com/rust-lang/rust/issues/11937</a></p>



<a name="263170265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263170265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263170265">(Nov 30 2021 at 16:31)</a>:</h4>
<p>would using lld instead of ld change any of this?</p>



<a name="263170326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263170326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263170326">(Nov 30 2021 at 16:31)</a>:</h4>
<p>otherwise my next option is statically link things</p>



<a name="263170421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263170421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263170421">(Nov 30 2021 at 16:32)</a>:</h4>
<p>using LLD would not help, no, it still needs to have the CRT objects</p>



<a name="263184590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263184590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263184590">(Nov 30 2021 at 18:06)</a>:</h4>
<p>Hmm, the rpath entries are wrong in the cargo binary:</p>
<div class="codehilite"><pre><span></span><code> 0x0000001d (RUNPATH)                    Library runpath: [$ORIGIN/../lib:/gnu/store/2i0zpa5w320y8m4zbqk1va8vs6dbawv0-zlib-1.2.11/lib:/gnu/store/6r82375s1fx3363k6wk5f16z8xvwzmj0-curl-7.79.1/lib:/gnu/store/cs1kihs34ccqhc69yx0c4kaf3rkiwyyy-openssl-1.1.1l/lib:/gnu/store/x5y2ngh1asiv3dkcbzaga9ml56xcm3ps-gcc-cross-i686-linux-gnu-10.3.0-lib/lib/gcc/i686-linux-gnu/10.3.0/../../../../i686-linux-gnu/lib:/gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib]
</code></pre></div>
<p>The zlib, curl and openssl paths are the native ones (build machine -- x86_64)</p>



<a name="263186405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263186405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263186405">(Nov 30 2021 at 18:20)</a>:</h4>
<p>Is there a guix linker wrapper that adds the rpath?</p>



<a name="263189671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263189671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263189671">(Nov 30 2021 at 18:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263186405">said</a>:</p>
<blockquote>
<p>Is there a guix linker wrapper that adds the rpath?</p>
</blockquote>
<p>yes, ld-wrapper; but I have it only as a native input (x86_64) for now.  rpath = true is also set in config.toml</p>



<a name="263189805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263189805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263189805">(Nov 30 2021 at 18:45)</a>:</h4>
<p>gcc picks ld from PATH, I believe.  So it may well be that this wrong-arch ld gets used for the i686 cross build</p>



<a name="263189959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263189959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263189959">(Nov 30 2021 at 18:46)</a>:</h4>
<p>since I can only specify <code>gcc</code> as the linker, not <code>ld</code> directly, I'm not sure how to get around this.  I guess I'll have to make a wrapper script for <code>gcc</code> that adds the correct ld to PATH.</p>



<a name="263190097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263190097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263190097">(Nov 30 2021 at 18:47)</a>:</h4>
<p>you can tell gcc to use <code>ld-wrapper</code> instead of <code>ld</code> I think</p>



<a name="263190109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263190109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263190109">(Nov 30 2021 at 18:47)</a>:</h4>
<p>there's some flag, <code>-fuse-linker</code> maybe</p>



<a name="263190193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263190193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263190193">(Nov 30 2021 at 18:48)</a>:</h4>
<p>and you should be able to tell bootstrap to pass along custom link flags, you don't need a shell script for it</p>



<a name="263190331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263190331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263190331">(Nov 30 2021 at 18:49)</a>:</h4>
<p><code>-fuse-ld</code>. There are some restrictions around what it accepts though. There is also an arg to specify in which dir to look for external tools like the linker. <code>-B</code> I think?</p>



<a name="263190867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263190867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263190867">(Nov 30 2021 at 18:53)</a>:</h4>
<p>Neat! thanks for the ideas</p>



<a name="263193027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263193027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263193027">(Nov 30 2021 at 19:06)</a>:</h4>
<p>-fuse-ld takes a file name to be found on PATH I guess (rather than an absolute path?)</p>



<a name="263193953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263193953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263193953">(Nov 30 2021 at 19:13)</a>:</h4>
<p>oh yeah gcc's version of this is very strange</p>



<a name="263193974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263193974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263193974">(Nov 30 2021 at 19:13)</a>:</h4>
<p>clang just takes an absolute file path the way god intended</p>



<a name="263196224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263196224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263196224">(Nov 30 2021 at 19:30)</a>:</h4>
<p>eh</p>



<a name="263207837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263207837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263207837">(Nov 30 2021 at 21:00)</a>:</h4>
<p>I got a educated a bit about how GCC looks up linkers in #gcc on <a href="http://libera.chat">libera.chat</a>.  Copying here:</p>
<div class="codehilite"><pre><span></span><code>it doesn&#39;t just look it up in PATH. -fuse-ld=gold makes it use ld.gold for a start, not &quot;gold&quot;
and it almost certainly looks for it in locations specified with -B and/or $GCC_EXEC_PREFIX as described in the manual
there&#39;s more logic behind those options than just finding an executable in PATH, because different options might need to be passed to the linker depending on which one you use
</code></pre></div>



<a name="263208001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263208001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263208001">(Nov 30 2021 at 21:00)</a>:</h4>
<p>so indeed -B looks like a good candidate for my use case!</p>



<a name="263208498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263208498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263208498">(Nov 30 2021 at 21:04)</a>:</h4>
<p>I don't see link options in config.toml.example though</p>



<a name="263208995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263208995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263208995">(Nov 30 2021 at 21:08)</a>:</h4>
<p>only llvm has support for ldflags it seems</p>



<a name="263209100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263209100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263209100">(Nov 30 2021 at 21:09)</a>:</h4>
<p>/me tries an ugly hack: gold for the build mathine, cross-compiled ld for the target</p>



<a name="263231802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263231802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263231802">(Dec 01 2021 at 01:02)</a>:</h4>
<p>Is there some environment variable I can set to get rustc/cargo to print all the low level GCC commands it invokes?</p>



<a name="263233262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263233262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263233262">(Dec 01 2021 at 01:22)</a>:</h4>
<p>Otherwise I'm trying to find in the source what/where is responsible for linking the cargo binary with libssh2, libcurl and openssl</p>



<a name="263235110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263235110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263235110">(Dec 01 2021 at 01:51)</a>:</h4>
<p>Ah!  Pretty sure my error is caused by my usage of PKG_CONFIG_ALLOW_CROSS:</p>
<blockquote>
<p>PKG_CONFIG_ALLOW_CROSS - The pkg-config command usually doesn't support cross-compilation, and this crate prevents it from selecting incompatible versions of libraries. Setting PKG_CONFIG_ALLOW_CROSS=1 disables this protection, which is likely to cause linking errors, unless pkg-config has been configured to use appropriate sysroot and search paths for the target platform.</p>
</blockquote>



<a name="263237202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263237202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263237202">(Dec 01 2021 at 02:27)</a>:</h4>
<p>At least for openssl-sys I can set <code>I686_UNKNOWN_LINUX_GNU_OPENSSL_DIR</code></p>



<a name="263241743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263241743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263241743">(Dec 01 2021 at 03:58)</a>:</h4>
<p>That allowed cargo to be linked correctly to openssl, and the build passed</p>



<a name="263241783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263241783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263241783">(Dec 01 2021 at 03:59)</a>:</h4>
<p>I built <a href="http://hello.rs">hello.rs</a> with the cross compiled rustc; running it works but it took 47 s.  Eh?</p>



<a name="263257210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263257210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263257210">(Dec 01 2021 at 08:23)</a>:</h4>
<p>Can you get a profile to see where it takes so much time?</p>



<a name="263284916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263284916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263284916">(Dec 01 2021 at 12:56)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> how can I gather such profile?</p>



<a name="263297746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263297746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263297746">(Dec 01 2021 at 14:25)</a>:</h4>
<p>You can try <code>perf record --call-graph dwarf</code> and then <code>perf report --no-inline</code> to get a tui or <code>perf script --no-inline &gt; profile.perf</code> and then open the profile using eg &lt;<a href="https://speedscope.app">https://speedscope.app</a>&gt;. (the <code>--no-inline</code> significantly improves time to process a profile)</p>



<a name="263324597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263324597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263324597">(Dec 01 2021 at 17:18)</a>:</h4>
<p><span class="user-mention" data-user-id="437426">@apteryx</span> It took 47s to compile <a href="http://hello.rs">hello.rs</a>, or to run it?</p>



<a name="263324654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263324654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263324654">(Dec 01 2021 at 17:18)</a>:</h4>
<p>to run it; compiling it was quick</p>



<a name="263338325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263338325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263338325">(Dec 01 2021 at 18:50)</a>:</h4>
<p>hmm, that debian VM doesn't seem to have the required tooling/configuration: Kernel address maps (/proc/{kallsyms,modules}) were restricted.</p>



<a name="263338383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263338383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263338383">(Dec 01 2021 at 18:50)</a>:</h4>
<p>upon invoking <code>sudo perf report --no-inline</code></p>



<a name="263338431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263338431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263338431">(Dec 01 2021 at 18:51)</a>:</h4>
<p>(with <code>sudo perf record --call-graph dwarf &amp;</code> running in the background)</p>



<a name="263338619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263338619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263338619">(Dec 01 2021 at 18:52)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ time rustc hello.rs

real    0m2.375s
user    0m1.144s
sys 0m1.283s

$ file hello
hello: ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, BuildID[sha1]=5458fb195357d02ff6de3d429201d69c16f03e1b, for GNU/Linux 2.6.32, with debug_info, not stripped

user@debian:~/Desktop$ time ./hello
Hello World!

real    0m50.931s
user    0m50.916s
sys 0m0.012s
</code></pre></div>



<a name="263339342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263339342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263339342">(Dec 01 2021 at 18:56)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ strace -f -s300 ./hello

[...]
openat(AT_FDCWD, &quot;/gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libpthread.so.0&quot;, O_RDONLY|O_LARGEFILE|O_CLOEXEC) = 3
read(3, &quot;\177ELF\1\1\1\0\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0\0\\\0\0004\0\0\0\24\271\22\0\0\0\0\0004\0 \0\f\0(\0+\0*\0\6\0\0\0004\0\0\0004\0\0\0004\0\0\0\200\1\0\0\200\1\0\0\4\0\0\0\4\0\0\0\3\0\0\0\300b\1\0\300b\1\0\300b\1\0^\0\0\0^\0\0\0\4\0\0\0 \0\0\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\310C\0\0\310C\0\0\4\0\0\0\0\20\0\0\1\0\0\0\0P\0\0\0P\0\0\0P\0\0\r\364\0\0\r\364\0\0\5\0\0\0\0\20\0\0\1\0\0\0\0P\1\0\0P\1\0\0P\1\0\360x\0\0\360x\0\0\4\0\0\0\0\20\0\0\1\0\0\0,\316\1\0,\336\1\0,\336\1\0L\3\0\0\10$\0\0\6\0\0\0\0\20\0\0\2\0\0\0\270\316\1\0\270\336\1\0\270\336\1\0\10\1\0\0\10\1\0\0\6\0\0\0\4\0\0\0\4\0\0\0\264\1\0\0\264\1\0\0\264\1\0\0T\0\0\0T\0\0\0&quot;..., 512) = 512
_llseek(3, 436, [436], SEEK_SET)        = 0
read(3, &quot;\4\0\0\0\20\0\0\0\1\0\0\0GNU\0\0\0\0\0\2\0\0\0\6\0\0\0 \0\0\0\4\0\0\0$\0\0\0\5\0\0\0GNU\0\2\200\0\300\4\0\0\0\1\0\0\0\1\0\1\300\4\0\0\0\1\0\0\0\2\0\1\300\4\0\0\0\1\0\0\0&quot;, 84) = 84
fstat64(3, {st_mode=S_IFREG|0555, st_size=1228748, ...}) = 0
mmap2(NULL, 131636, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xb7f3f000
mmap2(0xb7f44000, 65536, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x5000) = 0xb7f44000
mmap2(0xb7f54000, 32768, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x15000) = 0xb7f54000
mmap2(0xb7f5c000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1c000) = 0xb7f5c000
mmap2(0xb7f5e000, 4660, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xb7f5e000
close(3)                                = 0
openat(AT_FDCWD, &quot;/gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libdl.so.2&quot;, O_RDONLY|O_LARGEFILE|O_CLOEXEC) = 3
read(3, &quot;\177ELF\1\1\1\0\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0000\21\0\0004\0\0\0\2744\2\0\0\0\0\0004\0 \0\n\0(\0(\0&#39;\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\4\n\0\0\4\n\0\0\4\0\0\0\0\20\0\0\1\0\0\0\0\20\0\0\0\20\0\0\0\20\0\0-\22\0\0-\22\0\0\5\0\0\0\0\20\0\0\1\0\0\0\0000\0\0\0000\0\0\0000\0\0\340\v\0\0\340\v\0\0\4\0\0\0\0\20\0\0\1\0\0\0\260&gt;\0\0\260N\0\0\260N\0\0\220\1\0\0\304\1\0\0\6\0\0\0\0\20\0\0\2\0\0\0\310&gt;\0\0\310N\0\0\310N\0\0\10\1\0\0\10\1\0\0\6\0\0\0\4\0\0\0\4\0\0\0t\1\0\0t\1\0\0t\1\0\0T\0\0\0T\0\0\0\4\0\0\0\4\0\0\0S\345td\224\1\0\0\224\1\0\0\224\1\0\0004\0\0\0004\0\0\0\4\0\0\0\4\0\0\0P\345td\2440\0\0\2440\0\0\2440\0\0\354\0\0\0\354\0\0\0&quot;..., 512) = 512
fstat64(3, {st_mode=S_IFREG|0555, st_size=146172, ...}) = 0
mmap2(NULL, 20596, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xb7f39000
mmap2(0xb7f3a000, 8192, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1000) = 0xb7f3a000
mmap2(0xb7f3c000, 4096, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x3000) = 0xb7f3c000
mmap2(0xb7f3d000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x3000) = 0xb7f3d000
close(3)                                = 0
openat(AT_FDCWD, &quot;/gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libc.so.6&quot;, O_RDONLY|O_LARGEFILE|O_CLOEXEC) = 3
read(3, &quot;\177ELF\1\1\1\3\0\0\0\0\0\0\0\0\3\0\3\0\1\0\0\0\240\272\1\0004\0\0\0\334L\277\0\0\0\0\0004\0 \0\r\0(\0D\0C\0\6\0\0\0004\0\0\0004\0\0\0004\0\0\0\240\1\0\0\240\1\0\0\4\0\0\0\4\0\0\0\3\0\0\0`\371\30\0`\371\30\0`\371\30\0^\0\0\0^\0\0\0\4\0\0\0 \0\0\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0H\221\1\0H\221\1\0\4\0\0\0\0\20\0\0\1\0\0\0\0\240\1\0\0\240\1\0\0\240\1\0B\0\25\0B\0\25\0\5\0\0\0\0\20\0\0\1\0\0\0\0\260\26\0\0\260\26\0\0\260\26\0\244\214\7\0\244\214\7\0\4\0\0\0\0\20\0\0\1\0\0\0\234B\36\0\234R\36\0\234R\36\0\370+\0\0\360\245\0\0\6\0\0\0\0\20\0\0\2\0\0\0l]\36\0lm\36\0lm\36\0\350\0\0\0\350\0\0\0\6\0\0\0\4\0\0\0\4\0\0\0\324\1\0\0\324\1\0\0\324\1\0\0T\0\0\0T\0\0\0&quot;..., 512) = 512
_llseek(3, 468, [468], SEEK_SET)        = 0
read(3, &quot;\4\0\0\0\20\0\0\0\1\0\0\0GNU\0\0\0\0\0\2\0\0\0\6\0\0\0 \0\0\0\4\0\0\0$\0\0\0\5\0\0\0GNU\0\2\200\0\300\4\0\0\0\1\0\0\0\1\0\1\300\4\0\0\0\v\0\0\0\2\0\1\300\4\0\0\0\3\0\0\0&quot;, 84) = 84
fstat64(3, {st_mode=S_IFREG|0555, st_size=12539772, ...}) = 0
mmap2(NULL, 2029708, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0xb7d49000
mprotect(0xb7d63000, 1880064, PROT_NONE) = 0
mmap2(0xb7d63000, 1380352, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1a000) = 0xb7d63000
mmap2(0xb7eb4000, 495616, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x16b000) = 0xb7eb4000
mmap2(0xb7f2e000, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e4000) = 0xb7f2e000
mmap2(0xb7f31000, 30860, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0xb7f31000
close(3)                                = 0
mmap2(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7d47000
set_thread_area({entry_number=-1, base_addr=0xb7d47740, limit=0x0fffff, seg_32bit=1, contents=0, read_exec_only=0, limit_in_pages=1, seg_not_present=0, useable=1}) = 0 (entry_number=6)
mprotect(0xb7f2e000, 8192, PROT_READ)   = 0
mprotect(0xb7f3d000, 4096, PROT_READ)   = 0
mprotect(0xb7f5c000, 4096, PROT_READ)   = 0
mprotect(0xb7f7c000, 4096, PROT_READ)   = 0
mprotect(0x492000, 8192, PROT_READ)     = 0
mprotect(0xb7fc0000, 4096, PROT_READ)   = 0
munmap(0xb7f7e000, 76948)               = 0
set_tid_address(0xb7d477a8)             = 3908
set_robust_list(0xb7d477b0, 12)         = 0
rt_sigaction(SIGRTMIN, {sa_handler=0xb7f446e0, sa_mask=[], sa_flags=SA_RESTORER|SA_SIGINFO, sa_restorer=0xb7f50f60}, NULL, 8) = 0
rt_sigaction(SIGRT_1, {sa_handler=0xb7f44780, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART|SA_SIGINFO, sa_restorer=0xb7f50f60}, NULL, 8) = 0
rt_sigprocmask(SIG_UNBLOCK, [RTMIN RT_1], NULL, 8) = 0
ugetrlimit(RLIMIT_STACK, {rlim_cur=8192*1024, rlim_max=RLIM_INFINITY}) = 0

HANGS

poll([{fd=0, events=0}, {fd=1, events=0}, {fd=2, events=0}], 3, 0) = 0 (Timeout)
rt_sigaction(SIGPIPE, {sa_handler=SIG_IGN, sa_mask=[PIPE], sa_flags=SA_RESTORER|SA_RESTART, sa_restorer=0xb7d7a208}, {sa_handler=SIG_DFL, sa_mask=[], sa_flags=0}, 8) = 0
rt_sigaction(SIGSEGV, NULL, {sa_handler=SIG_DFL, sa_mask=[], sa_flags=0}, 8) = 0
rt_sigaction(SIGSEGV, {sa_handler=0x468f90, sa_mask=[], sa_flags=SA_RESTORER|SA_ONSTACK|SA_SIGINFO, sa_restorer=0xb7f50f60}, NULL, 8) = 0
rt_sigaction(SIGBUS, NULL, {sa_handler=SIG_DFL, sa_mask=[], sa_flags=0}, 8) = 0
rt_sigaction(SIGBUS, {sa_handler=0x468f90, sa_mask=[], sa_flags=SA_RESTORER|SA_ONSTACK|SA_SIGINFO, sa_restorer=0xb7f50f60}, NULL, 8) = 0
sigaltstack(NULL, {ss_sp=NULL, ss_flags=SS_DISABLE, ss_size=0}) = 0
mmap2(NULL, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7f8e000
mprotect(0xb7f8e000, 4096, PROT_NONE)   = 0
sigaltstack({ss_sp=0xb7f8f000, ss_flags=0, ss_size=8192}, NULL) = 0
mmap2(NULL, 1048576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb7c47000
openat(AT_FDCWD, &quot;/proc/self/maps&quot;, O_RDONLY|O_CLOEXEC) = 3
ugetrlimit(RLIMIT_STACK, {rlim_cur=8192*1024, rlim_max=RLIM_INFINITY}) = 0
statx(3, &quot;&quot;, AT_STATX_SYNC_AS_STAT|AT_NO_AUTOMOUNT|AT_EMPTY_PATH, STATX_BASIC_STATS, {stx_mask=STATX_BASIC_STATS, stx_attributes=0, stx_mode=S_IFREG|0444, stx_size=0, ...}) = 0
read(3, &quot;00444000-00446000 r--p 00000000 fe:01 403784     /home/user/Desktop/hello\n00446000-0047b000 r-xp 00002000 fe:01 403784     /home/user/Desktop/hello\n0047b000-00491000 r--p 00037000 fe:01 403784     /home/user/Desktop/hello\n00492000-00494000 r--p 0004d000 fe:01 403784     /home/user/Desktop/hello\n0049&quot;..., 1024) = 1024
read(3, &quot;    /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/libc-2.33.so\nb7f30000-b7f31000 rw-p 001e6000 fe:01 17949      /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/libc-2.33.so\nb7f31000-b7f39000 rw-p 00000000 00:00 0 \nb7f39000-b7f3a000 r-&quot;..., 1024) = 1024
read(3, &quot;00 fe:01 17981      /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/libpthread-2.33.so\nb7f44000-b7f54000 r-xp 00005000 fe:01 17981      /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/libpthread-2.33.so\nb7f54000-b7f5c000 r--p 00015000 f&quot;..., 1024) = 1024
read(3, &quot;f7d000 r--p 0001b000 fe:01 913933     /usr/lib/i386-linux-gnu/libgcc_s.so.1\nb7f7d000-b7f7e000 rw-p 0001c000 fe:01 913933     /usr/lib/i386-linux-gnu/libgcc_s.so.1\nb7f8e000-b7f8f000 ---p 00000000 00:00 0 \nb7f8f000-b7f93000 rw-p 00000000 00:00 0 \nb7f93000-b7f96000 r--p 00000000 00:00 0          [vvar]&quot;..., 1024) = 834
close(3)                                = 0
sched_getaffinity(3908, 32, [0, 1, 2, 3]) = 4
write(1, &quot;Hello World!\n&quot;, 13Hello World!
)          = 13
sigaltstack({ss_sp=NULL, ss_flags=SS_DISABLE, ss_size=8192}, NULL) = 0
munmap(0xb7f8e000, 12288)               = 0
exit_group(0)                           = ?
+++ exited with 0 +++
</code></pre></div>



<a name="263339918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263339918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263339918">(Dec 01 2021 at 19:00)</a>:</h4>
<p>Could you ctrl+z after a couple of seconds and then attach a debugger to get a backtrace? Or start it inside a debugger and then ctrl+c after a couple of seconds?</p>



<a name="263340123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263340123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263340123">(Dec 01 2021 at 19:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263338431">said</a>:</p>
<blockquote>
<p>(with <code>sudo perf record --call-graph dwarf &amp;</code> running in the background)</p>
</blockquote>
<p>I actually meant <code>sudo perf record --call-graph dwarf /path/to/hello_world</code>.</p>



<a name="263340884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263340884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263340884">(Dec 01 2021 at 19:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263340123">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263338431">said</a>:</p>
<blockquote>
<p>(with <code>sudo perf record --call-graph dwarf &amp;</code> running in the background)</p>
</blockquote>
<p>I actually meant <code>sudo perf record --call-graph dwarf /path/to/hello_world</code>.</p>
</blockquote>
<p>Ah, better: </p>
<div class="codehilite"><pre><span></span><code>Samples: 12K of event &#39;cycles&#39;, Event count (approx.): 85948101927
  Children      Self  Command  Shared Object       Symbol
+   88.62%     0.00%  hello    libpthread-2.33.so  [.] _init
+   88.62%    11.37%  hello    libpthread-2.33.so  [.] __pthread_initialize_minimal_internal
+   41.84%    34.58%  hello    libpthread-2.33.so  [.] __pthread_mutex_lock_full
+   35.37%    35.18%  hello    libpthread-2.33.so  [.] __pthread_mutex_lock
+   11.19%    11.16%  hello    libpthread-2.33.so  [.] __x86.get_pc_thunk.di
+    7.10%     7.02%  hello    libpthread-2.33.so  [.] __x86.get_pc_thunk.si
     0.59%     0.14%  hello    [kernel.kallsyms]   [k] apic_timer_interrupt
     0.45%     0.00%  hello    [kernel.kallsyms]   [k] smp_apic_timer_interrupt
     0.35%     0.00%  hello    [kernel.kallsyms]   [k] hrtimer_interrupt
     0.28%     0.02%  hello    [kernel.kallsyms]   [k] __hrtimer_run_queues
     0.25%     0.00%  hello    [kernel.kallsyms]   [k] tick_sched_timer
     0.19%     0.00%  hello    [kernel.kallsyms]   [k] tick_sched_handle
     0.19%     0.01%  hello    [kernel.kallsyms]   [k] update_process_times
     0.16%     0.00%  hello    [unknown]           [k] 0xf4a15ff8
     0.13%     0.01%  hello    [kernel.kallsyms]   [k] scheduler_tick
     0.05%     0.01%  hello    [kernel.kallsyms]   [k] irq_exit
     0.05%     0.00%  hello    [kernel.kallsyms]   [k] tick_sched_do_timer
     0.05%     0.00%  hello    [kernel.kallsyms]   [k] tick_do_update_jiffies64.part.12
     0.05%     0.05%  hello    [kernel.kallsyms]   [k] native_write_msr
     0.04%     0.00%  hello    [kernel.kallsyms]   [k] try_to_wake_up
     0.04%     0.04%  hello    [kernel.kallsyms]   [k] restore_all
     0.04%     0.00%  hello    [kernel.kallsyms]   [k] call_on_stack
     0.04%     0.00%  hello    [kernel.kallsyms]   [k] do_softirq_own_stack
     0.04%     0.01%  hello    [kernel.kallsyms]   [k] ktime_get_update_offsets_now
     0.04%     0.01%  hello    [kernel.kallsyms]   [k] perf_event_task_tick
     0.04%     0.01%  hello    [kernel.kallsyms]   [k] perf_pmu_disable.part.92
     0.04%     0.00%  hello    [kernel.kallsyms]   [k] irq_work_interrupt
     0.04%     0.00%  hello    [kernel.kallsyms]   [k] smp_irq_work_interrupt
</code></pre></div>



<a name="263341336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263341336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263341336">(Dec 01 2021 at 19:08)</a>:</h4>
<p><code>88.62% __pthread_initialize_minimal_internal</code> that is a lot of time spent inside mutex initialization. Same with mutex locking.</p>



<a name="263341407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263341407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263341407">(Dec 01 2021 at 19:09)</a>:</h4>
<p>From gdb:</p>
<div class="codehilite"><pre><span></span><code>$ gdb ./hello
GNU gdb (Debian 8.2.1-2+b3) 8.2.1
Copyright (C) 2018 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type &quot;show copying&quot; and &quot;show warranty&quot; for details.
This GDB was configured as &quot;i686-linux-gnu&quot;.
Type &quot;show configuration&quot; for configuration details.
For bug reporting instructions, please see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.
Find the GDB manual and other documentation resources online at:
    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.

For help, type &quot;help&quot;.
Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...
BFD: warning: /home/user/Desktop/hello: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0008002
Reading symbols from ./hello...done.
(gdb) run
Starting program: /home/user/Desktop/hello
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libpthread.so.0: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0008002
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libpthread.so.0: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010001
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libpthread.so.0: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010002
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libdl.so.2: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0008002
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libdl.so.2: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010001
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libdl.so.2: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010002
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libc.so.6: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0008002
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libc.so.6: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010001
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libc.so.6: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010002
warning: File &quot;/gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/libthread_db-1.0.so&quot; auto-loading has been declined by your `auto-load safe-path&#39; set to &quot;$debugdir:$datadir/auto-load&quot;.
To enable execution of this file add
    add-auto-load-safe-path /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/libthread_db-1.0.so
line to your configuration file &quot;/home/user/.gdbinit&quot;.
To completely disable this security protection add
    set auto-load safe-path /
line to your configuration file &quot;/home/user/.gdbinit&quot;.
For more information about this security protection see the
&quot;Auto-loading safe path&quot; section in the GDB manual.  E.g., run from the shell:
    info &quot;(gdb)Auto-loading safe path&quot;
warning: Unable to find libthread_db matching inferior&#39;s thread library, thread debugging will not be available.




^C
Program received signal SIGINT, Interrupt.
0xb7f859f0 in __pthread_mutex_lock_full (mutex=mutex@entry=0xb7fff584 &lt;_rtld_global+1348&gt;)
    at ../nptl/pthread_mutex_lock.c:599
599 ../nptl/pthread_mutex_lock.c: No such file or directory.
(gdb)
</code></pre></div>



<a name="263341508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263341508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263341508">(Dec 01 2021 at 19:10)</a>:</h4>
<p>hmm, I'll add /gnu/store to trusted paths and reprint the above</p>



<a name="263341720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263341720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263341720">(Dec 01 2021 at 19:11)</a>:</h4>
<p>The result is similar:</p>
<div class="codehilite"><pre><span></span><code>(gdb) set auto-load safe-path /
(gdb) run
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/user/Desktop/hello
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libpthread.so.0: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0008002
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libpthread.so.0: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010001
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libpthread.so.0: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010002
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libdl.so.2: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0008002
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libdl.so.2: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010001
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libdl.so.2: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010002
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libc.so.6: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0008002
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libc.so.6: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010001
BFD: warning: /gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libc.so.6: unsupported GNU_PROPERTY_TYPE (5) type: 0xc0010002
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib/../lib/libthread_db.so.1&quot;.
^C
Program received signal SIGINT, Interrupt.
0xb7f86003 in __GI___pthread_mutex_lock (mutex=0xb7fff584 &lt;_rtld_global+1348&gt;)
    at ../nptl/pthread_mutex_lock.c:71
71  ../nptl/pthread_mutex_lock.c: No such file or directory.
(gdb)
</code></pre></div>



<a name="263341849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263341849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263341849">(Dec 01 2021 at 19:12)</a>:</h4>
<p>Assuming that the master branch of glibc didn't move it around, in the first case you interrupted it at <a href="https://github.com/bminor/glibc/blob/d120fb9941be1fb1934f0b50c6ad64e4c5e404fb/nptl/pthread_mutex_lock.c#L599">https://github.com/bminor/glibc/blob/d120fb9941be1fb1934f0b50c6ad64e4c5e404fb/nptl/pthread_mutex_lock.c#L599</a> which is where the lock has been acquired.</p>



<a name="263341857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263341857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263341857">(Dec 01 2021 at 19:12)</a>:</h4>
<p>Seems ld.bfd is unhappy about something?</p>



<a name="263341957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263341957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263341957">(Dec 01 2021 at 19:12)</a>:</h4>
<p>That is not ld.bfd. Bfd is a library for handling many kinds of object files. ld.bfd is a linker based on bfd.</p>



<a name="263342008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263342008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263342008">(Dec 01 2021 at 19:13)</a>:</h4>
<p>Oh, I didn't know.  Thanks for the info.</p>



<a name="263342103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263342103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263342103">(Dec 01 2021 at 19:14)</a>:</h4>
<p>Something weird is definitively going on though. Initializing libpthreads and acquiring mutexes shouldn't take that much time.</p>



<a name="263342136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263342136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263342136">(Dec 01 2021 at 19:14)</a>:</h4>
<p>the linker is only used to link the binaries anyway, right?  it plays no part in the program execution?</p>



<a name="263342281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263342281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263342281">(Dec 01 2021 at 19:15)</a>:</h4>
<p>correct. there is a dynamic linker for loading dynamic libraries at runtime, but this is the <a href="http://ld-linux.so">ld-linux.so</a> that is part of your libc and not the linker you used to link the executable.</p>



<a name="263342356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263342356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263342356">(Dec 01 2021 at 19:15)</a>:</h4>
<p>neither glibc's nor musl's dynamic linker uses bfd. in this case the warning results from gdb's usage of bfd I think.</p>



<a name="263344092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263344092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263344092">(Dec 01 2021 at 19:26)</a>:</h4>
<p>OK; I was suggested by someone in Guix that in order to cut the dependency graph, the binary cross-built product would be uplodaded to <a href="http://ftp.gnu.org">ftp.gnu.org</a>, then it would be arranged for the <code>rust</code> package for i686-linux to correspond to that unpacked tarball.  But for this it would need to be linked statically.  Perhaps that will help to resolve this issue at the same time.  Is statically building rustc and its tools easy?</p>



<a name="263345382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263345382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263345382">(Dec 01 2021 at 19:33)</a>:</h4>
<p>I've heard glibc doesn't get linked statically though, at least not completely; is this true?</p>



<a name="263349004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263349004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263349004">(Dec 01 2021 at 19:57)</a>:</h4>
<p>You can link it statically with <code>+crt_static</code>, but if you have any uses of NSS (Name Service Switch) such as DNS resolution or user lookup, glibc will still dlopen NSS modules and break horribly if the ones on the system aren't compatible.</p>



<a name="263350924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263350924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263350924">(Dec 01 2021 at 20:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263349004">said</a>:</p>
<blockquote>
<p>You can link it statically with <code>+crt_static</code>, but if you have any uses of NSS (Name Service Switch) such as DNS resolution or user lookup, glibc will still dlopen NSS modules and break horribly if the ones on the system aren't compatible.</p>
</blockquote>
<p>I see.  Thanks for explaining!</p>



<a name="263354281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263354281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263354281">(Dec 01 2021 at 20:38)</a>:</h4>
<p>If you statically link rustc it won't be able to load proc macros as proc macros are currently implemented as dynamic libraries.</p>



<a name="263384660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263384660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263384660">(Dec 02 2021 at 02:01)</a>:</h4>
<p>Are proc macros a heavily relied-on feature or something that we can do without for the most part?</p>



<a name="263384991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263384991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263384991">(Dec 02 2021 at 02:07)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> is is still the case? I'm not so sure after reading <a href="https://github.com/rust-lang/rust/issues/45601">https://github.com/rust-lang/rust/issues/45601</a></p>



<a name="263386211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263386211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263386211">(Dec 02 2021 at 02:30)</a>:</h4>
<p>You will need proc-macros for almost any large rust codebase</p>



<a name="263386409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263386409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263386409">(Dec 02 2021 at 02:33)</a>:</h4>
<p>Also small ones, actually.</p>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263384660">said</a>:</p>
<blockquote>
<p>Are proc macros a heavily relied-on feature or something that we can do without for the most part?</p>
</blockquote>
<p>The main serialization/deserialization ecosystem for Rust is built around a proc macro.</p>



<a name="263386487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263386487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263386487">(Dec 02 2021 at 02:34)</a>:</h4>
<p>No proc macros means no serde, broadly, because it breaks <code>#[derive(Serialize, Deserialize)]</code>.</p>



<a name="263387077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263387077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263387077">(Dec 02 2021 at 02:46)</a>:</h4>
<p>would I be able to use a proc macro-less rustc as a bootstrap?</p>



<a name="263387195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263387195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263387195">(Dec 02 2021 at 02:48)</a>:</h4>
<p>Core is not allowed to use dependencies, but the compiler is, and as far as I know proc macros aren't off limits, so I believe we can only answer that based on whether or not proc macros are incidentally in the compiler's build graph, and the answer may change.</p>



<a name="263387426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263387426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263387426">(Dec 02 2021 at 02:52)</a>:</h4>
<p>The answer is no, rustc_macros has several proc macros</p>



<a name="263387468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263387468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jubilee <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263387468">(Dec 02 2021 at 02:54)</a>:</h4>
<p>Oh very no then. :D</p>



<a name="263388667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263388667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263388667">(Dec 02 2021 at 03:20)</a>:</h4>
<p>that's unfortunate :-/</p>



<a name="263388745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263388745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263388745">(Dec 02 2021 at 03:22)</a>:</h4>
<p>apparently we can't just take the cross-built rustc and inject it as a dependency for a i686-linux package in Guix (still clarifying why exactly); so the usual thing done when such a thing is needed is to build the cross package statically (self contained), pack it as a tarball, and offer this tarball as a bootstrap seed for the targeted architecture.</p>



<a name="263389183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263389183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263389183">(Dec 02 2021 at 03:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263387077">said</a>:</p>
<blockquote>
<p>would I be able to use a proc macro-less rustc as a bootstrap?</p>
</blockquote>
<p>Well, in theory you can replace all uses of proc macros in the compiler with the results of something like <code>cargo expand</code> and maybe some manual tweaking.<br>
It will be tedious, but may take less time than implementing proc macro support, and can produce some version of the compiler that can be temporarily used for bootstrapping.</p>



<a name="263390074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263390074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263390074">(Dec 02 2021 at 03:50)</a>:</h4>
<p>interesting ideas.  How are proc macros identified?  Are they easy to scan for?</p>



<a name="263390349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263390349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263390349">(Dec 02 2021 at 03:57)</a>:</h4>
<p>so this is the expected error after turning <code>crt-static = true</code> in the config.toml, correct (in this case, set both for the build and host targets).</p>
<div class="codehilite"><pre><span></span><code>error: cannot produce proc-macro for `merge_derive v0.1.0` as the target `x86_64-unknown-linux-gnu` does not support these crate types
</code></pre></div>



<a name="263390965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263390965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263390965">(Dec 02 2021 at 04:08)</a>:</h4>
<p>/me reads about proc-macros</p>



<a name="263391047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263391047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263391047">(Dec 02 2021 at 04:10)</a>:</h4>
<p>does <code>cargo expand</code> work at the level of a single file?</p>



<a name="263391396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263391396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263391396">(Dec 02 2021 at 04:19)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> that sounds a bit scary: <a href="https://github.com/dtolnay/cargo-expand#disclaimer">https://github.com/dtolnay/cargo-expand#disclaimer</a></p>



<a name="263393499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263393499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263393499">(Dec 02 2021 at 05:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263391047">said</a>:</p>
<blockquote>
<p>does <code>cargo expand</code> work at the level of a single file?</p>
</blockquote>
<p>No, at whole crate level only.</p>
<p><span class="user-mention silent" data-user-id="437426">apteryx</span> <a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo/near/263391396">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> that sounds a bit scary: <a href="https://github.com/dtolnay/cargo-expand#disclaimer">https://github.com/dtolnay/cargo-expand#disclaimer</a></p>
</blockquote>
<p>That's why I said "and maybe some manual tweaking".<br>
(Again, I didn't say this is necessarily a good idea, just a possibility.)</p>



<a name="263401986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263401986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263401986">(Dec 02 2021 at 07:41)</a>:</h4>
<p><code>cargo expand</code> actually does work on  both module and item level. You just need to pass the path.</p>



<a name="263437137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263437137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263437137">(Dec 02 2021 at 13:33)</a>:</h4>
<p>So the users of <code>proc-macro = true</code> crates would need to have their sources <code>cargo expanded</code>, right?</p>



<a name="263437279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263437279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263437279">(Dec 02 2021 at 13:34)</a>:</h4>
<p>and then after doing so I'd also need to set <code>proc-macro = false</code> in any proc-macro crate ?  Or would removing them work better?</p>



<a name="263438729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263438729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263438729">(Dec 02 2021 at 13:46)</a>:</h4>
<p>You will need to remove all proc-macro crate dependencies. Setting <code>proc-macro = false</code> will likely cause them to fail to compile.</p>



<a name="263439076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263439076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263439076">(Dec 02 2021 at 13:49)</a>:</h4>
<p>OK.  Apparently to use 'cargo expand' I need a "nightly" compiler.  What bulid option is needed to get such flavor built?  Currently I have a "release" flavor,  Ithink.</p>



<a name="263439479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263439479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263439479">(Dec 02 2021 at 13:52)</a>:</h4>
<p>If you use rustup you can use <code>cargo +nightly expand</code>. Otherwise you need to install a nightly version of the compiler.</p>



<a name="263441744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263441744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263441744">(Dec 02 2021 at 14:08)</a>:</h4>
<p>how can I build nightly from sources?</p>



<a name="263442049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263442049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263442049">(Dec 02 2021 at 14:10)</a>:</h4>
<p>this is the list of crates providing proc macros in the rust source tree:</p>
<div class="codehilite"><pre><span></span><code>$ ag -l &#39;proc-macro = true&#39; | grep .toml
compiler/rustc_macros/Cargo.toml
compiler/rustc_mir/src/transform/coverage/test_macros/Cargo.toml
library/stdarch/crates/assert-instr-macro/Cargo.toml
library/stdarch/crates/simd-test-macro/Cargo.toml
library/stdarch/crates/stdarch-verify/Cargo.toml
src/doc/book/listings/ch19-advanced-features/listing-19-31/hello_macro/hello_macro_derive/Cargo.toml
src/doc/book/listings/ch19-advanced-features/listing-19-33/hello_macro/hello_macro_derive/Cargo.toml
src/doc/book/listings/ch19-advanced-features/no-listing-21-pancakes/hello_macro/hello_macro_derive/Cargo.toml
src/tools/cargo/crates/cargo-test-macro/Cargo.toml
src/tools/cargo/src/cargo/util/toml/targets.rs
src/tools/miri/test-cargo-miri/issue-1760/Cargo.toml
src/tools/miri/test-cargo-miri/subcrate/Cargo.toml
src/tools/rust-analyzer/crates/proc_macro_test/Cargo.toml
src/tools/rustfmt/config_proc_macro/Cargo.toml
vendor/chalk-derive/Cargo.toml
vendor/chalk-derive-0.55.0/Cargo.toml
vendor/cstr/Cargo.toml
vendor/ctor/Cargo.toml
vendor/derive-new/Cargo.toml
vendor/derive_more/Cargo.toml
vendor/enum-iterator-derive/Cargo.toml
vendor/futures-macro/Cargo.toml
vendor/getset/Cargo.toml
vendor/jsonrpc-derive/Cargo.toml
vendor/merge_derive/Cargo.toml
vendor/paste-impl/Cargo.toml
vendor/pest_derive/Cargo.toml
vendor/proc-macro-error-attr/Cargo.toml
vendor/proc-macro-hack/Cargo.toml
vendor/rustc-ap-rustc_macros/Cargo.toml
vendor/rustversion/Cargo.toml
vendor/salsa-macros/Cargo.toml
vendor/serde_derive/Cargo.toml
vendor/serde_derive-1.0.125/Cargo.toml
vendor/serde_repr/Cargo.toml
vendor/serde_repr-0.1.6/Cargo.toml
vendor/structopt-derive/Cargo.toml
vendor/strum_macros/Cargo.toml
vendor/thiserror-impl/Cargo.toml
vendor/tokio-macros/Cargo.toml
vendor/tracing-attributes/Cargo.toml
vendor/tracing-attributes-0.1.13/Cargo.toml
vendor/xflags-macros/Cargo.toml
vendor/xshell-macros/Cargo.toml
</code></pre></div>



<a name="263442127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263442127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263442127">(Dec 02 2021 at 14:11)</a>:</h4>
<p>44 crates</p>



<a name="263442536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263442536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263442536">(Dec 02 2021 at 14:14)</a>:</h4>
<p>Maybe use the bootstrap compiler together with <code>RUSTC_BOOTSTRAP=1</code>?</p>



<a name="263443691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263443691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263443691">(Dec 02 2021 at 14:22)</a>:</h4>
<p>you mean the nightly flavor of the official bootstrap compiler binary?</p>



<a name="263443931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263443931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263443931">(Dec 02 2021 at 14:24)</a>:</h4>
<p>If you pass <code>RUSTC_BOOTSTRAP=1</code> the rustc used for bootstrapping will behave as if it is a nightly compiler, despite actually being a stable or beta compiler.</p>



<a name="263446015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263446015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263446015">(Dec 02 2021 at 14:38)</a>:</h4>
<p>interesting.  Is this documented?</p>



<a name="263452004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263452004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263452004">(Dec 02 2021 at 15:16)</a>:</h4>
<p>At <a href="https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#complications-of-bootstrapping">https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#complications-of-bootstrapping</a> It isn't guaranteed to work forever, but if you target a specific rustc version that isn't really a problem.</p>



<a name="263531742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263531742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263531742">(Dec 03 2021 at 03:27)</a>:</h4>
<p>I'm experimenting a bit more with this cross-compiled rustc on the 32-bit VM, and I've stumbled on this:</p>
<div class="codehilite"><pre><span></span><code>$ cargo install cargo-expand
    Updating crates.io index
error: could not execute process `rustc -vV` (never executed)

Caused by:
  Exec format error (os error 8)
</code></pre></div>



<a name="263531749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263531749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263531749">(Dec 03 2021 at 03:27)</a>:</h4>
<p>but:</p>
<div class="codehilite"><pre><span></span><code>$ rustc -vV
rustc 1.54.0
binary: rustc
commit-hash: unknown
commit-date: unknown
host: i686-unknown-linux-gnu
release: 1.54.0
LLVM version: 12.0.1
</code></pre></div>



<a name="263531824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263531824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263531824">(Dec 03 2021 at 03:29)</a>:</h4>
<p>strace shows this: <code>[pid  5614] execve("/gnu/store/rf5w7x769l7xdc2n7g153wnd00pvlm0s-rust-i686-linux-1.54.0/bin/rustc", ["rustc", "-vV"], 0xbfcfa444 /* 46 vars */) = -1 ENOEXEC (Exec format error)</code></p>



<a name="263531895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263531895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263531895">(Dec 03 2021 at 03:30)</a>:</h4>
<p>Invoking <code>rustc</code> from that absolute path works at the terminal</p>



<a name="263533486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263533486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263533486">(Dec 03 2021 at 04:03)</a>:</h4>
<p>ah nevermind, that's probably because rustc is wrapped in a shell script in Guix: </p>
<div class="codehilite"><pre><span></span><code>$ cat /gnu/store/rf5w7x769l7xdc2n7g153wnd00pvlm0s-rust-i686-linux-1.54.0/bin/rustc
#!/gnu/store/vx6vfbmmazvfi7vp8xyjn2mcyylvw9gn-bash-minimal-5.1.8/bin/bash
export PATH=&quot;/gnu/store/g58zxpycy64m790vwjlzpadmbn065fia-ld-wrapper-0/bin${PATH:+:}$PATH&quot;
export LIBRARY_PATH=&quot;$LIBRARY_PATH${LIBRARY_PATH+:}/gnu/store/miwzifnpn3lgzd6kvkcmz1i0hx7vvdfm-glibc-cross-i686-linux-gnu-2.33/lib&quot;
exec -a &quot;$0&quot; &quot;/gnu/store/rf5w7x769l7xdc2n7g153wnd00pvlm0s-rust-i686-linux-1.54.0/bin/.rustc-real&quot; &quot;$@&quot;
</code></pre></div>
<p>That's made so that the Guix-provided linker script is used when rustc links with shared libraries (so that runpaths get baked in the produced binary), and alsofor finding the libc startup files</p>



<a name="263533602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263533602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263533602">(Dec 03 2021 at 04:05)</a>:</h4>
<p>Oh: </p>
<div class="codehilite"><pre><span></span><code>$ file /gnu/store/vx6vfbmmazvfi7vp8xyjn2mcyylvw9gn-bash-minimal-5.1.8/bin/bash
/gnu/store/vx6vfbmmazvfi7vp8xyjn2mcyylvw9gn-bash-minimal-5.1.8/bin/bash: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /gnu/store/2fk1gz2s7ppdicynscra9b19byrrr866-glibc-2.33/lib/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, stripped
</code></pre></div>
<p>Well, that's one problem to fix.  I'll get rid of that wrapper for now.  It wouldn't cross-compile so I used some hack I thought would be OK, but apparently it isn't!</p>



<a name="263585056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263585056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263585056">(Dec 03 2021 at 14:13)</a>:</h4>
<p>Without the wrap script which had the erroneous shebang, and was also causing the built binary to use the guix-provided libc (but not its libgcc_s), it performs normally!</p>
<div class="codehilite"><pre><span></span><code>$ time ./hello
Hello World!

real    0m0.027s
user    0m0.011s
sys 0m0.019s
</code></pre></div>



<a name="263585113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263585113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263585113">(Dec 03 2021 at 14:13)</a>:</h4>
<p>I'm guessing the issue was the mixture of the Guix libc with the host <a href="http://libgcc_s.so">libgcc_s.so</a></p>



<a name="263585208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263585208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263585208">(Dec 03 2021 at 14:14)</a>:</h4>
<p>later I might try to have it use the <a href="http://libgcc_s.so">libgcc_s.so</a> from Guix as well as its libc (to not rely on the host), but for now it works!</p>



<a name="263585343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263585343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263585343">(Dec 03 2021 at 14:15)</a>:</h4>
<p>carefully looking at the strace output I had posted earlier is what allowed me to see this discrepancy in the origin of the used libc vs libgcc</p>



<a name="263588728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263588728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263588728">(Dec 03 2021 at 14:41)</a>:</h4>
<p>oh, and my gnome-boxes is running with <code>qemu-system-x86_64</code> although the Debian image is i686 32 bit... which probably explains why the x86_64 bash shebang didn't fail earlier when running <code>rustc</code> directly</p>



<a name="263588854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263588854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263588854">(Dec 03 2021 at 14:42)</a>:</h4>
<p>I'll try having it use qemu-system-i386 instead</p>



<a name="263597154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263597154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263597154">(Dec 03 2021 at 15:43)</a>:</h4>
<p>In GNOME Boxes XML editor, edited the &lt;emulator ...&gt; block to use qemu-system-i386; switched the os arch type to i686, and deleted the &lt;cpu ...&gt; block.  Still runs fine :-).</p>



<a name="263597292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cross-compiling%20rustc/stdlib/cargo/near/263597292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> apteryx <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cross-compiling.20rustc.2Fstdlib.2Fcargo.html#263597292">(Dec 03 2021 at 15:44)</a>:</h4>
<p>I'll now try to tackle the static compilation challenge</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>