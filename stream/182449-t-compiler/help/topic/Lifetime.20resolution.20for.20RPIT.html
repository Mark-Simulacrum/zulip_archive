<html>
<head><meta charset="utf-8"><title>Lifetime resolution for RPIT · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html">Lifetime resolution for RPIT</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260526736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260526736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260526736">(Nov 06 2021 at 17:41)</a>:</h4>
<p>I am trying to understand how lifetime resolution works for RPIT: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_resolve/src/late/lifetimes.rs#L754">https://github.com/rust-lang/rust/blob/master/compiler/rustc_resolve/src/late/lifetimes.rs#L754</a></p>
<p>My understanding of the RPIT desugaring is:</p>
<div class="codehilite"><pre><span></span><code>fn foo&lt;&#39;a&gt;(a: &amp;&#39;a usize) -&gt; impl Copy + &#39;a { a }
</code></pre></div>
<p>becomes</p>
<div class="codehilite"><pre><span></span><code>fn foo&lt;&#39;a&gt;(a: &amp;&#39;a usize) -&gt; FooRPIT&lt;&#39;a&gt; { a }
type FooRPIT&lt;&#39;a&gt; = impl Copy + &#39;a; // OpaqueTy
</code></pre></div>
<p>Current lifetime resolution code somehow intertwines the resolution of lifetimes in the <code>foo</code> and the resolution in <code>FooRPIT</code>. I attempted to separate the two: I wanted to perform resolution on the <code>type FooRPIT</code> item on its own. Doing that, I get lifetimes errors (<code>a ...is captured here... ...and is required to live as long as 'static here</code>).</p>
<p>Is there some kind of lifetime unification that is done during resolution that I missed?<br>
cc <span class="user-mention" data-user-id="124288">@oli</span> since you wrote <a href="https://github.com/rust-lang/rust/issues/54741">#54741</a> (please redirect me if required).</p>



<a name="260528641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260528641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260528641">(Nov 06 2021 at 18:24)</a>:</h4>
<p>There's a comment about this here: <a href="https://github.com/rust-lang/rust/blob/3326f19e8982ce033e04c163ddc520a76e42c737/compiler/rustc_borrowck/src/region_infer/opaque_types.rs#L14">https://github.com/rust-lang/rust/blob/3326f19e8982ce033e04c163ddc520a76e42c737/compiler/rustc_borrowck/src/region_infer/opaque_types.rs#L14</a></p>



<a name="260528700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260528700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260528700">(Nov 06 2021 at 18:24)</a>:</h4>
<p>The lowering does some unexpected stuff to make the partial lifetime capturing work.</p>



<a name="260528817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260528817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260528817">(Nov 06 2021 at 18:27)</a>:</h4>
<p>Thanks for the reference, but I don't understand this comment.</p>



<a name="260528935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260528935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260528935">(Nov 06 2021 at 18:29)</a>:</h4>
<p>What does "<code>infer_opaque_definition_from_instantiation</code>compares lifetimes directly" mean? Which representation of lifetimes is compared?</p>



<a name="260529024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260529024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260529024">(Nov 06 2021 at 18:31)</a>:</h4>
<p>It means comparing <code>ty::Region</code>s using <code>==</code> rather than using a <code>TypeRelation</code></p>



<a name="260529269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260529269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260529269">(Nov 06 2021 at 18:37)</a>:</h4>
<p>Let me try to summarize:</p>
<ol>
<li>the algorithm renames all regions inside the concrete type to a region which appears in the substs: in our case, we compute the concrete type to be <code>&amp;'a usize</code> where <code>'a</code> is the generic parameter of <code>foo</code>;</li>
<li>the algorithm declares <code>FooRPIT&lt;'b&gt; := concrete_type['a becomes 'b] = &amp;'b usize</code>.</li>
</ol>
<p>I still don't really see the link with how lifetime resolution is performed.</p>



<a name="260529755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260529755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260529755">(Nov 06 2021 at 18:49)</a>:</h4>
<p>I'm looking at <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_infer/src/infer/opaque_types.rs#L555">https://github.com/rust-lang/rust/blob/master/compiler/rustc_infer/src/infer/opaque_types.rs#L555</a><br>
This line attempts to perform a substitution of the opaque type <code>FooRPIT</code> with the substs from <code>foo</code>, doesn't it?</p>



<a name="260529854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260529854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260529854">(Nov 06 2021 at 18:51)</a>:</h4>
<p>The substs are from the <code>ty::Opaque</code></p>



<a name="260529924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260529924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260529924">(Nov 06 2021 at 18:53)</a>:</h4>
<p>Those would come from here: <a href="https://github.com/rust-lang/rust/blob/3326f19e8982ce033e04c163ddc520a76e42c737/compiler/rustc_typeck/src/astconv/mod.rs#L2410">https://github.com/rust-lang/rust/blob/3326f19e8982ce033e04c163ddc520a76e42c737/compiler/rustc_typeck/src/astconv/mod.rs#L2410</a></p>



<a name="260865045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260865045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260865045">(Nov 09 2021 at 21:35)</a>:</h4>
<p>Actually, do we really need the HIR dance with lifetime generics? We don't do this with type &amp; const generics, why do it on lifetimes?</p>



<a name="260984269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/260984269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#260984269">(Nov 10 2021 at 12:52)</a>:</h4>
<p>We only do it for lifetimes because only some lifetimes are captured by rpit, but all type and cost parameters are captured.</p>



<a name="261017949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/261017949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#261017949">(Nov 10 2021 at 16:49)</a>:</h4>
<p>Could this distinction be made during lifetime resolution: mark captured and non-captured lifetimes for a RPIT?</p>



<a name="261018131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Lifetime%20resolution%20for%20RPIT/near/261018131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Lifetime.20resolution.20for.20RPIT.html#261018131">(Nov 10 2021 at 16:50)</a>:</h4>
<p>I mean:</p>
<ul>
<li>stop duplicating lifetime generics for RPIT;</li>
<li>identify captured lifetimes during lifetime resolution;</li>
<li>use that information for type inference.</li>
</ul>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>