<html>
<head><meta charset="utf-8"><title>cloning arbitrary expression: bad? · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html">cloning arbitrary expression: bad?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265791365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cloning%20arbitrary%20expression%3A%20bad%3F/near/265791365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html#265791365">(Dec 22 2021 at 11:02)</a>:</h4>
<p>On a scale from "it doesn't matter" to "don't ever do this", how bad is cloning an arbitrary expression? It's an <code>AnonConst</code> that's present in the AST, being used as part of a derive macro.</p>



<a name="265791424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cloning%20arbitrary%20expression%3A%20bad%3F/near/265791424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html#265791424">(Dec 22 2021 at 11:02)</a>:</h4>
<p>Because it's part of a derive macro, it's running at most once per field per type (pre-monomorphization).</p>



<a name="265791963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cloning%20arbitrary%20expression%3A%20bad%3F/near/265791963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html#265791963">(Dec 22 2021 at 11:09)</a>:</h4>
<p>Also, if there's a way to run const eval and just use the resulting value, that would be ideal I'd imagine. Not sure how that works in the compiler, though; I'm operating on the AST level.</p>



<a name="265792467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cloning%20arbitrary%20expression%3A%20bad%3F/near/265792467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html#265792467">(Dec 22 2021 at 11:15)</a>:</h4>
<p>AST is too early for that I think; rustdoc uses <code>tcx.const_eval_poly(def_id)</code> for this</p>



<a name="265792503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cloning%20arbitrary%20expression%3A%20bad%3F/near/265792503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html#265792503">(Dec 22 2021 at 11:15)</a>:</h4>
<p>(well, rustdoc's handling of consts is a flaming trash heap, but <code>const_eval_poly</code> is one of the many things it does lmao)</p>



<a name="265792577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cloning%20arbitrary%20expression%3A%20bad%3F/near/265792577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html#265792577">(Dec 22 2021 at 11:16)</a>:</h4>
<p>That's what I thought (I know miri needs mir...it's literally in the name). So the question of cloning is the main one.</p>



<a name="265792709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cloning%20arbitrary%20expression%3A%20bad%3F/near/265792709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html#265792709">(Dec 22 2021 at 11:18)</a>:</h4>
<p>AnonConst is actually Copy so this should be extremely cheap, just 4 pointers memcopied<br>
<a href="https://doc.rust-lang.org/stable/nightly-rustc/src/rustc_hir/hir.rs.html#1368">https://doc.rust-lang.org/stable/nightly-rustc/src/rustc_hir/hir.rs.html#1368</a></p>



<a name="265792846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cloning%20arbitrary%20expression%3A%20bad%3F/near/265792846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html#265792846">(Dec 22 2021 at 11:20)</a>:</h4>
<p>That's hir's version. ast's isn't: <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_ast/ast/struct.AnonConst.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_ast/ast/struct.AnonConst.html</a></p>



<a name="265792897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cloning%20arbitrary%20expression%3A%20bad%3F/near/265792897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html#265792897">(Dec 22 2021 at 11:21)</a>:</h4>
<p>The actual type is <code>Option&lt;rustc_ast::AnonConst&gt;</code> if it at all matters.</p>



<a name="265793104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cloning%20arbitrary%20expression%3A%20bad%3F/near/265793104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Boxy [she/her] <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html#265793104">(Dec 22 2021 at 11:23)</a>:</h4>
<p>I imagine anon consts are generally pretty small <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> but really you can shove any sized expression in there so</p>



<a name="265793193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/cloning%20arbitrary%20expression%3A%20bad%3F/near/265793193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Pratt <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/cloning.20arbitrary.20expression.3A.20bad.3F.html#265793193">(Dec 22 2021 at 11:24)</a>:</h4>
<p>Yeah, <em>in theory</em> it's super cheap. But someone does something stupid, which let's face it is inevitable</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>