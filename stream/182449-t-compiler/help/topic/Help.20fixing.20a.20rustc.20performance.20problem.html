<html>
<head><meta charset="utf-8"><title>Help fixing a rustc performance problem · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html">Help fixing a rustc performance problem</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265085686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265085686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265085686">(Dec 15 2021 at 22:32)</a>:</h4>
<p>Hello everyone! <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> I'm looking into fixing a problem that's affecting the compile times of a few projects (influxdata/influxdb_iox, apache/arrow-rs, apache/arrow-datafusion). I've been playing around with a reduction of the problem, trying to reduce it more, but I'm not sure if there are more reduction experiments that it would be useful to try. I also have no idea where to start trying to fix the problem... I'd love any ideas anyone has! Here's the issue and the experiments I did today: <a href="https://github.com/rust-lang/rust/issues/87012#issuecomment-995262877">https://github.com/rust-lang/rust/issues/87012#issuecomment-995262877</a></p>



<a name="265085977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265085977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265085977">(Dec 15 2021 at 22:35)</a>:</h4>
<p><span class="user-mention" data-user-id="257516">@Carol (Nichols || Goulding)</span> I know a crash reduction tool - maybe you could adapt it to work for timeouts too? <a href="https://github.com/chengniansun/perses">https://github.com/chengniansun/perses</a></p>



<a name="265086025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265086025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265086025">(Dec 15 2021 at 22:35)</a>:</h4>
<p>if that doesn't work, <a href="http://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/">http://blog.pnkfx.org/blog/2019/11/18/rust-bug-minimization-patterns/</a> has some tips for doing it manually</p>



<a name="265087395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265087395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265087395">(Dec 15 2021 at 22:49)</a>:</h4>
<blockquote>
<p>Additionally, looking at the chrome profiles of cases that exhibit the problem, it looks like the issue is both that evaluate_obligation is being called many times and that these calls are expensive. The rectangles next to the one I'm hovering over here are all evaluate_obligation:</p>
</blockquote>
<p>Have you tried a recent nightly? A fix or partial fix for some obligation evaluation runtime explosions has landed a few days ago.</p>



<a name="265103577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265103577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265103577">(Dec 16 2021 at 02:02)</a>:</h4>
<p>Oooohhhh crash reduction looks fun!!</p>



<a name="265103666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265103666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265103666">(Dec 16 2021 at 02:04)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> I was using e2116acae 2021-12-05, I'll try a newer one, thank you!</p>



<a name="265104158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265104158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265104158">(Dec 16 2021 at 02:13)</a>:</h4>
<p><span class="user-mention" data-user-id="257516">@Carol (Nichols || Goulding)</span> you might want to see if <a href="https://github.com/rust-lang/rust/pull/89831">https://github.com/rust-lang/rust/pull/89831</a> fixes/improves the compile times for those projects. We ran into a compile time regression related to <code>evaluate_obligation</code> in 1.56 and I just confirmed that our build times go from 898 seconds to 34 seconds with that PR.</p>



<a name="265104789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265104789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265104789">(Dec 16 2021 at 02:24)</a>:</h4>
<p>so c5ecc1570 2021-12-15 still has the problem. <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> I will try out that PR! thank you!!</p>



<a name="265170213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265170213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265170213">(Dec 16 2021 at 15:15)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> I'm not 100% sure I've built/configured rustc with that PR correctly, but if I have.... that PR makes my test case worse :( <code>evaluate_obligation</code> takes 172ms/42% rather than 98ms/31% :(</p>



<a name="265172012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265172012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265172012">(Dec 16 2021 at 15:27)</a>:</h4>
<p>best way to check is probably rustup-toolchain-install-master <a href="https://github.com/rust-lang/rust/commit/35198c7a6d25cfbcbf61da23f8a6b22db99eacce">35198c7a6d25cfbcbf61da23f8a6b22db99eacce</a>, if you can test on x86_64-unknown-linux-gnu</p>



<a name="265172279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265172279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265172279">(Dec 16 2021 at 15:29)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> what's that hash? should i use the hash of the PR i'm trying to test?</p>



<a name="265172296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265172296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265172296">(Dec 16 2021 at 15:29)</a>:</h4>
<p>most recent try build</p>



<a name="265173317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265173317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265173317">(Dec 16 2021 at 15:36)</a>:</h4>
<p><span class="user-mention" data-user-id="257516">@Carol (Nichols || Goulding)</span> Sorry, I should have read your linked post more closely. If <code>evalute_obligation</code> is taking 100ms, then it's almost certainly not the same issue as <a href="https://github.com/rust-lang/rust/issues/89831">#89831</a> fixes.</p>



<a name="265173544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265173544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265173544">(Dec 16 2021 at 15:37)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> Ah, oh well. Thanks!</p>



<a name="265221789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265221789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265221789">(Dec 16 2021 at 21:26)</a>:</h4>
<p><span class="user-mention" data-user-id="257516">@Carol (Nichols || Goulding)</span> I'm happy to point a profiler at it and see if anything leaps out at me. Can you give me a link to the most relevant version to profile? (I'm having trouble keeping up with the different versions flying around.) One with an exaggerated version of the problem would be good, though not so exaggerated that it aborts.</p>



<a name="265222515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265222515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265222515">(Dec 16 2021 at 21:33)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> Thank you! If you check out <a href="https://github.com/integer32llc/rust_issue_87012/commit/c20999e8a971b71e65d0a26f7f1f0cc09bbb3479">https://github.com/integer32llc/rust_issue_87012/commit/c20999e8a971b71e65d0a26f7f1f0cc09bbb3479</a> that should complete but it's showing it's spending ~64% of the time in evaluate_obligation</p>



<a name="265223424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265223424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265223424">(Dec 16 2021 at 21:41)</a>:</h4>
<p>Will do, thanks</p>



<a name="265223728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265223728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265223728">(Dec 16 2021 at 21:44)</a>:</h4>
<p>Just to double check, I did this:</p>
<ul>
<li>git clone <a href="https://github.com/integer32llc/rust_issue_87012">https://github.com/integer32llc/rust_issue_87012</a></li>
<li>cd rust_issue_87012/</li>
<li>git co <a href="https://github.com/rust-lang/rust/commit/c20999e8a971b71e65d0a26f7f1f0cc09bbb3479">c20999e8a971b71e65d0a26f7f1f0cc09bbb3479</a></li>
</ul>



<a name="265223736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265223736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265223736">(Dec 16 2021 at 21:44)</a>:</h4>
<p>Is that right?</p>



<a name="265223831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265223831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265223831">(Dec 16 2021 at 21:45)</a>:</h4>
<p>Should be! If you run ./test.sh, what do you see?</p>



<a name="265224126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265224126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265224126">(Dec 16 2021 at 21:47)</a>:</h4>
<div class="codehilite"><pre><span></span><code>   Compiling helper_crate v0.1.0 (/home/njn/dev/rustc-perf/collector/benchmarks/rust_issue_87012/helper_crate)
   Compiling repro_crate v0.1.0 (/home/njn/dev/rustc-perf/collector/benchmarks/rust_issue_87012/repro_crate)
    Finished dev [unoptimized + debuginfo] target(s) in 1.88s
thread &#39;main&#39; panicked at &#39;couldn&#39;t read string_data file: Os { code: 2, kind: NotFound, message: &quot;No such file or directory&quot; }&#39;, src/libcore/result.rs:1188:5
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.
</code></pre></div>
<p>but I might not have summary and crox installed</p>



<a name="265224382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265224382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265224382">(Dec 16 2021 at 21:49)</a>:</h4>
<p>ahh.</p>



<a name="265224662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265224662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265224662">(Dec 16 2021 at 21:51)</a>:</h4>
<p>No matter, I was going to use different profilers</p>



<a name="265224689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265224689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265224689">(Dec 16 2021 at 21:51)</a>:</h4>
<p>But rustc-perf's harness doesn't like the workspace in the Cargo.toml, hmm</p>



<a name="265224910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265224910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265224910">(Dec 16 2021 at 21:53)</a>:</h4>
<p>Can I jam them together into a single crate and still see the perf issue?</p>



<a name="265225053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265225053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265225053">(Dec 16 2021 at 21:54)</a>:</h4>
<p>no idea!</p>



<a name="265225062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265225062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265225062">(Dec 16 2021 at 21:55)</a>:</h4>
<p>1 sec and I'll try</p>



<a name="265225743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265225743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265225743">(Dec 16 2021 at 22:00)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> yeah if you copy helper_crate/src/lib.rs into repro_crate/src/main.rs, then remove all the <code>helper_crate::</code> from the calls to <code>entry_point</code>, i can remove helper_crate from repro_crate/Cargo.toml and i still see the issue when doing cargo build -p repro_crate</p>



<a name="265225804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265225804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265225804">(Dec 16 2021 at 22:01)</a>:</h4>
<p>i'll clean this up a bit more and push it to a branch too, that's a good minimizer</p>



<a name="265225887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265225887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265225887">(Dec 16 2021 at 22:01)</a>:</h4>
<p>Thanks, I have it working in the rustc-perf harness</p>



<a name="265225942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265225942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265225942">(Dec 16 2021 at 22:02)</a>:</h4>
<p>First impression: it doesn't look that different to other profiles...</p>



<a name="265226048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265226048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265226048">(Dec 16 2021 at 22:03)</a>:</h4>
<p>:(</p>



<a name="265226250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265226250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265226250">(Dec 16 2021 at 22:05)</a>:</h4>
<p>other profiles spend that much time in evaluate_obligation?</p>



<a name="265226328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265226328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265226328">(Dec 16 2021 at 22:05)</a>:</h4>
<p>I'm using different profilers</p>



<a name="265226337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265226337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265226337">(Dec 16 2021 at 22:05)</a>:</h4>
<div class="codehilite"><pre><span></span><code>[gulf:~/dev/rustc-perf] cgout-more dec09/cgout-Orig-ripgrep-Check-Full | head -11
               2,061,681,981 TOTAL
12.5% 12.5%      257,352,501 ./malloc/malloc.c
 6.6% 19.1%      135,602,671 /home/njn/.cargo/registry/src/github.com-1ecc6299db9ec823/hashbrown-0.11.0/src/raw/mod.rs
 3.0% 22.1%       61,938,565 /home/njn/dev/rust0/library/core/src/ptr/mod.rs
 2.5% 24.6%       51,535,285 /home/njn/dev/rust0/library/alloc/src/vec/mod.rs
 2.3% 26.9%       48,440,844 /home/njn/dev/rust0/library/core/src/slice/iter/macros.rs
 2.0% 28.9%       41,597,709 /home/njn/dev/rust0/compiler/rustc_middle/src/ty/context.rs
 2.0% 30.9%       40,295,261 /home/njn/dev/rust0/compiler/rustc_middle/src/ty/sty.rs
 1.9% 32.8%       39,162,515 /home/njn/.cargo/registry/src/github.com-1ecc6299db9ec823/hashbrown-0.11.0/src/raw/bitmask.rs
 1.7% 34.5%       34,553,069 ./string/../sysdeps/x86_64/multiarch/memmove-vec-unaligned-erms.S
 1.7% 36.1%       34,088,744 /home/njn/dev/rust0/library/core/src/num/uint_macros.rs
close failed in file object destructor:
sys.excepthook is missing
lost sys.stderr
[gulf:~/dev/rustc-perf] cgout-more dec17/cgout-Orig-repro_crate-Check-Full | head -11
               4,471,625,012 TOTAL
12.7% 12.7%      566,100,729 ./malloc/malloc.c
 5.6% 18.2%      249,952,809 /home/njn/.cargo/registry/src/github.com-1ecc6299db9ec823/hashbrown-0.11.0/src/raw/mod.rs
 5.6% 23.8%      248,715,788 /home/njn/dev/rust0/compiler/rustc_trait_selection/src/traits/select/mod.rs
 4.5% 28.3%      202,185,949 /home/njn/dev/rust0/compiler/rustc_middle/src/ty/sty.rs
 3.9% 32.3%      175,388,010 /home/njn/dev/rust0/compiler/rustc_middle/src/ty/context.rs
 3.9% 36.2%      174,519,694 /home/njn/dev/rust0/compiler/rustc_infer/src/infer/mod.rs
 3.7% 39.9%      167,516,895 /home/njn/dev/rust0/compiler/rustc_middle/src/ty/subst.rs
 3.5% 43.4%      157,993,407 /home/njn/dev/rust0/compiler/rustc_middle/src/ty/fold.rs
 3.1% 46.5%      138,829,272 /home/njn/dev/rust0/library/core/src/ptr/mod.rs
 2.3% 48.8%      103,072,906 /home/njn/dev/rust0/library/core/src/option.rs
</code></pre></div>



<a name="265226407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265226407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265226407">(Dec 16 2021 at 22:06)</a>:</h4>
<p>That's comparing a profile compiling <code>ripgrep</code> with your example</p>



<a name="265226424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265226424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265226424">(Dec 16 2021 at 22:06)</a>:</h4>
<p>Per-file instruction blame</p>



<a name="265226434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265226434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265226434">(Dec 16 2021 at 22:06)</a>:</h4>
<p>Some differences, but nothing leaps out as "whoa"</p>



<a name="265226505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265226505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265226505">(Dec 16 2021 at 22:07)</a>:</h4>
<p>To be clear: I'm not denying there's a problem <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="265226626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265226626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265226626">(Dec 16 2021 at 22:08)</a>:</h4>
<p>Different profilers show up different aspects of the problem, I thought I'd try some different ones to what everyone's already been looking at</p>



<a name="265226721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265226721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265226721">(Dec 16 2021 at 22:09)</a>:</h4>
<p>so <code>/home/njn/dev/rust0/compiler/rustc_trait_selection/src/traits/select/mod.rs</code> shows up in the profile for my example but not ripgrep</p>



<a name="265226759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265226759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265226759">(Dec 16 2021 at 22:09)</a>:</h4>
<p>evaluate_obligation is definitely in rustc_trait_selection</p>



<a name="265227331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265227331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265227331">(Dec 16 2021 at 22:13)</a>:</h4>
<p>Things are fairly spread out across that file</p>



<a name="265228891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265228891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265228891">(Dec 16 2021 at 22:27)</a>:</h4>
<p>bleh. well now i'm getting unstable fingerprint errors trying to compile rustc with instrumentation on evaluate_obligation. time to take a break. thank you for your help!!!</p>



<a name="265229211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265229211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265229211">(Dec 16 2021 at 22:30)</a>:</h4>
<p><code>rm -r build/&lt;triple&gt;/&lt;affected stage&gt;</code> should solve it</p>



<a name="265230454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265230454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265230454">(Dec 16 2021 at 22:42)</a>:</h4>
<p>Looking at this example with DHAT (a heap profiler) and it is quite allocation-heavy, more so than normal.</p>



<a name="265230467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265230467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265230467">(Dec 16 2021 at 22:42)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_trait_selection/src/traits/select/mod.rs#L2334-L2342">https://github.com/rust-lang/rust/blob/master/compiler/rustc_trait_selection/src/traits/select/mod.rs#L2334-L2342</a> accounts for about 20% of the allocations</p>



<a name="265230529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265230529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265230529">(Dec 16 2021 at 22:43)</a>:</h4>
<p>That flaper87 comment is 7 years old, lol</p>



<a name="265230796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265230796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265230796">(Dec 16 2021 at 22:46)</a>:</h4>
<p>I poked around related code recently in <a href="https://github.com/rust-lang/rust/pull/91844/">https://github.com/rust-lang/rust/pull/91844/</a> (currently in the merge queue), there's still room for improvement</p>



<a name="265236488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265236488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265236488">(Dec 16 2021 at 23:49)</a>:</h4>
<p>I can definitely see some opportunities for some constant time improvements around this code. I don't know if there are opportunities for doing better than that, e.g. changing quadratic behaviour to linear</p>



<a name="265242668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265242668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265242668">(Dec 17 2021 at 01:13)</a>:</h4>
<p>E.g. I have a change now that avoids allocations when gathering obligations. It avoids 20% of the allocations (a different 20% to those I mentioned above) and runs about 5% faster on my non-jemalloc-enabled build. On a jemalloc-enabled build the win might be slightly smaller, like 3-4%. I see possibilities for a couple of improvements like this. Are they interesting? Or is the original problem more like "this is 10x slower than it should be"?</p>



<a name="265243601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265243601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265243601">(Dec 17 2021 at 01:30)</a>:</h4>
<p>The original issue didn't say it was a regression, so I think even small improvements would be worthwhile :)</p>



<a name="265245525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265245525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265245525">(Dec 17 2021 at 02:04)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/92017">https://github.com/rust-lang/rust/pull/92017</a> has the change</p>



<a name="265245629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265245629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265245629">(Dec 17 2021 at 02:06)</a>:</h4>
<p><code>ObligationCauseCode</code> also causes a lot of allocations, specifically the <code>ImplDerivedObligation</code> and <code>MatchImpl</code> variants, both of which are recursive</p>



<a name="265245833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265245833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265245833">(Dec 17 2021 at 02:10)</a>:</h4>
<p><code>MatchImpl</code> looks like it could be simplified, it doesn't need a full <code>ObligationCause</code> within it</p>



<a name="265246513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265246513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265246513">(Dec 17 2021 at 02:24)</a>:</h4>
<p>ImplDerivedObligation has some silly reallocations relating to <code>Lrc</code>, should be fixable once <a href="https://github.com/rust-lang/rust/pull/91844/">https://github.com/rust-lang/rust/pull/91844/</a>  lands</p>



<a name="265248990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265248990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265248990">(Dec 17 2021 at 03:09)</a>:</h4>
<p>Yeah, another 12% of the original allocation count can be shaved off with the <code>Lrc</code> fix</p>



<a name="265295888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265295888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265295888">(Dec 17 2021 at 13:35)</a>:</h4>
<p>I don't know how fast it "should" be, so I'm interested in any improvements!</p>



<a name="265502286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265502286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265502286">(Dec 19 2021 at 21:59)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/91844">#91844</a> will land shortly, I ended up fixing the silly <code>Lrc</code> allocations within it</p>



<a name="265587876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265587876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265587876">(Dec 20 2021 at 16:49)</a>:</h4>
<p>Good news!!! <a href="https://github.com/rust-lang/rust/pull/92044">https://github.com/rust-lang/rust/pull/92044</a> seems to fix it!!!!!!!!!!!</p>



<a name="265590852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265590852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265590852">(Dec 20 2021 at 17:13)</a>:</h4>
<p>Unfortunately, my initial version was unsound, so I've reduced the number of cases where it discards bounds from the <code>ParamEnv</code>. I'm pretty sure that this shouldn't affect your code (or almost any normal code), but you'll want to re-test once the <code>try</code> build completes.</p>



<a name="265603644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Help%20fixing%20a%20rustc%20performance%20problem/near/265603644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Carol (Nichols || Goulding) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Help.20fixing.20a.20rustc.20performance.20problem.html#265603644">(Dec 20 2021 at 19:01)</a>:</h4>
<p>Still works!!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>