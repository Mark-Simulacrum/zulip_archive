<html>
<head><meta charset="utf-8"><title>Trouble implementing `Copy` · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html">Trouble implementing `Copy`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272749160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272749160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272749160">(Feb 22 2022 at 00:52)</a>:</h4>
<p>I'm reworking the <code>List&lt;T&gt;</code> type and having trouble with implementing <code>Copy</code>:</p>
<div class="codehilite"><pre><span></span><code>error[E0204]: the trait `Copy` may not be implemented for this type
  --&gt; compiler/rustc_middle/src/ty/list.rs:48:15
   |
46 | pub struct List&lt;&#39;tcx, T&gt;(Interned&lt;&#39;tcx, ListS&lt;T&gt;&gt;);
   |                          ------------------------ this field does not implement `Copy`
47 |
48 | impl&lt;&#39;tcx, T&gt; Copy for List&lt;&#39;tcx, T&gt; {}
   |               ^^^^
</code></pre></div>
<p>But <code>Interned&lt;'a, T&gt;</code> very much does implement <code>Copy</code>, right <a href="https://github.com/rust-lang/rust/blob/03a8cc7df1d65554a4d40825b0490c93ac0f0236/compiler/rustc_data_structures/src/intern.rs#L44">here</a>.</p>
<p>What am I missing?</p>



<a name="272749842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272749842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272749842">(Feb 22 2022 at 01:05)</a>:</h4>
<p>What's the definition of ListS?</p>



<a name="272749902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272749902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272749902">(Feb 22 2022 at 01:06)</a>:</h4>
<p>actually hm, that shouldn't matter. Interned wraps a reference.</p>



<a name="272749918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272749918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272749918">(Feb 22 2022 at 01:06)</a>:</h4>
<p>There isn't a <code>T: 'tcx</code> or something you need to add, right?</p>



<a name="272750026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272750026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272750026">(Feb 22 2022 at 01:08)</a>:</h4>
<p>If you really want to go overboard, you could try building with <code>RUSTC_LOG=rustc_trait_selection=debug</code> and see why <code>type_is_copy_modulo_regions</code> is failing for <code>Interned</code>.</p>



<a name="272750091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272750091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272750091">(Feb 22 2022 at 01:10)</a>:</h4>
<p>Isn't copy special in that you can't implement it if anything inside doesn't? (Even if it is theoretically Copy)?</p>



<a name="272750113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272750113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272750113">(Feb 22 2022 at 01:10)</a>:</h4>
<p>Is the ListS type new?</p>



<a name="272753014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753014">(Feb 22 2022 at 02:13)</a>:</h4>
<p><code>ListS</code> is this:</p>
<div class="codehilite"><pre><span></span><code>#[repr(C)]
pub struct ListS&lt;T&gt; {
    len: usize,
    data: [T; 0],
    opaque: OpaqueListContents,
}
</code></pre></div>



<a name="272753062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753062">(Feb 22 2022 at 02:14)</a>:</h4>
<p>OpaqueListContents might not implement Copy?</p>



<a name="272753064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753064">(Feb 22 2022 at 02:14)</a>:</h4>
<p>I'm surprised because <code>List</code> is similar to <code>Ty</code>, <a href="https://github.com/rust-lang/rust/blob/b8967b0d52a2ba5f0c9da0da03e78ccba5534e4a/compiler/rustc_middle/src/ty/mod.rs#L437">here</a></p>



<a name="272753071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753071">(Feb 22 2022 at 02:14)</a>:</h4>
<p>But <code>Interned</code> implements <code>Copy</code>, I don't understand why <code>ListS</code> needs to. <a href="https://github.com/rust-lang/rust/blob/b8967b0d52a2ba5f0c9da0da03e78ccba5534e4a/compiler/rustc_middle/src/ty/mod.rs#L394"><code>TyS</code> doesn't</a></p>



<a name="272753165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753165">(Feb 22 2022 at 02:17)</a>:</h4>
<p>oh</p>



<a name="272753186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753186">(Feb 22 2022 at 02:17)</a>:</h4>
<p>yeah, I think <span class="user-mention" data-user-id="426609">@Michael Goulet (compiler-errors)</span> was right, try a <code>impl&lt;'tcx, T: 'tcx&gt; Copy for List&lt;'tcx, T&gt; {}</code></p>



<a name="272753187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753187">(Feb 22 2022 at 02:17)</a>:</h4>
<p>(note : 'tcx on T)</p>



<a name="272753231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753231">(Feb 22 2022 at 02:18)</a>:</h4>
<p>since <code>impl&lt;'tcx, T: 'tcx + ?Sized&gt; Copy for Interned&lt;'tcx, T&gt; {}</code></p>



<a name="272753262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753262">(Feb 22 2022 at 02:19)</a>:</h4>
<p>Doesn't work <span aria-label="frown" class="emoji emoji-1f641" role="img" title="frown">:frown:</span></p>



<a name="272753266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753266">(Feb 22 2022 at 02:19)</a>:</h4>
<p>same error</p>



<a name="272753279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753279">(Feb 22 2022 at 02:19)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> if you want some help, feel free to give me a commit hash and I could take a look at the trait selection logs.</p>



<a name="272753288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753288">(Feb 22 2022 at 02:19)</a>:</h4>
<p>Deriving <code>Copy</code> gives a similar failure</p>



<a name="272753374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753374">(Feb 22 2022 at 02:21)</a>:</h4>
<p><span class="user-mention" data-user-id="426609">@Michael Goulet (compiler-errors)</span> Here's a branch: <a href="https://github.com/nnethercote/rust/tree/Interned-List">https://github.com/nnethercote/rust/tree/Interned-List</a>  Thank you!</p>



<a name="272753446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753446">(Feb 22 2022 at 02:23)</a>:</h4>
<p>Aha, it <em>is</em> the <code>OpaqueListContents</code>. I made a <code>ListS2</code> without it and a <code>List2</code> that wraps <code>ListS2</code> and that works ok</p>



<a name="272753458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753458">(Feb 22 2022 at 02:23)</a>:</h4>
<p>So the error message is very unclear</p>



<a name="272753463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753463">(Feb 22 2022 at 02:23)</a>:</h4>
<p>And even knowing the problem, I don't know how to fix it <span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p>



<a name="272753552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753552">(Feb 22 2022 at 02:25)</a>:</h4>
<p>I can't impl <code>Copy</code> on <code>ListS</code> because of the array</p>



<a name="272753566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753566">(Feb 22 2022 at 02:25)</a>:</h4>
<p>Maybe if you impl Copy for the OpaqueListContents?</p>



<a name="272753572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753572">(Feb 22 2022 at 02:26)</a>:</h4>
<p>I can't, it's just a <code>type</code></p>



<a name="272753621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753621">(Feb 22 2022 at 02:26)</a>:</h4>
<p>hm, is it ?Sized or something? It should be fine to impl things for extern <code>type</code>s</p>



<a name="272753632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753632">(Feb 22 2022 at 02:26)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error[E0206]: the trait `Copy` may not be implemented for this type
  --&gt; compiler/rustc_middle/src/ty/list.rs:60:15
   |
60 | impl Copy for OpaqueListContents {}
   |               ^^^^^^^^^^^^^^^^^^ type is not a structure or enumeration
</code></pre></div>



<a name="272753638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753638">(Feb 22 2022 at 02:26)</a>:</h4>
<p>yeah, extern types are !Sized I think</p>



<a name="272753708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753708">(Feb 22 2022 at 02:28)</a>:</h4>
<p>huh</p>



<a name="272753712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753712">(Feb 22 2022 at 02:28)</a>:</h4>
<p>I mean I guess it makes sense (we can't really copy that type)</p>



<a name="272753733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753733">(Feb 22 2022 at 02:28)</a>:</h4>
<p>I'm not sure the exact intent of the extern type in List</p>



<a name="272753748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753748">(Feb 22 2022 at 02:29)</a>:</h4>
<p>ah, unsizing List</p>



<a name="272753758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753758">(Feb 22 2022 at 02:29)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> do you have <code>?Sized</code> on your <code>T</code> generic parameter in <code>Interned</code>?</p>



<a name="272753763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753763">(Feb 22 2022 at 02:29)</a>:</h4>
<p>On all three of the struct, the Copy, and the Clone impl.</p>



<a name="272753822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753822">(Feb 22 2022 at 02:30)</a>:</h4>
<p><code>Interned</code> is <a href="https://github.com/rust-lang/rust/blob/b8967b0d52a2ba5f0c9da0da03e78ccba5534e4a/compiler/rustc_data_structures/src/intern.rs#L24">here</a></p>



<a name="272753824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753824">(Feb 22 2022 at 02:30)</a>:</h4>
<p>Sorry, haven't had time to poke at your branch yet lol</p>



<a name="272753835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753835">(Feb 22 2022 at 02:30)</a>:</h4>
<p>Yeah, I think you need <code>T: ?Sized</code> everywhere</p>



<a name="272753836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753836">(Feb 22 2022 at 02:30)</a>:</h4>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=fbb3bf547517e6f6bcc1094f3245a7ee">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=fbb3bf547517e6f6bcc1094f3245a7ee</a></p>



<a name="272753837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753837">(Feb 22 2022 at 02:30)</a>:</h4>
<p>No, no <code>?Sized</code> anywhere</p>



<a name="272753841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753841">(Feb 22 2022 at 02:31)</a>:</h4>
<p>That playground is a minimization, shows the same error if <code>?Sized</code> is removed.</p>



<a name="272753917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753917">(Feb 22 2022 at 02:32)</a>:</h4>
<p>So <code>ListS</code> is <code>!Sized</code>, because of that opaque member. Therefore it does not qualify for the <code>Copy</code> implementation since it has an implicit <code>T: Sized</code>.</p>



<a name="272753930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753930">(Feb 22 2022 at 02:33)</a>:</h4>
<p>That works, thank you!</p>



<a name="272753932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753932">(Feb 22 2022 at 02:33)</a>:</h4>
<p>Man, that <code>Copy</code> lint could use some work. I will fix it to give a better "why", I think.</p>



<a name="272753946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272753946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Goulet (compiler-errors) <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272753946">(Feb 22 2022 at 02:33)</a>:</h4>
<p>There's no reason we can't have it spit out the reasons why copy_modulo_regions is not fulfilled.</p>



<a name="272798211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Trouble%20implementing%20%60Copy%60/near/272798211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Trouble.20implementing.20.60Copy.60.html#272798211">(Feb 22 2022 at 12:55)</a>:</h4>
<p>Yeah, the interesting thing here is that <code>Copy</code> may be one of the few cases where the compiler kind of inserts its own implicit where clause which needs to trivially resolve to <code>true</code>, and by circumventing the typical mechanism of <code>where</code> clauses, the error message does not trigger the "required by …" kind of messages.</p>
<p>In <span class="user-mention" data-user-id="120989">@nnethercote</span>'s codebase (<em>i.e.</em>, a codebase that would forget the <code>?Sized</code> unbounds when dealing with the more generic <code>Interned</code> type), manually adding the "recursive requirements" to the impls for <code>List</code>, like so:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w">impl&lt;'tcx, T&gt; Clone for List&lt;'tcx, T&gt;</span>
<span class="w">where</span>
<span class="gi">+   Self : Copy, /* from `Copy` derive `Clone` */</span><span class="w"></span>
<span class="w">{</span>
<span class="w"> </span>   fn clone(&amp;self) -&gt; Self {<span class="w"></span>
<span class="w"> </span>       *self<span class="w"></span>
<span class="w"> </span>   }<span class="w"></span>
<span class="w">}</span>

<span class="w">impl&lt;'tcx, T&gt; Copy for List&lt;'tcx, T&gt;</span>
<span class="w">where</span>
<span class="gi">+   Interned&lt;'tcx, ListS&lt;T&gt;&gt; : Copy, /* can be `Copy` if each field is */</span><span class="w"></span>
<span class="w">{}</span>
</code></pre></div>
<p>does yield the following error message for <code>assert_is_copy</code>:</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="go">error[E0277]: the size for values of type `OpaqueListContents` cannot be known at compilation time</span>
<span class="go">  --&gt; src/main.rs:45:5</span>
<span class="go">   |</span>
<span class="go">45 |     assert_is_copy::&lt;List&lt;'static, ()&gt;&gt;();</span>
<span class="go">   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ doesn't have a size known at compile-time</span>
<span class="go">   |</span>
<span class="go">   = help: within `ListS&lt;()&gt;`, the trait `Sized` is not implemented for `OpaqueListContents`</span>
<span class="go">note: required because it appears within the type `ListS&lt;()&gt;`</span>
<span class="go">  --&gt; src/main.rs:7:12</span>
<span class="go">   |</span>
<span class="go">7  | pub struct ListS&lt;T&gt; {</span>
<span class="go">   |            ^^^^^</span>
<span class="go">note: required because of the requirements on the impl of `Copy` for `Interned&lt;'_, ListS&lt;()&gt;&gt;`</span>
<span class="go">  --&gt; src/main.rs:21:13</span>
<span class="go">   |</span>
<span class="go">21 | impl&lt;'a, T&gt; Copy for Interned&lt;'a, T&gt;</span>
<span class="go">   |             ^^^^     ^^^^^^^^^^^^^^^</span>
<span class="go">   = note: 1 redundant requirement hidden</span>
<span class="go">   = note: required because of the requirements on the impl of `Copy` for `List&lt;'static, ()&gt;`</span>
<span class="go">note: required by a bound in `assert_is_copy`</span>
<span class="go">  --&gt; src/main.rs:42:22</span>
<span class="go">   |</span>
<span class="go">42 | fn assert_is_copy&lt;T: Copy&gt;() {}</span>
<span class="go">   |                      ^^^^ required by this bound in `assert_is_copy`</span>

<span class="go">For more information about this error, try `rustc --explain E0277`.</span>
</code></pre></div>
<ul>
<li><a href="https://play.integer32.com/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=0c6031dbd9d8520dac9d16e2a6208a5e">Playground</a></li>
</ul>
<p>The error message could still be a bit better even at that point (suggesting that <code>?Sized</code> be added to the root <code>impl Copy</code> like it does for other cases of impl mismatch), but it does mention <code>?Sized</code> as well as <code>OpaqueListContents</code> being part of <code>ListS</code>, and does highlight the</p>
<ul>
<li><code>impl&lt;'a, T&gt; Copy for Interned&lt;'a, T&gt;</code></li>
</ul>
<p>line. So from that point it's easier to guess what the issue was <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>