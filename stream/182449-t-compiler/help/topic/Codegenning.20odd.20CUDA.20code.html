<html>
<head><meta charset="utf-8"><title>Codegenning odd CUDA code · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20odd.20CUDA.20code.html">Codegenning odd CUDA code</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251765120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Codegenning%20odd%20CUDA%20code/near/251765120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20odd.20CUDA.20code.html#251765120">(Sep 02 2021 at 18:40)</a>:</h4>
<p>On my journey of compiling rust to cuda kernels, i have stumbled upon some really weird things CUDA/NVCC does. One of these is dynamic shared memory. Basically, you declare an... extern shared variable and then in the kernel invocation you tell it the amount of bytes of shared memory you want. CUDA C++ code:</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">dynamicReverse</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="n">__shared__</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">s</span><span class="p">[];</span><span class="w">   </span><span class="c1">// this right here</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">s</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">[</span><span class="n">t</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="n">__syncthreads</span><span class="p">();</span><span class="w"></span>
<span class="w">  </span><span class="n">d</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="n">tr</span><span class="p">];</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Which then, when put through nvcc, makes an extern decl in the ptx:</p>
<div class="codehilite"><pre><span></span><code>    // .globl   _Z14dynamicReversePii
.extern .shared .align 16 .b8 s[];
</code></pre></div>
<p>But i am a bit clueless on how i could implement this in a rustc codegen. I don't know if id have to do some manual mir codegen for this or something, because i would need to declare a global every time a certain struct or attribute is created. Maybe i could make a proc macro which the codegen then "grabs" invocations to and does its thing? Im honestly not sure how to approach this, so id love to hear any ideas <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="251765239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Codegenning%20odd%20CUDA%20code/near/251765239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20odd.20CUDA.20code.html#251765239">(Sep 02 2021 at 18:41)</a>:</h4>
<p>I need to do this for texture objects too, so its not an isolated problem :/</p>



<a name="251766351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Codegenning%20odd%20CUDA%20code/near/251766351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20odd.20CUDA.20code.html#251766351">(Sep 02 2021 at 18:49)</a>:</h4>
<p>Oh perhaps i could declare a special intrinsic like <code>__nvvm_get_shared_mem_global</code>. Then if the codegen stumbles upon a call to it, instead of generating a call to it, it creates a global then returns a pointer to that global. It seems like a bit of a hack but it should work</p>



<a name="251766888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Codegenning%20odd%20CUDA%20code/near/251766888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20odd.20CUDA.20code.html#251766888">(Sep 02 2021 at 18:52)</a>:</h4>
<p>i really dislike how cuda does this, because its 100% UB if the caller of the kernel does not match the expected amount of bytes</p>



<a name="251784149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Codegenning%20odd%20CUDA%20code/near/251784149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Riccardo D&#x27;Ambrosio <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20odd.20CUDA.20code.html#251784149">(Sep 02 2021 at 20:49)</a>:</h4>
<p>Another detail is that CUDA does not allow multiple dynamic shared mem declarations, if two shared vars are declared, they will point to the same memory, which will be odd to enforce...</p>



<a name="254970596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Codegenning%20odd%20CUDA%20code/near/254970596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> kang Lei <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Codegenning.20odd.20CUDA.20code.html#254970596">(Sep 26 2021 at 23:18)</a>:</h4>
<p>Hello everyone, I have finished learning the rust language, and now I am interested in the rust compiler. I want to join the rust compiler and contribute to rust. How do I learn? Thanks!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>