<html>
<head><meta charset="utf-8"><title>Unexpected difference in bounds check elision · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unexpected.20difference.20in.20bounds.20check.20elision.html">Unexpected difference in bounds check elision</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267736743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Unexpected%20difference%20in%20bounds%20check%20elision/near/267736743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gspr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unexpected.20difference.20in.20bounds.20check.20elision.html#267736743">(Jan 12 2022 at 15:06)</a>:</h4>
<p>I'm hoping that someone can help me decide whether this is worth filing a bug report for.</p>
<p>I would naively expect <code>for i [0_usize, 1_usize, 2_usize] { do_something_with(x[i]); }</code> to be able to elide the bounds check in <code>x[i]</code> whenever <code>x: [T; 3]</code>. Here the <code>3</code> is just some reasonably small number someone might iterate up to by hand, and the array that <code>i</code> iterates over is obviously known at compile time to only contain values less than <code>3</code>.</p>
<p>Looking at the generated assembly, however, I don't see this (rustc 1.57 on x86-64). If, however, I change the loop to use a slice iterator instead, i.e. <code>for &amp; i in &amp; [0_usize, 1_usize, 2_usize] { … }</code>, I do see the expected behavior.</p>
<p>Is this to be expected, or something I should file a bug report or feature request for?</p>



<a name="267757716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Unexpected%20difference%20in%20bounds%20check%20elision/near/267757716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unexpected.20difference.20in.20bounds.20check.20elision.html#267757716">(Jan 12 2022 at 17:27)</a>:</h4>
<p>There are many <code>I-slow</code> issues, including some about bounds checks. Maybe check if one matches. But considering that array iterators are newish maybe there isn't one yet. Maybe it's easy to fix, maybe not.</p>



<a name="267842626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Unexpected%20difference%20in%20bounds%20check%20elision/near/267842626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gspr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unexpected.20difference.20in.20bounds.20check.20elision.html#267842626">(Jan 13 2022 at 09:23)</a>:</h4>
<p>Hmm, this seems relevant, no? <a href="https://github.com/rust-lang/rust/issues/63552">https://github.com/rust-lang/rust/issues/63552</a></p>



<a name="267842661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/Unexpected%20difference%20in%20bounds%20check%20elision/near/267842661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> gspr <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/Unexpected.20difference.20in.20bounds.20check.20elision.html#267842661">(Jan 13 2022 at 09:23)</a>:</h4>
<p>Yet the discussion seems to indicate that this was fixed in nightly in 2019.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>