<html>
<head><meta charset="utf-8"><title>LLVM Pass · t-compiler/help · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/index.html">t-compiler/help</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html">LLVM Pass</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255712509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/255712509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gladys <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#255712509">(Oct 01 2021 at 09:02)</a>:</h4>
<p>Hi, I would like to achieve the following:<br>
rust code -&gt; Generating LLVM IR with the emit flag -&gt; Running custom pass with opt -&gt; final executable  <br>
May I know how to generate the final executable? Or is it even possible? Or is there any other way to pass in my custom pass to rustc? thanks</p>



<a name="255716467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/255716467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#255716467">(Oct 01 2021 at 09:38)</a>:</h4>
<p><code>-Cpasses=...</code> allows specifying passes to run.</p>



<a name="255718701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/255718701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gladys <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#255718701">(Oct 01 2021 at 09:56)</a>:</h4>
<p>The -Cpasses can pass in custom .so? Thanks</p>



<a name="255723190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/255723190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#255723190">(Oct 01 2021 at 10:37)</a>:</h4>
<p>I…  am not sure about a custom pass .so but people are experimenting with automated differentiation and whatnot, so it must be possible.</p>



<a name="255725806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/255725806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#255725806">(Oct 01 2021 at 11:02)</a>:</h4>
<p>I think you need -Zllvm-plugins to load external plugins. Be aware though that the rustc for some targets doesn't link LLVM dynamically as required for external plugins though. We don't offer any guarantees about which targets and which don't dynamically link against LLVM and which LLVM version is used, unless you build rustc against a specific LLVM version yourself.</p>



<a name="258474101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/258474101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> okaca <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#258474101">(Oct 21 2021 at 01:44)</a>:</h4>
<p>Hi guys, I am new to rust, also wanted to pass in a custom llvm pass to rustc. I have tried -Zllvm-plugins to load my .so and also tried -Cpasses to indicate my pass name; which result in unknown pass. </p>
<p>I have taken a look at the rustc code for the -Zllvm-plugins, but it seems like it just load and do nothing. Please advise if i am wrong or anyone have idea how to pass in the my custom .so and how to indicate the pass name in my custom .so. Thanks in advance.</p>
<p>compiler/rustc_codegen_llvm/src/llvm_util.rs</p>
<div class="codehilite"><pre><span></span><code>    for plugin in &amp;sess.opts.debugging_opts.llvm_plugins {
        let path = Path::new(plugin);
        let res = DynamicLibrary::open(path);
        match res {
            Ok(_) =&gt; debug!(&quot;LLVM plugin loaded succesfully {} ({})&quot;, path.display(), plugin),
            Err(e) =&gt; bug!(&quot;couldn&#39;t load plugin: {}&quot;, e),
        }
        mem::forget(res);
    }
</code></pre></div>



<a name="258478718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/258478718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#258478718">(Oct 21 2021 at 02:43)</a>:</h4>
<p>Did you register the plugin?</p>



<a name="258478834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/258478834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#258478834">(Oct 21 2021 at 02:45)</a>:</h4>
<p>Loading a library would execute all ctors in init section</p>



<a name="258498509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/258498509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> okaca <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#258498509">(Oct 21 2021 at 07:19)</a>:</h4>
<p>May  I know how to register the plugin via rustc?</p>



<a name="258505073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/258505073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> okaca <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#258505073">(Oct 21 2021 at 08:16)</a>:</h4>
<p>opps, i think u referring inside my  custom pass? I am using the llvm pass example from <a href="https://llvm.org/docs/WritingAnLLVMPass.html">https://llvm.org/docs/WritingAnLLVMPass.html</a> which did register the pass</p>
<div class="codehilite"><pre><span></span><code>#include &quot;llvm/Pass.h&quot;
#include &quot;llvm/IR/Function.h&quot;
#include &quot;llvm/Support/raw_ostream.h&quot;

#include &quot;llvm/IR/LegacyPassManager.h&quot;
#include &quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;

using namespace llvm;

namespace {
struct Hello : public FunctionPass {
  static char ID;
  Hello() : FunctionPass(ID) {}

  bool runOnFunction(Function &amp;F) override {
    errs() &lt;&lt; &quot;Hello: &quot;;
    errs().write_escaped(F.getName()) &lt;&lt; &#39;\n&#39;;
    return false;
  }
}; // end of struct Hello
}  // end of anonymous namespace

char Hello::ID = 0;
static RegisterPass&lt;Hello&gt; X(&quot;hello&quot;, &quot;Hello World Pass&quot;,
                             false /* Only looks at CFG */,
                             false /* Analysis Pass */);

static RegisterStandardPasses Y(
    PassManagerBuilder::EP_EarlyAsPossible,
    [](const PassManagerBuilder &amp;Builder,
       legacy::PassManagerBase &amp;PM) { PM.add(new Hello()); });
</code></pre></div>



<a name="258505201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/258505201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> okaca <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#258505201">(Oct 21 2021 at 08:17)</a>:</h4>
<p>I am using the llvm example first as I would like to ensure the example work first before i invest my time to write my custom pass.</p>



<a name="258512842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/258512842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#258512842">(Oct 21 2021 at 09:19)</a>:</h4>
<p>You are using the legacy pass manager. Rustc very recently switched to the new pass manager.</p>



<a name="258641669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/258641669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> okaca <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#258641669">(Oct 22 2021 at 01:01)</a>:</h4>
<p>hi, do you mean my command is correct but the rustc version is outdated? </p>
<p>my rustc version is: rustc --version<br>
rustc 1.56.0-nightly (29ef6cf16 2021-08-31)</p>
<p>my command is:<br>
rustc --crate-name test --edition=2018 test/src/bin/test.rs  --crate-type bin -Zllvm-plugins=/pathToMyCustom.so -Cpasses="hello"</p>



<a name="258642286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/258642286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#258642286">(Oct 22 2021 at 01:08)</a>:</h4>
<p><a href="https://llvm.org/docs/NewPassManager.html">https://llvm.org/docs/NewPassManager.html</a></p>



<a name="258643026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/182449-t-compiler/help/topic/LLVM%20Pass/near/258643026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> okaca <a href="https://zulip-archive.rust-lang.org/stream/182449-t-compiler/help/topic/LLVM.20Pass.html#258643026">(Oct 22 2021 at 01:17)</a>:</h4>
<p>thanks</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>