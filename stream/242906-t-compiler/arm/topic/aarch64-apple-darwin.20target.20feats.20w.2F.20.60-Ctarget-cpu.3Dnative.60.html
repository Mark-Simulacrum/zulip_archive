<html>
<head><meta charset="utf-8"><title>aarch64-apple-darwin target feats w/ `-Ctarget-cpu=native` · t-compiler/arm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/index.html">t-compiler/arm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html">aarch64-apple-darwin target feats w/ `-Ctarget-cpu=native`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271485835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271485835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271485835">(Feb 10 2022 at 19:58)</a>:</h4>
<p>On a new M1 and noticed this: <code>rustc --print cfg -Ctarget-cpu=native</code> does a worse job at figuring out the supported flags than <code>rustc --print cfg</code> (e.g. with no other options):  <a href="https://gist.github.com/thomcc/a505f793a7d30f1fa071777034c91db5">https://gist.github.com/thomcc/a505f793a7d30f1fa071777034c91db5</a> </p>
<p>Anybody know the deal here? Seems like we should fix this using whatever method is used for the default cfg values (or just checking <code>sysctl -a hw.optional</code> -- i'm not sure how specific the semantics of <code>-Ctarget-cpu=native</code> are that, and if that'd be allowed or if it'd be <em>too</em> specific to the local cpu)</p>
<p>(My wild speculation for why this is happening is that somehow it's related to the fact that system <code>clang</code> seems to outright forbid <code>-march=native</code> on aarch64-apple-darwin: "error: the clang compiler does not support '-march=native'" uh-huh, yeah, sure you don't)</p>



<a name="271490394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271490394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271490394">(Feb 10 2022 at 20:34)</a>:</h4>
<p>It looks like cpu detection on arm is only implemented for linux: <a href="https://github.com/llvm/llvm-project/blob/6b1e844b69f15bb7dffaf9365cd2b355d2eb7579/llvm/lib/Support/Host.cpp#L1271">https://github.com/llvm/llvm-project/blob/6b1e844b69f15bb7dffaf9365cd2b355d2eb7579/llvm/lib/Support/Host.cpp#L1271</a><br>
edit: it is supported. it is hard coded to cyclone for aarch64 though: <a href="https://github.com/llvm/llvm-project/blob/6b1e844b69f15bb7dffaf9365cd2b355d2eb7579/llvm/lib/Support/Host.cpp#L1304">https://github.com/llvm/llvm-project/blob/6b1e844b69f15bb7dffaf9365cd2b355d2eb7579/llvm/lib/Support/Host.cpp#L1304</a></p>



<a name="271490569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271490569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271490569">(Feb 10 2022 at 20:36)</a>:</h4>
<p>I would guess cyclone is a lot older than the m1 (which rustc defaults to on aarch64 macos) and thus disables target features.</p>



<a name="271490605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271490605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271490605">(Feb 10 2022 at 20:36)</a>:</h4>
<p>it looks like llvm detects cpus rather than individual target features.</p>



<a name="271490718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271490718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271490718">(Feb 10 2022 at 20:37)</a>:</h4>
<p>Interesting. So fixing this requires an LLVM patch?</p>



<a name="271490749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271490749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271490749">(Feb 10 2022 at 20:37)</a>:</h4>
<p>I dont actually know how you'd do CPU detection, only feature detection</p>



<a name="271490756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271490756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271490756">(Feb 10 2022 at 20:37)</a>:</h4>
<p>maybe there's a sysctl</p>



<a name="271491307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271491307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271491307">(Feb 10 2022 at 20:43)</a>:</h4>
<p>there is. <code>sysctl hw.cpufamily</code> spits out a number, and while theres likely a better place, it could be compared against the defines <a href="https://github.com/apple-oss-distributions/xnu/blob/main/osfmk/mach/machine.h#L411-L443">https://github.com/apple-oss-distributions/xnu/blob/main/osfmk/mach/machine.h#L411-L443</a> however the comment directly above it says explicitly not to use it for this:</p>
<blockquote>
<p>you should never try to deduce whether or not some feature is available based on the family. Use feature flags (eg, hw.optional.altivec) to test for optional functionality.</p>
</blockquote>



<a name="271491804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271491804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271491804">(Feb 10 2022 at 20:47)</a>:</h4>
<p>also, oddly enough the value I have is behind that <code>#ifdef</code>: <code>hw.cpufamily: 0x1b588bb3</code> and <code>hw.cpusubfamily: 0x00000005</code>. So that makes me even less optimistic that they should be used. I think at a minimum we should configure features under <code>-Ctarget-cpu=...</code> the same way we configure them without then. and IMO it would be reasonable to check <code>sysctl -a hw.optional</code> too, (although I don't care that much since the default seems to have the full feature set)</p>



<a name="271491879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271491879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271491879">(Feb 10 2022 at 20:48)</a>:</h4>
<p>fixing this in llvm tho... sounds too painful to be honest</p>



<a name="271492019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271492019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271492019">(Feb 10 2022 at 20:49)</a>:</h4>
<p>but maybe you'd prefer it be upto the codegen backend to determine such things? that seems like it would just make more work for you, but idk</p>



<a name="271492587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271492587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271492587">(Feb 10 2022 at 20:53)</a>:</h4>
<p><code>-Ctarget-cpu</code> doesn't just influence target features, but also instruction scheduling and other cost models. It would be impossible to do that without the codegen backend knowing the exact cpu to optimize for.</p>



<a name="271498048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271498048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271498048">(Feb 10 2022 at 21:35)</a>:</h4>
<p>Huh, I thought that was influenced by <code>-Ztune-cpu</code></p>



<a name="271498073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271498073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271498073">(Feb 10 2022 at 21:36)</a>:</h4>
<p>and that target-cpu was more naive about such things.</p>



<a name="271498235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271498235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271498235">(Feb 10 2022 at 21:37)</a>:</h4>
<p>Really, the question of the exact cpu is in some sense quite clear -- "this one". but i understand that this is not the sort of input instruction scheduling wants...</p>



<a name="271498543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271498543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271498543">(Feb 10 2022 at 21:39)</a>:</h4>
<p>the fact that <code>clang</code> refuses to accept native as a target cpu (or tune cpu) on aarch64-apple-darwin makes me think this isn't going to have a clean solution (perhaps apple are planning on having the feature sets vary for nominally equivalent cpus. or perhaps they want to avoid something they found undesirable about feature testing on intel). i have to imagine that it's deliberate, given how much sway apple has over clang</p>



<a name="271504057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271504057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271504057">(Feb 10 2022 at 22:21)</a>:</h4>
<p><code>-Ztune-cpu</code> is <code>-Ctarget-cpu</code> without preventing the program to run on older cpus afaik.</p>



<a name="271507352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271507352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271507352">(Feb 10 2022 at 22:58)</a>:</h4>
<p>oh</p>



<a name="271507393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271507393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271507393">(Feb 10 2022 at 22:59)</a>:</h4>
<p>yeah my bad, i thought it did something different</p>



<a name="271507620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271507620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271507620">(Feb 10 2022 at 23:01)</a>:</h4>
<p><span class="user-mention" data-user-id="209168">@Thom Chiovoloni</span> It might be good to file an issue about this, as it seems surprising.</p>
<blockquote>
<p>bjorn3: I would guess cyclone is a lot older than the m1 (which rustc defaults to on aarch64 macos) and thus disables target features.</p>
</blockquote>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> Unless I'm looking at the wrong thing, it seems like aarch64-apple-darwin defaults to <code>apple-a14</code>.  It looks like that was chosen because m1 isn't supported in LLVM 12.  I think it was added in LLVM 13.</p>



<a name="271507652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271507652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271507652">(Feb 10 2022 at 23:01)</a>:</h4>
<p>yep, i'm going to file one after work. i'll link it here when i do</p>



<a name="271507718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271507718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271507718">(Feb 10 2022 at 23:02)</a>:</h4>
<p>On the rustc side it does, but <code>-Ctarget-cpu=native</code> defaults to cyclone on the LLVM side it seems.</p>



<a name="271526787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin%20target%20feats%20w/%20%60-Ctarget-cpu%3Dnative%60/near/271526787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/aarch64-apple-darwin.20target.20feats.20w.2F.20.60-Ctarget-cpu.3Dnative.60.html#271526787">(Feb 11 2022 at 03:28)</a>:</h4>
<p>Filed as <a href="https://github.com/rust-lang/rust/issues/93889">https://github.com/rust-lang/rust/issues/93889</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>