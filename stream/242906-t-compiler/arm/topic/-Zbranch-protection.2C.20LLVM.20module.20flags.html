<html>
<head><meta charset="utf-8"><title>-Zbranch-protection, LLVM module flags · t-compiler/arm · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/index.html">t-compiler/arm</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html">-Zbranch-protection, LLVM module flags</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270233044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270233044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Bramley <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270233044">(Feb 01 2022 at 15:49)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span>, <span class="user-mention" data-user-id="123586">@nagisa</span> : Following on from <a href="#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bweekly.5D.202022-01-27.20.2354818/near/269589243">the weekly</a> and <a href="https://github.com/rust-lang/rust/issues/93523">#93523</a>... Omitting the flags entirely if disabled is problematic because if <code>branch-protection</code> is turned on in some other module then the result might be broken (or at best, won't have the security protections that the author might be expecting).<br>
That approach is "option 2" from my comment on the <a href="https://github.com/rust-lang/rust/issues/92885#issuecomment-1014356915">original bug report</a>; my fix (<a href="https://github.com/rust-lang/rust/issues/93269">#93269</a>) unconditionally emits the module flags, like Clang, but matches Clang's use of override behaviour flags.</p>



<a name="270233476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270233476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270233476">(Feb 01 2022 at 15:51)</a>:</h4>
<p>My broad belief is that unless the unstable feature is enabled in some way, the compiler should act as if the feature does not exist at all. Making sure that we always output some metadata may be something to consider during stabilization, I think.</p>



<a name="270233981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270233981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270233981">(Feb 01 2022 at 15:53)</a>:</h4>
<p>For <code>beta</code> reverting seems like the least risky possible change in a sense that it at least won't break any existing uses.</p>



<a name="270234174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270234174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270234174">(Feb 01 2022 at 15:54)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/93516">https://github.com/rust-lang/rust/pull/93516</a> is relevant in that context as well.</p>



<a name="270234959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270234959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Bramley <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270234959">(Feb 01 2022 at 15:59)</a>:</h4>
<p>Yes, I agree with that, I'm just thinking about the long-term fix.</p>



<a name="270235436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270235436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Bramley <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270235436">(Feb 01 2022 at 16:01)</a>:</h4>
<p>My concern is that existing uses that depend on Rust not generating anything are probably broken in other ways. Our <code>-Zbranch-protection</code> is additive, and cannot tell the difference between unspecified and deliberately-disabled flags.</p>



<a name="270235639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270235639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Bramley <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270235639">(Feb 01 2022 at 16:02)</a>:</h4>
<p>Discussing this during stabilisation sounds reasonable, though.</p>



<a name="270235664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270235664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270235664">(Feb 01 2022 at 16:02)</a>:</h4>
<p>As a side note you may want to create a tracking issue for this unstable feature (see <a href="https://github.com/rust-lang/rust/issues?q=is%3Aopen+is%3Aissue+label%3AC-tracking-issue">C-tracking-issue</a> for examples)</p>



<a name="270235805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270235805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270235805">(Feb 01 2022 at 16:03)</a>:</h4>
<p>I'm sure there's probably a chapter on the process in one of the books, but I don't know offhand which one.</p>



<a name="270237802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270237802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Bramley <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270237802">(Feb 01 2022 at 16:14)</a>:</h4>
<p>In the meantime, I haven't seen a change to omit disabled module flags, as you discussed in the weekly. Should we (Arm) do that, or are you working on it already?</p>



<a name="270241354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270241354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270241354">(Feb 01 2022 at 16:35)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/93516">https://github.com/rust-lang/rust/pull/93516</a> does that, doesn't it?</p>



<a name="270359058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/242906-t-compiler/arm/topic/-Zbranch-protection%2C%20LLVM%20module%20flags/near/270359058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Bramley <a href="https://zulip-archive.rust-lang.org/stream/242906-t-compiler/arm/topic/-Zbranch-protection.2C.20LLVM.20module.20flags.html#270359058">(Feb 02 2022 at 09:57)</a>:</h4>
<p>It does! I hadn't seen it, sorry.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>