<html>
<head><meta charset="utf-8"><title>polymorphizing shims vs transitive analysis w/ cycles · t-compiler/wg-polymorphization · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/index.html">t-compiler/wg-polymorphization</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html">polymorphizing shims vs transitive analysis w/ cycles</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="190024032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190024032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190024032">(Mar 08 2020 at 18:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>, <span class="user-mention silent" data-user-id="119009">eddyb</span> said I should speak to you about this.</p>
<p>There's an ICE when bootstrapping in stage two. I'll probably mangle this explanation, but here goes. Shims cannot be polymorphized, so I need to detect when they'll be generated and mark some generic parameters as used so they remain monomorphic. I did something similar with vtables, if I saw an unsized cast, I visited the source and target types in an exhaustive mode that visited closures, this meant that more generic parameters were marked as used and vtables would not be generated. However, with drop shims, while I can make a similar change, my analysis needs to be transitive for it to work.. but that causes cycle errors. I can't figure a way to work around the cycle errors, and because my query is for each individual function, there's no way for me to keep track of where I've been. <span class="user-mention silent" data-user-id="119009">eddyb</span> linked me to <a href="https://github.com/rust-lang/rust/issues/68828" target="_blank" title="https://github.com/rust-lang/rust/issues/68828">#68828</a>, and as far as I can gather from that, there's no consensus on how to deal with cycle errors.</p>
<p>The only other idea that <span class="user-mention silent" data-user-id="119009">eddyb</span> had was to use <code>ty::Placeholder</code> (or <code>ty::Erased</code>, something like that), instead of <code>ty::Param</code> when I use the results of my analysis, and then told me to speak to you about it.</p>
<p>I'm slightly concerned because this seems to be about the last blocker to have this whole thing working, but a solution to cycle errors doesn't seem to becoming soon, and re-working shims to avoid the issue would probably take a while; it's getting very close to when I need to start evaluating and writing my final paper on this (which is my fault for not getting further earlier - though, if I hadn't run into this blocker, I'd be about on schedule).</p>



<a name="190024082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190024082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190024082">(Mar 08 2020 at 19:00)</a>:</h4>
<p>(<a href="https://github.com/rust-lang/rust/issues/69749" target="_blank" title="https://github.com/rust-lang/rust/issues/69749">#69749</a> doesn't yet contain the patch to deal with drop shims that don't require the analysis be transitive, but it does contain the patch that I used for vtables)</p>



<a name="190032307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190032307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190032307">(Mar 08 2020 at 23:24)</a>:</h4>
<p>Wrapping up for today, didn't make much progress on resolving this issue (<a href="https://github.com/rust-lang/rust/pull/69749#issuecomment-596208496" target="_blank" title="https://github.com/rust-lang/rust/pull/69749#issuecomment-596208496">today's progress before hitting this issue</a>). Here's what I've got uncommitted:</p>
<ul>
<li><a href="http://sprunge.us/ME3r4H" target="_blank" title="http://sprunge.us/ME3r4H">Test that exercises drop shim issue</a>.</li>
<li><a href="http://sprunge.us/nX5lDB" target="_blank" title="http://sprunge.us/nX5lDB">Test that exercises drop shim issue (transitive)</a> - this is the harder case which is challenging without hitting cycle errors.</li>
<li><a href="http://sprunge.us/5BixNZ" target="_blank" title="http://sprunge.us/5BixNZ">Almost working, really hacky, fix</a> - this does awful things to detect when invoking the query would result in a query error, and then implements a transitive analysis based on that. In addition, it makes the query return more detailed information about why a type was used (in a drop or not) - this can be used with the transitive analysis to know when the transitive results mean that an exhaustive type visitor should be used, or not (e.g. if a closure is passed to a function and just called, then the closure doesn't need to be monomorphised, there won't be a drop shim; but if it is dropped, then it needs to be monomorphised - this lets us work that out). I suspect that this approach wouldn't pass review, because it is hacky, but I couldn't think of anything better and wanted to feel like I was making progress.</li>
</ul>



<a name="190038272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190038272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mark-i-m <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190038272">(Mar 09 2020 at 02:51)</a>:</h4>
<p>Probably a stupid question, but why why does the shim need to be monomorphic? Is the closure dropped in a different way depending on its context? Or am I misunderstanding?</p>



<a name="190047222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190047222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190047222">(Mar 09 2020 at 08:01)</a>:</h4>
<p>I don’t understand completely, it’s a limitation of the infrastructure for that in the compiler.</p>



<a name="190054387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190054387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190054387">(Mar 09 2020 at 10:09)</a>:</h4>
<p>Thinking on it more, I assume it's because the drop shim needs to identify the specific <code>Drop</code> impl, so it can call <code>Drop::drop</code> - it's intuitive that would inherently require all the generic parameters be known? </p>
<p>It works fine for regular types, but because closures inherit the generic arguments of their parent, I need to make sure that those parameters are marked used when a closure is getting dropped - the issue is knowing when I should do that. </p>
<p>For a normal generic parameter, if it is used in the call to another function, I mark it as used - easy, that function can mark it as used if it drops it. For closures, the type parameters that I need to mark as used are the ones that it inherits from the parent, those are in the current function, so if it is used in the call to another function, I need to know if that function will drop it, because the current function needs to mark parameters as used - that's the key difference, which function needs to mark the parameters as used -  which requires a transitive analysis. </p>
<p>If I were pessimistic and assume that closures might always be dropped, then that renders the whole analysis pointless, the saving we're hoping for comes from closures not having all their parameters marked as used.</p>



<a name="190057112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190057112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190057112">(Mar 09 2020 at 10:48)</a>:</h4>
<p>The only solution I've been able to come up with (lacking sufficient knowledge of drop shims to tackle the problem from that angle) is to make the analysis transitive - which I can do, it's not too hard - but I'd need to have a function like this to avoid cycle errors:</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">would_cause_query_error</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tcx</span>: <span class="nc">TyCtxt</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">def_id</span>: <span class="nc">DefId</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">query_map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tcx</span><span class="p">.</span><span class="n">queries</span><span class="p">.</span><span class="n">try_collect_active_jobs</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">current_job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ty</span>::<span class="n">tls</span>::<span class="n">with_related_context</span><span class="p">(</span><span class="n">tcx</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">icx</span><span class="o">|</span><span class="w"> </span><span class="n">icx</span><span class="p">.</span><span class="n">query</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">job</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_job</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">query_map</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">job</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">ty</span>::<span class="n">query</span>::<span class="n">Query</span>::<span class="n">used_generic_params</span><span class="p">(</span><span class="n">other_def_id</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">other_def_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">def_id</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">current_job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">job</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kc">false</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>I could probably make that function faster by exiting early as soon as I see a query that isn't <code>used_generic_params</code>, since if the analysis is transitive, there won't be any other queries in-between calls to <code>used_generic_params</code>.</p>



<a name="190058658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190058658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190058658">(Mar 09 2020 at 11:09)</a>:</h4>
<p>The mir inliner has the same problem: <a href="https://github.com/rust-lang/rust/pull/68828" target="_blank" title="https://github.com/rust-lang/rust/pull/68828">https://github.com/rust-lang/rust/pull/68828</a></p>



<a name="190058953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190058953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190058953">(Mar 09 2020 at 11:14)</a>:</h4>
<p>Yeah, <span class="user-mention silent" data-user-id="119009">eddyb</span> linked me to that PR, I referenced it in the initial message.</p>



<a name="190064196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190064196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190064196">(Mar 09 2020 at 12:44)</a>:</h4>
<p>Well... true cycle detection in the query system isn't possible, but if you can split your problem in into a pre cycle part and a post cycle part, you can do cycle detection on the pre cycle part</p>



<a name="190064406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190064406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190064406">(Mar 09 2020 at 12:47)</a>:</h4>
<p>I'm struggling to imagine an example of what that would look like (not just for the polymorphization case, but more generally too).</p>



<a name="190100110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100110">(Mar 09 2020 at 18:14)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> hmm</p>



<a name="190100201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100201">(Mar 09 2020 at 18:15)</a>:</h4>
<p>I might need to get more of an overview of exactly how your analysis works</p>



<a name="190100247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100247">(Mar 09 2020 at 18:15)</a>:</h4>
<p>maybe we can find a time to chat about this? I have to leave early today but plausibly could chat tomorrow or (maybe easier) Wed morning (my time)</p>



<a name="190100300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100300">(Mar 09 2020 at 18:16)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/69749" target="_blank" title="https://github.com/rust-lang/rust/issues/69749">#69749</a> has all of the code (minus the change to get drop shims working w/out transitivity)</p>



<a name="190100311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100311">(Mar 09 2020 at 18:16)</a>:</h4>
<p>I can do that</p>



<a name="190100333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100333">(Mar 09 2020 at 18:16)</a>:</h4>
<p>Would you recommend I start by trying to read your PR? Maybe that's best</p>



<a name="190100352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100352">(Mar 09 2020 at 18:16)</a>:</h4>
<p>Tomorrow or Wednesday afternoon (my time) works for me.</p>



<a name="190100358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100358">(Mar 09 2020 at 18:16)</a>:</h4>
<p>but I was assuming it'd be a lot of code :)</p>



<a name="190100362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100362">(Mar 09 2020 at 18:16)</a>:</h4>
<p>It's not a huge amount.</p>



<a name="190100394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100394">(Mar 09 2020 at 18:17)</a>:</h4>
<p>Having some familiarity from the PR would be helpful.</p>



<a name="190100402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100402">(Mar 09 2020 at 18:17)</a>:</h4>
<p>(Which reminds me that this might make a nice addition to rustc-dev-guide)</p>



<a name="190100409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100409">(Mar 09 2020 at 18:17)</a>:</h4>
<p>(That is, some notes on how it works)</p>



<a name="190100421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100421">(Mar 09 2020 at 18:17)</a>:</h4>
<p>I'll make a note to do that</p>



<a name="190100424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100424">(Mar 09 2020 at 18:17)</a>:</h4>
<p>I guess src/librustc_mir/monomorphize/polymorphize.rs is sort of the "main file"?</p>



<a name="190100441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100441">(Mar 09 2020 at 18:17)</a>:</h4>
<p>Yeah, that's the analysis itself.</p>



<a name="190100517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100517">(Mar 09 2020 at 18:18)</a>:</h4>
<p>There's a <code>polymorphize</code> function in <code>rustc/ty/instance.rs</code> which applies the results to an <code>Instance</code>.</p>



<a name="190100559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100559">(Mar 09 2020 at 18:18)</a>:</h4>
<p>There's a minor change to <code>rustc_mir/monomorphize/collector.rs</code> which uses that in <code>create_fn_mono_item</code>.</p>



<a name="190100591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100591">(Mar 09 2020 at 18:18)</a>:</h4>
<p>And a handful of places in <code>rustc_codegen_ssa</code> which also use that function.</p>



<a name="190100636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190100636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190100636">(Mar 09 2020 at 18:19)</a>:</h4>
<p>The majority of the work has been debugging where the analysis needed updated to fix obscure substitution failures from later in the compiler.</p>



<a name="190102663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190102663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mark-i-m <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190102663">(Mar 09 2020 at 18:36)</a>:</h4>
<blockquote>
<p>(Which reminds me that this might make a nice addition to rustc-dev-guide)</p>
</blockquote>
<p>Funny you should mention that... <a href="https://github.com/rust-lang/rustc-guide/pull/605/files#diff-d504f9659c36662fe3433e5a64d139ac" target="_blank" title="https://github.com/rust-lang/rustc-guide/pull/605/files#diff-d504f9659c36662fe3433e5a64d139ac">https://github.com/rust-lang/rustc-guide/pull/605/files#diff-d504f9659c36662fe3433e5a64d139ac</a></p>



<a name="190102728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190102728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mark-i-m <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190102728">(Mar 09 2020 at 18:37)</a>:</h4>
<p>It's just a stub currently, since I don't know much, but whenever you have time, expanding on it would be great!</p>



<a name="190107810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190107810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190107810">(Mar 09 2020 at 19:26)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> do you want to schedule a chat for tomorrow or wednesday then?</p>



<a name="190228814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190228814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190228814">(Mar 10 2020 at 21:41)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> ping; have you had an opportunity to look into this at all? I've got time tomorrow that I'd like to be able to use to make progress on this.</p>



<a name="190234435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190234435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190234435">(Mar 10 2020 at 22:45)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> I was totally slammed today, but I could take a look first thing tomorrow morning (9am my time, more or less)</p>



<a name="190236535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190236535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190236535">(Mar 10 2020 at 23:22)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I’d appreciate that, I’ll be around at that time.</p>



<a name="190279456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190279456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190279456">(Mar 11 2020 at 13:18)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> got a spotty wifi but I'm around :)</p>



<a name="190279459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190279459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190279459">(Mar 11 2020 at 13:18)</a>:</h4>
<p>o/</p>



<a name="190279755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190279755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190279755">(Mar 11 2020 at 13:21)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> the primary issue at the moment is that I don't know how to support drop shims w/ the analysis, so I'm blocked on being able to get it passing CI and then landed.</p>



<a name="190279856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190279856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190279856">(Mar 11 2020 at 13:22)</a>:</h4>
<p>right</p>



<a name="190280087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280087">(Mar 11 2020 at 13:24)</a>:</h4>
<p>Because drop shims need to be monomorphic (I don't understand the infrastructure around that enough to feel confident in my understanding of why that is) and because closures inherit type parameters, if a function passes a closure to another function, which is then dropped, then that causes a substitution failure (and presumably more failures later on that we don't get to) - to detect this case in the analysis of the original function which defines the closure, the analysis needs  to be transitive, which is hard because of cycle errors.</p>



<a name="190280168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280168">(Mar 11 2020 at 13:25)</a>:</h4>
<p>If <span class="user-mention" data-user-id="119009">@eddyb</span> is around, they might be able to explain this better.</p>



<a name="190280226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280226">(Mar 11 2020 at 13:26)</a>:</h4>
<p>uhhhhhhh</p>



<a name="190280240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280240">(Mar 11 2020 at 13:26)</a>:</h4>
<p>I should've been around this topic from the start, so sorry</p>



<a name="190280259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280259">(Mar 11 2020 at 13:26)</a>:</h4>
<p>so the explanation is that shims are fake MIR bodies for <em>a real definition</em></p>



<a name="190280298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280298">(Mar 11 2020 at 13:27)</a>:</h4>
<p>e.g. <code>drop_in_place::&lt;Foo&gt;</code> gets a shim <code>Instance</code> that has <code>substs=[Foo]</code></p>



<a name="190280312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280312">(Mar 11 2020 at 13:27)</a>:</h4>
<p>and the problem is that is that <code>Foo</code> is also in the <code>InstanceDef</code> determining the shim MIR body</p>



<a name="190280435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280435">(Mar 11 2020 at 13:28)</a>:</h4>
<p>so if there are any generic parameters in the <code>InstanceDef</code> (which contains <code>Foo</code> in my example above), they would be attempted to be substituted with <code>{ #0 -&gt; Foo }</code></p>



<a name="190280621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280621">(Mar 11 2020 at 13:30)</a>:</h4>
<p>I'm not sure I quite follow, <span class="user-mention" data-user-id="119009">@eddyb</span> -- I think you're saying that <code>Foo</code> is "hard-coded" in the <code>InstanceDef</code>, so just changing the substitution doesn't suffice?</p>



<a name="190280635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280635">(Mar 11 2020 at 13:30)</a>:</h4>
<p>so <code>drop_in_place::&lt;Vec&lt;#0&gt;&gt;</code> (I'm using <code>#0</code> but this could be <code>T</code>) produces a MIR body referring to <code>Vec&lt;#0&gt;</code> but which also is going to get monomorphized by <code>{ #0 -&gt; Vec&lt;#0&gt; }</code></p>



<a name="190280656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280656">(Mar 11 2020 at 13:30)</a>:</h4>
<p>so you'll create <code>Vec&lt;Vec&lt;#0&gt;&gt;</code> which is absurd</p>



<a name="190280670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280670">(Mar 11 2020 at 13:30)</a>:</h4>
<p>I'm trying in any case to read more into the PR because I don't quite understand where the cycle comes from</p>



<a name="190280702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280702">(Mar 11 2020 at 13:31)</a>:</h4>
<p>that is, what is the query involved</p>



<a name="190280704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280704">(Mar 11 2020 at 13:31)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> there's both a type in <code>InstanceDef</code> but also the substs for the original definition (or declaration if you want) that is getting shimmed</p>



<a name="190280720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280720">(Mar 11 2020 at 13:31)</a>:</h4>
<p>wait what cycle</p>



<a name="190280730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280730">(Mar 11 2020 at 13:31)</a>:</h4>
<p>oh I'm not talking about the cycle</p>



<a name="190280732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280732">(Mar 11 2020 at 13:31)</a>:</h4>
<p><code>.used_generic_params</code> I guess?</p>



<a name="190280748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280748">(Mar 11 2020 at 13:31)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> the cycle is like MIR inlining</p>



<a name="190280758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280758">(Mar 11 2020 at 13:31)</a>:</h4>
<p>recursive functions result in recursive queries etc.</p>



<a name="190280778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280778">(Mar 11 2020 at 13:31)</a>:</h4>
<p><a href="http://sprunge.us/ME3r4H" target="_blank" title="http://sprunge.us/ME3r4H">This code</a> demonstrates a case where this causes the PR to break; but that case can be fixed. But as soon as you extend it, <a href="http://sprunge.us/nX5lDB" target="_blank" title="http://sprunge.us/nX5lDB">like this</a>, the analysis would need to be transitive (calling itself on functions the current MIR body invokes) to detect the problematic case, but that can cause cycle errors where (<code>foo</code> -&gt; <code>bar</code> -&gt; <code>foo</code>) - the PR, right now, doesn't do that, because it cycle errors.</p>



<a name="190280863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280863">(Mar 11 2020 at 13:32)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> making the analysis transitive is likely much harder than fixing shims and vtables</p>



<a name="190280874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280874">(Mar 11 2020 at 13:32)</a>:</h4>
<p>So basically it's that same problem of needing to anayze / walk the call graph?</p>



<a name="190280882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280882">(Mar 11 2020 at 13:32)</a>:</h4>
<p>I'm sorry I didn't explain this better</p>



<a name="190280887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280887">(Mar 11 2020 at 13:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190280874" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190280874">said</a>:</p>
<blockquote>
<p>So basically it's that same problem of needing to anayze / walk the call graph?</p>
</blockquote>
<p>yupp</p>



<a name="190280909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280909">(Mar 11 2020 at 13:32)</a>:</h4>
<p>I'm not sure how much experimentation has been done there?</p>



<a name="190280958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280958">(Mar 11 2020 at 13:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190280621" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190280621">said</a>:</p>
<blockquote>
<p>I'm not sure I quite follow, <span class="user-mention silent" data-user-id="119009">eddyb</span> -- I think you're saying that <code>Foo</code> is "hard-coded" in the <code>InstanceDef</code>, so just changing the substitution doesn't suffice?</p>
</blockquote>
<p>it's just that right now we have <code>Foo</code> in two places and that basically causes double substitution if it has any generic parameters in it</p>



<a name="190280993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190280993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190280993">(Mar 11 2020 at 13:34)</a>:</h4>
<p>Personally, I still favor introducing a "construct the call graph query" and seeing how well that works, but I think that extending the query system to better accommodate cycles in this case would also be ok. It seems like <em>this</em> case is different from MIR inlining in some particulars.</p>



<a name="190281061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281061">(Mar 11 2020 at 13:34)</a>:</h4>
<p>we could probably solve this by not not using <code>instance.substs</code> when <code>instance.def</code> is a shim and we're working with the MIR body of the shim</p>



<a name="190281102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281102">(Mar 11 2020 at 13:34)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> ok, I admit I still don't <em>really</em> follow what you're talking about, though I think I have a sense for it,</p>



<a name="190281120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281120">(Mar 11 2020 at 13:35)</a>:</h4>
<p>are you saying that this would obviate the need for cyclic queries / walking call graph in some sense?</p>



<a name="190281134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281134">(Mar 11 2020 at 13:35)</a>:</h4>
<p>it's that PR of mine that asserts that doesn't resolve polymorphic shims</p>



<a name="190281166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281166">(Mar 11 2020 at 13:35)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> it would fix the problems that led <span class="user-mention" data-user-id="116107">@davidtwco</span> down the eldritch path of trying to make the analysis transitive</p>



<a name="190281178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281178">(Mar 11 2020 at 13:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190280993" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190280993">said</a>:</p>
<blockquote>
<p>Personally, I still favor introducing a "construct the call graph query" and seeing how well that works, but I think that extending the query system to better accommodate cycles in this case would also be ok. It seems like <em>this</em> case is different from MIR inlining in some particulars.</p>
</blockquote>
<p>to elaborate on this: I feel like we could have some way to say "cyclic queries are ok as long as all the members of the cycle are the same query and it is appropriately annotated", though we'd have to be careful about explaining the rules that permit a query to be so annotated</p>



<a name="190281182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281182">(Mar 11 2020 at 13:35)</a>:</h4>
<p>The issue with making the analysis transitive and that causing cycle errors is just a symptom of one potential solution (changing the analysis) in response to the root problem - substs in <code>Instance</code> for shims.</p>



<a name="190281234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281234">(Mar 11 2020 at 13:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> <a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190281182" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190281182">said</a>:</p>
<blockquote>
<p>The issue with making the analysis transitive and that causing cycle errors is just a symptom of one potential solution (changing the analysis) in response to the root problem - substs in <code>Instance</code> for shims.</p>
</blockquote>
<p>I think I confused this in my messaging, sorry.</p>



<a name="190281250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281250">(Mar 11 2020 at 13:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190281134" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190281134">said</a>:</p>
<blockquote>
<p>it's that PR of mine that asserts that doesn't resolve polymorphic shims</p>
</blockquote>
<p>yeah, I remember that PR, but</p>



<a name="190281255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281255">(Mar 11 2020 at 13:36)</a>:</h4>
<p>I was really happy when <span class="user-mention" data-user-id="116107">@davidtwco</span> initially told me the analysis isn't transitive, because that means we can land and enable it in a reasonable timeframe</p>



<a name="190281273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281273">(Mar 11 2020 at 13:36)</a>:</h4>
<p>instead of wasting months trying to do cyclic nonsense</p>



<a name="190281293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281293">(Mar 11 2020 at 13:37)</a>:</h4>
<p>can someone clarify for me what is meant by the analysis being intransitive</p>



<a name="190281300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281300">(Mar 11 2020 at 13:37)</a>:</h4>
<p>It's much simpler without being transitive, it seems to be <em>only</em> this case that "needs" it.</p>



<a name="190281310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281310">(Mar 11 2020 at 13:37)</a>:</h4>
<p>it analyzes the fn body but not callees, I guess..?</p>



<a name="190281325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281325">(Mar 11 2020 at 13:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190281310" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190281310">said</a>:</p>
<blockquote>
<p>it analyzes the fn body but not callees, I guess..?</p>
</blockquote>
<p>Exactly this.</p>



<a name="190281331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281331">(Mar 11 2020 at 13:37)</a>:</h4>
<p>yes, assumes callees use all of their substs</p>



<a name="190281368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281368">(Mar 11 2020 at 13:37)</a>:</h4>
<p>that will clearly lose precision</p>



<a name="190281373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281373">(Mar 11 2020 at 13:37)</a>:</h4>
<p>but we are saying "that's ok"</p>



<a name="190281376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281376">(Mar 11 2020 at 13:37)</a>:</h4>
<p>it only solves closures, really, since it's transitive through those</p>



<a name="190281433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281433">(Mar 11 2020 at 13:38)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> it's unattainable precision without a lot of effort nobody has time for</p>



<a name="190281445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281445">(Mar 11 2020 at 13:38)</a>:</h4>
<p>that's my position</p>



<a name="190281462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281462">(Mar 11 2020 at 13:38)</a>:</h4>
<p>I'm not arguing necessarily, just trying to understand</p>



<a name="190281469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281469">(Mar 11 2020 at 13:38)</a>:</h4>
<p>I agree it's a reasonable "first cut"</p>



<a name="190281481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281481">(Mar 11 2020 at 13:38)</a>:</h4>
<p>so we're not losing anything by starting without it because we could never "just do it"</p>



<a name="190281498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281498">(Mar 11 2020 at 13:38)</a>:</h4>
<p>and closures are arguably important enough</p>



<a name="190281509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281509">(Mar 11 2020 at 13:38)</a>:</h4>
<p>I mostly wanted to be sure I wasn't missing something</p>



<a name="190281520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281520">(Mar 11 2020 at 13:39)</a>:</h4>
<p>(I'm happy to sink time into it in future, but right now, an intransitive approach is desirable because it's 95% done and I've got a paper to write <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span>)</p>



<a name="190281524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281524">(Mar 11 2020 at 13:39)</a>:</h4>
<p>i.e., it's not like it wouldn't be <em>useful</em> in the abstract</p>



<a name="190281583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281583">(Mar 11 2020 at 13:39)</a>:</h4>
<p>right, I'm happy about avoiding the complexity <em>upfront</em></p>



<a name="190281586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281586">(Mar 11 2020 at 13:39)</a>:</h4>
<p>Making the analysis transitive is <em>a</em> solution to the problem that <span class="user-mention silent" data-user-id="119009">eddyb</span> was describing initially.</p>



<a name="190281683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281683">(Mar 11 2020 at 13:40)</a>:</h4>
<p>I never meant to imply it was a reasonable solution, and it's probably not even that hard to make the shims work correctly when polymorphic tbh</p>



<a name="190281732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281732">(Mar 11 2020 at 13:41)</a>:</h4>
<p>(to the extent that they can be polymorphic, I mean)</p>



<a name="190281862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281862">(Mar 11 2020 at 13:42)</a>:</h4>
<p>So maybe we should come back a bit to the problem</p>



<a name="190281867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281867">(Mar 11 2020 at 13:42)</a>:</h4>
<p>but first, one other question</p>



<a name="190281878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281878">(Mar 11 2020 at 13:42)</a>:</h4>
<p>would landing your PR <span class="user-mention" data-user-id="119009">@eddyb</span> allow this PR to land?</p>



<a name="190281887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281887">(Mar 11 2020 at 13:42)</a>:</h4>
<p>I feel like I r+'d it</p>



<a name="190281888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281888">(Mar 11 2020 at 13:42)</a>:</h4>
<p>but maybe I didn't :)</p>



<a name="190281896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281896">(Mar 11 2020 at 13:43)</a>:</h4>
<p>I'm having a hard time keeping up with reviews</p>



<a name="190281900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281900">(Mar 11 2020 at 13:43)</a>:</h4>
<p>no, it only acts as an early detection for the problem</p>



<a name="190281903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281903">(Mar 11 2020 at 13:43)</a>:</h4>
<p>I don't think so.</p>



<a name="190281906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281906">(Mar 11 2020 at 13:43)</a>:</h4>
<p>it still causes an ICE or w/e</p>



<a name="190281907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281907">(Mar 11 2020 at 13:43)</a>:</h4>
<p>but I still don't have a good "gut understanding" of the problem and i'd kind of like to</p>



<a name="190281912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281912">(Mar 11 2020 at 13:43)</a>:</h4>
<p>okok</p>



<a name="190281919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281919">(Mar 11 2020 at 13:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> <a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190280778" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190280778">said</a>:</p>
<blockquote>
<p><a href="http://sprunge.us/ME3r4H" target="_blank" title="http://sprunge.us/ME3r4H">This code</a> demonstrates a case where this causes the PR to break; but that case can be fixed. But as soon as you extend it, <a href="http://sprunge.us/nX5lDB" target="_blank" title="http://sprunge.us/nX5lDB">like this</a>, the analysis would need to be transitive (calling itself on functions the current MIR body invokes) to detect the problematic case, but that can cause cycle errors where (<code>foo</code> -&gt; <code>bar</code> -&gt; <code>foo</code>) - the PR, right now, doesn't do that, because it cycle errors.</p>
</blockquote>



<a name="190281930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281930">(Mar 11 2020 at 13:43)</a>:</h4>
<p>it's not a fix, it's just enforcing the implicit rules</p>



<a name="190281941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281941">(Mar 11 2020 at 13:43)</a>:</h4>
<p>It would have saved me some time working out what the problem was, had <span class="user-mention" data-user-id="119009">@eddyb</span>'s PR landed.</p>



<a name="190281954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281954">(Mar 11 2020 at 13:43)</a>:</h4>
<p>oops</p>



<a name="190281961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190281961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190281961">(Mar 11 2020 at 13:43)</a>:</h4>
<p>I should finish it</p>



<a name="190282100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282100">(Mar 11 2020 at 13:44)</a>:</h4>
<p>I don't quite understand the example you gave <span class="user-mention" data-user-id="116107">@davidtwco</span></p>



<a name="190282161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282161">(Mar 11 2020 at 13:45)</a>:</h4>
<p>first of all, is the <code>F: Fn()</code> bound significant?</p>



<a name="190282171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282171">(Mar 11 2020 at 13:45)</a>:</h4>
<p>all examples are going to be weird since only closures can really introduce this problem</p>



<a name="190282193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282193">(Mar 11 2020 at 13:45)</a>:</h4>
<p>It's a minimization of the ICE that comes out of the <code>rustc</code> crate when compiled with my stage one. I think it's about as small as it can get.</p>



<a name="190282264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282264">(Mar 11 2020 at 13:46)</a>:</h4>
<p>I'm guessing no</p>



<a name="190282286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282286">(Mar 11 2020 at 13:46)</a>:</h4>
<p>I don't think it is.</p>



<a name="190282298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282298">(Mar 11 2020 at 13:46)</a>:</h4>
<p>(there goes it being as small as it could be)</p>



<a name="190282340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282340">(Mar 11 2020 at 13:47)</a>:</h4>
<p>so the desired effect here</p>



<a name="190282345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282345">(Mar 11 2020 at 13:47)</a>:</h4>
<p>is that R, S are unused for <code>foo</code>?</p>



<a name="190282370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282370">(Mar 11 2020 at 13:47)</a>:</h4>
<p>except they are not, because</p>



<a name="190282376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282376">(Mar 11 2020 at 13:47)</a>:</h4>
<p>well, they are, right? :)</p>



<a name="190282397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282397">(Mar 11 2020 at 13:48)</a>:</h4>
<p>The analysis correctly determines that <code>R</code> and <code>S</code> are unused in <code>foo</code> and <code>foo::{{closure}}</code> and <code>foo::{{closure}}::{{closure}}</code>- but that causes an issue.</p>



<a name="190282434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282434">(Mar 11 2020 at 13:48)</a>:</h4>
<p>and the issue is?</p>



<a name="190282459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282459">(Mar 11 2020 at 13:48)</a>:</h4>
<p>ok, I'm starting to maybe see the connection to the drop shim</p>



<a name="190282473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282473">(Mar 11 2020 at 13:48)</a>:</h4>
<p>That code results in a drop shim <code>Instance</code> being created.</p>



<a name="190282484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282484">(Mar 11 2020 at 13:48)</a>:</h4>
<p>we have a drop shim for <code>OnDrop</code></p>



<a name="190282514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282514">(Mar 11 2020 at 13:49)</a>:</h4>
<p>or rather <code>OnDrop&lt;foo::{{closure}}::{{closure}}&gt;</code></p>



<a name="190282536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282536">(Mar 11 2020 at 13:49)</a>:</h4>
<p>which I will shorten to "fcc" :)</p>



<a name="190282568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282568">(Mar 11 2020 at 13:49)</a>:</h4>
<p>and that fcc type has a substs that would include R, S ..</p>



<a name="190282585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282585">(Mar 11 2020 at 13:49)</a>:</h4>
<p>and .. somehow .. this leads to ICE, right?</p>



<a name="190282655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282655">(Mar 11 2020 at 13:50)</a>:</h4>
<p>one thing I don't know: in your PR, if we determine a parameter is unused, during monomorphization, are we using <code>ty::Param</code> as its value?</p>



<a name="190282672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282672">(Mar 11 2020 at 13:50)</a>:</h4>
<p>I think this is what <span class="user-mention" data-user-id="119009">@eddyb</span> advocated for some time back</p>



<a name="190282718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282718">(Mar 11 2020 at 13:50)</a>:</h4>
<p>My understanding of the root problem is slightly flakey, but because <code>Instance</code> will contain the type parameters in both the <code>instance.def = InstanceDef::DropShim</code> (which contains the type because that's used for the MIR shim part), and the <code>instance.substs</code>, that causes double substitution - and an ICE as a result. I'm not sure if there are more issues with drop shims and type parameters that follow after that one, because I've not got that far.</p>



<a name="190282741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282741">(Mar 11 2020 at 13:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190282655" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190282655">said</a>:</p>
<blockquote>
<p>one thing I don't know: in your PR, if we determine a parameter is unused, during monomorphization, are we using <code>ty::Param</code> as its value?</p>
</blockquote>
<p>We replace unused parameters with the identity substitution.</p>



<a name="190282753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282753">(Mar 11 2020 at 13:51)</a>:</h4>
<p>ok so</p>



<a name="190282763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282763">(Mar 11 2020 at 13:51)</a>:</h4>
<p>let me go look at instance <em>but</em></p>



<a name="190282785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282785">(Mar 11 2020 at 13:51)</a>:</h4>
<p>well let me go look at instance, I sort of understand</p>



<a name="190282813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282813">(Mar 11 2020 at 13:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> <a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190282741" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/cycles/near/190282741">said</a>:</p>
<blockquote>
<p>We replace unused parameters with the identity substitution.</p>
</blockquote>
<p>OK, I think that's a "yes"</p>



<a name="190282843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190282843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190282843">(Mar 11 2020 at 13:51)</a>:</h4>
<p>It is, sorry.</p>



<a name="190283263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190283263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190283263">(Mar 11 2020 at 13:55)</a>:</h4>
<p>Btw, I'm enjoying being a fly on the wall for this conversation. Thanks for having it in the open!</p>



<a name="190283385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190283385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190283385">(Mar 11 2020 at 13:56)</a>:</h4>
<p>OK, I swas looking at <code>InstanceDef</code></p>



<a name="190283398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190283398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190283398">(Mar 11 2020 at 13:56)</a>:</h4>
<p>I guess I should review what <span class="user-mention" data-user-id="119009">@eddyb</span> wrote earlier</p>



<a name="190283438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190283438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190283438">(Mar 11 2020 at 13:57)</a>:</h4>
<p>I only really started understanding the ICE that I spent Sunday looking at after reading <span class="user-mention" data-user-id="119009">@eddyb</span>'s earlier messages today.</p>



<a name="190283634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190283634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190283634">(Mar 11 2020 at 13:59)</a>:</h4>
<p>I'm guessing part of the problem is that we treat <code>instance.def</code> as if it were .. huh, what's the term... not something that needs substitution, anyway</p>



<a name="190283642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190283642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190283642">(Mar 11 2020 at 13:59)</a>:</h4>
<p>like a <code>DefId</code></p>



<a name="190283700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190283700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190283700">(Mar 11 2020 at 13:59)</a>:</h4>
<p>I think so..</p>



<a name="190283887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190283887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190283887">(Mar 11 2020 at 14:01)</a>:</h4>
<p>OK, I have to run for a bit, I will re-read what <span class="user-mention" data-user-id="119009">@eddyb</span> wrote, but I guess the question for <span class="user-mention" data-user-id="119009">@eddyb</span> is whether they think they've got a solution in mind :)</p>



<a name="190283893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190283893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190283893">(Mar 11 2020 at 14:01)</a>:</h4>
<p>if so, you should probably do that, and I'll try to catch up :)</p>



<a name="190284027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190284027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190284027">(Mar 11 2020 at 14:02)</a>:</h4>
<p>I'm trying to find the code where we create an <code>InstanceDef::DropGlue</code>, to start</p>



<a name="190284235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190284235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190284235">(Mar 11 2020 at 14:04)</a>:</h4>
<ol>
<li><a href="https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc_mir/monomorphize/collector.rs#L615-L624" target="_blank" title="https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc_mir/monomorphize/collector.rs#L615-L624">https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc_mir/monomorphize/collector.rs#L615-L624</a></li>
<li><a href="https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc_mir/monomorphize/collector.rs#L650-L658" target="_blank" title="https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc_mir/monomorphize/collector.rs#L650-L658">https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc_mir/monomorphize/collector.rs#L650-L658</a></li>
<li><a href="https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc/ty/instance.rs#L340-L344" target="_blank" title="https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc/ty/instance.rs#L340-L344">https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc/ty/instance.rs#L340-L344</a></li>
<li><a href="https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc_ty/instance.rs#L35-L44" target="_blank" title="https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc_ty/instance.rs#L35-L44">https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc_ty/instance.rs#L35-L44</a></li>
</ol>



<a name="190284528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190284528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190284528">(Mar 11 2020 at 14:07)</a>:</h4>
<p>You can see that in (1) above, if the type contains type parameters, then that ends up being both in <code>instance.def</code> and <code>instance.substs</code> at (3) (I think), so you end up with the sort of scenario that <span class="user-mention" data-user-id="119009">@eddyb</span> described above:</p>
<blockquote>
<p>so <code>drop_in_place::&lt;Vec&lt;#0&gt;&gt;</code> (I'm using <code>#0</code> but this could be <code>T</code>) produces a MIR body referring to <code>Vec&lt;#0&gt;</code> but which also is going to get monomorphized by <code>{ #0 -&gt; Vec&lt;#0&gt; }</code></p>
</blockquote>



<a name="190284538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190284538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190284538">(Mar 11 2020 at 14:07)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> the problem is that <code>InstanceDef::DropGlue</code> contains a type with parameters in it, <em>and that ends up in the MIR body for the shim</em>, but those parameters shouldn't be substituted by <code>Instance</code>'s <code>substs</code> (which are for the <code>DefId</code> that we resolved to a shim, not for the shim itself)</p>



<a name="190284624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190284624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190284624">(Mar 11 2020 at 14:08)</a>:</h4>
<p>you still need <code>Instance</code> to have <code>substs</code> because we still rely on <code>(instance.def_id(), instance.substs)</code> for e.g. getting the signature</p>



<a name="190284666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190284666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190284666">(Mar 11 2020 at 14:08)</a>:</h4>
<p>but the <em>MIR body</em> is the one that needs to be treated differently</p>



<a name="190284690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190284690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190284690">(Mar 11 2020 at 14:08)</a>:</h4>
<p>codegen, miri and MIR inlining all substitute MIR bodies</p>



<a name="190284796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190284796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190284796">(Mar 11 2020 at 14:09)</a>:</h4>
<p>That clarifies things a lot.</p>



<a name="190284926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190284926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190284926">(Mar 11 2020 at 14:10)</a>:</h4>
<p>So do you think the solution for this is to modify these substitutions in some way so that drop shims can be polymorphic?</p>



<a name="190284964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190284964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190284964">(Mar 11 2020 at 14:11)</a>:</h4>
<p>yeah</p>



<a name="190284984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190284984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190284984">(Mar 11 2020 at 14:11)</a>:</h4>
<p>basically only subst for <code>InstanceDef::Item</code></p>



<a name="190285017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190285017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190285017">(Mar 11 2020 at 14:11)</a>:</h4>
<p>you'll probably get to this before I do, lol</p>



<a name="190285022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190285022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190285022">(Mar 11 2020 at 14:11)</a>:</h4>
<p>I can start on this right away.</p>



<a name="190285100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190285100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190285100">(Mar 11 2020 at 14:12)</a>:</h4>
<p>It doesn't <em>sound</em> like a large amount of work..?</p>



<a name="190285119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190285119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190285119">(Mar 11 2020 at 14:12)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/69036#issuecomment-597655036" target="_blank" title="https://github.com/rust-lang/rust/pull/69036#issuecomment-597655036">https://github.com/rust-lang/rust/pull/69036#issuecomment-597655036</a></p>



<a name="190285123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190285123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190285123">(Mar 11 2020 at 14:12)</a>:</h4>
<p>(in that I might actually be able to do it)</p>



<a name="190285692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190285692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190285692">(Mar 11 2020 at 14:17)</a>:</h4>
<p>Could you link where the MIR body gets substituted? I can only find <a href="https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc_mir/shim.rs#L172" target="_blank" title="https://github.com/rust-lang/rust/blob/303d8aff6092709edd4dbd35b1c88e9aa40bf6d8/src/librustc_mir/shim.rs#L172">this line</a> - nothing else in that file or at callers of the query.</p>



<a name="190285912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190285912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190285912">(Mar 11 2020 at 14:19)</a>:</h4>
<p>Also, would this remove the need for the vtable special-casing in the analysis, <span class="user-mention" data-user-id="119009">@eddyb</span>?</p>



<a name="190286143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190286143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190286143">(Mar 11 2020 at 14:21)</a>:</h4>
<p>ughhhh who murdered <code>ty::instance</code></p>



<a name="190286179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190286179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190286179">(Mar 11 2020 at 14:21)</a>:</h4>
<p>oh wow this is bold <a href="https://github.com/rust-lang/rust/commit/0e652c550711b301086b8f5ead2f6c90418fe7a1" target="_blank" title="https://github.com/rust-lang/rust/commit/0e652c550711b301086b8f5ead2f6c90418fe7a1">https://github.com/rust-lang/rust/commit/0e652c550711b301086b8f5ead2f6c90418fe7a1</a></p>



<a name="190286190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190286190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190286190">(Mar 11 2020 at 14:21)</a>:</h4>
<p>I hope it gets querified quick</p>



<a name="190289070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190289070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190289070">(Mar 11 2020 at 14:46)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> usually it's in a <code>fn monomorphize</code> or similar</p>



<a name="190289099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190289099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190289099">(Mar 11 2020 at 14:46)</a>:</h4>
<p>it's something like <code>subst_and_normalize</code> or similar</p>



<a name="190289153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190289153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190289153">(Mar 11 2020 at 14:47)</a>:</h4>
<p>I looked through calls to both those and nothing jumped out at me.</p>



<a name="190289215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190289215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190289215">(Mar 11 2020 at 14:47)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc_codegen_ssa/mir/mod.rs#L91-L95" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_codegen_ssa/mir/mod.rs#L91-L95">https://github.com/rust-lang/rust/blob/master/src/librustc_codegen_ssa/mir/mod.rs#L91-L95</a></p>



<a name="190289315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190289315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190289315">(Mar 11 2020 at 14:48)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I'm not sure I understand, let me check if I do.</p>



<a name="190289317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190289317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190289317">(Mar 11 2020 at 14:48)</a>:</h4>
<p>Yeah, I just couldn't find the callsite where the MIR body was passed to it, or am I misunderstanding?</p>



<a name="190289347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190289347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190289347">(Mar 11 2020 at 14:48)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> ah no only MIR inlining does that, it's a bit absurd to do it because it unnecessarily allocates</p>



<a name="190289365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190289365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190289365">(Mar 11 2020 at 14:49)</a>:</h4>
<p><code>monomorphize</code> functions are called on the fly with various bits of the original MIR</p>



<a name="190289377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190289377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190289377">(Mar 11 2020 at 14:49)</a>:</h4>
<p>I understand, alright.</p>



<a name="190293105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190293105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190293105">(Mar 11 2020 at 15:18)</a>:</h4>
<p>Is there some more specific circumstance than just "not an <code>InstanceDef::Item</code>" where I shouldn't substitute?</p>



<a name="190293155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190293155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190293155">(Mar 11 2020 at 15:19)</a>:</h4>
<p>A trivial change that only calls <code>subst_and_normalize_erasing_regions</code> for <code>InstanceDef::Item</code>, and <code>normalize_erasing_regions</code> otherwise doesn't quite work.</p>



<a name="190293522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190293522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190293522">(Mar 11 2020 at 15:21)</a>:</h4>
<p>(initially, a <code>ClosureOnceShim</code> had a <code>could not fully normalize `&lt;Self as ops::function::FnOnce&lt;Args&gt;&gt;::Output` </code>, then a <code>DropGlue</code> resulted in a <code>failed to get layout for `*mut T`: the type `T` has an unknown layout</code> if I skip <code>ClosureOnceShim</code>)</p>



<a name="190293831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190293831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190293831">(Mar 11 2020 at 15:24)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> hmm can you limit it to these 3 <a href="https://github.com/rust-lang/rust/pull/69036/files#diff-44a4a8b18aebfe4cd2261ccc019a1f0fR42-R75" target="_blank" title="https://github.com/rust-lang/rust/pull/69036/files#diff-44a4a8b18aebfe4cd2261ccc019a1f0fR42-R75">https://github.com/rust-lang/rust/pull/69036/files#diff-44a4a8b18aebfe4cd2261ccc019a1f0fR42-R75</a></p>



<a name="190293999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190293999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190293999">(Mar 11 2020 at 15:25)</a>:</h4>
<p>trying that</p>



<a name="190294544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190294544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190294544">(Mar 11 2020 at 15:29)</a>:</h4>
<p>It still ICEs,  <code>could not fully normalize `(i32, &lt;F as float::Float&gt;::Int)` </code> somewhere in <code>libcore</code>.</p>



<a name="190294856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190294856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190294856">(Mar 11 2020 at 15:31)</a>:</h4>
<p>nevermind, user error</p>



<a name="190295086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295086">(Mar 11 2020 at 15:33)</a>:</h4>
<p>Alright, that gets me back to the layout error that I sent previously - which makes sense, last time when I stopped doing <code>ClosureOnceShim</code>, the next failure was from a <code>DropGlue</code>, makes sense that it would be first now.</p>



<a name="190295362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295362">(Mar 11 2020 at 15:35)</a>:</h4>
<p>is this with polymorphization turned on or not?</p>



<a name="190295371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295371">(Mar 11 2020 at 15:35)</a>:</h4>
<p>Ugh, viewing the logs gives me a different ICE.</p>



<a name="190295373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295373">(Mar 11 2020 at 15:35)</a>:</h4>
<p>On</p>



<a name="190295398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295398">(Mar 11 2020 at 15:35)</a>:</h4>
<p>Just in my current working directory</p>



<a name="190295459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295459">(Mar 11 2020 at 15:36)</a>:</h4>
<p>(without any of the fixes I did for drop shims, just what the PR has)</p>



<a name="190295530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295530">(Mar 11 2020 at 15:37)</a>:</h4>
<p>(sorry for the topic change but it was bothering me)</p>



<a name="190295554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295554">(Mar 11 2020 at 15:37)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> so uhh I would always try something like this on fresh master</p>



<a name="190295584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295584">(Mar 11 2020 at 15:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> [said](<a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20(w.2F.20cycle.20haz.2E.2E.2E/near/190295371)" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20(w.2F.20cycle.20haz.2E.2E.2E/near/190295371)">https://rust-lang.zulipchat.com/#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20(w.2F.20cycle.20haz.2E.2E.2E/near/190295371)</a>:</p>
<blockquote>
<p>Ugh, viewing the logs gives me a different ICE.</p>
</blockquote>
<p>egads I hate that so much :)</p>



<a name="190295610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295610">(Mar 11 2020 at 15:37)</a>:</h4>
<p>oh uh the parens break links so sorry</p>



<a name="190295714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295714">(Mar 11 2020 at 15:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles/near/190295610" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles/near/190295610">said</a>:</p>
<blockquote>
<p>oh uh the parens break links so sorry</p>
</blockquote>
<p>should file this upstream with Zulip, will make a note to</p>



<a name="190295731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190295731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190295731">(Mar 11 2020 at 15:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles/near/190295554" title="#narrow/stream/216091-t-compiler.2Fwg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles/near/190295554">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116107">davidtwco</span> so uhh I would always try something like this on fresh master</p>
</blockquote>
<p>that is, to iron out the kinks without any interference</p>



<a name="190296189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296189">(Mar 11 2020 at 15:42)</a>:</h4>
<p>I probably should do that.</p>



<a name="190296256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296256">(Mar 11 2020 at 15:43)</a>:</h4>
<p><code>drop_in_place</code> with substs <code>&amp;[u8]</code> is what has the <code>*mut T</code>comes from.</p>



<a name="190296445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296445">(Mar 11 2020 at 15:44)</a>:</h4>
<p>aaaaah</p>



<a name="190296461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296461">(Mar 11 2020 at 15:44)</a>:</h4>
<p>wait what</p>



<a name="190296478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296478">(Mar 11 2020 at 15:44)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> can you get a backtrace?</p>



<a name="190296593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296593">(Mar 11 2020 at 15:45)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> presumably the shim building code needs to be changed not to do that :P</p>



<a name="190296604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296604">(Mar 11 2020 at 15:45)</a>:</h4>
<div class="codehilite"><pre><span></span>[DEBUG rustc_codegen_ssa::mir::analyze] non_ssa_locals: fx.instance=Instance { def: DropGlue(DefId(0:1502 ~ core[9627]::ptr[0]::drop_in_place[0]), None), substs: [&amp;u8] }
[DEBUG rustc_codegen_ssa::mir::analyze] non_ssa_locals: fx.instance=Instance { def: DropGlue(DefId(0:1502 ~ core[9627]::ptr[0]::drop_in_place[0]), None), substs: [&amp;u8] }
error: internal compiler error: src/librustc_codegen_llvm/context.rs:900: failed to get layout for `*mut T`: the type `T` has an unknown layout

thread &#39;rustc&#39; panicked at &#39;Box&lt;Any&gt;&#39;, src/librustc_errors/lib.rs:875:9
stack backtrace:
   0: backtrace::backtrace::libunwind::trace
             at /home/david/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.44/src/backtrace/libunwind.rs:86
   1: backtrace::backtrace::trace_unsynchronized
             at /home/david/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.44/src/backtrace/mod.rs:66
   2: std::sys_common::backtrace::_print_fmt
             at src/libstd/sys_common/backtrace.rs:78
   3: &lt;std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display&gt;::fmt
             at src/libstd/sys_common/backtrace.rs:59
   4: core::fmt::write
             at src/libcore/fmt/mod.rs:1053
   5: std::io::Write::write_fmt
             at src/libstd/io/mod.rs:1428
   6: std::sys_common::backtrace::_print
             at src/libstd/sys_common/backtrace.rs:62
   7: std::sys_common::backtrace::print
             at src/libstd/sys_common/backtrace.rs:49
   8: std::panicking::default_hook::{{closure}}
             at src/libstd/panicking.rs:204
   9: std::panicking::default_hook
             at src/libstd/panicking.rs:224
  10: &lt;alloc::boxed::Box&lt;F&gt; as core::ops::function::Fn&lt;A&gt;&gt;::call
             at ./src/liballoc/boxed.rs:1031
  11: rustc_driver::report_ice
             at src/librustc_driver/lib.rs:1183
  12: std::panicking::rust_panic_with_hook
             at src/libstd/panicking.rs:474
  13: std::panicking::begin_panic
             at ./src/libstd/panicking.rs:397
  14: rustc_errors::HandlerInner::bug
             at src/librustc_errors/lib.rs:875
  15: rustc_errors::Handler::bug
             at src/librustc_errors/lib.rs:646
  16: rustc::util::bug::opt_span_bug_fmt::{{closure}}
             at src/librustc/util/bug.rs:36
  17: rustc::ty::context::tls::with_opt::{{closure}}
             at src/librustc/ty/context.rs:1829
  18: rustc::ty::context::tls::with_context_opt
             at src/librustc/ty/context.rs:1781
  19: rustc::ty::context::tls::with_opt
             at src/librustc/ty/context.rs:1829
  20: rustc::util::bug::opt_span_bug_fmt
             at src/librustc/util/bug.rs:32
  21: rustc::util::bug::bug_fmt
             at src/librustc/util/bug.rs:12
  22: &lt;rustc_codegen_llvm::context::CodegenCx as rustc_target::abi::LayoutOf&gt;::spanned_layout_of::{{closure}}
             at src/librustc_codegen_llvm/context.rs:900
  23: core::result::Result&lt;T,E&gt;::unwrap_or_else
             at ./src/libcore/result.rs:851
  24: &lt;rustc_codegen_llvm::context::CodegenCx as rustc_target::abi::LayoutOf&gt;::spanned_layout_of
             at src/librustc_codegen_llvm/context.rs:896
  25: rustc_codegen_ssa::mir::analyze::non_ssa_locals
             at ./src/librustc_codegen_ssa/mir/analyze.rs:29
  26: rustc_codegen_ssa::mir::codegen_mir
             at ./src/librustc_codegen_ssa/mir/mod.rs:196
  27: rustc_codegen_ssa::base::codegen_instance
             at ./src/librustc_codegen_ssa/base.rs:389
  28: &lt;rustc::mir::mono::MonoItem as rustc_codegen_ssa::mono_item::MonoItemExt&gt;::define
             at ./src/librustc_codegen_ssa/mono_item.rs:42
  29: rustc_codegen_llvm::base::compile_codegen_unit::module_codegen
             at src/librustc_codegen_llvm/base.rs:130
  30: rustc::dep_graph::graph::DepGraph::with_task_impl::{{closure}}::{{closure}}
             at ./src/librustc/dep_graph/graph.rs:286
  31: rustc::ty::context::tls::enter_context::{{closure}}
             at ./src/librustc/ty/context.rs:1720
  32: rustc::ty::context::tls::set_tlv
             at ./src/librustc/ty/context.rs:1704
  33: rustc::ty::context::tls::enter_context
             at ./src/librustc/ty/context.rs:1720
  34: rustc::dep_graph::graph::DepGraph::with_task_impl::{{closure}}
             at ./src/librustc/dep_graph/graph.rs:286
  35: rustc::ty::context::tls::with_context::{{closure}}
             at ./src/librustc/ty/context.rs:1792
  36: rustc::ty::context::tls::with_context_opt
             at ./src/librustc/ty/context.rs:1781
  37: rustc::ty::context::tls::with_context
             at ./src/librustc/ty/context.rs:1792
  38: rustc::dep_graph::graph::DepGraph::with_task_impl
             at ./src/librustc/dep_graph/graph.rs:282
  39: rustc::dep_graph::graph::DepGraph::with_task
             at ./src/librustc/dep_graph/graph.rs:209
  40: rustc_codegen_llvm::base::compile_codegen_unit
             at src/librustc_codegen_llvm/base.rs:109
  41: &lt;rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_ssa::traits::backend::ExtraBackendMethods&gt;::compile_codegen_unit
             at src/librustc_codegen_llvm/lib.rs:109
  42: rustc_codegen_ssa::base::codegen_crate
             at ./src/librustc_codegen_ssa/base.rs:678
  43: &lt;rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_utils::codegen_backend::CodegenBackend&gt;::codegen_crate
             at src/librustc_codegen_llvm/lib.rs:259
  44: rustc_interface::passes::start_codegen::{{closure}}
             at src/librustc_interface/passes.rs:964
  45: rustc_data_structures::profiling::VerboseTimingGuard::run
             at ./src/librustc_data_structures/profiling.rs:569
  46: rustc_session::utils::&lt;impl rustc_session::session::Session&gt;::time
             at ./src/librustc_session/utils.rs:9
  47: rustc_interface::passes::start_codegen
             at src/librustc_interface/passes.rs:963
  48: rustc_interface::queries::Queries::ongoing_codegen::{{closure}}::{{closure}}
             at src/librustc_interface/queries.rs:280
  49: rustc_interface::passes::QueryContext::enter::{{closure}}
             at src/librustc_interface/passes.rs:696
  50: rustc::ty::context::tls::enter_global::{{closure}}
             at ./src/librustc/ty/context.rs:1743
  51: rustc::ty::context::tls::enter_context::{{closure}}
             at ./src/librustc/ty/context.rs:1720
  52: rustc::ty::context::tls::set_tlv
             at ./src/librustc/ty/context.rs:1704
  53: rustc::ty::context::tls::enter_context
             at ./src/librustc/ty/context.rs:1720
  54: rustc::ty::context::tls::enter_global
             at ./src/librustc/ty/context.rs:1743
  55: rustc_interface::passes::QueryContext::enter
             at src/librustc_interface/passes.rs:696
  56: rustc_interface::queries::Queries::ongoing_codegen::{{closure}}
             at src/librustc_interface/queries.rs:274
  57: rustc_interface::queries::Query&lt;T&gt;::compute
             at src/librustc_interface/queries.rs:33
  58: rustc_interface::queries::Queries::ongoing_codegen
             at src/librustc_interface/queries.rs:272
  59: rustc_driver::run_compiler::{{closure}}::{{closure}}
             at src/librustc_driver/lib.rs:402
  60: rustc_interface::queries::&lt;impl rustc_interface::interface::Compiler&gt;::enter
             at ./src/librustc_interface/queries.rs:339
  61: rustc_driver::run_compiler::{{closure}}
             at src/librustc_driver/lib.rs:292
  62: rustc_interface::interface::run_compiler_in_existing_thread_pool
             at ./src/librustc_interface/interface.rs:199
  63: rustc_interface::interface::run_compiler::{{closure}}
             at ./src/librustc_interface/interface.rs:213
  64: rustc_interface::util::spawn_thread_pool::{{closure}}::{{closure}}::{{closure}}
             at ./src/librustc_interface/util.rs:155
  65: scoped_tls::ScopedKey&lt;T&gt;::set
             at /home/david/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:137
  66: rustc_interface::util::spawn_thread_pool::{{closure}}::{{closure}}
             at ./src/librustc_interface/util.rs:151
  67: scoped_tls::ScopedKey&lt;T&gt;::set
             at /home/david/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:137
  68: rustc_ast::attr::with_globals::{{closure}}
             at ./src/librustc_ast/attr/mod.rs:44
  69: scoped_tls::ScopedKey&lt;T&gt;::set
             at /home/david/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:137
  70: rustc_ast::attr::with_globals
             at ./src/librustc_ast/attr/mod.rs:44
  71: rustc_interface::util::spawn_thread_pool::{{closure}}
             at ./src/librustc_interface/util.rs:150
  72: rustc_interface::util::scoped_thread::{{closure}}
             at ./src/librustc_interface/util.rs:125
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.

note: the compiler unexpectedly panicked. this is a bug.

note: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports

note: rustc 1.43.0-dev running on x86_64-unknown-linux-gnu

note: compiler flags: -Z macro-backtrace -Z binary-dep-depinfo -Z force-unstable-if-unmarked -C opt-level=3 -C debuginfo=1 -C incremental -C link-args=-Wl,-rpath,$ORIGIN/../lib -C prefer-dynamic -C llvm-args=-import-instr-limit=10 -C debug-assertions=y --crate-type lib

note: some of the compiler flags provided by cargo are hidden

query stack during panic:
end of query stack
error: aborting due to previous error

error: could not compile `core`.
warning: build failed, waiting for other jobs to finish...
</pre></div>



<a name="190296732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296732">(Mar 11 2020 at 15:46)</a>:</h4>
<p>okay so it's an argument local</p>



<a name="190296747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296747">(Mar 11 2020 at 15:46)</a>:</h4>
<p>(I added that log statement to <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_codegen_ssa/mir/analyze.rs#L28" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_codegen_ssa/mir/analyze.rs#L28">just before this line</a> with a <code>target: </code> so I could enable that and not anything else)</p>



<a name="190296812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296812">(Mar 11 2020 at 15:47)</a>:</h4>
<p>OOOOH <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/shim.rs#L175-L179" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/shim.rs#L175-L179">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/shim.rs#L175-L179</a></p>



<a name="190296860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296860">(Mar 11 2020 at 15:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> <span class="user-mention" data-user-id="116009">@nikomatsakis</span> we kind of have a <code>DropTrivial</code> polymorphic shim already lmao</p>



<a name="190296899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296899">(Mar 11 2020 at 15:47)</a>:</h4>
<p>you need to special-case <code>DropGlue { ty: Some(_)</code> only</p>



<a name="190296962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190296962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190296962">(Mar 11 2020 at 15:48)</a>:</h4>
<p>when it's <code>None</code> it's the noop version</p>



<a name="190297054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190297054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190297054">(Mar 11 2020 at 15:49)</a>:</h4>
<p>to clarify, special-case to not subst when <code>Some(_)</code>, or the opposite?</p>



<a name="190297080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190297080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190297080">(Mar 11 2020 at 15:49)</a>:</h4>
<p>former</p>



<a name="190297136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190297136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190297136">(Mar 11 2020 at 15:49)</a>:</h4>
<p>because in the <code>None</code> case substitution is necessary since it's exactly as polymorphic as <code>DefId</code></p>



<a name="190297316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190297316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190297316">(Mar 11 2020 at 15:50)</a>:</h4>
<p>Ooo, now I get the ICE that I got when I had logs.</p>



<a name="190298395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190298395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190298395">(Mar 11 2020 at 15:58)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> the suspense is killing me :P</p>



<a name="190298402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190298402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190298402">(Mar 11 2020 at 15:59)</a>:</h4>
<div class="codehilite"><pre><span></span>[DEBUG rustc_codegen_ssa::mir::analyze] process_place: base_ty=PlaceTy { ty: Args, variant_index: None } self.instance=Instance { def: FnPtrShim(DefId(0:2087 ~ core[9627]::ops[0]::function[0]::FnOnce[0]::call_once[0]), for&lt;&#39;r, &#39;s&gt; fn(&amp;&#39;r usize, &amp;&#39;s usize) -&gt; cmp::Ordering {&lt;usize as cmp::Ord&gt;::cmp}), substs: [for&lt;&#39;r, &#39;s&gt; fn(&amp;&#39;r usize, &amp;&#39;s usize) -&gt; cmp::Ordering {&lt;usize as cmp::Ord&gt;::cmp}, (&amp;usize, &amp;usize)] }
error: internal compiler error: src/librustc_codegen_llvm/context.rs:900: failed to get layout for `Args`: the type `Args` has an unknown layout

thread &#39;rustc&#39; panicked at &#39;Box&lt;Any&gt;&#39;, src/librustc_errors/lib.rs:875:9
stack backtrace:
   0: backtrace::backtrace::libunwind::trace
             at /home/david/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.44/src/backtrace/libunwind.rs:86
   1: backtrace::backtrace::trace_unsynchronized
             at /home/david/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.44/src/backtrace/mod.rs:66
   2: std::sys_common::backtrace::_print_fmt
             at src/libstd/sys_common/backtrace.rs:78
   3: &lt;std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display&gt;::fmt
             at src/libstd/sys_common/backtrace.rs:59
   4: core::fmt::write
             at src/libcore/fmt/mod.rs:1053
   5: std::io::Write::write_fmt
             at src/libstd/io/mod.rs:1428
   6: std::sys_common::backtrace::_print
             at src/libstd/sys_common/backtrace.rs:62
   7: std::sys_common::backtrace::print
             at src/libstd/sys_common/backtrace.rs:49
   8: std::panicking::default_hook::{{closure}}
             at src/libstd/panicking.rs:204
   9: std::panicking::default_hook
             at src/libstd/panicking.rs:224
  10: &lt;alloc::boxed::Box&lt;F&gt; as core::ops::function::Fn&lt;A&gt;&gt;::call
             at ./src/liballoc/boxed.rs:1031
  11: rustc_driver::report_ice
             at src/librustc_driver/lib.rs:1183
  12: std::panicking::rust_panic_with_hook
             at src/libstd/panicking.rs:474
  13: std::panicking::begin_panic
             at ./src/libstd/panicking.rs:397
  14: rustc_errors::HandlerInner::bug
             at src/librustc_errors/lib.rs:875
  15: rustc_errors::Handler::bug
             at src/librustc_errors/lib.rs:646
  16: rustc::util::bug::opt_span_bug_fmt::{{closure}}
             at src/librustc/util/bug.rs:36
  17: rustc::ty::context::tls::with_opt::{{closure}}
             at src/librustc/ty/context.rs:1829
  18: rustc::ty::context::tls::with_context_opt
             at src/librustc/ty/context.rs:1781
  19: rustc::ty::context::tls::with_opt
             at src/librustc/ty/context.rs:1829
  20: rustc::util::bug::opt_span_bug_fmt
             at src/librustc/util/bug.rs:32
  21: rustc::util::bug::bug_fmt
             at src/librustc/util/bug.rs:12
  22: &lt;rustc_codegen_llvm::context::CodegenCx as rustc_target::abi::LayoutOf&gt;::spanned_layout_of::{{closure}}
             at src/librustc_codegen_llvm/context.rs:900
  23: core::result::Result&lt;T,E&gt;::unwrap_or_else
             at ./src/libcore/result.rs:851
  24: &lt;rustc_codegen_llvm::context::CodegenCx as rustc_target::abi::LayoutOf&gt;::spanned_layout_of
             at src/librustc_codegen_llvm/context.rs:896
  25: rustc_codegen_ssa::mir::analyze::LocalAnalyzer&lt;Bx&gt;::process_place
             at ./src/librustc_codegen_ssa/mir/analyze.rs:134
  26: &lt;rustc_codegen_ssa::mir::analyze::LocalAnalyzer&lt;Bx&gt; as rustc::mir::visit::Visitor&gt;::visit_place
             at ./src/librustc_codegen_ssa/mir/analyze.rs:266
  27: rustc::mir::visit::Visitor::super_operand
             at ./src/librustc/mir/visit.rs:677
  28: rustc::mir::visit::Visitor::visit_operand
             at ./src/librustc/mir/visit.rs:141
  29: rustc::mir::visit::Visitor::super_terminator_kind
             at ./src/librustc/mir/visit.rs:494
  30: &lt;rustc_codegen_ssa::mir::analyze::LocalAnalyzer&lt;Bx&gt; as rustc::mir::visit::Visitor&gt;::visit_terminator_kind
             at ./src/librustc_codegen_ssa/mir/analyze.rs:261
  31: rustc::mir::visit::Visitor::super_terminator
             at ./src/librustc/mir/visit.rs:432
  32: rustc::mir::visit::Visitor::visit_terminator
             at ./src/librustc/mir/visit.rs:117
  33: rustc::mir::visit::Visitor::super_basic_block_data
             at ./src/librustc/mir/visit.rs:328
  34: rustc::mir::visit::Visitor::visit_basic_block_data
             at ./src/librustc/mir/visit.rs:93
  35: rustc::mir::visit::Visitor::super_body
             at ./src/librustc/mir/visit.rs:275
  36: rustc::mir::visit::Visitor::visit_body
             at ./src/librustc/mir/visit.rs:87
  37: rustc_codegen_ssa::mir::analyze::non_ssa_locals
             at ./src/librustc_codegen_ssa/mir/analyze.rs:23
  38: rustc_codegen_ssa::mir::codegen_mir
             at ./src/librustc_codegen_ssa/mir/mod.rs:196
  39: rustc_codegen_ssa::base::codegen_instance
             at ./src/librustc_codegen_ssa/base.rs:389
  40: &lt;rustc::mir::mono::MonoItem as rustc_codegen_ssa::mono_item::MonoItemExt&gt;::define
             at ./src/librustc_codegen_ssa/mono_item.rs:42
  41: rustc_codegen_llvm::base::compile_codegen_unit::module_codegen
             at src/librustc_codegen_llvm/base.rs:130
  42: rustc::dep_graph::graph::DepGraph::with_task_impl::{{closure}}::{{closure}}
             at ./src/librustc/dep_graph/graph.rs:286
  43: rustc::ty::context::tls::enter_context::{{closure}}
             at ./src/librustc/ty/context.rs:1720
  44: rustc::ty::context::tls::set_tlv
             at ./src/librustc/ty/context.rs:1704
  45: rustc::ty::context::tls::enter_context
             at ./src/librustc/ty/context.rs:1720
  46: rustc::dep_graph::graph::DepGraph::with_task_impl::{{closure}}
             at ./src/librustc/dep_graph/graph.rs:286
  47: rustc::ty::context::tls::with_context::{{closure}}
             at ./src/librustc/ty/context.rs:1792
  48: rustc::ty::context::tls::with_context_opt
             at ./src/librustc/ty/context.rs:1781
  49: rustc::ty::context::tls::with_context
             at ./src/librustc/ty/context.rs:1792
  50: rustc::dep_graph::graph::DepGraph::with_task_impl
             at ./src/librustc/dep_graph/graph.rs:282
  51: rustc::dep_graph::graph::DepGraph::with_task
             at ./src/librustc/dep_graph/graph.rs:209
  52: rustc_codegen_llvm::base::compile_codegen_unit
             at src/librustc_codegen_llvm/base.rs:109
  53: &lt;rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_ssa::traits::backend::ExtraBackendMethods&gt;::compile_codegen_unit
             at src/librustc_codegen_llvm/lib.rs:109
  54: rustc_codegen_ssa::base::codegen_crate
             at ./src/librustc_codegen_ssa/base.rs:678
  55: &lt;rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_utils::codegen_backend::CodegenBackend&gt;::codegen_crate
             at src/librustc_codegen_llvm/lib.rs:259
  56: rustc_interface::passes::start_codegen::{{closure}}
             at src/librustc_interface/passes.rs:964
  57: rustc_data_structures::profiling::VerboseTimingGuard::run
             at ./src/librustc_data_structures/profiling.rs:569
  58: rustc_session::utils::&lt;impl rustc_session::session::Session&gt;::time
             at ./src/librustc_session/utils.rs:9
  59: rustc_interface::passes::start_codegen
             at src/librustc_interface/passes.rs:963
  60: rustc_interface::queries::Queries::ongoing_codegen::{{closure}}::{{closure}}
             at src/librustc_interface/queries.rs:280
  61: rustc_interface::passes::QueryContext::enter::{{closure}}
             at src/librustc_interface/passes.rs:696
  62: rustc::ty::context::tls::enter_global::{{closure}}
             at ./src/librustc/ty/context.rs:1743
  63: rustc::ty::context::tls::enter_context::{{closure}}
             at ./src/librustc/ty/context.rs:1720
  64: rustc::ty::context::tls::set_tlv
             at ./src/librustc/ty/context.rs:1704
  65: rustc::ty::context::tls::enter_context
             at ./src/librustc/ty/context.rs:1720
  66: rustc::ty::context::tls::enter_global
             at ./src/librustc/ty/context.rs:1743
  67: rustc_interface::passes::QueryContext::enter
             at src/librustc_interface/passes.rs:696
  68: rustc_interface::queries::Queries::ongoing_codegen::{{closure}}
             at src/librustc_interface/queries.rs:274
  69: rustc_interface::queries::Query&lt;T&gt;::compute
             at src/librustc_interface/queries.rs:33
  70: rustc_interface::queries::Queries::ongoing_codegen
             at src/librustc_interface/queries.rs:272
  71: rustc_driver::run_compiler::{{closure}}::{{closure}}
             at src/librustc_driver/lib.rs:402
  72: rustc_interface::queries::&lt;impl rustc_interface::interface::Compiler&gt;::enter
             at ./src/librustc_interface/queries.rs:339
  73: rustc_driver::run_compiler::{{closure}}
             at src/librustc_driver/lib.rs:292
  74: rustc_interface::interface::run_compiler_in_existing_thread_pool
             at ./src/librustc_interface/interface.rs:199
  75: rustc_interface::interface::run_compiler::{{closure}}
             at ./src/librustc_interface/interface.rs:213
  76: rustc_interface::util::spawn_thread_pool::{{closure}}::{{closure}}::{{closure}}
             at ./src/librustc_interface/util.rs:155
  77: scoped_tls::ScopedKey&lt;T&gt;::set
             at /home/david/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:137
  78: rustc_interface::util::spawn_thread_pool::{{closure}}::{{closure}}
             at ./src/librustc_interface/util.rs:151
  79: scoped_tls::ScopedKey&lt;T&gt;::set
             at /home/david/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:137
  80: rustc_ast::attr::with_globals::{{closure}}
             at ./src/librustc_ast/attr/mod.rs:44
  81: scoped_tls::ScopedKey&lt;T&gt;::set
             at /home/david/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:137
  82: rustc_ast::attr::with_globals
             at ./src/librustc_ast/attr/mod.rs:44
...
</pre></div>



<a name="190298427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190298427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190298427">(Mar 11 2020 at 15:59)</a>:</h4>
<p>I was trying to work something out before stealing more of your time, but there you go.</p>



<a name="190298456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190298456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190298456">(Mar 11 2020 at 15:59)</a>:</h4>
<p>oh that's a <code>Fn</code> traits shim</p>



<a name="190298595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190298595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190298595">(Mar 11 2020 at 16:00)</a>:</h4>
<p>you can comment out <code>FnPtrShim</code> for now and leave a FIXME comment I guess?</p>



<a name="190298654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190298654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190298654">(Mar 11 2020 at 16:01)</a>:</h4>
<p>presumably <code>Args</code> is the pseudo-VG tuple type parameter and it's obtained from the <code>substs</code></p>



<a name="190298683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190298683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190298683">(Mar 11 2020 at 16:01)</a>:</h4>
<p>wait why would <code>FnPtrShim</code> need to exist like that</p>



<a name="190298784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190298784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190298784">(Mar 11 2020 at 16:02)</a>:</h4>
<p>As far as I can tell, that <code>Ord</code> impl is implemented by the derive.</p>



<a name="190298863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190298863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190298863">(Mar 11 2020 at 16:02)</a>:</h4>
<p><code>FnPtrShim</code> should probably be like <code>ClosureOnceShim</code></p>



<a name="190298894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190298894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190298894">(Mar 11 2020 at 16:03)</a>:</h4>
<p>oh right we don't have proper untupling yet ughh</p>



<a name="190299037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299037">(Mar 11 2020 at 16:04)</a>:</h4>
<p>the problem is the shim needs to be something like this:</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">call_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span><span class="p">(...</span><span class="n">args</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="190299131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299131">(Mar 11 2020 at 16:05)</a>:</h4>
<p>and we can do the first <code>...</code> but can't do the second one (it's triggered by <code>extern "rust-call"</code> and we haven't fixed that mess yet)</p>



<a name="190299276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299276">(Mar 11 2020 at 16:06)</a>:</h4>
<div class="codehilite"><pre><span></span>[DEBUG rustc_codegen_ssa::mir::analyze] process_place: elem_ty=Self self.instance=Instance { def: VtableShim(DefId(2:2087 ~ core[9627]::ops[0]::function[0]::FnOnce[0]::call_once[0])), substs: [[closure@/home/david/.cargo/registry/src/github.com-1ecc6299db9ec823/backtrace-0.3.44/src/symbolize/libbacktrace.rs:464:22: 467:14 called:&amp;mut bool, cb:&amp;mut &amp;mut dyn for&lt;&#39;r&gt; rustc_std_workspace_core::ops::FnMut(&amp;&#39;r symbolize::Symbol)], (&amp;symbolize::Symbol,)] }
error: internal compiler error: src/librustc_codegen_llvm/context.rs:900: failed to get layout for `Self`: the type `Self` has an unknown layout

thread &#39;rustc&#39; panicked at &#39;Box&lt;Any&gt;&#39;, src/librustc_errors/lib.rs:875:9
stack backtrace:
   0: backtrace::backtrace::libunwind::trace
             at ./src/backtrace/libunwind.rs:86
   1: backtrace::backtrace::trace_unsynchronized
             at ./src/backtrace/mod.rs:66
   2: std::sys_common::backtrace::_print_fmt
             at src/libstd/sys_common/backtrace.rs:78
   3: &lt;std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display&gt;::fmt
             at src/libstd/sys_common/backtrace.rs:59
   4: core::fmt::write
             at src/libcore/fmt/mod.rs:1053
   5: std::io::Write::write_fmt
             at src/libstd/io/mod.rs:1428
   6: std::sys_common::backtrace::_print
             at src/libstd/sys_common/backtrace.rs:62
   7: std::sys_common::backtrace::print
             at src/libstd/sys_common/backtrace.rs:49
   8: std::panicking::default_hook::{{closure}}
             at src/libstd/panicking.rs:204
   9: std::panicking::default_hook
             at src/libstd/panicking.rs:224
  10: &lt;alloc::boxed::Box&lt;F&gt; as core::ops::function::Fn&lt;A&gt;&gt;::call
             at /home/david/projects/rust/rust0/src/liballoc/boxed.rs:1031
  11: rustc_driver::report_ice
             at src/librustc_driver/lib.rs:1183
  12: std::panicking::rust_panic_with_hook
             at src/libstd/panicking.rs:474
  13: std::panicking::begin_panic
             at /home/david/projects/rust/rust0/src/libstd/panicking.rs:397
  14: rustc_errors::HandlerInner::bug
             at src/librustc_errors/lib.rs:875
  15: rustc_errors::Handler::bug
             at src/librustc_errors/lib.rs:646
  16: rustc::util::bug::opt_span_bug_fmt::{{closure}}
             at src/librustc/util/bug.rs:36
  17: rustc::ty::context::tls::with_opt::{{closure}}
             at src/librustc/ty/context.rs:1829
  18: rustc::ty::context::tls::with_context_opt
             at src/librustc/ty/context.rs:1781
  19: rustc::ty::context::tls::with_opt
             at src/librustc/ty/context.rs:1829
  20: rustc::util::bug::opt_span_bug_fmt
             at src/librustc/util/bug.rs:32
  21: rustc::util::bug::bug_fmt
             at src/librustc/util/bug.rs:12
  22: &lt;rustc_codegen_llvm::context::CodegenCx as rustc_target::abi::LayoutOf&gt;::spanned_layout_of::{{closure}}
             at src/librustc_codegen_llvm/context.rs:900
  23: core::result::Result&lt;T,E&gt;::unwrap_or_else
             at /home/david/projects/rust/rust0/src/libcore/result.rs:851
  24: &lt;rustc_codegen_llvm::context::CodegenCx as rustc_target::abi::LayoutOf&gt;::spanned_layout_of
             at src/librustc_codegen_llvm/context.rs:896
  25: rustc_codegen_ssa::mir::analyze::LocalAnalyzer&lt;Bx&gt;::process_place
             at /home/david/projects/rust/rust0/src/librustc_codegen_ssa/mir/analyze.rs:129
</pre></div>



<a name="190299298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299298">(Mar 11 2020 at 16:06)</a>:</h4>
<p>Same thing, but vtables?</p>



<a name="190299326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299326">(Mar 11 2020 at 16:06)</a>:</h4>
<p>is this with polymorphization on?</p>



<a name="190299336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299336">(Mar 11 2020 at 16:06)</a>:</h4>
<p>It is</p>



<a name="190299350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299350">(Mar 11 2020 at 16:06)</a>:</h4>
<p>I've not split off another directory yet.</p>



<a name="190299367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299367">(Mar 11 2020 at 16:07)</a>:</h4>
<p>It does have the "vtable workaround" that I added.</p>



<a name="190299378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299378">(Mar 11 2020 at 16:07)</a>:</h4>
<p>do that first before it drives you mad :P</p>



<a name="190299417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299417">(Mar 11 2020 at 16:07)</a>:</h4>
<p>I can't at a glance figure out what's at fault here</p>



<a name="190299439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299439">(Mar 11 2020 at 16:07)</a>:</h4>
<p>I suppose, but I'll need to solve these ICEs as soon as I rebase on top of the branch that does this w/out.</p>



<a name="190299484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299484">(Mar 11 2020 at 16:07)</a>:</h4>
<p>I mean, we need to fix vtables anyway, I suppose?</p>



<a name="190299548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299548">(Mar 11 2020 at 16:08)</a>:</h4>
<p>whatever their problem is</p>



<a name="190299595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299595">(Mar 11 2020 at 16:08)</a>:</h4>
<p>getting another directory up-to-date, will be a moment</p>



<a name="190299680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299680">(Mar 11 2020 at 16:09)</a>:</h4>
<p>but also I need to leave, they're going to sanitize the office soon</p>



<a name="190299725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190299725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190299725">(Mar 11 2020 at 16:09)</a>:</h4>
<p>(I don't open Zulip on my phone because my battery dreads it but feel free to PM me on Discord)</p>



<a name="190322983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing%20shims%20vs%20transitive%20analysis%20w/%20cycles/near/190322983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/216091-t-compiler/wg-polymorphization/topic/polymorphizing.20shims.20vs.20transitive.20analysis.20w.2F.20cycles.html#190322983">(Mar 11 2020 at 19:43)</a>:</h4>
<p>For those following along at home, <a href="https://github.com/rust-lang/rust/issues/69935" target="_blank" title="https://github.com/rust-lang/rust/issues/69935">#69935</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>