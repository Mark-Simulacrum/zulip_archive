<html>
<head><meta charset="utf-8"><title>#46589 kill borrows after assignment ¬∑ t-compiler/wg-nll ¬∑ Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/index.html">t-compiler/wg-nll</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html">#46589 kill borrows after assignment</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="151013855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151013855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151013855">(Dec 06 2018 at 15:20)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Picked up this issue today to finish it off, doesn't look like there's much to do. I've got a fix locally that's a really minor change but it isn't what you suggested in the issue, so just want to double check I've not did something too naive.</p>
<p>Am I right in understanding that the original issue was that if you assigned into a variable then that didn't kill any borrows of a projection of that variable? And what wasn't then finished was that if you assigned into a projection, instead of directly into a local, then it still doesn't kill any borrows.</p>
<p>I've got a naive fix that effectively just makes it work for deref projections too - this removes the error on the remaining test case you had in a comment. Am I right in my understanding that we don't actually want all borrows of a local to get killed for other types of projections - eg. field accesses, indexing? It doesn't touch the place conflict code that you suggested (though I did implement the change you suggested before being unable to work out where it fit into the problem).</p>



<a name="151017116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151017116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151017116">(Dec 06 2018 at 15:58)</a>:</h4>
<p>I'll have to refresh my memory, <span class="user-mention" data-user-id="116107">@davidtwco</span></p>



<a name="151017133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151017133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151017133">(Dec 06 2018 at 15:58)</a>:</h4>
<p>No worries, appreciate you taking a look.</p>



<a name="151231013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151231013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151231013">(Dec 09 2018 at 18:24)</a>:</h4>
<p>(just submitted a WIP PR with what I had for this, only because I'll forget I did it otherwise)</p>



<a name="151232043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151232043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151232043">(Dec 09 2018 at 18:56)</a>:</h4>
<blockquote>
<p>Am I right in my understanding that we don't actually want all borrows of a local to get killed for other types of projections - eg. field accesses, indexing?</p>
</blockquote>
<p>Definitely not. Assigning to <code>x.f</code>should not kill loans of <code>*x.g</code>, since this would allow a second mutable borrow of <code>*x.g</code>.</p>



<a name="151232462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151232462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151232462">(Dec 09 2018 at 19:05)</a>:</h4>
<blockquote>
<p>Definitely not. Assigning to <code>x.f</code>should not kill loans of <code>*x.g</code>, since this would allow a second mutable borrow of <code>*x.g</code>.</p>
</blockquote>
<p>Does that mean my understanding is definitely not correct, or we definitely don't want all borrows killed for other types of projections?</p>



<a name="151232505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151232505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151232505">(Dec 09 2018 at 19:06)</a>:</h4>
<p>I'm having a real hard time parsing sentences today and I don't know why.</p>



<a name="151232790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151232790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151232790">(Dec 09 2018 at 19:15)</a>:</h4>
<p>We definitely don't want assigning to a projection to kill all borrows of places with the same base.</p>



<a name="151256037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151256037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151256037">(Dec 10 2018 at 07:45)</a>:</h4>
<p>I think I realised what was intended by Niko‚Äôs notes on the issue last night. Hold off on reviewing until I‚Äôve had a chance to revisit the PR. <span class="emoji emoji-1f926" title="face palm">:face_palm:</span>üèª‚Äç‚ôÇÔ∏è</p>



<a name="151561521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151561521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151561521">(Dec 12 2018 at 20:33)</a>:</h4>
<p>I think I meant for assignments to <code>x.f</code> to kill all borrows of <code>x.f.*</code>, basically</p>



<a name="151561625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151561625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151561625">(Dec 12 2018 at 20:35)</a>:</h4>
<p>The main thing I wasn't sure of was, after generalizing the conflicting places logic like you described, what place should I check for conflict with?</p>



<a name="151561634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151561634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151561634">(Dec 12 2018 at 20:35)</a>:</h4>
<p>I've tried a few things and couldn't find something that seemed quite right.</p>



<a name="151563270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151563270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151563270">(Dec 12 2018 at 21:00)</a>:</h4>
<p>remind me <span class="user-mention" data-user-id="116107">@davidtwco</span>, is there a PR? it's a bit out of cache but I can take a look</p>



<a name="151563301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151563301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151563301">(Dec 12 2018 at 21:01)</a>:</h4>
<p>There is, but it's with the initial naive fix that didn't do anything with places conflicting.</p>



<a name="151563312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151563312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151563312">(Dec 12 2018 at 21:01)</a>:</h4>
<p>I've not pushed my experimenting with the place conflict code route yet.</p>



<a name="151563458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151563458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151563458">(Dec 12 2018 at 21:03)</a>:</h4>
<p>ok well give me a sec and I can maybe remember :)</p>



<a name="151563634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151563634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151563634">(Dec 12 2018 at 21:05)</a>:</h4>
<p>I mostly experimented with doing the place conflict with the base local being assigned into and then the actual place that was being assigned into.</p>



<a name="151563774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151563774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151563774">(Dec 12 2018 at 21:07)</a>:</h4>
<p>So, <code>_1</code> and <code>(*(_1.0))</code> for example. Hoping that it would consider something like <code>_1</code> and <code>*(_1)</code> in conflict and therefore can be killed and something like <code>_1</code> and <code>(*(_1.0))</code> not and therefore not killed. But it didn't quite work out like that - it was close. After tweaking the <code>BorrowKind</code> and <code>AccessDepth</code> parameters a bunch (since they don't really make sense in this context as far as I understand) I got it so that one or the other worked.</p>



<a name="151563785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151563785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151563785">(Dec 12 2018 at 21:08)</a>:</h4>
<p>(or something along those lines, I've still got the working directory so I can check)</p>



<a name="151563968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151563968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151563968">(Dec 12 2018 at 21:10)</a>:</h4>
<p>I'm a bit confused</p>



<a name="151563977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151563977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151563977">(Dec 12 2018 at 21:10)</a>:</h4>
<p>ah, you are considering using that function to decide whether something is killed?</p>



<a name="151563979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151563979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151563979">(Dec 12 2018 at 21:10)</a>:</h4>
<p>I think that's probably not the right one to use</p>



<a name="151564004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564004">(Dec 12 2018 at 21:11)</a>:</h4>
<p>I think the RFC basically imagined just using a strict notion of "prefix" -- i.e., if you assign to some place P0, then you find all loans of any <code>Place</code> with P0 as a base and kill them</p>



<a name="151564005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564005">(Dec 12 2018 at 21:11)</a>:</h4>
<p>You mentioned it in the issue, so figured I'd need it somewhere, couldn't think of where initially and then a few days later thought "hmm, maybe it is for deciding to kill things" and experimented with that.</p>



<a name="151564013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564013">(Dec 12 2018 at 21:11)</a>:</h4>
<p>That's what my understanding was.</p>



<a name="151564016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564016">(Dec 12 2018 at 21:11)</a>:</h4>
<p>this sort of kills more than necessary, but in some of those cases the assignment itself is illegal</p>



<a name="151564018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564018">(Dec 12 2018 at 21:11)</a>:</h4>
<p>I just tried to find a way to use that function.</p>



<a name="151564023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564023">(Dec 12 2018 at 21:11)</a>:</h4>
<p>Since it was mentioned.</p>



<a name="151564026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564026">(Dec 12 2018 at 21:11)</a>:</h4>
<p>well</p>



<a name="151564028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564028">(Dec 12 2018 at 21:12)</a>:</h4>
<p>let me re-read the issue :)</p>



<a name="151564086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564086">(Dec 12 2018 at 21:12)</a>:</h4>
<p>ok, ok, <em>right</em></p>



<a name="151564135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564135">(Dec 12 2018 at 21:13)</a>:</h4>
<p>I'm trying to decide if I was right to mention that function</p>



<a name="151564137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564137">(Dec 12 2018 at 21:14)</a>:</h4>
<p>in other words: what I wrote is all true</p>



<a name="151564197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564197">(Dec 12 2018 at 21:14)</a>:</h4>
<p>well I guess it's just that we don't have an efficient way to compare places per se</p>



<a name="151564198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564198">(Dec 12 2018 at 21:14)</a>:</h4>
<p>I tried to look through Gitter to see if there was some context of how it would be used that the issue assumed as known, but couldn't see anything.</p>



<a name="151564202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564202">(Dec 12 2018 at 21:14)</a>:</h4>
<p>apart from <code>places_conflict</code></p>



<a name="151564209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564209">(Dec 12 2018 at 21:14)</a>:</h4>
<p>but <code>places_conflict</code> is really written (as I wrote) for a different purpose:</p>



<a name="151564235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564235">(Dec 12 2018 at 21:15)</a>:</h4>
<p>it is used to say: if you have a loan of the place <code>P</code> and an access to the place <code>P2</code>, does that access potentially overlap with the borrowed place <code>P</code>?</p>



<a name="151564245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564245">(Dec 12 2018 at 21:15)</a>:</h4>
<p>naturally that wants to be conservative: if P2 <em>may</em> overlap P, it returns true</p>



<a name="151564311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564311">(Dec 12 2018 at 21:16)</a>:</h4>
<p>anyway I suspect you just want to write a separate function in the end</p>



<a name="151564318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564318">(Dec 12 2018 at 21:16)</a>:</h4>
<p>Yeah, I think I've implemented giving that function a bias toward overlapping or not (at least for the <code>j[x]</code> case).</p>



<a name="151564330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564330">(Dec 12 2018 at 21:16)</a>:</h4>
<p>something like </p>
<div class="codehilite"><pre><span></span><span class="n">assignment_kills_loan</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">assigned_place</span>: <span class="kp">&amp;</span><span class="nc">Place</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">borrowed_place</span>: <span class="kp">&amp;</span><span class="nc">Place</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="p">..</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="151564355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564355">(Dec 12 2018 at 21:17)</a>:</h4>
<p>Where would I get the <code>borrowed_place</code> from?</p>



<a name="151564383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564383">(Dec 12 2018 at 21:17)</a>:</h4>
<p>well e.g. in <a href="https://github.com/rust-lang/rust/blob/dd8fc7dc06dea00afbd365468cf4804f68a3531c/src/librustc_mir/borrow_check/nll/constraint_generation.rs#L139-L151" target="_blank" title="https://github.com/rust-lang/rust/blob/dd8fc7dc06dea00afbd365468cf4804f68a3531c/src/librustc_mir/borrow_check/nll/constraint_generation.rs#L139-L151">the polonius code</a> you can find it in the loop, I'm trying to find the other code</p>



<a name="151564453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564453">(Dec 12 2018 at 21:18)</a>:</h4>
<p>(incidentally, I think that Simon's example from the issue is not going to be fixed by this issue, but rather requires polonius)</p>



<a name="151564454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564454">(Dec 12 2018 at 21:18)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/dataflow/impls/borrows.rs#L238-L242" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/dataflow/impls/borrows.rs#L238-L242">https://github.com/rust-lang/rust/blob/master/src/librustc_mir/dataflow/impls/borrows.rs#L238-L242</a></p>



<a name="151564475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564475">(Dec 12 2018 at 21:19)</a>:</h4>
<p>right, just found it</p>



<a name="151564476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564476">(Dec 12 2018 at 21:19)</a>:</h4>
<p>(I had a working fix for that in the PR as it is by just extending the existing code to accept <code>*_1</code> as a kill for <code>_1</code> as well as <code>_1</code> - not sure if that is correct though, but only that test changed)</p>



<a name="151564490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564490">(Dec 12 2018 at 21:19)</a>:</h4>
<p>the naive thing of course would be to iterate over all the borrows</p>



<a name="151564492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564492">(Dec 12 2018 at 21:19)</a>:</h4>
<p>but that will kill perf</p>



<a name="151564500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564500">(Dec 12 2018 at 21:19)</a>:</h4>
<p>I suppose we'd want to index them in some way such that we can walk down the assigned path</p>



<a name="151564552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564552">(Dec 12 2018 at 21:20)</a>:</h4>
<p>it feels like a lot of work :) but an ideal thing would be some sort of tree I guess</p>



<a name="151564580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564580">(Dec 12 2018 at 21:20)</a>:</h4>
<p>this would all be easier/nicer if <span class="user-mention" data-user-id="116773">@csmoe</span>'s refactoring were landed -- I need to get back to them on that <span class="emoji emoji-263a" title="smile">:smile:</span></p>



<a name="151564667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564667">(Dec 12 2018 at 21:21)</a>:</h4>
<p>so e.g. if there were borrows of <code>a.b</code> and <code>a.c</code> and <code>a.c.d</code>, you could imagine some sort of tree like:</p>
<div class="codehilite"><pre><span></span>a
|- b
|- c
   |- d
</pre></div>


<p>then when you have an assignment to (say) <code>a.c</code>, you'd walk down to that node and kill all the borrows in that node or its descendants</p>



<a name="151564674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/151564674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#151564674">(Dec 12 2018 at 21:21)</a>:</h4>
<p>(gotta run)</p>



<a name="152023538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152023538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152023538">(Dec 17 2018 at 12:31)</a>:</h4>
<p>I've updated this PR so the approach it takes is now much more reasonable. There's one test that has less errors that isn't ideal, but I'm not really sure how to work around that case - it isn't wrong necessarily, but it's not great.</p>



<a name="152026092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026092">(Dec 17 2018 at 13:20)</a>:</h4>
<p>I wrote a few more comments (on the issue), mostly explaining the code to myself as I went</p>



<a name="152026135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026135">(Dec 17 2018 at 13:21)</a>:</h4>
<p>The only real issue I have is the one about whether we need to look at <code>propagate_call_return</code> as well. But to be honest, that might be left over (as in, whatever earlier PR started inspecting the <code>Local</code> should also have made changes to <code>propagate_call_return</code> ...</p>



<a name="152026224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026224">(Dec 17 2018 at 13:22)</a>:</h4>
<p>I think your PR as it stands is sound. And given the conditional nature of the overwrite caused in <code>propagate_call_return</code>, <del>I think you should not do the similar <code>kill_borrows</code> over there.</del> Update: no, I don't know what to think yet....</p>



<a name="152026230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026230">(Dec 17 2018 at 13:22)</a>:</h4>
<p><del>So I think I just answered my own Q.</del></p>



<a name="152026325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026325">(Dec 17 2018 at 13:24)</a>:</h4>
<p>A bit of explanation here: <code>propagate_call_return</code> is a hack that is working around the fact that our data-flow system is not designed to be as general purpose as we really require.</p>



<a name="152026353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026353">(Dec 17 2018 at 13:25)</a>:</h4>
<p>In particular, we (I) designed it so that most of the interesting effects on the dataflow bitsets occur at the statement level, as we progress directly from statement to statement</p>



<a name="152026442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026442">(Dec 17 2018 at 13:26)</a>:</h4>
<p>The problem with that model is that a <code>Terminator::Call</code> has a side-effect that is control-flow dependent: On a successful call, it will overwrite the given <code>dest_place</code>. On a call that unwinds (e.g. due to panic), it will not overwrite the given <code>dest_place</code>.</p>



<a name="152026460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026460">(Dec 17 2018 at 13:26)</a>:</h4>
<p>So the hack is that in the dataflow system itself, we add in those control-flow edge effects while we are doing the fixed-point iteration.</p>



<a name="152026494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026494">(Dec 17 2018 at 13:27)</a>:</h4>
<p>that (if my memory correctly matches the current state of the code) is the purpose of <code>propagate_call_return</code>.</p>



<a name="152026583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026583">(Dec 17 2018 at 13:28)</a>:</h4>
<p>Let me just catch up with what you've written.</p>



<a name="152026698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026698">(Dec 17 2018 at 13:30)</a>:</h4>
<p>In particular, <code>propagate_call_return</code> is <em>only</em> invoked to update the dataflow bitset when the control flow traverses from the call's basic block (every call is a terminator, so there is a mapping from every call to its unique BB) to the basic block that we jump to on successful (non-unwinding) call.</p>



<a name="152026721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026721">(Dec 17 2018 at 13:31)</a>:</h4>
<p>And the main effect you want to model in that scenario is that the <code>dest_place</code> will be overwritten, <em>just</em> as it is by an <code>Assign</code> statement.</p>



<a name="152026807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026807">(Dec 17 2018 at 13:32)</a>:</h4>
<p>(I'm starting to wonder if we'd just be better served with a default method  in the <code>DataflowAnalysis</code> trait that just said "this is called for assignment-like things, namely Assign statements and a successful return from a Call terminator" ...)</p>



<a name="152026843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026843">(Dec 17 2018 at 13:33)</a>:</h4>
<p>So this is all a long-winded way of me saying: "I think the same code that you've added to the Assign case might also be good to add to the propagate_call_return method." It should be <em>sound</em> for you to leave it out, but I think it will also be sound for you to put it in, and will lead to us accepting more code.</p>



<a name="152026864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152026864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152026864">(Dec 17 2018 at 13:33)</a>:</h4>
<p>But to confirm this I guess I should make some illustrative example.</p>



<a name="152028043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028043">(Dec 17 2018 at 13:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> I know I wrote a lot (both here and on the PR) and maybe you want to finish reading it all before you answer Q's, but here's maybe a simple one: Would you prefer me to r+ this one now, and leave the <code>propagate_call_return</code> generalization for later? Or do you feel like trying to throw that in with a follow-on commit + testcase?</p>



<a name="152028047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028047">(Dec 17 2018 at 13:50)</a>:</h4>
<p>Pushed a commit with better comments.</p>



<a name="152028068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028068">(Dec 17 2018 at 13:50)</a>:</h4>
<p>I'm happy to add it in.</p>



<a name="152028077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028077">(Dec 17 2018 at 13:50)</a>:</h4>
<p>It doesn't sound like a large change.</p>



<a name="152028088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028088">(Dec 17 2018 at 13:50)</a>:</h4>
<p>Yeah I think the hardest part might be adding a test</p>



<a name="152028097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028097">(Dec 17 2018 at 13:50)</a>:</h4>
<p>since I'm not certain whether you can even generate code that would get into the case</p>



<a name="152028111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028111">(Dec 17 2018 at 13:51)</a>:</h4>
<p>I.e. I may be wrong but based on the way we generated MIR today, calls might always write into locals</p>



<a name="152028123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028123">(Dec 17 2018 at 13:51)</a>:</h4>
<p>In that case, r+ and file a follow-up if you're happy with the new comments?</p>



<a name="152028165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028165">(Dec 17 2018 at 13:51)</a>:</h4>
<p>(but then again ... there's not even code to handle <em>locals</em> yet in <code>propagate_call_return</code>, right? That's sort of what I was getting at when I said I wasn't sure whether people in the past had been acknowledging the comment in the first place.)</p>



<a name="152028234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028234">(Dec 17 2018 at 13:52)</a>:</h4>
<p>It's really easy to glaze over and not really notice those comments if they don't seem immediately relevant.</p>



<a name="152028246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028246">(Dec 17 2018 at 13:52)</a>:</h4>
<p>I know.</p>



<a name="152028256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028256">(Dec 17 2018 at 13:52)</a>:</h4>
<p>I'm guilty of it too</p>



<a name="152028425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028425">(Dec 17 2018 at 13:55)</a>:</h4>
<p>Does this demonstrate your case?</p>
<div class="codehilite"><pre><span></span><span class="cp">#![allow(warnings)]</span><span class="w"></span>
<span class="cp">#![feature(rustc_attrs)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">nll_fail</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;b&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;c&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">capitalize</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">capitalize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="sc">&#39;e&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// one error here if assign &#39;e&#39; directly, one error here if call</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">capitalize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="sc">&#39;f&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// one error here if call</span>
<span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">capitalize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="sc">&#39;g&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// one error here if call</span>
<span class="w">    </span><span class="n">capitalize</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">capitalize</span><span class="p">(</span><span class="n">_</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">char</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">char</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sc">&#39;f&#39;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>It's similar to the <code>loan_ends_mid_block_pair</code> test - but instead of assigning characters directly into <code>data.0</code> (which as of this PR, produces one error), it produces three errors when replaced with a call?</p>



<a name="152028472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028472">(Dec 17 2018 at 13:56)</a>:</h4>
<p>Hmm. So am I right in my understanding that this change didn't turn any test from compile-fail into run-pass, and the only place where you saw anything like that was in <code>src/test/ui/nll/loan_ends_mid_block_pair.rs</code> (where you removed two Mir cases in the borrowck=compare output) ?</p>



<a name="152028522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028522">(Dec 17 2018 at 13:56)</a>:</h4>
<p>Yeah.</p>



<a name="152028537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028537">(Dec 17 2018 at 13:57)</a>:</h4>
<blockquote>
<p>It's similar to the <code>loan_ends_mid_block_pair</code> test - but instead of assigning characters directly into <code>data.0</code> (which as of this PR, produces one error), it produces three errors when replaced with a call?</p>
</blockquote>
<p>Yes I think that (putting a call on the RHS rather than a more-trivial expression) is exactly what I expected to illustrate the difference.</p>



<a name="152028545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028545">(Dec 17 2018 at 13:57)</a>:</h4>
<p>I wasn't sure that was better, but couldn't see a way around it.</p>



<a name="152028574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028574">(Dec 17 2018 at 13:57)</a>:</h4>
<p>You should add the example (perhaps adapted in some way) from <a href="https://github.com/rust-lang/rust/issues/46589" target="_blank" title="https://github.com/rust-lang/rust/issues/46589">#46589</a> as an explicit run-pass test, IMO.</p>



<a name="152028633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028633">(Dec 17 2018 at 13:58)</a>:</h4>
<p>i.e. solely relying on the change from <code>load_ends_mid_block_pair</code> to illustrate/test the increased expressiveness here is too subtle, in my opinion.</p>



<a name="152028634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028634">(Dec 17 2018 at 13:58)</a>:</h4>
<p>Yeah, the test as was there had another error that remained after this.</p>



<a name="152028638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028638">(Dec 17 2018 at 13:58)</a>:</h4>
<p>There is a test from that issue that I added.</p>



<a name="152028646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028646">(Dec 17 2018 at 13:58)</a>:</h4>
<p>Just not as run-pass.</p>



<a name="152028661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028661">(Dec 17 2018 at 13:58)</a>:</h4>
<p>right, the one you added was a compile-fail to double-check that we don't generalize <strong>too</strong> much, right?</p>



<a name="152028685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028685">(Dec 17 2018 at 13:59)</a>:</h4>
<p>No, it's exactly what was on the issue, it removed the error that it was supposed to with assigning into a deref projection but there was another unrelated error that test case would cause.</p>



<a name="152028686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028686">(Dec 17 2018 at 13:59)</a>:</h4>
<p>what about the example that SimonSapin had posted to that issue? Does that pass under your branch, or does it still error then too?</p>



<a name="152028688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028688">(Dec 17 2018 at 13:59)</a>:</h4>
<p>(as far as I understood it)</p>



<a name="152028697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028697">(Dec 17 2018 at 13:59)</a>:</h4>
<p>Forgot to try that one.</p>



<a name="152028760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028760">(Dec 17 2018 at 14:00)</a>:</h4>
<p>In some ways thats the most important one to get working, since that represents a real "customer request" <span class="emoji emoji-263a" title="smile">:smile:</span></p>



<a name="152028806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028806">(Dec 17 2018 at 14:00)</a>:</h4>
<p>It looks like it gets the same error.</p>



<a name="152028871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028871">(Dec 17 2018 at 14:01)</a>:</h4>
<p>ah well that's too bad.</p>



<a name="152028927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028927">(Dec 17 2018 at 14:02)</a>:</h4>
<p>I'll look into it and see if I can't add something to <code>propagate_call_return</code> for that too.</p>



<a name="152028931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028931">(Dec 17 2018 at 14:02)</a>:</h4>
<p>let me look again at the test you added and see if I can tease out a run-pass test that won't hit the error then</p>



<a name="152028953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028953">(Dec 17 2018 at 14:02)</a>:</h4>
<p>oh also, if you can</p>



<a name="152028974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028974">(Dec 17 2018 at 14:02)</a>:</h4>
<p>try to make a different title for your PR than the text of the issue it fixes</p>



<a name="152028997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152028997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152028997">(Dec 17 2018 at 14:03)</a>:</h4>
<p>Sure, that's all I've done for the last 50 PRs or something because it meant I didn't need to get creative.</p>



<a name="152029010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152029010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152029010">(Dec 17 2018 at 14:03)</a>:</h4>
<p>I think bors includes the title in the commit message, but more importantly, different text helps people like me who have the issue and the PR in two different tabs in one browser window.</p>



<a name="152029059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152029059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152029059">(Dec 17 2018 at 14:04)</a>:</h4>
<p>Fair enough, I'll do that in future.</p>



<a name="152029243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152029243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152029243">(Dec 17 2018 at 14:07)</a>:</h4>
<p>It's annoying that <code>propagate_call_return</code> takes a <code>BitSet</code> rather than the <code>BlockSets</code> of <code>statement_effect</code>.</p>



<a name="152029252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152029252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152029252">(Dec 17 2018 at 14:07)</a>:</h4>
<p>Makes this a tad more work.</p>



<a name="152029265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152029265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152029265">(Dec 17 2018 at 14:07)</a>:</h4>
<p>Well</p>



<a name="152029274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152029274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152029274">(Dec 17 2018 at 14:07)</a>:</h4>
<p>I think the intent was that the effect of a call could be non-local</p>



<a name="152029286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152029286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152029286">(Dec 17 2018 at 14:07)</a>:</h4>
<p>Yeah, it makes sense, just adds a little friction to this change.</p>



<a name="152029332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152029332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152029332">(Dec 17 2018 at 14:08)</a>:</h4>
<p>but maybe it should have done the look up for the blockset for the call block and the dest block</p>



<a name="152029338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152029338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152029338">(Dec 17 2018 at 14:08)</a>:</h4>
<p>and passed those two blocks in</p>



<a name="152030112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152030112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152030112">(Dec 17 2018 at 14:18)</a>:</h4>
<p>Ran into an error that might need improved:</p>
<div class="codehilite"><pre><span></span>error[E0521]: borrowed data escapes outside of function
   --&gt; src/librustc_mir/dataflow/impls/borrows.rs:391:9
    |
385 |         &amp;self,
    |         ----- `self` is declared here, outside of the function body
...
389 |         dest_place: &amp;mir::Place,
    |         ---------- `dest_place` is a reference that is only valid in the function body
390 |     ) {
391 |         self.kill_borrows_on_call_return(in_out, dest_place);
| ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ `dest_place` escapes the function body here
</pre></div>



<a name="152030139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152030139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152030139">(Dec 17 2018 at 14:18)</a>:</h4>
<p>Doesn't make sense to me that parameters should simultaneously be in and outside the function body.</p>



<a name="152030143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152030143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152030143">(Dec 17 2018 at 14:18)</a>:</h4>
<p>You know its <em>possible</em> fixing the <code>propagate_call_return</code> could help with the test you added, since that <em>is</em> a method call happening in <code>None =&gt; (*other).new_self()</code>... not sure yet.</p>



<a name="152031924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152031924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152031924">(Dec 17 2018 at 14:41)</a>:</h4>
<p>I'm finding the borrow checker surprisingly impenetrable being able to call a function from this <code>propagate_call_return</code> function.</p>



<a name="152032090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152032090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152032090">(Dec 17 2018 at 14:43)</a>:</h4>
<p>okay. Maybe just file a follow-up issue and don't worry about this now.</p>



<a name="152032970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152032970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152032970">(Dec 17 2018 at 14:53)</a>:</h4>
<p>It should be easy enough to do, but I just can't get the lifetimes to work out in order to use <code>self</code> from <code>propagate_call_return</code>.</p>



<a name="152033244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152033244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152033244">(Dec 17 2018 at 14:56)</a>:</h4>
<p>I assume you've already skimmed over other impls of <code>fn propagate_call_return</code>  for inspiration?</p>



<a name="152033315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152033315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152033315">(Dec 17 2018 at 14:57)</a>:</h4>
<p>Yeah, they either don't use <code>dest_place</code> or call some function on it to get owned data (such as <code>MoveData</code>) and then use that in combination with something from <code>self</code> and then that seems to work.</p>



<a name="152033717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152033717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152033717">(Dec 17 2018 at 15:03)</a>:</h4>
<p>I think it ends up being this that is the issue:</p>
<div class="codehilite"><pre><span></span>error: unsatisfied lifetime constraints
   --&gt; src/librustc_mir/dataflow/impls/borrows.rs:398:55
    |
286 | impl&lt;&#39;a, &#39;gcx, &#39;tcx&gt; BitDenotation for Borrows&lt;&#39;a, &#39;gcx, &#39;tcx&gt; {
    |      -- lifetime `&#39;a` defined here
...
396 |         dest_place: &amp;mir::Place,
    |         ---------- has type `&amp;rustc::mir::Place&lt;&#39;1&gt;`
397 |     ) {
398 |         kill_borrows_on_call_return(&amp;self.borrow_set, self.tcx, self.mir, in_out, dest_place);
    |                                                       ^^^^^^^^ copying this value requires that `&#39;1` must outlive `&#39;a`
</pre></div>



<a name="152033729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152033729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152033729">(Dec 17 2018 at 15:03)</a>:</h4>
<p>(after moving things around to get rid of some errors)</p>



<a name="152033952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152033952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152033952">(Dec 17 2018 at 15:06)</a>:</h4>
<p>If I manually specify <code>Place&lt;'tcx&gt;</code> then I can never get it to match what the trait expects, no matter what I do.</p>



<a name="152033989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152033989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152033989">(Dec 17 2018 at 15:07)</a>:</h4>
<div class="codehilite"><pre><span></span>error[E0308]: method not compatible with trait
   --&gt; src/librustc_mir/dataflow/impls/borrows.rs:343:5
    |
343 | /     fn propagate_call_return(
344 | |         &amp;self,
345 | |         set: &amp;mut BitSet&lt;BorrowIndex&gt;,
346 | |         _call_bb: mir::BasicBlock,
...   |
386 | |         }
387 | |     }
    | |_____^ lifetime mismatch
    |
    = note: expected type `fn(&amp;dataflow::impls::borrows::Borrows&lt;&#39;a, &#39;gcx, &#39;tcx&gt;, &amp;mut rustc_data_structures::bit_set::BitSet&lt;dataflow::move_paths::indexes::BorrowIndex&gt;, rustc::mir::BasicBlock, rustc::mir::BasicBlock, &amp;rustc::mir::Place&lt;&#39;tcx&gt;)`
               found type `fn(&amp;dataflow::impls::borrows::Borrows&lt;&#39;a, &#39;gcx, &#39;tcx&gt;, &amp;mut rustc_data_structures::bit_set::BitSet&lt;dataflow::move_paths::indexes::BorrowIndex&gt;, rustc::mir::BasicBlock, rustc::mir::BasicBlock, &amp;rustc::mir::Place&lt;&#39;tcx&gt;)`
note: the lifetime &#39;tcx as defined on the method body at 343:5...
   --&gt; src/librustc_mir/dataflow/impls/borrows.rs:343:5
    |
343 | /     fn propagate_call_return(
344 | |         &amp;self,
345 | |         set: &amp;mut BitSet&lt;BorrowIndex&gt;,
346 | |         _call_bb: mir::BasicBlock,
...   |
386 | |         }
387 | |     }
    | |_____^
note: ...does not necessarily outlive the lifetime &#39;tcx as defined on the impl at 238:16
   --&gt; src/librustc_mir/dataflow/impls/borrows.rs:238:16
    |
238 | impl&lt;&#39;a, &#39;gcx, &#39;tcx&gt; BitDenotation for Borrows&lt;&#39;a, &#39;gcx, &#39;tcx&gt; {
</pre></div>



<a name="152034274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034274">(Dec 17 2018 at 15:12)</a>:</h4>
<p>hmm. something seems sketchy there</p>



<a name="152034344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034344">(Dec 17 2018 at 15:12)</a>:</h4>
<p>Yeah, my ability to decode lifetime errors degrades quickly in cases like this.</p>



<a name="152034560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034560">(Dec 17 2018 at 15:14)</a>:</h4>
<p>hmm</p>



<a name="152034566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034566">(Dec 17 2018 at 15:14)</a>:</h4>
<p>I wonder if the problem is that the trait definiton</p>



<a name="152034571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034571">(Dec 17 2018 at 15:14)</a>:</h4>
<p>should be using</p>



<a name="152034577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034577">(Dec 17 2018 at 15:14)</a>:</h4>
<p><code>Place&lt;'tcx&gt;</code></p>



<a name="152034592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034592">(Dec 17 2018 at 15:15)</a>:</h4>
<p>on the header for <code>propagate_call_return</code> ?</p>



<a name="152034596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034596">(Dec 17 2018 at 15:15)</a>:</h4>
<p>That second error is what I get when I change it to that.</p>



<a name="152034635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034635">(Dec 17 2018 at 15:15)</a>:</h4>
<p>(and then update my impl of it to match)</p>



<a name="152034662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034662">(Dec 17 2018 at 15:15)</a>:</h4>
<p>don't you have to update all the other impls too?</p>



<a name="152034736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034736">(Dec 17 2018 at 15:16)</a>:</h4>
<p>The first error is when I'm (without having changed the signature) just trying to pass in the relevant information to a function.</p>



<a name="152034751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034751">(Dec 17 2018 at 15:16)</a>:</h4>
<p>I'd expect so, yeah. But I'd expect errors saying they don't match, instead of my impl not matching?</p>



<a name="152034764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034764">(Dec 17 2018 at 15:16)</a>:</h4>
<p>true, that is what I'd expect too</p>



<a name="152034776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034776">(Dec 17 2018 at 15:16)</a>:</h4>
<p>Maybe if I do that it'll resolve itself, might be a worth a shot.</p>



<a name="152034892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034892">(Dec 17 2018 at 15:18)</a>:</h4>
<p>Do you want me to r+ you current PR as is, in any case?</p>



<a name="152034899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034899">(Dec 17 2018 at 15:18)</a>:</h4>
<p>(and you'll do this stuff in some follow-up?)</p>



<a name="152034910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034910">(Dec 17 2018 at 15:18)</a>:</h4>
<p>Or shall we wait a bit to see if you work this lifetime issue out?</p>



<a name="152034925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034925">(Dec 17 2018 at 15:18)</a>:</h4>
<p>Before you do that, I'm looking at SimonSapin's test case and not sure if it is a instance of this issue.</p>



<a name="152034931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152034931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152034931">(Dec 17 2018 at 15:18)</a>:</h4>
<p>ah okay</p>



<a name="152035214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035214">(Dec 17 2018 at 15:22)</a>:</h4>
<p>If I update all of the impls, then they all complain that they don't match.</p>



<a name="152035236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035236">(Dec 17 2018 at 15:22)</a>:</h4>
<p>interesting</p>



<a name="152035303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035303">(Dec 17 2018 at 15:23)</a>:</h4>
<p>wait a minute... does this trait definition even have a <code>'tcx</code> on it?</p>



<a name="152035307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035307">(Dec 17 2018 at 15:23)</a>:</h4>
<p>/me looks some more</p>



<a name="152035313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035313">(Dec 17 2018 at 15:23)</a>:</h4>
<p>Don't think so.</p>



<a name="152035324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035324">(Dec 17 2018 at 15:23)</a>:</h4>
<p>well then what does <code>'tcx</code> even mean in that context...?</p>



<a name="152035329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035329">(Dec 17 2018 at 15:23)</a>:</h4>
<p>that might be the source of the problem here</p>



<a name="152035400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035400">(Dec 17 2018 at 15:24)</a>:</h4>
<p>i.e. this may be a combination of that new lifetime header feature</p>



<a name="152035423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035423">(Dec 17 2018 at 15:24)</a>:</h4>
<p>where <code>'tcx</code> gets implicitly bound at teh method level (I think)</p>



<a name="152035438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035438">(Dec 17 2018 at 15:24)</a>:</h4>
<p>if you don't explicitly declare it otherwise?</p>



<a name="152035467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035467">(Dec 17 2018 at 15:24)</a>:</h4>
<p>in other words, you might need to change <code>trait BitDenotation</code> to <code>trait BitDenotation&lt;'tcx&gt;</code></p>



<a name="152035476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035476">(Dec 17 2018 at 15:24)</a>:</h4>
<p>I'll go through and try that then.</p>



<a name="152035479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035479">(Dec 17 2018 at 15:25)</a>:</h4>
<p>(and lordy that means a lot more churn)</p>



<a name="152035513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035513">(Dec 17 2018 at 15:25)</a>:</h4>
<p>seems like all of this is going to be churn that may not buy us anything</p>



<a name="152035517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035517">(Dec 17 2018 at 15:25)</a>:</h4>
<p>but we'll see</p>



<a name="152035522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035522">(Dec 17 2018 at 15:25)</a>:</h4>
<p>in any case, the <em>exercise</em> may be good</p>



<a name="152035532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035532">(Dec 17 2018 at 15:25)</a>:</h4>
<p>since the frustration you had with the error diagnostic above</p>



<a name="152035610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035610">(Dec 17 2018 at 15:26)</a>:</h4>
<p>indicates that we need to improve our diagnostic reporting here a lot. This is a new feature which means no one may be prepared for this kind of error when we hit it.</p>



<a name="152035642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152035642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152035642">(Dec 17 2018 at 15:27)</a>:</h4>
<p>Yeah, there's definitely work to do with errors like that.</p>



<a name="152037338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152037338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152037338">(Dec 17 2018 at 15:48)</a>:</h4>
<p>So, did that and down to two lifetime errors relating to closures in the graphviz code - which anecdotally whenever I make a change like this, it always feels like it ends up in the graphviz code.</p>



<a name="152037985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152037985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152037985">(Dec 17 2018 at 15:57)</a>:</h4>
<p>I wish we had telemetry on how often that code is used</p>



<a name="152038004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152038004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152038004">(Dec 17 2018 at 15:57)</a>:</h4>
<p>I was probably its biggest client at one point but now ... who knows who uses it, if anyone.</p>



<a name="152038090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152038090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152038090">(Dec 17 2018 at 15:58)</a>:</h4>
<p>Managed to get around it.</p>



<a name="152038150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152038150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152038150">(Dec 17 2018 at 15:59)</a>:</h4>
<p>Got <code>rustc_mir</code> to compile with <code>Place&lt;'tcx&gt;</code>, so I suspect the lifetime situation is all resolved.</p>



<a name="152039210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152039210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152039210">(Dec 17 2018 at 16:13)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> the MIR of the test case for the calls instead of assignments ends up assigning into a local that the next block assigns into the field - so it doesn't end up using the code path for the <code>propagate_call_return</code>.</p>



<a name="152039285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152039285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152039285">(Dec 17 2018 at 16:14)</a>:</h4>
<p>But, it still has three errors instead of the one I'd expect because the borrow indices set that we iterate over end up being empty - which is odd.</p>



<a name="152039332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152039332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152039332">(Dec 17 2018 at 16:14)</a>:</h4>
<p>Looks like those sets only have the borrows from that block, which is why.</p>



<a name="152039668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152039668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152039668">(Dec 17 2018 at 16:18)</a>:</h4>
<p>Oh, well... propagate_call_return is called <em>during</em> data flow solving (the iteration to a fixed point)</p>



<a name="152039695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152039695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152039695">(Dec 17 2018 at 16:19)</a>:</h4>
<p>So I‚Äôd expect it to be called many times? And potentially the sets change between the calls...?</p>



<a name="152039712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152039712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152039712">(Dec 17 2018 at 16:19)</a>:</h4>
<p>I'd like to keep the lifetime changes in because I think they're more correct and someone else will need to do it if they end up doing something similar in that function in future.</p>



<a name="152039765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152039765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152039765">(Dec 17 2018 at 16:20)</a>:</h4>
<p>(that is, the <code>BitDenotation&lt;'tcx&gt;</code> change)</p>



<a name="152040157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152040157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152040157">(Dec 17 2018 at 16:25)</a>:</h4>
<p>I'm fairly sure (would appreciate if you could take a look at confirm) that SimonSapin's test case isn't related. I could be wrong, but I don't think it is assigning into a projection of anything and then relying on that to kill a borrow.</p>



<a name="152040300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152040300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152040300">(Dec 17 2018 at 16:27)</a>:</h4>
<p>Other than that, happy for you to r+ - just pushed a change with the lifetime fixes.</p>



<a name="152040814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152040814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152040814">(Dec 17 2018 at 16:34)</a>:</h4>
<blockquote>
<p>I'm fairly sure (would appreciate if you could take a look at confirm) that SimonSapin's test case isn't related. I could be wrong, but I don't think it is assigning into a projection of anything and then relying on that to kill a borrow.</p>
</blockquote>
<p>If it is related then I think it is worth trying to fix that before landing?</p>



<a name="152058174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152058174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152058174">(Dec 17 2018 at 20:32)</a>:</h4>
<blockquote>
<p>what about the example that SimonSapin had posted to that issue? Does that pass under your branch, or does it still error then too?</p>
</blockquote>
<p>I think that @simonsapin's example requires polonius</p>



<a name="152058298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2346589%20kill%20borrows%20after%20assignment/near/152058298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2346589.20kill.20borrows.20after.20assignment.html#152058298">(Dec 17 2018 at 20:34)</a>:</h4>
<p>at least that was my belief when I last looked</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>