<html>
<head><meta charset="utf-8"><title>#53114, #53438 - `_` patterns should not count as borrows · t-compiler/wg-nll · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/index.html">t-compiler/wg-nll</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html">#53114, #53438 - `_` patterns should not count as borrows</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="133081354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133081354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133081354">(Aug 30 2018 at 19:40)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>  I realized after your comment that discriminants aren't places, so we can't borrow one. I guess I could try making it one or alternatively make a new <code>StatementKind</code>/<code>Rvalue</code> for them. I guess I could try both and see how they compare.</p>



<a name="133081365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133081365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133081365">(Aug 30 2018 at 19:41)</a>:</h4>
<p>I think that this is probably the approach that seems most natural.</p>



<a name="133115332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133115332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133115332">(Aug 31 2018 at 10:03)</a>:</h4>
<blockquote>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>  I realized after your comment that discriminants aren't places, so we can't borrow one. I guess I could try making it one or alternatively make a new <code>StatementKind</code>/<code>Rvalue</code> for them. I guess I could try both and see how they compare.</p>
</blockquote>
<p>actually, we have a hack here...</p>



<a name="133115401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133115401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133115401">(Aug 31 2018 at 10:04)</a>:</h4>
<p>ah, right</p>



<a name="133115407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133115407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133115407">(Aug 31 2018 at 10:05)</a>:</h4>
<p>I was thinking of this:</p>



<a name="133115417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133115417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133115417">(Aug 31 2018 at 10:05)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/1114ab684fbad001c4e580326d8eb4d8c4e917d3/src/librustc_mir/borrow_check/mod.rs#L730-L734" target="_blank" title="https://github.com/rust-lang/rust/blob/1114ab684fbad001c4e580326d8eb4d8c4e917d3/src/librustc_mir/borrow_check/mod.rs#L730-L734">https://github.com/rust-lang/rust/blob/1114ab684fbad001c4e580326d8eb4d8c4e917d3/src/librustc_mir/borrow_check/mod.rs#L730-L734</a></p>



<a name="133115424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133115424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133115424">(Aug 31 2018 at 10:05)</a>:</h4>
<p>however — presently — this is not part of a <code>Place</code>, you are correct, instead, that is used as part of <a href="https://github.com/rust-lang/rust/blob/1114ab684fbad001c4e580326d8eb4d8c4e917d3/src/librustc_mir/borrow_check/mod.rs#L738-L743" target="_blank" title="https://github.com/rust-lang/rust/blob/1114ab684fbad001c4e580326d8eb4d8c4e917d3/src/librustc_mir/borrow_check/mod.rs#L738-L743">specifying what you access</a></p>



<a name="133115475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133115475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133115475">(Aug 31 2018 at 10:06)</a>:</h4>
<p>hmm, hmm, hmm</p>



<a name="133115479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133115479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133115479">(Aug 31 2018 at 10:07)</a>:</h4>
<p>I mean borrowing the "thing that contains the discriminant" would be a suitable overapproximation :P</p>



<a name="133145320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133145320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133145320">(Aug 31 2018 at 20:01)</a>:</h4>
<p>Borrowing the thing that contains the discriminant is too much of an over-approximation. There are crates that match on an <code>enum</code> while one of its fields is borrowed, which conflicts with a borrow of the <code>enum</code>.</p>



<a name="133145418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133145418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133145418">(Aug 31 2018 at 20:03)</a>:</h4>
<blockquote>
<p>match on an enum while one of its fields is borrowed</p>
</blockquote>
<p>but, if they've borrowed a field, the variant has to have already been decided; why would they match again?</p>



<a name="133145496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133145496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133145496">(Aug 31 2018 at 20:05)</a>:</h4>
<p>They could have returned, in which case the borrow will last until the end of the function until we have Polonius.</p>



<a name="133145566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133145566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133145566">(Aug 31 2018 at 20:06)</a>:</h4>
<p>They could also have only borrowed in one case in an if expression.</p>



<a name="133145589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133145589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133145589">(Aug 31 2018 at 20:07)</a>:</h4>
<blockquote>
<p>Borrowing the thing that contains the discriminant is too much of an over-approximation. There are crates that match on an <code>enum</code> while one of its fields is borrowed, which conflicts with a borrow of the <code>enum</code>.</p>
</blockquote>
<p>are we seeing these regressions in crater?</p>



<a name="133145636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133145636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133145636">(Aug 31 2018 at 20:08)</a>:</h4>
<p>all of this, incidentally, further argues for my desire to separate out the borrow checker's notion of "place" from MIR's notion of place</p>



<a name="133145649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133145649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133145649">(Aug 31 2018 at 20:09)</a>:</h4>
<p>I think we were, I held off on this PR until I was pretty sure that this was leading to actual regressions.</p>



<a name="133145654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133145654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133145654">(Aug 31 2018 at 20:09)</a>:</h4>
<p>hmm I hadn't seen those?</p>



<a name="133145884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133145884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133145884">(Aug 31 2018 at 20:13)</a>:</h4>
<p>The only one I can find ATM is <a href="https://cargobomb-reports.s3.amazonaws.com/nll-3/00bcc44fb92c28465c727881355c3235a56a4045/reg/rgen3-save-0.1.0/log.txt" target="_blank" title="https://cargobomb-reports.s3.amazonaws.com/nll-3/00bcc44fb92c28465c727881355c3235a56a4045/reg/rgen3-save-0.1.0/log.txt">https://cargobomb-reports.s3.amazonaws.com/nll-3/00bcc44fb92c28465c727881355c3235a56a4045/reg/rgen3-save-0.1.0/log.txt</a>. Does <a href="https://github.com/nikomatsakis/nll-crater-run-results" target="_blank" title="https://github.com/nikomatsakis/nll-crater-run-results">https://github.com/nikomatsakis/nll-crater-run-results</a> contain everything, because I thought that there were more?</p>



<a name="133146006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146006">(Aug 31 2018 at 20:15)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116113">@lqd</span></p>



<a name="133146035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146035">(Aug 31 2018 at 20:15)</a>:</h4>
<p>that said, we might have erroneously considered that legit</p>



<a name="133146098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146098">(Aug 31 2018 at 20:16)</a>:</h4>
<p>it's not obvious from the quoted error that it's not</p>



<a name="133146102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146102">(Aug 31 2018 at 20:16)</a>:</h4>
<p>I guess we have to go to the original sources to tell</p>



<a name="133146139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146139">(Aug 31 2018 at 20:17)</a>:</h4>
<p>some are not obvious yeah. there might be some in the reports that are not in the repo, there's a parser combinator library I hadn't time to minimize yet as well</p>



<a name="133146267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146267">(Aug 31 2018 at 20:19)</a>:</h4>
<p>that looks pretty legit to me</p>



<a name="133146275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146275">(Aug 31 2018 at 20:19)</a>:</h4>
<p>I think I have minimized rgen3 (it's the pokémon one IIRC), it looked legit but I might have done it incorrectly ?</p>



<a name="133146276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146276">(Aug 31 2018 at 20:19)</a>:</h4>
<p>relevant function</p>
<div class="codehilite"><pre><span></span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">sections</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">SaveSections</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">blocks</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">most_recent_index</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">team_and_items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">SectionData</span>::<span class="n">TeamAndItems</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                                    </span><span class="n">block</span><span class="p">.</span><span class="n">sections</span><span class="p">[</span><span class="n">block</span><span class="p">.</span><span class="n">team_and_items_index</span><span class="p">].</span><span class="n">data</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">data</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">panic</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Unexpected section data. Expected TeamAndItems&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">trainer_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">SectionData</span>::<span class="n">TrainerInfo</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                                  </span><span class="n">block</span><span class="p">.</span><span class="n">sections</span><span class="p">[</span><span class="n">block</span><span class="p">.</span><span class="n">trainer_info_index</span><span class="p">].</span><span class="n">data</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">data</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">panic</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Unexpected section data. Expected TrainerInfo&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">SaveSections</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">team</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">team_and_items</span><span class="p">.</span><span class="n">team</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">trainer</span>: <span class="nc">trainer_info</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>



<a name="133146347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146347">(Aug 31 2018 at 20:20)</a>:</h4>
<p>if I'm not mistaken, unless <code>team_and_items_index != trainer_info_index</code>, those two mutable borrows could overlap?</p>



<a name="133146364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146364">(Aug 31 2018 at 20:21)</a>:</h4>
<p>that said, <span class="user-mention" data-user-id="116118">@Matthew Jasper</span>, I could <em>imagine</em> cases where the borrow would be stronger than we would want</p>



<a name="133146371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146371">(Aug 31 2018 at 20:21)</a>:</h4>
<p>I'd just be surprised to see them in practice</p>



<a name="133146390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146390">(Aug 31 2018 at 20:21)</a>:</h4>
<p>or maybe not, who knows, mostly I mean "I just don't remember seeing them" :)</p>



<a name="133146441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146441">(Aug 31 2018 at 20:22)</a>:</h4>
<p><span class="user-mention" data-user-id="116118">@Matthew Jasper</span> are you currently doing some sort of hacking on this?</p>



<a name="133146476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146476">(Aug 31 2018 at 20:23)</a>:</h4>
<p>I have what you see in the PR and 20 minutes work on making discriminants Places.</p>



<a name="133146750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146750">(Aug 31 2018 at 20:28)</a>:</h4>
<p>oh, ok</p>



<a name="133146752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146752">(Aug 31 2018 at 20:28)</a>:</h4>
<p>making discrim places seems plausible for now, anyway</p>



<a name="133146756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146756">(Aug 31 2018 at 20:28)</a>:</h4>
<p>presumably it'll result in some <code>bug!</code> calls...</p>



<a name="133146764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146764">(Aug 31 2018 at 20:29)</a>:</h4>
<p>the challenge is that there are discriminants that can't be treated like other places</p>



<a name="133146768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146768">(Aug 31 2018 at 20:29)</a>:</h4>
<p>e.g., the null value of <code>Option&lt;&amp;T&gt;</code>  =)</p>



<a name="133146780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146780">(Aug 31 2018 at 20:29)</a>:</h4>
<p>this is why we have <code>ReadDiscriminant()</code> and not discriminant places</p>



<a name="133146866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146866">(Aug 31 2018 at 20:31)</a>:</h4>
<p>Indeed, I was planing to remove borrows of discriminants in one of the after borrowck passes</p>



<a name="133146907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133146907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133146907">(Aug 31 2018 at 20:32)</a>:</h4>
<p>It's still not great, having MIR that makes no sense to run.</p>



<a name="133147019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147019">(Aug 31 2018 at 20:34)</a>:</h4>
<p>well</p>



<a name="133147023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147023">(Aug 31 2018 at 20:34)</a>:</h4>
<p>yeah</p>



<a name="133147025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147025">(Aug 31 2018 at 20:34)</a>:</h4>
<p>I mean that part <em>itself</em> doesn't bother me</p>



<a name="133147032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147032">(Aug 31 2018 at 20:34)</a>:</h4>
<p>I always (in my head) imagine a "lowering" step between the MIR we initially create</p>



<a name="133147039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147039">(Aug 31 2018 at 20:34)</a>:</h4>
<p>and the LIR that we execute (which just happens to share the same data structures as MIR)</p>



<a name="133147049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147049">(Aug 31 2018 at 20:35)</a>:</h4>
<p>but one might imagine wanting something like <code>BorrowDiscriminant(...)</code> etc</p>



<a name="133147055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147055">(Aug 31 2018 at 20:35)</a>:</h4>
<p>so that you can at least more easily screen out the "impossible cases"</p>



<a name="133147064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147064">(Aug 31 2018 at 20:35)</a>:</h4>
<p>One could <em>even</em> imagine producing a whole distinct IR for LIR</p>



<a name="133147066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147066">(Aug 31 2018 at 20:35)</a>:</h4>
<p>this is not entirely crazy</p>



<a name="133147073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147073">(Aug 31 2018 at 20:35)</a>:</h4>
<p>in particular, it might eliminate some clones</p>



<a name="133147125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147125">(Aug 31 2018 at 20:36)</a>:</h4>
<p>that is, I think you could create the MIR, modify it in place to have full regions etc, then "clone/simplify" it into LIR, which might be somewhat different (SSA, maybe, etc)</p>



<a name="133147126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147126">(Aug 31 2018 at 20:36)</a>:</h4>
<p>anyway</p>



<a name="133147127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147127">(Aug 31 2018 at 20:36)</a>:</h4>
<p>that's all way far away for this bug :)</p>



<a name="133147132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147132">(Aug 31 2018 at 20:36)</a>:</h4>
<p>just thinking out loud</p>



<a name="133147170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147170">(Aug 31 2018 at 20:37)</a>:</h4>
<p>I considered <code>BorrowDiscriminant(...)</code>, it's probably worse for borrowck and better for everyone else who uses MIR.</p>



<a name="133147225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147225">(Aug 31 2018 at 20:38)</a>:</h4>
<p>And is probably stricter in some edge cases.</p>



<a name="133147258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147258">(Aug 31 2018 at 20:39)</a>:</h4>
<p>it's annoying that we now have borrows coming from something other than <code>Ref</code> expressions I guess</p>



<a name="133147260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147260">(Aug 31 2018 at 20:39)</a>:</h4>
<p>that is a pretty big loss</p>



<a name="133147302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147302">(Aug 31 2018 at 20:40)</a>:</h4>
<p>ok well</p>



<a name="133147312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147312">(Aug 31 2018 at 20:40)</a>:</h4>
<p>I guess one other thing</p>



<a name="133147315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147315">(Aug 31 2018 at 20:40)</a>:</h4>
<p>would be <code>BorrowKind::Discriminant</code></p>



<a name="133147327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147327">(Aug 31 2018 at 20:40)</a>:</h4>
<p>which is...wacky</p>



<a name="133147333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147333">(Aug 31 2018 at 20:40)</a>:</h4>
<p>but the idea would be sort of that it's a shared borrow of "the discriminant"</p>



<a name="133147346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147346">(Aug 31 2018 at 20:41)</a>:</h4>
<p>I forget just how <code>places_conflict</code> works...</p>



<a name="133147353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147353">(Aug 31 2018 at 20:41)</a>:</h4>
<p>in particular if it has access to the borrow kind</p>



<a name="133147354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147354">(Aug 31 2018 at 20:41)</a>:</h4>
<p>probably not</p>



<a name="133147408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147408">(Aug 31 2018 at 20:42)</a>:</h4>
<p>It would probably work, but would almost certainly cause anyone to be confused when they first see it.</p>



<a name="133147474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147474">(Aug 31 2018 at 20:43)</a>:</h4>
<p>It doesn't. I would have <code>BorrowKind::Discriminant</code> do a <code>Shallow(Discriminant)</code> access but borrow the whole place, if I could get away with it.</p>



<a name="133147546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147546">(Aug 31 2018 at 20:45)</a>:</h4>
<p>Otherwise just make discriminant a Place</p>



<a name="133147624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147624">(Aug 31 2018 at 20:47)</a>:</h4>
<blockquote>
<p>It doesn't. I would have <code>BorrowKind::Discriminant</code> do a <code>Shallow(Discriminant)</code> access but borrow the whole place, if I could get away with it.</p>
</blockquote>
<p>what precisely are you looking to "accept" here?</p>



<a name="133147813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147813">(Aug 31 2018 at 20:51)</a>:</h4>
<p>I guess you are thinking of a case where something is borrowed that is not affecting the discriminant?</p>



<a name="133147824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147824">(Aug 31 2018 at 20:51)</a>:</h4>
<p>it'd be good to come up with some specific example</p>



<a name="133147832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147832">(Aug 31 2018 at 20:51)</a>:</h4>
<p>I suspect that most of them also won't build with AST borrow check</p>



<a name="133147833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147833">(Aug 31 2018 at 20:51)</a>:</h4>
<p>The main things are</p>
<ul>
<li>Matches on a struct that have a field borrowed.</li>
<li>Matches on enums that have a field borrowed.</li>
<li><code>_</code> patterns on places that are borrowed.</li>
</ul>
<p>Using normal shared borrows more carefully should get us two of these, so I'll start there.</p>



<a name="133147838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133147838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133147838">(Aug 31 2018 at 20:51)</a>:</h4>
<p>in which case, maybe we can leave it for future work :)</p>



<a name="133148100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133148100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133148100">(Aug 31 2018 at 20:57)</a>:</h4>
<p>Well AST borrowck has a soundness bug around matching on borrowed places, which makes this even more fun.</p>



<a name="133149213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133149213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133149213">(Aug 31 2018 at 21:20)</a>:</h4>
<p>Some examples of what might or might not compile: <a href="https://play.rust-lang.org/?gist=3393dae9f7a74179a77af649ba50689d&amp;version=nightly&amp;mode=debug&amp;edition=2015" target="_blank" title="https://play.rust-lang.org/?gist=3393dae9f7a74179a77af649ba50689d&amp;version=nightly&amp;mode=debug&amp;edition=2015">https://play.rust-lang.org/?gist=3393dae9f7a74179a77af649ba50689d&amp;version=nightly&amp;mode=debug&amp;edition=2015</a></p>



<a name="133150252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133150252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133150252">(Aug 31 2018 at 21:45)</a>:</h4>
<p>my guess is that the final example might not compile, even if we removed E0382 (which we plan to, once NLL is merged)</p>



<a name="133150283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133150283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133150283">(Aug 31 2018 at 21:46)</a>:</h4>
<p>because we've been trying to be agnostic about the order in which match arms are tested</p>



<a name="133150303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133150303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133150303">(Aug 31 2018 at 21:46)</a>:</h4>
<p>that is sort of a special case in that there is probably <em>no other possible way</em> to evaluate that pattern</p>



<a name="133150312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133150312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133150312">(Aug 31 2018 at 21:46)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>



<a name="133150314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133150314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133150314">(Aug 31 2018 at 21:46)</a>:</h4>
<p>but something like that would I expect still be illegal</p>



<a name="133150321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133150321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133150321">(Aug 31 2018 at 21:46)</a>:</h4>
<p>regardless, all would be illegal under the compilation model I proposed</p>



<a name="133150325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133150325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133150325">(Aug 31 2018 at 21:46)</a>:</h4>
<p>in that <code>s</code> needs to be borrowed</p>



<a name="133150328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133150328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133150328">(Aug 31 2018 at 21:46)</a>:</h4>
<p>because it is compared for equality</p>



<a name="133150336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133150336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133150336">(Aug 31 2018 at 21:47)</a>:</h4>
<p>and it would remain borrowed until the match arm executes</p>



<a name="133151155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133151155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133151155">(Aug 31 2018 at 22:04)</a>:</h4>
<p>Should this compile then?</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">is_this_ok</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">s</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="133153454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133153454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133153454">(Aug 31 2018 at 22:58)</a>:</h4>
<p><span class="user-mention" data-user-id="116118">@Matthew Jasper</span> an interesting question</p>



<a name="133226372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133226372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133226372">(Sep 02 2018 at 19:48)</a>:</h4>
<p>Ok so we need some kind of "shallow borrow" to allow this to compile</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// has to prevent assigning to x in guards, but borrowing it will conflict with the borrow above</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="133226539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133226539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133226539">(Sep 02 2018 at 19:54)</a>:</h4>
<p>I guess I'll close the current PR and try implementing discriminant Places. Unless you think that now is the time to try using a different version of Place in borrowck.</p>



<a name="133227262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133227262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133227262">(Sep 02 2018 at 20:18)</a>:</h4>
<p>Maybe <code>BorrowKind::Shallow</code>and parsing the borrow kinds to places conflict is simpler.</p>



<a name="133229373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133229373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133229373">(Sep 02 2018 at 21:39)</a>:</h4>
<p>So, for reference, I'm proposing:</p>
<ul>
<li>Create a new <code>BorrowKind</code>: <code>Shallow</code> (name can be bike-shed)</li>
<li>
<p><code>Shallow</code> borrows differ from shared borrows in that</p>
<ul>
<li>When we check for access we treat them as a <code>Shallow(Some(_))</code> read</li>
<li>When we check for conflicts with them, if the access place is a strict prefix of the borrow place then we don't consider that a conflict.<ul>
<li>For example, a <code>Shallow</code> borrow of <code>x</code> does not conflict with any access or borrow of <code>x.0</code> or <code>*x</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Remove the current fake borrow in matches.</p>
</li>
<li>When building matches we take a <code>Shallow</code> borrow of any <code>Place</code> that we switch on, and any pointer that's dereferenced in that <code>Place</code>.<ul>
<li><code>match x { &amp;Some(1) =&gt; (),  _ =&gt; (), }</code> would <code>Shallow</code> borrow <code>x</code>, <code>*x</code> and <code>(*x as Some).0</code> (the <code>*x</code> borrow is unnecessary, but I'm not sure how easy it would be to remove.)</li>
</ul>
</li>
<li>Read the borrows before the last match arm (we should have enough fake edges to only need to do this on the last arm).</li>
<li>Replace the fake discriminant read with a <code>ReadForMatch</code>.</li>
<li>Change ReadForMatch to only check for initializedness (to prevent <code>let x: !; match x {}</code>), but not conflicting borrows. It is still considered a use for liveness and <code>unsafe</code> checking.</li>
<li>Try to keep the diagnostic improvements from the current PR.</li>
</ul>



<a name="133249022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133249022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133249022">(Sep 03 2018 at 08:59)</a>:</h4>
<blockquote>
<p>Ok so we need some kind of "shallow borrow" to allow this to compile</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">     </span><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// has to prevent assigning to x in guards, but borrowing it will conflict with the borrow above</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">r</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


</blockquote>
<p>I have to admit, I'm confused: why does it not suffice here to just borrow <code>x.1</code> alone?</p>



<a name="133249117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133249117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133249117">(Sep 03 2018 at 09:00)</a>:</h4>
<p>that is, your  comment says "has to prevent assigning to <code>x</code> in guards", but borrowing <code>x.1</code> should accomplish that, right? (and if the outer borrow <code>&amp;mut x.0</code> were not present, then presumably the guards then <em>would</em> be allowed to assign to <code>x.0</code>, in an ideal world at least?)</p>



<a name="133255150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133255150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133255150">(Sep 03 2018 at 11:39)</a>:</h4>
<p>Assignments only do shallow writes, so borrowing <code>(*x).0</code> or <code>*x</code> doesn't prevent assigning to <code>x</code>.</p>



<a name="133259917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133259917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133259917">(Sep 03 2018 at 13:10)</a>:</h4>
<p>oh right, I overlooked that <code>x</code> is a <em>reference</em> to a tuple, not a tuple itself.</p>



<a name="133259944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133259944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133259944">(Sep 03 2018 at 13:11)</a>:</h4>
<p>(though then I'm not 100% sure why it should be illegal to assign to <code>x</code> ... its not like doing so would invalidate <code>r</code>, right...? I must not be thinking hard enough about this.)</p>



<a name="133260004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133260004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133260004">(Sep 03 2018 at 13:12)</a>:</h4>
<p>oh, the match itself... hmm.</p>



<a name="133260011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133260011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133260011">(Sep 03 2018 at 13:12)</a>:</h4>
<p>(but the <code>match</code> input is derefed...)</p>



<a name="133260016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133260016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133260016">(Sep 03 2018 at 13:12)</a>:</h4>
<p>I guess I'll just stop talking for a while</p>



<a name="133274143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133274143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133274143">(Sep 03 2018 at 18:44)</a>:</h4>
<p>See the tests in this commit for why we borrow x as well as <code>*x</code> <a href="https://github.com/rust-lang/rust/commit/cb5c989598178af505fb215dd97afca8cc2b659f#diff-a2126cd3263a1f5342e2ecd5e699fbc6" target="_blank" title="https://github.com/rust-lang/rust/commit/cb5c989598178af505fb215dd97afca8cc2b659f#diff-a2126cd3263a1f5342e2ecd5e699fbc6">https://github.com/rust-lang/rust/commit/cb5c989598178af505fb215dd97afca8cc2b659f#diff-a2126cd3263a1f5342e2ecd5e699fbc6</a></p>



<a name="133274158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133274158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133274158">(Sep 03 2018 at 18:45)</a>:</h4>
<p>Replace <code>&amp;</code> with <code>&amp;mut</code> in the second test to get something closer to the example here.</p>



<a name="133375289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133375289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133375289">(Sep 05 2018 at 13:27)</a>:</h4>
<blockquote>
<p>(though then I'm not 100% sure why it should be illegal to assign to <code>x</code> ... its not like doing so would invalidate <code>r</code>, right...? I must not be thinking hard enough about this.)</p>
</blockquote>
<p>so <span class="user-mention" data-user-id="116083">@pnkfelix</span> this is -- to <em>some</em> extent -- an artifact of how MIR desugars</p>



<a name="133375351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133375351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133375351">(Sep 05 2018 at 13:28)</a>:</h4>
<p>that is, when matching on a place expression (like <code>(*x).1</code>) we will use that same <code>(*x).1</code> place expression to load the option etc</p>



<a name="133375359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133375359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133375359">(Sep 05 2018 at 13:28)</a>:</h4>
<p>so if it changes 'mid match', that is a problem</p>



<a name="133375396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133375396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133375396">(Sep 05 2018 at 13:29)</a>:</h4>
<p>aside: I feel like we are overdue to update and complete the NLL RFC</p>



<a name="133375417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133375417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133375417">(Sep 05 2018 at 13:29)</a>:</h4>
<blockquote>
<p>So, for reference, I'm proposing:</p>
</blockquote>
<p>let me try to compare this...</p>



<a name="133402721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133402721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133402721">(Sep 05 2018 at 21:07)</a>:</h4>
<blockquote>
<ul>
<li>When building matches we take a <code>Shallow</code> borrow of any <code>Place</code> that we switch on, and any pointer that's dereferenced in that <code>Place</code>.</li>
</ul>
</blockquote>
<p>I'm tempted to add "or bind to a variable" here as well. i.e. this should not compile</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span>: <span class="kt">i32</span> <span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">z</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="133403283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133403283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133403283">(Sep 05 2018 at 21:15)</a>:</h4>
<p>sorry <span class="user-mention" data-user-id="116118">@Matthew Jasper</span>, didn't get to this</p>



<a name="133403286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133403286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133403286">(Sep 05 2018 at 21:15)</a>:</h4>
<p>argh</p>



<a name="133403295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133403295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133403295">(Sep 05 2018 at 21:15)</a>:</h4>
<p>not sure where the days keep going!</p>



<a name="133503131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133503131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133503131">(Sep 07 2018 at 10:48)</a>:</h4>
<blockquote>
<p>(though then I'm not 100% sure why it should be illegal to assign to <code>x</code> ... its not like doing so would invalidate <code>r</code>, right...? I must not be thinking hard enough about this.)</p>
</blockquote>
<p>I cannot believe that I forgot that the match input is implicitly borrowed (and then we read from that borrow in the <code>ReadForMatch</code> MIR statements), especially since I'm the one who implemented that PR!</p>



<a name="133503144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133503144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133503144">(Sep 07 2018 at 10:49)</a>:</h4>
<p>just goes to show how badly sleep deprived I have been. <span class="emoji emoji-1f62a" title="sleepy">:sleepy:</span> <span class="emoji emoji-2639" title="sad">:sad:</span></p>



<a name="133529793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133529793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133529793">(Sep 07 2018 at 18:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>  ping</p>



<a name="133531927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133531927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133531927">(Sep 07 2018 at 19:27)</a>:</h4>
<p><span class="user-mention" data-user-id="116118">@Matthew Jasper</span> pong</p>



<a name="133532298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133532298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133532298">(Sep 07 2018 at 19:34)</a>:</h4>
<p>Just a reminder that this exists.</p>



<a name="133678500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133678500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133678500">(Sep 10 2018 at 18:04)</a>:</h4>
<p><span class="user-mention" data-user-id="116118">@Matthew Jasper</span> </p>
<p>Reading your <a href="#narrow/stream/122657-wg-nll/subject/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows/near/133229373" title="#narrow/stream/122657-wg-nll/subject/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows/near/133229373">big comment</a>:</p>
<blockquote>
<p>When we check for conflicts with them, if the access place is a strict prefix of the borrow place then we don't consider that a conflict.</p>
</blockquote>
<p>I think you have this reversed, maybe? That is, I think you mean "if the <em>borrow</em> place is a strict prefix of the <em>access</em> place". That at least fits your example: "a Shallow borrow of <code>x</code> does not conflict with any access or borrow of <code>x.0</code> or <code>*x</code>"</p>
<blockquote>
<p>When building matches we take a Shallow borrow of any Place that we switch on, and any pointer that's dereferenced in that Place.</p>
</blockquote>
<p>This sounds good, though I think I would say "we take a shallow borrow on all prefixes of any place that we switch on". </p>
<p>I'm not sure about "all pointer dereferences". For example, if you have a pattern like <code>&amp;_</code>, do we count <em>that</em>? I sort of think not, but it's unclear. It interacts somewhat with unsafe code guidelines, actually, in that this <em>might</em> be used to imply that the pointer has a valid type (but in that scenario one would normally have a pattern more like <code>&amp;!</code> or something).</p>
<blockquote>
<p>we should have enough fake edges to only need to do this on the last arm</p>
</blockquote>
<p>Hmm. Perhaps true but it makes me a bit nervous to only do the last arm. =) In part this is for the future: e.g., if we start to remove fake borrows, I don't want us to forget that we now have to add reads.</p>
<blockquote>
<p>Change ReadForMatch to only check for initializedness</p>
</blockquote>
<p>Hmm. So I think eventually we should adopt <a href="http://smallcultfollowing.com/babysteps/blog/2018/08/13/never-patterns-exhaustive-matching-and-uninhabited-types-oh-my/" target="_blank" title="http://smallcultfollowing.com/babysteps/blog/2018/08/13/never-patterns-exhaustive-matching-and-uninhabited-types-oh-my/">the <code>!</code> pattern proposal that I blogged about the other day</a>, which would address this. In particular, you would have <code>match x { ! }</code>, and the <code>!</code> would be considered a "switch", so we would get a "fake borrow", which would in turn prevent <code>x</code> from being uninitialized. </p>
<p>This is probably "close enough" to what you are doing here, at least for now. </p>
<p>I'm trying to think if there are other examples to be concerned about ...</p>



<a name="133678504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133678504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133678504">(Sep 10 2018 at 18:04)</a>:</h4>
<p>Sorry for taking so long</p>



<a name="133681170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681170">(Sep 10 2018 at 18:46)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> </p>
<blockquote>
<p>I think you have this reversed, maybe? That is, I think you mean "if the <em>borrow</em> place is a strict prefix of the <em>access</em> place". That at least fits your example: "a Shallow borrow of <code>x</code> does not conflict with any access or borrow of <code>x.0</code> or <code>*x</code>"</p>
</blockquote>
<p>Yes. :face palm:. </p>
<blockquote>
<p>I'm not sure about "all pointer dereferences". For example, if you have a pattern like <code>&amp;_</code>, do we count <em>that</em>? </p>
</blockquote>
<p>No, we aren't switching or binding on any place behind the reference.</p>
<blockquote>
<p>Hmm. So I think eventually we should adopt <a href="http://smallcultfollowing.com/babysteps/blog/2018/08/13/never-patterns-exhaustive-matching-and-uninhabited-types-oh-my/" target="_blank" title="http://smallcultfollowing.com/babysteps/blog/2018/08/13/never-patterns-exhaustive-matching-and-uninhabited-types-oh-my/">the <code>!</code> pattern proposal that I blogged about the other day</a></p>
</blockquote>
<p>Indeed, but we need something before then.</p>



<a name="133681187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681187">(Sep 10 2018 at 18:47)</a>:</h4>
<p>I just want to be sure we are doing something "sort of compatible" with that</p>



<a name="133681189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681189">(Sep 10 2018 at 18:47)</a>:</h4>
<p>I .. think we are :P</p>



<a name="133681209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681209">(Sep 10 2018 at 18:47)</a>:</h4>
<blockquote>
<p>No, we aren't switching or binding on any place behind the reference.</p>
</blockquote>



<a name="133681255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681255">(Sep 10 2018 at 18:48)</a>:</h4>
<p>it seems like we can define a set of things that must not change (e.g., those we are "switching" on) and then borrow all the prefixes</p>



<a name="133681259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681259">(Sep 10 2018 at 18:48)</a>:</h4>
<p>basically that <code>Place</code> must continue to evaluate to the same value throughout the match</p>



<a name="133681280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681280">(Sep 10 2018 at 18:49)</a>:</h4>
<p>I am happy, I think, modeling that as many small borrows — though you could imagine modeling it as a distinct kind of borrow</p>



<a name="133681282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681282">(Sep 10 2018 at 18:49)</a>:</h4>
<p>one for which <code>places_conflict</code> might act differently</p>



<a name="133681291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681291">(Sep 10 2018 at 18:49)</a>:</h4>
<p>(in fact, it's just "prefix of"?)</p>



<a name="133681345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681345">(Sep 10 2018 at 18:50)</a>:</h4>
<p>I have to look at that</p>



<a name="133681360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681360">(Sep 10 2018 at 18:50)</a>:</h4>
<p>refresh my memory on that code I mean</p>



<a name="133681374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681374">(Sep 10 2018 at 18:50)</a>:</h4>
<p>it seems like <code>each_borrow_involving_path</code> would be the one, probably, that checks the borrow kind</p>



<a name="133681388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681388">(Sep 10 2018 at 18:51)</a>:</h4>
<p>but basically traditional borrows ensure that the <em>memory we reached by evaluating the place</em> doesn't change, but here we want to ensure that we can <em>continue</em> to evaluate the place... an interesting distinction</p>



<a name="133681718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681718">(Sep 10 2018 at 18:57)</a>:</h4>
<blockquote>
<p>(in fact, it's just "prefix of"?)</p>
</blockquote>
<p>It depends on how we want to handle unions.</p>



<a name="133681747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681747">(Sep 10 2018 at 18:58)</a>:</h4>
<p>yeah, right. I think we want to handle them as errors</p>



<a name="133681793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681793">(Sep 10 2018 at 18:58)</a>:</h4>
<p>(that is, the way that you would get from the many shallow borrows)</p>



<a name="133681806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681806">(Sep 10 2018 at 18:58)</a>:</h4>
<p>ps</p>



<a name="133681814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681814">(Sep 10 2018 at 18:58)</a>:</h4>
<p>I think the right way to think of it, still, is as a "discriminant borrow"</p>



<a name="133681841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681841">(Sep 10 2018 at 18:59)</a>:</h4>
<p>oh, well, hmm</p>



<a name="133681850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681850">(Sep 10 2018 at 18:59)</a>:</h4>
<p>I guess the point is that — for the prefixes — that doesn't work</p>



<a name="133681852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681852">(Sep 10 2018 at 18:59)</a>:</h4>
<p>okok</p>



<a name="133681870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681870">(Sep 10 2018 at 18:59)</a>:</h4>
<p>Maybe, but it's a bit strange to call it the discriminant with integers.</p>



<a name="133681877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681877">(Sep 10 2018 at 18:59)</a>:</h4>
<p>"shallow" is a funny term</p>



<a name="133681893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681893">(Sep 10 2018 at 18:59)</a>:</h4>
<p>but I can't think of a better one</p>



<a name="133681951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681951">(Sep 10 2018 at 19:00)</a>:</h4>
<p>Anyway I'll implement a hopefully conservative variant of this and I guess we can see where we stand.</p>



<a name="133681971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681971">(Sep 10 2018 at 19:00)</a>:</h4>
<p>in particular, the fact that (e.g.) a shallow borrow of a tuple means:</p>
<ul>
<li>you can't overwrite the tuple</li>
<li>but you <em>can</em> write to its fields</li>
</ul>
<p>just surprises me a bit.</p>



<a name="133681983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133681983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133681983">(Sep 10 2018 at 19:00)</a>:</h4>
<p>yes, I'm basically <span class="emoji emoji-1f44d" title="+1">:+1:</span> on the idea</p>



<a name="133682150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133682150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133682150">(Sep 10 2018 at 19:03)</a>:</h4>
<blockquote>
<p>in particular, the fact that (e.g.) a shallow borrow of a tuple means:</p>
<ul>
<li>you can't overwrite the tuple</li>
<li>but you <em>can</em> write to its fields</li>
</ul>
<p>just surprises me a bit.</p>
</blockquote>
<p>True, but we won't ever create a shallow borrow of a tuple but none of its fields.</p>



<a name="133683098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133683098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133683098">(Sep 10 2018 at 19:18)</a>:</h4>
<p>it's more that I affect "shallow" to mean "not through a pointer deref"</p>



<a name="133683099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133683099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133683099">(Sep 10 2018 at 19:18)</a>:</h4>
<p>but that's not quite what this means</p>



<a name="133683103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133683103" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133683103">(Sep 10 2018 at 19:18)</a>:</h4>
<p>anyway, it's fine</p>



<a name="133683104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133683104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133683104">(Sep 10 2018 at 19:18)</a>:</h4>
<p>maybe we find another name</p>



<a name="133683106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133683106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133683106">(Sep 10 2018 at 19:18)</a>:</h4>
<p>regardless, it does feel like we need a new concept</p>



<a name="133683109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133683109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133683109">(Sep 10 2018 at 19:18)</a>:</h4>
<p>that doesn't already exist</p>



<a name="133843543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133843543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133843543">(Sep 12 2018 at 21:00)</a>:</h4>
<p>Current state:<br>
<a href="https://gist.github.com/matthewjasper/20706927286a2f81768dc67a175b15d2" target="_blank" title="https://gist.github.com/matthewjasper/20706927286a2f81768dc67a175b15d2">https://gist.github.com/matthewjasper/20706927286a2f81768dc67a175b15d2</a></p>



<a name="133843818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133843818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133843818">(Sep 12 2018 at 21:05)</a>:</h4>
<p>reading</p>



<a name="133843820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133843820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133843820">(Sep 12 2018 at 21:05)</a>:</h4>
<p>nice!</p>



<a name="133843831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133843831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133843831">(Sep 12 2018 at 21:05)</a>:</h4>
<p>what is <code>v</code> <a href="https://gist.github.com/matthewjasper/20706927286a2f81768dc67a175b15d2#file-match-guards-partially-borrows-rs-L57" target="_blank" title="https://gist.github.com/matthewjasper/20706927286a2f81768dc67a175b15d2#file-match-guards-partially-borrows-rs-L57">here</a>?</p>



<a name="133843892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133843892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133843892">(Sep 12 2018 at 21:06)</a>:</h4>
<p>also, maybe add a variant of <code>fn bad_indirect_mutation_in_guard</code> that uses the new patterns</p>



<a name="133843896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133843896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133843896">(Sep 12 2018 at 21:06)</a>:</h4>
<p><code>s</code>, but the neither me nor the compile read comments. :P</p>



<a name="133843904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/133843904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#133843904">(Sep 12 2018 at 21:06)</a>:</h4>
<p>e.g., </p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">bad_indirect_mutation_in_guard</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">v</span>: <span class="kp">&amp;</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kc">true</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="kc">false</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">//~ ERROR</span>
<span class="w">            </span><span class="kc">false</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="kc">false</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="134007262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134007262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134007262">(Sep 15 2018 at 10:44)</a>:</h4>
<p>Pushed</p>



<a name="134120721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134120721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134120721">(Sep 17 2018 at 19:09)</a>:</h4>
<p>Ok, so the problem is that the fake borrows are sometimes dereferencing pointers in inactive variants (or something like that)</p>



<a name="134120744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134120744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134120744">(Sep 17 2018 at 19:09)</a>:</h4>
<p>This will segfault:</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span>: <span class="nb">Option</span><span class="o">&lt;&amp;&amp;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">i32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">(</span><span class="nb">None</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="134120848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134120848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134120848">(Sep 17 2018 at 19:11)</a>:</h4>
<p>So I'm planning to create a MIR transform to remove them. But I'm wondering why there isn't already a pass to remove <code>ReadForMatch</code>es?</p>



<a name="134123953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134123953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134123953">(Sep 17 2018 at 20:15)</a>:</h4>
<blockquote>
<p>So I'm planning to create a MIR transform to remove them. But I'm wondering why there isn't already a pass to remove <code>ReadForMatch</code>es?</p>
</blockquote>
<p>I suspect there is -- but probably not to remove the <em>borrows</em>?</p>



<a name="134124414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134124414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134124414">(Sep 17 2018 at 20:23)</a>:</h4>
<p>They seem to survive up to codegen judging by emit mir output. Not removing the borrows is expected though.</p>



<a name="134125957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134125957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134125957">(Sep 17 2018 at 20:55)</a>:</h4>
<p>They may just be made a no-op at codegen time I guess</p>



<a name="134521262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134521262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134521262">(Sep 24 2018 at 11:49)</a>:</h4>
<p><span class="user-mention" data-user-id="116118">@Matthew Jasper</span> what can a <code>ShallowBorrow</code>actually inspect on a place, since it will not conflict with any projection into that place? Is it <em>solely</em> for the discriminant? Or is it also for the array-length? Is it for <em>all</em> metadata (like discriminant and array-length) that is not covered by the set of things that can be borrowed via MIR-projections?</p>



<a name="134521477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134521477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134521477">(Sep 24 2018 at 11:54)</a>:</h4>
<p>The list is something like discriminants, array lengths the value of a numeric type (or char or bool), and the value of a reference, but not what it points to.</p>



<a name="134521491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134521491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134521491">(Sep 24 2018 at 11:55)</a>:</h4>
<p>oh interesting, I hadn't consider the pointer value of the reference</p>



<a name="134521575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134521575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134521575">(Sep 24 2018 at 11:57)</a>:</h4>
<p>If you get a chance, it might be nice to add that list of concrete examples; the current comment leads one to see the discriminant as one example, but seeing the others as you listed here, even if you don't intend for it to be an exhaustive enumeration of the possibilities, is useful.</p>



<a name="134521589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353114%2C%20%2353438%20-%20%60_%60%20patterns%20should%20not%20count%20as%20borrows/near/134521589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353114.2C.20.2353438.20-.20.60_.60.20patterns.20should.20not.20count.20as.20borrows.html#134521589">(Sep 24 2018 at 11:57)</a>:</h4>
<p>and my description of it being for "metadata" would be misleading, since you've pointed out there are things like numeric values that are not metadata, but as also not projections.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>