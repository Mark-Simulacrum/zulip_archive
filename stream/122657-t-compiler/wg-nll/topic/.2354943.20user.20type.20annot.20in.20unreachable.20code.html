<html>
<head><meta charset="utf-8"><title>#54943 user type annot in unreachable code · t-compiler/wg-nll · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/index.html">t-compiler/wg-nll</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html">#54943 user type annot in unreachable code</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="147335722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147335722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147335722">(Nov 08 2018 at 22:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> I'd be interested in digging into this issue a little, particularly the first proposed solution by <span class="user-mention" data-user-id="116009">@nikomatsakis</span> if you don't mind me taking it off your plate <span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>



<a name="147335736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147335736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147335736">(Nov 08 2018 at 22:50)</a>:</h4>
<p>please do!</p>



<a name="147531475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147531475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147531475">(Nov 12 2018 at 15:20)</a>:</h4>
<p>Just an update on where I'm at with this: yesterday made the refactoring that moved user type ascriptions into an <code>IndexVec</code> on the <code>Mir</code> - got that all compiling but hitting an ICE that I've not had bunch time to look into.  Going to keep digging on this tonight.</p>



<a name="147540765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147540765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147540765">(Nov 12 2018 at 17:54)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> I think that approach is still the one I expect to work</p>



<a name="147540766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147540766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147540766">(Nov 12 2018 at 17:54)</a>:</h4>
<p>:)</p>



<a name="147540784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147540784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147540784">(Nov 12 2018 at 17:54)</a>:</h4>
<p>I expect it will. Fairly sure the ICE is a mistake I’ve made.</p>



<a name="147626709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147626709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147626709">(Nov 13 2018 at 21:28)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Would you be able to clarify the second half of your proposed fix? I'm not super clear on how I'd go about doing that. </p>
<p>So far I've moved the information that was previously in <code>StatementKind::AscribeUserTy</code> into the <code>IndexVec</code> in the <code>Mir</code> (I also added a <code>Span</code> as suggested) and then changed that statement kind to just keep an index. </p>
<p>That compiles but was ICE'ing somewhere in the serialization code from derives - so I tried a full rebuild and now it struggles to compile <code>rustc</code> in stage 1 (it can do everything before that) with a <code>error: internal compiler error: librustc_mir/borrow_check/nll/universal_regions.rs:754: cannot convert `ReScope(Remainder { block: ItemLocalId(2120), first_statement_index: 0})` to a region vid</code>.</p>
<p>Figured I might just need to continue on with the implementation and it might be a symptom of that. I assumed doing the refactoring into an <code>IndexVec</code> might be doable in isolation.</p>



<a name="147627094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147627094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147627094">(Nov 13 2018 at 21:34)</a>:</h4>
<p>(as far as I can tell, the only change that seems like it'd have an impact in that refactoring is that the <code>visit_place</code> call that normally came from visiting <code>StatementKind::AscribeUserTy</code> doesn't happen because the <code>Place&lt;'tcx&gt;</code> is now stored in the <code>IndexVec</code> and so when the visitor gets to that <code>StatementKind</code> it doesn't have that to call <code>visit_place</code> with. Similarly, when visiting the items in the <code>IndexVec</code> (much like how the visiting locals happens), I don't have the <code>Location</code> - so I can't <code>visit_place</code> then either)</p>



<a name="147628403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147628403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147628403">(Nov 13 2018 at 21:55)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> it feels like that refactoring should be do-able in isolation</p>



<a name="147628406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147628406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147628406">(Nov 13 2018 at 21:55)</a>:</h4>
<p>maybe worth opening a [WIP] PR..</p>



<a name="147628446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147628446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147628446">(Nov 13 2018 at 21:56)</a>:</h4>
<p>Sure thing.</p>



<a name="147628451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147628451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147628451">(Nov 13 2018 at 21:56)</a>:</h4>
<p>I don't remember what the second half of my instructions were</p>



<a name="147628452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147628452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147628452">(Nov 13 2018 at 21:56)</a>:</h4>
<p>so i'll have to check</p>



<a name="147628462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147628462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147628462">(Nov 13 2018 at 21:56)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/54943#issuecomment-430633005" target="_blank" title="https://github.com/rust-lang/rust/issues/54943#issuecomment-430633005">link to comment</a></p>



<a name="147628464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147628464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147628464">(Nov 13 2018 at 21:56)</a>:</h4>
<p>oh, right</p>



<a name="147628689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147628689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147628689">(Nov 13 2018 at 22:00)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/55937" target="_blank" title="https://github.com/rust-lang/rust/issues/55937">#55937</a></p>



<a name="147630268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147630268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147630268">(Nov 13 2018 at 22:29)</a>:</h4>
<p>Debugging an issue that happens compiling compiler crates is incredibly painful.</p>



<a name="147630571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147630571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147630571">(Nov 13 2018 at 22:35)</a>:</h4>
<p>Only 17G of logs..</p>



<a name="147631039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147631039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147631039">(Nov 13 2018 at 22:43)</a>:</h4>
<p>There's so much here I don't even know where I'd start. Seeing mentions of <code>bb738</code> and higher..</p>



<a name="147670108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670108">(Nov 14 2018 at 14:18)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> I have some advice :)</p>



<a name="147670149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670149">(Nov 14 2018 at 14:18)</a>:</h4>
<p>which crate is failing, first of all?</p>



<a name="147670151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670151">(Nov 14 2018 at 14:18)</a>:</h4>
<p><code>rustc</code></p>



<a name="147670156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670156">(Nov 14 2018 at 14:18)</a>:</h4>
<p>ok, that's good</p>



<a name="147670158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670158">(Nov 14 2018 at 14:18)</a>:</h4>
<p>that means libstd is available</p>



<a name="147670165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670165">(Nov 14 2018 at 14:18)</a>:</h4>
<p>so, obviosuly, trying to narrow down to a smaller example is the best thing</p>



<a name="147670182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670182">(Nov 14 2018 at 14:19)</a>:</h4>
<p>in a pinch, I sometimes resort to this</p>
<div class="codehilite"><pre><span></span>RUST_LOG=rustc::foo rustc 2&gt;&amp;1 | tail -100000 &gt; killme
</pre></div>


<p>i.e., keep only the last 100,000 lines of log</p>



<a name="147670185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670185">(Nov 14 2018 at 14:19)</a>:</h4>
<p>that's usually enough to capture the problem, without having an 17GB file</p>



<a name="147670209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670209">(Nov 14 2018 at 14:19)</a>:</h4>
<p>I'll definitely tail it like that if I need to do this again.</p>



<a name="147670210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670210">(Nov 14 2018 at 14:19)</a>:</h4>
<p>you might also consider checking the run-pass tests</p>



<a name="147670219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670219">(Nov 14 2018 at 14:19)</a>:</h4>
<p>But I've got the 17G file now.</p>



<a name="147670229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670229">(Nov 14 2018 at 14:19)</a>:</h4>
<p>well, I personally find tools die on that :)</p>



<a name="147670265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670265">(Nov 14 2018 at 14:20)</a>:</h4>
<p>but yes you could just tail the file :)</p>



<a name="147670300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670300">(Nov 14 2018 at 14:20)</a>:</h4>
<p>Fair, <code>less</code> seemed to be able to handle it.</p>



<a name="147670301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670301">(Nov 14 2018 at 14:20)</a>:</h4>
<p>I also tend to do a lot of "grep"</p>



<a name="147670307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670307">(Nov 14 2018 at 14:20)</a>:</h4>
<p>so having a smaller file helps there</p>



<a name="147670314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670314">(Nov 14 2018 at 14:20)</a>:</h4>
<p>anyway, yes, less is one of those tools that scales pretty well</p>



<a name="147670327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670327">(Nov 14 2018 at 14:20)</a>:</h4>
<p>is it ICEing?</p>



<a name="147670373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670373">(Nov 14 2018 at 14:21)</a>:</h4>
<p>It is.</p>



<a name="147670599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670599">(Nov 14 2018 at 14:25)</a>:</h4>
<p>OK</p>



<a name="147670645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670645">(Nov 14 2018 at 14:25)</a>:</h4>
<p><a href="https://gist.githubusercontent.com/davidtwco/b0ee3419cd55d57cc09fd6662c5ecb66/raw/e33ab48a347ac64b44b0bc62edfe2567b0f33286/gistfile1.txt" target="_blank" title="https://gist.githubusercontent.com/davidtwco/b0ee3419cd55d57cc09fd6662c5ecb66/raw/e33ab48a347ac64b44b0bc62edfe2567b0f33286/gistfile1.txt">Here's the last 10k lines</a>. ICE is at the very bottom.</p>



<a name="147670730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670730">(Nov 14 2018 at 14:26)</a>:</h4>
<p>It doesn't have the MIR build where the <code>add_user_ty_ascription</code> call (new function, adds to the new <code>IndexVec</code>) happens in that, but I've triple checked that those add the same things into the <code>IndexVec</code> that were previously added into the statements (just by looking at the code).</p>



<a name="147670872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147670872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147670872">(Nov 14 2018 at 14:28)</a>:</h4>
<p><a href="https://gist.github.com/davidtwco/a9fad44260a6758d1f5a1be7c18bfeac" target="_blank" title="https://gist.github.com/davidtwco/a9fad44260a6758d1f5a1be7c18bfeac">Here's the gist with the add_user_ty_ascription</a> - the one being asserted is added at the very bottom.</p>



<a name="147671157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147671157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147671157">(Nov 14 2018 at 14:32)</a>:</h4>
<p>Didn't make much progress digging into this last night and haven't had a chance to look into it much today.</p>



<a name="147672049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147672049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147672049">(Nov 14 2018 at 14:45)</a>:</h4>
<p><code>run-pass</code> tests are a good tip, very helpful for making the issue more manageable. Sadly, every <code>run-pass</code> failure I'm seeing is completely unrelated.</p>



<a name="147676207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147676207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147676207">(Nov 14 2018 at 15:20)</a>:</h4>
<blockquote>
<p>tend to do a lot of "grep"</p>
</blockquote>
<p>Clearly you mean <code>rg</code> ;-)</p>



<a name="147677157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147677157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147677157">(Nov 14 2018 at 15:31)</a>:</h4>
<p>Attempted to add in a <code>visit_place</code> that was lost in the visitor with the refactor - ended up causing an ICE earlier in stage1 at a seemingly more unrelated place.</p>



<a name="147677177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147677177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147677177">(Nov 14 2018 at 15:31)</a>:</h4>
<blockquote>
<p>(as far as I can tell, the only change that seems like it'd have an impact in that refactoring is that the <code>visit_place</code> call that normally came from visiting <code>StatementKind::AscribeUserTy</code> doesn't happen because the <code>Place&lt;'tcx&gt;</code> is now stored in the <code>IndexVec</code> and so when the visitor gets to that <code>StatementKind</code> it doesn't have that to call <code>visit_place</code> with. Similarly, when visiting the items in the <code>IndexVec</code> (much like how the visiting locals happens), I don't have the <code>Location</code> - so I can't <code>visit_place</code> then either)</p>
</blockquote>
<p>(context for the missing <code>visit_place</code>)</p>



<a name="147677673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147677673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147677673">(Nov 14 2018 at 15:38)</a>:</h4>
<p>[Quoting…]<br>
 sadly this is often the case :( </p>
<p>does mean we should try to make a reduced test case :)</p>



<a name="147678833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147678833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147678833">(Nov 14 2018 at 15:53)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc/ty/layout.rs#L416-L418" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc/ty/layout.rs#L416-L418">This line</a> seems to be the one causing the type annotation error.</p>



<a name="147678841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147678841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147678841">(Nov 14 2018 at 15:53)</a>:</h4>
<p>I'm not sure what case that falls under.</p>



<a name="147678933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147678933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147678933">(Nov 14 2018 at 15:54)</a>:</h4>
<p>According to the spans that are saved at the MIR build; types look like the ones being mentioned too.</p>



<a name="147683635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147683635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147683635">(Nov 14 2018 at 17:00)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> took a quick look at the PR, first of all, and <a href="https://github.com/rust-lang/rust/pull/55937#pullrequestreview-174969318" target="_blank" title="https://github.com/rust-lang/rust/pull/55937#pullrequestreview-174969318">left some comments</a> -- more questions than answers, I'm afraid</p>



<a name="147683663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147683663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147683663">(Nov 14 2018 at 17:00)</a>:</h4>
<p>Well, actually</p>



<a name="147683671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147683671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147683671">(Nov 14 2018 at 17:01)</a>:</h4>
<p>I suspect your ICE is indeed caused by the change to the visitor</p>



<a name="147683686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147683686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147683686">(Nov 14 2018 at 17:01)</a>:</h4>
<p>In particular, not visiting the <code>Place</code> means we will no longer "renumber" the regions within</p>



<a name="147684595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147684595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147684595">(Nov 14 2018 at 17:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> thanks for taking a look. The main issue I found with calling visit_place is that it requires a <code>Location</code> which I don’t have at that point in the visitor any more.</p>



<a name="147684662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147684662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147684662">(Nov 14 2018 at 17:18)</a>:</h4>
<p>I tried to put a location into <code>UserTypeAscriptionData</code> but that didn’t quite work. Got it compiling but it would ICE earlier for a stranger reason that I didn’t look too much into.</p>



<a name="147684698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147684698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147684698">(Nov 14 2018 at 17:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> yeah, I figured this was part of it; well, this is partly why I suggested not pulling out so many fields</p>



<a name="147684705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147684705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147684705">(Nov 14 2018 at 17:19)</a>:</h4>
<p>but rather just the "core type"</p>



<a name="147684710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147684710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147684710">(Nov 14 2018 at 17:19)</a>:</h4>
<p>however, we could also make a "PlaceContext" that doesn't have a location I think</p>



<a name="147684787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147684787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147684787">(Nov 14 2018 at 17:21)</a>:</h4>
<p><code>PlaceContext</code> doesn’t take a location, it’s just a parameter to the <code>visit_place</code> function.</p>



<a name="147684881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147684881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147684881">(Nov 14 2018 at 17:22)</a>:</h4>
<p>I’m unclear on how this refactoring (and what little I understand of the remaining steps for the larger change) would help with the unreachable code issue though. Since surely the statements that keep indices into our <code>IndexVec</code> will be removed as unreachable in the same way they are now?</p>



<a name="147772755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147772755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147772755">(Nov 15 2018 at 20:56)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Apologies for another ping regarding this issue, would liked to have made more progress by now. Took another attempt at this and still not getting very far. So far, I've tried:</p>
<ul>
<li>(monday) Naive first attempt at refactor into <code>IndexVec</code> w/out visiting place - ICE due to renumbering being skipped.</li>
<li>(wednesday) Refactor into <code>IndexVec</code>, storing a <code>Location</code> into the vec too so that I can <code>visit_place</code> - caused some strange ICE, think it was related to the ugly way I had to create a <code>Location</code> that anticipated the location of the statement that was about to be inserted.</li>
<li>(today) Refactor into <code>IndexVec</code>, removing the statement entirely, iterating over the vec after normal type check visitor. Still can't visit the place to renumber, so manually call the renumbering code on the <code>Ty&lt;'tcx&gt;</code> inside the <code>Place&lt;'tcx&gt;</code> - feels close but can't easily get a mutable reference to the <code>Ty&lt;'tcx&gt;</code> like you get from the visitor, so still ICEs due to renumbering even though I'm calling the renumbering code.</li>
</ul>
<p>I've not yet tried moving the place back into the statement so that it can be visited when the statement is visited - that'd solve the renumbering issue, but I'm unsure how it would solve the issue of user type annotations not being checked in dead code since those statements with less in them could still be removed.</p>



<a name="147777692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777692">(Nov 15 2018 at 22:11)</a>:</h4>
<p>You don't need the place to check for WF</p>



<a name="147777738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777738">(Nov 15 2018 at 22:12)</a>:</h4>
<p>I think you would ideally move <em>more</em> than just the place back into the statement</p>



<a name="147777745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777745">(Nov 15 2018 at 22:12)</a>:</h4>
<p>you would also move the "projections" part</p>



<a name="147777758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777758">(Nov 15 2018 at 22:12)</a>:</h4>
<p>that said, I don't know why you need a location to visit a place, let me double check the visitor</p>



<a name="147777775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777775">(Nov 15 2018 at 22:13)</a>:</h4>
<p>oh, I see, because <code>visit_place</code> wants you to give one :)</p>



<a name="147777794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777794">(Nov 15 2018 at 22:13)</a>:</h4>
<p>Yeah.</p>



<a name="147777806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777806">(Nov 15 2018 at 22:13)</a>:</h4>
<p>we could alter the visitor</p>



<a name="147777820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777820">(Nov 15 2018 at 22:13)</a>:</h4>
<p>but I feel like we should avoid that for now</p>



<a name="147777832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777832">(Nov 15 2018 at 22:13)</a>:</h4>
<p>let me try and explain what I meant by "move the projections part" better</p>



<a name="147777880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777880">(Nov 15 2018 at 22:14)</a>:</h4>
<p>Don't we need to get a <code>Place</code> when we do the wf check <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1297" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1297">here</a>?</p>



<a name="147777890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777890">(Nov 15 2018 at 22:14)</a>:</h4>
<p>Or is that the wrong check?</p>



<a name="147777909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777909">(Nov 15 2018 at 22:14)</a>:</h4>
<p>so we have this</p>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">UserTypeProjection</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">base</span>: <span class="nc">UserTypeAnnotation</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">projs</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ProjectionElem</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="p">,</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="147777914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777914">(Nov 15 2018 at 22:14)</a>:</h4>
<p>I was intending only to move the <code>base</code> field here into the array</p>



<a name="147777919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777919">(Nov 15 2018 at 22:15)</a>:</h4>
<p>and leave the rest as is</p>



<a name="147777929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777929">(Nov 15 2018 at 22:15)</a>:</h4>
<p>i.e., that structure would become</p>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">UserTypeProjection</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">base</span>: <span class="nc">UserTypeAnnotationIndex</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">projs</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ProjectionElem</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="p">,</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="147777940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777940">(Nov 15 2018 at 22:15)</a>:</h4>
<blockquote>
<p>Don't we need to get a <code>Place</code> when we do the wf check <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1297" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1297">here</a>?</p>
</blockquote>
<p>that is not the wf check</p>



<a name="147777948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777948">(Nov 15 2018 at 22:15)</a>:</h4>
<p>that is relating the type of the place to the user-given type</p>



<a name="147777951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777951">(Nov 15 2018 at 22:15)</a>:</h4>
<p>that stuff would stay the same</p>



<a name="147777957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777957">(Nov 15 2018 at 22:15)</a>:</h4>
<p>or, well, not the <em>same</em></p>



<a name="147777960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147777960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147777960">(Nov 15 2018 at 22:15)</a>:</h4>
<p>but it would still occur at that time</p>



<a name="147778019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778019">(Nov 15 2018 at 22:16)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1017-L1018" target="_blank" title="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1017-L1018">this part</a> we would probably do earlier, ahead of time, just by iterating over the <code>IndexVec</code> and creating a new <code>instantiated_types: IndexVec&lt;UserTypeAnnotationIndex, Ty&lt;'tcx&gt;&gt;</code></p>



<a name="147778037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778037">(Nov 15 2018 at 22:16)</a>:</h4>
<p>Ah, I thought the issue was that that code wasn't being called because the <code>AscribeUserType</code> statements were being removed, so the intent was to stop the data required for that being kept in a statement. <span class="emoji emoji-1f926" title="face palm">:face_palm:</span></p>



<a name="147778056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778056">(Nov 15 2018 at 22:17)</a>:</h4>
<p>at the end, we would also go over all the things in that vec, and try to prove them well-formed</p>



<a name="147778062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778062">(Nov 15 2018 at 22:17)</a>:</h4>
<p>using <code>Locations::All</code> I guess</p>



<a name="147778076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778076">(Nov 15 2018 at 22:17)</a>:</h4>
<p>but the <code>relate_type_and_user_type</code> code would stay mostly the same,</p>



<a name="147778082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778082">(Nov 15 2018 at 22:17)</a>:</h4>
<p>except that it reads the instantiated type from the vector</p>



<a name="147778088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778088">(Nov 15 2018 at 22:17)</a>:</h4>
<p>instead of doing that work itself</p>



<a name="147778148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778148">(Nov 15 2018 at 22:18)</a>:</h4>
<p>I guess we would also want to <a href="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1026" target="_blank" title="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1026">normalize</a> the instantiated type</p>



<a name="147778152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778152">(Nov 15 2018 at 22:18)</a>:</h4>
<p>So where is the wf check now?</p>



<a name="147778224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778224">(Nov 15 2018 at 22:19)</a>:</h4>
<p>hmm</p>



<a name="147778238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778238">(Nov 15 2018 at 22:19)</a>:</h4>
<p>I think it depends</p>



<a name="147778242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778242">(Nov 15 2018 at 22:19)</a>:</h4>
<p>:)</p>



<a name="147778258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778258">(Nov 15 2018 at 22:20)</a>:</h4>
<p>there are the two branches</p>



<a name="147778303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778303">(Nov 15 2018 at 22:20)</a>:</h4>
<p>on the <a href="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1060" target="_blank" title="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1060">*other* branch</a>, we wind up <a href="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_traits/type_op.rs#L195" target="_blank" title="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_traits/type_op.rs#L195">here</a></p>



<a name="147778346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778346">(Nov 15 2018 at 22:20)</a>:</h4>
<p>I'm trying to decide if that has to change :P</p>



<a name="147778354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778354">(Nov 15 2018 at 22:20)</a>:</h4>
<p>I think that path comes up when you do stuff like</p>



<a name="147778385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778385">(Nov 15 2018 at 22:21)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">&#39;static</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span>::<span class="o">&lt;&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="c1">// no error</span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="147778395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778395">(Nov 15 2018 at 22:21)</a>:</h4>
<p>(I confess that some part of me is back to wanting to say "screw it, this is fine as is")</p>



<a name="147778447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778447">(Nov 15 2018 at 22:22)</a>:</h4>
<blockquote>
<p>I think that path comes up when you do stuff like</p>
</blockquote>
<p>i.e,. the user didn't write a full type, but rather supplied explicit arguments to something</p>



<a name="147778466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778466">(Nov 15 2018 at 22:22)</a>:</h4>
<p>if the user wrote a full type, I don't think we explicitly prove well-formedness today</p>



<a name="147778472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778472">(Nov 15 2018 at 22:22)</a>:</h4>
<p>instead, we relate it to the type of the place, which we expect to be WF</p>



<a name="147778492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778492">(Nov 15 2018 at 22:22)</a>:</h4>
<p>i.e., in <a href="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1016" target="_blank" title="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1016">this branch</a></p>



<a name="147778524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778524">(Nov 15 2018 at 22:23)</a>:</h4>
<p>vs <a href="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1060" target="_blank" title="https://github.com/rust-lang/rust/blob/6b9b97bd9b704f85f0184f7a213cc4d62bd9654c/src/librustc_mir/borrow_check/nll/type_check/mod.rs#L1060">this branch</a>, which is covering the "explicit substitution" case</p>



<a name="147778534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778534">(Nov 15 2018 at 22:23)</a>:</h4>
<p>/me wishes there were more comments, blames self</p>



<a name="147778549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778549">(Nov 15 2018 at 22:23)</a>:</h4>
<p>I appreciate your patience with this issue, I've been going the completely wrong direction with it all week.</p>



<a name="147778602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778602">(Nov 15 2018 at 22:24)</a>:</h4>
<p>well I appreciate <em>your</em> patience</p>



<a name="147778604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778604">(Nov 15 2018 at 22:24)</a>:</h4>
<p>:)</p>



<a name="147778617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778617">(Nov 15 2018 at 22:24)</a>:</h4>
<p>sorry i've been scattered this week, took me a while to catch up, now trying to track down some regressions :/</p>



<a name="147778686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147778686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147778686">(Nov 15 2018 at 22:25)</a>:</h4>
<p>No worries. Now I've got some idea what is actually happening here I should be able to work something together tomorrow.</p>



<a name="147783963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147783963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147783963">(Nov 16 2018 at 00:03)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> </p>
<blockquote>
<p>sorry i've been scattered this week, took me a while to catch up, now trying to track down some regressions <span class="emoji emoji-1f615" title="confused">:confused:</span></p>
</blockquote>
<p>Is there a list of these regressions somewhere ?</p>



<a name="147835045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147835045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147835045">(Nov 16 2018 at 18:16)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Pushed a new commit that is way closer to what we want. I had to change more than I thought to be able to check for well-formed-ness (presuming that I did that correctly, of course) but it should be doing that. For some reason, on a bunch of tests (probably the majority) we're seeing errors from <code>libserialize</code>. There are tests that have type annotations that work, so I don't really know what's going on. The test case that we're looking to fix for this issue fails with that ICE so I don't know if this actually fixes the issue yet.</p>



<a name="147835092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147835092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147835092">(Nov 16 2018 at 18:16)</a>:</h4>
<p>I can change the way I did some of the things if you're not happy with them, it was a bit more invasive that I'd have expected.</p>



<a name="147835100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147835100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147835100">(Nov 16 2018 at 18:16)</a>:</h4>
<p>And I might have missed a simpler way.</p>



<a name="147835600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147835600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147835600">(Nov 16 2018 at 18:25)</a>:</h4>
<p>It occurs to me that I might have misinterpreted what you meant yesterday and should just invoke the same query again with the already-instantiated type instead of this new one that I've made.</p>



<a name="147835611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147835611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147835611">(Nov 16 2018 at 18:25)</a>:</h4>
<p>Either way, I suspect that will not fix the serialize errors I'm seeing.</p>



<a name="147836573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147836573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147836573">(Nov 16 2018 at 18:41)</a>:</h4>
<p>Hadn't tried a stage0 build so hadn't noticed the error on Travis. Will need to think about how to tackle that - the way I'd worked around that to be able to continue was quite hacky.</p>



<a name="147839377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147839377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147839377">(Nov 16 2018 at 19:23)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> these changes are reflected in the PR? I'm thinking we should remove this from the milestone for two reasons (you may have seen me comment on discord):</p>
<ul>
<li>Bug is obscure</li>
<li>Too big of a change to want to backport</li>
</ul>



<a name="147839387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147839387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147839387">(Nov 16 2018 at 19:23)</a>:</h4>
<p>doesn't seem worth the risk</p>



<a name="147839401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147839401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147839401">(Nov 16 2018 at 19:23)</a>:</h4>
<p>(not to say we shoudln't keep working on it, just lowers the priority level somewhat)</p>



<a name="147839487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147839487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147839487">(Nov 16 2018 at 19:24)</a>:</h4>
<p>(done)</p>



<a name="147839491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147839491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147839491">(Nov 16 2018 at 19:24)</a>:</h4>
<p>I’ve got something compiling for the issue on Travis. Don’t know if it works yet because I’m walking home.</p>



<a name="147839497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147839497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147839497">(Nov 16 2018 at 19:24)</a>:</h4>
<p>That’s fine, makes sense.</p>



<a name="147849081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147849081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147849081">(Nov 16 2018 at 21:58)</a>:</h4>
<p>Pushed another change. Stripped it back a bit, the way I was doing the wf check wasn't right at all. This just has the refactor, but even that isn't quite right - it causes two ICEs, but it's nearly there.</p>



<a name="147849317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147849317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147849317">(Nov 16 2018 at 22:02)</a>:</h4>
<p>I had it sort-of working for the <code>UserTypeAnnotation::TypeOf</code> variant, but not the other variant.</p>



<a name="147849331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147849331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147849331">(Nov 16 2018 at 22:03)</a>:</h4>
<p>And the other variant happened to be what was generated for the test case from the issue.</p>



<a name="147851380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/147851380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#147851380">(Nov 16 2018 at 22:41)</a>:</h4>
<p>Pushed another change, still only the refactor, but no error. It's not ideal because there's two <code>IndexVecs</code> now in the <code>TypeChecker</code>.</p>



<a name="148060435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148060435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148060435">(Nov 20 2018 at 19:15)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> reviewing now sorry for the delay</p>



<a name="148060438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148060438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148060438">(Nov 20 2018 at 19:15)</a>:</h4>
<p>looks like the mir-opt tests need updating though</p>



<a name="148060465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148060465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148060465">(Nov 20 2018 at 19:16)</a>:</h4>
<p>I've not made any changes since Friday, was hoping to get to it tonight.</p>



<a name="148060558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148060558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148060558">(Nov 20 2018 at 19:17)</a>:</h4>
<p>I'm not all that happy with the way it is looking. I dislike that I'm using two maps for each variant of <code>UserTypeAnnotation</code> (since I need the substs from the <code>UserTypeAnnotation::TypeOf</code> variant - I found that if I still use the <code>instantiated_types</code> map for that branch then it ICEs, I had to construct and normalize the type where it currently happens).</p>



<a name="148060700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148060700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148060700">(Nov 20 2018 at 19:19)</a>:</h4>
<p>w/r/t checking the well-formedness: Is that only the <code>UserTypeAnnotation::TypeOf</code> branch? If it is, that doesn't cover the case mentioned in the issue since it is the other variant. I had a working branch where the <code>user_self_ty</code> well-formedness check was moved and happening outside of the existing path as we want but it didn't cover the test case. I've not worked out what check I need to do for the other variant in <code>UserTypeAnnotation</code>.</p>



<a name="148060764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148060764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148060764">(Nov 20 2018 at 19:20)</a>:</h4>
<p>My memory might be a bit hazy on the details of above since I haven't looked at it for a few days.</p>



<a name="148061030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061030">(Nov 20 2018 at 19:24)</a>:</h4>
<p>heh I thought it was nice :)</p>



<a name="148061034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061034">(Nov 20 2018 at 19:24)</a>:</h4>
<p>maybe I overlooked something</p>



<a name="148061044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061044">(Nov 20 2018 at 19:24)</a>:</h4>
<p>I actually realize now I didn't look to see if you enforce the WF rules</p>



<a name="148061077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061077">(Nov 20 2018 at 19:24)</a>:</h4>
<p>anyway I guess the WF rules apply to both branches; we just need to do keep the def-id and apply the substitution to the <code>type_of(...)</code></p>



<a name="148061094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061094">(Nov 20 2018 at 19:25)</a>:</h4>
<p>I'm not doing that yet. I had it in for the <code>UserTypeAnnotation::TypeOf</code> case but it wasn't great IMO.</p>



<a name="148061102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061102">(Nov 20 2018 at 19:25)</a>:</h4>
<p>re: the <code>UserTypeAnnotation</code></p>



<a name="148061105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061105">(Nov 20 2018 at 19:25)</a>:</h4>
<p>right now it has this form</p>



<a name="148061112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061112">(Nov 20 2018 at 19:25)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="cp">#[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, RustcEncodable, RustcDecodable)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">UserTypeAnnotation</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Ty</span><span class="p">(</span><span class="n">CanonicalTy</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>

<span class="w">    </span><span class="sd">/// The canonical type is the result of `type_of(def_id)` with the</span>
<span class="w">    </span><span class="sd">/// given substitutions applied.</span>
<span class="w">    </span><span class="n">TypeOf</span><span class="p">(</span><span class="n">DefId</span><span class="p">,</span><span class="w"> </span><span class="n">CanonicalUserSubsts</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="148061116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061116">(Nov 20 2018 at 19:25)</a>:</h4>
<p>but maybe we should change it to</p>



<a name="148061176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061176">(Nov 20 2018 at 19:26)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="cp">#[derive(Copy, Clone, Debug, PartialEq, Eq, Hash, RustcEncodable, RustcDecodable)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">UserTypeAnnotation</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Ty</span><span class="p">(</span><span class="n">Ty</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>

<span class="w">    </span><span class="sd">/// The canonical type is the result of `type_of(def_id)` with the</span>
<span class="w">    </span><span class="sd">/// given substitutions applied.</span>
<span class="w">    </span><span class="n">TypeOf</span><span class="p">(</span><span class="n">DefId</span><span class="p">,</span><span class="w"> </span><span class="n">UserSubsts</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>and move the <code>Canonical</code> out, so we store a <code>Canonical&lt;UserTypeAnnotation&lt;'tcx&gt;&gt;</code></p>



<a name="148061202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061202">(Nov 20 2018 at 19:26)</a>:</h4>
<p>then you could have <code>instantiated_user_types: IndexVec&lt;UserTypeAnnotationIndex, UserTypeAnnotation&lt;'tcx&gt;&gt;</code></p>



<a name="148061221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061221">(Nov 20 2018 at 19:26)</a>:</h4>
<p>(in the type checker)</p>



<a name="148061233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061233">(Nov 20 2018 at 19:26)</a>:</h4>
<p>thoughts?</p>



<a name="148061251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061251">(Nov 20 2018 at 19:27)</a>:</h4>
<p>Am I right that it is <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_traits/type_op.rs#L184-L196" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_traits/type_op.rs#L184-L196">this part</a> of the well-formedness check that we want to extract out to happen w/out the statement?</p>



<a name="148061257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061257">(Nov 20 2018 at 19:27)</a>:</h4>
<p>Yeah, I could try doing that.</p>



<a name="148061273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061273">(Nov 20 2018 at 19:27)</a>:</h4>
<p>(that link is only for the <code>UserTypeAnnotation::TypeOf</code> case)</p>



<a name="148061296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061296">(Nov 20 2018 at 19:27)</a>:</h4>
<p>yes, that looks like the right part</p>



<a name="148061343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061343">(Nov 20 2018 at 19:28)</a>:</h4>
<p>That's what you had linked before, wasn't sure if it was just that.</p>



<a name="148061364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148061364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148061364">(Nov 20 2018 at 19:28)</a>:</h4>
<p>I'd been experimenting with just that part so that's fine.</p>



<a name="148132546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148132546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148132546">(Nov 21 2018 at 19:33)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I'm trying out that change you suggested yesterday to change <code>UserTypeAnnotation&lt;'tcx&gt;</code> with canonicalized types in it to <code>Canonical&lt;'tcx, UserTypeAnnotation&lt;'tcx&gt;&gt;</code> with the normal types in it. I've got that compiling and running, but I get a few ICEs that I'm not quite sure about. It definitely makes some of the code changes to type check related to this issue easier.</p>
<p>To do that, I'm needing to modify where the <code>Ty&lt;'tcx&gt;</code> and <code>UserSubsts&lt;'tcx&gt;</code> were initially being canonicalized in <code>librustc_typeck</code>. Instead of canonicalizing a <code>UserSubsts&lt;'tcx&gt;</code> and storing that so that it can later be put into a <code>UserTypeAnnotation&lt;'tcx&gt;</code>, I'm now making a <code>UserTypeAnnotation&lt;'tcx&gt;</code> at that point and canonicalizing that so it can later be used when building the <code>Mir</code>. I'm not thrilled that I'm needing to use that <code>rustc::mir</code> type in <code>rustc_typeck</code> because I figured we'd want to keep a separation there, but I don't know how else to get around that.</p>
<p>Anyway, this is mostly working - I've got it compiling with around 100 or so tests failing due to an ICE. I get this logging on a build without the change applied:</p>
<div class="codehilite"><pre><span></span>DEBUG 2018-11-21T00:36:33Z: rustc_typeck::check: write_user_substs_from_substs(HirId { owner: DefIndex(0:15), local_id: ItemLocalId(12) }, [_]) in fcx 0x7fff8ef5e150
DEBUG 2018-11-21T00:36:33Z: rustc_typeck::check: instantiate_value_path: user_substs = Canonical { max_universe: U0, variables: [CanonicalVarInfo { kind: Ty(General) }], value: UserSubsts { substs: [^0], user_self_ty: None } }
DEBUG 2018-11-21T00:36:33Z: rustc_typeck::check: write_user_substs(HirId { owner: DefIndex(0:15), local_id: ItemLocalId(12) }, Canonical { max_universe: U0, variables: [CanonicalVarInfo { kind: Ty(General) }], value: UserSubsts { substs: [^0], user_self_ty: None } }) in fcx 0x7fff8ef5e150
DEBUG 2018-11-21T00:36:33Z: rustc_typeck::check: write_user_substs: skipping identity substs
</pre></div>


<p>So that logging is with a <code>UserSubsts&lt;'tcx&gt;</code> being canonicalized. When I canonicalize the whole <code>UserTypeAnnotation&lt;'tcx&gt;</code>, I get this logging:</p>
<div class="codehilite"><pre><span></span>DEBUG 2018-11-21T00:54:55Z: rustc_typeck::check: write_user_type_annotation_from_substs: hir_id=HirId { owner: DefIndex(0:15), local_id: ItemLocalId(12) } def_id=DefId(2/1:13146 ~ core[420c]::option[0]::Option[0]::Some[0]) substs=[_] user_self_ty=None in fcx 0x7ffda113afe0
DEBUG 2018-11-21T00:54:55Z: rustc_typeck::check: write_user_type_annotation_from_substs: canonicalized=Canonical { max_universe: U0, variables: [CanonicalVarInfo { kind: Ty(General) }], value: TypeOf(DefId(2/1:13146 ~ core[420c]::option[0]::Option[0]::Some[0]), UserSubsts { substs: [?0], user_self_ty: None }) }
DEBUG 2018-11-21T00:54:55Z: rustc_typeck::check: write_user_type_annotation: hir_id=HirId { owner: DefIndex(0:15), local_id: ItemLocalId(12) } canonical_user_type_annotation=Canonical { max_universe: U0, variables: [CanonicalVarInfo { kind: Ty(General) }], value: TypeOf(DefId(2/1:13146 ~ core[420c]::option[0]::Option[0]::Some[0]), UserSubsts { substs: [?0], user_self_ty: None }) } tag=0x7ffda113afe0
</pre></div>


<p>I'm going on the perhaps naive assumption that I can just take the types that were being canoncalized, add them as fields to a type and canonicalize that and it works the same. Either way, the <code>is_identity</code> function is now returning <code>true</code> (due to the change from <code>^0</code> to <code>?0</code> - though I don't know what these represent) and that annotation isn't being skipped as it should be.</p>



<a name="148133714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148133714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148133714">(Nov 21 2018 at 19:56)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> </p>
<blockquote>
<p>I'm not thrilled that I'm needing to use that rustc::mir type in rustc_typeck because I figured we'd want to keep a separation there, but I don't know how else to get around that.</p>
</blockquote>
<p>That type is not particularly tied to MIR. It would be OK, I think, to move it so it lives alongside <code>TypeckTables</code></p>



<a name="148133731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148133731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148133731">(Nov 21 2018 at 19:56)</a>:</h4>
<p>what's the ICE you are getting exactly?</p>



<a name="148133977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148133977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148133977">(Nov 21 2018 at 20:00)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc/mir/tcx.rs#L73" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc/mir/tcx.rs#L73">https://github.com/rust-lang/rust/blob/master/src/librustc/mir/tcx.rs#L73</a></p>



<a name="148133981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148133981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148133981">(Nov 21 2018 at 20:00)</a>:</h4>
<p>It comes from that line.</p>



<a name="148133987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148133987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148133987">(Nov 21 2018 at 20:01)</a>:</h4>
<p>Due to the type you’re seeing in the logs.</p>



<a name="148134011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148134011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148134011">(Nov 21 2018 at 20:01)</a>:</h4>
<p>(on phone just now so have limited typing ability)</p>



<a name="148134900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148134900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148134900">(Nov 21 2018 at 20:18)</a>:</h4>
<p>Oops. Not that line, this one: <a href="https://github.com/rust-lang/rust/blob/master/src/librustc/mir/tcx.rs#L149" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc/mir/tcx.rs#L149">https://github.com/rust-lang/rust/blob/master/src/librustc/mir/tcx.rs#L149</a></p>



<a name="148141985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148141985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148141985">(Nov 21 2018 at 22:49)</a>:</h4>
<blockquote>
<p>That type is not particularly tied to MIR. It would be OK, I think, to move it so it lives alongside <code>TypeckTables</code></p>
</blockquote>
<p>I've changed this, much better now.</p>



<a name="148142388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148142388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148142388">(Nov 21 2018 at 22:59)</a>:</h4>
<p>Also managed to fix that above ICE.</p>



<a name="148192115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148192115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148192115">(Nov 22 2018 at 19:38)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Alright, I've finally got something that's compiling and passing tests here. I'm not seeing a massive effect to the tests (including the test case from the linked issue), but I think this does what it is supposed to. PR is updated.</p>



<a name="148192338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148192338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148192338">(Nov 22 2018 at 19:44)</a>:</h4>
<p>Still need to rebase, but doing that now.</p>



<a name="148200866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148200866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148200866">(Nov 23 2018 at 00:29)</a>:</h4>
<p>Huh, didn't notice that failure locally. Will take a look tomorrow.</p>



<a name="148222001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148222001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148222001">(Nov 23 2018 at 10:51)</a>:</h4>
<p>Should have fixed those - was seeing some odd ICE in <code>run-pass</code> locally but wasn't sure if it was just my machine so pushed what I have.</p>



<a name="148225740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148225740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148225740">(Nov 23 2018 at 12:18)</a>:</h4>
<p>Looks like it wasn't just local <span class="emoji emoji-2639" title="sad">:sad:</span></p>



<a name="148367612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148367612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148367612">(Nov 26 2018 at 13:47)</a>:</h4>
<p>Made a decent amount of progress on this PR over the weekend. Added fixes for two other type annotation issues. Still dealing with one (and hopefully the last) ICE in it that affects three run-pass tests. I know which line is causing it, but removing that removes a error that it introduced on another test case that seemed correct - not looked into it that much yet.</p>



<a name="148377935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148377935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148377935">(Nov 26 2018 at 16:17)</a>:</h4>
<p>Struggling to work out what is expected for this sort of case, got <a href="https://gist.githubusercontent.com/davidtwco/4f7dcb7f80cc47b97b49b32470e66b02/raw/501f906f8474c7b6c2c6d6711e9d00d9fb43213b/gistfile1.txt" target="_blank" title="https://gist.githubusercontent.com/davidtwco/4f7dcb7f80cc47b97b49b32470e66b02/raw/501f906f8474c7b6c2c6d6711e9d00d9fb43213b/gistfile1.txt">the log output and backtrace here</a>.</p>



<a name="148394763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148394763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148394763">(Nov 26 2018 at 20:11)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> hey so I'm looking at the PR now</p>



<a name="148395226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148395226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148395226">(Nov 26 2018 at 20:18)</a>:</h4>
<p>much bigger PR than I anticipated :)</p>



<a name="148396761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148396761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148396761">(Nov 26 2018 at 20:41)</a>:</h4>
<p>Yeah, it got big.</p>



<a name="148396818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148396818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148396818">(Nov 26 2018 at 20:42)</a>:</h4>
<p>Mostly the refactor.</p>



<a name="148746359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/148746359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#148746359">(Nov 28 2018 at 21:46)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I’d appreciate if you could take a look at this if you have time, it’s not a priority though. I’ve been finding this ICE relatively impenetrable - not been able to narrow down the root cause of it.</p>



<a name="151203620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151203620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151203620">(Dec 09 2018 at 02:14)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I think I've now fixed that ICE - I experimented with a bunch of solutions but in the end I had to move some of the well-formedness checking back to only reachable code. That's not ideal but it's the best I could get. That said, the well-formedness check that had to be moved was one that I don't think we were doing at all before, so it's still an improvement.</p>
<p>(I spent like three hours on an alternate solution that worked for the tests that were failing, was very pleased when I finally got something that worked, until I made that test's code unreachable and my solution didn't work for it)</p>



<a name="151203621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151203621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151203621">(Dec 09 2018 at 02:14)</a>:</h4>
<p>It passes tests locally but it's 2am and I need sleep, so there might be something Travis catches that I didn't see.</p>



<a name="151477984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151477984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151477984">(Dec 11 2018 at 20:23)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> can you say a bit more about the ICE?</p>



<a name="151478006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478006">(Dec 11 2018 at 20:23)</a>:</h4>
<p>It seems like it came from unresolved type variables?</p>



<a name="151478185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478185">(Dec 11 2018 at 20:27)</a>:</h4>
<p>Yeah, it might be visible in the hidden Travis error GitHub comments <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="151478195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478195">(Dec 11 2018 at 20:27)</a>:</h4>
<p>I feel like I thought that wouldn't happen but now I'm not sure why I thought that</p>



<a name="151478198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478198">(Dec 11 2018 at 20:27)</a>:</h4>
<p>I'm trying to find the test</p>



<a name="151478201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478201">(Dec 11 2018 at 20:27)</a>:</h4>
<p>comment says <code>issue-54943-1.rs</code></p>



<a name="151478257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478257">(Dec 11 2018 at 20:28)</a>:</h4>
<p>oh</p>



<a name="151478258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478258">(Dec 11 2018 at 20:28)</a>:</h4>
<p>that is something added in your PR :)</p>



<a name="151478260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478260">(Dec 11 2018 at 20:28)</a>:</h4>
<p>no wonder I can't find it</p>



<a name="151478263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478263">(Dec 11 2018 at 20:28)</a>:</h4>
<p>Yeah, there were three dropck run-pass tests.</p>



<a name="151478268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478268">(Dec 11 2018 at 20:28)</a>:</h4>
<p>I made them smaller into <code>issue-54943-1.rs</code> and <code>issue-54943-2.rs</code>.</p>



<a name="151478281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478281">(Dec 11 2018 at 20:29)</a>:</h4>
<p>I had a fix that solved the issue unless the same code was unreachable.</p>



<a name="151478285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478285">(Dec 11 2018 at 20:29)</a>:</h4>
<p>Hence the two tests.</p>



<a name="151478295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478295">(Dec 11 2018 at 20:29)</a>:</h4>
<p>I can see why the ICE is occurring</p>



<a name="151478299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478299">(Dec 11 2018 at 20:29)</a>:</h4>
<p>I'm not sure why I thought this wouldn't happen</p>



<a name="151478304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478304">(Dec 11 2018 at 20:29)</a>:</h4>
<p>it seems obvious that it would</p>



<a name="151478435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478435">(Dec 11 2018 at 20:31)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="nc">A</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="p">,</span><span class="w"> </span><span class="n">B</span>: <span class="na">&#39;a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>: <span class="p">(</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;auto&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="o">&amp;</span><span class="s">&quot;this&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">((</span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>would cause the issue, but</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="nc">A</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="p">,</span><span class="w"> </span><span class="n">B</span>: <span class="na">&#39;a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a1</span><span class="p">,)</span>: <span class="p">(</span><span class="n">A</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="p">,)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="o">&amp;</span><span class="s">&quot;this&quot;</span><span class="p">),);</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">((</span><span class="n">a1</span><span class="p">,));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>wouldn't - comparing both logs I worked it out to be a certain map that didn't contain something - I'm slightly fuzzy on exactly what map.</p>



<a name="151478527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478527">(Dec 11 2018 at 20:33)</a>:</h4>
<p>I'm not convinced the other case is immune from this problem</p>



<a name="151478531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478531">(Dec 11 2018 at 20:33)</a>:</h4>
<p>it seems like we would maybe need to remember the type we inferred to solve it</p>



<a name="151478620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478620">(Dec 11 2018 at 20:34)</a>:</h4>
<p>The difference was <a href="https://github.com/rust-lang/rust/blob/8375ab4ff43474c73e3572c2b226560f8cc8e695/src/librustc/infer/canonical/canonicalizer.rs#L343" target="_blank" title="https://github.com/rust-lang/rust/blob/8375ab4ff43474c73e3572c2b226560f8cc8e695/src/librustc/infer/canonical/canonicalizer.rs#L343">this line</a>.</p>



<a name="151478638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478638">(Dec 11 2018 at 20:34)</a>:</h4>
<p>In the successful case it took the <code>Ok(..)</code> branch.</p>



<a name="151478645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478645">(Dec 11 2018 at 20:35)</a>:</h4>
<p>I wasn't able to track it down further.</p>



<a name="151478771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478771">(Dec 11 2018 at 20:37)</a>:</h4>
<p>I eventually tried applying the projections into the type annotation and saving those into the <code>TypeChecker</code> map that I had (requiring a whole bunch of refactoring so that we stored the <code>UserTypeProjection</code> in the MIR, not the <code>UserTypeAnnotation</code> - that meant that projections didn't need to be applied in the code that gets run for the <code>AscribeUserType</code> statement and it fixed the issue unless the code was unreachable.</p>



<a name="151478776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478776">(Dec 11 2018 at 20:37)</a>:</h4>
<p>I guess what I have to do is to checkout and build your branch</p>



<a name="151478781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478781">(Dec 11 2018 at 20:37)</a>:</h4>
<p>it's gotten large enough I can't really peruse it effectively on GH :)</p>



<a name="151478830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478830">(Dec 11 2018 at 20:38)</a>:</h4>
<p>I find it isn't too awful if you go commit-by-commit, but all at once it's hard for me to work out.</p>



<a name="151478857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151478857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151478857">(Dec 11 2018 at 20:38)</a>:</h4>
<p>I deliberately didn't include the fix to the ICE in the commit that introduced it like I normally would have, instead just adding it on so that it could be popped off and the ICE could be observed again.</p>



<a name="151522061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151522061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151522061">(Dec 12 2018 at 12:46)</a>:</h4>
<blockquote>
<p>I eventually tried applying the projections into the type annotation and saving those into the <code>TypeChecker</code> map that I had (requiring a whole bunch of refactoring so that we stored the <code>UserTypeProjection</code> in the MIR, not the <code>UserTypeAnnotation</code> - that meant that projections didn't need to be applied in the code that gets run for the <code>AscribeUserType</code> statement and it fixed the issue unless the code was unreachable.</p>
</blockquote>
<p>Remembered this morning that I saved <a href="https://gist.github.com/davidtwco/f9751ffd9c0508f7251c0f17adc3af53" target="_blank" title="https://gist.github.com/davidtwco/f9751ffd9c0508f7251c0f17adc3af53">the diff</a> of this change. Don't think there's anything useful in there, but it took a while so I kept it around just in case.</p>



<a name="151542379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542379">(Dec 12 2018 at 17:52)</a>:</h4>
<p>ok <span class="user-mention" data-user-id="116107">@davidtwco</span> so I spent some time reading into the ICE etc</p>



<a name="151542385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542385">(Dec 12 2018 at 17:52)</a>:</h4>
<p>and in general playing with the branch</p>



<a name="151542386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542386">(Dec 12 2018 at 17:52)</a>:</h4>
<p>I was particularly interested in this example:</p>



<a name="151542393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542393">(Dec 12 2018 at 17:52)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="nc">A</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="p">,</span><span class="w"> </span><span class="n">B</span>: <span class="na">&#39;a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="n">B</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span>: <span class="p">(</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">&quot;auto&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">A</span><span class="p">(</span><span class="o">&amp;</span><span class="s">&quot;this&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">((</span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="151542395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542395">(Dec 12 2018 at 17:52)</a>:</h4>
<p>which is <code>issue-54943-1.rs</code></p>



<a name="151542408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542408">(Dec 12 2018 at 17:52)</a>:</h4>
<p>I think the problem in <strong>this specific case</strong> is that we are creating too many <code>CanonicalUserTypeAnnotation</code> entries</p>



<a name="151542435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542435">(Dec 12 2018 at 17:53)</a>:</h4>
<p>in particular, we wind up with kind of two distinct copies of the <code>(String, A&lt;_&gt;)</code> annotation, one used when projecting out <code>String</code>, and one used when projecting out the <code>A&lt;_&gt;</code></p>



<a name="151542454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542454">(Dec 12 2018 at 17:53)</a>:</h4>
<p>the result is that -- when we instantiate -- we have distinct type variables for those two cases, and the <code>A&lt;_&gt;</code> type variable winds up unconstrained</p>



<a name="151542467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542467">(Dec 12 2018 at 17:53)</a>:</h4>
<p>I feel like there should be only be one index in this case, used with two distinct projections,</p>



<a name="151542520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542520">(Dec 12 2018 at 17:54)</a>:</h4>
<p>but it's not entirely obvious how to modify the source code to make that happen.</p>



<a name="151542529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542529">(Dec 12 2018 at 17:54)</a>:</h4>
<p><em>But also</em>, I'm a bit worried about a separate problem.</p>



<a name="151542580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542580">(Dec 12 2018 at 17:55)</a>:</h4>
<p>which has to do with <code>issue-54943-2.rs</code> -- in that case, I imagine that the type variable would simply never be constrained</p>



<a name="151542588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542588">(Dec 12 2018 at 17:55)</a>:</h4>
<p>(that is, the <code>_</code> in <code>A&lt;_&gt;</code>)</p>



<a name="151542604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542604">(Dec 12 2018 at 17:55)</a>:</h4>
<p>because those constraints arise from type-checking the <code>let</code>, and that code is dead... unless, perhaps we would still see it because we've not stripped dead code?</p>



<a name="151542612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542612">(Dec 12 2018 at 17:55)</a>:</h4>
<p>(I can't recall)</p>



<a name="151542726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151542726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151542726">(Dec 12 2018 at 17:57)</a>:</h4>
<p>(nope, we definitely strip dead code)</p>



<a name="151543255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151543255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151543255">(Dec 12 2018 at 18:04)</a>:</h4>
<p>anyway, so that seems like a bit of a difficult challenge that for some reason I had not anticipated. I'm not sure what I expected us to do here, maybe retain some information (which we could do) from typeck that tells us what type (modulo regions) we inferred those variables to?</p>



<a name="151543261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151543261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151543261">(Dec 12 2018 at 18:04)</a>:</h4>
<p>i'll stop here for now :)</p>



<a name="151551897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151551897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151551897">(Dec 12 2018 at 18:17)</a>:</h4>
<p>That explains what I observed happening when experimenting with those tests.</p>



<a name="151552154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151552154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151552154">(Dec 12 2018 at 18:21)</a>:</h4>
<p>In particular with the attempt I mentioned yesterday (and linked to a gist of earlier) where by applying the projections to the <code>(String, A&lt;_&gt;)</code> before checking well-formedness fixed the issue - but only when the source of the type annotation wasn’t dead code.</p>



<a name="151552449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151552449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151552449">(Dec 12 2018 at 18:25)</a>:</h4>
<p>I’m not sure how you’d work around the issue because, as I understand it, the <code>(String, A&lt;_&gt;)</code> annotation’s well-formedness check depends on the inference variable for the <code>_</code> having been related to the <code>&amp;str</code> type when the associated <code>AscribeUserType</code> or local decl processing happened previously? I haven’t been able to work out a way to do that when it is in dead code.</p>



<a name="151552560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151552560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151552560">(Dec 12 2018 at 18:26)</a>:</h4>
<p>(That’s the half-baked understanding I was left with having dug into the compiler as far as that canonicalizer code and the <code>ty_probe</code> function I linked yesterday)</p>



<a name="151560125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560125">(Dec 12 2018 at 20:13)</a>:</h4>
<p>Yes. I'm sort of leaning towards "won't fix" here, tbqh, but I'm torn about it still. I think the best fix would have to involve preserving -- for each user type -- not only the user-given type (as now) but also the "fully inferred" variant of it, so that we can unify those. Right now, that fully inferred (modulo regions) type comes from the type-check, but that doesn't apply to dead code, hence the problem.</p>



<a name="151560678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560678">(Dec 12 2018 at 20:21)</a>:</h4>
<blockquote>
<p>the result is that -- when we instantiate -- we have distinct type variables for those two cases, and the <code>A&lt;_&gt;</code> type variable winds up unconstrained</p>
</blockquote>
<p>Fixing this might be another path that could help with <a href="https://github.com/rust-lang/rust/issues/55748" target="_blank" title="https://github.com/rust-lang/rust/issues/55748">#55748</a></p>



<a name="151560691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560691">(Dec 12 2018 at 20:21)</a>:</h4>
<p>interesting</p>



<a name="151560753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560753">(Dec 12 2018 at 20:22)</a>:</h4>
<p>or at least, it roughly matches up with one of my theories when I was reviewing the RUST_LOG output</p>



<a name="151560761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560761">(Dec 12 2018 at 20:22)</a>:</h4>
<p>trying to make sense of what was happening</p>



<a name="151560776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560776">(Dec 12 2018 at 20:22)</a>:</h4>
<p>in that it seemed like we might be creating two separate sets of fresh type inference variables</p>



<a name="151560782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560782">(Dec 12 2018 at 20:22)</a>:</h4>
<p>for two separate projections out of the <em>same</em> type annotation</p>



<a name="151560790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560790">(Dec 12 2018 at 20:22)</a>:</h4>
<p>that makes sense</p>



<a name="151560798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560798">(Dec 12 2018 at 20:23)</a>:</h4>
<p>it does feel like there should be a "connection"</p>



<a name="151560812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560812">(Dec 12 2018 at 20:23)</a>:</h4>
<p>looking at the code, it felt like it wouldn't be <em>entirely</em> trivial to create that; mostly, we have to somehow carry the identify forward</p>



<a name="151560817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560817">(Dec 12 2018 at 20:23)</a>:</h4>
<p>but ohI think we should focus on the meeting now. :)</p>



<a name="151560824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560824">(Dec 12 2018 at 20:23)</a>:</h4>
<p>in a few minutes I guess</p>



<a name="151560827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560827">(Dec 12 2018 at 20:23)</a>:</h4>
<p>or at least in 7 minutes, yeah</p>



<a name="151560859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151560859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151560859">(Dec 12 2018 at 20:24)</a>:</h4>
<p>my phone alarm went off so I thought I was already late. :)</p>



<a name="151561741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151561741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151561741">(Dec 12 2018 at 20:37)</a>:</h4>
<p>btw I think this exact question is <a href="https://github.com/rust-lang/rust/blob/dd8fc7dc06dea00afbd365468cf4804f68a3531c/src/librustc_mir/build/matches/mod.rs#L315-L326" target="_blank" title="https://github.com/rust-lang/rust/blob/dd8fc7dc06dea00afbd365468cf4804f68a3531c/src/librustc_mir/build/matches/mod.rs#L315-L326">the reason I used <code>Invariant</code> here</a></p>



<a name="151736055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151736055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151736055">(Dec 13 2018 at 21:51)</a>:</h4>
<p>So how do we want to fix the issue here? We could consider it a follow up and land this PR with the well-formedness check of the <code>UserTypeAnnotation::Ty(..)</code> only happening in reachable code and the other case happening in both.</p>



<a name="151736872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151736872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151736872">(Dec 13 2018 at 22:05)</a>:</h4>
<p>A good question</p>



<a name="151736873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151736873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151736873">(Dec 13 2018 at 22:05)</a>:</h4>
<p>I'm not super sure</p>



<a name="151736885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151736885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151736885">(Dec 13 2018 at 22:05)</a>:</h4>
<p>obviously we need to land the PR, it's got a lot of great stuff in it</p>



<a name="151736898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151736898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151736898">(Dec 13 2018 at 22:05)</a>:</h4>
<p>we could move everything over to reachable code for now, to at least get consistency</p>



<a name="151736974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151736974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151736974">(Dec 13 2018 at 22:06)</a>:</h4>
<p>I don't know that it being consistent is better than it covering more cases. IIRC it still takes the same code path to check well-formedness, the call site for each case is just different.</p>



<a name="151736990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151736990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151736990">(Dec 13 2018 at 22:07)</a>:</h4>
<p>Previously we only checked the <code>UserTypeAnnotation::TypeOf</code> case and the whole issue in the first place was supporting unreachable code for that.</p>



<a name="151737787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/151737787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#151737787">(Dec 13 2018 at 22:20)</a>:</h4>
<p>I don't really see how the two cases are different per se, but perhaps you are right. It seems better to report more errors. I guess I just remain sort of ambivalent about whether we should report "lifetime errors" in dead code.</p>



<a name="152108146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152108146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152108146">(Dec 18 2018 at 13:37)</a>:</h4>
<p>I would like to land this PR (<a href="https://github.com/rust-lang/rust/issues/55937" target="_blank" title="https://github.com/rust-lang/rust/issues/55937">#55937</a>) as is. I agree it has lots of great stuff in it, and I would like to have it already landed before I land anything for <a href="https://github.com/rust-lang/rust/issues/55748" target="_blank" title="https://github.com/rust-lang/rust/issues/55748">#55748</a></p>



<a name="152108358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152108358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152108358">(Dec 18 2018 at 13:40)</a>:</h4>
<p>I think it's in a state where it could land with a follow-up to fix the underlying cause of the ICE that the last commit fixed.</p>



<a name="152108388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152108388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152108388">(Dec 18 2018 at 13:40)</a>:</h4>
<p>I agree with that assessment. The only reason why I haven't r+'ed already is that I'll be meeting with <span class="user-mention" data-user-id="116009">@nikomatsakis</span> in about 20 minutes anyway, so I figure I'll give them a chance to weigh in if he so chooses.</p>



<a name="152124669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152124669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152124669">(Dec 18 2018 at 17:38)</a>:</h4>
<p>I told <span class="user-mention" data-user-id="116083">@pnkfelix</span> that I'd like to take one more look. I'm doing so now.</p>



<a name="152124702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152124702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152124702">(Dec 18 2018 at 17:39)</a>:</h4>
<p>Just pushed a rebase for the conflict that happened.</p>



<a name="152125461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125461">(Dec 18 2018 at 17:54)</a>:</h4>
<p>ok, so, I think I figured out why I was not seeing the errors I expected, but I also don't think that this PR is quite fixing the bug it claims to fix</p>



<a name="152125463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125463">(Dec 18 2018 at 17:54)</a>:</h4>
<p>though it does fix some other bugs</p>



<a name="152125482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125482">(Dec 18 2018 at 17:55)</a>:</h4>
<p>in particular, the test <code>issue-54943.rs</code> does not include <code>#![feature(nll)]</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">foo</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">&#39;static</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span>::<span class="o">&lt;&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">//~^ ERROR the type `&amp;&#39;a u32` does not fulfill the required lifetime [E0477]</span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="152125489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125489">(Dec 18 2018 at 17:55)</a>:</h4>
<p>if you run with <code>-Zborrowck=mir</code>, the test compiles</p>



<a name="152125498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125498">(Dec 18 2018 at 17:55)</a>:</h4>
<p>well, almost:</p>
<div class="codehilite"><pre><span></span>warning: unreachable statement
  --&gt; issue-54943.rs:16:5
   |
16 |     let x = foo::&lt;&amp;&#39;a u32&gt;();
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^
   |
   = note: #[warn(unreachable_code)] on by default

error[E0131]: `main` function is not allowed to have generic parameters
  --&gt; issue-54943.rs:13:8
   |
13 | fn main&lt;&#39;a&gt;() {
   |        ^^^^ `main` cannot have generic parameters
</pre></div>



<a name="152125546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125546">(Dec 18 2018 at 17:56)</a>:</h4>
<p>(if I rename <code>main</code> to <code>bar</code>, that error goes away)</p>



<a name="152125551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125551">(Dec 18 2018 at 17:56)</a>:</h4>
<p>anyway I think I know why that is happening</p>



<a name="152125576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125576">(Dec 18 2018 at 17:57)</a>:</h4>
<p>the code is creating the <code>TyFnDef</code> for <code>foo::&lt;&amp;'a u32&gt;</code> and is proving the predicate <code>WF(foo::&lt;&amp;'a u32&gt;)</code>, but the code that computes the WF conditions for such a type is rather flawed</p>



<a name="152125583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125583">(Dec 18 2018 at 17:57)</a>:</h4>
<p>and in fact proving that predicate is a no-op</p>



<a name="152125589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125589">(Dec 18 2018 at 17:57)</a>:</h4>
<blockquote>
<p>if you run with <code>-Zborrowck=mir</code>, the test compiles</p>
</blockquote>
<p>(the error you are seeing comes from the older, lexical check)</p>



<a name="152125683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125683">(Dec 18 2018 at 17:58)</a>:</h4>
<p>this explains why e.g. this test (which I created as <code>issue-54943-3.rs</code>)  compiles with no error:</p>
<div class="codehilite"><pre><span></span>use std::fmt::Debug;

fn foo&lt;T: &#39;static + Debug&gt;(_: T) { }

fn bar&lt;&#39;a&gt;() {
    return;

    let _x = foo::&lt;Vec&lt;_&gt;&gt;(Vec::&lt;&amp;&#39;a u32&gt;::new());
    //~^ ERROR the type `&amp;&#39;a u32` does not fulfill the required lifetime [E0477]
}
</pre></div>


<p>...and also no ICE.</p>



<a name="152125843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125843">(Dec 18 2018 at 18:01)</a>:</h4>
<p>I expected that test to ICE because the <code>_</code> in <code>Vec&lt;_&gt;</code> would be unconstrained, and we would never be able to prove that <code>Vec&lt;_&gt;: Debug</code></p>



<a name="152125850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125850">(Dec 18 2018 at 18:01)</a>:</h4>
<p>(but it turns out we don't even try)</p>



<a name="152125912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125912">(Dec 18 2018 at 18:02)</a>:</h4>
<p>(I'm trying to decide what I think we ought to do, in any case)</p>



<a name="152125931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125931">(Dec 18 2018 at 18:02)</a>:</h4>
<p>I would definitely like to land this PR or most of it, it seems to be in a good direction</p>



<a name="152125935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152125935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152125935">(Dec 18 2018 at 18:02)</a>:</h4>
<p>If we don't try it might be the <code>UserTypeAnnotation::Ty(..)</code> case.</p>



<a name="152126072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126072">(Dec 18 2018 at 18:05)</a>:</h4>
<p>no</p>



<a name="152126106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126106">(Dec 18 2018 at 18:05)</a>:</h4>
<p>the problem is <a href="https://github.com/rust-lang/rust/blob/cb84844e83ee88684ef89cc02221a26abbf92530/src/librustc/ty/wf.rs#L362-L365" target="_blank" title="https://github.com/rust-lang/rust/blob/cb84844e83ee88684ef89cc02221a26abbf92530/src/librustc/ty/wf.rs#L362-L365">this code here</a>:</p>
<div class="codehilite"><pre><span></span><span class="w">                </span><span class="n">ty</span>::<span class="n">FnDef</span><span class="p">(..)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ty</span>::<span class="n">FnPtr</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="c1">// let the loop iterate into the argument/return</span>
<span class="w">                    </span><span class="c1">// types appearing in the fn signature</span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
</pre></div>



<a name="152126109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126109">(Dec 18 2018 at 18:05)</a>:</h4>
<p>that is supposed to be returning the conditions for the type to be WF</p>



<a name="152126162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126162">(Dec 18 2018 at 18:06)</a>:</h4>
<p>for <code>FnPtr</code>, it is correct, but for <code>FnDef</code>, I think it is wrong</p>



<a name="152126181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126181">(Dec 18 2018 at 18:06)</a>:</h4>
<p>it should probably be treated <a href="https://github.com/rust-lang/rust/blob/cb84844e83ee88684ef89cc02221a26abbf92530/src/librustc/ty/wf.rs#L296-L300" target="_blank" title="https://github.com/rust-lang/rust/blob/cb84844e83ee88684ef89cc02221a26abbf92530/src/librustc/ty/wf.rs#L296-L300">the same as <code>TyAdt</code></a></p>



<a name="152126198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126198">(Dec 18 2018 at 18:06)</a>:</h4>
<p>the result is that when we do this:</p>



<a name="152126217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126217">(Dec 18 2018 at 18:07)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">prove_predicate</span><span class="p">(</span><span class="n">Predicate</span>::<span class="n">WellFormed</span><span class="p">(</span><span class="n">ty</span><span class="p">));</span><span class="w"></span>
</pre></div>


<p>in <code>librustc_traits/type_op.rs</code> (in the PR branch)</p>



<a name="152126224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126224">(Dec 18 2018 at 18:07)</a>:</h4>
<p>it winds up being basically a no-op</p>



<a name="152126236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126236">(Dec 18 2018 at 18:07)</a>:</h4>
<p>hmm although</p>



<a name="152126290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126290">(Dec 18 2018 at 18:08)</a>:</h4>
<p>let me double check a few things ;)</p>



<a name="152126298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126298">(Dec 18 2018 at 18:08)</a>:</h4>
<p>I still think that code is wrong but there is something I don't quite yet understand</p>



<a name="152126837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126837">(Dec 18 2018 at 18:17)</a>:</h4>
<p>Oh, hm, interesting. The type-op code never actually checks whether the type-ops result in a "certainty: Proven" result, which I believe is the expected thing. So actually we <em>do</em> create the conditions I thought would lead to an ICE, but I guess we're not checking the result that I thought we were.</p>



<a name="152126871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126871">(Dec 18 2018 at 18:17)</a>:</h4>
<p>to clarify: in my example above that I expected to ICE, what happens is that we go to prove <code>WF(foo::&lt;Vec&lt;_&gt;&gt;</code> or whatever -- this requires us to prove <code>WF(Vec&lt;_&gt;)</code>, which we fail to do, and so we give back an ambiguous result</p>



<a name="152126927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126927">(Dec 18 2018 at 18:18)</a>:</h4>
<p>I .. think that should probably be an ICE, we're not supposed to have unresolved type variables like that in the region queries</p>



<a name="152126936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152126936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152126936">(Dec 18 2018 at 18:18)</a>:</h4>
<p>I'm not entirely sure why the other examples do result in ICEs now, I have to go back and re-check <em>that</em></p>



<a name="152127016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152127016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152127016">(Dec 18 2018 at 18:20)</a>:</h4>
<p>(I'm a bit afraid to add in the asseritons I think we should have...)</p>



<a name="152127269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152127269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152127269">(Dec 18 2018 at 18:23)</a>:</h4>
<p>Changing the <code>ty::FnDef</code> case that you mentioned previously makes <code>issue-54943.rs</code> fail.</p>



<a name="152127281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152127281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152127281">(Dec 18 2018 at 18:23)</a>:</h4>
<p>(that is, fail to compile, as expected, not fail to do what we want)</p>



<a name="152127370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152127370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152127370">(Dec 18 2018 at 18:24)</a>:</h4>
<p>It also makes the <code>issue-54943-3.rs</code> you mention above ICE.</p>



<a name="152127398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152127398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152127398">(Dec 18 2018 at 18:25)</a>:</h4>
<p><code>unresolved inference variable in outlives: _#0t</code> as before</p>



<a name="152128064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128064">(Dec 18 2018 at 18:33)</a>:</h4>
<p>ah ok yes that is what I expect</p>



<a name="152128068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128068">(Dec 18 2018 at 18:33)</a>:</h4>
<p>you altered <a href="http://wf.rs" target="_blank" title="http://wf.rs">wf.rs</a>?</p>



<a name="152128073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128073">(Dec 18 2018 at 18:33)</a>:</h4>
<p>does it affect any other tests?</p>



<a name="152128124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128124">(Dec 18 2018 at 18:34)</a>:</h4>
<p>None of the <code>issue-54943-*</code> tests, let me run the rest.</p>



<a name="152128136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128136">(Dec 18 2018 at 18:34)</a>:</h4>
<p>I meant the whole test suite , yeah</p>



<a name="152128279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128279">(Dec 18 2018 at 18:36)</a>:</h4>
<p>Two new errors on these tests w/out compare mode NLL:</p>
<div class="codehilite"><pre><span></span>    [ui] ui/nll/ty-outlives/projection-where-clause-env-wrong-bound.rs
    [ui] ui/nll/ty-outlives/projection-where-clause-none.rs
</pre></div>



<a name="152128304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128304">(Dec 18 2018 at 18:36)</a>:</h4>
<div class="codehilite"><pre><span></span>---- [ui] ui/nll/ty-outlives/projection-where-clause-none.rs stdout ----
diff of stderr:

+       error[E0309]: the associated type `&lt;T as MyTrait&lt;&#39;a&gt;&gt;::Output` may not live long enough
+         --&gt; $DIR/projection-where-clause-none.rs:16:5
+          |
+       LL |     bar::&lt;T::Output&gt;() //~ ERROR the parameter type `T` may not live long enough
+          |     ^^^^^^^^^^^^^^^^
+          |
+          = help: consider adding an explicit lifetime bound `&lt;T as MyTrait&lt;&#39;a&gt;&gt;::Output: &#39;a`...
+
1       error[E0309]: the parameter type `T` may not live long enough
2         --&gt; $DIR/projection-where-clause-none.rs:16:5
3          |

6          |
7          = help: consider adding an explicit lifetime bound `T: &#39;a`...
8
-       error: aborting due to previous error
+       error: aborting due to 2 previous errors
10
11      For more information about this error, try `rustc --explain E0309`.
12
</pre></div>



<a name="152128321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128321">(Dec 18 2018 at 18:36)</a>:</h4>
<p>Same w/ compare-mode NLL.</p>



<a name="152128436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128436">(Dec 18 2018 at 18:38)</a>:</h4>
<p>ok so we get some double errors</p>



<a name="152128446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128446">(Dec 18 2018 at 18:38)</a>:</h4>
<p>but not <em>new</em> errors</p>



<a name="152128456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128456">(Dec 18 2018 at 18:38)</a>:</h4>
<p>that's not surprising, I think we have some code that is basically doing repeating same checks twice now</p>



<a name="152128692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128692">(Dec 18 2018 at 18:42)</a>:</h4>
<p>Didn't affect any run-pass tests.</p>



<a name="152128781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128781">(Dec 18 2018 at 18:43)</a>:</h4>
<p>specifically I think that <a href="https://github.com/rust-lang/rust/blob/cb84844e83ee88684ef89cc02221a26abbf92530/src/librustc_traits/type_op.rs#L198-L209" target="_blank" title="https://github.com/rust-lang/rust/blob/cb84844e83ee88684ef89cc02221a26abbf92530/src/librustc_traits/type_op.rs#L198-L209">these checks</a> are kind of duplicated by the WF check now</p>



<a name="152128784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128784">(Dec 18 2018 at 18:43)</a>:</h4>
<p>but I'm not 100% sure</p>



<a name="152128865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152128865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152128865">(Dec 18 2018 at 18:44)</a>:</h4>
<p>Any thoughts on the ICEs?</p>



<a name="152131645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131645">(Dec 18 2018 at 19:26)</a>:</h4>
<p>sorry, I was on a call</p>



<a name="152131662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131662">(Dec 18 2018 at 19:26)</a>:</h4>
<p>well, my thoughts are that we should (for now) try to move towards checking only reachable constraints</p>



<a name="152131679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131679">(Dec 18 2018 at 19:26)</a>:</h4>
<p>but I think that the "right fix" is probably to have typeck produce a (region-erased) "instantiated version" of those annotations</p>



<a name="152131704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131704">(Dec 18 2018 at 19:27)</a>:</h4>
<p>i.e., the user-type-annotations which are -- right now -- canonicalized, would also have to have the "inferred" form</p>



<a name="152131707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131707">(Dec 18 2018 at 19:27)</a>:</h4>
<p>So should I remove the query for well formed type annotations and just move what it does back into the original query?</p>



<a name="152131712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131712">(Dec 18 2018 at 19:27)</a>:</h4>
<p>probably for now yes</p>



<a name="152131721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131721">(Dec 18 2018 at 19:27)</a>:</h4>
<p>(hmm)</p>



<a name="152131726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131726">(Dec 18 2018 at 19:27)</a>:</h4>
<p>I am trying to decide what the ultimate architeture would be</p>



<a name="152131786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131786">(Dec 18 2018 at 19:28)</a>:</h4>
<p>why exactly did we make a query in the first place?</p>



<a name="152131809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131809">(Dec 18 2018 at 19:28)</a>:</h4>
<p>I needed access to a certain kind of context and I felt it'd be easier to get that the same way the existing query did.</p>



<a name="152131828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131828">(Dec 18 2018 at 19:29)</a>:</h4>
<p>Well, I could just copy the existing well-formedness check for one of the cases but I needed the helper functions it had, so it had to be a query to get those.</p>



<a name="152131830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152131830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152131830">(Dec 18 2018 at 19:29)</a>:</h4>
<p>Made it a tad easier.</p>



<a name="152135204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152135204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152135204">(Dec 18 2018 at 20:23)</a>:</h4>
<p>I've now got a build that has the refactoring, other two fixes but doesn't actually perform well-formedness checks on unreachable code.</p>



<a name="152135209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152135209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152135209">(Dec 18 2018 at 20:23)</a>:</h4>
<p>Only boring old reachable code.</p>



<a name="152135245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152135245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152135245">(Dec 18 2018 at 20:24)</a>:</h4>
<p>If that's the route we want to take then I can push it and stop the PR from closing <a href="https://github.com/rust-lang/rust/issues/54943" target="_blank" title="https://github.com/rust-lang/rust/issues/54943">#54943</a>.</p>



<a name="152135438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152135438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152135438">(Dec 18 2018 at 20:27)</a>:</h4>
<p>seems like a solid step forward</p>



<a name="152135447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152135447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152135447">(Dec 18 2018 at 20:27)</a>:</h4>
<p>and we can then discuss the next step for unreachable code</p>



<a name="152135681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152135681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152135681">(Dec 18 2018 at 20:30)</a>:</h4>
<p>Alright, PR updated.</p>



<a name="152142184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152142184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152142184">(Dec 18 2018 at 22:04)</a>:</h4>
<p>Don’t worry if you don’t, but do you think you’ll have time to jot down some ideas for fixing the unreachable type annotations before the holidays <span class="user-mention" data-user-id="116009">@nikomatsakis</span>? I’d like to be able to get a start on that during mine.</p>



<a name="152142563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152142563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152142563">(Dec 18 2018 at 22:11)</a>:</h4>
<p>Responded to the review comments.</p>



<a name="152142672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152142672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152142672">(Dec 18 2018 at 22:12)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> will try to do so asap</p>



<a name="152142676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152142676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152142676">(Dec 18 2018 at 22:12)</a>:</h4>
<p>I expect I can do that before the holidays, yes</p>



<a name="152142679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152142679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152142679">(Dec 18 2018 at 22:12)</a>:</h4>
<p>Thanks, I appreciate it.</p>



<a name="152143278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152143278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152143278">(Dec 18 2018 at 22:23)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> re: the ignored tests, as a rule, I think ignored tests should never be committed</p>



<a name="152143284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152143284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152143284">(Dec 18 2018 at 22:23)</a>:</h4>
<p>basically because it's very easy to forget that they are ignored</p>



<a name="152143342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152143342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152143342">(Dec 18 2018 at 22:24)</a>:</h4>
<p>whereas if you edit the annotations to document the current behavior</p>



<a name="152143346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152143346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152143346">(Dec 18 2018 at 22:24)</a>:</h4>
<p>then when you fix it, you see that (as test failures :)</p>



<a name="152143855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152143855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152143855">(Dec 18 2018 at 22:33)</a>:</h4>
<p>That’s fair. In this case I think since we’ll be following up pretty quickly it’s probably fine? If you want I can quickly change them though.</p>



<a name="152143933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152143933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152143933">(Dec 18 2018 at 22:34)</a>:</h4>
<p>I'd prefer not to ignore them personally</p>



<a name="152143938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152143938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152143938">(Dec 18 2018 at 22:34)</a>:</h4>
<p>(but I agree not that big a deal)</p>



<a name="152143948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152143948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152143948">(Dec 18 2018 at 22:34)</a>:</h4>
<p>so if it's annoying for you to remove that maybe i'll just r+ :)</p>



<a name="152143990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152143990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152143990">(Dec 18 2018 at 22:36)</a>:</h4>
<p>Give me a second and I’ll change them.</p>



<a name="152144256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152144256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152144256">(Dec 18 2018 at 22:40)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Fixed them.</p>



<a name="152185541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185541">(Dec 19 2018 at 14:23)</a>:</h4>
<p>hey <span class="user-mention" data-user-id="116107">@davidtwco</span> are you still around to answer Q's about this PR (<a href="https://github.com/rust-lang/rust/issues/55937" target="_blank" title="https://github.com/rust-lang/rust/issues/55937">#55937</a>)?</p>



<a name="152185594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185594">(Dec 19 2018 at 14:24)</a>:</h4>
<p>Yeah, I'm around.</p>



<a name="152185602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185602">(Dec 19 2018 at 14:24)</a>:</h4>
<p>so I've been playing with a checkout of it locally</p>



<a name="152185629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185629">(Dec 19 2018 at 14:24)</a>:</h4>
<p>to see whether it helps me make a solution to <a href="https://github.com/rust-lang/rust/issues/55748" target="_blank" title="https://github.com/rust-lang/rust/issues/55748">#55748</a></p>



<a name="152185631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185631">(Dec 19 2018 at 14:24)</a>:</h4>
<p>and I noticed someting</p>



<a name="152185658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185658">(Dec 19 2018 at 14:25)</a>:</h4>
<p>the way you modified the <code>fn user_ty</code> on e.g. <code>PatternTypeProjections</code></p>



<a name="152185681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185681">(Dec 19 2018 at 14:25)</a>:</h4>
<p>takes a <code>annotations: &amp;mut CanonicalUserTypeAnnotations&lt;'tcx&gt;</code></p>



<a name="152185737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185737">(Dec 19 2018 at 14:26)</a>:</h4>
<p>and then the <code>user_ty</code> in <code>PatternTypeProjection</code> (singular) pushes annotations on to it</p>



<a name="152185762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185762">(Dec 19 2018 at 14:27)</a>:</h4>
<p>while the <code>user_ty</code> on <code>PatternTypeProjections</code> (plural) does a map over the <code>.contents</code> and calls <code>user_ty</code> on each</p>



<a name="152185788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185788">(Dec 19 2018 at 14:27)</a>:</h4>
<p>this ends up meaning that we get distinct entries in the <code>annotations</code> for each projection</p>



<a name="152185864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185864">(Dec 19 2018 at 14:28)</a>:</h4>
<p>but ... wouldn't it be more appropriate to have a single entry in the annotations, that we add at the outset, and then the projections into that annotation each reference the single entry that they share?</p>



<a name="152185890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185890">(Dec 19 2018 at 14:28)</a>:</h4>
<p>(this obviously is a more invasive change the code. but I think it is ... "more correct" ...?)</p>



<a name="152185904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185904">(Dec 19 2018 at 14:28)</a>:</h4>
<p>Yeah, it would. Not sure why I did it that way, there wasn't any particular rhyme or reason behind it, just what I ended up doing while fixing the bunch of errors that would have been around during that refactoring.</p>



<a name="152185929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185929">(Dec 19 2018 at 14:29)</a>:</h4>
<p>I suppose I can just try to make this change myself</p>



<a name="152185932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185932">(Dec 19 2018 at 14:29)</a>:</h4>
<p>In fact, I think that was a problem that <span class="user-mention" data-user-id="116009">@nikomatsakis</span> had pointed out in relation to the ICEs we were seeing.</p>



<a name="152185935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185935">(Dec 19 2018 at 14:29)</a>:</h4>
<p>on my check out of this branch</p>



<a name="152185940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185940">(Dec 19 2018 at 14:29)</a>:</h4>
<p>hmm okay yes</p>



<a name="152185942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152185942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152185942">(Dec 19 2018 at 14:29)</a>:</h4>
<p>I think it wouldn't be too bad to fix actually.</p>



<a name="152186006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186006">(Dec 19 2018 at 14:30)</a>:</h4>
<p><a href="#narrow/stream/122657-wg-nll/subject/.2354943.20user.20type.20annot.20in.20unreachable.20code/near/151542435" title="#narrow/stream/122657-wg-nll/subject/.2354943.20user.20type.20annot.20in.20unreachable.20code/near/151542435">this message</a></p>



<a name="152186007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186007">(Dec 19 2018 at 14:30)</a>:</h4>
<p>I think he and I briefly spoke on it yesterday (where I asserting that your PR did not suffer from this problem, because I was looking in the wrong place for the instance of the problem)</p>



<a name="152186106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186106">(Dec 19 2018 at 14:31)</a>:</h4>
<p>I think if we made that change, then asserted well-formedness for the <code>UserTypeAnnotation::Ty(..)</code> and <code>UserTypeAnnotation::TypeOf(..)</code> case then where that would normally break <code>issue-54943-1.rs</code> and <code>issue-54943-2.rs</code>, it would only break <code>issue-54943-2.rs</code>?</p>



<a name="152186152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186152">(Dec 19 2018 at 14:32)</a>:</h4>
<p>/me looks</p>



<a name="152186286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186286">(Dec 19 2018 at 14:34)</a>:</h4>
<p>it certainly seems like it would help in at least <a href="http://issue-54943-1.rs" target="_blank" title="http://issue-54943-1.rs">issue-54943-1.rs</a>, if done properly.</p>



<a name="152186334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186334">(Dec 19 2018 at 14:35)</a>:</h4>
<p>Since the issue there was that we had some annotation over <code>(String, &amp;'XXX str)</code> (or something like that, I forget exactly) and because there were two copies of the annotation, when the type relation happened because the code was reachable, you ended up with one copy that was <code>(String, &amp;'XXX str)</code> (when looking at the first field) and one that was <code>(String, &amp;'a str)</code> (when relating the second field) - and when doing well-formedness checking of that whole annotation later you ended up trying to work with <code>&amp;'XXX str</code> and failing. Since there would now be only one annotation, both fields would be related and you'd only have <code>(String, &amp;'a str)</code>.</p>



<a name="152186358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186358">(Dec 19 2018 at 14:35)</a>:</h4>
<p>But they don't get related at all when unreachable, which is what <code>issue-54943-2.rs</code> shows.</p>



<a name="152186363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186363">(Dec 19 2018 at 14:35)</a>:</h4>
<p>how are you thinking you'd go about doing this? Would you scan the <code>annotations</code> first to see if the given <code>CanonicalUserTypeAnnotation</code> was previously pushed onto it? Or are you thinking of a bigger re-architecting?</p>



<a name="152186472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186472">(Dec 19 2018 at 14:36)</a>:</h4>
<p>I had worked around this previously by having the projections indexed into an vec instead of the annotations, and then in the instantiate phase where I normally instantiate the canonicalized annotations now, I do that and apply the projections - that way when checking the well-formedness later, we were only doing so on that one field that would have been related - still failed on the unreachable case though.</p>



<a name="152186496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186496">(Dec 19 2018 at 14:37)</a>:</h4>
<p>I'm not too sure, I'd need to refresh myself on the code.</p>



<a name="152186499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186499">(Dec 19 2018 at 14:37)</a>:</h4>
<p>okay. just curious</p>



<a name="152186528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186528">(Dec 19 2018 at 14:37)</a>:</h4>
<blockquote>
<p>I had worked around this previously by having the projections indexed into an vec instead of the annotations, and then in the instantiate phase where I normally instantiate the canonicalized annotations now, I do that and apply the projections - that way when checking the well-formedness later, we were only doing so on that one field that would have been related - still failed on the unreachable case though.</p>
</blockquote>
<p><a href="https://gist.github.com/davidtwco/f9751ffd9c0508f7251c0f17adc3af53" target="_blank" title="https://gist.github.com/davidtwco/f9751ffd9c0508f7251c0f17adc3af53">diff for this experiment</a></p>



<a name="152186821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186821">(Dec 19 2018 at 14:42)</a>:</h4>
<blockquote>
<p>how are you thinking you'd go about doing this? Would you scan the <code>annotations</code> first to see if the given <code>CanonicalUserTypeAnnotation</code> was previously pushed onto it? Or are you thinking of a bigger re-architecting?</p>
</blockquote>
<p>Do you remember if a <code>PatternTypeProjections</code> only ever has the projections into a single annotation? Is it only ever <code>Field(0)</code>, <code>Field(1)</code> and <code>Field(2)</code> into the same <code>(X, Y, Z)</code> or can it be into <code>(X, Y)</code>, <code>(X, Z)</code> and <code>(Z, Y, X)</code> respectively?</p>



<a name="152186866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186866">(Dec 19 2018 at 14:43)</a>:</h4>
<p>I'm pretty sure that the intent is that the <code>base</code> will be able to differ, at least in the long term</p>



<a name="152186873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186873">(Dec 19 2018 at 14:43)</a>:</h4>
<p>because we want to be able to ascribe types on patterns themselves</p>



<a name="152186892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186892">(Dec 19 2018 at 14:43)</a>:</h4>
<p>which means we'll get into scenarios like</p>



<a name="152186948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186948">(Dec 19 2018 at 14:44)</a>:</h4>
<p><code>let (x: X, y): PairOfXandY;</code></p>



<a name="152186993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186993">(Dec 19 2018 at 14:45)</a>:</h4>
<p>I guess I'd probably just have worked out some sort of check to see whether an annotation already exists and if so just return the same id.</p>



<a name="152186996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152186996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152186996">(Dec 19 2018 at 14:45)</a>:</h4>
<p>and thus the accumulated state as we descend will (eventually) have distinct patterns that we are potentially projecting out of.</p>



<a name="152187024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152187024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152187024">(Dec 19 2018 at 14:45)</a>:</h4>
<blockquote>
<p>I guess I'd probably just have worked out some sort of check to see whether an annotation already exists and if so just return the same id.</p>
</blockquote>
<p>Yeah I'm going to try that now on my local checkout</p>



<a name="152187039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152187039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152187039">(Dec 19 2018 at 14:45)</a>:</h4>
<p>I'm not going to bother with a hashtable or anything. I don't expect this vector to grow much.</p>



<a name="152187046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152187046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152187046">(Dec 19 2018 at 14:45)</a>:</h4>
<p>(which may be a terrible assumption longer term, but for now... )</p>



<a name="152187133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152187133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152187133">(Dec 19 2018 at 14:47)</a>:</h4>
<p>Alternatively, I don't mind having some duplication of annotations as we propagate them through to NLL and then applying the projection before it is used at all in NLL type check.</p>



<a name="152187149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152187149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152187149">(Dec 19 2018 at 14:47)</a>:</h4>
<p>Or just as early as we can.</p>



<a name="152187302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152187302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152187302">(Dec 19 2018 at 14:48)</a>:</h4>
<p>well the reason why I want to try avoiding duplicating the annotations is that, in cases like the "potentially wrong-headed demo" from <a href="https://github.com/rust-lang/rust/issues/55748" target="_blank" title="https://github.com/rust-lang/rust/issues/55748">#55748</a>, I think I need to ensure that we only have one annotation in hand when it gets its variables instantiated.</p>



<a name="152187347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152187347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152187347">(Dec 19 2018 at 14:49)</a>:</h4>
<p>Right now, because there are duplicate annotations for each projection, when I look at the types for <code>y</code> and <code>_z</code> in <code>let (mut y, mut _z): Pair&lt;&amp;u32&gt; = (s, x);</code>, I do not think I have much hope of ensuring that their respective types actually use the same regions.</p>



<a name="152187404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152187404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152187404">(Dec 19 2018 at 14:50)</a>:</h4>
<p>Ah, I see.</p>



<a name="152191270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152191270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152191270">(Dec 19 2018 at 15:40)</a>:</h4>
<p>yay: my modifications to your PR fix <a href="https://github.com/rust-lang/rust/issues/55748" target="_blank" title="https://github.com/rust-lang/rust/issues/55748">#55748</a></p>



<a name="152191292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152191292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152191292">(Dec 19 2018 at 15:41)</a>:</h4>
<p>The deduplication of annotations?</p>



<a name="152191301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152191301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152191301">(Dec 19 2018 at 15:41)</a>:</h4>
<p>Is it on a branch? I'd be interested in taking a look.</p>



<a name="152191309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152191309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152191309">(Dec 19 2018 at 15:41)</a>:</h4>
<p>Its not uploaded yet, but I'll push in a moment.</p>



<a name="152191378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152191378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152191378">(Dec 19 2018 at 15:42)</a>:</h4>
<p>If you want you could push straight onto my branch so we don't need to wait two bors cycles for it to land.</p>



<a name="152192022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192022">(Dec 19 2018 at 15:52)</a>:</h4>
<p>Well I think the best thing may be for you to look at the two commits in question and cherry-pick them over if you like them.</p>



<a name="152192038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192038">(Dec 19 2018 at 15:53)</a>:</h4>
<p>I don't want the other change I made to get mixed in with yours unless you want it to be there.</p>



<a name="152192043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192043">(Dec 19 2018 at 15:53)</a>:</h4>
<p>Alright, sounds good.</p>



<a name="152192127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192127">(Dec 19 2018 at 15:54)</a>:</h4>
<p>this is branch: <a href="https://github.com/pnkfelix/rust/commits/issue-54943-with-fix-for-55748" target="_blank" title="https://github.com/pnkfelix/rust/commits/issue-54943-with-fix-for-55748">https://github.com/pnkfelix/rust/commits/issue-54943-with-fix-for-55748</a></p>



<a name="152192155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192155">(Dec 19 2018 at 15:54)</a>:</h4>
<p>I <em>think</em> it will build and still fix my problem. (Its a quick result of me removing a bunch of code that was just noise now that I found these smaller deltas...)</p>



<a name="152192215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192215">(Dec 19 2018 at 15:55)</a>:</h4>
<p>Is it just the first two commits?</p>



<a name="152192228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192228">(Dec 19 2018 at 15:55)</a>:</h4>
<p>the two commits I'm suggesting you consider cherry picking are <a href="https://github.com/pnkfelix/rust/commit/194e25d8783504a0b2fc3dd4622545b5baccafac" target="_blank" title="https://github.com/pnkfelix/rust/commit/194e25d8783504a0b2fc3dd4622545b5baccafac">194e25d</a> and <a href="https://github.com/pnkfelix/rust/commit/eaf062131abe70468e08ad0d343d3ba311ab9530" target="_blank" title="https://github.com/pnkfelix/rust/commit/eaf062131abe70468e08ad0d343d3ba311ab9530">eaf0621</a></p>



<a name="152192232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192232">(Dec 19 2018 at 15:55)</a>:</h4>
<p>yeah, just the first two</p>



<a name="152192296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192296">(Dec 19 2018 at 15:56)</a>:</h4>
<p>Yeah, I'll grab those, they look like they'd just be a straight improvement on what is currently there.</p>



<a name="152192331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192331">(Dec 19 2018 at 15:56)</a>:</h4>
<p>okay great. and now I've just confirmed that that branch does indeed fix my demo.</p>



<a name="152192461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192461">(Dec 19 2018 at 15:59)</a>:</h4>
<p>Doing a quick UI test run with it locally and then I'll push them to my PR.</p>



<a name="152192726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192726">(Dec 19 2018 at 16:02)</a>:</h4>
<p>note that it <em>might</em> <code>ui/nll/user-annotations/pattern.rs</code>, since one test in there is broken by my branch.</p>



<a name="152192732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192732">(Dec 19 2018 at 16:02)</a>:</h4>
<p>but honestly I think that is due to my third commit that you are not cherry-picking.</p>



<a name="152192742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152192742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152192742">(Dec 19 2018 at 16:02)</a>:</h4>
<p>I guess I'll be able to confirm that in a moment.</p>



<a name="152193232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152193232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152193232">(Dec 19 2018 at 16:09)</a>:</h4>
<p>Had a failure in <code>ui/dropck/dropck_trait_cycle_checked.rs</code> but it was just the attribution of a error changing from a "cast" to a "type annotation" so it seems OK.</p>



<a name="152193365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152193365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152193365">(Dec 19 2018 at 16:10)</a>:</h4>
<p>interesting that I didn't see that on my end...</p>



<a name="152193376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152193376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152193376">(Dec 19 2018 at 16:10)</a>:</h4>
<p>was it from compare-mode=nll or something?</p>



<a name="152193380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152193380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152193380">(Dec 19 2018 at 16:10)</a>:</h4>
<p>It was.</p>



<a name="152193386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152193386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152193386">(Dec 19 2018 at 16:10)</a>:</h4>
<p>ok i see</p>



<a name="152193582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152193582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152193582">(Dec 19 2018 at 16:13)</a>:</h4>
<p>Anyway, updated the PR with those.</p>



<a name="152210014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152210014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152210014">(Dec 19 2018 at 20:20)</a>:</h4>
<p>I noted a concern here: <a href="https://github.com/rust-lang/rust/pull/55937#pullrequestreview-186731482" target="_blank" title="https://github.com/rust-lang/rust/pull/55937#pullrequestreview-186731482">link</a></p>



<a name="152210675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152210675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152210675">(Dec 19 2018 at 20:30)</a>:</h4>
<p>I tried <a href="https://gist.github.com/davidtwco/515efb2d947211e240955a437d712251" target="_blank" title="https://gist.github.com/davidtwco/515efb2d947211e240955a437d712251">this test case</a> which is similar to what you mentioned in the issue, and it has <a href="https://gist.github.com/davidtwco/3724fd9ad0f5363982dfc293797fa145" target="_blank" title="https://gist.github.com/davidtwco/3724fd9ad0f5363982dfc293797fa145">this MIR</a>.</p>



<a name="152210679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152210679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152210679">(Dec 19 2018 at 20:30)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="152210766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152210766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152210766">(Dec 19 2018 at 20:31)</a>:</h4>
<p>I guess this is because the span is included</p>



<a name="152210796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152210796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152210796">(Dec 19 2018 at 20:32)</a>:</h4>
<p>doesn't feel "right" to me</p>



<a name="152210812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152210812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152210812">(Dec 19 2018 at 20:32)</a>:</h4>
<p>but it may prevent there from being an actual bug</p>



<a name="152210838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152210838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152210838">(Dec 19 2018 at 20:32)</a>:</h4>
<p>I am wondering if some kind of trickery involving macros can distinct annotations with the same span</p>



<a name="152211039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152211039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152211039">(Dec 19 2018 at 20:35)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <a href="https://gist.github.com/davidtwco/2347f13126e9471703acb25829242168" target="_blank" title="https://gist.github.com/davidtwco/2347f13126e9471703acb25829242168">test</a> and <a href="https://gist.github.com/davidtwco/ceb500acaac1c278ec89115b8898d262" target="_blank" title="https://gist.github.com/davidtwco/ceb500acaac1c278ec89115b8898d262">mir</a>?</p>



<a name="152211122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152211122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152211122">(Dec 19 2018 at 20:36)</a>:</h4>
<p>that's roughly what I had in mind, yes :)</p>



<a name="152212185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152212185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152212185">(Dec 19 2018 at 20:52)</a>:</h4>
<p>okay so then that approach isn't quite right I guess...</p>



<a name="152212229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152212229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152212229">(Dec 19 2018 at 20:53)</a>:</h4>
<p>I guess if we included a <code>HirId</code> or something it could work</p>



<a name="152212257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152212257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152212257">(Dec 19 2018 at 20:53)</a>:</h4>
<p>yeah I was just musing that tying it back to either the HIR or the HAIR would be necessary to deal with these scenarios</p>



<a name="152212336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152212336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152212336">(Dec 19 2018 at 20:54)</a>:</h4>
<p>right, I had thought first about refactoring things more broadly, but perhaps adding a <code>HirId</code> would be a "good enough" hack</p>



<a name="152212672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152212672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152212672">(Dec 19 2018 at 20:58)</a>:</h4>
<p>I should try to make a variant of <span class="user-mention" data-user-id="116107">@davidtwco</span> 's test that shows the bug without having to look at MIR</p>



<a name="152212690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152212690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152212690">(Dec 19 2018 at 20:58)</a>:</h4>
<p>I tried for a little bit to do that but struggled.</p>



<a name="152212741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152212741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152212741">(Dec 19 2018 at 20:59)</a>:</h4>
<p>I can probably do it. Not tonight though. Have to wait until I get a bit more sleep</p>



<a name="152247669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152247669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152247669">(Dec 20 2018 at 10:43)</a>:</h4>
<p>Okay I have a test but its coupled to my own work for <a href="https://github.com/rust-lang/rust/issues/55748" target="_blank" title="https://github.com/rust-lang/rust/issues/55748">#55748</a></p>



<a name="152247720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152247720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152247720">(Dec 20 2018 at 10:44)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> you may want to just take my commits out of your PR</p>



<a name="152247728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152247728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152247728">(Dec 20 2018 at 10:44)</a>:</h4>
<p>and I'll do them in a manner that doesn't get fooled by macros separately.</p>



<a name="152247827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152247827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152247827">(Dec 20 2018 at 10:46)</a>:</h4>
<p>(If you want to see it, <a href="https://gist.github.com/6802e05d447dc5415774a214ff6ea5ae" target="_blank" title="https://gist.github.com/6802e05d447dc5415774a214ff6ea5ae">this is the test</a>.]</p>



<a name="152252966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152252966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152252966">(Dec 20 2018 at 12:25)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> Is it only deduplication within a <code>PatternTypeProjections</code> or is it over all annotations that you need?</p>



<a name="152252975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152252975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152252975">(Dec 20 2018 at 12:25)</a>:</h4>
<p>i think its only over <code>PatternTypeProjections</code></p>



<a name="152253027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253027">(Dec 20 2018 at 12:26)</a>:</h4>
<p>or rather, I think that the only place where a single source type can cause multiple entries to be added ...?</p>



<a name="152253040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253040">(Dec 20 2018 at 12:26)</a>:</h4>
<p>by "source type" I mean ... I guess a node representing a type in the macro-expanded AST</p>



<a name="152253163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253163">(Dec 20 2018 at 12:29)</a>:</h4>
<p>I've got something that doesn't deduplicate as much - it'll deduplicate within <code>PatternTypeProjections</code> so if you end up having a <code>Field(field[0])</code> and a <code>Field(field[1])</code> out of the same annotation then it won't be duplicated and won't be affected by macros or rely on spans. But it doesn't deduplicate globally like your fix did where the same annotation isn't used for a <code>StatementKind::AscribeUserType</code> statement even if it is the same underlying <code>Ty</code>.</p>



<a name="152253166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253166">(Dec 20 2018 at 12:29)</a>:</h4>
<p>I'm not sure if that is useful.</p>



<a name="152253170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253170">(Dec 20 2018 at 12:29)</a>:</h4>
<p>it may be enough for my purposes</p>



<a name="152253172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253172">(Dec 20 2018 at 12:29)</a>:</h4>
<p>my fix de-duplicating globally was a bug</p>



<a name="152253255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253255">(Dec 20 2018 at 12:31)</a>:</h4>
<p>For example, with my test case from yesterday, I <a href="https://gist.github.com/davidtwco/b1871efb357a7c6a23901f2bd35fd582" target="_blank" title="https://gist.github.com/davidtwco/b1871efb357a7c6a23901f2bd35fd582">get this</a>.</p>



<a name="152253264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253264">(Dec 20 2018 at 12:31)</a>:</h4>
<p>For the code from your issue, <a href="https://gist.github.com/davidtwco/3d5b8bbe84c640ae5f1210280ad08ba9" target="_blank" title="https://gist.github.com/davidtwco/3d5b8bbe84c640ae5f1210280ad08ba9">I get this</a>.</p>



<a name="152253266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253266">(Dec 20 2018 at 12:31)</a>:</h4>
<p>I'm not sure if it is right or not.</p>



<a name="152253268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253268">(Dec 20 2018 at 12:32)</a>:</h4>
<p>I suspect it isn't, because there are a lot of annotations.</p>



<a name="152253310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253310">(Dec 20 2018 at 12:32)</a>:</h4>
<p>And they're still different.</p>



<a name="152253320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253320">(Dec 20 2018 at 12:33)</a>:</h4>
<p>/me reads</p>



<a name="152253336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253336">(Dec 20 2018 at 12:34)</a>:</h4>
<p>In <code>visit_bindings</code> instead of adding the <code>CanonicalUserTypeAnnotation</code> to <code>PatternTypeProjections</code> and then cloning that each time you add a projection, I'm storing it to get an index at the start and cloning the index after adding a projection.</p>



<a name="152253373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253373">(Dec 20 2018 at 12:34)</a>:</h4>
<p>its a good sign that lines 78 and 79 on your code (for my issue) are referencing the same UserTypeAnnotation</p>



<a name="152253376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253376">(Dec 20 2018 at 12:34)</a>:</h4>
<p>Which I thought would work.</p>



<a name="152253392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253392">(Dec 20 2018 at 12:34)</a>:</h4>
<p>yes that sounds plausible.</p>



<a name="152253396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253396">(Dec 20 2018 at 12:34)</a>:</h4>
<p>You maybe want to just show me the diff?</p>



<a name="152253408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253408">(Dec 20 2018 at 12:35)</a>:</h4>
<p>(and I'll apply it on my branch and give it  a whirl)</p>



<a name="152253423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253423">(Dec 20 2018 at 12:35)</a>:</h4>
<p><a href="https://gist.github.com/davidtwco/a00b8af51ca45558085baf838cfdc79f" target="_blank" title="https://gist.github.com/davidtwco/a00b8af51ca45558085baf838cfdc79f">https://gist.github.com/davidtwco/a00b8af51ca45558085baf838cfdc79f</a></p>



<a name="152253466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253466">(Dec 20 2018 at 12:36)</a>:</h4>
<p>I also haven't run all the tests on it, just those two files - so it might be completely broken in ways I've not checked yet.</p>



<a name="152253473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152253473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152253473">(Dec 20 2018 at 12:36)</a>:</h4>
<p>(going to grab lunch now, so might be delayed in responding for ~20mins)</p>



<a name="152254973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152254973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152254973">(Dec 20 2018 at 13:09)</a>:</h4>
<p>that diff does well against the test I posted earlier.</p>



<a name="152255035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255035">(Dec 20 2018 at 13:10)</a>:</h4>
<p>It passes the test suite (except for the same dropck test that your initial change affected, it will undo that).</p>



<a name="152255048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255048">(Dec 20 2018 at 13:10)</a>:</h4>
<p>it even fixes a case that I didn't expect it to</p>



<a name="152255054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255054">(Dec 20 2018 at 13:10)</a>:</h4>
<p>(and the same mir-opt test, same thing)</p>



<a name="152255077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255077">(Dec 20 2018 at 13:11)</a>:</h4>
<p>If it seems to do what we want then I'll add it to the PR?</p>



<a name="152255078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255078">(Dec 20 2018 at 13:11)</a>:</h4>
<p>namely I expanded my previous test with this new <a href="https://gist.github.com/8dbe7ab864cbc6ac65164af06abe66be" target="_blank" title="https://gist.github.com/8dbe7ab864cbc6ac65164af06abe66be">gist</a></p>



<a name="152255092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255092">(Dec 20 2018 at 13:11)</a>:</h4>
<p>I saw that earlier but didn't know what other stuff it depended on from your PR.</p>



<a name="152255093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255093">(Dec 20 2018 at 13:11)</a>:</h4>
<p>and <a href="https://gist.github.com/pnkfelix/8dbe7ab864cbc6ac65164af06abe66be#file-wildcard-tyvars-rs-L79" target="_blank" title="https://gist.github.com/pnkfelix/8dbe7ab864cbc6ac65164af06abe66be#file-wildcard-tyvars-rs-L79">this case on line 79</a> is now accepted under your diff</p>



<a name="152255096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255096">(Dec 20 2018 at 13:12)</a>:</h4>
<p>which is totally cool with me</p>



<a name="152255141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255141">(Dec 20 2018 at 13:12)</a>:</h4>
<p>(I don't understand why my previous version was rejecting it)</p>



<a name="152255158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255158">(Dec 20 2018 at 13:12)</a>:</h4>
<p>yeah no that test is not going to be useful without the other commit in my branch</p>



<a name="152255164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255164">(Dec 20 2018 at 13:13)</a>:</h4>
<p>which, as I said before, I think we should keep as a separate PR</p>



<a name="152255179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255179">(Dec 20 2018 at 13:13)</a>:</h4>
<p>Would you prefer I just add it on top of the existing commits or replace the last three with the first attempt at deduplication?</p>



<a name="152255189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255189">(Dec 20 2018 at 13:13)</a>:</h4>
<p>I think you should replace</p>



<a name="152255208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255208">(Dec 20 2018 at 13:13)</a>:</h4>
<p>as in, don't keep the bogus deduplication. its going just introduce noise in the history.</p>



<a name="152255257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255257">(Dec 20 2018 at 13:14)</a>:</h4>
<p>Sure, will do that now.</p>



<a name="152255274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255274">(Dec 20 2018 at 13:14)</a>:</h4>
<p>I am a <em>little</em> curious whether we can (should?) use linked structures rather than cloning as we descend</p>



<a name="152255293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255293">(Dec 20 2018 at 13:15)</a>:</h4>
<p>but its not something I really want anyone to spend much mental energy on</p>



<a name="152255297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255297">(Dec 20 2018 at 13:15)</a>:</h4>
<p>Yeah, I didn't like how much cloning it involved - don't think it was any more than there was before though.</p>



<a name="152255314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255314">(Dec 20 2018 at 13:15)</a>:</h4>
<p>oh actually you are right</p>



<a name="152255319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255319">(Dec 20 2018 at 13:16)</a>:</h4>
<p>I just hid the cloning in the methods, didn't i</p>



<a name="152255360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255360">(Dec 20 2018 at 13:16)</a>:</h4>
<p>Yeah.</p>



<a name="152255380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255380">(Dec 20 2018 at 13:16)</a>:</h4>
<p>okay then don't worry about it</p>



<a name="152255387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255387">(Dec 20 2018 at 13:16)</a>:</h4>
<p>unless you feel like re-hiding it</p>



<a name="152255391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255391">(Dec 20 2018 at 13:16)</a>:</h4>
<p>I think I prefer it not hidden.</p>



<a name="152255395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255395">(Dec 20 2018 at 13:16)</a>:</h4>
<p>fine with me</p>



<a name="152255809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255809">(Dec 20 2018 at 13:24)</a>:</h4>
<p>PR updated.</p>



<a name="152255961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255961">(Dec 20 2018 at 13:27)</a>:</h4>
<p>first up, <a href="https://github.com/rust-lang/rust/issues?utf8=%E2%9C%93&amp;q=is%3Aopen+is%3Aissue+label%3AT-compiler+label%3AP-high+" target="_blank" title="https://github.com/rust-lang/rust/issues?utf8=%E2%9C%93&amp;q=is%3Aopen+is%3Aissue+label%3AT-compiler+label%3AP-high+">P-high issues</a></p>



<a name="152255967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255967">(Dec 20 2018 at 13:27)</a>:</h4>
<p>Wrong topic.</p>



<a name="152255968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255968">(Dec 20 2018 at 13:27)</a>:</h4>
<p>And stream.</p>



<a name="152255970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255970">(Dec 20 2018 at 13:27)</a>:</h4>
<p>d'oh</p>



<a name="152255977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255977">(Dec 20 2018 at 13:27)</a>:</h4>
<p>Don't think you can edit that to the right stream.</p>



<a name="152255985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152255985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152255985">(Dec 20 2018 at 13:27)</a>:</h4>
<p>could just delete all of this. <span class="emoji emoji-263a" title="smile">:smile:</span></p>



<a name="152266087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152266087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152266087">(Dec 20 2018 at 16:05)</a>:</h4>
<p>what is current status of <span class="user-mention" data-user-id="116107">@davidtwco</span>'s branch here? (cc <span class="user-mention" data-user-id="116083">@pnkfelix</span>)</p>



<a name="152266243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152266243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152266243">(Dec 20 2018 at 16:07)</a>:</h4>
<p>From my most recent <a href="https://github.com/rust-lang/rust/pull/55937#issuecomment-449020922" target="_blank" title="https://github.com/rust-lang/rust/pull/55937#issuecomment-449020922">comment</a> on the PR: </p>
<blockquote>
<p>(this looks good to me. I'm planning to r+ but I'll wait a few hours to see if @nikomatsakis wants to weigh in on the latest commit.)</p>
</blockquote>



<a name="152266328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152266328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152266328">(Dec 20 2018 at 16:08)</a>:</h4>
<p>basically <span class="user-mention" data-user-id="116107">@davidtwco</span>  came up with a more targetted way to avoid duplicate entries just when descending into the projections of a pattern</p>



<a name="152266352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152266352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152266352">(Dec 20 2018 at 16:08)</a>:</h4>
<p>and it is enough to resolve the problem I was facing</p>



<a name="152268175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152268175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152268175">(Dec 20 2018 at 16:31)</a>:</h4>
<p><span class="emoji emoji-1f44d" title="thumbs up">:thumbs_up:</span></p>



<a name="152323767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/152323767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#152323767">(Dec 21 2018 at 11:17)</a>:</h4>
<p>I'm happy to start building on this PR to handle the unreachable case once I've got a clearer idea how we want to handle it.</p>



<a name="154185186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154185186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154185186">(Jan 02 2019 at 16:37)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> do you have any thoughts on the toolstate breakages as a result of <a href="https://github.com/rust-lang/rust/issues/55937" target="_blank" title="https://github.com/rust-lang/rust/issues/55937">#55937</a>? I’ve been taking a look and think there might have been a bug with my fix for <a href="https://github.com/rust-lang/rust/issues/55511" target="_blank" title="https://github.com/rust-lang/rust/issues/55511">#55511</a> because as far as I understand, I think the code mentioned in the PR comments should work?</p>



<a name="154185268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154185268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154185268">(Jan 02 2019 at 16:38)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> I haven't seen that yet, link?</p>



<a name="154185296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154185296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154185296">(Jan 02 2019 at 16:39)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <a href="https://github.com/rust-lang/rust/pull/55937#issuecomment-450899521" target="_blank" title="https://github.com/rust-lang/rust/pull/55937#issuecomment-450899521">https://github.com/rust-lang/rust/pull/55937#issuecomment-450899521</a></p>



<a name="154185563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154185563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154185563">(Jan 02 2019 at 16:43)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/commit/4be7214d30b121762c8675c3e732083da262b136" target="_blank" title="https://github.com/rust-lang/rust/commit/4be7214d30b121762c8675c3e732083da262b136">https://github.com/rust-lang/rust/commit/4be7214d30b121762c8675c3e732083da262b136</a> is the commit that would have affected that.</p>



<a name="154193256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154193256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154193256">(Jan 02 2019 at 18:56)</a>:</h4>
<p>Hmm, <span class="user-mention" data-user-id="116107">@davidtwco</span> that does sound strange</p>



<a name="154193278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154193278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154193278">(Jan 02 2019 at 18:57)</a>:</h4>
<p>I wonder if we can get a minimized reproduction. I also wonder if <span class="user-mention" data-user-id="153740">@Igor Matuszewski</span>  monitors zulip =)</p>



<a name="154193531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154193531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154193531">(Jan 02 2019 at 19:00)</a>:</h4>
<p>well <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=c864079c6a555e7960818b2fa82690cb" target="_blank" title="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=c864079c6a555e7960818b2fa82690cb">maybe this playground link suffices</a>:</p>
<div class="codehilite"><pre><span></span><span class="cp">#![feature(nll)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Blah</span>: <span class="kp">&amp;</span><span class="nb">&#39;static</span><span class="w"> </span><span class="kt">str</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Placeholder</span><span class="p">;</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Placeholder</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">Blah</span>: <span class="kp">&amp;</span><span class="nb">&#39;static</span><span class="w"> </span><span class="kt">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;hi&quot;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">Placeholder</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Foo</span><span class="o">&gt;</span>::<span class="n">Blah</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="154193589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154193589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154193589">(Jan 02 2019 at 19:01)</a>:</h4>
<p>That looks like the same issue.</p>



<a name="154193606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154193606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154193606">(Jan 02 2019 at 19:01)</a>:</h4>
<p>it certainly <em>seems</em> like a bug</p>



<a name="154193610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154193610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154193610">(Jan 02 2019 at 19:01)</a>:</h4>
<p>that same example does compile for me</p>



<a name="154193653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154193653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154193653">(Jan 02 2019 at 19:02)</a>:</h4>
<p>(with an older nightly)</p>



<a name="154193872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154193872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154193872">(Jan 02 2019 at 19:05)</a>:</h4>
<p>looking at the generated Mir, we do indeed have an <code>AscribeUserTypeAnnotation</code> on the value being matched</p>



<a name="154193881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154193881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154193881">(Jan 02 2019 at 19:05)</a>:</h4>
<p>that doesn't seem right though</p>



<a name="154193944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154193944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154193944">(Jan 02 2019 at 19:06)</a>:</h4>
<p>perhaps because <a href="https://github.com/rust-lang/rust/commit/4be7214d30b121762c8675c3e732083da262b136" target="_blank" title="https://github.com/rust-lang/rust/commit/4be7214d30b121762c8675c3e732083da262b136">https://github.com/rust-lang/rust/commit/4be7214d30b121762c8675c3e732083da262b136</a> is incorrect</p>



<a name="154193964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154193964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154193964">(Jan 02 2019 at 19:06)</a>:</h4>
<p>in general the handling of user type annotations and patterns is more complex than we first imagined I think</p>



<a name="154195455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154195455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154195455">(Jan 02 2019 at 19:31)</a>:</h4>
<p>I guess we should file an issue on this</p>



<a name="154195456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154195456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154195456">(Jan 02 2019 at 19:31)</a>:</h4>
<p>I can look a bit more</p>



<a name="154195461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154195461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154195461">(Jan 02 2019 at 19:31)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> there is no issue filed yet, right?</p>



<a name="154195469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154195469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154195469">(Jan 02 2019 at 19:31)</a>:</h4>
<p>Not that I know of.</p>



<a name="154195957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154195957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154195957">(Jan 02 2019 at 19:39)</a>:</h4>
<p>I'll file one and do a bit of investigation perhaps</p>



<a name="154196085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154196085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154196085">(Jan 02 2019 at 19:41)</a>:</h4>
<p>Filed <a href="https://github.com/rust-lang/rust/issues/57280" target="_blank" title="https://github.com/rust-lang/rust/issues/57280">https://github.com/rust-lang/rust/issues/57280</a></p>



<a name="154202627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154202627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154202627">(Jan 02 2019 at 21:29)</a>:</h4>
<p>So <span class="user-mention" data-user-id="116107">@davidtwco</span> I that some of the original examples from <a href="https://github.com/rust-lang/rust/issues/55511" target="_blank" title="https://github.com/rust-lang/rust/issues/55511">https://github.com/rust-lang/rust/issues/55511</a> also give errors when they shouldn't (in particular, the first example)</p>



<a name="154202634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154202634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154202634">(Jan 02 2019 at 21:29)</a>:</h4>
<p>I'm still a touch confused why though</p>



<a name="154202693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154202693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154202693">(Jan 02 2019 at 21:30)</a>:</h4>
<p>I also thought of a potential complication with user-type-annotations around promoted stuff--</p>



<a name="154202701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154202701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154202701">(Jan 02 2019 at 21:30)</a>:</h4>
<p>if we "promote" a type assertion.. maybe we never do that I guess</p>



<a name="154202884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154202884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154202884">(Jan 02 2019 at 21:33)</a>:</h4>
<p>Ah, I see why the error occurs, duh. We are requiring that the type of the path being matched is a subtype of the type of the constant that ... doesn't seem right.</p>



<a name="154202964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154202964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154202964">(Jan 02 2019 at 21:34)</a>:</h4>
<p>Oops, should have paid more attention when working on that fix.</p>



<a name="154203073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203073">(Jan 02 2019 at 21:36)</a>:</h4>
<blockquote>
<p>Ah, I see why the error occurs, duh. We are requiring that the type of the path being matched is a subtype of the type of the constant that ... doesn't seem right.</p>
</blockquote>
<p>This might just be my misunderstanding, but isn't that what is required in order to make the should-error case from <a href="https://github.com/rust-lang/rust/issues/55511" target="_blank" title="https://github.com/rust-lang/rust/issues/55511">#55511</a> produce an error?</p>



<a name="154203201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203201">(Jan 02 2019 at 21:39)</a>:</h4>
<p>Well, it will produce an error in that case, but it's not the only way :)</p>



<a name="154203208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203208">(Jan 02 2019 at 21:39)</a>:</h4>
<blockquote>
<p>Well, it will produce an error in that case, but it's not the only way <span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>
</blockquote>
<p>Of course, right.</p>



<a name="154203261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203261">(Jan 02 2019 at 21:40)</a>:</h4>
<p>to be honest, the semantics of matching against a constant have long been debated</p>



<a name="154203266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203266">(Jan 02 2019 at 21:40)</a>:</h4>
<p>but if you think of it as e.g. similar to <code>a == b</code></p>



<a name="154203274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203274">(Jan 02 2019 at 21:40)</a>:</h4>
<p>that does not require that <code>A &lt;: B</code> nor <code>B &lt;: A</code> (where <code>A</code> and  <code>B</code> are the types of <code>a</code> and <code>b</code> respectively)</p>



<a name="154203282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203282">(Jan 02 2019 at 21:40)</a>:</h4>
<p>it does require that <code>A: PartialEq&lt;B&gt;</code></p>



<a name="154203299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203299">(Jan 02 2019 at 21:41)</a>:</h4>
<p>but e.g. <code>&amp;'a str: PartialEq&lt;&amp;'static str&gt;</code> and <code>&amp;'static str: PartialEq&lt;&amp;'a str&gt;</code></p>



<a name="154203321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203321">(Jan 02 2019 at 21:41)</a>:</h4>
<blockquote>
<p>Of course, right.</p>
</blockquote>
<p>don't feel too bad :P I at first was thinking it was the semantics we wanted too</p>



<a name="154203330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203330">(Jan 02 2019 at 21:41)</a>:</h4>
<p>but that was clearly just wrong, even in the original set of examples</p>



<a name="154203383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203383">(Jan 02 2019 at 21:42)</a>:</h4>
<p>for those <em>original</em> examples, something like <code>ExpectedType &lt;: MatchedType</code> does work</p>



<a name="154203391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203391">(Jan 02 2019 at 21:42)</a>:</h4>
<p>(which is the reverse of what we are doing now)</p>



<a name="154203396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203396">(Jan 02 2019 at 21:42)</a>:</h4>
<p>but I don't think it's really <em>right</em> either</p>



<a name="154203445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203445">(Jan 02 2019 at 21:43)</a>:</h4>
<p>and actually this <code>PartialEq</code> impl for <code>Cell</code> is unnecessarily strict</p>
<div class="codehilite"><pre><span></span><span class="cp">#[stable(feature = </span><span class="s">&quot;rust1&quot;</span><span class="cp">, since = </span><span class="s">&quot;1.0.0&quot;</span><span class="cp">)]</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>:<span class="nb">PartialEq</span> <span class="o">+</span><span class="w"> </span><span class="nb">Copy</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">PartialEq</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Cell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[inline]</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">eq</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">other</span>: <span class="kp">&amp;</span><span class="nc">Cell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="154203451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203451">(Jan 02 2019 at 21:43)</a>:</h4>
<p>but I guess that's why we are getting an error</p>



<a name="154203513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203513">(Jan 02 2019 at 21:44)</a>:</h4>
<p>that is, it could really be</p>
<div class="codehilite"><pre><span></span><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Copy</span><span class="p">,</span><span class="w"> </span><span class="n">U</span>: <span class="nb">Copy</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">PartialEq</span><span class="o">&lt;</span><span class="n">Cell</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Cell</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">  </span><span class="n">T</span>: <span class="nb">PartialEq</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>


<p>I suppose</p>



<a name="154203530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203530">(Jan 02 2019 at 21:44)</a>:</h4>
<p>anyway now I'm wondering how the lexical type-checker is handling this</p>



<a name="154203643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203643">(Jan 02 2019 at 21:46)</a>:</h4>
<p>OK, so, <span class="user-mention" data-user-id="116107">@davidtwco</span> , the <em>lexical</em> type checker actually does kind of the "wrong" thing too:</p>
<div class="codehilite"><pre><span></span><span class="w">                </span><span class="c1">// somewhat surprising: in this case, the subtyping</span>
<span class="w">                </span><span class="c1">// relation goes the opposite way as the other</span>
<span class="w">                </span><span class="c1">// cases. Actually what we really want is not a subtyping</span>
<span class="w">                </span><span class="c1">// relation at all but rather that there exists a LUB (so</span>
<span class="w">                </span><span class="c1">// that they can be compared). However, in practice,</span>
<span class="w">                </span><span class="c1">// constants are always scalars or strings.  For scalars</span>
<span class="w">                </span><span class="c1">// subtyping is irrelevant, and for strings `ty` is</span>
<span class="w">                </span><span class="c1">// type is `&amp;&#39;static str`, so if we say that</span>
<span class="w">                </span><span class="c1">//</span>
<span class="w">                </span><span class="c1">//     &amp;&#39;static str &lt;: expected</span>
<span class="w">                </span><span class="c1">//</span>
<span class="w">                </span><span class="c1">// that&#39;s equivalent to there existing a LUB.</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">demand_suptype</span><span class="p">(</span><span class="n">pat</span><span class="p">.</span><span class="n">span</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="p">,</span><span class="w"> </span><span class="n">pat_ty</span><span class="p">);</span><span class="w"></span>
</pre></div>


<p>that's from <a href="https://github.com/rust-lang/rust/blob/ec194646fef1a467073ad74b8b68f6f202cfce97/src/librustc_typeck/check/_match.rs#L153-L165" target="_blank" title="https://github.com/rust-lang/rust/blob/ec194646fef1a467073ad74b8b68f6f202cfce97/src/librustc_typeck/check/_match.rs#L153-L165"><code>_match.rs</code></a></p>



<a name="154203663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203663">(Jan 02 2019 at 21:46)</a>:</h4>
<p>that fix doesn't seem very right</p>



<a name="154203667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203667">(Jan 02 2019 at 21:46)</a>:</h4>
<p>but I suppose we could match that behavior by extending pattern ascriptions on constants to have the opposite variance</p>



<a name="154203693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203693">(Jan 02 2019 at 21:47)</a>:</h4>
<p>which would be a small fix, if not the ideal one</p>



<a name="154203703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203703">(Jan 02 2019 at 21:47)</a>:</h4>
<p>I wonder if I can craft a test case that behaves poorly, probably</p>



<a name="154203766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203766">(Jan 02 2019 at 21:48)</a>:</h4>
<blockquote>
<p>but I suppose we could match that behavior by extending pattern ascriptions on constants to have the opposite variance</p>
</blockquote>
<p>I think that would be a good first step so that nightly doesn't have this behaviour and instead mirrors what AST borrowck does.</p>



<a name="154203769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203769">(Jan 02 2019 at 21:48)</a>:</h4>
<p>We could follow-up with the more correct fix.</p>



<a name="154203818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203818">(Jan 02 2019 at 21:49)</a>:</h4>
<p>yes</p>



<a name="154203824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203824">(Jan 02 2019 at 21:49)</a>:</h4>
<p>I'm actually not sure if I can create a kind of "actionable" example where the rule goes wrong in <em>stable</em> Rust</p>



<a name="154203902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203902">(Jan 02 2019 at 21:50)</a>:</h4>
<p>because there..huh. There are <em>supposed</em> to be limitations on the types of constants you can match against</p>



<a name="154203913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203913">(Jan 02 2019 at 21:50)</a>:</h4>
<p>they have to "derive" <code>Eq</code> and <code>PartialEq</code> iirc</p>



<a name="154203917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154203917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154203917">(Jan 02 2019 at 21:50)</a>:</h4>
<p>and not have manual impl's</p>



<a name="154204023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154204023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154204023">(Jan 02 2019 at 21:52)</a>:</h4>
<p>but I don't see the requisite (unstable...) annotations on <code>Cell</code>...</p>



<a name="154204212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154204212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154204212">(Jan 02 2019 at 21:55)</a>:</h4>
<p>ah, wow, interesting</p>



<a name="154204260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154204260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154204260">(Jan 02 2019 at 21:56)</a>:</h4>
<p>my example only compiled because I was using <code>Option&lt;Cell&lt;u32&gt;&gt;</code> and the value was <code>None</code></p>



<a name="154204272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154204272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154204272">(Jan 02 2019 at 21:56)</a>:</h4>
<p>if <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=a215c646c07b91bb7040fdf8f378a14b" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=a215c646c07b91bb7040fdf8f378a14b">the value is <code>Some</code></a>, you get the stability error</p>



<a name="154204276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154204276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154204276">(Jan 02 2019 at 21:56)</a>:</h4>
<p>anyway, <span class="user-mention" data-user-id="116107">@davidtwco</span>, are you going to do that fix, or should I?</p>



<a name="154204280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154204280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154204280">(Jan 02 2019 at 21:56)</a>:</h4>
<p>I can leave a few notes if desired</p>



<a name="154204296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154204296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154204296">(Jan 02 2019 at 21:56)</a>:</h4>
<p>I can fix it.</p>



<a name="154204325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154204325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154204325">(Jan 02 2019 at 21:57)</a>:</h4>
<p>Assuming you are fine with adding a field <a href="https://github.com/davidtwco/rust/blob/4be7214d30b121762c8675c3e732083da262b136/src/librustc_mir/hair/pattern/mod.rs#L862" target="_blank" title="https://github.com/davidtwco/rust/blob/4be7214d30b121762c8675c3e732083da262b136/src/librustc_mir/hair/pattern/mod.rs#L862">here</a> with the variance, I think it should be alright to thread that through.</p>



<a name="154204339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154204339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154204339">(Jan 02 2019 at 21:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> speaking of user type annotations... <a href="https://github.com/rust-lang/rfcs/pull/2522#issuecomment-415551732" target="_blank" title="https://github.com/rust-lang/rfcs/pull/2522#issuecomment-415551732">https://github.com/rust-lang/rfcs/pull/2522#issuecomment-415551732</a> <span class="emoji emoji-1f642" title="slight smile">:slight_smile:</span></p>



<a name="154204447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154204447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154204447">(Jan 02 2019 at 21:59)</a>:</h4>
<blockquote>
<p>Assuming you are fine with adding a field <a href="https://github.com/davidtwco/rust/blob/4be7214d30b121762c8675c3e732083da262b136/src/librustc_mir/hair/pattern/mod.rs#L862" target="_blank" title="https://github.com/davidtwco/rust/blob/4be7214d30b121762c8675c3e732083da262b136/src/librustc_mir/hair/pattern/mod.rs#L862">here</a> with the variance, I think it should be alright to thread that through.</p>
</blockquote>
<p>yes this is basically what I had in mind</p>



<a name="154243265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154243265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154243265">(Jan 03 2019 at 14:45)</a>:</h4>
<p>Submitted a PR with that.</p>



<a name="154243285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154243285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154243285">(Jan 03 2019 at 14:45)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/57304" target="_blank" title="https://github.com/rust-lang/rust/issues/57304">#57304</a></p>



<a name="154248561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154248561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154248561">(Jan 03 2019 at 16:09)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="116107">@davidtwco</span> :)</p>



<a name="154248583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154248583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154248583">(Jan 03 2019 at 16:09)</a>:</h4>
<p>Making a quick change to it to fix an issue I've noticed.</p>



<a name="154249146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154249146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154249146">(Jan 03 2019 at 16:18)</a>:</h4>
<p>Ah, <span class="user-mention" data-user-id="116107">@davidtwco</span>, <a href="https://github.com/rust-lang/rust/pull/57304#discussion_r245025505" target="_blank" title="https://github.com/rust-lang/rust/pull/57304#discussion_r245025505">left a comment here</a></p>



<a name="154249312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154249312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154249312">(Jan 03 2019 at 16:21)</a>:</h4>
<p>I've made it locally so that it is an <code>Option&lt;Variance&gt;</code> and I only set it to <code>Some(..)</code> in the specific spot where we want to reverse it, and then I just use <code>.unwrap_or(..)</code> with whatever was there previously - I found that I couldn't replicate the exact variances used in each case if I shifted that decision back like I was doing.</p>



<a name="154249396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154249396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154249396">(Jan 03 2019 at 16:22)</a>:</h4>
<p>It seemed off to introduce a <code>variance</code> field to the <code>PatternKind::AscribeUserType</code> and then only use it in one case.</p>



<a name="154249454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154249454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154249454">(Jan 03 2019 at 16:23)</a>:</h4>
<p>That <em>should</em> resolve your review comment?</p>



<a name="154250693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154250693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154250693">(Jan 03 2019 at 16:45)</a>:</h4>
<p>hmm maybe but I agree something seems fishy</p>



<a name="154250698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154250698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154250698">(Jan 03 2019 at 16:45)</a>:</h4>
<p>also, the use I highlighted is not "like" the others</p>



<a name="154250699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154250699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154250699">(Jan 03 2019 at 16:46)</a>:</h4>
<p>as I noted -- it is constraining the type of a different thing</p>



<a name="154250735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154250735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154250735">(Jan 03 2019 at 16:46)</a>:</h4>
<p>and that is why the variance does not apply</p>



<a name="154250749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154250749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154250749">(Jan 03 2019 at 16:46)</a>:</h4>
<p>so I don't really think that the <code>unwrap_or</code> solution is right there</p>



<a name="154250755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154250755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154250755">(Jan 03 2019 at 16:46)</a>:</h4>
<p>(though I think that the variance will always be <code>None</code> in that case)</p>



<a name="154250762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154250762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154250762">(Jan 03 2019 at 16:46)</a>:</h4>
<p>are there other cases that didn't match up, <span class="user-mention" data-user-id="116107">@davidtwco</span>?</p>



<a name="154250769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154250769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154250769">(Jan 03 2019 at 16:46)</a>:</h4>
<p>I imagined that we would only change the spot that was currently <code>Covariant</code></p>



<a name="154250849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154250849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154250849">(Jan 03 2019 at 16:48)</a>:</h4>
<p>When I was looking at the diff previously, there was a place where we used <code>Invariant</code> and and one where we used <code>Covariant</code>, but I wasn't sure that they wouldn't result from the same <code>PatternKind::AscribeUserType</code> construction - where I didn't have the information to pick between <code>Invariant</code> and <code>Covariant</code>.</p>



<a name="154251251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154251251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154251251">(Jan 03 2019 at 16:55)</a>:</h4>
<p>I can take another look <span class="user-mention" data-user-id="116107">@davidtwco</span>, but I feel a bit uneasy with <code>Option&lt;Variance&gt;</code></p>



<a name="154251259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154251259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154251259">(Jan 03 2019 at 16:55)</a>:</h4>
<p>I'd feel better if we can say with certainty when it matters and when it doesn't</p>



<a name="154251263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154251263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154251263">(Jan 03 2019 at 16:55)</a>:</h4>
<p>(and I <em>think</em> we can)</p>



<a name="154251327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154251327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154251327">(Jan 03 2019 at 16:56)</a>:</h4>
<p>I'm happy to change the approach, I'm just not too sure what that would look like.</p>



<a name="154253110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253110">(Jan 03 2019 at 17:30)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> so in your new PR, I see two calls to <code>unwrap_or</code>, if i'm not mistaken, right?</p>



<a name="154253115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253115">(Jan 03 2019 at 17:30)</a>:</h4>
<p>Yeah.</p>



<a name="154253129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253129">(Jan 03 2019 at 17:31)</a>:</h4>
<p>basically I think the PR looks like your original PR except that the place which uses <code>Invariant</code> just ignores the variance and continues to specify <code>Invariant</code></p>



<a name="154253133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253133">(Jan 03 2019 at 17:31)</a>:</h4>
<p>and the reason it ignores it should have a comment,</p>



<a name="154253135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253135">(Jan 03 2019 at 17:31)</a>:</h4>
<p>the point is that the variance is the variance to use when relating the type annotation to <em>the value being matched</em></p>



<a name="154253141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253141">(Jan 03 2019 at 17:31)</a>:</h4>
<p>but in this case, that same annotation is being applied to the <em>binding</em></p>



<a name="154253146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253146">(Jan 03 2019 at 17:31)</a>:</h4>
<p>as an example:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="nc">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">expr</span><span class="o">&gt;</span><span class="w"></span>
</pre></div>



<a name="154253149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253149">(Jan 03 2019 at 17:31)</a>:</h4>
<p>here, the type <code>T_x</code> of <code>x</code> just <em>is</em> <code>T</code> (<code>T == T_x</code>, or <code>T &lt;: T_x</code> and <code>T_x &lt;: T</code>)</p>



<a name="154253192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253192">(Jan 03 2019 at 17:32)</a>:</h4>
<p>but the type <code>U</code> of <code>&lt;expr&gt;</code> need only meet <code>U &lt;: T</code></p>



<a name="154253224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253224">(Jan 03 2019 at 17:33)</a>:</h4>
<p>this is also why it is using <code>Invariant</code> and not <code>Covariant</code> now</p>



<a name="154253232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253232">(Jan 03 2019 at 17:33)</a>:</h4>
<p>which I should have commented in the first place but anyway</p>



<a name="154253234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253234">(Jan 03 2019 at 17:33)</a>:</h4>
<p>does that make sense?</p>



<a name="154253301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253301">(Jan 03 2019 at 17:34)</a>:</h4>
<p>The example makes sense but I'm still not sure I understand exactly what changes you're requesting.</p>



<a name="154253304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253304">(Jan 03 2019 at 17:34)</a>:</h4>
<p>ok well to start can you revert to the older version?</p>



<a name="154253323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253323">(Jan 03 2019 at 17:35)</a>:</h4>
<p>Doing that now.</p>



<a name="154253748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154253748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154253748">(Jan 03 2019 at 17:43)</a>:</h4>
<p>Alright, pushed what was there before.</p>



<a name="154254436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154254436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154254436">(Jan 03 2019 at 17:55)</a>:</h4>
<p>It seems like in doing that, I've lost the <a href="https://github.com/rust-lang/rust/pull/57304/files#diff-ef9c98f22bf95e3bda12c849d5550cedL1324" target="_blank" title="https://github.com/rust-lang/rust/pull/57304/files#diff-ef9c98f22bf95e3bda12c849d5550cedL1324">equivalent of this line</a> where <code>Covariant</code> is given.</p>



<a name="154254618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154254618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154254618">(Jan 03 2019 at 17:58)</a>:</h4>
<p>But I've not been able to work out which of <a href="https://github.com/rust-lang/rust/pull/57304/files#diff-b2dc10372716c61d52394605d024374bR91" target="_blank" title="https://github.com/rust-lang/rust/pull/57304/files#diff-b2dc10372716c61d52394605d024374bR91">this spot</a> or <a href="https://github.com/rust-lang/rust/pull/57304/files#diff-e826542d6f24137d5b0b5ae333230529R718" target="_blank" title="https://github.com/rust-lang/rust/pull/57304/files#diff-e826542d6f24137d5b0b5ae333230529R718">this spot</a> should be changed, or if neither is really correct as it depends on some decision made later in the code (which is why I used an <code>Option</code>).</p>



<a name="154255531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154255531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154255531">(Jan 03 2019 at 18:12)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> <a href="https://github.com/rust-lang/rust/pull/57304#pullrequestreview-189119455" target="_blank" title="https://github.com/rust-lang/rust/pull/57304#pullrequestreview-189119455">left a review</a></p>



<a name="154255567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154255567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154255567">(Jan 03 2019 at 18:13)</a>:</h4>
<p>Great, thanks.</p>



<a name="154255639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154255639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154255639">(Jan 03 2019 at 18:14)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> btw, this conversation seems relevant to this thread: <a href="https://github.com/rust-lang/rfcs/pull/2522#discussion_r209286375" target="_blank" title="https://github.com/rust-lang/rfcs/pull/2522#discussion_r209286375">https://github.com/rust-lang/rfcs/pull/2522#discussion_r209286375</a></p>



<a name="154255642"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154255642" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> centril <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154255642">(Jan 03 2019 at 18:14)</a>:</h4>
<p>(pinged you there)</p>



<a name="154255884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154255884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154255884">(Jan 03 2019 at 18:18)</a>:</h4>
<p>I've got to review that RFC at some point</p>



<a name="154255911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154255911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154255911">(Jan 03 2019 at 18:18)</a>:</h4>
<p>/me goes to print it out</p>



<a name="154257109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154257109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154257109">(Jan 03 2019 at 18:34)</a>:</h4>
<p>Addressed review comments <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="154257522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154257522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154257522">(Jan 03 2019 at 18:40)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> did they make sense to you? :)</p>



<a name="154257681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354943%20user%20type%20annot%20in%20unreachable%20code/near/154257681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354943.20user.20type.20annot.20in.20unreachable.20code.html#154257681">(Jan 03 2019 at 18:42)</a>:</h4>
<p>Yeah, it all makes sense, cleared up some misconceptions about how we were doing things.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>