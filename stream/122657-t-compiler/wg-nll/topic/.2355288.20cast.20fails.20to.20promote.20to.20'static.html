<html>
<head><meta charset="utf-8"><title>#55288 cast fails to promote to &#x27;static · t-compiler/wg-nll · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/index.html">t-compiler/wg-nll</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html">#55288 cast fails to promote to &#x27;static</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="136367697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136367697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136367697">(Oct 23 2018 at 21:13)</a>:</h4>
<p>FYI, this test case no longer ICEs on the latest master - it still produces an incorrect error though.</p>



<a name="136367935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136367935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136367935">(Oct 23 2018 at 21:17)</a>:</h4>
<p>progess :P</p>



<a name="136371108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136371108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136371108">(Oct 23 2018 at 22:16)</a>:</h4>
<p>Do you have any plans for how you'd like this tackled? It seems like the cause is the constraint to static created as a result of the <code>AscribeUserTy</code> statement.</p>



<a name="136376313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136376313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136376313">(Oct 24 2018 at 00:09)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> i think we need to modify the promotion code to permit promotion even when there is a <code>AscribeUserTy</code> statement; <span class="user-mention" data-user-id="124288">@Oli</span> or <span class="user-mention" data-user-id="120791">@RalfJ</span> may have more insights, or I can take a closer look tomorrow</p>



<a name="136392866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136392866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136392866">(Oct 24 2018 at 07:57)</a>:</h4>
<p>Most likely, in <code>qualify_const.rs</code> one needs to prevent the visitor from recursing into <code>AscribeUserTy</code> (I'm not sure where though), because otherwise the const qualifier will see the place that is ascribed twice and assume that there are two accesses and thus the value cannot be promoted</p>



<a name="136393724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136393724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136393724">(Oct 24 2018 at 08:15)</a>:</h4>
<p>Unless I'm being naive and this isn't the only place where that might happen, <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1124" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/qualify_consts.rs#L1124"><code>AscribeUserTy</code> is only visited once</a>?</p>



<a name="136395655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136395655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136395655">(Oct 24 2018 at 08:59)</a>:</h4>
<p>That's what I thought, too, but I haven't been able to figure out what else could have caused this. Did the MIR around the <code>AscribeUserTy</code> change? Or was the statement just added additionally without any other MIR changes?</p>



<a name="136395848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136395848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136395848">(Oct 24 2018 at 09:03)</a>:</h4>
<p>As I understand it, the <code>AscribeUserTy</code> statement was added for this case to support user type annotations in cast statements - but in this particular instance, that new statement is resulting in a constraint that the lifetime must be <code>'static</code>. I think what is happening is that the error caused by that new constraint is happening before the promotion to <code>'static</code>.</p>



<a name="136395991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136395991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136395991">(Oct 24 2018 at 09:04)</a>:</h4>
<p>As before, without this constraint, there wouldn't be an error generated by that constraint not being met and then it will get to be promoted and everything ends up fine.</p>



<a name="136395996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136395996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136395996">(Oct 24 2018 at 09:04)</a>:</h4>
<p>That's my working theory, at least.</p>



<a name="136397064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136397064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136397064">(Oct 24 2018 at 09:25)</a>:</h4>
<p>I think you're on the right track</p>



<a name="136397073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136397073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136397073">(Oct 24 2018 at 09:25)</a>:</h4>
<p>the borrow checker runs after promotion</p>



<a name="136397119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136397119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136397119">(Oct 24 2018 at 09:26)</a>:</h4>
<p>the value that <code>AscribeUserTy</code> refers to was promoted successfully</p>



<a name="136397120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136397120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136397120">(Oct 24 2018 at 09:26)</a>:</h4>
<p>the problem is that <code>AscribeUserTy</code> still points to the unpromoted value</p>



<a name="136397133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136397133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136397133">(Oct 24 2018 at 09:27)</a>:</h4>
<p>Ah, so I should try update that during promotion?</p>



<a name="136397141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136397141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136397141">(Oct 24 2018 at 09:27)</a>:</h4>
<p>Or is that not a thing that can be done?</p>



<a name="136397144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136397144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136397144">(Oct 24 2018 at 09:27)</a>:</h4>
<p>jup, and it can be done</p>



<a name="136397146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136397146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136397146">(Oct 24 2018 at 09:27)</a>:</h4>
<p>but not in <code>qualify_const.rs</code></p>



<a name="136397148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136397148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136397148">(Oct 24 2018 at 09:27)</a>:</h4>
<p>you'll need to do it in <code>promote_consts.rs</code></p>



<a name="136397152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136397152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136397152">(Oct 24 2018 at 09:28)</a>:</h4>
<p>that's where the actual promotion is happening</p>



<a name="136397195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136397195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136397195">(Oct 24 2018 at 09:28)</a>:</h4>
<p>Alright. I'll see what I can come up with. Thanks.</p>



<a name="136415140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136415140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136415140">(Oct 24 2018 at 14:58)</a>:</h4>
<p>interesting</p>



<a name="136438653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136438653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136438653">(Oct 24 2018 at 21:49)</a>:</h4>
<p>So, having just had a chance to look at this a little, in both cases (the working case where I remove the cast and the not-working case where I don't remove the cast), I only see <code>rustc_mir::transform::promote_consts: promote_candidates([])</code> - as if there isn't any promotion happening, in either case?</p>
<p><a href="https://gist.github.com/davidtwco/f529f630b4599ebbf4b4e680bd5ddd97" target="_blank" title="https://gist.github.com/davidtwco/f529f630b4599ebbf4b4e680bd5ddd97">This is the MIR without the cast</a>.<br>
<a href="https://gist.github.com/davidtwco/85082eac3665afc9ae9f8969ba3b61d8" target="_blank" title="https://gist.github.com/davidtwco/85082eac3665afc9ae9f8969ba3b61d8">This is the MIR with the cast</a>.</p>



<a name="136438916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136438916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136438916">(Oct 24 2018 at 21:55)</a>:</h4>
<p>Hoping I'll have some more time tomorrow night to properly dig in and see if I can't work anything out.</p>



<a name="136439088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136439088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136439088">(Oct 24 2018 at 21:58)</a>:</h4>
<p>I think that the partial log statement I sent above comes from the empty main function - since const promotion is limited to either functions or const functions. It is not coming from the static map.</p>



<a name="136439119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136439119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136439119">(Oct 24 2018 at 21:59)</a>:</h4>
<p>(I've double checked this, the <code>mode</code> variable that decides which branch we go into in <code>qualify_consts.rs</code> is <code>Mode::Static</code> which doesn't end up calling <code>promote_consts::promote_candidates</code>)</p>



<a name="136439146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136439146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136439146">(Oct 24 2018 at 22:00)</a>:</h4>
<p>There's either somewhere else in <code>qualify_consts</code> that makes the working case work; or it's something else entirely. I'm not sure.</p>



<a name="136439686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136439686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136439686">(Oct 24 2018 at 22:08)</a>:</h4>
<p>This looks suspicious</p>
<div class="codehilite"><pre><span></span>_3 = &amp;_4;                        // bb0[16]: scope 0 at src/test/ui/nll/issue-55288.rs:17:27: 19:2
// ...
StorageDead(_4); // bb0[21]: scope 0 at src/test/ui/nll/issue-55288.rs:19:2: 19:3
</pre></div>



<a name="136477953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136477953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136477953">(Oct 25 2018 at 13:48)</a>:</h4>
<p>Hmm, yes, curious. I agree with <span class="user-mention" data-user-id="116118">@Matthew Jasper</span> that the immediate <em>cause</em> of the error is that we have a <code>StorageDead</code></p>



<a name="136478010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478010">(Oct 25 2018 at 13:48)</a>:</h4>
<p>Why is that <code>StorageDead</code> strange?</p>



<a name="136478013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478013">(Oct 25 2018 at 13:48)</a>:</h4>
<p>of course the next question is <em>why</em></p>



<a name="136478016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478016">(Oct 25 2018 at 13:48)</a>:</h4>
<p>IIRC, in statics/constants, we emit <code>StorageDead</code> only for temporaries that doesn't escape into static scope — so why does it consider this a temporary etc in one case but not the other?</p>



<a name="136478039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478039">(Oct 25 2018 at 13:49)</a>:</h4>
<p>well, it's not whether it's strange or not, but it causes the error for sure— we are reporting the error because we see a <code>StorageDead</code> and we have an outstanding borrow</p>



<a name="136478081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478081">(Oct 25 2018 at 13:49)</a>:</h4>
<p>Ah, I didn't know that we used <code>StorageDead</code> differently in statics/consts.</p>



<a name="136478434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478434">(Oct 25 2018 at 13:54)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> are you familiar with the temporary lifetime rules?</p>



<a name="136478455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478455">(Oct 25 2018 at 13:54)</a>:</h4>
<p>e.g., <code>let x = foo(&amp;something())</code> -- in this, the return value of <code>something()</code> is saved into a temporary that is freed before the next statement</p>



<a name="136478463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478463">(Oct 25 2018 at 13:55)</a>:</h4>
<p><code>let x = &amp;something()</code> -- but here we extend the lifetime till the end of the block</p>



<a name="136478490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478490">(Oct 25 2018 at 13:55)</a>:</h4>
<p>the idea for statics/consts is to apply the same rules to the value of the static -- if it would have been "extended till end of block", it is never freed, but otherwise, it is</p>



<a name="136478499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478499">(Oct 25 2018 at 13:55)</a>:</h4>
<p>in this case, I would <em>expect</em> the <code>StorageDead</code></p>



<a name="136478513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478513">(Oct 25 2018 at 13:55)</a>:</h4>
<p>(but I would also have expected promotion to kick in, maybe it a bit of a moot point)</p>



<a name="136478516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478516">(Oct 25 2018 at 13:56)</a>:</h4>
<p>so actually the question is more why <strong>doesn't</strong> the <code>StorageDead</code> get emitted?</p>



<a name="136478565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478565">(Oct 25 2018 at 13:56)</a>:</h4>
<p>(in the case that compiles successfully)</p>



<a name="136478568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478568">(Oct 25 2018 at 13:56)</a>:</h4>
<p>That makes sense. Hadn't considered how those rules would apply to statics.</p>



<a name="136478577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136478577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136478577">(Oct 25 2018 at 13:56)</a>:</h4>
<p>I can dig into that more when I'm next looking at this.</p>



<a name="136506055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136506055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136506055">(Oct 25 2018 at 20:48)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> So, I've worked out what the issue is here.</p>



<a name="136506364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136506364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136506364">(Oct 25 2018 at 20:54)</a>:</h4>
<p>In the below snippet of MIR, the use of <code>_6</code> in the <code>AscribeUserType</code> statement is causing the const promotion (which is actually happening despite my theory otherwise because of the branch it was falling into) to not happen, as was the suspicion all along.</p>
<div class="codehilite"><pre><span></span>        _6 = move _7;                    // bb0[12]: scope 0 at src/test/ui/nll/issue-55288.rs:18:5: 18:35
        AscribeUserType(_6, o, Ty(Canonical { variables: [], value: &amp;&#39;static [u8] })); // bb0[13]: scope 0 at src/test/ui/nll/issue-55288.rs:18:5: 18:35
       _5 = _6; // bb0[14]: scope 0 at src/test/ui/nll/issue-55288.rs:18:5: 18:35
</pre></div>


<p>In particular, what was happening was that the <code>TempState</code> for <code>_6</code> is being marked as <code>Unpromotable</code> and then that meant it got flagged as <code>Qualif::NOT_PROMOTABLE</code> so didn't become a promotion candidate and as a result, didn't get the <code>StorageDead</code> statements removed by the <code>qualify_consts</code> pass.</p>
<p><code>_6</code> is being marked as <code>Unpromotable</code> because the <code>PlaceContext::Validate</code> returns <code>false</code> from <code>is_nonmutating_use</code>. That made a difference <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L118-L128" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L118-L128">in this code</a>. Without the <code>PlaceContext::Validate</code> introduced by the user type assertions, visiting the local never resulted in a <code>TempState::Unpromotable</code> and therefore was always promoted and the relevant <code>StorageDead</code> statements removed. I guess the solution if we want to make this code work is to either special-case <code>PlaceContext::Validate</code> as <code>true</code> just like <code>PlaceContext::Borrow</code> here, or change the return value of <code>is_nonmutating_use</code> to <code>true</code> for that <code>PlaceContext</code> variant.</p>



<a name="136506375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136506375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136506375">(Oct 25 2018 at 20:54)</a>:</h4>
<p>Or something else that you think of.</p>



<a name="136506784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136506784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136506784">(Oct 25 2018 at 21:00)</a>:</h4>
<p>I would imagine <code>Validate</code> would be a non-mutating use. But I don't know the const promotion code...</p>



<a name="136506809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136506809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136506809">(Oct 25 2018 at 21:01)</a>:</h4>
<p>but you say that this same code is also special-casing <code>PlaceContext::Borrow</code>  ?</p>



<a name="136506823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136506823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136506823">(Oct 25 2018 at 21:01)</a>:</h4>
<p>ah I see, you linked it. Hmm.</p>



<a name="136506880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136506880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136506880">(Oct 25 2018 at 21:02)</a>:</h4>
<p>IIRC there was a topic in <a class="stream" data-stream-id="131828" href="/#narrow/stream/131828-t-compiler">#t-compiler</a> like this a bit ago.</p>



<a name="136506991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136506991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136506991">(Oct 25 2018 at 21:04)</a>:</h4>
<p><a href="#narrow/stream/131828-t-compiler/subject/PlaceContext.20for.20AscribeUserType/near/136343874" title="#narrow/stream/131828-t-compiler/subject/PlaceContext.20for.20AscribeUserType/near/136343874">https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/subject/PlaceContext.20for.20AscribeUserType/near/136343874</a></p>



<a name="136507102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136507102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136507102">(Oct 25 2018 at 21:06)</a>:</h4>
<p>It looks like this might fix itself if whatever change <span class="user-mention" data-user-id="120791">@RalfJ</span> was landing changes the variant used by <code>AscribeUserType</code> in <code>PlaceContext</code> and that variant returns <code>true</code> from <code>is_nonmutating_use</code>.</p>



<a name="136507120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136507120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136507120">(Oct 25 2018 at 21:07)</a>:</h4>
<p>It seems wrong to make any change if <code>PlaceContext::Validate</code> is intended for use by miri and not just <code>AscribeUserType</code>?</p>



<a name="136507124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136507124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136507124">(Oct 25 2018 at 21:07)</a>:</h4>
<p>yeah I agree. It sounds like I misunderstood what Validate is used for</p>



<a name="136507128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136507128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136507128">(Oct 25 2018 at 21:07)</a>:</h4>
<p>maybe coordinate with <span class="user-mention" data-user-id="120791">@RalfJ</span> here. Find out where they are in their PR</p>



<a name="136507132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136507132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136507132">(Oct 25 2018 at 21:07)</a>:</h4>
<p>worst case scenario: Add a new PlaceContext yourself</p>



<a name="136507180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136507180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136507180">(Oct 25 2018 at 21:08)</a>:</h4>
<p>Yeah, I think that makes sense. If they have a big PR that might not land for a while then I'll make something small that adds the new variant so we can get this fixed, otherwise I'll leave it.</p>



<a name="136507190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136507190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136507190">(Oct 25 2018 at 21:08)</a>:</h4>
<p>right. and your adding a new PlaceContext will force <span class="user-mention" data-user-id="120791">@RalfJ</span> to deal with it upon rebase. Or vice versa, depending on who wins the race.</p>



<a name="136507194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136507194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136507194">(Oct 25 2018 at 21:08)</a>:</h4>
<p><span class="emoji emoji-1f44d" title="thumbs up">:thumbs_up:</span></p>



<a name="136507624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136507624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136507624">(Oct 25 2018 at 21:16)</a>:</h4>
<p>(I agree with all this; adding a new <code>PlaceContext</code> is indeed what I expected the fix would be)</p>



<a name="136529690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136529690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136529690">(Oct 26 2018 at 06:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> <span class="user-mention" data-user-id="116083">@pnkfelix</span> <span class="user-mention" data-user-id="116009">@nikomatsakis</span> My PR at <a href="https://github.com/rust-lang/rust/pull/55316" target="_blank" title="https://github.com/rust-lang/rust/pull/55316">https://github.com/rust-lang/rust/pull/55316</a> does add a <code>PlaceContext</code> variant for <code>AscribeUserType</code></p>



<a name="136529699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136529699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136529699">(Oct 26 2018 at 06:57)</a>:</h4>
<p>but I made it neither mutating nor nonmutating use because that's what <span class="user-mention" data-user-id="116009">@nikomatsakis</span> told me to do ;)</p>



<a name="136529906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136529906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136529906">(Oct 26 2018 at 07:02)</a>:</h4>
<p>Awesome. I guess this fixes itself then. Presumably the test case from the issue here doesn’t fail to compile on your branch?</p>



<a name="136533069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136533069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136533069">(Oct 26 2018 at 08:30)</a>:</h4>
<p>In fact, re-reading your message, this still won't be fixed as the <code>is_nonmutating_use</code> is <code>false</code> (which is correct). We'd still need to special-case the new variant <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L121" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L121">here</a> to make this issue pass.</p>



<a name="136533168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136533168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136533168">(Oct 26 2018 at 08:33)</a>:</h4>
<p>(that and adding a test for the example in the issue)</p>



<a name="136536020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536020">(Oct 26 2018 at 09:40)</a>:</h4>
<p>I'm wondering why else branch in that code is <code>context.is_nonmutating_use()</code> and not <code>!context.is_mutating_use()</code></p>



<a name="136536033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536033">(Oct 26 2018 at 09:41)</a>:</h4>
<p>Is it because it increments <code>*uses</code> ?</p>



<a name="136536080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536080">(Oct 26 2018 at 09:42)</a>:</h4>
<p>I'd have assumed that <code>context.is_nonmutating_use()</code> was just <code>!context.is_mutating_use()</code>.</p>



<a name="136536091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536091">(Oct 26 2018 at 09:42)</a>:</h4>
<p>except its not, since <span class="user-mention" data-user-id="120791">@RalfJ</span> made it "neither mutating nor nonmutating use"</p>



<a name="136536101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536101">(Oct 26 2018 at 09:43)</a>:</h4>
<p>Yeah, I realise that now. That's where it threw my expections.</p>



<a name="136536102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536102">(Oct 26 2018 at 09:43)</a>:</h4>
<p>note in particular that there's an <code>is_use()</code> method that just does the <em>OR</em> of <code>is_mutating_use()</code> and <code>is_nonmutating_use()</code></p>



<a name="136536104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536104">(Oct 26 2018 at 09:43)</a>:</h4>
<p>right, gotcha</p>



<a name="136536110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536110">(Oct 26 2018 at 09:43)</a>:</h4>
<p>But that is why, if someone had the understanding I did, they might call <code>is_nonmutating_use</code> when they really meant <code>!is_mutating_use</code>.</p>



<a name="136536111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536111">(Oct 26 2018 at 09:43)</a>:</h4>
<p>true</p>



<a name="136536157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536157">(Oct 26 2018 at 09:44)</a>:</h4>
<p>I dont understand what these classifiers are used for at all</p>



<a name="136536163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536163">(Oct 26 2018 at 09:44)</a>:</h4>
<p><code>Validate</code> was for miri's validation statements though, so that was definitely wrong</p>



<a name="136536165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536165">(Oct 26 2018 at 09:44)</a>:</h4>
<p>oh dear, I was hoping <span class="user-mention" data-user-id="120791">@RalfJ</span> was our local expert. :)</p>



<a name="136536174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536174">(Oct 26 2018 at 09:44)</a>:</h4>
<p>this is NLL land. or borrowck. or so. I know nothing about any of that^^</p>



<a name="136536177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536177">(Oct 26 2018 at 09:45)</a>:</h4>
<p>I know a lot about CTFE/miri and that's pretty much the end of my rustc knowledge :)</p>



<a name="136536183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536183">(Oct 26 2018 at 09:45)</a>:</h4>
<p>well its actually const promotion code</p>



<a name="136536186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536186">(Oct 26 2018 at 09:45)</a>:</h4>
<p>/me runs away screaming</p>



<a name="136536190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536190">(Oct 26 2018 at 09:45)</a>:</h4>
<p>I can understand why <code>AscribeUserTy</code> isn't a mutating use or a nonmutating use - since it isn't using the value, just doing a check.</p>



<a name="136536194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536194">(Oct 26 2018 at 09:45)</a>:</h4>
<p>const promotion doesn't overlap with CTFE ?</p>



<a name="136536197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536197">(Oct 26 2018 at 09:45)</a>:</h4>
<p><span class="user-mention" data-user-id="120791">@RalfJ</span> ^ ?</p>



<a name="136536201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536201">(Oct 26 2018 at 09:45)</a>:</h4>
<p>now that <code>Validate</code> is gone, there is <code>Retag</code>. that has a side-effect in miri, it mutates the content of the place, so I made it a mutating use....^^</p>



<a name="136536206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536206">(Oct 26 2018 at 09:45)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> const promotion is a static analysis on MIR</p>



<a name="136536208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536208">(Oct 26 2018 at 09:46)</a>:</h4>
<p>it has no code overlap with CTFE</p>



<a name="136536246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536246">(Oct 26 2018 at 09:46)</a>:</h4>
<p>but a lot of overlap of concerns</p>



<a name="136536249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536249">(Oct 26 2018 at 09:46)</a>:</h4>
<p>okay</p>



<a name="136536250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536250">(Oct 26 2018 at 09:46)</a>:</h4>
<p>I think the correct approach here is actually to change that line to <code>!is_mutating_use</code>.</p>



<a name="136536251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536251">(Oct 26 2018 at 09:46)</a>:</h4>
<p>also, it exists twice (once on HIR and once on MIR)</p>



<a name="136536254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536254">(Oct 26 2018 at 09:46)</a>:</h4>
<p>and both passes are a mess</p>



<a name="136536255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536255">(Oct 26 2018 at 09:46)</a>:</h4>
<p>But I don't know if that would break other things.</p>



<a name="136536257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536257">(Oct 26 2018 at 09:46)</a>:</h4>
<p>so, generally, it's just bad^^</p>



<a name="136536259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536259">(Oct 26 2018 at 09:46)</a>:</h4>
<p>maybe that's where my confusion lies: I had assumed that since there is an overlap of concerns, it might make sense for the code to overlap. Like reuse common elements</p>



<a name="136536262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536262">(Oct 26 2018 at 09:46)</a>:</h4>
<p>but when it comes to const promotion I'd like to summon <span class="user-mention" data-user-id="124288">@Oli</span></p>



<a name="136536265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536265">(Oct 26 2018 at 09:46)</a>:</h4>
<p>they know that mess way better than I do^^</p>



<a name="136536276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536276">(Oct 26 2018 at 09:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span>  const promotion runs on runtime MIR though</p>



<a name="136536279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536279">(Oct 26 2018 at 09:47)</a>:</h4>
<p>on non-monomorphized runtime mir</p>



<a name="136536281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536281">(Oct 26 2018 at 09:47)</a>:</h4>
<p>it has to statically determine if we want to promote this</p>



<a name="136536283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536283">(Oct 26 2018 at 09:47)</a>:</h4>
<p>that has nothing to do with what CTFE does, which is to actually execute fully monomorphized MIR</p>



<a name="136536287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536287">(Oct 26 2018 at 09:48)</a>:</h4>
<p>It seems like <code>StorageDead</code>, <code>StorageLive</code> and <code>Validate</code> (or whatever the new variant is called) all return <code>false</code> for either.</p>



<a name="136536330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536330">(Oct 26 2018 at 09:48)</a>:</h4>
<p>IOW, CTFE is "dynamic" -- it runs at compile-time, but it is an interpreter so it is dynamic the same way running a python program is dynamic. const promotion is static.</p>



<a name="136536343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536343">(Oct 26 2018 at 09:48)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> the new <code>Validate</code> is called <code>Retag</code> and I made it return <code>true</code> for <code>is_mutating_use</code></p>



<a name="136536346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536346">(Oct 26 2018 at 09:48)</a>:</h4>
<p>because it mutates. in my model.</p>



<a name="136536347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536347">(Oct 26 2018 at 09:48)</a>:</h4>
<p>I guessed I had figured that much of the expressions that we can promote are also things that we can CTFE ?</p>



<a name="136536356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536356">(Oct 26 2018 at 09:49)</a>:</h4>
<p>I meant the new variant for <code>AscribeUserTy</code>.</p>



<a name="136536357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536357">(Oct 26 2018 at 09:49)</a>:</h4>
<p>(apart from stuff that actually references statically allocated state ...?)</p>



<a name="136536362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536362">(Oct 26 2018 at 09:49)</a>:</h4>
<blockquote>
<p>I guessed I had figured that much of the expressions that we can promote are also things that we can CTFE ?</p>
</blockquote>
<p>it must be the case that everything we promote, we can run in CTFE.</p>



<a name="136536364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536364">(Oct 26 2018 at 09:49)</a>:</h4>
<p>but its like a static analysis: running on the source code to see if later doing CTFE will work.</p>



<a name="136536368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536368">(Oct 26 2018 at 09:49)</a>:</h4>
<p>I am not certain we need this static analysis on the MIR</p>



<a name="136536370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536370">(Oct 26 2018 at 09:49)</a>:</h4>
<p>I think <code>!is_mutating_use</code> would work, since we exit early in that function for <code>StorageDead</code> and <code>StorageLive</code> before the check.</p>



<a name="136536422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536422">(Oct 26 2018 at 09:50)</a>:</h4>
<p>I've been trying to formulate my thoughts (e.g. in <a href="https://github.com/rust-lang/rust/issues/53819" target="_blank" title="https://github.com/rust-lang/rust/issues/53819">https://github.com/rust-lang/rust/issues/53819</a>), but I guess that's orthogonal</p>



<a name="136536438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536438">(Oct 26 2018 at 09:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> if the only other case is the variant for AscribeUserType, maybe it would be clearer to just put that in as a special case...</p>



<a name="136536441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536441">(Oct 26 2018 at 09:50)</a>:</h4>
<p>not obvious to me. Depends on what the supposed "specs" are for <code>fn is_[non]mutating_use</code>.</p>



<a name="136536449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536449">(Oct 26 2018 at 09:50)</a>:</h4>
<p>what is the trouble with making <code>AscribeUserType</code> a nonmutating use?</p>



<a name="136536452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536452">(Oct 26 2018 at 09:50)</a>:</h4>
<p>then const promotion should be fine with it</p>



<a name="136536465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536465">(Oct 26 2018 at 09:51)</a>:</h4>
<p>It depends what the intent of that code was - was it to check for a use that doesn't mutate, or a nonmutating use - since those seem to be different.</p>



<a name="136536468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536468">(Oct 26 2018 at 09:51)</a>:</h4>
<p>I was assuming the problem is that <code>AscribeUserTy</code> doesn't correspond to an actual use ?</p>



<a name="136536471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536471">(Oct 26 2018 at 09:51)</a>:</h4>
<p>just a constraint on the type of the <del>local</del> place</p>



<a name="136536474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536474">(Oct 26 2018 at 09:51)</a>:</h4>
<p>yes that</p>



<a name="136536475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536475">(Oct 26 2018 at 09:51)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> I dont think they are different. just some of them arent uses at all</p>



<a name="136536476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536476">(Oct 26 2018 at 09:51)</a>:</h4>
<p>Yeah, it isn't a use at all.</p>



<a name="136536484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536484">(Oct 26 2018 at 09:51)</a>:</h4>
<p>i.e., <code>StorageDead</code>/<code>StorageLive</code></p>



<a name="136536520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536520">(Oct 26 2018 at 09:52)</a>:</h4>
<p>but <code>AscribeUserTy</code> is a use, right?</p>



<a name="136536529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536529">(Oct 26 2018 at 09:52)</a>:</h4>
<p>it takes a value and returns the same value, or so</p>



<a name="136536530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536530">(Oct 26 2018 at 09:52)</a>:</h4>
<p>changing its type</p>



<a name="136536531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536531">(Oct 26 2018 at 09:52)</a>:</h4>
<p>no?</p>



<a name="136536532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536532">(Oct 26 2018 at 09:52)</a>:</h4>
<p>No, it doesn't do anything</p>



<a name="136536536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536536">(Oct 26 2018 at 09:52)</a>:</h4>
<p>oh</p>



<a name="136536538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536538">(Oct 26 2018 at 09:52)</a>:</h4>
<p>it's just a marker for nll</p>



<a name="136536539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536539">(Oct 26 2018 at 09:52)</a>:</h4>
<p>Does it make sense to back out early <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L96-L101" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L96-L101">in this conditional</a> then?</p>



<a name="136536544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536544">(Oct 26 2018 at 09:52)</a>:</h4>
<p>maybe that conditional should then be <code>!is_use()</code></p>



<a name="136536545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536545">(Oct 26 2018 at 09:52)</a>:</h4>
<p>backing out early might be the right call.</p>



<a name="136536552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536552">(Oct 26 2018 at 09:52)</a>:</h4>
<p>and <code>AscribeUserTy</code> should return <code>false</code> for both (mutating and nonmutating)</p>



<a name="136536562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536562">(Oct 26 2018 at 09:53)</a>:</h4>
<p>what does <code>is_storage_marker</code> mean?</p>



<a name="136536566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536566">(Oct 26 2018 at 09:53)</a>:</h4>
<p>sounds about right?</p>



<a name="136536593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536593">(Oct 26 2018 at 09:53)</a>:</h4>
<p>It's defined as <code>context == PlaceContext::StorageDead || context == PlaceContext::StorageLive</code></p>



<a name="136536596"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536596" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536596">(Oct 26 2018 at 09:53)</a>:</h4>
<p>/me is going to let you three hash this out. :)</p>



<a name="136536644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536644">(Oct 26 2018 at 09:54)</a>:</h4>
<p>the other use is <a href="https://github.com/rust-lang/rust/blob/441519536c8bd138e8c651743249acd6814747a1/src/librustc_mir/transform/copy_prop.rs#L257" target="_blank" title="https://github.com/rust-lang/rust/blob/441519536c8bd138e8c651743249acd6814747a1/src/librustc_mir/transform/copy_prop.rs#L257">https://github.com/rust-lang/rust/blob/441519536c8bd138e8c651743249acd6814747a1/src/librustc_mir/transform/copy_prop.rs#L257</a></p>



<a name="136536648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536648">(Oct 26 2018 at 09:54)</a>:</h4>
<p>so I say yes, most definitely is <code>AscribeUserTy</code> a storage marker</p>



<a name="136536666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536666">(Oct 26 2018 at 09:55)</a>:</h4>
<p>not sure if that sounds right</p>



<a name="136536667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536667">(Oct 26 2018 at 09:55)</a>:</h4>
<p>maybe redefine this function as an exhaustive match, so future changes to <code>PlaceContext</code> will hit it</p>



<a name="136536675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536675">(Oct 26 2018 at 09:55)</a>:</h4>
<p>Would making it a storage marker result in the pass you just linked removing the statements before they can be checked by NLL?</p>



<a name="136536676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536676">(Oct 26 2018 at 09:55)</a>:</h4>
<p>storage_marker sounds very specific to StorageDead/Live</p>



<a name="136536686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536686">(Oct 26 2018 at 09:55)</a>:</h4>
<p>but maybe rename it to <code>is_marker</code>?</p>



<a name="136536722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536722">(Oct 26 2018 at 09:56)</a>:</h4>
<p><code>is_local_marker</code> then</p>



<a name="136536726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536726">(Oct 26 2018 at 09:56)</a>:</h4>
<p>and then declare that every <code>PlaceContext</code> must be exactly one of mutating use, nonmutating use, marker</p>



<a name="136536731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536731">(Oct 26 2018 at 09:56)</a>:</h4>
<p>I assumed <code>strorage</code> to mean <code>Local</code></p>



<a name="136536738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536738">(Oct 26 2018 at 09:56)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> no, the copy prop pass runs after nll</p>



<a name="136536739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536739">(Oct 26 2018 at 09:56)</a>:</h4>
<p>I'd add a new function that is <code>is_use</code> - returning false for <code>AscribeUserTy</code>, <code>StorageDead</code> and <code>StorageLive</code>. I'd change <code>is_nonmutating_use</code> and <code>is_mutating_use</code> to return <code>false</code> straight away as a match arm if that the new <code>is_use</code> returns <code>true</code>. That makes it much clearer why those variants return <code>false</code> for both.</p>



<a name="136536743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536743">(Oct 26 2018 at 09:56)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@Oli</span> <code>AscribeUserTy</code> works on any <code>Place</code> though</p>



<a name="136536745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536745">(Oct 26 2018 at 09:56)</a>:</h4>
<p>oh</p>



<a name="136536753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536753">(Oct 26 2018 at 09:57)</a>:</h4>
<p>well, then <code>is_use</code> sounds great</p>



<a name="136536759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536759">(Oct 26 2018 at 09:57)</a>:</h4>
<p>And then change the condition to be <code>!is_use() || is_nonmutating_use()</code> <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L122" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L122">here</a>.</p>



<a name="136536762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536762">(Oct 26 2018 at 09:57)</a>:</h4>
<p>at which point we might change <code>is_nonmutating_use</code> to an <code>Option&lt;bool&gt;</code>?</p>



<a name="136536763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536763">(Oct 26 2018 at 09:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> the problem with that is that the non-use variants still have to be repeated in nonmutating use</p>



<a name="136536805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536805">(Oct 26 2018 at 09:58)</a>:</h4>
<p>I'd rather we classify <code>PlaceContext</code> in three disjoint classes, than in a hierarchy with some excluded</p>



<a name="136536807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536807">(Oct 26 2018 at 09:58)</a>:</h4>
<p>three disjoint classes covering everything seem clearer to me</p>



<a name="136536808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536808">(Oct 26 2018 at 09:58)</a>:</h4>
<p>That's true...</p>



<a name="136536812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536812">(Oct 26 2018 at 09:58)</a>:</h4>
<p>So... split the enum into 4?</p>



<a name="136536813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536813">(Oct 26 2018 at 09:58)</a>:</h4>
<p>the classes being: mutating use, nonmutating use, marker</p>



<a name="136536814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536814">(Oct 26 2018 at 09:58)</a>:</h4>
<p>into 4?</p>



<a name="136536815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536815">(Oct 26 2018 at 09:58)</a>:</h4>
<p>you can leave it as one enum</p>



<a name="136536816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536816">(Oct 26 2018 at 09:58)</a>:</h4>
<p>just make a new <del>4</del> K variant enum</p>



<a name="136536817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536817">(Oct 26 2018 at 09:58)</a>:</h4>
<p>but why 4?</p>



<a name="136536818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536818">(Oct 26 2018 at 09:58)</a>:</h4>
<p>and a method that maps from the first to the second</p>



<a name="136536819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536819">(Oct 26 2018 at 09:58)</a>:</h4>
<p>we have 3 classes^^</p>



<a name="136536826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536826">(Oct 26 2018 at 09:59)</a>:</h4>
<p>We could have three <code>is_x</code> functions with the invariant that any given variant can only return <code>true</code> for one of them.</p>



<a name="136536829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536829">(Oct 26 2018 at 09:59)</a>:</h4>
<p>If we split the enum we don't need the methods anymore</p>



<a name="136536833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536833">(Oct 26 2018 at 09:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> that was my thinking but having this encoded in the types would be even nicer</p>



<a name="136536837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536837">(Oct 26 2018 at 09:59)</a>:</h4>
<p>Yeah, definitely.</p>



<a name="136536838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536838">(Oct 26 2018 at 09:59)</a>:</h4>
<p>yea, base enum with 3 variants + one enum for each variant</p>



<a name="136536841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536841">(Oct 26 2018 at 09:59)</a>:</h4>
<p><code>enum PlaceContextKind { Mutating, Nonmutating, Marker }</code></p>



<a name="136536846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536846">(Oct 26 2018 at 09:59)</a>:</h4>
<p><code>fn classify(PlaceContext) -&gt; PlaceContextKind</code></p>



<a name="136536939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536939">(Oct 26 2018 at 10:00)</a>:</h4>
<p>s/Marker/StaticEffect/ ?</p>



<a name="136536947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536947">(Oct 26 2018 at 10:00)</a>:</h4>
<p>or what <span class="user-mention" data-user-id="124288">@Oli</span> said. no strong preference, just it seems overkill to have 4 enums here</p>



<a name="136536948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536948">(Oct 26 2018 at 10:00)</a>:</h4>
<p>(just a thought. I don't find "Marker" intuitive)</p>



<a name="136536949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536949">(Oct 26 2018 at 10:00)</a>:</h4>
<p><code>enum PlaceContext { Mutating(MutPlaceUse), Nonmutating(NonMutPlaceUse), Marker(PlaceNonUse) }</code></p>



<a name="136536950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536950">(Oct 26 2018 at 10:00)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> I'm happy to bikeshed the name^^</p>



<a name="136536972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536972">(Oct 26 2018 at 10:01)</a>:</h4>
<p>That would work. Then we'd change the condition <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L122" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L122">here</a> to be <code>context_kind == PlaceContextKind::NonMutatingUse || context_kind == PlaceContextKind::NoUse</code> and this test would pass.</p>



<a name="136536976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536976">(Oct 26 2018 at 10:01)</a>:</h4>
<p>Or do we handle the <code>NoUse</code> case by exiting early.</p>



<a name="136536977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136536977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136536977">(Oct 26 2018 at 10:01)</a>:</h4>
<p>That'd probably be better.</p>



<a name="136537024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537024">(Oct 26 2018 at 10:02)</a>:</h4>
<p>I still think it's more fragile if we don't do it in the type</p>



<a name="136537027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537027">(Oct 26 2018 at 10:02)</a>:</h4>
<p>but I'm not blocking it on that</p>



<a name="136537030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537030">(Oct 26 2018 at 10:02)</a>:</h4>
<p>there's a reasonable argument for doing it in the type</p>



<a name="136537036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537036">(Oct 26 2018 at 10:02)</a>:</h4>
<p>it can be nice to narrow to the specific subset of variants relevant to a given branch</p>



<a name="136537046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537046">(Oct 26 2018 at 10:03)</a>:</h4>
<p>but are there instances where you'd want to handle two of the three cases in one branch?</p>



<a name="136537050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537050">(Oct 26 2018 at 10:03)</a>:</h4>
<p>Is this change going to be made in <span class="user-mention" data-user-id="120791">@RalfJ</span>'s current PR that adds the <code>AscribeUserTy</code> variant or should I branch off that and make this change to fix this issue?</p>



<a name="136537183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537183">(Oct 26 2018 at 10:06)</a>:</h4>
<blockquote>
<p>That would work. Then we'd change the condition <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L122" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/transform/promote_consts.rs#L122">here</a> to be <code>context_kind == PlaceContextKind::NonMutatingUse || context_kind == PlaceContextKind::NoUse</code> and this test would pass.</p>
</blockquote>
<p>we can still have the <code>is_</code> methods</p>



<a name="136537186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537186">(Oct 26 2018 at 10:06)</a>:</h4>
<p>just they would internally use <code>classify</code></p>



<a name="136537208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537208">(Oct 26 2018 at 10:07)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> I'd say do one of the two variants we discussed here (<span class="user-mention" data-user-id="124288">@Oli</span>'s or mine), ignore my PR</p>



<a name="136537213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537213">(Oct 26 2018 at 10:07)</a>:</h4>
<p>whoever lands last has to rebase^^</p>



<a name="136537218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537218">(Oct 26 2018 at 10:07)</a>:</h4>
<p>Easy to say when you've got the open PR that'll be in the queue earlier, but sure thing <span class="emoji emoji-1f61d" title="stuck out tongue">:stuck_out_tongue:</span></p>



<a name="136537256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537256">(Oct 26 2018 at 10:08)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> well my PR depends on another PR that didnt land yet though</p>



<a name="136537266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537266">(Oct 26 2018 at 10:08)</a>:</h4>
<p>so I have two PRs that need to land. both are earlier in the queue but the race isnt entirely settled^^</p>



<a name="136537267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537267">(Oct 26 2018 at 10:08)</a>:</h4>
<p>if you want you can do it on top of my PR</p>



<a name="136537270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537270">(Oct 26 2018 at 10:08)</a>:</h4>
<p>I just thought we'd not want to tie these things together</p>



<a name="136537279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136537279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136537279">(Oct 26 2018 at 10:09)</a>:</h4>
<p>Sure thing, works for me.</p>



<a name="136540467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136540467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136540467">(Oct 26 2018 at 11:29)</a>:</h4>
<p>Alright, submitted <a href="https://github.com/rust-lang/rust/issues/55385" target="_blank" title="https://github.com/rust-lang/rust/issues/55385">#55385</a>, let the race begin.</p>



<a name="136545909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136545909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136545909">(Oct 26 2018 at 13:14)</a>:</h4>
<p>Responded to review comments.</p>



<a name="136562986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136562986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136562986">(Oct 26 2018 at 17:52)</a>:</h4>
<p>glad you all sorted this out :)</p>



<a name="136645937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136645937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> RalfJ <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136645937">(Oct 28 2018 at 10:13)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> that's unfair, you got priority :P</p>



<a name="136645978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2355288%20cast%20fails%20to%20promote%20to%20%27static/near/136645978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2355288.20cast.20fails.20to.20promote.20to.20&#x27;static.html#136645978">(Oct 28 2018 at 10:14)</a>:</h4>
<p>Might have cheated a little bit, yeah.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>