<html>
<head><meta charset="utf-8"><title>#21114 non-intuitive rvalue lifetimes · t-compiler/wg-nll · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/index.html">t-compiler/wg-nll</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html">#21114 non-intuitive rvalue lifetimes</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="134233848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134233848" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134233848">(Sep 19 2018 at 14:03)</a>:</h4>
<p>So I've been looking at the examples from <a href="https://github.com/rust-lang/rust/issues/21114" target="_blank" title="https://github.com/rust-lang/rust/issues/21114">#21114</a>, and I had a thought</p>



<a name="134233863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134233863" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134233863">(Sep 19 2018 at 14:03)</a>:</h4>
<p>a lot of the discussion centers around trying to make the examples compile, e.g. by changing our rvalue lifetime rules</p>



<a name="134233913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134233913" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134233913">(Sep 19 2018 at 14:04)</a>:</h4>
<p>but I was just now wondering: If we could emit a more targetted diagnostic, focused on this case</p>



<a name="134233933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134233933" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134233933">(Sep 19 2018 at 14:04)</a>:</h4>
<p>that could provide links to the explanation of why this is happening, and the standard workarounds</p>



<a name="134233976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134233976" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134233976">(Sep 19 2018 at 14:05)</a>:</h4>
<p>That seems like it would be a marked improvement over today, where you just see "does not live long enough" without enough context to understand why...</p>



<a name="134234494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134234494" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134234494">(Sep 19 2018 at 14:13)</a>:</h4>
<p>(I'm thinking in particular of targeting the diagnostic to the scenario where you have</p>
<div class="codehilite"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="p">...;</span><span class="w"></span>
<span class="w">   </span><span class="n">TAIL</span><span class="w"></span>
<span class="p">};</span><span class="w"> </span><span class="c1">// semi, or at end of `-&gt; ()` fn</span>
</pre></div>


<p>so the result of the block is unused and thus dropped. We don't have to change language semantics to suggest to the user that they could put a semi immediately after TAIL if we see that the extended lifetime is causing a "does not live long enough" error for some temp created within TAIL.)</p>



<a name="134234963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134234963" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134234963">(Sep 19 2018 at 14:20)</a>:</h4>
<p>In essence: I'm suggesting that while the status quo is annoying, what makes it especially annoying is <strong>tracking down</strong> the issue when it arises. Exceptionally so for newcomers.  If the compiler feedback guided one to blindly insert the semi-colon, then some people might gripe momentarily as they type it in, but I doubt we'd see bug reports.</p>



<a name="134236010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134236010" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134236010">(Sep 19 2018 at 14:36)</a>:</h4>
<blockquote>
<p>I doubt we'd see bug reports.</p>
</blockquote>
<p>Wouldn't that be a net negative end result? People are subtly annoyed, but not enough to tell us. When they talk to friends they say "oh, Rust has weird magical problems with stuff, I don't even remember what, so I don't recommend using it"</p>



<a name="134236163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134236163" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134236163">(Sep 19 2018 at 14:38)</a>:</h4>
<p>Okay well maybe that was flippant of me. A more positive way to phrase it: this could cause people to shift their viewpoint over whether this is a bug.</p>



<a name="134236204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134236204" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134236204">(Sep 19 2018 at 14:39)</a>:</h4>
<p>The drop order for these temporaries <em>is</em> observable, and thus the presence of that semicolon immediately after TAIL does matter, even when the type is <code>TAIL: ()</code>.</p>



<a name="134236226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134236226" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134236226">(Sep 19 2018 at 14:39)</a>:</h4>
<p>(I mean the order is observable with respect to the locals bound in the block)</p>



<a name="134236474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134236474" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134236474">(Sep 19 2018 at 14:42)</a>:</h4>
<p>as demonstrated e.g. on this <a href="https://play.rust-lang.org/?gist=b5ed18445883a9e1eb7dd3c3614b7a0d&amp;version=stable&amp;mode=debug&amp;edition=2015" target="_blank" title="https://play.rust-lang.org/?gist=b5ed18445883a9e1eb7dd3c3614b7a0d&amp;version=stable&amp;mode=debug&amp;edition=2015">playpen</a></p>



<a name="134236541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134236541" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134236541">(Sep 19 2018 at 14:43)</a>:</h4>
<p>And sure, some people may still get frustrated and abandon ship</p>



<a name="134236628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134236628" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134236628">(Sep 19 2018 at 14:44)</a>:</h4>
<p>but the diagnostics in the compiler, especially the help explanations, try hard to counteract that...</p>



<a name="134236767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134236767" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134236767">(Sep 19 2018 at 14:46)</a>:</h4>
<p>Part of my response here is influenced by my <a href="https://github.com/rust-lang/rfcs/pull/210" target="_blank" title="https://github.com/rust-lang/rfcs/pull/210">past experience</a> attempting to propose changes to the dynamic semantics of drop</p>



<a name="134236962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134236962" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134236962">(Sep 19 2018 at 14:49)</a>:</h4>
<p>because a change to the rvalue lifetimes in this scenario is, in some ways, a more limited version of what was being proposed for RFC 210. And there was a lot of fear there about silently breaking existing code.</p>



<a name="134239211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134239211" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134239211">(Sep 19 2018 at 15:20)</a>:</h4>
<p>I do think that telling people 'maybe insert a ; here' and pointing to some longer form documentation in --explain for that error could be a good way of 'solving' this</p>



<a name="134239245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134239245" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134239245">(Sep 19 2018 at 15:21)</a>:</h4>
<p>We could even say something like "drop order changes", possibly even providing that order to the user</p>



<a name="134243831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134243831" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134243831">(Sep 19 2018 at 16:06)</a>:</h4>
<blockquote>
<p>to shift their viewpoint over whether this is a bug</p>
</blockquote>
<p>Which is a crucial thing, I believe. <em>Is</em> it a bug? (I know that bug vs feature request is a fuzzy line). Your discussion of observable effects seems to indicate that it is <strong>not</strong> a bug, but a hard fact within the current set of rules. If that's the case, I agree there are two primary options: improve diagnostics and/or change the rules. NLL is an example of changing the rules, but there was also effort put into improving diagnostics for AST borrowck before MIR borrowck could exist.</p>
<p>I think it's mostly your phrasing that is throwing me, which sounds like "let's pull a fast one on the users so they stop complaining". I'm <span class="emoji emoji-1f4af" title="100">:100:</span> on improving diagnostics to explain a rule that is non-intuitive, however.</p>



<a name="134245662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134245662" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134245662">(Sep 19 2018 at 16:07)</a>:</h4>
<p>yes, I think my phrasing was poor.</p>



<a name="134251681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134251681" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134251681">(Sep 19 2018 at 16:12)</a>:</h4>
<p>When I wrote: </p>
<blockquote>
<p>... some people might gripe momentarily as they type it in, but I doubt we'd see bug reports.</p>
</blockquote>
<p>I was half-thinking of cases like my own griping <a href="#narrow/stream/122657-wg-nll/subject/general.20discussion/near/134164409" title="#narrow/stream/122657-wg-nll/subject/general.20discussion/near/134164409">here</a>, which was actually a case where the borrow-checker is <em>right</em> to reject my code.</p>



<a name="134258145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134258145" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134258145">(Sep 19 2018 at 18:00)</a>:</h4>
<p>my feeling <span class="user-mention" data-user-id="116083">@pnkfelix</span> is that we ought to start with a diganostic, yes</p>



<a name="134258155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134258155" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134258155">(Sep 19 2018 at 18:00)</a>:</h4>
<p>makes a lot of sense</p>



<a name="134258161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134258161" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134258161">(Sep 19 2018 at 18:00)</a>:</h4>
<p>it's something we can do in the short term</p>



<a name="134258173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134258173" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134258173">(Sep 19 2018 at 18:00)</a>:</h4>
<p>that said, I think maybe longer term we should see if we can make some targeted changes here— but you're not wrong that changing drop order is a scary thing</p>



<a name="134258213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134258213" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134258213">(Sep 19 2018 at 18:01)</a>:</h4>
<p>(before doing it, I would want to try and assess impact, e.g. by devising some sort of lint to detect cases where we think it would maybe be significant and doing crater runs)</p>



<a name="134263454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134263454" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134263454">(Sep 19 2018 at 19:27)</a>:</h4>
<p><span class="user-mention" data-user-id="116155">@Jake Goulding</span> FWIW, "NLL is an example of changing the rules" isn't really true -- that is, NLL should have no effects on runtime execution -- unlike changes to drop order</p>



<a name="134263881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134263881" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134263881">(Sep 19 2018 at 19:35)</a>:</h4>
<p>Perhaps my wording wasn't the clearest. What I mean is that pre-NLL, it was <em>expected</em> that certain sound code would not compile. It was not a <strong>bug</strong> that that code didn't compile, but it was unfortunate. The rules were overly conservative and then NLL "changed the rules".</p>
<p>It sounds similar to this case, as presumably there's code that is sound w.r.t these conditions at the end of blocks but the compiler doesn't allow it. (I assume this because I don't imagine that someone is trying to change the rules to allow for unsoundness). <span class="user-mention" data-user-id="116083">@pnkfelix</span> saying " change to the rvalue lifetimes" sounds like "a change to the rules"</p>



<a name="134263898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134263898" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134263898">(Sep 19 2018 at 19:35)</a>:</h4>
<p>NLL is <em>literally</em> a change to the rules of what the compiler allows though...</p>



<a name="134263959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134263959" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134263959">(Sep 19 2018 at 19:36)</a>:</h4>
<p>In truth NLL did change a <em>few</em> of the rules of the dynamic semantics</p>



<a name="134263978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134263978" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134263978">(Sep 19 2018 at 19:37)</a>:</h4>
<p>Perhaps y'all are meaning a different set of rules than what I mean, but I cannot figure out how to state what I have stated in a different manner :-)</p>



<a name="134264116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134264116" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134264116">(Sep 19 2018 at 19:40)</a>:</h4>
<p>Now, if <span class="user-mention" data-user-id="116122">@simulacrum</span> means that "the changes we call NLL" and "the proposed changes to rvalue lifetimes " would have different amounts / kinds of end-user behavior, that's totally possible; I don't know anything about that (other than what <span class="user-mention" data-user-id="116083">@pnkfelix</span> just spilled <span class="emoji emoji-1f609" title="wink">:wink:</span> )</p>



<a name="134264156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134264156" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134264156">(Sep 19 2018 at 19:41)</a>:</h4>
<p>Yes, I think different amounts is what I meant to imply; NLL is intended to be mostly or all 'transparent' as I understand it</p>



<a name="134400523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134400523" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134400523">(Sep 21 2018 at 19:54)</a>:</h4>
<p>(in any case I am looking into trying to improve the diagnostics here now)</p>



<a name="134407000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407000" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407000">(Sep 21 2018 at 21:46)</a>:</h4>
<p>So, for this example (<a href="https://play.rust-lang.org/?gist=5749c428b2f05a75415856aff3a98dd9&amp;version=nightly&amp;mode=debug&amp;edition=2015" target="_blank" title="https://play.rust-lang.org/?gist=5749c428b2f05a75415856aff3a98dd9&amp;version=nightly&amp;mode=debug&amp;edition=2015">play</a>)</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">_thing1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">D</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="s">&quot;thing1&quot;</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="c1">// D(&quot;other&quot;).next(&amp;_thing1).end()</span>
<span class="w">        </span><span class="n">D</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_thing1</span><span class="p">).</span><span class="n">end</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>what do people think of this new diagnostic output i've managed to hack up:</p>
<div class="codehilite"><pre><span></span>error[E0597]: `_thing1` does not live long enough
  --&gt; ../../issue-21114-demo-borrow-of-temp.rs:7:11
   |
7  |         D(&amp;_thing1).end()
   |           ^^^^^^^^ borrowed value does not live long enough
8  |     }
   |     - `_thing1` dropped here while still borrowed
9  |
10 |     ;
   |     - borrow later used here, when temporary is dropped
   |
note: temporary is formed when evaluating this expresion
  --&gt; ../../issue-21114-demo-borrow-of-temp.rs:7:9
   |
7  |         D(&amp;_thing1).end()
   |         ^^^^^^^^^^^
   = note: temporary is part of a block-tail expression. Consider adding semicolon to drop its temporaries sooner
</pre></div>



<a name="134407121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407121" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407121">(Sep 21 2018 at 21:49)</a>:</h4>
<p>I recognize there is likely to be overlap/conflicts between some of what I've done here and <span class="user-mention" data-user-id="116925">@mikhail-m1</span> 's work on <a href="https://github.com/rust-lang/rust/issues/54164" target="_blank" title="https://github.com/rust-lang/rust/issues/54164">#54164</a>. But hopefully it will be more synergistic rather than actual conflicts...</p>



<a name="134407218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407218" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407218">(Sep 21 2018 at 21:51)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> I like it -- I like in particular calling out the expression where temporary is formed. That said, I think it's a bit misleading here. In particular, the temporary is formed because of <code>end</code> being an <code>&amp;self</code> method, I suppose?</p>



<a name="134407220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407220" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407220">(Sep 21 2018 at 21:51)</a>:</h4>
<p>I think we should work harder to call that out</p>



<a name="134407231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407231" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407231">(Sep 21 2018 at 21:51)</a>:</h4>
<p>that's one of the more confusing things</p>



<a name="134407251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407251" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407251">(Sep 21 2018 at 21:51)</a>:</h4>
<p><code>end</code> being a <code>&amp;self</code> method rather than a <code>self</code> method, you mean?</p>



<a name="134407314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407314" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407314">(Sep 21 2018 at 21:52)</a>:</h4>
<p>(i mean, a temporary is formed in the latter case; it just gets moved into <code>end()</code> and dies sooner...)</p>



<a name="134407350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407350" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407350">(Sep 21 2018 at 21:53)</a>:</h4>
<p>but it <em>is</em> an interesting idea, to tie in the relevance of the signature of <code>end</code></p>



<a name="134407363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407363" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407363">(Sep 21 2018 at 21:53)</a>:</h4>
<p>(The playpen link I provided provides the full context, as you might expect; so that's a better place to play around with the example.)</p>



<a name="134407372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407372" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407372">(Sep 21 2018 at 21:54)</a>:</h4>
<p>Anyway I'm pretty happy with even this smallish hack that I've gotten working</p>



<a name="134407524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407524" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407524">(Sep 21 2018 at 21:56)</a>:</h4>
<p><del>Perhaps amazingly ... this change doesn't seem to have affected our test suite ???</del></p>



<a name="134407552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407552" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407552">(Sep 21 2018 at 21:57)</a>:</h4>
<p><del>as in... we aren't <em>testing</em> the behavior on this test, even in <code>[ui (nll)]</code>  ???</del></p>



<a name="134407563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407563" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407563">(Sep 21 2018 at 21:57)</a>:</h4>
<p>wait no, strike that</p>



<a name="134407620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407620" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407620">(Sep 21 2018 at 21:58)</a>:</h4>
<p>I'd suggest explaining "a block-tail expression" or changing that wording.</p>



<a name="134407629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407629" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407629">(Sep 21 2018 at 21:58)</a>:</h4>
<p><del>What's the old diagnostic for that look like?</del> I'll just look at the playground link.</p>



<a name="134407647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407647" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407647">(Sep 21 2018 at 21:59)</a>:</h4>
<blockquote>
<p>(i mean, a temporary is formed in the latter case; it just gets moved into <code>end()</code> and dies sooner...)</p>
</blockquote>
<p>my point is that the underlined thing — <code>D(&amp;_thing1)</code> — is the value that goes <em>into</em> the temporary, but not the <em>reason</em> we make a temporary</p>



<a name="134407648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407648" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407648">(Sep 21 2018 at 21:59)</a>:</h4>
<p>(I misread my test output; it never got to <code>[ui (nll)]</code>, due to problems with my test set up)</p>



<a name="134407659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407659" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407659">(Sep 21 2018 at 21:59)</a>:</h4>
<p>and in particular the reason that we are making a temporary is not visible</p>



<a name="134407749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407749" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407749">(Sep 21 2018 at 22:00)</a>:</h4>
<p>okay. Its late and I have to go, but this provides interesting food for thought</p>



<a name="134407769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407769" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407769">(Sep 21 2018 at 22:00)</a>:</h4>
<p>I'll try to explore whether I can encode a bit more information here</p>



<a name="134407780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407780" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407780">(Sep 21 2018 at 22:01)</a>:</h4>
<p>but I don't know if I agree that the diagnostic as written is "misleading" per se</p>



<a name="134407795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407795" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407795">(Sep 21 2018 at 22:01)</a>:</h4>
<p>I.e. its not claiming to say <em>why</em> the temporary is made ...</p>



<a name="134407827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407827" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407827">(Sep 21 2018 at 22:01)</a>:</h4>
<p>For me, not knowing why that error is happening, reading that error doesn't make it much clearer.</p>



<a name="134407829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407829" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407829">(Sep 21 2018 at 22:01)</a>:</h4>
<p>I don't disagree</p>



<a name="134407831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407831" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407831">(Sep 21 2018 at 22:01)</a>:</h4>
<p><em>but</em></p>



<a name="134407833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407833" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407833">(Sep 21 2018 at 22:02)</a>:</h4>
<p>its just saying "a temporary was made. Here's the expression that produced "it" -- though as you point out, it would be more acccurrte to say that's the expression  used to initialize it, I guess...</p>



<a name="134407876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407876" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407876">(Sep 21 2018 at 22:02)</a>:</h4>
<p>it took me a while to understand it</p>



<a name="134407896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407896" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407896">(Sep 21 2018 at 22:02)</a>:</h4>
<p>I kept thinking "but <code>&amp;_thing1</code> shouldn't make a temporary..."</p>



<a name="134407910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407910" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407910">(Sep 21 2018 at 22:02)</a>:</h4>
<p>I didn't highlight <code>&amp;_thing1</code> alone</p>



<a name="134407915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407915" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407915">(Sep 21 2018 at 22:02)</a>:</h4>
<p>yes, and that also confused me</p>



<a name="134407921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407921" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407921">(Sep 21 2018 at 22:02)</a>:</h4>
<p>until I realized what was going on :)</p>



<a name="134407939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407939" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407939">(Sep 21 2018 at 22:03)</a>:</h4>
<p>It would perhaps be nice to provide the highlight of the bigger expression sooner</p>



<a name="134407942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407942" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407942">(Sep 21 2018 at 22:03)</a>:</h4>
<p>perhaps via multispan magic?</p>



<a name="134407951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407951" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407951">(Sep 21 2018 at 22:03)</a>:</h4>
<p>not really sure if that API is right thing to use here...</p>



<a name="134407958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407958" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407958">(Sep 21 2018 at 22:04)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> part of the problem is that there is a confluence of <em>many</em> factors here</p>



<a name="134407976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134407976" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134407976">(Sep 21 2018 at 22:04)</a>:</h4>
<div class="codehilite"><pre><span></span>error[E0597]: `_thing1` does not live long enough
  --&gt; ../../issue-21114-demo-borrow-of-temp.rs:7:11
   |
7  |         D(&amp;_thing1).end()
   |           ^^^^^^^^ borrowed value does not live long enough
8  |     }
   |     - `_thing1` dropped here while still borrowed
9  |
10 |     ;
   |     - borrow later used here, when temporary is dropped
   |
note: temporary is formed because this is an `&amp;self` method
  --&gt; ../../issue-21114-demo-borrow-of-temp.rs:7:9
   |
7  |         D(&amp;_thing1).end()
   |                     ^^^
   = note: temporary is part of a block-tail expression. Consider adding semicolon to drop its temporaries sooner
</pre></div>



<a name="134408003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408003" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408003">(Sep 21 2018 at 22:04)</a>:</h4>
<p>I think that's better, but not quite there</p>



<a name="134408014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408014" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408014">(Sep 21 2018 at 22:04)</a>:</h4>
<p>wait, surely you would want us to still highlight the whole expression ... ?</p>



<a name="134408021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408021" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408021">(Sep 21 2018 at 22:04)</a>:</h4>
<p>I thought identifying it as <code>D(&amp;_thing1)</code> was important</p>



<a name="134408023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408023" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408023">(Sep 21 2018 at 22:04)</a>:</h4>
<p>I'd prefer not, but maybe we would in practice</p>



<a name="134408029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408029" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408029">(Sep 21 2018 at 22:05)</a>:</h4>
<p>hmm</p>



<a name="134408039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408039" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408039">(Sep 21 2018 at 22:05)</a>:</h4>
<p>I guess I don't know</p>



<a name="134408046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408046" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408046">(Sep 21 2018 at 22:05)</a>:</h4>
<p>maybe in the common case the expression would be unwieldy and just noise...</p>



<a name="134408054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408054" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408054">(Sep 21 2018 at 22:05)</a>:</h4>
<p>my micro-test may be misleading me as to the utility of the message</p>



<a name="134408106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408106" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408106">(Sep 21 2018 at 22:06)</a>:</h4>
<p>but part of the reason why I think its important to highlight the expression</p>



<a name="134408110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408110" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408110">(Sep 21 2018 at 22:06)</a>:</h4>
<p>is the fact that it implements <code>Drop</code></p>



<a name="134408125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408125" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408125">(Sep 21 2018 at 22:06)</a>:</h4>
<p>obviously we could alternatively highlight the <code>impl Drop for D</code></p>



<a name="134408142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408142" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408142">(Sep 21 2018 at 22:07)</a>:</h4>
<p>hmm</p>



<a name="134408143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408143" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408143">(Sep 21 2018 at 22:07)</a>:</h4>
<p>i may not have the full picture of the example in question</p>



<a name="134408150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408150" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408150">(Sep 21 2018 at 22:07)</a>:</h4>
<p>i definitely recommend playing with it in the playpen</p>



<a name="134408152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408152" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408152">(Sep 21 2018 at 22:07)</a>:</h4>
<p>every piece is necessary...</p>



<a name="134408163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408163" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408163">(Sep 21 2018 at 22:08)</a>:</h4>
<p>I guess I am thinking a bit more generally</p>



<a name="134408205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408205" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408205">(Sep 21 2018 at 22:08)</a>:</h4>
<p>I think in general our temporary rules are a big source of confusion</p>



<a name="134408215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408215" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408215">(Sep 21 2018 at 22:08)</a>:</h4>
<p>and I think it is not helpful that the reason there is a temporary is often "hidden"</p>



<a name="134408222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408222" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408222">(Sep 21 2018 at 22:08)</a>:</h4>
<p>(though even <code>&amp;foo()</code> is probably not obvious to most folks)</p>



<a name="134408489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408489" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408489">(Sep 21 2018 at 22:14)</a>:</h4>
<p>The example, to my untrained eye, would be confused by more diagnostics - I read it and think "oh, we're creating a <code>D</code> that has a borrow in it, and we're returning that but the borrow won't live long enough".  It feels like something similar to:</p>
<div class="codehilite"><pre><span></span><span class="k">struct</span> <span class="nc">Q</span><span class="o">&lt;</span><span class="na">&#39;a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">x</span><span class="p">(</span><span class="n">_y</span>: <span class="kp">&amp;</span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Q</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">Q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>At least with this example, I don't understand why the error is confusing, because I'd need to understand what is happening at a much deeper level than I do to realise the error isn't right? I think that's what I think?</p>



<a name="134408514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408514" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408514">(Sep 21 2018 at 22:15)</a>:</h4>
<p>well, maybe the answer is I should try out my branch on some of the examples from <a href="https://github.com/rust-lang/rust/issues/21114" target="_blank" title="https://github.com/rust-lang/rust/issues/21114">#21114</a></p>



<a name="134408522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408522" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408522">(Sep 21 2018 at 22:15)</a>:</h4>
<p>because there <em>are</em> plenty of cases of tail-exprs where our users <del>get mad about having</del> don't understand why they have to add <code>;</code></p>



<a name="134408579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408579" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408579">(Sep 21 2018 at 22:16)</a>:</h4>
<p>e.g. note that in the code I wrote, the block isn't returning a <code>D</code>. Its returning <code>()</code>.</p>



<a name="134408586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408586" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408586">(Sep 21 2018 at 22:16)</a>:</h4>
<p>and so people say "why is the borrow lasting so long?"</p>



<a name="134408606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408606" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408606">(Sep 21 2018 at 22:17)</a>:</h4>
<p>and the answer is "because the <code>D</code> you created gets killed after locals in the block are dropped." But then you get into "well why is <strong>that</strong> happening?"</p>



<a name="134408613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408613" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408613">(Sep 21 2018 at 22:17)</a>:</h4>
<p>and the answer then is "our r-value lifetime rules"</p>



<a name="134408850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134408850" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134408850">(Sep 21 2018 at 22:22)</a>:</h4>
<p>Perhaps a good way to explain that is to "expand" the confusing part, have a little note at the bottom with a code snippet that splits the confusing statement into multiple statements that approximates how the compiler understands the code and is more obviously wrong to someone who has an intuition for the borrow rules? Not sure if that would work, just a thought.</p>



<a name="134409229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134409229" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134409229">(Sep 21 2018 at 22:31)</a>:</h4>
<p>by the way, one of the few tests that this change <em>did</em> affect was <a href="https://github.com/rust-lang/rust/commits/0957ede5027c0bffe208904998675a17bfd4cd59/src/test/ui/issue-47646.stderr" target="_blank" title="https://github.com/rust-lang/rust/commits/0957ede5027c0bffe208904998675a17bfd4cd59/src/test/ui/issue-47646.stderr">issue-47646.stderr</a></p>



<a name="134409291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134409291" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134409291">(Sep 21 2018 at 22:32)</a>:</h4>
<p>I linked to that commit, <a href="https://github.com/rust-lang/rust/commit/0957ede5027c0bffe208904998675a17bfd4cd59" target="_blank" title="https://github.com/rust-lang/rust/commit/0957ede5027c0bffe208904998675a17bfd4cd59">0957ede5027c0bffe208904998675a17bfd4cd59</a> , in particular, because it looks to me like that PR might have regressed the diagnostics that <span class="user-mention" data-user-id="116009">@nikomatsakis</span> carefully plotted out for <a href="https://github.com/rust-lang/rust/issues/47646" target="_blank" title="https://github.com/rust-lang/rust/issues/47646">#47646</a> ?</p>



<a name="134409297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134409297" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134409297">(Sep 21 2018 at 22:32)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> ^</p>



<a name="134409306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134409306" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134409306">(Sep 21 2018 at 22:33)</a>:</h4>
<p>(I'll leave a note on PR <a href="https://github.com/rust-lang/rust/issues/51889" target="_blank" title="https://github.com/rust-lang/rust/issues/51889">#51889</a> about this)</p>



<a name="134409461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134409461" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134409461">(Sep 21 2018 at 22:36)</a>:</h4>
<p>its not hard to "fix"; or at least, a fix will be a natural consequence of the branch I'm playing with for <a href="https://github.com/rust-lang/rust/issues/21114" target="_blank" title="https://github.com/rust-lang/rust/issues/21114">#21114</a>. But I'm just curious about whether this was deliberate or accidental.</p>



<a name="134410513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134410513" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134410513">(Sep 21 2018 at 23:01)</a>:</h4>
<p>I ended up pushing the current state to a branch. I'm a little shocked at how few of our tests needed to be updated: <a href="https://github.com/pnkfelix/rust/commits/issue-21114-semi-on-tail-diagnostic" target="_blank" title="https://github.com/pnkfelix/rust/commits/issue-21114-semi-on-tail-diagnostic">https://github.com/pnkfelix/rust/commits/issue-21114-semi-on-tail-diagnostic</a></p>



<a name="134410562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134410562" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134410562">(Sep 21 2018 at 23:02)</a>:</h4>
<p>(the test updates are on <a href="https://github.com/pnkfelix/rust/commit/98cd11d8f8a78c3bb7e916d2b299eeeade7c6392" target="_blank" title="https://github.com/pnkfelix/rust/commit/98cd11d8f8a78c3bb7e916d2b299eeeade7c6392">this commit</a> in particular)</p>



<a name="134410652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134410652" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134410652">(Sep 21 2018 at 23:04)</a>:</h4>
<p>Also, this <a href="https://github.com/pnkfelix/rust/blob/98cd11d8f8a78c3bb7e916d2b299eeeade7c6392/src/test/ui/span/issue-23338-locals-die-before-temps-of-body.nll.stderr" target="_blank" title="https://github.com/pnkfelix/rust/blob/98cd11d8f8a78c3bb7e916d2b299eeeade7c6392/src/test/ui/span/issue-23338-locals-die-before-temps-of-body.nll.stderr">test</a> shows a clear case where the blind suggestion to add a semicolon is bogus</p>



<a name="134410670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134410670" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134410670">(Sep 21 2018 at 23:04)</a>:</h4>
<p>(as I alluded to in the commit message of the <a href="https://github.com/pnkfelix/rust/commit/053de3952a08036e4db3bac5213418cdf3183366" target="_blank" title="https://github.com/pnkfelix/rust/commit/053de3952a08036e4db3bac5213418cdf3183366">parent commit</a> to that one linked above)</p>



<a name="134410759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134410759" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134410759">(Sep 21 2018 at 23:06)</a>:</h4>
<p>I may change it to only suggest adding the semi-colon if the tail expression has type <code>()</code>. Not sure yet.</p>



<a name="134410811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134410811" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134410811">(Sep 21 2018 at 23:07)</a>:</h4>
<p>(because then that won't catch the case where the context surrounding the block-expression in question  is itself supplying the <code>;</code> that causes the returned value to be discarded... but maybe that's okay, as long as we highlight <em>that</em> semicolon when we presumably say "temporary is dropped here")</p>



<a name="134420209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134420209" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134420209">(Sep 22 2018 at 03:45)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> cool that you bring this up</p>



<a name="134420213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134420213" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134420213">(Sep 22 2018 at 03:45)</a>:</h4>
<p>to be honest I do not remember why we changed that</p>



<a name="134420214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134420214" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134420214">(Sep 22 2018 at 03:45)</a>:</h4>
<p>/cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="134532224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2321114%20non-intuitive%20rvalue%20lifetimes/near/134532224" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2321114.20non-intuitive.20rvalue.20lifetimes.html#134532224">(Sep 24 2018 at 15:11)</a>:</h4>
<blockquote>
<p>its not hard to "fix"; or at least, a fix will be a natural consequence of the branch I'm playing with for <a href="https://github.com/rust-lang/rust/issues/21114" target="_blank" title="https://github.com/rust-lang/rust/issues/21114">#21114</a>. But I'm just curious about whether this was deliberate or accidental.</p>
</blockquote>
<p>it wasn't <em>deliberate</em>, I don't think.</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>