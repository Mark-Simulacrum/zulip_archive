<html>
<head><meta charset="utf-8"><title>#53643 optimize UCD · t-compiler/wg-nll · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/index.html">t-compiler/wg-nll</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html">#53643 optimize UCD</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="132855067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/132855067" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#132855067">(Aug 27 2018 at 12:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116925">@mikhail-m1</span> hi =)</p>



<a name="132855096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/132855096" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#132855096">(Aug 27 2018 at 12:53)</a>:</h4>
<p>This was my <a href="https://gist.github.com/e61b50399ca3a7606dd40de8befafb59" target="_blank" title="https://gist.github.com/e61b50399ca3a7606dd40de8befafb59">minimized test case</a> that I used to make compiles complete in a reasonable amount of time</p>



<a name="132855103"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/132855103" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#132855103">(Aug 27 2018 at 12:53)</a>:</h4>
<p>in particular <a href="https://gist.github.com/nikomatsakis/e61b50399ca3a7606dd40de8befafb59#file-ucd-rs-L6" target="_blank" title="https://gist.github.com/nikomatsakis/e61b50399ca3a7606dd40de8befafb59#file-ucd-rs-L6">this constant</a> is the one we are interested in</p>



<a name="132855120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/132855120" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#132855120">(Aug 27 2018 at 12:53)</a>:</h4>
<p>the temporaries result from expressions like this</p>
<div class="codehilite"><pre><span></span><span class="w"> </span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">65</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">97</span><span class="p">)]),</span><span class="w"> </span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">66</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">98</span><span class="p">)]),</span><span class="w"> </span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">67</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">99</span><span class="p">)]),</span><span class="w"></span>
</pre></div>



<a name="132855165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/132855165" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#132855165">(Aug 27 2018 at 12:54)</a>:</h4>
<p>something like <code>&amp;[(0, 0, 97)]</code> winds up generating MIR like:</p>



<a name="132855170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/132855170" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#132855170">(Aug 27 2018 at 12:54)</a>:</h4>
<div class="codehilite"><pre><span></span>TMP0 = (0, 0, 97)
TMP1 = [move TMP0]
TMP2 = &amp;TMP1 // &lt;-- these is the borrows that are killing us
</pre></div>



<a name="132855187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/132855187" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#132855187">(Aug 27 2018 at 12:55)</a>:</h4>
<p>example:</p>
<div class="codehilite"><pre><span></span>        _157 = (const 0u8, const 0u8, const 118u8); // bb0[305]: scope 0 at ucd.rs:14:16: 14:25
                                         // ty::Const
                                         // + ty: u8
                                         // + val: Scalar(Bits { size: 1, bits: 0 })
                                         // mir::Constant
                                         // + span: ucd.rs:14:17: 14:18
                                         // + ty: u8
                                         // + literal: Const { ty: u8, val: Scalar(Bits { size: 1, bits: 0 }) }
                                         // ty::Const
                                         // + ty: u8
                                         // + val: Scalar(Bits { size: 1, bits: 0 })
                                         // mir::Constant
                                         // + span: ucd.rs:14:19: 14:20
                                         // + ty: u8
                                         // + literal: Const { ty: u8, val: Scalar(Bits { size: 1, bits: 0 }) }
                                         // ty::Const
                                         // + ty: u8
                                         // + val: Scalar(Bits { size: 1, bits: 118 })
                                         // mir::Constant
                                         // + span: ucd.rs:14:21: 14:24
                                         // + ty: u8
                                         // + literal: Const { ty: u8, val: Scalar(Bits { size: 1, bits: 118 }) }
        _156 = [move _157];              // bb0[306]: scope 0 at ucd.rs:14:15: 14:26
        _155 = &amp;_156;                    // bb0[307]: scope 0 at ucd.rs:14:14: 14:26
</pre></div>



<a name="133012392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133012392" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133012392">(Aug 29 2018 at 18:08)</a>:</h4>
<p>hey <span class="user-mention" data-user-id="116009">@nikomatsakis</span>  , I'd like to discuss some issues with create immutable temporary variables, unfortunately immutable temporary vars are not expected now, i commented <a href="http://here%20https://github.com/rust-lang/rust/blob/e6b35b0e1115f008796e8313574e4a4739b6d39d/src/librustc/mir/mod.rs#L226" target="_blank" title="http://here%20https://github.com/rust-lang/rust/blob/e6b35b0e1115f008796e8313574e4a4739b6d39d/src/librustc/mir/mod.rs#L226">assert about it</a> and now mir borrowck  panics for </p>
<div class="codehilite"><pre><span></span>fn main() {
    match &amp;mut &amp;Some(5i32) {
        Some(n) =&gt; {
            *n += 1; //~ ERROR cannot assign to immutable
            let _ = n;
        }
        None =&gt; {},
    };
}
</pre></div>


<p>because don't know how to output error for temp var, there is another panic during compiling stdlib, but may be i create immutable temps to often :), I've made just POC implementation for the first step.</p>



<a name="133012723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133012723" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133012723">(Aug 29 2018 at 18:15)</a>:</h4>
<p>you mean you commented out <a href="https://github.com/rust-lang/rust/blob/e6b35b0e1115f008796e8313574e4a4739b6d39d/src/librustc/mir/mod.rs#L226" target="_blank" title="https://github.com/rust-lang/rust/blob/e6b35b0e1115f008796e8313574e4a4739b6d39d/src/librustc/mir/mod.rs#L226">this assert</a>?</p>



<a name="133012735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133012735" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133012735">(Aug 29 2018 at 18:15)</a>:</h4>
<blockquote>
<p>because don't know how to output error for temp var</p>
</blockquote>
<p>hmm, interesting, can you say more about the error? did you push your branch anywhere?</p>



<a name="133012780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133012780" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133012780">(Aug 29 2018 at 18:16)</a>:</h4>
<p>I guess that it is some bit of code trying to suggest "maybe you should make this a <code>mut</code> variable" ?</p>



<a name="133012783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133012783" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133012783">(Aug 29 2018 at 18:16)</a>:</h4>
<p>in that case, we would presumably just disable the suggestion for now...</p>



<a name="133012796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133012796" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133012796">(Aug 29 2018 at 18:16)</a>:</h4>
<p>the libstd thing is a bit more concerning :)</p>



<a name="133012916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133012916" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133012916">(Aug 29 2018 at 18:19)</a>:</h4>
<blockquote>
<p>you mean you commented out <a href="https://github.com/rust-lang/rust/blob/e6b35b0e1115f008796e8313574e4a4739b6d39d/src/librustc/mir/mod.rs#L226" target="_blank" title="https://github.com/rust-lang/rust/blob/e6b35b0e1115f008796e8313574e4a4739b6d39d/src/librustc/mir/mod.rs#L226">this assert</a>?</p>
</blockquote>
<p>yes,</p>
<p>I will prevent a panic and check and collect more info..</p>



<a name="133013427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133013427" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133013427">(Aug 29 2018 at 18:29)</a>:</h4>
<p>now three errors are emitted vs one: </p>
<div class="codehilite"><pre><span></span>error[E0594]: cannot assign to immutable borrowed content `*n` (Ast)
 --&gt; test/x.rs:4:13
  |
4 |             *n += 1; //~ ERROR cannot assign to immutable
  |             ^^^^^^^ cannot borrow as mutable

error[E0596]: cannot borrow `temp` as mutable, as it is not declared as mutable (Mir)
 --&gt; test/x.rs:2:11
  |
2 |     match &amp;mut &amp;Some(5i32) {
  |           ^^^^^^^^^^^^^^^^
  |           |
  |           cannot borrow as mutable
  |           try removing `&amp;mut` here

error[E0594]: cannot assign to `*n` which is behind a `&amp;` reference (Mir)
 --&gt; test/x.rs:4:13
  |
4 |             *n += 1; //~ ERROR cannot assign to immutable
  |             ^^^^^^^ `n` is a `&amp;` reference, so the data it refers to cannot be written
</pre></div>


<p><code>temp</code> is a stub name, compiling libstd</p>



<a name="133013490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133013490" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133013490">(Aug 29 2018 at 18:30)</a>:</h4>
<blockquote>
<p>cannot borrow <code>temp</code> as mutable, as it is not declared as mutable</p>
</blockquote>



<a name="133013491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133013491" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133013491">(Aug 29 2018 at 18:30)</a>:</h4>
<p>that seems curious</p>



<a name="133013498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133013498" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133013498">(Aug 29 2018 at 18:30)</a>:</h4>
<p>can I see your diff?</p>



<a name="133013501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133013501" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133013501">(Aug 29 2018 at 18:30)</a>:</h4>
<p>(e.g., can you push commits somewhere?)</p>



<a name="133013592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133013592" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133013592">(Aug 29 2018 at 18:32)</a>:</h4>
<p>creating it</p>



<a name="133013902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133013902" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133013902">(Aug 29 2018 at 18:39)</a>:</h4>
<p><a href="https://github.com/mikhail-m1/rust/commit/d1109b8c75e65aed079dba7128ff8723597342c9" target="_blank" title="https://github.com/mikhail-m1/rust/commit/d1109b8c75e65aed079dba7128ff8723597342c9">https://github.com/mikhail-m1/rust/commit/d1109b8c75e65aed079dba7128ff8723597342c9</a> I didn't change <code>as_rval</code>, just checking by trace</p>



<a name="133014183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133014183" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133014183">(Aug 29 2018 at 18:44)</a>:</h4>
<p>MIR</p>
<div class="codehilite"><pre><span></span>    let mut _2: &amp;&#39;5s mut &amp;&#39;22s std::option::Option&lt;i32&gt;;
    let _3: &amp;&#39;22s std::option::Option&lt;i32&gt;;
    let mut _4: std::option::Option&lt;i32&gt;;
        _4 = std::option::Option&lt;i32&gt;::Some(const 5i32,); // bb0[4]: scope 0 at test/x.rs:2:17: 2:27
        _3 = &amp;&#39;22s _4;                   // bb0[6]: scope 0 at test/x.rs:2:16: 2:27
        _2 = &amp;&#39;5s mut _3;                // bb0[8]: scope 0 at test/x.rs:2:11: 2:27
 ```
</pre></div>



<a name="133014224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133014224" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133014224">(Aug 29 2018 at 18:45)</a>:</h4>
<p>see <a href="https://github.com/mikhail-m1/rust/commit/d1109b8c75e65aed079dba7128ff8723597342c9#r30333329" target="_blank" title="https://github.com/mikhail-m1/rust/commit/d1109b8c75e65aed079dba7128ff8723597342c9#r30333329">this comment</a>, more in a sec</p>



<a name="133014676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133014676" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133014676">(Aug 29 2018 at 18:52)</a>:</h4>
<blockquote>
<p>see <a href="https://github.com/mikhail-m1/rust/commit/d1109b8c75e65aed079dba7128ff8723597342c9#r30333329" target="_blank" title="https://github.com/mikhail-m1/rust/commit/d1109b8c75e65aed079dba7128ff8723597342c9#r30333329">this comment</a>, more in a sec</p>
</blockquote>
<p>yes, right now i just check that as_place that create temp is called from as_rvalue Borrow, I think result will be the same for this sample, of cause it's wrong in general</p>



<a name="133014817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133014817" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133014817">(Aug 29 2018 at 18:55)</a>:</h4>
<p>the result is not the same</p>



<a name="133014818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133014818" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133014818">(Aug 29 2018 at 18:55)</a>:</h4>
<p>in particular</p>



<a name="133014821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133014821" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133014821">(Aug 29 2018 at 18:55)</a>:</h4>
<p>well, let me double check :)</p>



<a name="133014829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133014829" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133014829">(Aug 29 2018 at 18:55)</a>:</h4>
<p>right, I think it will not be the same</p>



<a name="133014831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133014831" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133014831">(Aug 29 2018 at 18:55)</a>:</h4>
<p>if you have <code>EXPR1</code> defined as <code>&amp;EXPR2</code></p>



<a name="133014877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133014877" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133014877">(Aug 29 2018 at 18:56)</a>:</h4>
<p>what we want to do is to create an (immutable) temporary to store <code>EXPR2</code></p>



<a name="133014883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133014883" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133014883">(Aug 29 2018 at 18:56)</a>:</h4>
<p>but we are creating, iiuc, an immutable temporary to store <code>EXPR1</code></p>



<a name="133014963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133014963" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133014963">(Aug 29 2018 at 18:57)</a>:</h4>
<p>make sense?</p>



<a name="133015027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015027" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015027">(Aug 29 2018 at 18:58)</a>:</h4>
<p>this would, I believe, give rise to those spurious errors you are reporting... e.g., if we have <code>&amp;mut &amp;Some(5i32)</code>, then we will create an immutable temp storing <code>&amp;Some(5i32)</code>, which can't be borrowed mutably</p>



<a name="133015032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015032" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015032">(Aug 29 2018 at 18:58)</a>:</h4>
<p>but in my version, the temp that stores <code>&amp;Some(5i32)</code> would be mutable</p>



<a name="133015044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015044" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015044">(Aug 29 2018 at 18:59)</a>:</h4>
<p>(but the temp storing <code>Some(5i32)</code> would not)</p>



<a name="133015063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015063" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015063">(Aug 29 2018 at 18:59)</a>:</h4>
<p>can you change the MIR sample?</p>



<a name="133015073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015073" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015073">(Aug 29 2018 at 18:59)</a>:</h4>
<p>yep</p>



<a name="133015143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015143" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015143">(Aug 29 2018 at 19:00)</a>:</h4>
<div class="codehilite"><pre><span></span> let mut _2: &amp;&#39;5s mut &amp;&#39;22s std::option::Option&lt;i32&gt;;
    let mut _3: &amp;&#39;22s std::option::Option&lt;i32&gt;; // &lt;-- changed to be mut
    let _4: std::option::Option&lt;i32&gt;; // &lt;-- changed to be immut
        _4 = std::option::Option&lt;i32&gt;::Some(const 5i32,); // bb0[4]: scope 0 at test/x.rs:2:17: 2:27
        _3 = &amp;&#39;22s _4;                   // bb0[6]: scope 0 at test/x.rs:2:16: 2:27
        _2 = &amp;&#39;5s mut _3;                // bb0[8]: scope 0 at test/x.rs:2:11: 2:27
 ```
</pre></div>



<a name="133015149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015149" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015149">(Aug 29 2018 at 19:00)</a>:</h4>
<p>note the <code>// &lt;--</code> comments</p>



<a name="133015156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015156" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015156">(Aug 29 2018 at 19:00)</a>:</h4>
<p>thanks</p>



<a name="133015205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015205" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015205">(Aug 29 2018 at 19:02)</a>:</h4>
<p>i will try to do this</p>



<a name="133015248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015248" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015248">(Aug 29 2018 at 19:02)</a>:</h4>
<p>I think we may have to extend <code>as_place</code></p>



<a name="133015253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015253" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015253">(Aug 29 2018 at 19:02)</a>:</h4>
<p>or add an optional variant</p>



<a name="133015256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015256" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015256">(Aug 29 2018 at 19:02)</a>:</h4>
<p>that includes the mutability of temporary needed</p>



<a name="133015281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133015281" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133015281">(Aug 29 2018 at 19:02)</a>:</h4>
<p>though we can hack it in another way perhaps</p>



<a name="133024434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133024434" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133024434">(Aug 29 2018 at 21:56)</a>:</h4>
<p>hmm I did not realize that <span class="user-mention" data-user-id="116925">@mikhail-m1</span> was still working on this</p>



<a name="133226498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133226498" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133226498">(Sep 02 2018 at 19:53)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>  I created a review,  no it's 18s vs 68s on nightly. <a href="https://github.com/rust-lang/rust/pull/53909" target="_blank" title="https://github.com/rust-lang/rust/pull/53909">https://github.com/rust-lang/rust/pull/53909</a></p>



<a name="133323979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133323979" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133323979">(Sep 04 2018 at 17:24)</a>:</h4>
<p>nice! Let's do a perf run, I guess</p>



<a name="133323994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133323994" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133323994">(Sep 04 2018 at 17:25)</a>:</h4>
<p>maybe I'll do a local build too, I'm curious to profile that result</p>



<a name="133324409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133324409" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133324409">(Sep 04 2018 at 17:32)</a>:</h4>
<p>btw <a href="https://github.com/rust-lang/rust/pull/53942" target="_blank" title="https://github.com/rust-lang/rust/pull/53942">https://github.com/rust-lang/rust/pull/53942</a> results are -60% on ucd</p>



<a name="133328055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133328055" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133328055">(Sep 04 2018 at 18:34)</a>:</h4>
<p>Still ~400% afterwards, but better than the current &gt;100%.</p>



<a name="133329634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133329634" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133329634">(Sep 04 2018 at 19:00)</a>:</h4>
<p>yeah, I saw. nice!</p>



<a name="133336111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133336111" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133336111">(Sep 04 2018 at 20:56)</a>:</h4>
<p>the try build is ready for rust-timerification <a href="https://github.com/rust-lang/rust/pull/53909#issuecomment-418501219" target="_blank" title="https://github.com/rust-lang/rust/pull/53909#issuecomment-418501219">https://github.com/rust-lang/rust/pull/53909#issuecomment-418501219</a></p>



<a name="133376692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133376692" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133376692">(Sep 05 2018 at 13:49)</a>:</h4>
<p>hi <span class="user-mention" data-user-id="116009">@nikomatsakis</span>  , what should I do with this <a href="https://github.com/rust-lang/rust/pull/53909#discussion_r215004417" target="_blank" title="https://github.com/rust-lang/rust/pull/53909#discussion_r215004417">comment</a>?</p>



<a name="133376820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133376820" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133376820">(Sep 05 2018 at 13:51)</a>:</h4>
<p><span class="user-mention" data-user-id="116925">@mikhail-m1</span> I think we can easily tell if a local variable has any moves by using the <code>MoveData</code></p>



<a name="133376833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133376833" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133376833">(Sep 05 2018 at 13:51)</a>:</h4>
<p>which I suppose you are familiar-ish with :)</p>



<a name="133376887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133376887" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133376887">(Sep 05 2018 at 13:52)</a>:</h4>
<p>in particular if we iterate over all child-move-paths of the variable</p>



<a name="133376902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133376902" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133376902">(Sep 05 2018 at 13:52)</a>:</h4>
<p>ok, so if it has has any move we cannot ignore it, right?</p>



<a name="133376904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133376904" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133376904">(Sep 05 2018 at 13:52)</a>:</h4>
<p>and check whether the <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_mir/dataflow/move_paths/struct.MoveData.html#structfield.path_map" target="_blank" title="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_mir/dataflow/move_paths/struct.MoveData.html#structfield.path_map">path map</a> is empty</p>



<a name="133376906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133376906" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133376906">(Sep 05 2018 at 13:52)</a>:</h4>
<p>yeah</p>



<a name="133376921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133376921" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133376921">(Sep 05 2018 at 13:53)</a>:</h4>
<p>basically similar to the storage-dead thing</p>



<a name="133377005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133377005" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133377005">(Sep 05 2018 at 13:54)</a>:</h4>
<p>probably we want to rename the "has storage dead" actually</p>



<a name="133377017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133377017" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133377017">(Sep 05 2018 at 13:54)</a>:</h4>
<p>to "has storage dead or moves" or something like that</p>



<a name="133377143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133377143" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133377143">(Sep 05 2018 at 13:56)</a>:</h4>
<p>ok, and I'm going to make a change suggested by <span class="user-mention" data-user-id="116083">@pnkfelix</span>  <a href="https://github.com/rust-lang/rust/pull/53909#discussion_r214856869" target="_blank" title="https://github.com/rust-lang/rust/pull/53909#discussion_r214856869">https://github.com/rust-lang/rust/pull/53909#discussion_r214856869</a></p>



<a name="133377248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133377248" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133377248">(Sep 05 2018 at 13:58)</a>:</h4>
<p>sounds good</p>



<a name="133404874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404874" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404874">(Sep 05 2018 at 21:42)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>  just want to check I added move out next way</p>
<div class="codehilite"><pre><span></span>            for move_out in &amp;move_data.moves {
                if let Place::Local(index) = move_data.move_paths[move_out.path].place {
                    has_storage_dead_or_moved.insert(index);
                }
            }
</pre></div>


<p>but you mentioned <code>path_map</code></p>



<a name="133404887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404887" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404887">(Sep 05 2018 at 21:43)</a>:</h4>
<p>oh, that's .. smarter than what I suggested :)</p>



<a name="133404898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404898" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404898">(Sep 05 2018 at 21:43)</a>:</h4>
<p>well wait</p>



<a name="133404908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404908" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404908">(Sep 05 2018 at 21:43)</a>:</h4>
<p>it's a good overall approach but I think the <code>if let</code> is wrong</p>



<a name="133404914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404914" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404914">(Sep 05 2018 at 21:43)</a>:</h4>
<p>in particular, if you have a move from something like <code>a.b.c</code></p>



<a name="133404919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404919" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404919">(Sep 05 2018 at 21:43)</a>:</h4>
<p>we still want to disqualify <code>a</code></p>



<a name="133404973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404973" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404973">(Sep 05 2018 at 21:44)</a>:</h4>
<p>so we could do something like walk up the <code>MovePathIndex</code> parent links</p>



<a name="133404975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404975" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404975">(Sep 05 2018 at 21:44)</a>:</h4>
<p>until we find the root MPI</p>



<a name="133404977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404977" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404977">(Sep 05 2018 at 21:44)</a>:</h4>
<p>which will be a local</p>



<a name="133404978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404978" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404978">(Sep 05 2018 at 21:44)</a>:</h4>
<p>and/or we could do that on the place too</p>



<a name="133404980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404980" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404980">(Sep 05 2018 at 21:44)</a>:</h4>
<p>yes, i just want to check for loop and get path code</p>



<a name="133404981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133404981" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133404981">(Sep 05 2018 at 21:44)</a>:</h4>
<p>there is .. probably .. an existing method</p>



<a name="133461698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133461698" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133461698">(Sep 06 2018 at 18:52)</a>:</h4>
<p>I updated the PR yesterday</p>



<a name="133461800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133461800" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133461800">(Sep 06 2018 at 18:54)</a>:</h4>
<p>oh, nice</p>



<a name="133461895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133461895" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133461895">(Sep 06 2018 at 18:56)</a>:</h4>
<p>remember that whoever r+ will <a href="https://github.com/rust-lang/rust/pull/53942#issuecomment-418873477" target="_blank" title="https://github.com/rust-lang/rust/pull/53942#issuecomment-418873477">owe njn $5</a></p>



<a name="133461922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133461922" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133461922">(Sep 06 2018 at 18:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116925">@mikhail-m1</span> btw, in the older version, did all tests pass?</p>



<a name="133461925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133461925" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133461925">(Sep 06 2018 at 18:57)</a>:</h4>
<p>if so, maybe I need to make a test that would've failed...</p>



<a name="133461932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133461932" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133461932">(Sep 06 2018 at 18:57)</a>:</h4>
<p>(ah, I recall thinking that would be potentially hard to do actually due to the limitations on constants)</p>



<a name="133462313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133462313" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133462313">(Sep 06 2018 at 19:04)</a>:</h4>
<p><span class="user-mention" data-user-id="116925">@mikhail-m1</span> I left a few nits</p>



<a name="133471836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353643%20optimize%20UCD/near/133471836" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mikhail-m1 <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2353643.20optimize.20UCD.html#133471836">(Sep 06 2018 at 21:41)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>  updated once more and rustfmt <code>librustc_mir/build/expr</code></p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>