<html>
<head><meta charset="utf-8"><title>#52663-span-decl-captured-variables · t-compiler/wg-nll · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/index.html">t-compiler/wg-nll</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html">#52663-span-decl-captured-variables</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="131040156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131040156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131040156">(Aug 07 2018 at 12:09)</a>:</h4>
<p>Looking at <a href="https://github.com/rust-lang/rust/issues/52663#issuecomment-409027282" target="_blank" title="https://github.com/rust-lang/rust/issues/52663#issuecomment-409027282">this diagnostic improvement</a>. This is <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/move_errors.rs#L238-L266" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/move_errors.rs#L238-L266">the code that produces the error</a>. I figured that I'd look up the <code>upvar_decls</code> to find the upvar and then get the span. However, normally I'd use <code>place.is_upvar_field_projection(..)</code> or look for the upvar index manually but I can't quite work it out. <a href="https://gist.github.com/davidtwco/85974c050a966585600913ce4361e52f" target="_blank" title="https://gist.github.com/davidtwco/85974c050a966585600913ce4361e52f">Here's the gist</a> - I'd normally expect one of the regions to be external but I might be getting mixed up. Thoughts <span class="user-mention" data-user-id="116009">@nikomatsakis</span>?</p>



<a name="131040232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131040232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131040232">(Aug 07 2018 at 12:10)</a>:</h4>
<p>/me looks</p>



<a name="131040260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131040260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131040260">(Aug 07 2018 at 12:11)</a>:</h4>
<p>ok so let's look at this code...</p>



<a name="131040303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131040303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131040303">(Aug 07 2018 at 12:12)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/move_errors.rs#L241-L247" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/move_errors.rs#L241-L247">this part is just checking that we have <code>self.foo</code> for some field</a></p>



<a name="131040310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131040310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131040310">(Aug 07 2018 at 12:12)</a>:</h4>
<p>that .. seems a bit bogus to me, I think it should be using <code>is_upvar_field_projection</code>, as you said</p>



<a name="131043253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043253">(Aug 07 2018 at 13:11)</a>:</h4>
<p>Sorry, had to run for a moment there, back now.</p>



<a name="131043419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043419">(Aug 07 2018 at 13:14)</a>:</h4>
<p>What I was finding is that inside that match arm, <code>is_upvar_field_projection</code> was returning <code>None</code> and therefore I wasn't able to get the definition span for the upvar.</p>



<a name="131043424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043424">(Aug 07 2018 at 13:14)</a>:</h4>
<p>er sorry got distracted myself</p>



<a name="131043459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043459">(Aug 07 2018 at 13:14)</a>:</h4>
<p>hmm</p>



<a name="131043485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043485">(Aug 07 2018 at 13:15)</a>:</h4>
<p>Am I right in thinking that any upvars should have external regions in the MIR? This isn't related to how I want to tackle this issue, I just noticed that in the MIR, there wasn't a external region and that seemed strange.</p>



<a name="131043502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043502">(Aug 07 2018 at 13:15)</a>:</h4>
<p>not all upvars will have external regions</p>



<a name="131043522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043522">(Aug 07 2018 at 13:16)</a>:</h4>
<p>e.g., when capturing "by value"</p>



<a name="131043549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043549">(Aug 07 2018 at 13:16)</a>:</h4>
<p>Ah, I see.</p>



<a name="131043552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043552">(Aug 07 2018 at 13:16)</a>:</h4>
<p>That makes sense.</p>



<a name="131043555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043555">(Aug 07 2018 at 13:16)</a>:</h4>
<p>I'm confused why <code>is_upvar_field_projection</code> would not return true</p>



<a name="131043601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043601">(Aug 07 2018 at 13:17)</a>:</h4>
<p>I also found <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/mutability_errors.rs#L386-L409" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/mutability_errors.rs#L386-L409">this function</a> which seems to be equivalent to <code>is_upvar_field_projection(..).is_some()</code>?</p>



<a name="131043652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043652">(Aug 07 2018 at 13:18)</a>:</h4>
<p>yes</p>



<a name="131043660"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043660" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043660">(Aug 07 2018 at 13:18)</a>:</h4>
<p>seems like there is some refactoring need here</p>



<a name="131043661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043661">(Aug 07 2018 at 13:18)</a>:</h4>
<p>(Since I ended up digging around related code figuring out what it used when looking up <code>upvar_decls</code> given that <code>is_upvar_field_projection</code> was returning <code>None</code>)</p>



<a name="131043665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043665">(Aug 07 2018 at 13:18)</a>:</h4>
<p>it seems like it'd be useful to dump out the place etc</p>



<a name="131043669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043669">(Aug 07 2018 at 13:18)</a>:</h4>
<p>maybe we are confused about something</p>



<a name="131043681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043681">(Aug 07 2018 at 13:18)</a>:</h4>
<p>Give me a second, I've got a build with some logging here.</p>



<a name="131043684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043684">(Aug 07 2018 at 13:18)</a>:</h4>
<p>ok</p>



<a name="131043814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043814">(Aug 07 2018 at 13:20)</a>:</h4>
<p><a href="https://gist.github.com/davidtwco/3b7e8c0bf0b8fb3cbf13c09e924350af#file-gistfile1-txt-L4370-L4371" target="_blank" title="https://gist.github.com/davidtwco/3b7e8c0bf0b8fb3cbf13c09e924350af#file-gistfile1-txt-L4370-L4371">Here we go</a> - that's the arguments and some of the intermediate variables of the <code>report</code> function I initially linked.</p>



<a name="131043823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043823">(Aug 07 2018 at 13:20)</a>:</h4>
<p>In particular, the <code>(*_1)</code> is the place.</p>



<a name="131043826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043826">(Aug 07 2018 at 13:21)</a>:</h4>
<p>Which makes sense, given that <code>_1</code> is the captured <code>y</code> variable.</p>



<a name="131043839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043839">(Aug 07 2018 at 13:21)</a>:</h4>
<p>It's from <code>bb0[1]</code>.</p>



<a name="131043845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043845">(Aug 07 2018 at 13:21)</a>:</h4>
<p>huh</p>



<a name="131043850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043850">(Aug 07 2018 at 13:21)</a>:</h4>
<p>let me check that MIR you sent</p>



<a name="131043875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043875">(Aug 07 2018 at 13:22)</a>:</h4>
<p>I'm probably missing something silly, but it made sense to me looking at it that <code>is_upvar_field_projection</code> should be a <code>Some(..)</code> with <code>_1</code>.</p>



<a name="131043943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043943">(Aug 07 2018 at 13:22)</a>:</h4>
<p>well <code>is_upvar_field_projection</code> wants something like <code>(*_1).0</code></p>



<a name="131043945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043945">(Aug 07 2018 at 13:22)</a>:</h4>
<p>maybe we are feeding it just <code>*_1</code>?</p>



<a name="131043949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043949">(Aug 07 2018 at 13:22)</a>:</h4>
<p>Ah, that could be it.</p>



<a name="131043956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043956">(Aug 07 2018 at 13:22)</a>:</h4>
<p>in that case, there is no speific field</p>



<a name="131043960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043960">(Aug 07 2018 at 13:22)</a>:</h4>
<p>that is, the field index comes from the <code>.0</code> part</p>



<a name="131043965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043965">(Aug 07 2018 at 13:23)</a>:</h4>
<p>maybe we have to modify the move code to give more information?</p>



<a name="131043999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131043999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131043999">(Aug 07 2018 at 13:23)</a>:</h4>
<p>In this case there isn't a field I don't think.</p>



<a name="131044077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044077">(Aug 07 2018 at 13:24)</a>:</h4>
<p>well there must be a field</p>



<a name="131044085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044085">(Aug 07 2018 at 13:24)</a>:</h4>
<p>but it's not included in the information at hand</p>



<a name="131044106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044106">(Aug 07 2018 at 13:25)</a>:</h4>
<p>I'm looking a bit to see what would be the easiest way to fix that</p>



<a name="131044220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044220">(Aug 07 2018 at 13:27)</a>:</h4>
<p>Backtracking slightly, in this <code>is_upvar</code> function, on <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/mutability_errors.rs#L405" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/mutability_errors.rs#L405">this line</a> - there's an extra condition, that the upvar decl is <code>by_ref</code> - will that make it return differently from <code>is_upvar_field_projection(..).is_some()</code>?</p>



<a name="131044233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044233">(Aug 07 2018 at 13:27)</a>:</h4>
<p>I <em>think</em> that this is where the move errors are collected:</p>



<a name="131044234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044234">(Aug 07 2018 at 13:27)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/18925dee25ce649562d203e72068e3a57b60b153/src/librustc_mir/dataflow/move_paths/builder.rs#L409-L412" target="_blank" title="https://github.com/rust-lang/rust/blob/18925dee25ce649562d203e72068e3a57b60b153/src/librustc_mir/dataflow/move_paths/builder.rs#L409-L412">https://github.com/rust-lang/rust/blob/18925dee25ce649562d203e72068e3a57b60b153/src/librustc_mir/dataflow/move_paths/builder.rs#L409-L412</a></p>



<a name="131044291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044291">(Aug 07 2018 at 13:28)</a>:</h4>
<p>in particular, if we modified <code>errors</code> from <code>Vec&lt;MoveError&lt;'tcx&gt;&gt;</code> to <code>Vec&lt;(Place&lt;'tcx&gt;, MoveError&lt;'tcx&gt;)&gt;</code></p>



<a name="131044293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044293">(Aug 07 2018 at 13:28)</a>:</h4>
<p>then we can keep along the original path</p>



<a name="131044294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044294">(Aug 07 2018 at 13:28)</a>:</h4>
<p>which is what we are missing here</p>



<a name="131044304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044304">(Aug 07 2018 at 13:28)</a>:</h4>
<p>Sounds good.</p>



<a name="131044312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044312">(Aug 07 2018 at 13:28)</a>:</h4>
<p>what winds up happening is that we convert a <code>Place</code> like <code>(*_1).0</code> into a "move path"</p>



<a name="131044315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044315">(Aug 07 2018 at 13:28)</a>:</h4>
<p>this works recursively</p>



<a name="131044318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044318">(Aug 07 2018 at 13:29)</a>:</h4>
<p>so it will try to convert <code>*_1</code></p>



<a name="131044328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044328">(Aug 07 2018 at 13:29)</a>:</h4>
<p>when that fails, we don't have enough context anymore</p>



<a name="131044334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044334">(Aug 07 2018 at 13:29)</a>:</h4>
<p>but if we keep the top-level path, that would be good</p>



<a name="131044344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044344">(Aug 07 2018 at 13:29)</a>:</h4>
<p>of course, then we might wind up with something like <code>(*_1).0.1</code></p>



<a name="131044349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044349">(Aug 07 2018 at 13:29)</a>:</h4>
<p>but what we could do is to "peel off" projections from the original path</p>



<a name="131044355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044355">(Aug 07 2018 at 13:29)</a>:</h4>
<p>until we encounter something for which <code>is_upvar_field_projection</code> returns true</p>



<a name="131044407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044407">(Aug 07 2018 at 13:30)</a>:</h4>
<blockquote>
<p>Backtracking slightly, in this <code>is_upvar</code> function, on <a href="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/mutability_errors.rs#L405" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/librustc_mir/borrow_check/mutability_errors.rs#L405">this line</a> - there's an extra condition, that the upvar decl is <code>by_ref</code> - will that make it return differently from <code>is_upvar_field_projection(..).is_some()</code>?</p>
</blockquote>
<p>looking</p>



<a name="131044420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044420">(Aug 07 2018 at 13:30)</a>:</h4>
<p>I just spotted the <code>.0</code> part of <code>(*_1).0</code> in the MIR, I never read that properly before. <span class="emoji emoji-1f926" title="face palm">:face_palm:</span></p>



<a name="131044433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044433">(Aug 07 2018 at 13:30)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="116107">@davidtwco</span> that the two functions are "morally" equivalent</p>



<a name="131044438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044438">(Aug 07 2018 at 13:30)</a>:</h4>
<p>you are correct that <code>is_upvar</code> is a bit ... more careful</p>



<a name="131044443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044443">(Aug 07 2018 at 13:30)</a>:</h4>
<p>however</p>



<a name="131044458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044458">(Aug 07 2018 at 13:31)</a>:</h4>
<p>in practice we will never generate an access to a by-ref upvar</p>



<a name="131044466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044466">(Aug 07 2018 at 13:31)</a>:</h4>
<p>that does not have a deref</p>



<a name="131044468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044468">(Aug 07 2018 at 13:31)</a>:</h4>
<p>Just checking before refactoring slightly to use <code>is_upvar_field_projection</code> throughout.</p>



<a name="131044477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044477">(Aug 07 2018 at 13:31)</a>:</h4>
<p>but really being careful is good</p>



<a name="131044481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044481">(Aug 07 2018 at 13:31)</a>:</h4>
<p>e.g., if we have a not by-ref upvar</p>



<a name="131044485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044485">(Aug 07 2018 at 13:31)</a>:</h4>
<p>then the MIR might be just <code>(*_1).0</code></p>



<a name="131044493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044493">(Aug 07 2018 at 13:31)</a>:</h4>
<p>whereas for a by-ref upvar we would have <code>*(*_1).0</code></p>



<a name="131044499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044499">(Aug 07 2018 at 13:31)</a>:</h4>
<p>(e.g. if the upvar has type <code>i32</code> or something)</p>



<a name="131044552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044552">(Aug 07 2018 at 13:32)</a>:</h4>
<p>it might make sense to merge the two</p>



<a name="131044567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044567">(Aug 07 2018 at 13:32)</a>:</h4>
<p>Add in an assert to the main <code>is_upvar_field_projection</code> since it shouldn't ever happen?</p>



<a name="131044575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044575">(Aug 07 2018 at 13:32)</a>:</h4>
<p>that is, if you have some code like <code>move || *x</code> -- that will generate MIR like <code>*(*_1).0</code></p>



<a name="131044577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044577">(Aug 07 2018 at 13:32)</a>:</h4>
<p>no, I think it can happen</p>



<a name="131044594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044594">(Aug 07 2018 at 13:33)</a>:</h4>
<p><code>is_upvar_field_projection</code> will "incorrectly" categorize <code>*(*_1).0</code> as a field projection</p>



<a name="131044602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044602">(Aug 07 2018 at 13:33)</a>:</h4>
<p>I say "incorrectly" because it may never matter ..</p>



<a name="131044604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044604">(Aug 07 2018 at 13:33)</a>:</h4>
<p>but it could lead us to print <code>x</code> somewhere where we should print <code>*x</code> for example</p>



<a name="131044616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044616">(Aug 07 2018 at 13:33)</a>:</h4>
<p>I think what i'm saying is that we should maybe modify <code>is_upvar_field_projection</code> to be the same as the other one</p>



<a name="131044655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044655">(Aug 07 2018 at 13:34)</a>:</h4>
<p>but then merge everything to call just <code>is_upvar_field_projection</code></p>



<a name="131044702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044702">(Aug 07 2018 at 13:35)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>  sorry for cutting in, this is the "new" def of <code>is_upvar_field_projection</code> based on new <code>Place</code></p>
<div class="codehilite"><pre><span></span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">is_upvar_field_projection</span><span class="o">&lt;</span><span class="na">&#39;cx</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;gcx</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">mir</span>: <span class="kp">&amp;</span><span class="na">&#39;cx</span><span class="w"> </span><span class="n">Mir</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">tcx</span>: <span class="kp">&amp;</span><span class="nc">TyCtxt</span><span class="o">&lt;</span><span class="na">&#39;cx</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;gcx</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Field</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">projection</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">ProjectionElem</span>::<span class="n">Field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n">_ty</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">base_ty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ty</span><span class="p">(</span><span class="n">mir</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">tcx</span><span class="p">).</span><span class="n">to_ty</span><span class="p">(</span><span class="o">*</span><span class="n">tcx</span><span class="p">);</span><span class="w"></span>

<span class="w">                </span><span class="k">if</span><span class="w">  </span><span class="n">base_ty</span><span class="p">.</span><span class="n">is_closure</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">base_ty</span><span class="p">.</span><span class="n">is_generator</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="nb">Some</span><span class="p">(</span><span class="o">*</span><span class="n">field</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="nb">None</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">},</span><span class="w"></span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="131044725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044725">(Aug 07 2018 at 13:36)</a>:</h4>
<p>hmm what does <code>self.projection()</code> do?</p>



<a name="131044772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044772">(Aug 07 2018 at 13:36)</a>:</h4>
<p><code>place.elems.last()</code></p>



<a name="131044780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044780">(Aug 07 2018 at 13:36)</a>:</h4>
<p>Does this mean we're in a race to see who will need to deal with the merge conflict of this change?</p>



<a name="131044781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044781">(Aug 07 2018 at 13:36)</a>:</h4>
<p>ok, that doesn't seem quite right then</p>



<a name="131044793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044793">(Aug 07 2018 at 13:36)</a>:</h4>
<p>in particular, the current one includes some logic to skip derefs:</p>
<div class="codehilite"><pre><span></span><span class="w">       </span><span class="kd">let</span><span class="w"> </span><span class="n">place</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Place</span>::<span class="n">Projection</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">proj</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">ProjectionElem</span>::<span class="n">Deref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proj</span><span class="p">.</span><span class="n">elem</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">proj</span><span class="p">.</span><span class="n">base</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="bp">self</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="bp">self</span><span class="w"></span>
<span class="w">        </span><span class="p">};</span><span class="w"></span>
</pre></div>



<a name="131044796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044796">(Aug 07 2018 at 13:36)</a>:</h4>
<p>eddyb told me that in new <code>Place</code>, the projection lives in the last elems of the placeelem slice</p>



<a name="131044799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044799">(Aug 07 2018 at 13:37)</a>:</h4>
<p>as I was just saying to <span class="user-mention" data-user-id="116107">@davidtwco</span>, that logic is a bit aggressive</p>



<a name="131044824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044824">(Aug 07 2018 at 13:37)</a>:</h4>
<p>yes, so, I think that your version would work for e.g. a place like <code>(*_1).0</code></p>



<a name="131044832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044832">(Aug 07 2018 at 13:37)</a>:</h4>
<p>but not <code>*(*_1).0</code></p>



<a name="131044887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044887">(Aug 07 2018 at 13:38)</a>:</h4>
<p>I think it wants a kind of recursive call</p>



<a name="131044955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044955">(Aug 07 2018 at 13:39)</a>:</h4>
<p>well I'm not sure exactly how to write it but basically</p>



<a name="131044959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131044959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131044959">(Aug 07 2018 at 13:39)</a>:</h4>
<p>if the final projection is a <code>Deref</code></p>



<a name="131045017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045017">(Aug 07 2018 at 13:40)</a>:</h4>
<p>then we want to look at the penultimate projection and check if it is a field</p>



<a name="131045031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045031">(Aug 07 2018 at 13:40)</a>:</h4>
<p><span class="user-mention" data-user-id="116773">@csmoe</span> I forget, is it easy to make a <code>Place</code> for the "base" path?</p>



<a name="131045037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045037">(Aug 07 2018 at 13:40)</a>:</h4>
<p>in particular, we can "subslice" I guess, right?</p>



<a name="131045042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045042">(Aug 07 2018 at 13:40)</a>:</h4>
<p>i.e., we have some kind of (Base, &amp;[Projections]) representation?</p>



<a name="131045047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045047">(Aug 07 2018 at 13:40)</a>:</h4>
<p>that would be useful here :)</p>



<a name="131045062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045062">(Aug 07 2018 at 13:41)</a>:</h4>
<p>the tuple repr is easy to generate</p>



<a name="131045168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045168">(Aug 07 2018 at 13:43)</a>:</h4>
<p>MirBorrowckCtxt has a base_path method</p>



<a name="131045180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045180">(Aug 07 2018 at 13:43)</a>:</h4>
<p>ok; it doesn't matter if it's a tuple or not per se</p>



<a name="131045192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045192">(Aug 07 2018 at 13:44)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">impl</span><span class="o">&lt;</span><span class="na">&#39;cx</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;gcx</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MirBorrowckCtxt</span><span class="o">&lt;</span><span class="na">&#39;cx</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;gcx</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// FIXME (#16118): function intended to allow the borrow checker</span>
<span class="w">    </span><span class="c1">// to be less precise in its handling of Box while still allowing</span>
<span class="w">    </span><span class="c1">// moves out of a Box. They should be removed when/if we stop</span>
<span class="w">    </span><span class="c1">// treating Box specially (e.g. when/if DerefMove is added...)</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">base_path</span><span class="o">&lt;</span><span class="na">&#39;d</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">place</span>: <span class="kp">&amp;</span><span class="na">&#39;d</span><span class="w"> </span><span class="n">Place</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="na">&#39;d</span><span class="w"> </span><span class="n">Place</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="sd">//! Returns the base of the leftmost (deepest) dereference of an</span>
<span class="w">        </span><span class="sd">//! Box in `place`. If there is no dereference of an Box</span>
<span class="w">        </span><span class="sd">//! in `place`, then it just returns `place` itself.</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">cursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">place</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">deepest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">place</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">proj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="o">*</span><span class="n">cursor</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">Place</span>::<span class="n">Promo</span><span class="w"></span>
</pre></div>



<a name="131045254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045254">(Aug 07 2018 at 13:44)</a>:</h4>
<p>my main point was that if you have e.g. <code>(B, [P1, P2])</code> -- i.e., a base with two projections</p>



<a name="131045260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045260">(Aug 07 2018 at 13:44)</a>:</h4>
<p>we want to cheaply be able to make a Place like <code>(B, [P1])</code></p>



<a name="131045264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045264">(Aug 07 2018 at 13:45)</a>:</h4>
<p>or <code>(B, [])</code></p>



<a name="131045266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045266">(Aug 07 2018 at 13:45)</a>:</h4>
<p>i.e., the prefix paths</p>



<a name="131045275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045275">(Aug 07 2018 at 13:45)</a>:</h4>
<p>anyway, did you understand my concern about your "translation" of <code>is_upvar_field_projection</code>?</p>



<a name="131045433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045433">(Aug 07 2018 at 13:48)</a>:</h4>
<p>my <code>is_upvar_field_projection</code> just checks the "final" projection(<code>c</code>), it should cover like <code>b</code> in <code>base.[a, b, c]</code>?</p>



<a name="131045470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045470">(Aug 07 2018 at 13:49)</a>:</h4>
<p>yes, in particular when <code>c</code> is a deref</p>



<a name="131045486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045486">(Aug 07 2018 at 13:49)</a>:</h4>
<p>for Place: <code>B.[P1, P2]</code> produce: <code>B.[]</code>, <code>B.[P1,]</code>, <code>B.[P1, P2]</code>?</p>



<a name="131045527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045527">(Aug 07 2018 at 13:50)</a>:</h4>
<p>when we capture upvars, if we capture them "by reference", then something like <code>x</code> translates to (e.g.) <code>*self.x</code></p>



<a name="131045541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045541">(Aug 07 2018 at 13:50)</a>:</h4>
<blockquote>
<p>for Place: <code>B.[P1, P2]</code> produce: <code>B.[]</code>, <code>B.[P1,]</code>, <code>B.[P1, P2]</code>?</p>
</blockquote>
<p>well, that is just a generally useful thing to be able to do</p>



<a name="131045570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045570">(Aug 07 2018 at 13:51)</a>:</h4>
<p>in this case we want logic that's like, at a high-level</p>
<div class="codehilite"><pre><span></span>is_upvar_field_projection() {
    let mut place = self;
    if place is a deref projection {
        place = place.base_place();
    }

    if place is a field projection with index X {
        if place.base_place() has closure type {
            return Some(X)
       }
    }

    None
}
</pre></div>



<a name="131045573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045573">(Aug 07 2018 at 13:51)</a>:</h4>
<p>at least, that is the current fn</p>



<a name="131045577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045577">(Aug 07 2018 at 13:51)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> pointed out that there is another version that is a bit more careful around the deref</p>



<a name="131045629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045629">(Aug 07 2018 at 13:52)</a>:</h4>
<p>but it would look like</p>
<div class="codehilite"><pre><span></span>is_upvar_field_projection() {
    let mut place = self;
    let mut by_ref = false;

    if place is a deref projection {
        place = place.base_place();
        by_ref = true;
    }

    if place is a field projection with index X {
        if place.base_place() has closure type {
            if (upvar X is b reference) == by_ref {
                return Some(X)
             }
       }
    }

    None
}
</pre></div>



<a name="131045646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045646">(Aug 07 2018 at 13:52)</a>:</h4>
<p>in any case, if I understood your code, you were missing the "if place is a deref projection" part</p>



<a name="131045669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045669">(Aug 07 2018 at 13:53)</a>:</h4>
<blockquote>
<p>well, that is just a generally useful thing to be able to do</p>
</blockquote>
<p>so what about create a <code>shrink</code> method for <code>Place</code>?  </p>
<p>okay, that's clear. will fix it soon.</p>



<a name="131045683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131045683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csmoe <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131045683">(Aug 07 2018 at 13:53)</a>:</h4>
<p>then <code>base_place()</code> is <code>B.[]</code>?</p>



<a name="131046100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131046100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131046100">(Aug 07 2018 at 14:01)</a>:</h4>
<p><span class="user-mention" data-user-id="116773">@csmoe</span> I wonder if we should make a <code>split_projection</code> method that returns <code>Option&lt;(Place&lt;'tcx&gt;, &amp;PlaceProjection&lt;'tcx&gt;)&gt;</code></p>



<a name="131046110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131046110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131046110">(Aug 07 2018 at 14:01)</a>:</h4>
<p>analogous to <a href="https://doc.rust-lang.org/std/primitive.slice.html#method.split_last" target="_blank" title="https://doc.rust-lang.org/std/primitive.slice.html#method.split_last">https://doc.rust-lang.org/std/primitive.slice.html#method.split_last</a></p>



<a name="131046122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131046122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131046122">(Aug 07 2018 at 14:01)</a>:</h4>
<p>anyway, this probably belongs in a different topic :)</p>



<a name="131046124"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131046124" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131046124">(Aug 07 2018 at 14:01)</a>:</h4>
<p>at this point, anyway...</p>



<a name="131055401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131055401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131055401">(Aug 07 2018 at 16:49)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Submitted <a href="https://github.com/rust-lang/rust/issues/53164" target="_blank" title="https://github.com/rust-lang/rust/issues/53164">#53164</a>.</p>



<a name="131056878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131056878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131056878">(Aug 07 2018 at 17:18)</a>:</h4>
<p><span class="user-mention" data-user-id="116107">@davidtwco</span> <a href="https://github.com/rust-lang/rust/pull/53164#pullrequestreview-144098474" target="_blank" title="https://github.com/rust-lang/rust/pull/53164#pullrequestreview-144098474">can you easily test this?</a></p>



<a name="131056919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131056919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131056919">(Aug 07 2018 at 17:18)</a>:</h4>
<p>(is the test case I want clear?)</p>



<a name="131057041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057041">(Aug 07 2018 at 17:20)</a>:</h4>
<p>Yeah, it doesn't work for that.</p>



<a name="131057260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057260">(Aug 07 2018 at 17:24)</a>:</h4>
<p>Perhaps it is better to do something along the lines of <code>original_path.is_upvar_field_projection(self.mir, &amp;self.tcx).or_else(|| { place.is_upvar_field_projection(self.mir, &amp;self.tcx) })</code> rather than try modify <code>original_path</code>. Of course, the <code>place</code> that the function previously had wouldn't work as it only has <code>(*_1)</code> not <code>(*_1).0</code>.</p>



<a name="131057396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057396">(Aug 07 2018 at 17:26)</a>:</h4>
<p>well</p>



<a name="131057399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057399">(Aug 07 2018 at 17:26)</a>:</h4>
<p>what I had in mind was something like this:</p>



<a name="131057435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057435">(Aug 07 2018 at 17:27)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="n">place</span><span class="p">.</span><span class="n">prefixes</span><span class="p">().</span><span class="n">any</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="n">is_upvar_field_projection</span><span class="p">(</span><span class="n">p</span><span class="p">))</span><span class="w"></span>
</pre></div>



<a name="131057439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057439">(Aug 07 2018 at 17:27)</a>:</h4>
<p>though I don't know if the method <code>prefixes</code> exists :)</p>



<a name="131057443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057443">(Aug 07 2018 at 17:27)</a>:</h4>
<p>there is something more cumbersome:</p>



<a name="131057447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057447">(Aug 07 2018 at 17:27)</a>:</h4>
<p>Sadly, it does not.</p>



<a name="131057453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057453">(Aug 07 2018 at 17:27)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_mir/borrow_check/struct.MirBorrowckCtxt.html#method.prefixes" target="_blank" title="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_mir/borrow_check/struct.MirBorrowckCtxt.html#method.prefixes">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_mir/borrow_check/struct.MirBorrowckCtxt.html#method.prefixes</a></p>



<a name="131057457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057457">(Aug 07 2018 at 17:27)</a>:</h4>
<p>we could write <code>prefixes</code> of course :)</p>



<a name="131057462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057462">(Aug 07 2018 at 17:28)</a>:</h4>
<p>or just open code it...</p>



<a name="131057505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057505">(Aug 07 2018 at 17:28)</a>:</h4>
<p>So, it does exist?</p>



<a name="131057516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057516">(Aug 07 2018 at 17:28)</a>:</h4>
<p>I only looked on <code>Place</code> itself before saying it didn't.</p>



<a name="131057530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057530">(Aug 07 2018 at 17:28)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">place</span><span class="p">;</span><span class="w"></span>
<span class="k">loop</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">is_upvar_field_project</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Projection</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">       </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">proj</span><span class="p">.</span><span class="n">base</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="131057545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057545">(Aug 07 2018 at 17:29)</a>:</h4>
<p>the prefixes method that exists is something like <code>self.prefixes(place, PrefixSet::All)</code></p>



<a name="131057564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057564">(Aug 07 2018 at 17:29)</a>:</h4>
<p>where <code>self</code> is the <code>MirBorrowckCtxt</code></p>



<a name="131057645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131057645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131057645">(Aug 07 2018 at 17:30)</a>:</h4>
<p>Yeah, I'm trying that just now.</p>



<a name="131058399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131058399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131058399">(Aug 07 2018 at 17:42)</a>:</h4>
<p>Seems to have done the job, adding that as a test case and updating the PR momentarily.</p>



<a name="131058909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131058909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131058909">(Aug 07 2018 at 17:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Fixed on PR.</p>



<a name="131062664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131062664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131062664">(Aug 07 2018 at 18:56)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> Fixed PR again.</p>



<a name="131062719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131062719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131062719">(Aug 07 2018 at 18:57)</a>:</h4>
<p>one annoying thing about the blue link</p>



<a name="131062720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131062720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131062720">(Aug 07 2018 at 18:57)</a>:</h4>
<p>we need a link to the PR :)</p>



<a name="131062798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131062798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131062798">(Aug 07 2018 at 18:59)</a>:</h4>
<p>I wonder if it can do two links?</p>



<a name="131062814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131062814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131062814">(Aug 07 2018 at 18:59)</a>:</h4>
<p>It can.</p>



<a name="131062888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131062888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131062888">(Aug 07 2018 at 19:00)</a>:</h4>
<p>I don't see any blue arrows in your zulip test...?</p>



<a name="131063890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131063890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131063890">(Aug 07 2018 at 19:22)</a>:</h4>
<p>Fixed again - I've been awful for lots of minor travis failures of late.</p>



<a name="131063894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/131063894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#131063894">(Aug 07 2018 at 19:22)</a>:</h4>
<p>Looks like simulacrum already got it.</p>



<a name="132072715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/132072715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#132072715">(Aug 13 2018 at 21:21)</a>:</h4>
<p>This PR needs a retry <span class="user-mention" data-user-id="116009">@nikomatsakis</span>.</p>



<a name="132072719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/132072719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#132072719">(Aug 13 2018 at 21:21)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/53164" target="_blank" title="https://github.com/rust-lang/rust/issues/53164">#53164</a></p>



<a name="132073072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/132073072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#132073072">(Aug 13 2018 at 21:28)</a>:</h4>
<p>Thanks.</p>



<a name="132121491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/132121491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#132121491">(Aug 14 2018 at 16:39)</a>:</h4>
<p>Rebased this after the big PR landed.</p>



<a name="132183883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/132183883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#132183883">(Aug 15 2018 at 16:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> can you quickly take a look at this again? It's just a rebase so nothing's really changed, just test output.</p>



<a name="132184651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2352663-span-decl-captured-variables/near/132184651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2352663-span-decl-captured-variables.html#132184651">(Aug 15 2018 at 16:31)</a>:</h4>
<p>ok</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>