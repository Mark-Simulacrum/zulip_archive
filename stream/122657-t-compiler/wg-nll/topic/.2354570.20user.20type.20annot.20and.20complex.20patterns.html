<html>
<head><meta charset="utf-8"><title>#54570 user type annot and complex patterns · t-compiler/wg-nll · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/index.html">t-compiler/wg-nll</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html">#54570 user type annot and complex patterns</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="135501205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501205">(Oct 09 2018 at 21:42)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> I think you once sent a link to your in-progress branch here...</p>



<a name="135501217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501217">(Oct 09 2018 at 21:42)</a>:</h4>
<p>yeah its around</p>



<a name="135501221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501221">(Oct 09 2018 at 21:43)</a>:</h4>
<p>hold on one sec</p>



<a name="135501227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501227">(Oct 09 2018 at 21:43)</a>:</h4>
<p>I am looking at refactoring how user type annotations are attached to constants in order to address <a href="https://github.com/rust-lang/rust/issues/54574" target="_blank" title="https://github.com/rust-lang/rust/issues/54574">#54574</a> (and, I think, the other  issue assigned to me)</p>



<a name="135501236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501236">(Oct 09 2018 at 21:43)</a>:</h4>
<p>I think it will no longer suffice to just attach a <code>CanonicalTy</code></p>



<a name="135501242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501242">(Oct 09 2018 at 21:43)</a>:</h4>
<p>but actually this is probably somewhat disjoint from what you are doing</p>



<a name="135501244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501244">(Oct 09 2018 at 21:43)</a>:</h4>
<p>since it applies <em>specifically</em> to constants</p>



<a name="135501248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501248">(Oct 09 2018 at 21:43)</a>:</h4>
<p>still, I was curious to see</p>



<a name="135501301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501301">(Oct 09 2018 at 21:44)</a>:</h4>
<p>this is probably the easiest thing for me to share: <a href="https://github.com/pnkfelix/rust/tree/issue-54570-proj-path-into-pats-with-type" target="_blank" title="https://github.com/pnkfelix/rust/tree/issue-54570-proj-path-into-pats-with-type">https://github.com/pnkfelix/rust/tree/issue-54570-proj-path-into-pats-with-type</a></p>



<a name="135501316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501316">(Oct 09 2018 at 21:45)</a>:</h4>
<p>I still need to rebase this atop your fix for the ICE</p>



<a name="135501329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501329">(Oct 09 2018 at 21:45)</a>:</h4>
<p>ok</p>



<a name="135501335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501335">(Oct 09 2018 at 21:45)</a>:</h4>
<p>or ... hmm, well, that actually might currently be icing for an entirely different reason</p>



<a name="135501393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501393">(Oct 09 2018 at 21:46)</a>:</h4>
<p>I cannot remember, and my most recent build log shows an ice that I myself injected here</p>



<a name="135501408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501408">(Oct 09 2018 at 21:47)</a>:</h4>
<p>still, I think it captures the strategy I was planning to deploy</p>



<a name="135501417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501417">(Oct 09 2018 at 21:47)</a>:</h4>
<p>Oh  now I remember</p>



<a name="135501505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501505">(Oct 09 2018 at 21:49)</a>:</h4>
<p>Or ...  I thought I had a big comment somewhere in the commit that said "if this works, why am I doing it this way"</p>



<a name="135501580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501580">(Oct 09 2018 at 21:51)</a>:</h4>
<p>but now I cannot find that comment. I must have decided it didn't work. :)</p>



<a name="135501591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501591">(Oct 09 2018 at 21:51)</a>:</h4>
<p>Oh I bet its on my laptop!</p>



<a name="135501594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501594">(Oct 09 2018 at 21:51)</a>:</h4>
<p>(sorry, so much of my workflow is centered on my remote desktop.)</p>



<a name="135501647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501647">(Oct 09 2018 at 21:52)</a>:</h4>
<p>yes yes yes!</p>



<a name="135501654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501654">(Oct 09 2018 at 21:52)</a>:</h4>
<p>okay I need to push the work from my laptop to that branch</p>



<a name="135501665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501665">(Oct 09 2018 at 21:52)</a>:</h4>
<p>but the ICE I was seeing on my laptop looked like this:</p>



<a name="135501693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501693">(Oct 09 2018 at 21:53)</a>:</h4>
<p><code>"librustc_mir/borrow_check/nll/universal_regions.rs:754: cannot convert </code>ReScope(Remainder { block: ItemLocalId(110), first_statement_index: 1})<code> to a region vid</code></p>



<a name="135501826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501826">(Oct 09 2018 at 21:55)</a>:</h4>
<p>that is almost certainly the ICE I fixed, yes</p>



<a name="135501828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501828">(Oct 09 2018 at 21:55)</a>:</h4>
<p>and I can see why the changes you are making might trigger it</p>



<a name="135501881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501881">(Oct 09 2018 at 21:56)</a>:</h4>
<p>it would arise in particular if you were asserting types on more complex places that involve field projections</p>



<a name="135501884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501884">(Oct 09 2018 at 21:56)</a>:</h4>
<p>okay github repo is updated</p>



<a name="135501918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501918">(Oct 09 2018 at 21:57)</a>:</h4>
<p>and this is the comment slash big question to self that I was referring to up above: <a href="https://github.com/pnkfelix/rust/blob/30687327f112018837d227917e0331a052648b5f/src/librustc_mir/borrow_check/nll/type_check/relate_tys.rs#L93" target="_blank" title="https://github.com/pnkfelix/rust/blob/30687327f112018837d227917e0331a052648b5f/src/librustc_mir/borrow_check/nll/type_check/relate_tys.rs#L93">https://github.com/pnkfelix/rust/blob/30687327f112018837d227917e0331a052648b5f/src/librustc_mir/borrow_check/nll/type_check/relate_tys.rs#L93</a></p>



<a name="135501936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501936">(Oct 09 2018 at 21:57)</a>:</h4>
<p>basically, when I started on this task, I expected at some point to have to apply the series of PlaceProjections to a base other than the one I started with</p>



<a name="135501996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135501996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135501996">(Oct 09 2018 at 21:58)</a>:</h4>
<p>but that did not seem to happen</p>



<a name="135502100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/135502100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#135502100">(Oct 09 2018 at 22:00)</a>:</h4>
<p>but I suspect I'm probably overlooking some way in which the state of the Place (or the base of the Place) gets updated between the  two points in the control flow of <code>rustc</code></p>



<a name="136484398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136484398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136484398">(Oct 25 2018 at 15:15)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> thanks for the review. Got me off my duff and made an example that shows why we need to normalize during projection.</p>



<a name="136484519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136484519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136484519">(Oct 25 2018 at 15:17)</a>:</h4>
<p>if we weren't relatively close to cutting the beta, I'd wonder if I should be refactoring further (to fold my new code in with the code you had linked in sanitize type). But my current inclination is to try to land it as is, even with the minor amount of duplication of functionality?</p>



<a name="136484535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136484535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136484535">(Oct 25 2018 at 15:17)</a>:</h4>
<p>(oops and clearly a last minute rebase broke my PR... will fix)</p>



<a name="136484692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136484692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136484692">(Oct 25 2018 at 15:19)</a>:</h4>
<p>ooh and oh boy I need to rebase atop PR <a href="https://github.com/rust-lang/rust/issues/55323" target="_blank" title="https://github.com/rust-lang/rust/issues/55323">#55323</a> anyway! Okay so I guess don't worry about a re-review until  i take care of that...</p>



<a name="136485496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136485496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136485496">(Oct 25 2018 at 15:30)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> ping me when ready</p>



<a name="136503863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136503863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136503863">(Oct 25 2018 at 20:13)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> ping: I have a question about how to properly rebase this work</p>



<a name="136506084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136506084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136506084">(Oct 25 2018 at 20:49)</a>:</h4>
<p>the main question is this: You shifted the code for handling <code>TypeOf</code> to a ascribe_user_type query. It <em>looks</em> like the "right" way (and perhaps only way?) forward for me is to add the list of projections <em>to</em> the <code>AscribeUserType</code>.</p>



<a name="136506164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136506164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136506164">(Oct 25 2018 at 20:50)</a>:</h4>
<p>But the <code>struct AscribeUserType</code> must be <code>Copy</code>. And therefore I'm probably going to have to intern the  instances of <code>[ProjectionElem&lt;'tcx, (), ()&gt;]</code>. I can do that, it looks like a somewhat straight-forward addition. But I want you to stop me if this sounds like entirely the wrong path.</p>



<a name="136507324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507324">(Oct 25 2018 at 21:11)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> why must <code>AscribeUserType</code> be copy?</p>



<a name="136507335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507335">(Oct 25 2018 at 21:11)</a>:</h4>
<p>let me think here...</p>



<a name="136507381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507381">(Oct 25 2018 at 21:12)</a>:</h4>
<p>because I tried making it non-Copy and everything went haywire?</p>



<a name="136507386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507386">(Oct 25 2018 at 21:12)</a>:</h4>
<p>heh :)</p>



<a name="136507392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507392">(Oct 25 2018 at 21:12)</a>:</h4>
<p>you could also intern them :)</p>



<a name="136507395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507395">(Oct 25 2018 at 21:12)</a>:</h4>
<p>I guess that's what you said</p>



<a name="136507397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507397">(Oct 25 2018 at 21:12)</a>:</h4>
<p>I get the impression that all the query types are Copy?</p>



<a name="136507401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507401">(Oct 25 2018 at 21:12)</a>:</h4>
<p>that may be true</p>



<a name="136507409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507409">(Oct 25 2018 at 21:12)</a>:</h4>
<p>it doesn't seem like it <em>has</em> to be true but maybe we added that requirement at some point to simplify things</p>



<a name="136507421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507421">(Oct 25 2018 at 21:13)</a>:</h4>
<p>(I didn't formally verify that. I just saw a macro that referenced <code>AscribeUserType</code> that itself requires it to be Copy. That was the impression I got from the compiler error)</p>



<a name="136507426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507426">(Oct 25 2018 at 21:13)</a>:</h4>
<p>anyway I.. think I agree that we have to pipe those projections in with the query</p>



<a name="136507440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507440">(Oct 25 2018 at 21:13)</a>:</h4>
<p>I may be about to the stage in my second rebase attempt where I could retry the experiment of making <code>AscribeUserType</code> non-copy</p>



<a name="136507441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507441">(Oct 25 2018 at 21:13)</a>:</h4>
<p>that is, add them to the query key</p>



<a name="136507465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507465">(Oct 25 2018 at 21:14)</a>:</h4>
<p>as an aside, <span class="user-mention" data-user-id="131694">@scalexm</span>'s PR that converts canonical to use bound-tys would be mildly helpful — my initial attempt at that query had the query key including a <code>CanonicalUserTypeAnnotation</code></p>



<a name="136507509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507509">(Oct 25 2018 at 21:14)</a>:</h4>
<p>I had to back that out because we did not yet support recursive canonicalization</p>



<a name="136507519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507519">(Oct 25 2018 at 21:14)</a>:</h4>
<p>I think that should "just work" once <a href="https://github.com/rust-lang/rust/pull/55330" target="_blank" title="https://github.com/rust-lang/rust/pull/55330">https://github.com/rust-lang/rust/pull/55330</a> lands</p>



<a name="136507535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507535">(Oct 25 2018 at 21:14)</a>:</h4>
<p>I guess that's sort of neither here nor there</p>



<a name="136507543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507543">(Oct 25 2018 at 21:14)</a>:</h4>
<p>okay</p>



<a name="136507544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507544">(Oct 25 2018 at 21:14)</a>:</h4>
<p>just might mean a bit less duplication</p>



<a name="136507559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507559">(Oct 25 2018 at 21:15)</a>:</h4>
<p>(the "okay" was largely in response to "we have to pipe those projections in with the query")</p>



<a name="136507566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507566">(Oct 25 2018 at 21:15)</a>:</h4>
<p>I should have tried harder to the win the race. :)</p>



<a name="136507634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507634">(Oct 25 2018 at 21:16)</a>:</h4>
<p>haha sorry</p>



<a name="136507645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507645">(Oct 25 2018 at 21:16)</a>:</h4>
<p>though fwiw it seems like fixing ICE before adding your stuff is the right way forward</p>



<a name="136507672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507672">(Oct 25 2018 at 21:17)</a>:</h4>
<p>yeah no I'm just kidding</p>



<a name="136507678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507678">(Oct 25 2018 at 21:17)</a>:</h4>
<p>I'm sure its better that this ends up on my shoulders</p>



<a name="136507679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507679">(Oct 25 2018 at 21:17)</a>:</h4>
<p>for many reasons</p>



<a name="136507700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507700">(Oct 25 2018 at 21:18)</a>:</h4>
<p>and I think I'll be able to do it tomorrow. But I don't think I'll be able to do it quickly tonight, which means I will probably just go to bed now.</p>



<a name="136507781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507781">(Oct 25 2018 at 21:19)</a>:</h4>
<p>This is why <code>AscribeUserType</code> has to be <code>Copy</code>: </p>
<div class="codehilite"><pre><span></span>error[E0204]: the trait `Copy` may not be implemented for this type
   --&gt; librustc/ty/query/plumbing.rs:729:18
    |
729 |           #[derive(Copy, Clone, Debug, PartialEq, Eq, Hash)]
    |                    ^^^^
730 |           pub enum Query&lt;$tcx&gt; {
731 |               $($(#[$attr])* $name($K)),*
    |                                    -- this field does not implement `Copy`
    |
   ::: librustc/ty/query/mod.rs:106:1
    |
106 | / define_queries! { &lt;&#39;tcx&gt;
107 | |     Other {
108 | |         /// Records the type of every item.
109 | |         [] fn type_of: TypeOfItem(DefId) -&gt; Ty&lt;&#39;tcx&gt;,
...   |
688 | |     },
689 | | }
    | |_- in this macro invocation
</pre></div>



<a name="136507794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507794">(Oct 25 2018 at 21:19)</a>:</h4>
<p>are you suggesting that we might be able to just make <em>Query</em> non-copy as well?</p>



<a name="136507795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507795">(Oct 25 2018 at 21:19)</a>:</h4>
<p>welp</p>



<a name="136507802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507802">(Oct 25 2018 at 21:19)</a>:</h4>
<p>I don't know how much work that would entail</p>



<a name="136507850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507850">(Oct 25 2018 at 21:20)</a>:</h4>
<p>seems <em>plausible</em></p>



<a name="136507857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507857">(Oct 25 2018 at 21:20)</a>:</h4>
<p>otoh maybe it's better to just intern</p>



<a name="136507859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507859">(Oct 25 2018 at 21:20)</a>:</h4>
<p>it's kind of a pain</p>



<a name="136507863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507863">(Oct 25 2018 at 21:20)</a>:</h4>
<p>I think I'm better off interning the projection</p>



<a name="136507868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507868">(Oct 25 2018 at 21:20)</a>:</h4>
<p>the macros around this area are annoying I mean</p>



<a name="136507873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507873">(Oct 25 2018 at 21:20)</a>:</h4>
<p>but overall it seems probably good</p>



<a name="136507875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507875">(Oct 25 2018 at 21:20)</a>:</h4>
<p>I can at least <em>predict</em> the amount of effort attatched to that.</p>



<a name="136507880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507880">(Oct 25 2018 at 21:20)</a>:</h4>
<p>:)</p>



<a name="136507889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507889">(Oct 25 2018 at 21:20)</a>:</h4>
<p>I was musing to myself</p>



<a name="136507896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507896">(Oct 25 2018 at 21:20)</a>:</h4>
<p>whether we have any notion</p>



<a name="136507900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507900">(Oct 25 2018 at 21:20)</a>:</h4>
<p>of how much fragmentation is caused by these intern tables</p>



<a name="136507918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507918">(Oct 25 2018 at 21:21)</a>:</h4>
<p>i.e. how much a GC would reduce our rss</p>



<a name="136507931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136507931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136507931">(Oct 25 2018 at 21:21)</a>:</h4>
<p>but its one of those things ... where you need to have a GC to even answer the question in the first place.</p>



<a name="136542327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136542327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136542327">(Oct 26 2018 at 12:05)</a>:</h4>
<blockquote>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> ping me when ready</p>
</blockquote>
<p>Okay PR <a href="https://github.com/rust-lang/rust/issues/55274" target="_blank" title="https://github.com/rust-lang/rust/issues/55274">#55274</a> is now ready for review again. (I ended up merging much of the immediate review feedback into a commit during a rebase, but most of the new stuff to deal with the AscribeUserType type op is is follow-on commits, not squashed.</p>



<a name="136542334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136542334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136542334">(Oct 26 2018 at 12:05)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> ^</p>



<a name="136543320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136543320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136543320">(Oct 26 2018 at 12:25)</a>:</h4>
<p>hup, no, apparently that was premature. :(</p>



<a name="136544263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136544263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136544263">(Oct 26 2018 at 12:44)</a>:</h4>
<p>or maybe its fine ...? I might have just hit some --keep-stage corruption on that last run, not sure yet</p>



<a name="136553799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136553799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136553799">(Oct 26 2018 at 15:17)</a>:</h4>
<p>Okay I think this is indeed ready <span class="user-mention" data-user-id="116009">@nikomatsakis</span> : would be awesome if we could manage to get this in before beta is cut over weekend. But not end of world if not.</p>



<a name="136564659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136564659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136564659">(Oct 26 2018 at 18:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116083">@pnkfelix</span> r=me but needs rebase</p>



<a name="136565739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354570%20user%20type%20annot%20and%20complex%20patterns/near/136565739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2354570.20user.20type.20annot.20and.20complex.20patterns.html#136565739">(Oct 26 2018 at 18:39)</a>:</h4>
<p>Yeah I hope to rebase tonight</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>