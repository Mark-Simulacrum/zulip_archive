<html>
<head><meta charset="utf-8"><title>#53189 optimize `check_if_reassignment_to_immutable_state` · t-compiler/wg-nll · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/index.html">t-compiler/wg-nll</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html">#53189 optimize `check_if_reassignment_to_immutable_state`</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="131117598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131117598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131117598">(Aug 08 2018 at 16:10)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> how much do you know about the <code>MoveData</code> setup?</p>



<a name="131118346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118346">(Aug 08 2018 at 16:25)</a>:</h4>
<p>from the top of my head nothing</p>



<a name="131118359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118359">(Aug 08 2018 at 16:25)</a>:</h4>
<p>but I have already done something with it ... don't remember</p>



<a name="131118362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118362">(Aug 08 2018 at 16:25)</a>:</h4>
<p>need to check the definition</p>



<a name="131118429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118429">(Aug 08 2018 at 16:26)</a>:</h4>
<p>the idea is that we find paths which are used within the MIR (i.e., <code>Place</code>s)</p>



<a name="131118434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118434">(Aug 08 2018 at 16:26)</a>:</h4>
<p>and we assign them a <code>MovePathIndex</code></p>



<a name="131118441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118441">(Aug 08 2018 at 16:27)</a>:</h4>
<p>actually i'd like to use them (or something similar) for <em>everything</em></p>



<a name="131118444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118444">(Aug 08 2018 at 16:27)</a>:</h4>
<p>but right we only use them for computing which values have been initialized etc</p>



<a name="131118446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118446">(Aug 08 2018 at 16:27)</a>:</h4>
<p>these indices are then used in the bitset</p>



<a name="131118458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118458">(Aug 08 2018 at 16:27)</a>:</h4>
<p>in particular, if you have a path like <code>a.b.c</code> there will be a <code>MovePathIndex</code> (MPI) for that path; these are in a tree, so you can go to the MPI for the parent (<code>a.b</code>) and its parent (<code>a</code>)</p>



<a name="131118483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118483">(Aug 08 2018 at 16:28)</a>:</h4>
<p>we make MPIs for each path that is used in the source</p>



<a name="131118503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118503">(Aug 08 2018 at 16:28)</a>:</h4>
<p>well, almost</p>



<a name="131118507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118507">(Aug 08 2018 at 16:28)</a>:</h4>
<p>in particular, there are some paths where you cannot move individual fields out</p>



<a name="131118513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118513">(Aug 08 2018 at 16:28)</a>:</h4>
<p>for example, you cannot move a field from an enum, or from the referent of a <code>&amp;T</code> , or from a struct that implements <code>Drop</code></p>



<a name="131118520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118520">(Aug 08 2018 at 16:28)</a>:</h4>
<p>in those cases there is no MPI for the path</p>



<a name="131118523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118523">(Aug 08 2018 at 16:28)</a>:</h4>
<p>because any attempt to <em>move</em> from such a path would be an error</p>



<a name="131118544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118544">(Aug 08 2018 at 16:29)</a>:</h4>
<p>I mention this because when you have an assignment like <code>a = foo</code>, we need to map <code>a</code> to an MPI to look up whether it has already been initialized or not</p>



<a name="131118553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118553">(Aug 08 2018 at 16:29)</a>:</h4>
<p>in the "simplified version" that I initially proposed, this lookup would be infallible, because there is <em>always</em> an MPI for every local variable</p>



<a name="131118621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118621">(Aug 08 2018 at 16:30)</a>:</h4>
<p>but if we want to permit something like</p>
<div class="codehilite"><pre><span></span>let x: (u32, u32);

x.0 = 22;
x.1 = 44;
</pre></div>



<a name="131118635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118635">(Aug 08 2018 at 16:30)</a>:</h4>
<p>then we would be looking up the MPI for <code>x.0</code> (and all of its parents, I think)</p>



<a name="131118658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118658">(Aug 08 2018 at 16:31)</a>:</h4>
<p>(actually i'm not 100% sure how that works, I have to double check, I thought that we only propagated the bits for the paths like <code>x.0</code>, but maybe we assign a bit for every MPI? have to check)</p>



<a name="131118662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118662">(Aug 08 2018 at 16:31)</a>:</h4>
<p>anyway, point is, that might be fallible</p>



<a name="131118665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118665">(Aug 08 2018 at 16:31)</a>:</h4>
<p>I'm actually in favor still of doing the simplified thing that matches AST borrow ck</p>



<a name="131118669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118669">(Aug 08 2018 at 16:31)</a>:</h4>
<p>and opening an issue to do a full extension</p>



<a name="131118674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131118674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131118674">(Aug 08 2018 at 16:31)</a>:</h4>
<p>to do it <em>right</em> will require a bit more work anyway</p>



<a name="131228691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131228691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131228691">(Aug 10 2018 at 10:10)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> do you think you'll have time to poke at this? I'm tempted to take a stab at it myself to see how much it helps</p>



<a name="131234905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131234905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131234905">(Aug 10 2018 at 12:44)</a>:</h4>
<p>yes</p>



<a name="131234924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131234924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131234924">(Aug 10 2018 at 12:44)</a>:</h4>
<p>I have time today for sure</p>



<a name="131842603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842603">(Aug 10 2018 at 19:42)</a>:</h4>
<p>hey <span class="user-mention" data-user-id="116009">@nikomatsakis</span> back</p>



<a name="131842608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842608">(Aug 10 2018 at 19:42)</a>:</h4>
<p>so, I've made a couple of tests</p>



<a name="131842613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842613">(Aug 10 2018 at 19:42)</a>:</h4>
<p>but I was reading what you wrote in the issue</p>



<a name="131842622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842622">(Aug 10 2018 at 19:42)</a>:</h4>
<p>in particular this part</p>



<a name="131842623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842623">(Aug 10 2018 at 19:42)</a>:</h4>
<p><code>It iterates over all initialized paths and checks that the path being assigned to (e.g., x.0 in the third example) is disjoint from all of them:</code></p>



<a name="131842626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842626">(Aug 10 2018 at 19:42)</a>:</h4>
<p>not sure I follow the meaning of that</p>



<a name="131842639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842639">(Aug 10 2018 at 19:43)</a>:</h4>
<p>and also, it seems very different to what the error talks about</p>



<a name="131842641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842641">(Aug 10 2018 at 19:43)</a>:</h4>
<p>the error says</p>



<a name="131842650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842650">(Aug 10 2018 at 19:43)</a>:</h4>
<p><code>cannot mutably borrow field of immutable binding</code></p>



<a name="131842661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842661">(Aug 10 2018 at 19:43)</a>:</h4>
<p>which I'm not even sure if it's correct</p>



<a name="131842718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842718">(Aug 10 2018 at 19:44)</a>:</h4>
<p>I need to read the comments of the issue</p>



<a name="131842842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842842">(Aug 10 2018 at 19:47)</a>:</h4>
<p>I've read the stuff, ok I see why the mut thing, but the borrow word in the error sounds weird to me</p>



<a name="131842845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842845">(Aug 10 2018 at 19:47)</a>:</h4>
<p>is that a borrow?</p>



<a name="131842851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842851">(Aug 10 2018 at 19:47)</a>:</h4>
<p>I mean, accessing an entry of a pair</p>



<a name="131842921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842921">(Aug 10 2018 at 19:48)</a>:</h4>
<p>and anyway I still don't get the phrase anyway <code>It iterates over all initialized paths and checks that the path being assigned to (e.g., x.0 in the third example) is disjoint from all of them:</code></p>



<a name="131842938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842938">(Aug 10 2018 at 19:49)</a>:</h4>
<p>I mean, I think I get it but I can't make sense of that</p>



<a name="131842945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842945">(Aug 10 2018 at 19:49)</a>:</h4>
<p>you mean that the algorithm iterates over .0 and .1 and check that the thing being assigned in this case .0 is disjoint in this case? which of course is not?</p>



<a name="131842991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131842991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131842991">(Aug 10 2018 at 19:50)</a>:</h4>
<p>I don't see how that makes sense to cover reassignments of immutable things</p>



<a name="131843422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843422">(Aug 10 2018 at 19:58)</a>:</h4>
<p>hey <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span></p>



<a name="131843423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843423">(Aug 10 2018 at 19:58)</a>:</h4>
<p>sorry, was in a call</p>



<a name="131843431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843431">(Aug 10 2018 at 19:59)</a>:</h4>
<p>ok so what the code does <em>now</em></p>



<a name="131843439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843439">(Aug 10 2018 at 19:59)</a>:</h4>
<p>it has a complete list of all things that have ever been assigned up until this point</p>



<a name="131843440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843440">(Aug 10 2018 at 19:59)</a>:</h4>
<p>I was reading again and I think I got it :)</p>



<a name="131843441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843441">(Aug 10 2018 at 19:59)</a>:</h4>
<p>ah ok :)</p>



<a name="131843452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843452">(Aug 10 2018 at 19:59)</a>:</h4>
<p>I <em>think</em> the actual diff needed here is not very large</p>



<a name="131843454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843454">(Aug 10 2018 at 19:59)</a>:</h4>
<p>depending which alternative we opt for</p>



<a name="131843465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843465">(Aug 10 2018 at 20:00)</a>:</h4>
<p>we are not going to allow in this PR <code>x.0 = 1; x.1 = 2;</code> and stuff like that, right?</p>



<a name="131843524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843524">(Aug 10 2018 at 20:00)</a>:</h4>
<p>I'm personally leaning that way</p>



<a name="131843528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843528">(Aug 10 2018 at 20:00)</a>:</h4>
<p>it seems just a bit easier</p>



<a name="131843530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843530">(Aug 10 2018 at 20:00)</a>:</h4>
<p>it may be a larger diff though :)</p>



<a name="131843540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843540">(Aug 10 2018 at 20:00)</a>:</h4>
<p>just because the code is a bit oriented towards accepting that</p>



<a name="131843553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843553">(Aug 10 2018 at 20:01)</a>:</h4>
<p>anyway I feel like I'd rather support <code>x.0 = 1</code> <em>properly</em></p>



<a name="131843561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843561">(Aug 10 2018 at 20:01)</a>:</h4>
<p>I regret that we permit you to do that (at least, without having initialized <code>x</code> first) at all</p>



<a name="131843577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843577">(Aug 10 2018 at 20:01)</a>:</h4>
<p>(i.e., we now accept it, so long as <code>x</code> is <code>mut</code>)</p>



<a name="131843579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843579">(Aug 10 2018 at 20:01)</a>:</h4>
<p>but not much we can do about <em>that</em></p>



<a name="131843580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843580">(Aug 10 2018 at 20:01)</a>:</h4>
<p>no need to break code</p>



<a name="131843646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843646">(Aug 10 2018 at 20:02)</a>:</h4>
<blockquote>
<p>I regret that we permit you to do that (at least, without having initialized <code>x</code> first) at all</p>
</blockquote>
<p>permit to do what?</p>



<a name="131843671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843671">(Aug 10 2018 at 20:03)</a>:</h4>
<p>we permit this today:</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="n">x</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>but only if <code>x</code> is <code>mut</code></p>



<a name="131843674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843674">(Aug 10 2018 at 20:03)</a>:</h4>
<p>we do not permit you to <em>use</em> <code>x</code> later</p>



<a name="131843675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843675">(Aug 10 2018 at 20:03)</a>:</h4>
<p>that is, you can use <code>x.0</code> but not <code>x</code></p>



<a name="131843712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843712">(Aug 10 2018 at 20:04)</a>:</h4>
<p>in other words, if <code>x</code> is mut, we let you initialize "field by field", but we never recognize that <code>x</code> is fully initialized</p>



<a name="131843725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843725">(Aug 10 2018 at 20:04)</a>:</h4>
<p>I see</p>



<a name="131843730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843730">(Aug 10 2018 at 20:04)</a>:</h4>
<p>even this ...</p>



<a name="131843736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843736">(Aug 10 2018 at 20:04)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="n">x</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
</pre></div>



<a name="131843741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843741">(Aug 10 2018 at 20:04)</a>:</h4>
<p>should work</p>



<a name="131843823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843823">(Aug 10 2018 at 20:06)</a>:</h4>
<p>well</p>



<a name="131843824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843824">(Aug 10 2018 at 20:06)</a>:</h4>
<p>eventually I think yes</p>



<a name="131843826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843826">(Aug 10 2018 at 20:06)</a>:</h4>
<p>but it doesn't today (i.e., with the AST-based checker)</p>



<a name="131843830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843830">(Aug 10 2018 at 20:06)</a>:</h4>
<p><span class="emoji emoji-1f44d" title="+1">:+1:</span></p>



<a name="131843832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843832">(Aug 10 2018 at 20:06)</a>:</h4>
<p>it does with the MIR-based checker today</p>



<a name="131843848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843848">(Aug 10 2018 at 20:07)</a>:</h4>
<p>so</p>



<a name="131843849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843849">(Aug 10 2018 at 20:07)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="cp">#![feature(nll)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="131843853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843853">(Aug 10 2018 at 20:07)</a>:</h4>
<p>why should that fail?</p>



<a name="131843898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843898">(Aug 10 2018 at 20:08)</a>:</h4>
<p>just to keep the AST behavior for now?</p>



<a name="131843900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843900">(Aug 10 2018 at 20:08)</a>:</h4>
<p>it's easier? :)</p>



<a name="131843909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843909">(Aug 10 2018 at 20:08)</a>:</h4>
<p>I'm not sure that it should</p>



<a name="131843914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843914">(Aug 10 2018 at 20:08)</a>:</h4>
<p>but weren't you saying that this case is already working?</p>



<a name="131843915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843915">(Aug 10 2018 at 20:08)</a>:</h4>
<p>:P</p>



<a name="131843917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843917">(Aug 10 2018 at 20:08)</a>:</h4>
<p>well</p>



<a name="131843922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843922">(Aug 10 2018 at 20:09)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="cp">#![feature(nll)]</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">44</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">drop</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="c1">// ERROR</span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="131843926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843926">(Aug 10 2018 at 20:09)</a>:</h4>
<p>the thing is that x doesn't work later?</p>



<a name="131843931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843931">(Aug 10 2018 at 20:09)</a>:</h4>
<p>"working"</p>



<a name="131843933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843933">(Aug 10 2018 at 20:09)</a>:</h4>
<p>yes</p>



<a name="131843935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843935">(Aug 10 2018 at 20:09)</a>:</h4>
<p>I see</p>



<a name="131843940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843940">(Aug 10 2018 at 20:09)</a>:</h4>
<p>but yes</p>



<a name="131843997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131843997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131843997">(Aug 10 2018 at 20:10)</a>:</h4>
<p>so ... to be 100% clear</p>



<a name="131844003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844003">(Aug 10 2018 at 20:10)</a>:</h4>
<p>the rules we want to implement are ...</p>



<a name="131844008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844008">(Aug 10 2018 at 20:10)</a>:</h4>
<p>if x is not mut, we can't assign twice, it doesn't matter if the parts are disjoint</p>



<a name="131844016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844016">(Aug 10 2018 at 20:11)</a>:</h4>
<p>well</p>



<a name="131844033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844033">(Aug 10 2018 at 20:11)</a>:</h4>
<p>I am vacillating :)</p>



<a name="131844035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844035">(Aug 10 2018 at 20:11)</a>:</h4>
<p>but that <em>is</em> what I said</p>



<a name="131844038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844038">(Aug 10 2018 at 20:11)</a>:</h4>
<p>I am looking briefly at the code now</p>



<a name="131844040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844040">(Aug 10 2018 at 20:11)</a>:</h4>
<p>if x is mut it just works?</p>



<a name="131844110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844110">(Aug 10 2018 at 20:12)</a>:</h4>
<p>there are some annoying complications to consider</p>



<a name="131844111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844111">(Aug 10 2018 at 20:12)</a>:</h4>
<p>e.g.</p>



<a name="131844118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844118">(Aug 10 2018 at 20:12)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">union</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">b</span>: <span class="kt">u32</span> <span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">foo</span>: <span class="nc">Foo</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">foo</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">foo</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">44</span><span class="p">;</span><span class="w"> </span><span class="c1">// Error?</span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="131844126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844126">(Aug 10 2018 at 20:13)</a>:</h4>
<p>(that is, if we want to support this)</p>



<a name="131844132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844132">(Aug 10 2018 at 20:13)</a>:</h4>
<p>this is why the code was written with that naive loop, I think</p>



<a name="131844146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844146">(Aug 10 2018 at 20:13)</a>:</h4>
<p>hmmm</p>



<a name="131844147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844147">(Aug 10 2018 at 20:13)</a>:</h4>
<p>so yes I personally lean towards implementing the existing AST behavior, which is easy to get right</p>



<a name="131844151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844151">(Aug 10 2018 at 20:13)</a>:</h4>
<p>and then filing a follow-up issue to support "partial initialization" better</p>



<a name="131844192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844192">(Aug 10 2018 at 20:14)</a>:</h4>
<p><span class="emoji emoji-1f44d" title="+1">:+1:</span></p>



<a name="131844199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844199">(Aug 10 2018 at 20:14)</a>:</h4>
<p>so ... you proposed two ideas if I've read correctly</p>



<a name="131844203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844203">(Aug 10 2018 at 20:14)</a>:</h4>
<div class="codehilite"><pre><span></span>Distinguish the case of assignment directly to an immutable local (x = ...) from any other place.

    For assignments to an immutable local, we find the move-path-index and just check the &quot;ever initialized&quot; bit directly.
    For assignments to any other place, we use the self.access_place method with LocalMutationIsAllowed::No (unlike now, where we use ExceptUpvars).
</pre></div>



<a name="131844206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844206">(Aug 10 2018 at 20:14)</a>:</h4>
<p>and</p>



<a name="131844210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844210">(Aug 10 2018 at 20:14)</a>:</h4>
<div class="codehilite"><pre><span></span>    Find the move path corresponding to the place being assigned
        If there is no precise match, that is an error (e.g., assigning to a single field of a drop struct)
    If there is a precise match, check its bit
</pre></div>



<a name="131844231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844231">(Aug 10 2018 at 20:15)</a>:</h4>
<p>yes</p>



<a name="131844237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844237">(Aug 10 2018 at 20:15)</a>:</h4>
<p>well</p>



<a name="131844248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844248">(Aug 10 2018 at 20:15)</a>:</h4>
<p>the second one...</p>



<a name="131844294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844294">(Aug 10 2018 at 20:16)</a>:</h4>
<p>if this is an assignment to an immutable local,</p>



<a name="131844297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844297">(Aug 10 2018 at 20:16)</a>:</h4>
<p>then in fact you are guaranteed that it has a MPI bit</p>



<a name="131844300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844300">(Aug 10 2018 at 20:16)</a>:</h4>
<p>because all locals have MPI bits</p>



<a name="131844524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844524">(Aug 10 2018 at 20:20)</a>:</h4>
<p>unsure what the last thing means</p>



<a name="131844555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844555">(Aug 10 2018 at 20:21)</a>:</h4>
<p>there are these "move paths" that are used to track what is initialized</p>



<a name="131844562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844562">(Aug 10 2018 at 20:21)</a>:</h4>
<p>each has a <code>MovePathIndex</code> (or MPI)</p>



<a name="131844563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844563">(Aug 10 2018 at 20:21)</a>:</h4>
<p>we create them for all the places that we see in the source</p>



<a name="131844564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844564">(Aug 10 2018 at 20:21)</a>:</h4>
<p>or, most of them</p>



<a name="131844566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844566">(Aug 10 2018 at 20:21)</a>:</h4>
<p>but not for just any old <code>Place</code></p>



<a name="131844626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844626">(Aug 10 2018 at 20:22)</a>:</h4>
<p>so if you want to check if some place has been initialized, you do something like:</p>
<div class="codehilite"><pre><span></span>let x = move_data.mpi(place); // converts the place to an mpi
check-if-the-bit-x-is-set
</pre></div>



<a name="131844631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844631">(Aug 10 2018 at 20:22)</a>:</h4>
<p>except that the first step is sometimes "fallible"</p>



<a name="131844639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844639">(Aug 10 2018 at 20:22)</a>:</h4>
<p>...but not for local variables</p>



<a name="131844677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844677">(Aug 10 2018 at 20:23)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_mir/dataflow/move_paths/struct.MovePathLookup.html#method.find_local" target="_blank" title="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_mir/dataflow/move_paths/struct.MovePathLookup.html#method.find_local">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_mir/dataflow/move_paths/struct.MovePathLookup.html#method.find_local</a></p>



<a name="131844721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844721">(Aug 10 2018 at 20:24)</a>:</h4>
<p>that method will give you the <code>MovePathIndex</code> for a local variable</p>



<a name="131844798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844798">(Aug 10 2018 at 20:26)</a>:</h4>
<p>then something like</p>



<a name="131844903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844903">(Aug 10 2018 at 20:28)</a>:</h4>
<div class="codehilite"><pre><span></span>let mpi = self.move_data.rev_lookup.find_local(local);
let is_initialized =
  self.move_data.init_path_map[mpi]
    .iter()
    .any(|init_index| flow_state.ever_inits.contains(&amp;init_index));
</pre></div>



<a name="131844908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844908">(Aug 10 2018 at 20:28)</a>:</h4>
<p>bit more complex than I thought...</p>



<a name="131844913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844913">(Aug 10 2018 at 20:28)</a>:</h4>
<p>so, what's happening there:</p>



<a name="131844920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844920">(Aug 10 2018 at 20:29)</a>:</h4>
<p>for every initialization, we create an index (the <code>init_index</code>)</p>



<a name="131844932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844932">(Aug 10 2018 at 20:29)</a>:</h4>
<p>then we have a map from each variable to all the initializations that correspond to it</p>



<a name="131844953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844953">(Aug 10 2018 at 20:29)</a>:</h4>
<p>so e.g. if you had</p>
<div class="codehilite"><pre><span></span>let (x, y);

x = 44; // this gets an InitIndex, say 0
y = 44;  // this gets an InitIndex, say 1
</pre></div>



<a name="131844959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131844959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131844959">(Aug 10 2018 at 20:29)</a>:</h4>
<p>and there is a map that would say <code>x -&gt; [0]</code>, <code>y -&gt; [1]</code></p>



<a name="131845138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131845138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131845138">(Aug 10 2018 at 20:32)</a>:</h4>
<p>let me know if this is making any sense at all :)</p>



<a name="131845143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131845143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131845143">(Aug 10 2018 at 20:32)</a>:</h4>
<p>it seems clear we need some more chapters in the rustc-guide...</p>



<a name="131845870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131845870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake Goulding <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131845870">(Aug 10 2018 at 20:49)</a>:</h4>
<blockquote>
<p>and then filing a follow-up issue to support "partial initialization" better</p>
</blockquote>
<p>I think that's <a href="https://github.com/rust-lang/rust/issues/21232" target="_blank" title="https://github.com/rust-lang/rust/issues/21232">https://github.com/rust-lang/rust/issues/21232</a></p>



<a name="131849870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131849870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131849870">(Aug 10 2018 at 22:22)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/53258" target="_blank" title="https://github.com/rust-lang/rust/pull/53258">https://github.com/rust-lang/rust/pull/53258</a></p>



<a name="131928892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131928892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131928892">(Aug 11 2018 at 00:05)</a>:</h4>
<p>on other front ...</p>



<a name="131928893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131928893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131928893">(Aug 11 2018 at 00:05)</a>:</h4>
<div class="codehilite"><pre><span></span>commit 63c32b891da049cf20d0693b5e122a8937c8e67b
Author: Santiago Pastorino &lt;spastorino@gmail.com&gt;
Date:   Fri Aug 10 16:34:35 2018 -0300

    Add test showing that re-assigning to immutable in nll fails

diff --git a/src/test/ui/nll/reassignment-to-immutable.rs b/src/test/ui/nll/reassignment-to-immutable.rs
new file mode 100644
index 0000000000..07046cf2a2
--- /dev/null
+++ b/src/test/ui/nll/reassignment-to-immutable.rs
@@ -0,0 +1,19 @@
+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT
+// file at the top-level directory of this distribution and at
+// http://rust-lang.org/COPYRIGHT.
+//
+// Licensed under the Apache License, Version 2.0 &lt;LICENSE-APACHE or
+// http://www.apache.org/licenses/LICENSE-2.0&gt; or the MIT license
+// &lt;LICENSE-MIT or http://opensource.org/licenses/MIT&gt;, at your
+// option. This file may not be copied, modified, or distributed
+// except according to those terms.
+
+#![feature(nll)]
+
+fn main() {
+    let x: (u32, u32);
+    x = (1, 2);
+    x = (3, 4);
+    //~^ ERROR cannot assign twice to immutable variable `x` [E0384]
+    drop(x);
+}
diff --git a/src/test/ui/nll/reassignment-to-immutable.stderr b/src/test/ui/nll/reassignment-to-immutable.stderr
new file mode 100644
index 0000000000..31716050f7
--- /dev/null
+++ b/src/test/ui/nll/reassignment-to-immutable.stderr
@@ -0,0 +1,13 @@
+error[E0384]: cannot assign twice to immutable variable `x`
+  --&gt; $DIR/reassignment-to-immutable.rs:16:5
+   |
+LL |     let x: (u32, u32);
+   |         - consider changing this to `mut x`
+LL |     x = (1, 2);
+   |     ---------- first assignment to `x`
+LL |     x = (3, 4);
+   |     ^^^^^^^^^^ cannot assign twice to immutable variable
+
+error: aborting due to previous error
+
+For more information about this error, try `rustc --explain E0384`.
</pre></div>



<a name="131928943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131928943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131928943">(Aug 11 2018 at 00:06)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> forgot to share that if you want to avoid typing that code :P</p>



<a name="131929883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131929883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131929883">(Aug 11 2018 at 00:34)</a>:</h4>
<p>I was thinking a few more tests would probably  be good actually</p>



<a name="131929884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131929884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131929884">(Aug 11 2018 at 00:34)</a>:</h4>
<p>in particular, my changes didn't really break anything :)</p>



<a name="131953445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2353189%20optimize%20%60check_if_reassignment_to_immutable_state%60/near/131953445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/122657-t-compiler/wg-nll/topic/.2353189.20optimize.20.60check_if_reassignment_to_immutable_state.60.html#131953445">(Aug 11 2018 at 12:37)</a>:</h4>
<p>cool</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>