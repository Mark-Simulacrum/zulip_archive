<html>
<head><meta charset="utf-8"><title>#54620 user type annot well-formed · t-compiler/wg-nll · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/index.html">t-compiler/wg-nll</a></h2>
<h3>Topic: <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html">#54620 user type annot well-formed</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://rust-lang.github.io/zulip_archive/style.css" rel="stylesheet"></head>

<a name="135213358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135213358" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135213358">(Oct 04 2018 at 20:11)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="128294">@blitzerr</span> — I didn't find a previous topic for this, so I created one</p>



<a name="135213362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135213362" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135213362">(Oct 04 2018 at 20:11)</a>:</h4>
<p>did the mentoring instructions I put on the issue make sense?</p>



<a name="135213523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135213523" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135213523">(Oct 04 2018 at 20:13)</a>:</h4>
<p>Kind of <span class="emoji emoji-1f603" title="smiley">:smiley:</span>.</p>



<a name="135213643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135213643" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135213643">(Oct 04 2018 at 20:15)</a>:</h4>
<p>I say that because I am going through the code in type_check/mod.rs and trying to figure out what's going on and what the terms such as well formed, prove_predicate, cannonical types and values mean</p>



<a name="135213726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135213726" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135213726">(Oct 04 2018 at 20:16)</a>:</h4>
<p><span class="user-mention" data-user-id="128294">@blitzerr</span> while the contents of this RFC aren't <em>directly</em> related, it may help with the general background (<a href="https://rust-lang.github.io/rfcs/1214-projections-lifetimes-and-wf.html" target="_blank" title="https://rust-lang.github.io/rfcs/1214-projections-lifetimes-and-wf.html">RFC 1214</a>)</p>



<a name="135213746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135213746" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135213746">(Oct 04 2018 at 20:16)</a>:</h4>
<p>Cool thanks a lot <span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="135213847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135213847" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135213847">(Oct 04 2018 at 20:18)</a>:</h4>
<p>Also I will be away for a couple of weeks from Oct 8-23. So might not get it to PR approved state by then. Will that be an issue ?</p>



<a name="135213876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135213876" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135213876">(Oct 04 2018 at 20:19)</a>:</h4>
<p>Hmm, could be, yes</p>



<a name="135213878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135213878" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135213878">(Oct 04 2018 at 20:19)</a>:</h4>
<p>since we're trying to land this by Oct 25</p>



<a name="135262520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135262520" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135262520">(Oct 05 2018 at 15:41)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <br>
After the fix, we expect the error to be the same as it would be without NLL turned on right as it is here?<br>
<a href="https://play.rust-lang.org/?gist=a6399e527836280d98889172fd919223&amp;version=nightly&amp;mode=debug&amp;edition=2018" target="_blank" title="https://play.rust-lang.org/?gist=a6399e527836280d98889172fd919223&amp;version=nightly&amp;mode=debug&amp;edition=2018">https://play.rust-lang.org/?gist=a6399e527836280d98889172fd919223&amp;version=nightly&amp;mode=debug&amp;edition=2018</a></p>



<a name="135263877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135263877" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135263877">(Oct 05 2018 at 16:05)</a>:</h4>
<p>yes, more or less</p>



<a name="135263882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135263882" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135263882">(Oct 05 2018 at 16:05)</a>:</h4>
<p>at least in the same fns</p>



<a name="135358435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135358435" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135358435">(Oct 07 2018 at 16:41)</a>:</h4>
<p>Does someone know how to convert </p>
<div class="codehilite"><pre><span></span><span class="n">b</span>: <span class="nc">CanonicalTy</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="w"></span>
<span class="n">into</span><span class="w"></span>
<span class="n">var</span>: <span class="nc">CanonicalVar</span><span class="w"></span>

<span class="n">So</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">by</span><span class="w"></span>

<span class="n">canonical_var_values</span><span class="w"> </span><span class="err">```</span><span class="w"></span>
</pre></div>



<a name="135359197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135359197" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135359197">(Oct 07 2018 at 17:07)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">relate_type_and_user_type</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">infcx</span>: <span class="kp">&amp;</span><span class="nc">InferCtxt</span><span class="o">&lt;</span><span class="na">&#39;_</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;_</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">a</span>: <span class="nc">Ty</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">v</span>: <span class="nc">ty</span>::<span class="n">Variance</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span>: <span class="nc">CanonicalTy</span><span class="o">&lt;</span><span class="na">&#39;tcx</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">locations</span>: <span class="nc">Locations</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">category</span>: <span class="nc">ConstraintCategory</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">borrowck_context</span>: <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">BorrowCheckContext</span><span class="o">&lt;</span><span class="na">&#39;_</span><span class="p">,</span><span class="w"> </span><span class="na">&#39;tcx</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Fallible</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="err">¦</span><span class="w">   </span><span class="s">&quot;sub_type_and_user_type(a={:?}, b={:?}, locations={:?})&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="err">¦</span><span class="w">   </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">locations</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">Canonical</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="err">¦</span><span class="w">   </span><span class="n">variables</span>: <span class="nc">b_variables</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="err">¦</span><span class="w">   </span><span class="n">value</span>: <span class="nc">b_value</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
</pre></div>


<p>Here one could use <code>b_variables</code> instead of <code>b.variables</code> ?</p>



<a name="135361345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135361345" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135361345">(Oct 07 2018 at 18:26)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <br>
It does not look like I will be able to take the PR for <a href="https://github.com/rust-lang/rust/issues/54620" target="_blank" title="https://github.com/rust-lang/rust/issues/54620">#54620</a> to finish line by Oct 25 as I will be traveling. So it might be worthwhile to assign it to someone else. Sorry about that.</p>



<a name="135361890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135361890" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135361890">(Oct 07 2018 at 18:46)</a>:</h4>
<p>I'm doing some things that are related, so I might pick it up with them.</p>



<a name="135409519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135409519" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135409519">(Oct 08 2018 at 15:04)</a>:</h4>
<p>Thanks a lot <span class="user-mention" data-user-id="116118">@Matthew Jasper</span></p>



<a name="135411044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135411044" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135411044">(Oct 08 2018 at 15:30)</a>:</h4>
<p><span class="user-mention" data-user-id="128294">@blitzerr</span> the question -- how to convert a canonical-ty into a canonical-var -- doesn't  really make sense, I'm afraid</p>



<a name="135411049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135411049" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135411049">(Oct 08 2018 at 15:30)</a>:</h4>
<p>but maybe a moot point</p>



<a name="135411679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135411679" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135411679">(Oct 08 2018 at 15:40)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <br>
In <br>
<code>fn relate_type_and_user_type </code>  the argument is <code>CanonicalTy&lt;'tcx&gt;</code><br>
but the <code>canonical_var_values: IndexVec&lt;CanonicalVar, Option&lt;Kind&lt;'tcx&gt;&gt;&gt;</code><br>
is an index vector of CanonicalVar. So wouldn't it require a conversion ?</p>



<a name="135412008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135412008" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135412008">(Oct 08 2018 at 15:45)</a>:</h4>
<p>Because this is what my interpretation of the mentorship note was:<br>
- Instantiate the canonical types with their canonical variables using (substitute function).<br>
- Then create the well formed predicate for each.</p>



<a name="135432186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135432186" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135432186">(Oct 08 2018 at 22:41)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span></p>



<a name="135480403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480403" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480403">(Oct 09 2018 at 16:09)</a>:</h4>
<p><span class="user-mention" data-user-id="116118">@Matthew Jasper</span> so you are taking this issue?</p>



<a name="135480412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480412" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480412">(Oct 09 2018 at 16:09)</a>:</h4>
<p>(I was debating about fixing it, but I can do other things)</p>



<a name="135480426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480426" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480426">(Oct 09 2018 at 16:09)</a>:</h4>
<p><span class="user-mention" data-user-id="128294">@blitzerr</span> mainly because that type is not a key to that vector — you might want to read up on the <a href="https://rust-lang-nursery.github.io/rustc-guide/traits/canonicalization.html" target="_blank" title="https://rust-lang-nursery.github.io/rustc-guide/traits/canonicalization.html">rustc-guide chapter on canonicalization</a></p>



<a name="135480468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480468" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480468">(Oct 09 2018 at 16:10)</a>:</h4>
<p>Yes, I should have a PR up later today.</p>



<a name="135480475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480475" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480475">(Oct 09 2018 at 16:10)</a>:</h4>
<p><span class="user-mention" data-user-id="116118">@Matthew Jasper</span> I was thinking of ripping out the code from <code>relate_tys</code> that tries to figure out the values for canonical values</p>



<a name="135480490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480490" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480490">(Oct 09 2018 at 16:10)</a>:</h4>
<p>and instead just instantiating with "fresh inference variables"</p>



<a name="135480502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480502" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480502">(Oct 09 2018 at 16:10)</a>:</h4>
<p>I think.. at this point... there is no reason not to do that? Ah, well, I guess it might mean I have to make <code>relate_tys</code> able to handle unbound type variables</p>



<a name="135480508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480508" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480508">(Oct 09 2018 at 16:10)</a>:</h4>
<p>but we have the generalization code</p>



<a name="135480548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480548" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480548">(Oct 09 2018 at 16:11)</a>:</h4>
<p>oh I guess we have the ability to "Substitute" into a canonical ty</p>



<a name="135480586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480586" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480586">(Oct 09 2018 at 16:12)</a>:</h4>
<p>I remember now that this was a decent alternative</p>



<a name="135480604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480604" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480604">(Oct 09 2018 at 16:12)</a>:</h4>
<p><span class="user-mention" data-user-id="128294">@blitzerr</span> to elaborate a bit more, the "canonical type" is basically a "type with holes in it" (missing bits) and the values in that vector are the values that go into those holes</p>



<a name="135480626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135480626" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135480626">(Oct 09 2018 at 16:13)</a>:</h4>
<blockquote>
<p>Ah, well, I guess it might mean I have to make <code>relate_tys</code> able to handle unbound type variables</p>
</blockquote>
<p>How would that be different to now?</p>



<a name="135482385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135482385" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135482385">(Oct 09 2018 at 16:45)</a>:</h4>
<p>right now I think it panics</p>



<a name="135482397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135482397" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135482397">(Oct 09 2018 at 16:45)</a>:</h4>
<p>but the logic to handle an unbound type variable would not be particularly different from the logic we are using to handle canonical vars</p>



<a name="135482400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135482400" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135482400">(Oct 09 2018 at 16:45)</a>:</h4>
<p>instead, if we found a canonical var, we would panic</p>



<a name="135493568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493568" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493568">(Oct 09 2018 at 19:45)</a>:</h4>
<p>So, unreachable type annotations get removed from the MIR before we get to borrowck.</p>



<a name="135493748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493748" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493748">(Oct 09 2018 at 19:48)</a>:</h4>
<p>obvious solution 1: keep them around. problem: the RHS of <code>let _: T = ...</code>is a coercion site, so the type annotation applies to what looks like just a local variable only sometimes.</p>



<a name="135493777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493777" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493777">(Oct 09 2018 at 19:49)</a>:</h4>
<p>I am not sure if we really care</p>



<a name="135493787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493787" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493787">(Oct 09 2018 at 19:49)</a>:</h4>
<p>interesting question</p>



<a name="135493791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493791" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493791">(Oct 09 2018 at 19:49)</a>:</h4>
<p>solution 2: only keep around the types and only check wf-ness of them. But this results in this:</p>
<blockquote>
<p>instead, if we found a canonical var, we would panic</p>
</blockquote>



<a name="135493793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493793" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493793">(Oct 09 2018 at 19:49)</a>:</h4>
<p>always hard to tell what to do with dead code for things like this</p>



<a name="135493803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493803" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493803">(Oct 09 2018 at 19:49)</a>:</h4>
<p>solution 3: leave for another PR</p>



<a name="135493908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493908" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493908">(Oct 09 2018 at 19:51)</a>:</h4>
<p>This could be a compiler tests only issue</p>



<a name="135493917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493917" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493917">(Oct 09 2018 at 19:51)</a>:</h4>
<p>i.e., something that won't arise in practice?</p>



<a name="135493929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493929" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493929">(Oct 09 2018 at 19:51)</a>:</h4>
<p>yes</p>



<a name="135493934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493934" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493934">(Oct 09 2018 at 19:51)</a>:</h4>
<p>i'm thinking about it; in general, regions are now a "location-sensitive thing"</p>



<a name="135493994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135493994" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135493994">(Oct 09 2018 at 19:52)</a>:</h4>
<p>e.g., I think that if you have </p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">foo</span><span class="p">;</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span>: <span class="kp">&amp;</span><span class="na">&#39;a</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// foo need not be borrowed here</span>
</pre></div>



<a name="135494000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494000" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494000">(Oct 09 2018 at 19:52)</a>:</h4>
<p>this isn't really true today but hopefully will be with polonius</p>



<a name="135494031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494031" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494031">(Oct 09 2018 at 19:53)</a>:</h4>
<p>so in some sense if the code is dead, you can make a case that the region-oriented parts of the annotation don't "count" -- similar to how we don't really borrow check such code</p>



<a name="135494376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494376" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494376">(Oct 09 2018 at 19:59)</a>:</h4>
<p>Link to the test that I'm try to get working (after enabling compare mode) <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/regions/regions-outlives-projection-container-wc.rs" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/test/ui/regions/regions-outlives-projection-container-wc.rs">https://github.com/rust-lang/rust/blob/master/src/test/ui/regions/regions-outlives-projection-container-wc.rs</a></p>



<a name="135494396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494396" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494396">(Oct 09 2018 at 19:59)</a>:</h4>
<p>yeah, so the code is not reachable...hmm.</p>



<a name="135494401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494401" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494401">(Oct 09 2018 at 19:59)</a>:</h4>
<p>so we do have a version of the type-checker</p>



<a name="135494402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494402" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494402">(Oct 09 2018 at 19:59)</a>:</h4>
<p>er, the MIR</p>



<a name="135494405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494405" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494405">(Oct 09 2018 at 20:00)</a>:</h4>
<p>before dead code is stripped</p>



<a name="135494505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494505" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494505">(Oct 09 2018 at 20:00)</a>:</h4>
<p>but I think running the borrowck on it would be maybe a big change</p>



<a name="135494521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494521" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494521">(Oct 09 2018 at 20:00)</a>:</h4>
<p>otoh there <em>is</em> something annoying about this being accepted</p>



<a name="135494533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494533" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494533">(Oct 09 2018 at 20:01)</a>:</h4>
<p>it doesn't <em>feel</em> like a "flow-sensitive" property</p>



<a name="135494542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494542" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494542">(Oct 09 2018 at 20:01)</a>:</h4>
<blockquote>
<p>solution 2: only keep around the types and only check wf-ness of them. But this results in this:</p>
<blockquote>
<p>instead, if we found a canonical var, we would panic</p>
</blockquote>
</blockquote>
<p>I don't understand what you meant here</p>



<a name="135494616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494616" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494616">(Oct 09 2018 at 20:02)</a>:</h4>
<p>I mean that my attempt at solving this would panic if any types needed to be inferred.</p>



<a name="135494658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494658" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494658">(Oct 09 2018 at 20:03)</a>:</h4>
<p>hmm</p>



<a name="135494673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494673" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494673">(Oct 09 2018 at 20:03)</a>:</h4>
<p>so the user types could involve things like <code>_</code></p>



<a name="135494685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494685" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494685">(Oct 09 2018 at 20:03)</a>:</h4>
<p>the main type-check will have inferred those — modulo regions —</p>



<a name="135494755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494755" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494755">(Oct 09 2018 at 20:04)</a>:</h4>
<p>I guess the question is what you mean by "keep the types around"</p>



<a name="135494763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494763" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494763">(Oct 09 2018 at 20:04)</a>:</h4>
<p>i.e., <em>where</em> would we do so</p>



<a name="135494852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494852" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494852">(Oct 09 2018 at 20:05)</a>:</h4>
<p>So attempt 1 was to preserve the AscribeUserTypes in the simplify cfg pass: this results in surprising behaviour depending on whether the compiler coerces or not</p>



<a name="135494902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494902" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494902">(Oct 09 2018 at 20:06)</a>:</h4>
<p>Attempt 2 was to just keep the canonical types, but then there's nothing to substitute</p>



<a name="135494930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494930" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494930">(Oct 09 2018 at 20:07)</a>:</h4>
<p>yeah, this is what I was pondering</p>



<a name="135494934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494934" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494934">(Oct 09 2018 at 20:07)</a>:</h4>
<p>neither of those really <em>feel right</em></p>



<a name="135494971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494971" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494971">(Oct 09 2018 at 20:07)</a>:</h4>
<p>Indeed</p>



<a name="135494976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494976" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494976">(Oct 09 2018 at 20:07)</a>:</h4>
<p>I guess in the end that it feels like the most consistent option might be to not strip dead code</p>



<a name="135494978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135494978" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135494978">(Oct 09 2018 at 20:07)</a>:</h4>
<p>until after borrow check</p>



<a name="135495021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495021" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495021">(Oct 09 2018 at 20:08)</a>:</h4>
<p>if we wanted to issue errors here</p>



<a name="135495041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495041" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495041">(Oct 09 2018 at 20:08)</a>:</h4>
<p>I'm a bit wary of accepting types that are so clearly not well-formed</p>



<a name="135495060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495060" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495060">(Oct 09 2018 at 20:09)</a>:</h4>
<blockquote>
<p>I guess in the end that it feels like the most consistent option might be to not strip dead code</p>
</blockquote>
<p>I wonder what would break if we tried to do that, feels like a big change</p>



<a name="135495064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495064" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495064">(Oct 09 2018 at 20:09)</a>:</h4>
<p>it sort of requires you to deal with a notion of control-flow graphs that have multiple entry points</p>



<a name="135495070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495070" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495070">(Oct 09 2018 at 20:09)</a>:</h4>
<p>e.g., <em>ideally</em> we would issue errors that are "local" to a dead region</p>



<a name="135495077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495077" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495077">(Oct 09 2018 at 20:09)</a>:</h4>
<p>so something like this:</p>
<div class="codehilite"><pre><span></span><span class="k">return</span><span class="p">;</span><span class="w"></span>

<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
</pre></div>



<a name="135495125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495125" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495125">(Oct 09 2018 at 20:10)</a>:</h4>
<p>seems clearly out of scope for <em>this</em> PR</p>



<a name="135495143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495143" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495143">(Oct 09 2018 at 20:10)</a>:</h4>
<p>There are problems like</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"> </span><span class="c1">// unitialized</span>
</pre></div>



<a name="135495165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495165" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495165">(Oct 09 2018 at 20:11)</a>:</h4>
<p>yep</p>



<a name="135495175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495175" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495175">(Oct 09 2018 at 20:11)</a>:</h4>
<p>it's a big ol' can of worms</p>



<a name="135495192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495192" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495192">(Oct 09 2018 at 20:11)</a>:</h4>
<p>and the same sort of applies to these WF rules, I think</p>



<a name="135495202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495202" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495202">(Oct 09 2018 at 20:11)</a>:</h4>
<p>Fake edges on <code>return/goto</code>?</p>



<a name="135495211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495211" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495211">(Oct 09 2018 at 20:11)</a>:</h4>
<p>no, because that would make borrows extend too long</p>



<a name="135495297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495297" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495297">(Oct 09 2018 at 20:12)</a>:</h4>
<p>I don't really know what set of things you would need</p>



<a name="135495301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495301" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495301">(Oct 09 2018 at 20:12)</a>:</h4>
<p>we decided a while back to just <em>not</em> report borrow check errors in dead code for simplicity</p>



<a name="135495316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495316" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495316">(Oct 09 2018 at 20:13)</a>:</h4>
<p>rightly or wrongly, I feel like backing up on that decision is going to be a major shipping risk :)</p>



<a name="135495329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495329" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495329">(Oct 09 2018 at 20:13)</a>:</h4>
<p>and isn't <em>really</em> an option</p>



<a name="135495337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495337" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495337">(Oct 09 2018 at 20:13)</a>:</h4>
<p>so the question is whether to do something targeted to this WF case</p>



<a name="135495346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495346" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495346">(Oct 09 2018 at 20:13)</a>:</h4>
<p>Yes</p>



<a name="135495357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495357" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495357">(Oct 09 2018 at 20:13)</a>:</h4>
<p>in general, the rules around unreachable code are a kind of "best effort" basis in any case</p>



<a name="135495358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495358" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495358">(Oct 09 2018 at 20:13)</a>:</h4>
<p>(as in that's the question)</p>



<a name="135495451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495451" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495451">(Oct 09 2018 at 20:14)</a>:</h4>
<p>I guess the thing we are baking in here is the idea of things being "Well-formed modulo regions"</p>



<a name="135495473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495473" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495473">(Oct 09 2018 at 20:15)</a>:</h4>
<p>that is, we accept this code, but we wouldn't accept some other variations</p>



<a name="135495491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495491" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495491">(Oct 09 2018 at 20:15)</a>:</h4>
<p>(because the type-checker will catch them early on)</p>



<a name="135495514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495514" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495514">(Oct 09 2018 at 20:15)</a>:</h4>
<p>this is .. probably ok, it's a concept that applies elsewhere, it's just one of the bits of the traits story that I've been wanting to get a better handle on</p>



<a name="135495530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495530" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495530">(Oct 09 2018 at 20:15)</a>:</h4>
<p>I would say that for now you should file the PR without "fixing" this test as is, and file a follow-up issue</p>



<a name="135495583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495583" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495583">(Oct 09 2018 at 20:16)</a>:</h4>
<p>(the test can be modified to avoid <code>loop { }</code>)</p>



<a name="135495598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495598" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495598">(Oct 09 2018 at 20:16)</a>:</h4>
<p>e.g., <code>fn foo&lt;T&gt;() -&gt; T</code></p>



<a name="135495617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495617" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495617">(Oct 09 2018 at 20:16)</a>:</h4>
<p>sound reasonable?</p>



<a name="135495774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135495774" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135495774">(Oct 09 2018 at 20:18)</a>:</h4>
<p>Yes, and borrowck=migrate catches this.</p>



<a name="135496145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135496145" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135496145">(Oct 09 2018 at 20:22)</a>:</h4>
<p>what do you mean by it "catches this"?</p>



<a name="135497002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135497002" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135497002">(Oct 09 2018 at 20:34)</a>:</h4>
<p>It gives an error for <a href="https://github.com/rust-lang/rust/blob/master/src/test/ui/regions/regions-outlives-projection-container-wc.rs" target="_blank" title="https://github.com/rust-lang/rust/blob/master/src/test/ui/regions/regions-outlives-projection-container-wc.rs">https://github.com/rust-lang/rust/blob/master/src/test/ui/regions/regions-outlives-projection-container-wc.rs</a></p>



<a name="135497131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135497131" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135497131">(Oct 09 2018 at 20:36)</a>:</h4>
<p>ah, because we re-enable region errors during migration?</p>



<a name="135497137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135497137" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135497137">(Oct 09 2018 at 20:36)</a>:</h4>
<p>well ok that gives a bit of breathing room I guess</p>



<a name="135501321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135501321" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135501321">(Oct 09 2018 at 21:45)</a>:</h4>
<p><span class="user-mention" data-user-id="116118">@Matthew Jasper</span> can I see your WIP branch too?</p>



<a name="135501324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135501324" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135501324">(Oct 09 2018 at 21:45)</a>:</h4>
<p>and/or do you expect to open a PR soon?</p>



<a name="135501336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135501336" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135501336">(Oct 09 2018 at 21:45)</a>:</h4>
<p>I'll have a PR soon</p>



<a name="135502362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135502362" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135502362">(Oct 09 2018 at 22:04)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/54942" target="_blank" title="https://github.com/rust-lang/rust/issues/54942">#54942</a></p>



<a name="135502901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135502901" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135502901">(Oct 09 2018 at 22:16)</a>:</h4>
<p>cool</p>



<a name="135502905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135502905" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135502905">(Oct 09 2018 at 22:16)</a>:</h4>
<p>gotta run now, took a quick look, pondering a bit</p>



<a name="135503083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135503083" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135503083">(Oct 09 2018 at 22:20)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/54942#pullrequestreview-163117501" target="_blank" title="https://github.com/rust-lang/rust/pull/54942#pullrequestreview-163117501">left a review</a></p>



<a name="135522922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135522922" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135522922">(Oct 10 2018 at 06:54)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>  </p>
<blockquote>
<p><span class="user-mention" data-user-id="128294">@blitzerr</span> to elaborate a bit more, the "canonical type" is basically a "type with holes in it" (missing bits) and the values in that vector are the values that go into those holes</p>
</blockquote>
<p>that part I got. I will look at <span class="user-mention" data-user-id="116118">@Matthew Jasper</span>  's PR to understand it better.</p>



<a name="135522927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135522927" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135522927">(Oct 10 2018 at 06:54)</a>:</h4>
<blockquote>
<p>I guess the thing we are baking in here is the idea of things being "Well-formed modulo regions"</p>
</blockquote>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span>  what did you mean by this ? Also when I tried to read up on regions, I found this  <a href="https://rust-lang-nursery.github.io/rustc-guide/traits/regions.html" target="_blank" title="https://rust-lang-nursery.github.io/rustc-guide/traits/regions.html">https://rust-lang-nursery.github.io/rustc-guide/traits/regions.html</a>. Is there some other doc that I can read to understand the concept and the discussion?</p>



<a name="135538804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135538804" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135538804">(Oct 10 2018 at 12:55)</a>:</h4>
<p><span class="user-mention" data-user-id="128294">@blitzerr</span> "region" is a synonym for "lifetime"</p>



<a name="135538882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135538882" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135538882">(Oct 10 2018 at 12:56)</a>:</h4>
<p><span class="user-mention" data-user-id="116118">@Matthew Jasper</span> did you ever open an issue re: enforcing WF conditions in dead code?</p>



<a name="135538940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135538940" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135538940">(Oct 10 2018 at 12:57)</a>:</h4>
<p><span class="user-mention" data-user-id="128294">@blitzerr</span> what I meant by "well-formed modulo regions": the goal is to eventually have a first type-check that basically "ignores" ("erases") all specific lifetime information. So we don't track if something is <code>&amp;'a u32</code> or <code>&amp;'b u32</code>, just <code>&amp;u32</code>. The results of that type-check are used to build the MIR. Then we run the borrow check. So I said "well-formed modulo regions" because you would get errors if your type is ill-formed in some way that is <em>not</em> dependent on the specific regions involved (<code>'a</code> vs <code>'b</code>) but — if the code is dead code — you would not get errors even if the regions involved were incorrect.</p>



<a name="135543252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135543252" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthew Jasper <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135543252">(Oct 10 2018 at 14:06)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/54943" target="_blank" title="https://github.com/rust-lang/rust/issues/54943">#54943</a></p>



<a name="135543529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135543529" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135543529">(Oct 10 2018 at 14:11)</a>:</h4>
<p><span class="user-mention" data-user-id="116118">@Matthew Jasper</span> great, I was thinking we should <a href="https://github.com/rust-lang/rust/pull/54942#pullrequestreview-163339721" target="_blank" title="https://github.com/rust-lang/rust/pull/54942#pullrequestreview-163339721">add a FIXME into the test case</a></p>



<a name="135548225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/122657-t-compiler/wg-nll/topic/%2354620%20user%20type%20annot%20well-formed/near/135548225" class="zl"><img src="https://rust-lang.github.io/zulip_archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> blitzerr <a href="https://rust-lang.github.io/zulip_archive/stream/122657-t-compiler/wg-nll/topic/.2354620.20user.20type.20annot.20well-formed.html#135548225">(Oct 10 2018 at 15:14)</a>:</h4>
<p>Thanks a lot for explaining <span class="user-mention" data-user-id="116009">@nikomatsakis</span> . Makes sense.</p>



<hr><p>Last updated: Aug 07 2021 at 22:04 UTC</p>
</html>