<html>
<head><meta charset="utf-8"><title>implementing the expect RFC rust#87835 · t-compiler/wg-incr-comp · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/index.html">t-compiler/wg-incr-comp</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/implementing.20the.20expect.20RFC.20rust.2387835.html">implementing the expect RFC rust#87835</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="248963523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/implementing%20the%20expect%20RFC%20rust%2387835/near/248963523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/implementing.20the.20expect.20RFC.20rust.2387835.html#248963523">(Aug 10 2021 at 10:43)</a>:</h4>
<p>Hello, I've got a working implementation of the <code>expect</code> attribute in <a href="https://github.com/rust-lang/rust/issues/87835">rust#87835</a>. The implementation is currently based on an ID that is assigned to each lint expectation when it's discovered in the <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_lint/levels/struct.LintLevelsBuilder.html"><code>LintLevelsBuilder</code></a>. The ID is then stored as part of the new <code>Expect</code> lint level and used to link the diagnostic to the expectation. This works well in test files.</p>
<p>The current implementation creates the expectation ID based on the <code>AttrId</code> of the attribute that the expectation originated from. However, that ID is not stable. I'm now struck on how to create an ID that's stable between compilation sessions. The <code>LintLevelsBuilder</code> is also used during the <code>EarlyLintPass</code> inside <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_lint/context/struct.EarlyContext.html"><code>EarlyContext</code></a> to track the current level for lints during that pass. It would also be a viable option to use the <code>HirId</code> of the item/statement that the attribute is on, but the <code>HirId</code> is not available in the early lint pass (to my knowledge).</p>
<p>Could somebody maybe take a look at the implementation and help me find a stable way to generate an expectation ID?</p>
<hr>
<p>The PR description contains a more detailed explanation about the implementation and as well as reasoning why this ID has to be stable.</p>



<a name="248963621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/implementing%20the%20expect%20RFC%20rust%2387835/near/248963621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/implementing.20the.20expect.20RFC.20rust.2387835.html#248963621">(Aug 10 2021 at 10:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="369415">xFrednet</span> has marked this topic as resolved.</p>



<a name="248963628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/implementing%20the%20expect%20RFC%20rust%2387835/near/248963628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/implementing.20the.20expect.20RFC.20rust.2387835.html#248963628">(Aug 10 2021 at 10:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="369415">xFrednet</span> has marked this topic as unresolved.</p>



<a name="255778417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/implementing%20the%20expect%20RFC%20rust%2387835/near/255778417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/implementing.20the.20expect.20RFC.20rust.2387835.html#255778417">(Oct 01 2021 at 17:20)</a>:</h4>
<p><span class="user-mention" data-user-id="369415">@xFrednet</span> If you can use the <code>HirId</code>, that will be a lot more stable than just the attribute id. (<a href="https://rustc-dev-guide.rust-lang.org/identifiers.html#in-the-hir">https://rustc-dev-guide.rust-lang.org/identifiers.html#in-the-hir</a>)</p>
<p><code>DefId</code> is the most stable but I don't think you have access to those when EarlyLintPasses run.</p>



<a name="262187868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/implementing%20the%20expect%20RFC%20rust%2387835/near/262187868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/implementing.20the.20expect.20RFC.20rust.2387835.html#262187868">(Nov 20 2021 at 15:02)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> , I'm just getting back into working on the <code>expect</code> attribute. The early lint pass operates on the AST and can even be registered to run before the expansion of macros. Is there a way to get the <code>HirId</code> of an AST node? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I couldn't find one the last time I looked into it.</p>



<a name="262187902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/implementing%20the%20expect%20RFC%20rust%2387835/near/262187902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/implementing.20the.20expect.20RFC.20rust.2387835.html#262187902">(Nov 20 2021 at 15:03)</a>:</h4>
<p>I wouldn't expect (heh) there to be one, HirIds aren't stable between compilations and aren't assigned until HIR lowering happens</p>



<a name="262187946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/implementing%20the%20expect%20RFC%20rust%2387835/near/262187946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/implementing.20the.20expect.20RFC.20rust.2387835.html#262187946">(Nov 20 2021 at 15:04)</a>:</h4>
<p>Now I'm considering to have the <code>LintExpectationId</code> as an enum that either holds a <code>AttrId</code> for the early lint pass and then a <code>HirId</code> for the late lint pass. Diagnostics with a <code>AttrId</code> would be updated to a <code>HirId</code> based <code>LintExpectationId</code> once the <code>HirId</code> was determined. I'll experiment a bit more with this idea.</p>



<a name="262187951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/implementing%20the%20expect%20RFC%20rust%2387835/near/262187951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/implementing.20the.20expect.20RFC.20rust.2387835.html#262187951">(Nov 20 2021 at 15:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/implementing.20the.20expect.20RFC.20rust.2387835/near/262187902">said</a>:</p>
<blockquote>
<p>I wouldn't expect (heh) there to be one, HirIds aren't stable between compilations and aren't assigned until HIR lowering happens</p>
</blockquote>
<p>That's also what I thought, thanks :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>