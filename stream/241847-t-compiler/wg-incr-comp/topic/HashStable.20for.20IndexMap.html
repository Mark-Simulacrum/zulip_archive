<html>
<head><meta charset="utf-8"><title>HashStable for IndexMap · t-compiler/wg-incr-comp · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/index.html">t-compiler/wg-incr-comp</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/HashStable.20for.20IndexMap.html">HashStable for IndexMap</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272869695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/HashStable%20for%20IndexMap/near/272869695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/HashStable.20for.20IndexMap.html#272869695">(Feb 22 2022 at 21:33)</a>:</h4>
<p>While working on removing <code>Ord</code> from <code>Defid</code> (see <a href="https://github.com/rust-lang/rust/issues/90317">#90317</a>), I've needed to replace some BTreeMaps with FxHashMaps (since BTree requires type to have <code>Ord</code>). The result it that in a few places that use nested indexmaps, I'm getting:</p>
<div class="codehilite"><pre><span></span><code>error[E0599]: the method `hash_stable` exists for reference `&amp;indexmap::map::IndexMap&lt;SimplifiedTypeGen&lt;rustc_span::def_id::DefId&gt;, Vec&lt;rustc_span::def_id::DefId&gt;, BuildHasherDefault&lt;FxHasher&gt;&gt;`, but its trait bounds were not satisfied
   --&gt; compiler/rustc_middle/src/traits/specialization_graph.rs:86:52
    |
86  |   #[derive(Default, TyEncodable, TyDecodable, Debug, HashStable)]
    |                                                      ^^^^^^^^^^
    |                                                      |
    |                                                      method cannot be called on `&amp;indexmap::map::IndexMap&lt;SimplifiedTypeGen&lt;rustc_span::def_id::DefId&gt;, Vec&lt;rustc_span::def_id::DefId&gt;, BuildHasherDefault&lt;FxHasher&gt;&gt;` due to unsatisfied trait bounds
    |                                                      in this derive macro expansion
    |
   ::: /Users/will/.cargo/registry/src/github.com-1ecc6299db9ec823/indexmap-1.8.0/src/map.rs:71:1
    |
71  |   pub struct IndexMap&lt;K, V, S = RandomState&gt; {
    |   ------------------------------------------ doesn&#39;t satisfy `_: HashStable&lt;_&gt;`
    |
   ::: compiler/rustc_middle/src/ty/fast_reject.rs:21:1
    |
21  | / pub enum SimplifiedTypeGen&lt;D&gt;
22  | | where
23  | |     D: Copy + Debug + Eq,
24  | | {
...   |
48  | |     ParameterSimplifiedType,
49  | | }
    | |_- doesn&#39;t satisfy `_: HashStable&lt;_&gt;`
    |
   ::: /Users/will/.cargo/registry/src/github.com-1ecc6299db9ec823/synstructure-0.12.6/src/macros.rs:94:9
    |
94  | /         pub fn $derives(
95  | |             i: $crate::macros::TokenStream
96  | |         ) -&gt; $crate::macros::TokenStream {
    | |________________________________________- in this expansion of `#[derive(HashStable)]`
    |
    = note: the following trait bounds were not satisfied:
            `SimplifiedTypeGen&lt;rustc_span::def_id::DefId&gt;: HashStable&lt;_&gt;`
            which is required by `indexmap::map::IndexMap&lt;SimplifiedTypeGen&lt;rustc_span::def_id::DefId&gt;, Vec&lt;rustc_span::def_id::DefId&gt;, BuildHasherDefault&lt;FxHasher&gt;&gt;: HashStable&lt;_&gt;`
            `indexmap::map::IndexMap&lt;SimplifiedTypeGen&lt;rustc_span::def_id::DefId&gt;, Vec&lt;rustc_span::def_id::DefId&gt;, BuildHasherDefault&lt;FxHasher&gt;&gt;: HashStable&lt;_&gt;`
            which is required by `&amp;indexmap::map::IndexMap&lt;SimplifiedTypeGen&lt;rustc_span::def_id::DefId&gt;, Vec&lt;rustc_span::def_id::DefId&gt;, BuildHasherDefault&lt;FxHasher&gt;&gt;: HashStable&lt;_&gt;`
note: the following trait must be implemented
   --&gt; /Users/will/repos/rust/compiler/rustc_data_structures/src/stable_hasher.rs:198:1
    |
198 | / pub trait HashStable&lt;CTX&gt; {
199 | |     fn hash_stable(&amp;self, hcx: &amp;mut CTX, hasher: &amp;mut StableHasher);
200 | | }
    | |_^
</code></pre></div>
<p>Is it totally insane to consider implementing HashStable for IndexMap&lt;T,U&gt; where T,U are HashStable? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="272871040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/HashStable%20for%20IndexMap/near/272871040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/HashStable.20for.20IndexMap.html#272871040">(Feb 22 2022 at 21:47)</a>:</h4>
<p>Actually I think I've misunderstood something along the way...</p>



<a name="272871149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/HashStable%20for%20IndexMap/near/272871149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/HashStable.20for.20IndexMap.html#272871149">(Feb 22 2022 at 21:48)</a>:</h4>
<p>Because it's already implemented lol</p>



<a name="272871231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/HashStable%20for%20IndexMap/near/272871231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/HashStable.20for.20IndexMap.html#272871231">(Feb 22 2022 at 21:49)</a>:</h4>
<p>The problem is with <code>ParameterSimplifiedType</code></p>



<a name="272871325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/HashStable%20for%20IndexMap/near/272871325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/HashStable.20for.20IndexMap.html#272871325">(Feb 22 2022 at 21:50)</a>:</h4>
<p>But ah!! <a href="https://doc.rust-lang.org/stable/nightly-rustc/rustc_middle/ty/fast_reject/enum.SimplifiedTypeGen.html#impl-HashStable%3CStableHashingContext%3C%27a%3E%3E">https://doc.rust-lang.org/stable/nightly-rustc/rustc_middle/ty/fast_reject/enum.SimplifiedTypeGen.html#impl-HashStable%3CStableHashingContext%3C%27a%3E%3E</a></p>



<a name="272871633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/HashStable%20for%20IndexMap/near/272871633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/HashStable.20for.20IndexMap.html#272871633">(Feb 22 2022 at 21:53)</a>:</h4>
<p>Ah okay. So _maybe_ this <code>Ord</code> isn't needed <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span> </p>
<div class="codehilite"><pre><span></span><code>impl&lt;&#39;a, D&gt; HashStable&lt;StableHashingContext&lt;&#39;a&gt;&gt; for SimplifiedTypeGen&lt;D&gt; where
    D: Copy + Debug + Ord + Eq + HashStable&lt;StableHashingContext&lt;&#39;a&gt;&gt;,
</code></pre></div>



<a name="272877872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/HashStable%20for%20IndexMap/near/272877872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/HashStable.20for.20IndexMap.html#272877872">(Feb 22 2022 at 22:50)</a>:</h4>
<p>Submitted <a href="https://github.com/rust-lang/rust/pull/94267">https://github.com/rust-lang/rust/pull/94267</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>