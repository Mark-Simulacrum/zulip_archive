<html>
<head><meta charset="utf-8"><title>Removing HashStable from hash maps and btree maps · t-compiler/wg-incr-comp · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/index.html">t-compiler/wg-incr-comp</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Removing.20HashStable.20from.20hash.20maps.20and.20btree.20maps.html">Removing HashStable from hash maps and btree maps</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270183513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Removing%20HashStable%20from%20hash%20maps%20and%20btree%20maps/near/270183513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Removing.20HashStable.20from.20hash.20maps.20and.20btree.20maps.html#270183513">(Feb 01 2022 at 10:23)</a>:</h4>
<p>Taking a note here, this is not a complete proposal and super urgent:</p>
<p>I think it would be a good idea to remove the HashStable impl for collections that store their values in non-deterministic order, such as hash maps and btree maps. These collection types could be replaced by new-type wrappers which don't allow iterating of the entries but expose the rest of the functionality. These wrappers could also have something like a <code>items_in_deterministic_order(&amp;self, cmp: Fn(&amp;K) -&gt; Ordering) -&gt; Vec&lt;(&amp;K, &amp;V)&gt;</code> method that allows to extract the items, if they can be ordered deterministically.</p>



<a name="270195888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Removing%20HashStable%20from%20hash%20maps%20and%20btree%20maps/near/270195888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Removing.20HashStable.20from.20hash.20maps.20and.20btree.20maps.html#270195888">(Feb 01 2022 at 11:54)</a>:</h4>
<blockquote>
<p>These collection types could be replaced by new-type wrappers which don't allow iterating of the entries but expose the rest of the functionality.</p>
</blockquote>
<p>You mean <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_data_structures/stable_map/struct.StableMap.html"><code>StableMap</code></a>?</p>
<blockquote>
<p>These wrappers could also have something like a <code>items_in_deterministic_order(&amp;self, cmp: Fn(&amp;K) -&gt; Ordering) -&gt; Vec&lt;(&amp;K, &amp;V)&gt;</code> method that allows to extract the items, if they can be ordered deterministically.</p>
</blockquote>
<p><code>StableMap</code> has an <code>into_sorted_vector</code> method. It uses the <code>Ord</code> trait instead of a closure though.</p>



<a name="270196992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Removing%20HashStable%20from%20hash%20maps%20and%20btree%20maps/near/270196992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Removing.20HashStable.20from.20hash.20maps.20and.20btree.20maps.html#270196992">(Feb 01 2022 at 12:05)</a>:</h4>
<p>Ah yes, that looks pretty good. That <code>into_sorted_vector</code> simply uses <code>Ord</code> (which does not guarantee determinism across compilation sessions) is problematic. But otherwise that's roughly what I imagined.</p>
<p>The important thing would be to also use it everywhere and disallow using regular hashmaps in query results/query keys.</p>



<a name="270197575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Removing%20HashStable%20from%20hash%20maps%20and%20btree%20maps/near/270197575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Removing.20HashStable.20from.20hash.20maps.20and.20btree.20maps.html#270197575">(Feb 01 2022 at 12:08)</a>:</h4>
<p>See <a href="https://github.com/rust-lang/rust/issues/63713">#63713</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>