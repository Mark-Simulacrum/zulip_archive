<html>
<head><meta charset="utf-8"><title>Stability of source map · t-compiler/wg-incr-comp · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/index.html">t-compiler/wg-incr-comp</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html">Stability of source map</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272001384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272001384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272001384">(Feb 15 2022 at 16:42)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/93967">#93967</a> suggests to use <code>guess_head_span</code> in the implementation of the <code>def_span</code>query. However, I fear that using the source_map may be hazardous for incr. comp. The source text behind a span is not tracked anywhere, only the file name, line &amp; column numbers. As the span may get into the crate metadata, this will also create an ICE in downstream crates.</p>
<p>There are three possibilities:</p>
<ol>
<li>make source_map a (no_hash eval_always) query and hash source tokens as part of the crate hash;</li>
<li>make source_map a (no_hash eval_always) query and compute crate hash from encoded metadata;</li>
<li>forbid accessing the source map outside of diagnostic code (using a delay_span_bug for example);</li>
<li>ignore the problem until someone hits an ICE.</li>
</ol>
<p>I think the most future-proof solution is (2), but it may incur a significant runtime cost.<br>
<span class="user-mention" data-user-id="125294">@Aaron Hill</span> <span class="user-mention" data-user-id="124287">@mw</span> I'd like your opinion on this.</p>



<a name="272011697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272011697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272011697">(Feb 15 2022 at 17:48)</a>:</h4>
<p>The source map is already included in the crate hash I believe.</p>



<a name="272011824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272011824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272011824">(Feb 15 2022 at 17:49)</a>:</h4>
<p>I think 3. makes sense. Accessing the source map pessimizes incremental compilation as every change to the source will cause the respective query to run again.</p>



<a name="272012229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272012229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272012229">(Feb 15 2022 at 17:52)</a>:</h4>
<p>The crate hash contains the source file names, but it does not contain the source contents, does it?</p>



<a name="272012817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272012817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272012817">(Feb 15 2022 at 17:56)</a>:</h4>
<p>you're right. <a href="https://github.com/rust-lang/rust/blob/24b8bb13bff98bb747cd403b86596af43aceee78/compiler/rustc_middle/src/hir/map/mod.rs#L1104">https://github.com/rust-lang/rust/blob/24b8bb13bff98bb747cd403b86596af43aceee78/compiler/rustc_middle/src/hir/map/mod.rs#L1104</a></p>



<a name="272014335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272014335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272014335">(Feb 15 2022 at 18:06)</a>:</h4>
<p>I opened a related issue a while back</p>



<a name="272014375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272014375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272014375">(Feb 15 2022 at 18:06)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/86480">https://github.com/rust-lang/rust/issues/86480</a></p>



<a name="272031569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272031569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272031569">(Feb 15 2022 at 20:13)</a>:</h4>
<p>Is the underlying problem that <code>guess_head_span</code> relies on the string contents of something from the source map (and those string contents are not fingerprinted anywhere)?</p>



<a name="272034055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272034055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272034055">(Feb 15 2022 at 20:34)</a>:</h4>
<p>Yes.</p>



<a name="272034086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272034086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272034086">(Feb 15 2022 at 20:34)</a>:</h4>
<p>This is true for all span manipulation functions that use the source_map, not just guess_head_span.</p>



<a name="272100610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272100610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272100610">(Feb 16 2022 at 10:57)</a>:</h4>
<blockquote>
<p>compute crate hash from encoded metadata;</p>
</blockquote>
<p>Can you elaborate on what you mean by this exactly and how it would solve the problem?</p>



<a name="272142358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272142358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272142358">(Feb 16 2022 at 16:48)</a>:</h4>
<p>There are 2 issues.<br>
Inside one crate, we can force re-evaluation of queries that depend on source_map data by making it a no-hash eval-always query.<br>
Across crates, the query system relies on a foreign crate's <code>crate_hash</code> to know if data should be loaded. At the moment, crate_hash is computed from HIR. As source text is not in HIR, changes to source text will not change chrate_hash, but may still influence guess_head_span. We could compute it from metadata itself (or a sanitized version of it), which would ensure that we never miss anything in metadata.</p>



<a name="272142961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272142961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272142961">(Feb 16 2022 at 16:52)</a>:</h4>
<p>There's an additional issue - guess_head_span for foreign files actually reads from the file on disk, not the crate metadata</p>



<a name="272143244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272143244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272143244">(Feb 16 2022 at 16:54)</a>:</h4>
<p>A hash of each source file is included in the source map as encoded in the crate metadata. That doesn't help with missing or changed source files though as reading the source will fail in that case.</p>



<a name="272235295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272235295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272235295">(Feb 17 2022 at 09:45)</a>:</h4>
<blockquote>
<p>There's an additional issue - guess_head_span for foreign files actually reads from the file on disk, not the crate metadata</p>
</blockquote>
<p>If the crate hash somehow captures any changes that might be relevant for guess_head_span, then that would only be a problem, if we re-compiled a crate without first also re-compiling its dependencies, right?</p>



<a name="272237005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Stability%20of%20source%20map/near/272237005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Stability.20of.20source.20map.html#272237005">(Feb 17 2022 at 10:00)</a>:</h4>
<blockquote>
<p>Inside one crate, we can force re-evaluation of queries that depend on source_map data by making it a no-hash eval-always query.<br>
Yes, it sounds to me like making the source map no_hash + eval_always would take care of the problem inside the current crate.</p>
</blockquote>
<blockquote>
<p>Across crates, ...</p>
</blockquote>
<p>At some point in the past, we computed fingerprints while generating crate metadata. It required quite a bit of additional infrastructure and we removed it because it was a bit of a maintenance burden without providing that much of a benefit. Removing it also solved a few bugs we had then -- but that doesn't mean a new, clean implementation of the same thing would also have to have these problems. A benefit would be that fingerprints for a given crate only have to be computed once instead of every time something is loaded from that crate. A downside is that you have to compute fingerprints for everything in crate metadata, even if that thing is never used downstream.</p>
<p>I'm wondering though: is there a big downside to straight-up including  a hash of all source files in the crate hash? We would get some false positives if  there are only insignificant whitespace changes -- but almost all changes that are likely to happen are significant, right? And the main case, where a crate is recompiled without any change, would be unaffected. If we hash source files, we might even get around hashing the HIR altogether. But maybe I'm missing something.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>