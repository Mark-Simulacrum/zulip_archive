<html>
<head><meta charset="utf-8"><title>Item-relative spans · t-compiler/wg-incr-comp · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/index.html">t-compiler/wg-incr-comp</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html">Item-relative spans</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="236718226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/236718226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#236718226">(Apr 29 2021 at 18:00)</a>:</h4>
<p>I recently submitted <a href="https://github.com/rust-lang/rust/issues/84373">#84373</a>. This PR changes the incr-comp encoding of spans to only encode the position relative to the surrounding definition. This PR unlocks some massive opportunities for incr compilation: up to 25% for cargo-check. More gains will be accessible later to a review of span usage by the MIR optimizer (for instance).</p>
<p>I am looking for a reviewer inside the work-group to evaluate the soundness of the design.</p>



<a name="236718911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/236718911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oliver <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#236718911">(Apr 29 2021 at 18:04)</a>:</h4>
<p>does this affect multithreaded builds?</p>



<a name="236719188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/236719188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#236719188">(Apr 29 2021 at 18:06)</a>:</h4>
<p>Theoretically, yes.</p>



<a name="236719574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/236719574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oliver <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#236719574">(Apr 29 2021 at 18:09)</a>:</h4>
<p>if theoretical then no implementation</p>



<a name="236734612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/236734612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#236734612">(Apr 29 2021 at 19:52)</a>:</h4>
<p>What do you mean?</p>



<a name="236752215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/236752215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oliver <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#236752215">(Apr 29 2021 at 21:42)</a>:</h4>
<p>does this pr actually involve multithreading rustc, or would that be an extension of the pr and this topic?</p>



<a name="236752252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/236752252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oliver <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#236752252">(Apr 29 2021 at 21:42)</a>:</h4>
<p>I think no</p>



<a name="236868157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/236868157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#236868157">(Apr 30 2021 at 17:05)</a>:</h4>
<p>The modification is independent of multithreading, and should apply to both single and multi thread versions equally.</p>



<a name="249994258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/249994258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#249994258">(Aug 19 2021 at 14:26)</a>:</h4>
<p>hi <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <span class="user-mention" data-user-id="124287">@mw</span> and <span class="user-mention" data-user-id="248906">@cjgillot</span></p>



<a name="249994265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/249994265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#249994265">(Aug 19 2021 at 14:26)</a>:</h4>
<p>I figure we can talk discussion of scheduling here</p>



<a name="249994378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/249994378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#249994378">(Aug 19 2021 at 14:27)</a>:</h4>
<p>Aug 20, after the steering meeting works for me</p>



<a name="249994488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/249994488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#249994488">(Aug 19 2021 at 14:28)</a>:</h4>
<p>Before or after the steering meeting works for me.</p>



<a name="249995219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/249995219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#249995219">(Aug 19 2021 at 14:34)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> I didn’t know how to interpret your response on the other thread: did you mean that you had a conflict after the steering meeting? Or that you were available after the steering meeting?</p>



<a name="249995329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/249995329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#249995329">(Aug 19 2021 at 14:34)</a>:</h4>
<p>I am available after the steering meeting.</p>



<a name="249995779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/249995779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#249995779">(Aug 19 2021 at 14:38)</a>:</h4>
<p>okay. i’ll move the event. <span class="user-mention" data-user-id="124287">@mw</span> and <span class="user-mention" data-user-id="248906">@cjgillot</span> , can you privmsg me the appropriate emails to send Google Calendar invites to?</p>



<a name="249995803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/249995803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#249995803">(Aug 19 2021 at 14:38)</a>:</h4>
<p>(or post them here if you don’t mind them being publicly archived.)</p>



<a name="250129604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250129604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250129604">(Aug 20 2021 at 15:03)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <span class="user-mention" data-user-id="124287">@mw</span> and <span class="user-mention" data-user-id="248906">@cjgillot</span> , I forgot to say how we’d conduct the meeting</p>



<a name="250129648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250129648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250129648">(Aug 20 2021 at 15:04)</a>:</h4>
<p>we can do it right here :)</p>



<a name="250129680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250129680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250129680">(Aug 20 2021 at 15:04)</a>:</h4>
<p>sounds great to me</p>



<a name="250129779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250129779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250129779">(Aug 20 2021 at 15:05)</a>:</h4>
<p>so we’re here to discuss <a href="https://github.com/rust-lang/rust/pull/84373">https://github.com/rust-lang/rust/pull/84373</a></p>



<a name="250130016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130016">(Aug 20 2021 at 15:06)</a>:</h4>
<p>regarding testing: <span class="user-mention" data-user-id="124287">@mw</span> , you used to have a test infrastructure that used commit histories as basis for testing incr-comp, right?</p>



<a name="250130142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130142">(Aug 20 2021 at 15:07)</a>:</h4>
<p>I’m sitting here wondering if we could keep long-lived metadata somewhere about what commits in open-source Rust projects successfully compile. (I suppose a lot of them already have that in reports from their CI.) And then use that metadata to drive usage of commit logs</p>



<a name="250130149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130149">(Aug 20 2021 at 15:07)</a>:</h4>
<p>yes, but that was a long time ago</p>



<a name="250130329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130329">(Aug 20 2021 at 15:08)</a>:</h4>
<p>basically, I’m really wondering about generalizing crater to operate on histories</p>



<a name="250130359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130359">(Aug 20 2021 at 15:09)</a>:</h4>
<p>so, you know, that slow thing can be even slower</p>



<a name="250130383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130383">(Aug 20 2021 at 15:09)</a>:</h4>
<p><code>:D</code></p>



<a name="250130426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130426">(Aug 20 2021 at 15:09)</a>:</h4>
<p>I think anything like that is too far off for this PR</p>



<a name="250130435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130435">(Aug 20 2021 at 15:09)</a>:</h4>
<p>Yes that is true</p>



<a name="250130461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130461">(Aug 20 2021 at 15:09)</a>:</h4>
<p>but its a problem that comes up again and again for us</p>



<a name="250130603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130603">(Aug 20 2021 at 15:10)</a>:</h4>
<p>Anyway the point is, for testing, it seems like the options are either: 1. figure out a way to get more automated testing to happen for incr-comp, or 2. get people to opt into using features like this</p>



<a name="250130616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130616">(Aug 20 2021 at 15:10)</a>:</h4>
<p>it would make for a good volunteer project: you don't have to know the compiler or Rust particularly well, just Git and so on</p>



<a name="250130746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130746">(Aug 20 2021 at 15:11)</a>:</h4>
<p>In its current form, the PR is opt-in. I still need to adapt the incr hash tests (which is tedious).</p>



<a name="250130915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130915">(Aug 20 2021 at 15:13)</a>:</h4>
<p>I think ultimately we need both automated and manual testing</p>



<a name="250130925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130925">(Aug 20 2021 at 15:13)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> actually makes a good point, one that <span class="user-mention" data-user-id="124287">@mw</span> already said on the PR: Its behind a <code>-Z</code> flag. The question of “how do we validate this” is a question we can work on answering <em>after we land the PR</em></p>



<a name="250130946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130946">(Aug 20 2021 at 15:13)</a>:</h4>
<p>so we don’t need to get bogged down in that here</p>



<a name="250130974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250130974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250130974">(Aug 20 2021 at 15:13)</a>:</h4>
<p>yes, the fact that it is behind a flag makes it much easier to merge this, I think</p>



<a name="250131028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131028">(Aug 20 2021 at 15:14)</a>:</h4>
<p>Apologies if this was answered in the PR thread but I didn't see it: does the PR affect performance if that flag isn't set? (I assume all of the benchmarks are with the flag enabled?)</p>



<a name="250131090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131090">(Aug 20 2021 at 15:14)</a>:</h4>
<p>however, I'm a bit worried that the approach does not scale to a clean solution</p>



<a name="250131134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131134">(Aug 20 2021 at 15:14)</a>:</h4>
<p>I mean, the implementation is pretty clean within the limits it has to work with</p>



<a name="250131180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131180">(Aug 20 2021 at 15:15)</a>:</h4>
<p>but it needs to add extra hooks to dep tracking</p>



<a name="250131215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131215">(Aug 20 2021 at 15:15)</a>:</h4>
<p>Latest perf with the flag unset features ~1.8% regression for incr-unchanged.</p>



<a name="250131367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131367">(Aug 20 2021 at 15:16)</a>:</h4>
<p>do we know where that comes from?</p>



<a name="250131371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131371">(Aug 20 2021 at 15:16)</a>:</h4>
<p>hmm. Is there a way to guard more stuff with the flag to prevent that?</p>



<a name="250131396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131396">(Aug 20 2021 at 15:16)</a>:</h4>
<p>@mw: what would you consider as a clean solution for spans handling (in general)?</p>



<a name="250131617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131617">(Aug 20 2021 at 15:18)</a>:</h4>
<p>one that does not require a callback into the tracking system</p>



<a name="250131670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131670">(Aug 20 2021 at 15:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250131215">said</a>:</p>
<blockquote>
<p>Latest perf with the flag unset features ~1.8% regression for incr-unchanged.</p>
</blockquote>
<p>is this the same as what <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> was commenting on <a href="https://github.com/rust-lang/rust/pull/84373#issuecomment-859452236">here</a> ?</p>



<a name="250131705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131705">(Aug 20 2021 at 15:18)</a>:</h4>
<p>but I don't want to block work in this area. I don't have time to work on a "clean solution" myself</p>



<a name="250131714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131714">(Aug 20 2021 at 15:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250131371">said</a>:</p>
<blockquote>
<p>hmm. Is there a way to guard more stuff with the flag to prevent that?</p>
</blockquote>
<p>I am not sure. There is the extra test for each span during lowering, and the modification of the span encoding.</p>



<a name="250131739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131739">(Aug 20 2021 at 15:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250131670">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250131215">said</a>:</p>
<blockquote>
<p>Latest perf with the flag unset features ~1.8% regression for incr-unchanged.</p>
</blockquote>
<p>is this the same as what <span class="user-mention silent" data-user-id="123856">Vadim Petrochenkov</span> was commenting on <a href="https://github.com/rust-lang/rust/pull/84373#issuecomment-859452236">here</a> ?</p>
</blockquote>
<p>Yes.</p>



<a name="250131745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131745">(Aug 20 2021 at 15:19)</a>:</h4>
<p>okay</p>



<a name="250131768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131768">(Aug 20 2021 at 15:19)</a>:</h4>
<p>You ask me, I think we should go for it</p>



<a name="250131789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131789">(Aug 20 2021 at 15:19)</a>:</h4>
<p>as in, progress here is worth the ~1.8% hit</p>



<a name="250131815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131815">(Aug 20 2021 at 15:19)</a>:</h4>
<p>the only other option I can imagine</p>



<a name="250131826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131826">(Aug 20 2021 at 15:19)</a>:</h4>
<p>is to dig into what <span class="user-mention" data-user-id="124287">@mw</span> is talking about</p>



<a name="250131831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131831">(Aug 20 2021 at 15:19)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span>, do you know if eddyb's instruction-count based self-profiling already works?</p>



<a name="250131833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131833">(Aug 20 2021 at 15:19)</a>:</h4>
<p>I can make a PR with just the encoding change, to have a comparison baseline.</p>



<a name="250131884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131884">(Aug 20 2021 at 15:20)</a>:</h4>
<p>that might help with pinning down the regression</p>



<a name="250131934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131934">(Aug 20 2021 at 15:20)</a>:</h4>
<p>I'm generally OK with merging this</p>



<a name="250131935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250131935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250131935">(Aug 20 2021 at 15:20)</a>:</h4>
<p>I know they've used it successfully but it's not integrated into rustc yet. I think there's an open PR for that.</p>



<a name="250132016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132016">(Aug 20 2021 at 15:21)</a>:</h4>
<p>we could enable it on nightly for check builds, maybe?</p>



<a name="250132044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132044">(Aug 20 2021 at 15:21)</a>:</h4>
<p>I don't know how much that would help for finding bugs</p>



<a name="250132068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132068">(Aug 20 2021 at 15:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124287">mw</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250132016">said</a>:</p>
<blockquote>
<p>we could enable it on nightly for check builds, maybe?</p>
</blockquote>
<p>you mean in the CI alone?</p>



<a name="250132074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132074">(Aug 20 2021 at 15:21)</a>:</h4>
<p>We can enable it when rustc_bootstrap is set.</p>



<a name="250132081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132081">(Aug 20 2021 at 15:22)</a>:</h4>
<p>but it would be pretty harmless if there is one, right?</p>



<a name="250132155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132155">(Aug 20 2021 at 15:22)</a>:</h4>
<p>I meant in general</p>



<a name="250132180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132180">(Aug 20 2021 at 15:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250132074">said</a>:</p>
<blockquote>
<p>We can enable it when rustc_bootstrap is set.</p>
</blockquote>
<p>The motivation here is that then rustc developers would be trying it out?</p>



<a name="250132185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132185">(Aug 20 2021 at 15:22)</a>:</h4>
<p>but yeah, just for bootstrapping might be an idea too</p>



<a name="250132198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132198">(Aug 20 2021 at 15:22)</a>:</h4>
<p>and presumably would know how to respond if something goes wrong?</p>



<a name="250132212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132212">(Aug 20 2021 at 15:22)</a>:</h4>
<p>That has not always worked well in the past :)</p>



<a name="250132240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132240">(Aug 20 2021 at 15:23)</a>:</h4>
<p>But it is better than nothing</p>



<a name="250132249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132249">(Aug 20 2021 at 15:23)</a>:</h4>
<p>hmm</p>



<a name="250132278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132278">(Aug 20 2021 at 15:23)</a>:</h4>
<p>well, we had this problem of people assuming that incremental in bootstrap doesn't work anyway</p>



<a name="250132299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132299">(Aug 20 2021 at 15:23)</a>:</h4>
<p>and thus we would miss bugs that were already in beta</p>



<a name="250132308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132308">(Aug 20 2021 at 15:23)</a>:</h4>
<p>I feel like there’s potentially something here, e.g. a “surprise me” mode in config.toml that people can use  to opt into being surprised.</p>



<a name="250132417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132417">(Aug 20 2021 at 15:24)</a>:</h4>
<p>We still have an action item to try to improve bootstrap’s handling of incremental</p>



<a name="250132469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132469">(Aug 20 2021 at 15:24)</a>:</h4>
<p>(in terms of doing a better job of reporting to people which ICEs, i.e. from which compiler stages and building which things, represent real bugs that should be reported…)</p>



<a name="250132489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132489">(Aug 20 2021 at 15:25)</a>:</h4>
<p>but anyway</p>



<a name="250132672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132672">(Aug 20 2021 at 15:26)</a>:</h4>
<p>A campaign to encourage rustc devs to use incremental for bootstrap</p>



<a name="250132677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132677">(Aug 20 2021 at 15:26)</a>:</h4>
<p>is something we should look into</p>



<a name="250132807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132807">(Aug 20 2021 at 15:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124287">mw</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250131617">said</a>:</p>
<blockquote>
<p>one that does not require a callback into the tracking system</p>
</blockquote>
<p>I want to come back to this for a moment</p>



<a name="250132850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132850">(Aug 20 2021 at 15:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250132807">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="124287">mw</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250131617">said</a>:</p>
<blockquote>
<p>one that does not require a callback into the tracking system</p>
</blockquote>
<p>I want to come back to this for a moment</p>
</blockquote>
<p>I wholeheartedly agree</p>



<a name="250132872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250132872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250132872">(Aug 20 2021 at 15:28)</a>:</h4>
<p>I see there's also <a href="https://github.com/rust-lang/rust/pull/84762">https://github.com/rust-lang/rust/pull/84762</a> which improves performance for the incr-patch scenarios. Is it likely we'd be able to land that in the next few months or is it still very much "experimental" as the title implies? I'm just trying to gauge the potential wins we're hoping for.</p>



<a name="250133051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133051">(Aug 20 2021 at 15:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250132872">said</a>:</p>
<blockquote>
<p>I see there's also <a href="https://github.com/rust-lang/rust/pull/84762">https://github.com/rust-lang/rust/pull/84762</a> which improves performance for the incr-patch scenarios. Is it likely we'd be able to land that in the next few months or is it still very much "experimental" as the title implies? I'm just trying to gauge the potential wins we're hoping for.</p>
</blockquote>
<p>This is essentially <a href="https://github.com/rust-lang/rust/issues/84373">#84373</a> with the flag set by default.</p>



<a name="250133078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133078">(Aug 20 2021 at 15:29)</a>:</h4>
<p>Oh, I see. Thanks!</p>



<a name="250133279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133279">(Aug 20 2021 at 15:30)</a>:</h4>
<p>(at least it will be once I rebase everything properly)</p>



<a name="250133416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133416">(Aug 20 2021 at 15:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250132850">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250132807">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="124287">mw</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250131617">said</a>:</p>
<blockquote>
<p>one that does not require a callback into the tracking system</p>
</blockquote>
<p>I want to come back to this for a moment</p>
</blockquote>
<p>I wholeheartedly agree</p>
</blockquote>
<p>My general feeling is that the handling of spans already is pretty messy</p>



<a name="250133528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133528">(Aug 20 2021 at 15:32)</a>:</h4>
<p>a lot of that comes from them being generated by the query system exists</p>



<a name="250133529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133529">(Aug 20 2021 at 15:32)</a>:</h4>
<p>My first attempt was to remove spans from the HIR. That was a disaster: large work, with little to no benefit.</p>



<a name="250133605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133605">(Aug 20 2021 at 15:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124287">mw</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250133528">said</a>:</p>
<blockquote>
<p>a lot of that comes from them being generated by the query system exists</p>
</blockquote>
<p>spans are generated by the query system?</p>



<a name="250133655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133655">(Aug 20 2021 at 15:33)</a>:</h4>
<p>sorry, "generated before the query system exists"</p>



<a name="250133665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133665">(Aug 20 2021 at 15:33)</a>:</h4>
<p>oh oh oh</p>



<a name="250133710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133710">(Aug 20 2021 at 15:33)</a>:</h4>
<p>hmm.</p>



<a name="250133799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133799">(Aug 20 2021 at 15:34)</a>:</h4>
<p>I assume it would be a non-starter to have the parser itself depend on the query system</p>



<a name="250133803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133803">(Aug 20 2021 at 15:34)</a>:</h4>
<p>but maybe the PR is already as good as it can get...</p>



<a name="250133849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133849">(Aug 20 2021 at 15:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250133799">said</a>:</p>
<blockquote>
<p>I assume it would be a non-starter to have the parser itself depend on the query system</p>
</blockquote>
<p>This is a 2y project :)</p>



<a name="250133864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133864">(Aug 20 2021 at 15:34)</a>:</h4>
<p>yeah okay</p>



<a name="250133892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250133892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250133892">(Aug 20 2021 at 15:35)</a>:</h4>
<p>so maybe not a non-starter, but not a short term thing</p>



<a name="250134086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134086">(Aug 20 2021 at 15:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250133529">said</a>:</p>
<blockquote>
<p>My first attempt was to remove spans from the HIR. That was a disaster: large work, with little to no benefit.</p>
</blockquote>
<p>It was my hope that that's the solution (IIRC)</p>



<a name="250134122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134122">(Aug 20 2021 at 15:36)</a>:</h4>
<p>but if it doesn't work in practice ...</p>



<a name="250134131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134131">(Aug 20 2021 at 15:36)</a>:</h4>
<p>maybe then we can talk about how that failed</p>



<a name="250134191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134191">(Aug 20 2021 at 15:37)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> do you have a comment somewhere explaining what went wrong there?</p>



<a name="250134348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134348">(Aug 20 2021 at 15:38)</a>:</h4>
<p>okay, it was <a href="https://github.com/rust-lang/rust/pull/72015">https://github.com/rust-lang/rust/pull/72015</a></p>



<a name="250134418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134418">(Aug 20 2021 at 15:38)</a>:</h4>
<p>PR size : +4,244 −3,307<br>
Approximately a rebase every week.<br>
Regressions up to 8%, for improvements up to 12%.</p>



<a name="250134424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134424">(Aug 20 2021 at 15:38)</a>:</h4>
<p>so the performance hit to lowering was huge</p>



<a name="250134452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134452">(Aug 20 2021 at 15:39)</a>:</h4>
<p>or no, you mitigated that</p>



<a name="250134482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134482">(Aug 20 2021 at 15:39)</a>:</h4>
<p>Last perf : <a href="https://github.com/rust-lang/rust/pull/72015#issuecomment-755845433">https://github.com/rust-lang/rust/pull/72015#issuecomment-755845433</a></p>



<a name="250134484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134484">(Aug 20 2021 at 15:39)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/72015#issuecomment-631264342">comment</a>:</p>
<blockquote>
<p>For a very few cases, the query count is lower, and compilation is faster. For the rest, the query count is unchanged, and compilation is slower: it takes more work to get the spans.</p>
</blockquote>



<a name="250134510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134510">(Aug 20 2021 at 15:39)</a>:</h4>
<p>its really interesting</p>



<a name="250134569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134569">(Aug 20 2021 at 15:40)</a>:</h4>
<p>Did that also remove spans from MIR?</p>



<a name="250134584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134584">(Aug 20 2021 at 15:40)</a>:</h4>
<p>so the item-relative span approach doesn’t have as much overhead as the approach you used in PR <a href="https://github.com/rust-lang/rust/issues/72015">#72015</a>?</p>



<a name="250134628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134628">(Aug 20 2021 at 15:40)</a>:</h4>
<p>It did not remove spans from MIR (which should have been a first step).</p>



<a name="250134724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134724">(Aug 20 2021 at 15:41)</a>:</h4>
<p>The new approach does not have a side table for spans, so most of the client code doesn't see a difference. Only diagnostics are affected.</p>



<a name="250134798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134798">(Aug 20 2021 at 15:42)</a>:</h4>
<p>I’d like to ask a hypothetical question, largely targeted at <span class="user-mention" data-user-id="124287">@mw</span> : lets assume, for a moment, that removing spans from the HIR <em>is</em> the right answer, for the long term</p>



<a name="250134884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134884">(Aug 20 2021 at 15:42)</a>:</h4>
<p>do you think that landing PR <a href="https://github.com/rust-lang/rust/issues/84373">#84373</a> (the item-relative span encoding) would be a huge mistake, in terms of technical debt it introduces?</p>



<a name="250134917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134917">(Aug 20 2021 at 15:43)</a>:</h4>
<p>no, I don't think so</p>



<a name="250134940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134940">(Aug 20 2021 at 15:43)</a>:</h4>
<p>(i.e. I’m assuming here that in a year or two someone comes in and figures out a way to rip spans out of HIR anyway)</p>



<a name="250134985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250134985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250134985">(Aug 20 2021 at 15:43)</a>:</h4>
<p>what do you think about that, <span class="user-mention" data-user-id="248906">@cjgillot</span> ?</p>



<a name="250135009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250135009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250135009">(Aug 20 2021 at 15:43)</a>:</h4>
<p>I tend to agree.</p>



<a name="250135145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250135145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250135145">(Aug 20 2021 at 15:44)</a>:</h4>
<p>Okay. My inclination is to push on landing PR <a href="https://github.com/rust-lang/rust/issues/84373">#84373</a>. It does provide a nice benefit (once its turned on). The architecture may not be quite as clean as we would like, but the right answer there might lie with the eventual librarification of the compiler as a whole</p>



<a name="250135308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250135308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250135308">(Aug 20 2021 at 15:46)</a>:</h4>
<p>Okay, great. So, in that case: <span class="user-mention" data-user-id="248906">@cjgillot</span> , you’ll rebase (again, sorry), and I assume either <span class="user-mention" data-user-id="124287">@mw</span> or <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> will take lead on reviewing it?</p>



<a name="250135388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250135388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250135388">(Aug 20 2021 at 15:46)</a>:</h4>
<p>were there any remaining action items for the PR itself, things that needed to be addressed? I didn’t see any.</p>



<a name="250135437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250135437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250135437">(Aug 20 2021 at 15:46)</a>:</h4>
<p>No problem with rebasing. I still have to adapt the incremental tests to test the option.</p>



<a name="250135448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250135448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250135448">(Aug 20 2021 at 15:47)</a>:</h4>
<p>I can do another reviewing pass but it would be great if <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> could also take another look</p>



<a name="250135458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250135458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250135458">(Aug 20 2021 at 15:47)</a>:</h4>
<p>Okay</p>



<a name="250135511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250135511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250135511">(Aug 20 2021 at 15:47)</a>:</h4>
<p>This is great. Thanks so much for you work here <span class="user-mention" data-user-id="248906">@cjgillot</span> . And thanks to <span class="user-mention" data-user-id="124287">@mw</span> and <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> for taking the time to meet about this.</p>



<a name="250135664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250135664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250135664">(Aug 20 2021 at 15:48)</a>:</h4>
<p>(i would love for us to fire up regular wg-incr-comp meetings again, if only on zulip. I think I’ll be in a much better place to plan that in about three weeks or so, once all three of my kids are out of our house going to school.)</p>



<a name="250151998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250151998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250151998">(Aug 20 2021 at 18:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116083">pnkfelix</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/Item-relative.20spans/near/250132469">said</a>:</p>
<blockquote>
<p>(in terms of doing a better job of reporting to people which ICEs, i.e. from which compiler stages and building which things, represent real bugs that should be reported…)</p>
</blockquote>
<p>well, the issue partly that x.py has so many <em>other</em> bugs</p>



<a name="250152101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250152101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250152101">(Aug 20 2021 at 18:02)</a>:</h4>
<p>e.g. I hit <a href="https://github.com/rust-lang/rust/issues/81381">https://github.com/rust-lang/rust/issues/81381</a> pretty regularly until I turned off llvm assertions (<a href="#narrow/stream/182449-t-compiler.2Fhelp/topic/undefined.20reference.20to.20DisableABIBreakingChecks.40LLVM_12">https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/undefined.20reference.20to.20DisableABIBreakingChecks.40LLVM_12</a>)</p>



<a name="250152154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative%20spans/near/250152154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/Item-relative.20spans.html#250152154">(Aug 20 2021 at 18:03)</a>:</h4>
<p>and so people get used to "broken windows"; <span class="user-mention" data-user-id="133169">@matklad</span> was talking about this in the context of rust-analyzer a while ago</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>