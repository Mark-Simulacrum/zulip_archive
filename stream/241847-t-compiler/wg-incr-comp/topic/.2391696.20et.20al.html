<html>
<head><meta charset="utf-8"><title>#91696 et al · t-compiler/wg-incr-comp · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/index.html">t-compiler/wg-incr-comp</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html">#91696 et al</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264991621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/264991621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#264991621">(Dec 15 2021 at 10:50)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="248906">@cjgillot</span> &amp; <span class="user-mention" data-user-id="125294">@Aaron Hill</span>, I just wanted to let you know that I'm also looking into the incr. comp. issues described in <a href="https://github.com/rust-lang/rust/issues/91696">https://github.com/rust-lang/rust/issues/91696</a> and other places. I'm still in the process of trying to understand what exactly is going (i.e. trying to confirm Aaron's analysis). I don't think we should rush to merge a fix before we really understand what's going on (you all might be farther along there than me <code>;)</code>). This seems to be a somewhat fundamental problem in the tracking system and I suspect it will show up again and again if we don't fix it in a clean way.</p>



<a name="264991663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/264991663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#264991663">(Dec 15 2021 at 10:51)</a>:</h4>
<p>The reproducer in <a href="https://github.com/rust-lang/rust/issues/91696#issuecomment-991995520">https://github.com/rust-lang/rust/issues/91696#issuecomment-991995520</a> is invaluable! :D</p>



<a name="265004522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265004522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265004522">(Dec 15 2021 at 12:49)</a>:</h4>
<p>I independently reached the same conclusion as <span class="user-mention" data-user-id="125294">@Aaron Hill</span> did. However, I don't agree with his PR. I think that ignoring all the dependencies edge arising from try_load_from_on_disk_cache_in_memory would be a more permanent solution, which would keep the ability to call queries from the cache decoding facility. This fixes the reproducer, but I still need to double check my reasoning.</p>



<a name="265027100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265027100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265027100">(Dec 15 2021 at 15:36)</a>:</h4>
<p>My concern is that this is a weird form of re-entrance - instead of invoking a query from the body of another query, we're running a new query from within the internal query infrastructure</p>



<a name="265027193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265027193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265027193">(Dec 15 2021 at 15:36)</a>:</h4>
<p>Even if it works now, I think it could lead to problems later on</p>



<a name="265027820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265027820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265027820">(Dec 15 2021 at 15:40)</a>:</h4>
<p>Also, I think ignoring dependencies would only work if the dependency we're adding (query and argument) already exists, right?</p>



<a name="265027985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265027985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265027985">(Dec 15 2021 at 15:41)</a>:</h4>
<p>For example, let's say that someone decided to create a weird query that walks over the entire HIR, and only used that query during decoding</p>



<a name="265028154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265028154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265028154">(Dec 15 2021 at 15:42)</a>:</h4>
<p>I think ignoring that dependency would be incorrect, since the next compilation would re-use the decoded result even if some of its dependencies had changed</p>



<a name="265029157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265029157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265029157">(Dec 15 2021 at 15:49)</a>:</h4>
<p>Let's try to collect some assumptions:</p>
<ul>
<li>Before we load something from the cache we must have been able to mark it green, which means that all dependencies have also been marked green. That does not mean, however, that dependencies have been invoked or loaded from disk -- just their corresponding dep-nodes have been marked green.</li>
<li>For a green dep-node, we expect that invoking the corresponding query would create the exact same dep-graph. That is, we are replaying queries that we already expect to yield the same result.</li>
<li>As a consequence, when we invoke/force a query that is marked green, we don't expect any new nodes or edges to be added to the graph (modulo some weirdness around anonymous nodes). Forcing the query should only encounter nodes that are already green.</li>
</ul>



<a name="265029413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265029413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265029413">(Dec 15 2021 at 15:50)</a>:</h4>
<ul>
<li>The same should be true when loading something from the cache: we expect the corresponding dep-graph portion to already exist and be green -- thus if anything tries to add new edges or nodes, then something is wrong.</li>
</ul>



<a name="265029530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265029530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265029530">(Dec 15 2021 at 15:51)</a>:</h4>
<ul>
<li>But it also means that invoking queries while loading something from the cache should be fine, if that invocation is being done to re-compute a value that is not cached.</li>
</ul>



<a name="265029561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265029561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265029561">(Dec 15 2021 at 15:51)</a>:</h4>
<p>does that sound right?</p>



<a name="265029798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265029798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265029798">(Dec 15 2021 at 15:52)</a>:</h4>
<p>If it does then one thing we could do is setting a "don't allow new nodes or edges and expect all nodes encountered to be already green" flag in the dep-graph while something is being loaded from the cache.</p>



<a name="265029964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265029964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265029964">(Dec 15 2021 at 15:53)</a>:</h4>
<p>I implemented something similar in my PR - it causes a panic on new edges</p>



<a name="265030116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265030116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265030116">(Dec 15 2021 at 15:54)</a>:</h4>
<p>yes, that sounds like something we should do in any case.</p>



<a name="265030346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265030346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265030346">(Dec 15 2021 at 15:55)</a>:</h4>
<p>there's another facet to the problem, that is kind of independent: <span class="user-mention" data-user-id="248906">@cjgillot</span> made mapping from DefPathHash to LocalDefId return an Option.</p>



<a name="265030442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265030442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265030442">(Dec 15 2021 at 15:56)</a>:</h4>
<p>that does make sense when dealing with removed items</p>



<a name="265030601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265030601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265030601">(Dec 15 2021 at 15:57)</a>:</h4>
<p>however, I think we expected that case to never occur because queries should never be invoked for items that have been removed, because we expect another query before that rule such cases out</p>



<a name="265030608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265030608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265030608">(Dec 15 2021 at 15:57)</a>:</h4>
<p>e.g.</p>



<a name="265030836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265030836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265030836">(Dec 15 2021 at 15:58)</a>:</h4>
<p>some query does:</p>
<ol>
<li>get list of valid defids from some eval-always query</li>
<li>invoke for def_id in list_of_valid_defids { some_other_query(def_id) }</li>
</ol>



<a name="265030966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265030966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265030966">(Dec 15 2021 at 15:59)</a>:</h4>
<p>we expect the initial query to be re-executed because the query in step 1 is marked red, and thus step 2 is never invoked for outdated DefIds</p>



<a name="265031053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031053">(Dec 15 2021 at 16:00)</a>:</h4>
<p>That's right - we bail out of marking it green before we try to load a stale defpathhash</p>



<a name="265031152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031152">(Dec 15 2021 at 16:00)</a>:</h4>
<p>We should document that somewhere, if it's not already</p>



<a name="265031161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031161">(Dec 15 2021 at 16:00)</a>:</h4>
<p>the question is: why do we try to force a query for an outdated defid anyway?</p>



<a name="265031264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031264">(Dec 15 2021 at 16:01)</a>:</h4>
<p>is it because of cache loading invalidly introduces a new edge, as your investigation seems to suggest?</p>



<a name="265031305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031305">(Dec 15 2021 at 16:01)</a>:</h4>
<p>I haven't had time to look into that part in any detail</p>



<a name="265031331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031331">(Dec 15 2021 at 16:01)</a>:</h4>
<p>That's what I think. We're using the same TaskDeps when we start to decode</p>



<a name="265031434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031434">(Dec 15 2021 at 16:02)</a>:</h4>
<p>So during the decoding of an intermediate query, any new queries that get invoked by decoding get attached to the ancestor query</p>



<a name="265031502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031502">(Dec 15 2021 at 16:02)</a>:</h4>
<p>So, if we have A -&gt; (decode B) -&gt; C, we end up with an edge A -&gt; C</p>



<a name="265031522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031522">(Dec 15 2021 at 16:02)</a>:</h4>
<p>which would normally never happen</p>



<a name="265031643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031643">(Dec 15 2021 at 16:03)</a>:</h4>
<p>yeah, it sounds like we should introduce a new "tracking mode" for decoding</p>



<a name="265031714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031714">(Dec 15 2021 at 16:04)</a>:</h4>
<p>that basically assert that no new stuff gets added to the dep-graph</p>



<a name="265031740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031740">(Dec 15 2021 at 16:04)</a>:</h4>
<p>it sounds worse than it is :)</p>



<a name="265031757"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031757" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031757">(Dec 15 2021 at 16:04)</a>:</h4>
<p>That's what I was thinking</p>



<a name="265031791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031791">(Dec 15 2021 at 16:04)</a>:</h4>
<p>basically add a check that no invariants are violated</p>



<a name="265031802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031802">(Dec 15 2021 at 16:04)</a>:</h4>
<p>I thought you were going to suggest saving those deps in a new way</p>



<a name="265031875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031875">(Dec 15 2021 at 16:05)</a>:</h4>
<p>From my PR, I only found two violations of that</p>



<a name="265031902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031902">(Dec 15 2021 at 16:05)</a>:</h4>
<p>and opened PRs for each of them</p>



<a name="265031933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031933">(Dec 15 2021 at 16:05)</a>:</h4>
<p>but that mode would allow invoking queries during de-serialization, right?</p>



<a name="265031945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265031945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265031945">(Dec 15 2021 at 16:05)</a>:</h4>
<p>Surprisingly, encoding the full AdtDef is a large perf and size win</p>



<a name="265032059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032059">(Dec 15 2021 at 16:06)</a>:</h4>
<p>that is surprising and we should just do that -- but it would be more of a work-around, right?</p>



<a name="265032102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032102">(Dec 15 2021 at 16:06)</a>:</h4>
<p>Well, that's necessary to pass the check</p>



<a name="265032151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032151">(Dec 15 2021 at 16:06)</a>:</h4>
<p>yes, I'm wondering why that check fails otherwise</p>



<a name="265032158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032158">(Dec 15 2021 at 16:07)</a>:</h4>
<p>Because those were two query executions happening during decoding, which we want to ban</p>



<a name="265032181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032181">(Dec 15 2021 at 16:07)</a>:</h4>
<p>I'm not sure I understand</p>



<a name="265032299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032299">(Dec 15 2021 at 16:08)</a>:</h4>
<p>I don't want to ban query invocations during decoding. I'd like to add assertions that such query invocations conform to the dep-graph the we already allocated while marking things green</p>



<a name="265032402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032402">(Dec 15 2021 at 16:08)</a>:</h4>
<p>does that make sense?</p>



<a name="265032411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032411">(Dec 15 2021 at 16:08)</a>:</h4>
<p>Oh, I see</p>



<a name="265032464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032464">(Dec 15 2021 at 16:08)</a>:</h4>
<p>So, if decoding B invokes query C, then we should already have an identical B-&gt; C edge</p>



<a name="265032488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032488">(Dec 15 2021 at 16:09)</a>:</h4>
<p>yes</p>



<a name="265032528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032528">(Dec 15 2021 at 16:09)</a>:</h4>
<p>I <em>think</em> that's right - the only difficulty is the order</p>



<a name="265032594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032594">(Dec 15 2021 at 16:09)</a>:</h4>
<p>As we said above, we rely on the green-marking bailing out before we reach a stale edge</p>



<a name="265032657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032657">(Dec 15 2021 at 16:10)</a>:</h4>
<p>Is there any way that the edge from decoding could be in the "wrong" place in the edges list?</p>



<a name="265032733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032733">(Dec 15 2021 at 16:10)</a>:</h4>
<p>that's an interesting thought</p>



<a name="265032746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032746">(Dec 15 2021 at 16:10)</a>:</h4>
<p>This is why I wanted to ban queries entirely in decoding - to avoid needing to worry about that kind of problem :)</p>



<a name="265032793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032793">(Dec 15 2021 at 16:11)</a>:</h4>
<p>yeah :)</p>



<a name="265032853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032853">(Dec 15 2021 at 16:11)</a>:</h4>
<p>but we might not need to require decoding to do everything exactly as the original query</p>



<a name="265032950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032950">(Dec 15 2021 at 16:12)</a>:</h4>
<p>That worries me, if we're talking about different invoking different queries</p>



<a name="265032952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265032952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265032952">(Dec 15 2021 at 16:12)</a>:</h4>
<p>intuitively it should be sufficient to check that anything we would add is already there</p>



<a name="265033123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265033123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265033123">(Dec 15 2021 at 16:13)</a>:</h4>
<p>I agree that that makes sense intuitively, but I'm concerned that we might not be thinking of some edge case</p>



<a name="265033178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265033178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265033178">(Dec 15 2021 at 16:13)</a>:</h4>
<p>you're certainly right to be concerned :)</p>



<a name="265033238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265033238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265033238">(Dec 15 2021 at 16:14)</a>:</h4>
<p>From my perspective, there isn't currently a real need for query invocation during decoding</p>



<a name="265033301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265033301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265033301">(Dec 15 2021 at 16:14)</a>:</h4>
<p>We could change the two I identified, and actually get a perf and disk usage win</p>



<a name="265033355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265033355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265033355">(Dec 15 2021 at 16:14)</a>:</h4>
<p>if the need ever arises in the future, we could revisit this</p>



<a name="265033399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265033399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265033399">(Dec 15 2021 at 16:15)</a>:</h4>
<p>But for now, we could take the safe approach of banning any new edges during decoding</p>



<a name="265033438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265033438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265033438">(Dec 15 2021 at 16:15)</a>:</h4>
<p>yeah, I'm just a bit worried that we might not actually understand the problem and are kind of papering over it</p>



<a name="265033685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265033685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265033685">(Dec 15 2021 at 16:16)</a>:</h4>
<p>Meaning the original reproducer?</p>



<a name="265034043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034043">(Dec 15 2021 at 16:18)</a>:</h4>
<p>The reproducer I investigated seems fundamentally relates to query decoding</p>



<a name="265034075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034075">(Dec 15 2021 at 16:18)</a>:</h4>
<p>I mean: we construct a piece of dep-graph during marking, and the we load something from the cache and rely on that being correct without ever encountering that piece of dep-graph again. </p>
<p>If we allowed queries during cache decoding, we would get a chance to verify that things are actually as we expect them</p>



<a name="265034203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034203">(Dec 15 2021 at 16:19)</a>:</h4>
<p>ok, let me try to summarize:</p>



<a name="265034344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034344">(Dec 15 2021 at 16:20)</a>:</h4>
<p>Well, we do have incremental_verify_ich partially turned on for loads from disk</p>



<a name="265034368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034368">(Dec 15 2021 at 16:20)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/blob/22c2d9ddbf356bcdb718e88ca6ee3665e1e42690/compiler/rustc_query_system/src/query/plumbing.rs#L534">https://github.com/rust-lang/rust/blob/22c2d9ddbf356bcdb718e88ca6ee3665e1e42690/compiler/rustc_query_system/src/query/plumbing.rs#L534</a></p>



<a name="265034512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034512">(Dec 15 2021 at 16:21)</a>:</h4>
<p>there are two options:</p>
<ol>
<li><span class="user-mention" data-user-id="125294">@Aaron Hill</span>'s approach of disallowing calling queries during decoding and making sure we don't have to do that by storing a few more things in the cache.</li>
<li><span class="user-mention" data-user-id="248906">@cjgillot</span> approach of not adding any new edges during cache loading -- which I would somewhat  adapt to: also asserting that we would not add anything new to the dep-graph</li>
</ol>



<a name="265034543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034543">(Dec 15 2021 at 16:21)</a>:</h4>
<p>both approaches seem correct to me</p>



<a name="265034630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034630">(Dec 15 2021 at 16:22)</a>:</h4>
<p>I'm a bit surprised that approach (1) does not need more stuff to be added to the cache</p>



<a name="265034751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034751">(Dec 15 2021 at 16:23)</a>:</h4>
<p>Yeah, I was wondering if we're maybe not covering the decoding of all queries in our test cases</p>



<a name="265034766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034766">(Dec 15 2021 at 16:23)</a>:</h4>
<p>However, I did a perf run, which passed</p>



<a name="265034777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034777">(Dec 15 2021 at 16:23)</a>:</h4>
<p>I would have expected the cache to have quite a few "holes" where we need to re-compute instead of load</p>



<a name="265034827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034827">(Dec 15 2021 at 16:23)</a>:</h4>
<p>And the incremental benchmarks should give us a fair amount of coverage</p>



<a name="265034866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034866">(Dec 15 2021 at 16:24)</a>:</h4>
<p>yes, I think so too</p>



<a name="265034870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034870">(Dec 15 2021 at 16:24)</a>:</h4>
<p>Well, this is separate from queries that are not cached on disk</p>



<a name="265034917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034917">(Dec 15 2021 at 16:24)</a>:</h4>
<p>which are pretty common</p>



<a name="265034927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034927">(Dec 15 2021 at 16:24)</a>:</h4>
<p>I wish we had extensive fuzzing from incr. comp. :)</p>



<a name="265034947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034947">(Dec 15 2021 at 16:24)</a>:</h4>
<p>Yeah :)</p>



<a name="265034975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265034975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265034975">(Dec 15 2021 at 16:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/.2391696.20et.20al/near/265034870">said</a>:</p>
<blockquote>
<p>Well, this is separate from queries that are not cached on disk</p>
</blockquote>
<p>in what way?</p>



<a name="265035044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035044">(Dec 15 2021 at 16:25)</a>:</h4>
<p>This is when we encode a query result to disk, but we try to be smart about the encoding process</p>



<a name="265035075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035075">(Dec 15 2021 at 16:25)</a>:</h4>
<p>E.g. encoding an AdtDef just encodes the DefId</p>



<a name="265035134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035134">(Dec 15 2021 at 16:25)</a>:</h4>
<p>and then decoding uses that DefId to invoke a query that reconstructs the value</p>



<a name="265035202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035202">(Dec 15 2021 at 16:26)</a>:</h4>
<p>Doing the "obvious" approach of deriving serialize/deserialize will never do that</p>



<a name="265035208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035208">(Dec 15 2021 at 16:26)</a>:</h4>
<p>yes, I would have thought that we do that in many places</p>



<a name="265035234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035234">(Dec 15 2021 at 16:26)</a>:</h4>
<p>I can check all of the various manual impls</p>



<a name="265035273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035273">(Dec 15 2021 at 16:26)</a>:</h4>
<p>But I think there are limited opportunities for that kind of thing</p>



<a name="265035343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035343">(Dec 15 2021 at 16:27)</a>:</h4>
<p>Considering that the impls are usually shares by the metadata encoding/decoding</p>



<a name="265035378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035378">(Dec 15 2021 at 16:27)</a>:</h4>
<p>I think I can now articulate what I don't like about completely disallowing queries during decoding:<br>
We are actually pretty sure that it should work, but we don't trust our system to be correct enough to handle it</p>



<a name="265035399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035399">(Dec 15 2021 at 16:27)</a>:</h4>
<p>which is kind of "smell"</p>



<a name="265035618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035618">(Dec 15 2021 at 16:29)</a>:</h4>
<p>My view is that it could potentially break in the future if someone introduces a query in decoding that does something "weird"</p>



<a name="265035643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035643">(Dec 15 2021 at 16:29)</a>:</h4>
<p>That is, it might not be possible to correctly handle in all cases</p>



<a name="265035650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035650">(Dec 15 2021 at 16:29)</a>:</h4>
<p>otoh, it looks like we are going to cache ADTs for performance reasons anyway -- leaving us with exactly zero cases that would exercise those code paths :)</p>



<a name="265035671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035671">(Dec 15 2021 at 16:29)</a>:</h4>
<p>But I'm not currently able to come up with anything concrete</p>



<a name="265035725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035725">(Dec 15 2021 at 16:30)</a>:</h4>
<p>could we add assertions that guard against such cases?</p>



<a name="265035770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035770">(Dec 15 2021 at 16:30)</a>:</h4>
<p>Here's the PR by the way: <a href="https://github.com/rust-lang/rust/pull/91924">https://github.com/rust-lang/rust/pull/91924</a></p>



<a name="265035799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035799">(Dec 15 2021 at 16:30)</a>:</h4>
<p>The problem is that I don't know what those cases.might look like :)</p>



<a name="265035803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035803">(Dec 15 2021 at 16:30)</a>:</h4>
<p>disallowing anything new to be added would get us pretty far, I think</p>



<a name="265035815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035815">(Dec 15 2021 at 16:30)</a>:</h4>
<p>Maybe I'm being overly cautious</p>



<a name="265035875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035875">(Dec 15 2021 at 16:30)</a>:</h4>
<p>I completely understand where you are coming from :)</p>



<a name="265035894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265035894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265035894">(Dec 15 2021 at 16:31)</a>:</h4>
<p>But the fingerprint ICEs have been a nightmare to deal with, and I'd like to avoid a repeat of that</p>



<a name="265036145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265036145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265036145">(Dec 15 2021 at 16:32)</a>:</h4>
<p>My view that we should impose the strictest checks we can get away with, and then back then off if a concrete need ever arises</p>



<a name="265036179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265036179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265036179">(Dec 15 2021 at 16:33)</a>:</h4>
<p>E.g. if someone opens a PR that adds a query execution during decoding, and we decide that it's reasonable</p>



<a name="265036270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265036270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265036270">(Dec 15 2021 at 16:33)</a>:</h4>
<p>But enabling the strictest possible checks will let us know if that ever happens, and prevent such a query invocation from slipping in by accident</p>



<a name="265036366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265036366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265036366">(Dec 15 2021 at 16:34)</a>:</h4>
<p>Yes</p>



<a name="265036490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265036490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265036490">(Dec 15 2021 at 16:35)</a>:</h4>
<p>but I also don't want to lose sight of <span class="user-mention" data-user-id="248906">@cjgillot</span> correct discovery that queries invoked during decoding (should we ever allow that) need to happen in a new TaskDeps context</p>



<a name="265036521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265036521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265036521">(Dec 15 2021 at 16:35)</a>:</h4>
<p>or rather an ignore-new-stuff context</p>



<a name="265036555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265036555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265036555">(Dec 15 2021 at 16:35)</a>:</h4>
<p>Yeah, that sounds right</p>



<a name="265036558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265036558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265036558">(Dec 15 2021 at 16:35)</a>:</h4>
<p>but it basically amounts to the same</p>



<a name="265036710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265036710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265036710">(Dec 15 2021 at 16:36)</a>:</h4>
<p>we don't need to decide right now.</p>



<a name="265036744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265036744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265036744">(Dec 15 2021 at 16:36)</a>:</h4>
<p>I do think we have a much better picture of what's going on!</p>



<a name="265036822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265036822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265036822">(Dec 15 2021 at 16:37)</a>:</h4>
<p>it's really awesome to have incr. comp. experts around :)</p>



<a name="265037054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265037054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265037054">(Dec 15 2021 at 16:38)</a>:</h4>
<p>I need to run now. I'll check back in tomorrow. Sleeping on the whole thing sounds like a good idea anyway.</p>



<a name="265037353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265037353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265037353">(Dec 15 2021 at 16:41)</a>:</h4>
<p>So I don't forget: anonymous queries are kind of weird. They might make adding proper assertions more complicated. But it's also possible that handling them correctly is not too hard.</p>



<a name="265051903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265051903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265051903">(Dec 15 2021 at 18:16)</a>:</h4>
<p>I fear I missed the battle. To clarify my position, in the light of your discussion: trying to decode B,</p>
<ul>
<li>queries could be allowed during decoding, for instance to benefit of their cache;</li>
<li>all the queries C invoked during decoding of B must be a (recursive) dependency of B in the previous session;</li>
<li>we know all these C are green because B is green;</li>
<li>we must not create direct dependencies A -&gt; C.</li>
</ul>
<p>I think we have always created those direct dependencies, but we used to create A -&gt; B <em>before</em> A -&gt; C. <a href="https://github.com/rust-lang/rust/issues/78780">#78780</a> changed this order and created our current situation.</p>
<p>I think that:</p>
<ul>
<li>ignoring the A -&gt; C dependencies quring decoding;</li>
<li>asserting that all the queries C are direct (for simplicity) dependencies of B and that they are green is a great idea. A debug-assertion could be a start and avoid more ICEs on stable.</li>
</ul>



<a name="265167339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265167339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265167339">(Dec 16 2021 at 14:57)</a>:</h4>
<p>Great, it looks like we are all roughly on the same page.</p>



<a name="265169244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265169244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265169244">(Dec 16 2021 at 15:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="248906">cjgillot</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/.2391696.20et.20al/near/265051903">said</a>:</p>
<blockquote>
<p>I think that:</p>
<ul>
<li>ignoring the A -&gt; C dependencies quring decoding;</li>
<li>asserting that all the queries C are direct (for simplicity) dependencies of B and that they are green is a great idea. A debug-assertion could be a start and avoid more ICEs on stable.</li>
</ul>
</blockquote>
<p>That sounds good to me. Let me try to re-phrase that a little and you can tell me if that still is what you mean:</p>
<ol>
<li>When we succeed to mark a query B as green, it means that we are allowed to load its result from the cache.</li>
<li>The process of successfully marking query B as green has already "promoted" B's previous dep-graph to the new graph. That is, at that point we already expect B dependency information to already be in place and complete.</li>
<li>Thus, when we load B's value from the cache, any queries that are invoked during that loading are expected to already be green and only introduce dependencies from B's dep-node  to other already green nodes (this is the <code>asserting that all the queries C are direct (for simplicity) dependencies of B and that they are green</code> part, <span class="user-mention" data-user-id="248906">@cjgillot</span>)</li>
<li>Loading B in an A -&gt; B -&gt; C invocation conceptually does <em>not</em> introduce an A -&gt; C edge. Thus when loading B, it starts out in a new context, just as if B was called normally from A (this is the <code>ignoring the A -&gt; C dependencies quring decoding</code> part).</li>
</ol>



<a name="265169329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265169329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265169329">(Dec 16 2021 at 15:09)</a>:</h4>
<p>Also caching ADT's as <span class="user-mention" data-user-id="125294">@Aaron Hill</span> suggested sounds like a good idea.</p>



<a name="265169831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265169831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265169831">(Dec 16 2021 at 15:13)</a>:</h4>
<p>I haven't looked at Aaron's <a href="https://github.com/rust-lang/rust/pull/91924">https://github.com/rust-lang/rust/pull/91924</a> in detail, but I think we can merge that (modulo fixing any problems that show up during review)</p>



<a name="265169923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265169923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265169923">(Dec 16 2021 at 15:13)</a>:</h4>
<p>But I think we should try to get the other stuff (opening a new context during decoding, and adding assertions) before that.</p>



<a name="265171678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265171678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265171678">(Dec 16 2021 at 15:25)</a>:</h4>
<p>I think that strategy mostly alleviates my concerns about potentially introducing new bugs</p>



<a name="265171781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265171781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265171781">(Dec 16 2021 at 15:26)</a>:</h4>
<p>If we're "just" running already green queries that we already have as dependencies,.it's hard to imagine anything going wrong</p>



<a name="265171965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265171965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265171965">(Dec 16 2021 at 15:27)</a>:</h4>
<p>However, if we do decide to merge the AdtDef encoding PR, then we don't have any actual need for this functionality at the moment</p>



<a name="265172028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172028">(Dec 16 2021 at 15:27)</a>:</h4>
<p>And I believe banning all new edges is easier to implement than checking if the edge already exists in the previous session</p>



<a name="265172135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172135">(Dec 16 2021 at 15:28)</a>:</h4>
<p>(and it might be more efficient)</p>



<a name="265172246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172246">(Dec 16 2021 at 15:29)</a>:</h4>
<p>Personally, I think it would be better to implement the simpler strategy, and document the slightly more complex strategy if the need ever arises in the future</p>



<a name="265172250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172250">(Dec 16 2021 at 15:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/.2391696.20et.20al/near/265171965">said</a>:</p>
<blockquote>
<p>However, if we do decide to merge the AdtDef encoding PR, then we don't have any actual need for this functionality at the moment</p>
</blockquote>
<p>Well, that PR still leaves the code in that generates the erroneous A -&gt; C edges, right? It just removes the currently only case that hits that code path</p>



<a name="265172466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172466">(Dec 16 2021 at 15:30)</a>:</h4>
<p>Do you mean the code in the query infrastructure? Yes, we're still re-hsing the same TaskDeps during decoding</p>



<a name="265172494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172494">(Dec 16 2021 at 15:31)</a>:</h4>
<p>yes, that's what I mean</p>



<a name="265172518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172518">(Dec 16 2021 at 15:31)</a>:</h4>
<p>I think that should be fixed in any case</p>



<a name="265172569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172569">(Dec 16 2021 at 15:31)</a>:</h4>
<p>how strict we do assertions is a separate question</p>



<a name="265172577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172577">(Dec 16 2021 at 15:31)</a>:</h4>
<p>But, given that we're going to fix the TaskDeps in any case, I think "ban new edges during decoding" will be simpler to implement than "ban new edges that fail a certain check during decoding"</p>



<a name="265172636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172636">(Dec 16 2021 at 15:32)</a>:</h4>
<p>We could certainly make a PR and compare the implementations</p>



<a name="265172680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172680">(Dec 16 2021 at 15:32)</a>:</h4>
<p>I'd be fine with either option, as long as we document things properly</p>



<a name="265172725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172725">(Dec 16 2021 at 15:32)</a>:</h4>
<p>I'm not sure how complicated the more accurate assertions would be</p>



<a name="265172775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172775">(Dec 16 2021 at 15:32)</a>:</h4>
<p>My overall concern is that the incr comp system is very complex, and "infects" many other parts of the compiler</p>



<a name="265172804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172804">(Dec 16 2021 at 15:33)</a>:</h4>
<p>E.g sorting by DefID leading to miscompilations</p>



<a name="265172846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172846">(Dec 16 2021 at 15:33)</a>:</h4>
<p>So we should try to avoid introducing more complexity unless it's absolutely necessary</p>



<a name="265172908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265172908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265172908">(Dec 16 2021 at 15:33)</a>:</h4>
<p>I didn't even realize that new queries could run during decoding of an existing query, until I investigated that crash</p>



<a name="265173041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265173041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265173041">(Dec 16 2021 at 15:34)</a>:</h4>
<p>In general I agree - in this particular instance I see it more as a case of adding assertions that things conform to the underlying formal model</p>



<a name="265173295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265173295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265173295">(Dec 16 2021 at 15:36)</a>:</h4>
<p>I wished we could pull the incr. comp. system out to be standalone and unit testable :)</p>



<a name="265173419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265173419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265173419">(Dec 16 2021 at 15:37)</a>:</h4>
<p>I think that's <em>more</em> feasible than in the past, thanks to some of <span class="user-mention" data-user-id="248906">@cjgillot</span> 's work</p>



<a name="265173474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265173474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265173474">(Dec 16 2021 at 15:37)</a>:</h4>
<p>E.g. some parts of the system use a trait instead of directly accessing a <code>TyCtxt</code></p>



<a name="265173549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265173549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265173549">(Dec 16 2021 at 15:37)</a>:</h4>
<p>Which is not to say that it would be easy ;)</p>



<a name="265177242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265177242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265177242">(Dec 16 2021 at 16:02)</a>:</h4>
<p>I'd love to take a stab at implementing the more accurate assertion version -- but I don't know when I would find the time for that.</p>



<a name="265177603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265177603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265177603">(Dec 16 2021 at 16:05)</a>:</h4>
<p>It looks like the ADT caching PR is not quite as straightforward as I expected (because of the interning stuff). But if that can be sorted out, and we add a big fat comment on why we ban new edges, I'd be OK with merging <a href="https://github.com/rust-lang/rust/pull/91919">https://github.com/rust-lang/rust/pull/91919</a> as a temporary solution.</p>



<a name="265178525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265178525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265178525">(Dec 16 2021 at 16:11)</a>:</h4>
<p>Just a thought, what happens of the decoded adt_Def and the recompiled one don't agree ? Should we force the adt_Def query to use the on-disk value when it exists ?</p>



<a name="265179508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265179508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265179508">(Dec 16 2021 at 16:18)</a>:</h4>
<p>How could they end up disagreeing?</p>



<a name="265179762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265179762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265179762">(Dec 16 2021 at 16:20)</a>:</h4>
<p>/me is still concerned that the incr system trusts the disk to never get corrupted</p>



<a name="265180274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265180274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265180274">(Dec 16 2021 at 16:24)</a>:</h4>
<p><span class="user-mention" data-user-id="125294">@Aaron Hill</span> I agree they should not, since the adt_Def node must be Green, except for a bug (which could very well happen). Should we debug-assert somewhere before decoding that the depnode has been marked green ?</p>



<a name="265180414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265180414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265180414">(Dec 16 2021 at 16:25)</a>:</h4>
<p>For AdtDef specifically? Ok, that sounds good</p>



<a name="265181254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265181254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265181254">(Dec 16 2021 at 16:31)</a>:</h4>
<p>Stupid question: shouldn't we just remove the adt_Def information from typeck output and tell the query consumer to invoke the query based on adt_Def ?</p>



<a name="265181392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265181392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265181392">(Dec 16 2021 at 16:32)</a>:</h4>
<p>I think it's used during the computation of typeck results</p>



<a name="265181403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265181403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265181403">(Dec 16 2021 at 16:32)</a>:</h4>
<p>But I'll double check</p>



<a name="265183504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265183504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265183504">(Dec 16 2021 at 16:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/.2391696.20et.20al/near/265179762">said</a>:</p>
<blockquote>
<p>/me is still concerned that the incr system trusts the disk to never get corrupted</p>
</blockquote>
<p>it wouldn't be too hard to add a per-entry checksum. it's mostly a performance question.</p>



<a name="265183859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265183859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265183859">(Dec 16 2021 at 16:49)</a>:</h4>
<p>Is AdtDef interned?</p>



<a name="265184022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265184022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265184022">(Dec 16 2021 at 16:50)</a>:</h4>
<p>Yes</p>



<a name="265184485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265184485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265184485">(Dec 16 2021 at 16:54)</a>:</h4>
<p>it would indeed be great if we could make sure that there are no two different AdtDef for the same DefId</p>



<a name="265184810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265184810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265184810">(Dec 16 2021 at 16:56)</a>:</h4>
<p>Do we know what happens to performance if we cache AdtDefs but still invoke the query during decoding? Then the existing fingerprinting infrastructure would take care of consistency checking</p>



<a name="265184957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265184957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265184957">(Dec 16 2021 at 16:57)</a>:</h4>
<p>(of course that only works if we allow queries to be invoked during decoding)</p>



<a name="265185003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185003">(Dec 16 2021 at 16:57)</a>:</h4>
<p>I could investigate that, but this is pretty much the same as decoding any other type</p>



<a name="265185085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185085">(Dec 16 2021 at 16:58)</a>:</h4>
<p>TypeckResults, mir::Body, etc</p>



<a name="265185125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185125">(Dec 16 2021 at 16:58)</a>:</h4>
<p>Where we encode/decode them in the obvious way via a derive</p>



<a name="265185154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185154">(Dec 16 2021 at 16:58)</a>:</h4>
<p>yeah, I suspect that it would perform about the same as when decoding directly</p>



<a name="265185238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185238">(Dec 16 2021 at 16:59)</a>:</h4>
<p>What's the point of caching things on disk, then?</p>



<a name="265185439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185439">(Dec 16 2021 at 17:00)</a>:</h4>
<p>Also, wait</p>



<a name="265185467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185467">(Dec 16 2021 at 17:00)</a>:</h4>
<p>that we would go through the query and thus be inside the regular system that already does consistency checks (but still get the performance boost you found)</p>



<a name="265185542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185542">(Dec 16 2021 at 17:00)</a>:</h4>
<p>Caching the result on disk but keeping the existing decoding scheme is pretty much identical to what we're doing now</p>



<a name="265185580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185580">(Dec 16 2021 at 17:01)</a>:</h4>
<p>Since forcing the query uses the stored DefPathHash to re-run the query</p>



<a name="265185648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185648">(Dec 16 2021 at 17:01)</a>:</h4>
<p>And "caching" the encoded DefId (using the current encoding impl) is basically just the same thing</p>



<a name="265185728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185728">(Dec 16 2021 at 17:02)</a>:</h4>
<p>In both cases, we re-run the adt_ded query with a DefId</p>



<a name="265185819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185819">(Dec 16 2021 at 17:02)</a>:</h4>
<p>All of the performance benefit is current coming from being able to decodr an AdtDef directly when it ends in the metadata or the result of another query</p>



<a name="265185825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185825">(Dec 16 2021 at 17:02)</a>:</h4>
<p>yes, but it would hit the cache instead of re-compute (which might run other queries transitively) and thus might be faster</p>



<a name="265185863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185863">(Dec 16 2021 at 17:03)</a>:</h4>
<p>I don't understand</p>



<a name="265185916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185916">(Dec 16 2021 at 17:03)</a>:</h4>
<p>Are you talking about leaving the existing encoding impl for AdtDef the same?</p>



<a name="265185918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265185918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265185918">(Dec 16 2021 at 17:03)</a>:</h4>
<p>re-computing the AdtDef might be more expensive than loading it from the cache</p>



<a name="265186037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265186037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265186037">(Dec 16 2021 at 17:04)</a>:</h4>
<p>/me takes a look at the changes again ...</p>



<a name="265186074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265186074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265186074">(Dec 16 2021 at 17:04)</a>:</h4>
<p>I think we're talking about two different things here</p>



<a name="265186194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265186194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265186194">(Dec 16 2021 at 17:05)</a>:</h4>
<p>The current situation: Whenever we need to encode an AdtDef (when it occurs in the metadata, or inside the type of a query result that we <em>do</em> cache on disk), we write out a DefId</p>



<a name="265186376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265186376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265186376">(Dec 16 2021 at 17:06)</a>:</h4>
<p>When we need to decode it, we load that DefId, and re-run the AdtDef query. This gives us some automatic caching (the query result will get saved in the in-memory cache, since we only run a query once for a given input)</p>



<a name="265186447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265186447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265186447">(Dec 16 2021 at 17:06)</a>:</h4>
<p>My PR benchmark results come from encoding the full AdtDef to disk (recursively encoding all of the struct fields to disk)</p>



<a name="265186477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265186477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265186477">(Dec 16 2021 at 17:06)</a>:</h4>
<p>That yielded a large performance improvement</p>



<a name="265186633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265186633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265186633">(Dec 16 2021 at 17:08)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> suggested that I additionally cache the result of the <code>adt_def</code> query on disk. This would not affect decoding of other query results, but it would affect cases where some code explicitly calls <code>adt_def</code></p>



<a name="265186718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265186718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265186718">(Dec 16 2021 at 17:08)</a>:</h4>
<p>However, that caused a failure, and I still need to investigate and fix it so that I can get benchmark results</p>



<a name="265186836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265186836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265186836">(Dec 16 2021 at 17:09)</a>:</h4>
<p>This is complicated :)</p>



<a name="265186934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265186934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265186934">(Dec 16 2021 at 17:10)</a>:</h4>
<p>Yeah - that's why I was concerned about performing any queue invocations during decoding :)</p>



<a name="265186968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265186968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265186968">(Dec 16 2021 at 17:10)</a>:</h4>
<p>it would kind of make sense to only store a DefId in structs where we have an AdtDef now so other code has to go through the query</p>



<a name="265187033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265187033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265187033">(Dec 16 2021 at 17:10)</a>:</h4>
<p>You mean, refactor the code to no longer store an AdtDef?</p>



<a name="265187037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265187037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265187037">(Dec 16 2021 at 17:10)</a>:</h4>
<p>and then cache the adt_def query</p>



<a name="265187082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265187082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265187082">(Dec 16 2021 at 17:11)</a>:</h4>
<p>probably not a small change</p>



<a name="265187127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265187127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265187127">(Dec 16 2021 at 17:11)</a>:</h4>
<p>I think the main user is <code>TyKind</code>, which uses it to actually define the ADT</p>



<a name="265187142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265187142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265187142">(Dec 16 2021 at 17:11)</a>:</h4>
<p>but how AdtDef is handled right now is indeed a bit weird</p>



<a name="265187204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265187204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265187204">(Dec 16 2021 at 17:12)</a>:</h4>
<p>yeah, that does not seem like a straightforward refactoring</p>



<a name="265187462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265187462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265187462">(Dec 16 2021 at 17:13)</a>:</h4>
<p>I'll try to fix the error in the current PR, and see how it affects benchmark results</p>



<a name="265188414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265188414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265188414">(Dec 16 2021 at 17:21)</a>:</h4>
<p>OK</p>



<a name="265189443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265189443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265189443">(Dec 16 2021 at 17:28)</a>:</h4>
<p>(maybe removing the direct AdtDef value from TyKind wouldn't be that hard after all? I only get 5 matches for the string <code>TyKind::Adt(</code>...)</p>



<a name="265207717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265207717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265207717">(Dec 16 2021 at 19:31)</a>:</h4>
<p>In light of this discussion, I think we should indeed ban using queries during decoding as Aaron sugested.  No datatype should need to decode needs another query's result.  TyKind::Adt should store the DefId.  Code which needs the full AdtDef would be responsible for calling adt_def query.  Likewise for any other query and datatype.  This would (1) simplify our life, (2) decode less stuff we probably won't use, (3) reduce query invalidations.</p>



<a name="265219474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265219474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265219474">(Dec 16 2021 at 21:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124287">mw</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/.2391696.20et.20al/near/265189443">said</a>:</p>
<blockquote>
<p>(maybe removing the direct AdtDef value from TyKind wouldn't be that hard after all? I only get 5 matches for the string <code>TyKind::Adt(</code>...)</p>
</blockquote>
<p>I've trying this out locally - there appears to be a very large number of usages (over 50)</p>



<a name="265219497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265219497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265219497">(Dec 16 2021 at 21:05)</a>:</h4>
<p>Most of them are <code>ty::Adt</code>, not <code>TyKind::Adt</code></p>



<a name="265219536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265219536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265219536">(Dec 16 2021 at 21:05)</a>:</h4>
<p>and many places will require us to pass in a <code>TyCtxt</code> to existing methods, so that we can look up information from the <code>AdtDef</code></p>



<a name="265235691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265235691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265235691">(Dec 16 2021 at 23:38)</a>:</h4>
<p>I think this isn't worth the effort for now (but I may revisit it later)</p>



<a name="265302147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265302147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265302147">(Dec 17 2021 at 14:29)</a>:</h4>
<blockquote>
<p>How could they end up disagreeing?</p>
</blockquote>
<p>The decoded value does not go through <code>incremental_verify_ich</code>. Should it?</p>



<a name="265303497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265303497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265303497">(Dec 17 2021 at 14:39)</a>:</h4>
<p>We do verify a subset of decoded results unconditionally: <a href="https://github.com/rust-lang/rust/blob/2595d038273a4c7746320efd06200764f99bd760/compiler/rustc_query_system/src/query/plumbing.rs#L527-L539">https://github.com/rust-lang/rust/blob/2595d038273a4c7746320efd06200764f99bd760/compiler/rustc_query_system/src/query/plumbing.rs#L527-L539</a></p>



<a name="265303785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265303785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265303785">(Dec 17 2021 at 14:41)</a>:</h4>
<p>but that might not cover the error case here where various different query results might contain an AdtDef for the same DefId. We will end up only using one of them (because of interning) but we don't verify that they all agree.</p>



<a name="265303890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265303890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265303890">(Dec 17 2021 at 14:42)</a>:</h4>
<p>but the same is true for any other value that is encoded by value inside of a query result -- so I'm not sure how to think about this</p>



<a name="265304161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265304161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265304161">(Dec 17 2021 at 14:44)</a>:</h4>
<p>we could add some additional verification that debug_asserts equality at the point of interning? might be a good idea because the current interning infrastructure seems a bit fragile to me.</p>



<a name="265544531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265544531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265544531">(Dec 20 2021 at 10:25)</a>:</h4>
<p>I approved <a href="https://github.com/rust-lang/rust/pull/91924">https://github.com/rust-lang/rust/pull/91924</a> just now. I agree with Aaron that merging <a href="https://github.com/rust-lang/rust/pull/91919">https://github.com/rust-lang/rust/pull/91919</a> sooner rather than later is a good idea.</p>



<a name="265544745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265544745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265544745">(Dec 20 2021 at 10:27)</a>:</h4>
<p>I just saw you assigned yourself to <a href="https://github.com/rust-lang/rust/issues/91924">#91924</a>, <span class="user-mention" data-user-id="248906">@cjgillot</span>. I hope you don't mind my approving the PR.</p>



<a name="265546711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%2391696%20et%20al/near/265546711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.2391696.20et.20al.html#265546711">(Dec 20 2021 at 10:47)</a>:</h4>
<p>Please go ahead. I won't have time to take a detailed look, and I agree we shouldn't delay this PR.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>