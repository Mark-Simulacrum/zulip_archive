<html>
<head><meta charset="utf-8"><title>`def_ident_span` incr ICE #95945 · t-compiler/wg-incr-comp · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/index.html">t-compiler/wg-incr-comp</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.60def_ident_span.60.20incr.20ICE.20.2395945.html">`def_ident_span` incr ICE #95945</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278707878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%60def_ident_span%60%20incr%20ICE%20%2395945/near/278707878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.60def_ident_span.60.20incr.20ICE.20.2395945.html#278707878">(Apr 12 2022 at 15:16)</a>:</h4>
<p>just FYI there's another recent incremental ICE on stable for <code>def_ident_span</code>, tracked in <a href="https://github.com/rust-lang/rust/issues/95945">#95945</a></p>
<p>I've bisected it to <a href="https://github.com/rust-lang/rust/issues/93095">#93095</a> (and pinged the author and reviewer) but it's unclear to me whether this is an ICE from the PR itself, or a variation on what the PR wanted to fix</p>



<a name="278712515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%60def_ident_span%60%20incr%20ICE%20%2395945/near/278712515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.60def_ident_span.60.20incr.20ICE.20.2395945.html#278712515">(Apr 12 2022 at 15:51)</a>:</h4>
<p>I'll take a look today</p>



<a name="278725000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%60def_ident_span%60%20incr%20ICE%20%2395945/near/278725000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.60def_ident_span.60.20incr.20ICE.20.2395945.html#278725000">(Apr 12 2022 at 17:27)</a>:</h4>
<p>Found the issue - we're skipping hashing the <code>Ident</code> span in several manual <code>HashStable</code> impls: <a href="https://github.com/rust-lang/rust/blob/327caac4d01aef74d6577b87c295270608be09fa/compiler/rustc_hir/src/stable_hash_impls.rs#L157">https://github.com/rust-lang/rust/blob/327caac4d01aef74d6577b87c295270608be09fa/compiler/rustc_hir/src/stable_hash_impls.rs#L157</a></p>



<a name="278725105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%60def_ident_span%60%20incr%20ICE%20%2395945/near/278725105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.60def_ident_span.60.20incr.20ICE.20.2395945.html#278725105">(Apr 12 2022 at 17:28)</a>:</h4>
<p>I knew what I was looking for, but it still took me a few read-throughs to notice that when I was examining the impl</p>



<a name="278725140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%60def_ident_span%60%20incr%20ICE%20%2395945/near/278725140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.60def_ident_span.60.20incr.20ICE.20.2395945.html#278725140">(Apr 12 2022 at 17:28)</a>:</h4>
<p>yet another case of manual hashstable impls causing problems :/</p>



<a name="278725436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%60def_ident_span%60%20incr%20ICE%20%2395945/near/278725436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.60def_ident_span.60.20incr.20ICE.20.2395945.html#278725436">(Apr 12 2022 at 17:31)</a>:</h4>
<p>We <em>do</em> currently hash the span of the item itself. Usually, both the item ident span and the item span will be changed at the same time. When macros are involved, though, we can end up with two completely different spans, only one of which may change between sessions</p>



<a name="278733674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%60def_ident_span%60%20incr%20ICE%20%2395945/near/278733674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.60def_ident_span.60.20incr.20ICE.20.2395945.html#278733674">(Apr 12 2022 at 18:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125294">Aaron Hill</span> <a href="#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/.60def_ident_span.60.20incr.20ICE.20.2395945/near/278725000">said</a>:</p>
<blockquote>
<p>Found the issue - we're skipping hashing the <code>Ident</code> span in several manual <code>HashStable</code> impls: <a href="https://github.com/rust-lang/rust/blob/327caac4d01aef74d6577b87c295270608be09fa/compiler/rustc_hir/src/stable_hash_impls.rs#L157">https://github.com/rust-lang/rust/blob/327caac4d01aef74d6577b87c295270608be09fa/compiler/rustc_hir/src/stable_hash_impls.rs#L157</a></p>
</blockquote>
<p>I wonder if we could/should address this by adding some derive-style proc macro machinery that lets you enumerate the fields <em>to skip</em></p>



<a name="278734295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%60def_ident_span%60%20incr%20ICE%20%2395945/near/278734295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.60def_ident_span.60.20incr.20ICE.20.2395945.html#278734295">(Apr 12 2022 at 18:33)</a>:</h4>
<p>We already have <code>#[stable_hasher(ignore)]</code>.</p>



<a name="278734523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/%60def_ident_span%60%20incr%20ICE%20%2395945/near/278734523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cjgillot <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/.60def_ident_span.60.20incr.20ICE.20.2395945.html#278734523">(Apr 12 2022 at 18:35)</a>:</h4>
<p>This impl is manual because it setups <code>NodeIdHashingMode</code>.  <a href="https://github.com/rust-lang/rust/issues/95656">#95656</a> suggests to remove that.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>