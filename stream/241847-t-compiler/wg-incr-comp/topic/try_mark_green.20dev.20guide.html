<html>
<head><meta charset="utf-8"><title>try_mark_green dev guide · t-compiler/wg-incr-comp · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/index.html">t-compiler/wg-incr-comp</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green.20dev.20guide.html">try_mark_green dev guide</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="254067746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green%20dev%20guide/near/254067746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green.20dev.20guide.html#254067746">(Sep 20 2021 at 15:26)</a>:</h4>
<p>Rustc Dev Guide explains the basic algorithm in the following way ...</p>



<a name="254067784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green%20dev%20guide/near/254067784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green.20dev.20guide.html#254067784">(Sep 20 2021 at 15:26)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Try-mark-green works as follows:

- First check if the query Q was executed during the previous compilation.
  - If not, we can just re-execute the query as normal, and assign it the
    color of red.
- If yes, then load the &#39;dependent queries&#39; of Q.
- If there is a saved result, then we load the `reads(Q)` vector from the
  query DAG. The &quot;reads&quot; is the set of queries that Q executed during
  its execution.
  - For each query R in `reads(Q)`, we recursively demand the color
    of R using try-mark-green.
    - Note: it is important that we visit each node in `reads(Q)` in same order
      as they occurred in the original compilation. See [the section on the
      query DAG below](#dag).
    - If **any** of the nodes in `reads(Q)` wind up colored **red**, then Q is
      dirty.
      - We re-execute Q and compare the hash of its result to the hash of the
        result from the previous compilation.
      - If the hash has not changed, we can mark Q as **green** and return.
    - Otherwise, **all** of the nodes in `reads(Q)` must be **green**. In that
      case, we can color Q as **green** and return.
</code></pre></div>



<a name="254067980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green%20dev%20guide/near/254067980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green.20dev.20guide.html#254067980">(Sep 20 2021 at 15:27)</a>:</h4>
<p>but it's missing what happens near the end when one or more <code>reads(Q)</code> are red if we re-execute query <code>Q</code> and the hash has changed</p>



<a name="254068114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green%20dev%20guide/near/254068114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green.20dev.20guide.html#254068114">(Sep 20 2021 at 15:28)</a>:</h4>
<p>I guess it should just say that Q is red and that we store the hash of the new result and maybe the result too (depending on how the query is configured)</p>



<a name="254069306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green%20dev%20guide/near/254069306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green.20dev.20guide.html#254069306">(Sep 20 2021 at 15:36)</a>:</h4>
<p>if I'm not wrong that's this part of the code <a href="https://github.com/rust-lang/rust/blob/497ee321af3b8496eaccd7af7b437f18bab81abf/compiler/rustc_query_system/src/dep_graph/graph.rs#L552-L562">https://github.com/rust-lang/rust/blob/497ee321af3b8496eaccd7af7b437f18bab81abf/compiler/rustc_query_system/src/dep_graph/graph.rs#L552-L562</a></p>



<a name="254069535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green%20dev%20guide/near/254069535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/241847-t-compiler/wg-incr-comp/topic/try_mark_green.20dev.20guide.html#254069535">(Sep 20 2021 at 15:37)</a>:</h4>
<p>so yeah, maybe saying that once you find one of such cases there's no need to keep checking for the rest of the dependencies and you can just re-execute Q, mark as red and store it's hash</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>