<html>
<head><meta charset="utf-8"><title>cargo-geiger Migrating to clap · wg-cli · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/index.html">wg-cli</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html">cargo-geiger Migrating to clap</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="267147775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267147775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267147775">(Jan 07 2022 at 03:34)</a>:</h4>
<p>Hi lovelies - so you know cargo-geiger is migrating to clap as part of de-coupling and it might provide some reference later. Might be helpful for you <span class="user-mention" data-user-id="424212">@Ed Page</span>  too :)<br>
<a href="https://github.com/rust-secure-code/cargo-geiger/issues/226">https://github.com/rust-secure-code/cargo-geiger/issues/226</a><br>
<a href="https://github.com/rust-secure-code/cargo-geiger/discussions/244">https://github.com/rust-secure-code/cargo-geiger/discussions/244</a></p>



<a name="267148518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267148518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267148518">(Jan 07 2022 at 03:50)</a>:</h4>
<p>Thanks for the heads up!</p>



<a name="267148558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267148558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267148558">(Jan 07 2022 at 03:51)</a>:</h4>
<p>I think I'm missing some context. What is the decoupling? Are you removing <code>cargo</code> as a dependency? How can we help?</p>



<a name="267148577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267148577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267148577">(Jan 07 2022 at 03:51)</a>:</h4>
<p>yup that's the plan - getting rid of it :) <br>
<a href="https://github.com/rust-secure-code/cargo-geiger/issues/241">https://github.com/rust-secure-code/cargo-geiger/issues/241</a></p>



<a name="267148643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267148643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267148643">(Jan 07 2022 at 03:52)</a>:</h4>
<p>help would be very welcome - consulting around opts use - I am planning to use clap-cargo, escargot and cla-verbosity - we already use cargo_metadata</p>



<a name="267148759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267148759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267148759">(Jan 07 2022 at 03:54)</a>:</h4>
<p>I am proposing the following pattern for 0.12.0 cargo-geiger</p>
<p>cargo geiger build -- should do build deps</p>
<p>cargo geiger test -- should do test deps</p>
<p>cargo geiger run -- should do runtime deps</p>
<p>cargo geiger scan -- Scan only</p>
<p>Cargo opts would be passed on to cargo transparently</p>



<a name="267150145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267150145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267150145">(Jan 07 2022 at 04:23)</a>:</h4>
<p><span class="user-mention" data-user-id="424212">@Ed Page</span> this example doesn't work it is complaining about missing trait impl<br>
<a href="https://github.com/crate-ci/clap-cargo/blob/master/examples/flags.rs">https://github.com/crate-ci/clap-cargo/blob/master/examples/flags.rs</a></p>
<p>error[E0277]: the trait bound <code>clap_cargo::Workspace: clap::Args</code> is not satisfied<br>
  --&gt; cargo-geiger/src/args.rs:25:12<br>
   |<br>
25 |     #[clap(flatten)]<br>
   |            ^^^^^^^ the trait <code>clap::Args</code> is not implemented for <code>clap_cargo::Workspace</code></p>
<p>If I give it clap::Args then there is conflicting impl</p>
<p>error[E0119]: conflicting implementations of trait <code>clap::Args</code> for type <code>args::CargoArgs</code><br>
  --&gt; cargo-geiger/src/args.rs:21:25<br>
   |<br>
21 | #[derive(Debug, Parser, clap::Args)]<br>
   |                 ------  ^^^^^^^^^^ conflicting implementation for <code>args::CargoArgs</code><br>
   |                 |<br>
   |                 first implementation here</p>



<a name="267154721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267154721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267154721">(Jan 07 2022 at 06:04)</a>:</h4>
<p>the derive is brilliant...</p>



<a name="267154859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267154859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267154859">(Jan 07 2022 at 06:06)</a>:</h4>
<p>Now it would be nice if I can discover all cargo build etc. options and then transparently (cargo version relevant) mirror them without writing a piece of line and then intercept opportunistically (try_fetch_opt) from generated opts.... hmm?</p>



<a name="267189482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267189482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267189482">(Jan 07 2022 at 13:37)</a>:</h4>
<p><code>test</code> sounds similar to <code>--tests</code><br>
<code>run</code> sounds similar to <code>--lib</code> and <code>--bins</code></p>
<p>What about using those and inventing a <code>--build</code>?</p>



<a name="267189871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267189871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267189871">(Jan 07 2022 at 13:41)</a>:</h4>
<blockquote>
<p>Now it would be nice if I can discover all cargo build etc. options and then transparently (cargo version relevant) mirror them without writing a piece of line and then intercept opportunistically (try_fetch_opt) from generated opts.... hmm?</p>
</blockquote>
<p>You want to automatically forward arguments to some underlying cargo command?  Something like <a href="https://github.com/clap-rs/clap/issues/1404">partial parsing</a> would help once implemented.  Until then, I don't think there is a good way to do it.  Even then, it can be questionable unless the underlying command fits perfectly to your purpose.  You also wouldn't get <code>--help</code> for it.</p>



<a name="267243190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267243190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267243190">(Jan 07 2022 at 21:09)</a>:</h4>
<p>Well I could get --help if the cargo arg/opts are "discoverable" and there is a mapping template off them - e.g. an utility that digs the supported arguments from current rustup/cargo on $PATH</p>



<a name="267243321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267243321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267243321">(Jan 07 2022 at 21:10)</a>:</h4>
<p>I still have to build the target if the user hasn't supplied thigns so I want to mirror cargo args/opts as-is and passthru them and behaving like cargo whilst injecting analyzer on top</p>



<a name="267243443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267243443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267243443">(Jan 07 2022 at 21:12)</a>:</h4>
<p>I could even in worst case passthru cargo error if the flags on cargo don't match f.ex. if I need to invoke build leading the argument parsing completely to cargo and then do a naive and dumb regular expression at top replacing the binary name :D</p>



<a name="267244203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267244203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267244203">(Jan 07 2022 at 21:19)</a>:</h4>
<p>I would have thought there was some functionality on last where you can pass -- &lt;EVERYTHING&gt; or even worst case wrap it -cargo "cargo_flags"</p>



<a name="267261005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/220302-wg-cli/topic/cargo-geiger%20Migrating%20to%20clap/near/267261005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pinkforest(she/her) <a href="https://zulip-archive.rust-lang.org/stream/220302-wg-cli/topic/cargo-geiger.20Migrating.20to.20clap.html#267261005">(Jan 08 2022 at 00:08)</a>:</h4>
<p>on derive's what is the preferred way to reduce duplication of clap-cargo items on Subcommand derive e.g. </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Subcommand)]</span><span class="w"></span>
<span class="cp">#[clap(setting(AppSettings::DeriveDisplayOrder))]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">GeigerCommands</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Geiger with build tree</span>
<span class="w">    </span><span class="n">Build</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[clap(flatten)]</span><span class="w"></span>
<span class="w">        </span><span class="n">workspace</span>: <span class="nc">clap_cargo</span>::<span class="n">Workspace</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="sd">/// Geiger with test tree</span>
<span class="w">    </span><span class="n">Test</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cp">#[clap(flatten)]</span><span class="w"></span>
<span class="w">        </span><span class="n">workspace</span>: <span class="nc">clap_cargo</span>::<span class="n">Workspace</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>How do I use global() with clap-cargo items under subcomand enum? I can use them with regular arguments but flatten can't use it with clap(global(true)) due to:</p>
<div class="codehilite"><pre><span></span><code>error: methods are not allowed for flattened entry
  --&gt; cargo-geiger/src/args.rs:62:16
   |
62 |         #[clap(flatten, global(true))]
   |                ^^^^^^^
</code></pre></div>
<p>If I try to use em without flatten - I tried to search doc for flatten which obviously provides FromStr?</p>
<div class="codehilite"><pre><span></span><code>62  |         #[clap(global(true))]
    |         ^ the trait `FromStr` is not implemented for `clap_cargo::Features`
</code></pre></div>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>