<html>
<head><meta charset="utf-8"><title>Blog post on completion IO systems and BufRead trait · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html">Blog post on completion IO systems and BufRead trait</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275397205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275397205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275397205">(Mar 15 2022 at 16:24)</a>:</h4>
<p>A thread for discussion. <a href="https://www.ncameron.org/blog/async-io-with-completion-model-io-systems/">https://www.ncameron.org/blog/async-io-with-completion-model-io-systems/</a></p>



<a name="275397477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275397477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275397477">(Mar 15 2022 at 16:26)</a>:</h4>
<p>I'm curious what people think about the options here. I guess we want an async::BufRead trait in any case, so the big question is whether we want to support owned-buffer reads <em>as well</em>. I'll note that that seems to be the preference amongst implementers, but it would mean further divergence from the sync traits. If we want to support that, the next question is about whether to add another trait of more functionality to <code>async::Read</code>.</p>



<a name="275462776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275462776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sashanoraa (any/all) <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275462776">(Mar 16 2022 at 03:10)</a>:</h4>
<p>My WIP library currently supports both owned-buffers and a managed buffer pool at the choice of the user.</p>



<a name="275462859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275462859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sashanoraa (any/all) <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275462859">(Mar 16 2022 at 03:12)</a>:</h4>
<p>I personally think non-cancellable futures would be a really nice way to resolve this, but I understand that's probably one of the harder solutions for a lang prospective.</p>



<a name="275462893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275462893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sashanoraa (any/all) <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275462893">(Mar 16 2022 at 03:13)</a>:</h4>
<p>Maybe a broader abstraction could be some kinda of non-droppable types? So you could express which states are droppable and which aren't through a type transition.</p>



<a name="275565336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275565336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275565336">(Mar 16 2022 at 19:27)</a>:</h4>
<p>Do completion-based IO systems normally provide a way to do cancellation?</p>



<a name="275565412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275565412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275565412">(Mar 16 2022 at 19:28)</a>:</h4>
<p>If so, it seems like in the <code>Drop</code> impl for the async IO future it could include a call to the OS to cancel the IO, at least as long as the OS-provided cancel API is synchronous.</p>



<a name="275565508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275565508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275565508">(Mar 16 2022 at 19:28)</a>:</h4>
<p>Although I'm guessing for the OS to safely implement synchronous cancellation then that would negate most of the benefits of async IO...</p>



<a name="275565818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275565818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275565818">(Mar 16 2022 at 19:32)</a>:</h4>
<p>I believe the is provided cancellation is always async and that you have to keep the buffer alive until either the cancellation or the original io completes</p>



<a name="275565952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275565952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275565952">(Mar 16 2022 at 19:33)</a>:</h4>
<p>Even with sync cancellation, there's no way of guaranteeing that the destructor is run</p>



<a name="275566332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275566332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275566332">(Mar 16 2022 at 19:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="363998">Ibraheem Ahmed</span> <a href="#narrow/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait/near/275565952">said</a>:</p>
<blockquote>
<p>Even with sync cancellation, there's no way of guaranteeing that the destructor is run</p>
</blockquote>
<p>True, although it seems like then we also wouldn't free the backing buffer so there wouldn't be a risk of use-after-free when the IO finally completes (unless you stack allocated the buffer....)</p>



<a name="275566483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275566483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275566483">(Mar 16 2022 at 19:38)</a>:</h4>
<p>Anyway, I don't think "hoping the buffer leaks too" is a good strategy for avoiding UB here.</p>



<a name="275566610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275566610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275566610">(Mar 16 2022 at 19:39)</a>:</h4>
<p>How do we solve this problem in the face of panics?</p>



<a name="275572039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275572039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275572039">(Mar 16 2022 at 20:21)</a>:</h4>
<p>The buffer could be elsewhere and is borrowed for the io. In which case it would be dropped even if the other dtor is not called</p>



<a name="275572048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%20on%20completion%20IO%20systems%20and%20BufRead%20trait/near/275572048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.20on.20completion.20IO.20systems.20and.20BufRead.20trait.html#275572048">(Mar 16 2022 at 20:21)</a>:</h4>
<p>*owned elsewhere</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>