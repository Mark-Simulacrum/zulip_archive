<html>
<head><meta charset="utf-8"><title>Lifetime bounds on -&gt; impl Trait · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html">Lifetime bounds on -&gt; impl Trait</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274758717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274758717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274758717">(Mar 09 2022 at 22:02)</a>:</h4>
<p>I just saw <a href="#narrow/stream/122651-general/topic/Specifying.20lifetime.20bounds.20in.20async.20closures">this thread</a> on #general and thought I'd highlight it here too. I know I've hit this issue before. Will any of the work around RPITIT or RPITIDT apply here too?</p>



<a name="274760234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274760234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Parrill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274760234">(Mar 09 2022 at 22:15)</a>:</h4>
<p>I don't think <code>type_alias_impl_trait</code> will help. Using as a return type in a generic or impl doesn't count as a defining use. <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=5d7864eb93c4cfe4bfa55a0c376c78a7">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=5d7864eb93c4cfe4bfa55a0c376c78a7</a></p>
<p>Seems like the crux of the issue is that HRTBs can only apply to one bound. Passing a generic closure requires two bounds: one for the future return type and one for the closure itself, and the two need to share a lifetime.</p>
<p>Like:</p>
<div class="codehilite"><pre><span></span><code>fn read_modify_write&lt;Fut, F&gt;(mut cb: F)
where
    F: for&lt;&#39;a&gt; FnMut(&amp;&#39;a Server) -&gt; Fut,
    Fut: Future + &#39;a_from_above_somehow
{ ... }
</code></pre></div>



<a name="274760429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274760429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274760429">(Mar 09 2022 at 22:16)</a>:</h4>
<p>It'd be nice if we could do something like </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">read_modify_write</span><span class="o">&lt;</span><span class="n">Fut</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">cb</span>: <span class="nc">F</span><span class="p">)</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">F</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">Server</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Fut</span>::<span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">Fut</span>: <span class="nc">for</span><span class="o">&lt;'</span><span class="na">b</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">b</span><span class="w"></span>
<span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274788225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274788225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274788225">(Mar 10 2022 at 04:26)</a>:</h4>
<p>you can kinda do that like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(unboxed_closures)]</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">read_modify_write</span><span class="o">&lt;</span><span class="n">Fut</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">cb</span>: <span class="nc">F</span><span class="p">)</span><span class="w"></span>
<span class="k">where</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">F</span>: <span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">Server</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">F</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">Server</span><span class="p">)</span><span class="o">&gt;</span>::<span class="n">Output</span>: <span class="nc">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XXX</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="p">,</span><span class="w"></span>
<span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274788330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274788330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274788330">(Mar 10 2022 at 04:28)</a>:</h4>
<p>but that won't typecheck because rust is not smart enough.</p>
<p>Seems the issue is bounds on higher-ranked associated types don't work in general. There's quite a few issues open, closest is maybe <a href="https://github.com/rust-lang/rust/issues/23481">#23481</a> . Seems it's blocked on "lazy normalization": <a href="https://github.com/rust-lang/rust/issues/60471">#60471</a></p>



<a name="274788404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274788404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274788404">(Mar 10 2022 at 04:30)</a>:</h4>
<p>I had to battle this recently and ended up giving up</p>



<a name="274788497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274788497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274788497">(Mar 10 2022 at 04:32)</a>:</h4>
<p>it's one of the biggest async papercuts right now imo. There's simply no way to do "async closures" that borrow stuff. It's quite common to run into this when trying to convert code to async.</p>



<a name="274840612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274840612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274840612">(Mar 10 2022 at 14:19)</a>:</h4>
<p>I can amend <a href="https://docs.rs/higher-order-closure">https://docs.rs/higher-order-closure</a> to also handle <code>async</code> closures like expected, by using <code>Box</code>ing on stable, and some unstable features on nightly / opt-in. I'll probably release that as an <code>async-closure</code>crate or somenthing like that, and then have <code>higher-order-closure</code> reexport it.</p>



<a name="274840651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274840651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274840651">(Mar 10 2022 at 14:19)</a>:</h4>
<p>But if I had to guess, I'd say that's the main reason <code>async |…|</code> syntax is unstable? It would have to cover this?</p>



<a name="274855993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274855993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274855993">(Mar 10 2022 at 16:04)</a>:</h4>
<p>you can do <code>|...| async { ... }</code> on stable, which is just a regular closure returning an <code>async{}</code> block.</p>



<a name="274856060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274856060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274856060">(Mar 10 2022 at 16:05)</a>:</h4>
<p>(I'm not sure what advantages would <code>async |..|</code> have over that, I think they desugar to the same..?)</p>



<a name="274856587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274856587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274856587">(Mar 10 2022 at 16:08)</a>:</h4>
<p>I took a look at <code>higher-order-closure</code>, but I can't see how to use it for this. It'd need doing <code>FnMut(..) -&gt; impl Future + 'a</code> which is not allowed.</p>



<a name="274874718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274874718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274874718">(Mar 10 2022 at 18:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait/near/274840651">said</a>:</p>
<blockquote>
<p>But if I had to guess, I'd say that's the main reason <code>async |…|</code> syntax is unstable? It would have to cover this?</p>
</blockquote>
<p>I think covering this case is one of the primary asks for async closures</p>



<a name="274874899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274874899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274874899">(Mar 10 2022 at 18:19)</a>:</h4>
<p><span class="user-mention" data-user-id="421986">@eholk</span> for the problem in the general topic, I think you can make an ad-hoc trait that captures the constraints, but then you may hit this: <a href="https://github.com/rust-lang/rust/issues/70263">https://github.com/rust-lang/rust/issues/70263</a></p>



<a name="274877893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Lifetime%20bounds%20on%20-%3E%20impl%20Trait/near/274877893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Parrill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Lifetime.20bounds.20on.20-.3E.20impl.20Trait.html#274877893">(Mar 10 2022 at 18:42)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> for the problem in the general topic, I think you can make an ad-hoc trait that captures the constraints, but then you may hit this: <a href="https://github.com/rust-lang/rust/issues/70263">https://github.com/rust-lang/rust/issues/70263</a></p>
</blockquote>
<p>Yeah, I linked to that in the #general thread.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>