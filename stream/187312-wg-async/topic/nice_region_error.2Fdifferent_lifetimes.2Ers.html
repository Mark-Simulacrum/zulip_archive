<html>
<head><meta charset="utf-8"><title>nice_region_error/different_lifetimes.rs · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html">nice_region_error/different_lifetimes.rs</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255431296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255431296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255431296">(Sep 29 2021 at 16:39)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="257428">@Gus Wynn</span>, can I pick your brain sometime about <code>different_lifetimes.rs</code>? I was looking at it yesterday in connection with my polish bug for this sprint, and it looks like you <a href="https://github.com/rust-lang/rust/commit/20e032e65007ff1376e8480c1fbdb0a5068028fa#diff-20107dce5d641d88411894eb3d35764f7e37d2f99b7c9b6adb30834f47741985">most recently changed</a> the code in question, so I wanted to make sure I'm reading it right.</p>



<a name="255431334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255431334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255431334">(Sep 29 2021 at 16:40)</a>:</h4>
<p>(now's not good for me, but I should have time later)</p>



<a name="255434978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255434978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255434978">(Sep 29 2021 at 17:00)</a>:</h4>
<p>I'm not an expert at regions or region errors, but I might be able to help! just message when you have time and ill try to get to it</p>



<a name="255472308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255472308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255472308">(Sep 29 2021 at 20:52)</a>:</h4>
<p>Okay, <span class="user-mention" data-user-id="257428">@Gus Wynn</span> - I'm coming back to this now. I'll go ahead and post my questions and whenever you have the chance to reply is fine.</p>



<a name="255472438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255472438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255472438">(Sep 29 2021 at 20:53)</a>:</h4>
<p>So I'm working on <a href="https://github.com/rust-lang/rust/issues/74256">#74256</a>, which is an issue where in the error message for</p>
<div class="codehilite"><pre><span></span><code>    async fn async_fn(self: &amp;Struct, f: &amp;u32) -&gt; &amp;u32 {
        f
    }
</code></pre></div>
<p>the compiler highlights the <code>&amp;Struct</code> when the <code>&amp;u32</code> is really what should be highlighted.</p>



<a name="255473208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255473208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255473208">(Sep 29 2021 at 20:58)</a>:</h4>
<p>So it seems like it might be a single character fix: <a href="https://github.com/rust-lang/rust/pull/89375/files">https://github.com/rust-lang/rust/pull/89375/files</a></p>



<a name="255473552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255473552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255473552">(Sep 29 2021 at 21:00)</a>:</h4>
<p>But that also changes the output from a few other tests, including the ones you added in that change. I spot checked a couple of them (I'll go through them in more depth), and in general I think the new behavior is better for the existing tests too, but I just want a second opinion on whether what I'm doing makes sense here.</p>



<a name="255485339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255485339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255485339">(Sep 29 2021 at 22:23)</a>:</h4>
<p>Oh I remember not quite understanding the difference between sup and sub, its more that possible that I chose the wrong one for the diagnostic. My understanding is that they are basically the mismatched regions (lifetimes), so maybe either makes sense?</p>
<p>can you push what other changes it causes?</p>



<a name="255485503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255485503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255485503">(Sep 29 2021 at 22:24)</a>:</h4>
<p>also, definitely worth tagging esteban on the pr tho</p>



<a name="255488736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255488736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255488736">(Sep 29 2021 at 22:54)</a>:</h4>
<p>I added some more comments <a href="https://github.com/rust-lang/rust/issues/74256#issuecomment-930581911">here</a>. I think fixing should actually involve more than just highlighting a different parameter. I think including some more information would help.</p>



<a name="255488822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255488822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255488822">(Sep 29 2021 at 22:55)</a>:</h4>
<p>I just updated the draft PR with the other stderr file changes that I thought looked okay. The ui/regions/regions-free-region-ordering-callee.rs test is one that changes and I think the current behavior is better though.</p>



<a name="255494550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255494550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255494550">(Sep 29 2021 at 23:54)</a>:</h4>
<p>oooh pointing out that its borrowed from self woudl be nice</p>



<a name="255495035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255495035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255495035">(Sep 29 2021 at 23:59)</a>:</h4>
<div class="codehilite"><pre><span></span><code>LL |     async fn a(self: Pin&lt;&amp;Foo&gt;, f: &amp;Foo) -&gt; &amp;Foo { f }
   |                                    ----     ----   ^ ...but data from `f` is held across an await point here
   |                                    |        |
   |                                    |        this `async fn` implicitly returns an `impl Future&lt;Output = &amp;Foo&gt;`
   |                                    this parameter and the returned future are declared with different lifetimes...
</code></pre></div>
<p>so in this one, which used to point to self, it was saying that the self parameter, which is what it's trying to borrow from, does not match the actual lifetime of the return type, which is the Foo parameter</p>
<p>honestly I feel that that is more clear, IF we point out that the fact that we are eliding that the return type is supposed to borrow from <code>self</code><br>
this also, vaguely makes sense, as we are changing from pointing out the sub type to pointing out the super type, where sub (elided return type) ! &lt;= sup (the actual lifetime we are returning) I THINK</p>
<p>on fn, non-method cases, I am not sure whats more clear, for example, not sure whats happening in <code>async-await/issue-76547.stderr</code></p>
<p>do other, non-async borrowing ui tests change as well?</p>



<a name="255593220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255593220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255593220">(Sep 30 2021 at 15:24)</a>:</h4>
<p>it is VERY curious that this is so much better in the sync case, without any changes: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=03ba654fc9d6b5d1aa6c544a8d8451d8">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=03ba654fc9d6b5d1aa6c544a8d8451d8</a></p>



<a name="255600358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255600358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255600358">(Sep 30 2021 at 16:07)</a>:</h4>
<p>Yeah, the suggestion for an explicit lifetime would be really nice to have in the async case.</p>



<a name="255603564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255603564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255603564">(Sep 30 2021 at 16:26)</a>:</h4>
<p>its very, very curious to me that async and sync are working differently here, its probably because we are 1 more layer deep in the soup, as its not the return type that borrow from &amp;Foo, its the inside of the Future returned, but I am not sure</p>



<a name="255603752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255603752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255603752">(Sep 30 2021 at 16:27)</a>:</h4>
<p>Oh yeah, maybe so. Today I'll dig into where the explicit lifetime suggestion comes from.</p>



<a name="255603891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255603891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255603891">(Sep 30 2021 at 16:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/nice_region_error.2Fdifferent_lifetimes.2Ers/near/255603752">said</a>:</p>
<blockquote>
<p>Oh yeah, maybe so. Today I'll dig into where the explicit lifetime suggestion comes from.</p>
</blockquote>
<p><a href="https://twitter.com/guswynn/status/1435328358745710592?s=20">https://twitter.com/guswynn/status/1435328358745710592?s=20</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/guswynn/status/1435328358745710592?s=20"><img class="twitter-avatar" src="https://uploads.zulipusercontent.net/4659dcbdb5fa72e151a4d1435512b187172e7cca/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f3838353032383935343635383237313233322f32657237686359685f6e6f726d616c2e6a7067"></a><p>my workflow for how to figure out how things work in rustc: 1. make a rust playground that errors/warns about the thing I'm interested in 2. copy the error output and use rg to find where in rustc the diagnostic happens</p><span>- g̶͇̻̀ū̵̯͙͎́s̷̙͉̥̓͒͠ (@guswynn)</span></div></div>



<a name="255603957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/nice_region_error/different_lifetimes.rs/near/255603957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/nice_region_error.2Fdifferent_lifetimes.2Ers.html#255603957">(Sep 30 2021 at 16:28)</a>:</h4>
<p>I've been trying to steal that workflow!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>