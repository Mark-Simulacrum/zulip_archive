<html>
<head><meta charset="utf-8"><title>&quot;recorded types from MIR&quot; PR #65782 · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html">&quot;recorded types from MIR&quot; PR #65782</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="183192274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192274">(Dec 11 2019 at 19:30)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="125294">@Aaron Hill</span>  -- I've been looking over PR <a href="https://github.com/rust-lang/rust/issues/65782" target="_blank" title="https://github.com/rust-lang/rust/issues/65782">#65782</a>, do you want to chat about it soon-ish as we discussed?</p>



<a name="183192291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192291">(Dec 11 2019 at 19:30)</a>:</h4>
<p>Sure!</p>



<a name="183192305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192305">(Dec 11 2019 at 19:30)</a>:</h4>
<p>Actually I've mostly been pondering the main comment, I've not really looked at the code yet =)</p>



<a name="183192395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192395">(Dec 11 2019 at 19:31)</a>:</h4>
<p>There are essentially two parts:<br>
1) Delaying the processing of generator-related obligations until mir typeck/borrowck<br>
2) Changing how 'constituent tyoes' are defined for GeneratorWitness</p>



<a name="183192424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192424">(Dec 11 2019 at 19:31)</a>:</h4>
<p>Can you say a bit more about 2?</p>



<a name="183192430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192430">(Dec 11 2019 at 19:31)</a>:</h4>
<p>I'm mostly thinking about 1</p>



<a name="183192433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192433">(Dec 11 2019 at 19:31)</a>:</h4>
<p>I think the first part might actually be the more complicated part, since it involves changes to both typeck, TraitEngine/SelectionContext, and mir typeck/borrowck</p>



<a name="183192442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192442">(Dec 11 2019 at 19:31)</a>:</h4>
<p>sure</p>



<a name="183192488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192488">(Dec 11 2019 at 19:32)</a>:</h4>
<p>How I understood from the PR <em>description</em> is something like</p>



<a name="183192504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192504">(Dec 11 2019 at 19:32)</a>:</h4>
<ul>
<li>when we have to prove <code>G: Send</code> for some generator interior <code>G</code></li>
</ul>



<a name="183192516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192516">(Dec 11 2019 at 19:32)</a>:</h4>
<p>we record that for posterity and just assume it's true</p>



<a name="183192529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192529">(Dec 11 2019 at 19:32)</a>:</h4>
<p>(perhaps in some "special mode")</p>



<a name="183192547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192547">(Dec 11 2019 at 19:32)</a>:</h4>
<p>then later in MIR code, we go and prove for real</p>



<a name="183192558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192558">(Dec 11 2019 at 19:32)</a>:</h4>
<p>That's correct</p>



<a name="183192559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192559">(Dec 11 2019 at 19:32)</a>:</h4>
<p>this is effectively <em>similar</em> to the idea of "reveal"</p>



<a name="183192573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192573">(Dec 11 2019 at 19:32)</a>:</h4>
<p>it interacts I think with specialization</p>



<a name="183192620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192620">(Dec 11 2019 at 19:33)</a>:</h4>
<p>How so? I would have assumed that specialization doesn't directly interact with generators</p>



<a name="183192622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192622">(Dec 11 2019 at 19:33)</a>:</h4>
<p>like, if you have a specialization that is true iff something is Send</p>



<a name="183192627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192627">(Dec 11 2019 at 19:33)</a>:</h4>
<p>Since you can't write impls for them</p>



<a name="183192724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192724">(Dec 11 2019 at 19:34)</a>:</h4>
<p>ah</p>



<a name="183192733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192733">(Dec 11 2019 at 19:34)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="k">trait</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Bar</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">default</span> <span class="k">type</span><span class="w"> </span><span class="n">Bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Send</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">type</span> <span class="nc">Bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>



<a name="183192745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192745">(Dec 11 2019 at 19:34)</a>:</h4>
<p>I implemeneted the 'delayed generator witnesses' as a 'special mode' of TraitEngine</p>



<a name="183192753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192753">(Dec 11 2019 at 19:34)</a>:</h4>
<p>we only use this mode during type inference</p>



<a name="183192755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192755">(Dec 11 2019 at 19:34)</a>:</h4>
<p>I believe that, as presently defined, you <em>can</em> observe that <code>&lt;T as MyTrait&gt;::Bar</code> is <code>u32</code></p>



<a name="183192768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192768">(Dec 11 2019 at 19:34)</a>:</h4>
<p>every other existing usage of TraitEngine/SelectionnContext gets the current behavior</p>



<a name="183192771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192771">(Dec 11 2019 at 19:34)</a>:</h4>
<p>(I'm thinking also about what this would mean for chalk)</p>



<a name="183192805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192805">(Dec 11 2019 at 19:35)</a>:</h4>
<p>oh, you're talking about specialization of assocaited types</p>



<a name="183192815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192815">(Dec 11 2019 at 19:35)</a>:</h4>
<p>I thought you were referring to the impl itself</p>



<a name="183192816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192816">(Dec 11 2019 at 19:35)</a>:</h4>
<p>hmm</p>



<a name="183192914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192914">(Dec 11 2019 at 19:36)</a>:</h4>
<p>I guess if I had concerns they would be:</p>
<ul>
<li>adding modes to trait resolution might have unexpected interactions</li>
<li>determining the "live types" from MIR is probably right but it may also be more precise than we wanted it to be? we could reveal impl details we don't intend to. I'm however not as nervous about this if we tie it to the MIR that feeds into borrowck, since the same is already true there.</li>
</ul>



<a name="183192998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183192998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183192998">(Dec 11 2019 at 19:37)</a>:</h4>
<p>yes, typeck can observe specializations, <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=3e2cd720425a19c59f1b7eb25a548ba0" target="_blank" title="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=3e2cd720425a19c59f1b7eb25a548ba0">as you can see here</a></p>



<a name="183193011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193011">(Dec 11 2019 at 19:37)</a>:</h4>
<p>I'm not very familiar with specialization of associated types - where do we end up 'checking' (but not requiring) if a bound holds, so that we can see if the specialized impl should be used?</p>



<a name="183193024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193024">(Dec 11 2019 at 19:37)</a>:</h4>
<p>(interestingly, the current code <em>cannot</em> rely on the projection being <code>()</code> -- that is, we always assume new specializations could be added during typeck)</p>



<a name="183193058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193058">(Dec 11 2019 at 19:37)</a>:</h4>
<blockquote>
<p>I'm not very familiar with specialization of associated types - where do we end up 'checking' (but not requiring) if a bound holds, so that we can see if the specialized impl should be used?</p>
</blockquote>
<p>it happens in the <a href="http://select.rs" target="_blank" title="http://select.rs">select.rs</a> code right now</p>



<a name="183193126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193126">(Dec 11 2019 at 19:38)</a>:</h4>
<p>there is some logic that says "if you have two competing impls A and B, and A specializes B, and you know that A applies, then discard B"</p>



<a name="183193166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193166">(Dec 11 2019 at 19:38)</a>:</h4>
<p>we could certainly make it so that "generator impls Send" is more of a "maybe true" bit of info</p>



<a name="183193194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193194">(Dec 11 2019 at 19:39)</a>:</h4>
<p>that's a new concept we'd have to add though</p>



<a name="183193197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193197">(Dec 11 2019 at 19:39)</a>:</h4>
<p>I hadn't considered that interaction at all</p>



<a name="183193202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193202">(Dec 11 2019 at 19:39)</a>:</h4>
<p>that really complicates things</p>



<a name="183193216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193216">(Dec 11 2019 at 19:39)</a>:</h4>
<p>Yes.</p>



<a name="183193235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193235">(Dec 11 2019 at 19:39)</a>:</h4>
<p>I had previously assumed that it didn't really matter 'when' we determined if 'G: AutoTrait' holds or not. However, that seems to be wrong</p>



<a name="183193236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193236">(Dec 11 2019 at 19:39)</a>:</h4>
<p>The same thing is something of a problem for <code>-&gt; impl Trait</code> and send</p>



<a name="183193297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193297">(Dec 11 2019 at 19:40)</a>:</h4>
<p>Right now we impose a DAG relationship for that reason</p>



<a name="183193337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193337">(Dec 11 2019 at 19:40)</a>:</h4>
<p>It's of course possible to imagine that we should alter specialization to avoid this interaction, though it'd be a significant limitation</p>



<a name="183193477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193477">(Dec 11 2019 at 19:42)</a>:</h4>
<p>/me thinks</p>



<a name="183193512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193512">(Dec 11 2019 at 19:42)</a>:</h4>
<p>So, if we <em>didn't</em> take this approach</p>



<a name="183193549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193549">(Dec 11 2019 at 19:42)</a>:</h4>
<p>Well, put another way, the conflict I am identifying is basically unavoidable</p>



<a name="183193720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193720">(Dec 11 2019 at 19:44)</a>:</h4>
<p>yeah, it seems so - we need to do type-checking to generate the MIR, but the MIR can directly influence type-checking via specialization</p>



<a name="183193782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193782">(Dec 11 2019 at 19:45)</a>:</h4>
<p>I think this would apply to any approach that tries to use the MIR (in any way) to determine generator auto trait impls</p>



<a name="183193795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193795">(Dec 11 2019 at 19:45)</a>:</h4>
<p>Agreed</p>



<a name="183193803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193803">(Dec 11 2019 at 19:45)</a>:</h4>
<p>This is kind of where I got stuck when thinking about it before</p>



<a name="183193808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193808">(Dec 11 2019 at 19:45)</a>:</h4>
<p>It seems like there are two options</p>



<a name="183193834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193834">(Dec 11 2019 at 19:45)</a>:</h4>
<p>Or maybe three :)</p>



<a name="183193930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193930">(Dec 11 2019 at 19:46)</a>:</h4>
<p>I mean (1) is that we take this basic approach, but we work out the interactions w/ specialization etc <em>somehow</em></p>



<a name="183193968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193968">(Dec 11 2019 at 19:46)</a>:</h4>
<p>This might be by assuming Send is true (and checking later), which I'm not wild about, or by regarding it as "unknown" (and hence refusing to decide whether the specialization applies)</p>



<a name="183193976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183193976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183193976">(Dec 11 2019 at 19:47)</a>:</h4>
<p>with perhaps some kind of "opt-in" to make it required to be true</p>



<a name="183194119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194119">(Dec 11 2019 at 19:48)</a>:</h4>
<p>well, hmm, so even looking past MIR, there really is a "core cycle" which is:</p>



<a name="183194134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194134">(Dec 11 2019 at 19:48)</a>:</h4>
<p>we can't figure out all the types</p>



<a name="183194144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194144">(Dec 11 2019 at 19:48)</a>:</h4>
<p>(at least in some cases)</p>



<a name="183194148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194148">(Dec 11 2019 at 19:48)</a>:</h4>
<p>i.e., the type of something might depend on specialization</p>



<a name="183194157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194157">(Dec 11 2019 at 19:48)</a>:</h4>
<p>so I think there are really just two choices</p>



<a name="183194241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194241">(Dec 11 2019 at 19:49)</a>:</h4>
<p>we can resolve that, as I just described, or we can use an approximation (as we do today) -- but even the one we use today seems to require knowing the types..?</p>



<a name="183194469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194469">(Dec 11 2019 at 19:51)</a>:</h4>
<p>To make matters worse, the generator can be hidden behind several other types, via type-alias-impl-trait</p>



<a name="183194493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194493">(Dec 11 2019 at 19:51)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="cp">#![feature(specialization)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Bar</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">default</span> <span class="k">type</span><span class="w"> </span><span class="n">Bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Send</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyTrait</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">type</span> <span class="nc">Bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">gimme</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">MyTrait</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">MyTrait</span><span class="o">&gt;</span>::<span class="n">Bar</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">panic</span><span class="o">!</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gimme</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>



<a name="183194496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194496">(Dec 11 2019 at 19:51)</a>:</h4>
<p>So, trying to specialize based on <code>InnocousStruct: Send</code> might actually involve determining whether some generator is Send</p>



<a name="183194549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194549">(Dec 11 2019 at 19:52)</a>:</h4>
<p>that's an example where the type of <code>y</code> is determined from <code>gimme(x)</code></p>



<a name="183194568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194568">(Dec 11 2019 at 19:52)</a>:</h4>
<p>I think you can use some deferred type variables to get that as part of <code>x</code></p>



<a name="183194641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194641">(Dec 11 2019 at 19:53)</a>:</h4>
<p>e.g., <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=2da9e6f5b6c50c5e7154ea537a1e66fe" target="_blank" title="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=2da9e6f5b6c50c5e7154ea537a1e66fe">this one</a>, but it won't compile today (which seems good)</p>



<a name="183194650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194650">(Dec 11 2019 at 19:53)</a>:</h4>
<p>(and as I expected)</p>



<a name="183194793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194793">(Dec 11 2019 at 19:54)</a>:</h4>
<p>I think what is happening there is that we don't yet know the interior types of the generator, so that the <code>T: MyTrait&lt;Bar = ?U&gt;</code> obligation remains effectively unsatisfied, and hence the type of <code>z: Option&lt;?U&gt;</code> is never fully known</p>



<a name="183194837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194837">(Dec 11 2019 at 19:55)</a>:</h4>
<p>"more or less"</p>



<a name="183194894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194894">(Dec 11 2019 at 19:55)</a>:</h4>
<p>hmm</p>



<a name="183194992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183194992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183194992">(Dec 11 2019 at 19:56)</a>:</h4>
<p>thinking about this from the MIR side - we really do need to know the actual types when deciding which types are live across yield points. - the analysis takes <code>Drop</code> into account</p>



<a name="183195019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195019">(Dec 11 2019 at 19:57)</a>:</h4>
<p>this cycle seems really fundamental, unfortunately</p>



<a name="183195145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195145">(Dec 11 2019 at 19:58)</a>:</h4>
<p>Yeah. So there is the option of just refusing to make decisions.</p>



<a name="183195152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195152">(Dec 11 2019 at 19:58)</a>:</h4>
<p>After all, this is something of an edge case that is unlikely to truly arise.</p>



<a name="183195188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195188">(Dec 11 2019 at 19:58)</a>:</h4>
<p>I'm thinking a bit about it from the chalk angle</p>



<a name="183195204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195204">(Dec 11 2019 at 19:58)</a>:</h4>
<p>Right now chalk has a notion of "cannot prove" --</p>



<a name="183195231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195231">(Dec 11 2019 at 19:59)</a>:</h4>
<p>so e.g. trying to prove <code>T: Send</code> could yield that, and it would prevent specializations from being used</p>



<a name="183195248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195248">(Dec 11 2019 at 19:59)</a>:</h4>
<p>however, that's likely not quite what we want here, in that</p>



<a name="183195289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195289">(Dec 11 2019 at 19:59)</a>:</h4>
<p>if you had some code that relied on it being send</p>



<a name="183195297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195297">(Dec 11 2019 at 19:59)</a>:</h4>
<p>it would get an error</p>



<a name="183195316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195316">(Dec 11 2019 at 20:00)</a>:</h4>
<p>(well, maybe that <em>is</em> what we want..?)</p>



<a name="183195433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195433">(Dec 11 2019 at 20:00)</a>:</h4>
<p>put another way, leaving chalk aside, if you imagine that the result of saying "can I prove this?" is either yes/no/maybe</p>



<a name="183195513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195513">(Dec 11 2019 at 20:01)</a>:</h4>
<p>/me stops to think :)</p>



<a name="183195515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195515">(Dec 11 2019 at 20:01)</a>:</h4>
<p>So, we would error whenever we attempted to check a specialization that would require evaluating <code>G: AutoTrait</code>?</p>



<a name="183195538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195538">(Dec 11 2019 at 20:01)</a>:</h4>
<p>well, it wouldn't be an <em>error</em></p>



<a name="183195575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195575">(Dec 11 2019 at 20:01)</a>:</h4>
<p>it wouldn't be able to decide if the spec applies or not</p>



<a name="183195580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195580">(Dec 11 2019 at 20:01)</a>:</h4>
<p>but that might not lead to an error</p>



<a name="183195585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195585">(Dec 11 2019 at 20:01)</a>:</h4>
<p>as it might not matter</p>



<a name="183195653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195653">(Dec 11 2019 at 20:02)</a>:</h4>
<p>e.g., if you were trying to prove something like <code>&lt;T as MyTrait&gt;::Bar: Sized</code>, you don't actually care if <code>T: Send</code>--i.e., you don't care if you took the specialization or not</p>



<a name="183195668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195668">(Dec 11 2019 at 20:02)</a>:</h4>
<p>there is a small 'fly in the ointment' though</p>



<a name="183195731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195731">(Dec 11 2019 at 20:02)</a>:</h4>
<p>In your <code>&lt;u32 as MyTrait&gt;::Bar</code> example, would we then use the unspecialised impl for <code>G</code>?</p>



<a name="183195747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195747">(Dec 11 2019 at 20:02)</a>:</h4>
<p>if the example were changed to involve generators, that is</p>



<a name="183195825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195825">(Dec 11 2019 at 20:03)</a>:</h4>
<p>ah, maybe since specialization is unstable, it's largely ok, but it's true that <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=ed3e8a7eb0e944581062f758c89126c6" target="_blank" title="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=ed3e8a7eb0e944581062f758c89126c6">this compiles today</a></p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gimme</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>and it is only able to do so because we are able to first figure out that the generator type is <code>Send</code> so that  we can resolve the type of <code>y</code></p>



<a name="183195834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195834">(Dec 11 2019 at 20:03)</a>:</h4>
<blockquote>
<p>In your <code>&lt;u32 as MyTrait&gt;::Bar</code> example, would we then use the unspecialised impl for <code>G</code>?</p>
</blockquote>
<p>we would not use either impl</p>



<a name="183195892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195892">(Dec 11 2019 at 20:04)</a>:</h4>
<p>that is, in type-checking</p>



<a name="183195920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195920">(Dec 11 2019 at 20:04)</a>:</h4>
<p>er, I'm guessing you meant <code>&lt;G as MyTrait&gt;::Bar</code>, where <code>G</code> is a generator type</p>



<a name="183195941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195941">(Dec 11 2019 at 20:04)</a>:</h4>
<p>(or something that depends on a generator)</p>



<a name="183195944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195944">(Dec 11 2019 at 20:04)</a>:</h4>
<p>yeah, sorry for being unclear there</p>



<a name="183195983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195983">(Dec 11 2019 at 20:05)</a>:</h4>
<p>the idea would be that we just can't normalize that</p>



<a name="183195990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183195990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183195990">(Dec 11 2019 at 20:05)</a>:</h4>
<p>we can't convert it to <code>()</code> or <code>u32</code></p>



<a name="183196109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196109">(Dec 11 2019 at 20:06)</a>:</h4>
<p>What would happen for uses of the impl that don't involve associated types - e.g. calling a potentially specialised method?</p>



<a name="183196148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196148">(Dec 11 2019 at 20:06)</a>:</h4>
<p>I guess we don't actually need to know that during typeck, right?</p>



<a name="183196163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196163">(Dec 11 2019 at 20:06)</a>:</h4>
<p>nothing; we know that there exists some method, you could still call it, it's not until codgen time that we'd have to figure out exactly which one gets invoked</p>



<a name="183196332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196332">(Dec 11 2019 at 20:08)</a>:</h4>
<p>in the associated type example, would we just give up and error when a generator was involved in the normalization?</p>



<a name="183196426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196426">(Dec 11 2019 at 20:09)</a>:</h4>
<p>it depends I guess, I'm not sure exactly which example you mean</p>



<a name="183196457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196457">(Dec 11 2019 at 20:09)</a>:</h4>
<p><code>&lt;G as MyTrait&gt;::Bar</code></p>



<a name="183196459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196459">(Dec 11 2019 at 20:10)</a>:</h4>
<p>a lazy normalization strategy kind of affects this too</p>



<a name="183196515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196515">(Dec 11 2019 at 20:10)</a>:</h4>
<p>or some type involving a generator instead of <code>G</code></p>



<a name="183196562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196562">(Dec 11 2019 at 20:10)</a>:</h4>
<p>i.e., the type of <code>y</code> right now is considered "unresolved" but conceivably it could just be assigned to <code>&lt;G as MyTrait&gt;::Bar</code> in a lazy norm strategy, and that's a perfectly valid type (that will be normalized if it must be, i.e., if some bit of code requires that to be <code>u32</code>)</p>



<a name="183196572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196572">(Dec 11 2019 at 20:10)</a>:</h4>
<p>right, but that's not a complete example</p>



<a name="183196620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196620">(Dec 11 2019 at 20:11)</a>:</h4>
<p>the <code>gimme(x)</code> example with <code>let x = async move</code></p>



<a name="183196624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196624">(Dec 11 2019 at 20:11)</a>:</h4>
<p>so e.g. if you had</p>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gimme</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="n">drop</span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
</pre></div>


<p>we don't really have to know the type of <code>y</code>, it's enough to know that it has <em>some</em> <code>Sized</code> type</p>



<a name="183196629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196629">(Dec 11 2019 at 20:11)</a>:</h4>
<p>but if you have</p>



<a name="183196645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196645">(Dec 11 2019 at 20:11)</a>:</h4>
<div class="codehilite"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">y</span>: <span class="kt">u32</span> <span class="o">=</span><span class="w"> </span><span class="n">gimme</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</pre></div>


<p>that's different</p>



<a name="183196754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196754">(Dec 11 2019 at 20:12)</a>:</h4>
<p>so depending on how we set things up, it could be that the first one builds, but the second one doesn't</p>



<a name="183196762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196762">(Dec 11 2019 at 20:12)</a>:</h4>
<p>e.g., because the type of <code>y</code> effectively gets inferred to the placeholder <code>G::Bar</code>, since we can't decide which specialization to use</p>



<a name="183196840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196840">(Dec 11 2019 at 20:13)</a>:</h4>
<p>I see. When this error occurred, would the user have any way to fix it (other than not using the trait in question)?</p>



<a name="183196924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196924">(Dec 11 2019 at 20:14)</a>:</h4>
<p>Things could be very deeply nested, so I'm not sure what kind of information the user could specify to resolve it</p>



<a name="183196989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183196989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183196989">(Dec 11 2019 at 20:15)</a>:</h4>
<p>the bigger problem I think is code like this, which builds today:</p>
<div class="codehilite"><pre><span></span><span class="k">fn</span> <span class="nf">gimme_send</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nb">Send</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">panic</span><span class="o">!</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">gimme_send</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>


<p>because this code only type-checks if the generator is <code>Send</code></p>



<a name="183197003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197003">(Dec 11 2019 at 20:15)</a>:</h4>
<p>(sorry, it's not a <em>problem</em>, it's just a thing to remember)</p>



<a name="183197021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197021">(Dec 11 2019 at 20:15)</a>:</h4>
<blockquote>
<p>I see. When this error occurred, would the user have any way to fix it (other than not using the trait in question)?</p>
</blockquote>
<p>I think we'd have to add a mechanism</p>



<a name="183197105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197105">(Dec 11 2019 at 20:16)</a>:</h4>
<p>I'm not sure what that means, I guess it would be a declaration that the <code>async move</code> is <code>Send</code></p>



<a name="183197123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197123">(Dec 11 2019 at 20:16)</a>:</h4>
<p>and maybe we can use some kind of "approx analysis" to avoid the need for that sometimes, too -- i.e., if we have an over-approx, we could (maybe?)check if that suffices</p>



<a name="183197234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197234">(Dec 11 2019 at 20:17)</a>:</h4>
<p>( in any case, I was just pondering how specialization should be modeled in chalk, I'm trying to map this to the chalk solver, and wondering if I had overlooked something there )</p>



<a name="183197323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197323">(Dec 11 2019 at 20:18)</a>:</h4>
<p>(ah, no, I guess it's ok)</p>



<a name="183197341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197341">(Dec 11 2019 at 20:18)</a>:</h4>
<p>sorry to keep mapping back to chalk, I can try to elaborate, I just find that a useful framework for thinking about this stuff</p>



<a name="183197570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197570">(Dec 11 2019 at 20:20)</a>:</h4>
<p>I think the way I'm thining about it right now is like this</p>



<a name="183197612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197612">(Dec 11 2019 at 20:21)</a>:</h4>
<p>Here's a different approach I'm thinking of (not sure if it will work):</p>



<a name="183197629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197629">(Dec 11 2019 at 20:21)</a>:</h4>
<p>we augment the system so that when you try to prove something (e.g., <code>T: Foo</code>), you can get back an answer like "yes if G" where <code>G</code> are some things that must be proven later. We already do something like this for region constraints and we are trying to build up some similar logic for coinduction anyway.</p>



<a name="183197646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197646">(Dec 11 2019 at 20:22)</a>:</h4>
<p>Such an answer is considered "ambiguous" in some sense, you can't know if it's true or false yet</p>



<a name="183197690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197690">(Dec 11 2019 at 20:22)</a>:</h4>
<p>This is basically the "mode" you added</p>



<a name="183197717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197717">(Dec 11 2019 at 20:22)</a>:</h4>
<p>i.e., the mode is "defer" <code>G: Send</code> goals</p>



<a name="183197788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183197788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183197788">(Dec 11 2019 at 20:23)</a>:</h4>
<blockquote>
<p>Here's a different approach I'm thinking of (not sure if it will work):</p>
</blockquote>
<p>anyway, go for it :)</p>



<a name="183198090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183198090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183198090">(Dec 11 2019 at 20:26)</a>:</h4>
<p>hmm, what I was thinking of might actually not work out</p>



<a name="183198121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183198121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183198121">(Dec 11 2019 at 20:26)</a>:</h4>
<p>I was thinking that we didn't actually need to know the types of upvars when type-checking the parent - only the types of things local to the generator.</p>



<a name="183198131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183198131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183198131">(Dec 11 2019 at 20:26)</a>:</h4>
<p>However, you can have something like:</p>



<a name="183198153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183198153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183198153">(Dec 11 2019 at 20:27)</a>:</h4>
<p><code>async move { let myvar = some_fn(local_var, upvar) }</code></p>



<a name="183198184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183198184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183198184">(Dec 11 2019 at 20:27)</a>:</h4>
<p>And the type of <code>myvar</code> might depend on <code>upvar</code> if <code>some_fn</code> is generic</p>



<a name="183198240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183198240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183198240">(Dec 11 2019 at 20:27)</a>:</h4>
<p>So the typeck results from the parent can actually be relevant when determining which types live across suspend points</p>



<a name="183198451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183198451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183198451">(Dec 11 2019 at 20:29)</a>:</h4>
<p>yeah it's all tangled up :)</p>



<a name="183198612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183198612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183198612">(Dec 11 2019 at 20:31)</a>:</h4>
<p>though, on second thought - is it possible to combine that case with specialization of an associated type?</p>



<a name="183198711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183198711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183198711">(Dec 11 2019 at 20:32)</a>:</h4>
<p>That would mean that 1) the parent is trying to compute a type (e.g. <code>let a: u32 = &lt;G as MyTrait&gt;::MyType</code>) while specializing on the generator, and 2) the generator is trying to use that type from the parent</p>



<a name="183198738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183198738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183198738">(Dec 11 2019 at 20:32)</a>:</h4>
<p>I think that should cause a cycle error even if we kept the current generator auto-trait behavior (i.e using the GeneratorWitness types from HIR)</p>



<a name="183198818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183198818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183198818">(Dec 11 2019 at 20:33)</a>:</h4>
<p>The parent needs to evaluate <code>G:  AutoTrait</code>, but the constituent types (under any scheme) depend on an upvar that relies on the specialization of <code>G: AutoTrait</code></p>



<a name="183199033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199033">(Dec 11 2019 at 20:35)</a>:</h4>
<p>So, I think there are two cases:<br>
1) We have the kind of weird cycle that I just described. We have to emit a cycle error regardless of how we determine the consitutent types of <code>G</code><br>
2) We don't have this kind of cycle. This means that one of these cases is true:<br>
2.1) We are specializing on the generator type, but the generator doesn't rely on the result of that specializtion (via an upvar)<br>
2.2) We are not specializing on the generator type, and the generator uses an upvar<br>
2.3) We are not specializing, and the generator does not use an upvar</p>



<a name="183199120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199120">(Dec 11 2019 at 20:36)</a>:</h4>
<p>If we're not specializing, then the existing 'delayed generator predicate' scheme works</p>



<a name="183199201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199201">(Dec 11 2019 at 20:37)</a>:</h4>
<p>If we <em>are</em> specializing, then I think we can go with something like this:</p>
<p>We comute some kind of 'incomplete mir' for the generator - it has the generator interior types filled in, but not upvars</p>



<a name="183199234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199234">(Dec 11 2019 at 20:37)</a>:</h4>
<p>err, rather</p>



<a name="183199288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199288">(Dec 11 2019 at 20:38)</a>:</h4>
<p>It does have upvars, which we can determine the types of because we're not specializing</p>



<a name="183199302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199302">(Dec 11 2019 at 20:38)</a>:</h4>
<p>We then run the analysis on that MIR, and use the results for the witness types</p>



<a name="183199314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199314">(Dec 11 2019 at 20:38)</a>:</h4>
<p>This is pretty complicated, but I think it should be completely transparent to users</p>



<a name="183199329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199329">(Dec 11 2019 at 20:38)</a>:</h4>
<p>and will not introduce errors in any casses where they did not already exist (e.g. the weird specialization + upvar cycle)</p>



<a name="183199349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199349">(Dec 11 2019 at 20:39)</a>:</h4>
<p>sorry, that ended up being way longer than I thought it would <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="183199395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199395">(Dec 11 2019 at 20:39)</a>:</h4>
<p>I admit i don't <em>quite</em> follow all that logic. I'll have to re-read it carefully. =)</p>



<a name="183199450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199450">(Dec 11 2019 at 20:40)</a>:</h4>
<p>I've probably got to run to do a few other things, but I think the idea of able to have "deferred" trait proving goals might be quite useful (as I noted, also for <code>impl Trait</code>). I feel like I can sort of understand how to model it in chalk, and then the question is mostly how we can ensure that those things eventually get proven.</p>



<a name="183199484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199484">(Dec 11 2019 at 20:40)</a>:</h4>
<p>The main idea is that if we're doing any kind of associated type specialization based on the generator, the generator itself cannot rely on that associated type specialization (via an upvar)</p>



<a name="183199510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199510">(Dec 11 2019 at 20:40)</a>:</h4>
<p>Yeah. I'm kind of taking that as a given in some sense.</p>



<a name="183199535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199535">(Dec 11 2019 at 20:41)</a>:</h4>
<p>I think it would effectively manifest as a kind of error -- i.e., we wouldn't be able to prove that the specialized impl applies</p>



<a name="183199544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199544">(Dec 11 2019 at 20:41)</a>:</h4>
<p>I think that fact lets us perform the needed analysis without hitting cycles</p>



<a name="183199576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199576">(Dec 11 2019 at 20:41)</a>:</h4>
<p>I guess I don't really like the idea of (e.g.) "incomplete MIR", it's sounding very complex</p>



<a name="183199605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199605">(Dec 11 2019 at 20:41)</a>:</h4>
<p>Yeah, I agree that it's not very great</p>



<a name="183199658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199658">(Dec 11 2019 at 20:42)</a>:</h4>
<p>That said, maybe there is some "reframing"</p>



<a name="183199728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199728">(Dec 11 2019 at 20:43)</a>:</h4>
<p>That is, the current setup where we do type-check to compute all the types etc, then build the MIR, doesn't quite seem fine-grained enough necessarily, maybe there is another way to draw the line .. e.g. I don't know producing some other kind of intermediate structure (more like HAIR, maybe) that we can use .. still sounds complex :)</p>



<a name="183199746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183199746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183199746">(Dec 11 2019 at 20:43)</a>:</h4>
<p>Thinking about this more, I think we don't actually need the notion of 'incomplete MIR':</p>



<a name="183200140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183200140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183200140">(Dec 11 2019 at 20:47)</a>:</h4>
<p>or perhaps not - this approach really is quite complicated</p>



<a name="183200356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183200356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183200356">(Dec 11 2019 at 20:49)</a>:</h4>
<p>Oh, wait - I think I may have misunderstood how closrue type-checking works</p>



<a name="183200424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183200424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183200424">(Dec 11 2019 at 20:50)</a>:</h4>
<p>I was thinking that the parent had a separate TypeckTables, which the child depended on</p>



<a name="183200441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183200441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183200441">(Dec 11 2019 at 20:50)</a>:</h4>
<p>but actually, they use the same TypeckTables</p>



<a name="183200595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183200595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183200595">(Dec 11 2019 at 20:52)</a>:</h4>
<p>I don't think that helps to simplify the complexity of the 'incomplete mir' approach, though</p>



<a name="183201518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183201518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183201518">(Dec 11 2019 at 21:04)</a>:</h4>
<p>yeah, that's how it works, but in a way it's part of the problem</p>



<a name="183201704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183201704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183201704">(Dec 11 2019 at 21:06)</a>:</h4>
<p>I wonder if we could just ban associated type specializations on generator types, when the specialization occurs in the same function as the generator</p>



<a name="183201717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183201717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183201717">(Dec 11 2019 at 21:06)</a>:</h4>
<p>for the time being, that is</p>



<a name="183201800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183201800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183201800">(Dec 11 2019 at 21:07)</a>:</h4>
<p>I think the error would almost never come up (you need to be using an unstable feature, and be specializing on associated types, and have generators/async fns involved)</p>



<a name="183201945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183201945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183201945">(Dec 11 2019 at 21:08)</a>:</h4>
<p>it would leave room to decide what the actual behavior should be (a more complicated analysis, a more targeted error, something else)</p>



<a name="183202003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/183202003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#183202003">(Dec 11 2019 at 21:08)</a>:</h4>
<p>I think all other cases are fine (if the specialization is in a different function, then we can certainly compute <code>G: AutoTrait</code> without hitting a cycle)</p>



<a name="188048815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%22recorded%20types%20from%20MIR%22%20PR%20%2365782/near/188048815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> DPC <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.22recorded.20types.20from.20MIR.22.20PR.20.2365782.html#188048815">(Feb 12 2020 at 20:08)</a>:</h4>
<p><span class="user-mention" data-user-id="125294">@Aaron Hill</span> <span class="user-mention" data-user-id="116009">@nikomatsakis</span>  is there any progress on this PR? Thanks</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>