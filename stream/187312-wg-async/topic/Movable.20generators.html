<html>
<head><meta charset="utf-8"><title>Movable generators · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Movable.20generators.html">Movable generators</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272193644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Movable%20generators/near/272193644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Movable.20generators.html#272193644">(Feb 16 2022 at 23:20)</a>:</h4>
<p>I was just reading some of the <a href="https://cs.github.com/rust-lang/rust/blob/e646f3d2a9541952310778288854943678738ea9/compiler/rustc_mir_transform/src/generator.rs?q=locals_live_across_suspend_points++#L512">generator MIR generation code</a> and I noticed we have a concept of movable generators. Does anyone have an example of how to make a non-movable generator?</p>



<a name="272193680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Movable%20generators/near/272193680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Movable.20generators.html#272193680">(Feb 16 2022 at 23:20)</a>:</h4>
<p>Apparently all <code>async fn</code>s make a movable generator, which is odd to me given that in order to poll the generator you have to pin it first, making it not movable.</p>



<a name="272196199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Movable%20generators/near/272196199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Movable.20generators.html#272196199">(Feb 16 2022 at 23:53)</a>:</h4>
<p>Oh, I would have imagined it to be the other way around: <code>async fn</code> are generators which are allowed not to be <code>Unpin</code>, and thus have local borrows cross <code>yield</code> / <code>await</code> points, thus acting like a <code>static |_| ...</code> generator. And a generator without the <code>static</code> would not allow borrows to cross <code>yield</code> points, since in order to be moveable it would have to be <code>Unpin</code>.</p>



<a name="272197648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Movable%20generators/near/272197648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Movable.20generators.html#272197648">(Feb 17 2022 at 00:09)</a>:</h4>
<p>Oh, maybe movable in the context of MIR generation is sort of dual to what I'm thinking. In MIR generation, I guess movable means "we've determined this is safe to move" which means "this generator doesn't have any borrows that cross await points."</p>



<a name="272198154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Movable%20generators/near/272198154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Movable.20generators.html#272198154">(Feb 17 2022 at 00:15)</a>:</h4>
<p>I think the actual problem is that <code>MaybeBorrowedLocals</code> is too coarse. The logic I linked there seems correct (you have to consider borrows because there might be live borrows because the generator is not movable), but it seems like <code>MaybeBorrowedLocals</code> is considering too many things borrowed.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>