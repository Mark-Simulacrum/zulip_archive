<html>
<head><meta charset="utf-8"><title>must_not_suspend false positives · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html">must_not_suspend false positives</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256689478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256689478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256689478">(Oct 08 2021 at 05:10)</a>:</h4>
<p>looks like we are getting false positives on must_not_suspend due to the generator analysis, <a href="https://github.com/rust-lang/rust/issues/89562">#89562</a></p>



<a name="256732020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256732020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256732020">(Oct 08 2021 at 12:29)</a>:</h4>
<p>Yeah, that's a more general limitation of liveness analysis <em>w.r.t</em> the unsugaring of generator and its resolved captures: the lint will automagically be fixed when that bigger issue is.</p>



<a name="256753622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256753622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256753622">(Oct 08 2021 at 15:05)</a>:</h4>
<p>Yah I believe this is related to <span class="user-mention" data-user-id="421986">@eholk</span>'s work,  where <code>drop</code> doesn't actually work!</p>
<p>If we want to wait for that, we can definitely remove the attribute from std for now (it should only be on nightly for now)?</p>



<a name="256769536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256769536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256769536">(Oct 08 2021 at 16:51)</a>:</h4>
<p>Yeah, these false positives should be fixed once generator captures are more precise, but unfortunately that's turning out to be trickier to do than I'd hoped.</p>



<a name="256769886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256769886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256769886">(Oct 08 2021 at 16:54)</a>:</h4>
<p>I wonder if we could do the <code>must_not_suspend</code> analysis on MIR? It has more precise knowledge of what actually goes in the generator at that point.</p>



<a name="256769944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256769944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256769944">(Oct 08 2021 at 16:55)</a>:</h4>
<p>But I also thinking remove the attribute from std is a good idea in the meantime, at least at some point before the change makes it to beta.</p>



<a name="256770413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256770413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256770413">(Oct 08 2021 at 16:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20false.20positives/near/256769886">said</a>:</p>
<blockquote>
<p>I wonder if we could do the <code>must_not_suspend</code> analysis on MIR? It has more precise knowledge of what actually goes in the generator at that point.</p>
</blockquote>
<p>I thought the mir  generator directly pulled from the typeck analysis? does it do something different?</p>



<a name="256770752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256770752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256770752">(Oct 08 2021 at 17:00)</a>:</h4>
<p>The mir generator gets a subset of the typeck analysis (and there's a check to make sure that anything the mir generator found was also found by typeck)</p>



<a name="256771137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256771137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256771137">(Oct 08 2021 at 17:02)</a>:</h4>
<p>Here's the MIR version: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_transform/src/generator.rs#L449">https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_transform/src/generator.rs#L449</a></p>



<a name="256771629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256771629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256771629">(Oct 08 2021 at 17:05)</a>:</h4>
<p>Here's the check to make sure the things MIR found is a subset of the things typeck found: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_transform/src/generator.rs#L750">https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_transform/src/generator.rs#L750</a></p>



<a name="256771758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256771758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256771758">(Oct 08 2021 at 17:06)</a>:</h4>
<p>That'd actually be a tidy place to check <code>must_not_suspend</code>, I bet.</p>



<a name="256772326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256772326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256772326">(Oct 08 2021 at 17:09)</a>:</h4>
<p>FWIW, rather than delaying the release of the lint altogether, it could be released but as an <code>allow</code>-by-default one. For those use to the <code>Future</code> is not <code>Send</code> despite the <code>drop</code>ped <code>Mutex</code>es, this lint won't be worse, and it's a lint which can prove itself useful on its own <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="256781802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256781802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256781802">(Oct 08 2021 at 18:12)</a>:</h4>
<p>allow-by-default as opposed to warn-by-default? that seems reasonable</p>
<p><span class="user-mention" data-user-id="421986">@eholk</span> , do you think its worth moving the analysis to mir, if we probably will want to move it back once we resolve the typeck analysis?</p>



<a name="256792396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256792396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256792396">(Oct 08 2021 at 19:24)</a>:</h4>
<p>It depends. Is there a reason it's better to do this in typeck analysis? The nice thing about going it at the MIR level is that it will always have the most precise information about the types that are live across an await.</p>



<a name="256792504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20false%20positives/near/256792504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20false.20positives.html#256792504">(Oct 08 2021 at 19:25)</a>:</h4>
<p>I think it might be easier to attach <code>#[must_not_suspend]</code> to functions in typeck than in MIR, but I'm not sure.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>