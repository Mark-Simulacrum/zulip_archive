<html>
<head><meta charset="utf-8"><title>return position impl trait in trait · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/return.20position.20impl.20trait.20in.20trait.html">return position impl trait in trait</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260160328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/return%20position%20impl%20trait%20in%20trait/near/260160328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/return.20position.20impl.20trait.20in.20trait.html#260160328">(Nov 03 2021 at 16:32)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="124288">@oli</span>, <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> and I were talking about possibly using RPIT-in-trait to implement async fn in trait. It doesn't look like that's implemented right now. Do you have a sense of how difficult it would be to implement / what the hurdles are?</p>



<a name="261544200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/return%20position%20impl%20trait%20in%20trait/near/261544200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/return.20position.20impl.20trait.20in.20trait.html#261544200">(Nov 15 2021 at 19:09)</a>:</h4>
<p>I'm thinking about how we can give users of an impl using RPITIT more information about the underlying type (following <a href="https://github.com/rust-lang/rfcs/pull/3193#issuecomment-965505149">Gankra's comment</a>). It seems like we can allow publishing this information directly from the impl. For example, one could write</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">NewIntoIterator</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Range</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">into_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Item</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">DoubleEndedIterator</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>when the trait definition <em>only guarantees <code>impl Iterator&lt;Item = Self::Item&gt;</code></em>. This seems very doable given that we already know how to leak auto traits; we're just opting in to more "leakage" from individual impls.</p>



<a name="261545381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/return%20position%20impl%20trait%20in%20trait/near/261545381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/return.20position.20impl.20trait.20in.20trait.html#261545381">(Nov 15 2021 at 19:18)</a>:</h4>
<p><span class="user-mention" data-user-id="116883">@tmandry</span> yes, that could work, in general we've been considering a move towards "impl is allowed to refine the trait". I quite like this idea if you pare it with specialization, in particular.</p>



<a name="261545430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/return%20position%20impl%20trait%20in%20trait/near/261545430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/return.20position.20impl.20trait.20in.20trait.html#261545430">(Nov 15 2021 at 19:18)</a>:</h4>
<p>Because that allows us to construct 'intermediate impls' that give stronger requirements</p>



<a name="261547372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/return%20position%20impl%20trait%20in%20trait/near/261547372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/return.20position.20impl.20trait.20in.20trait.html#261547372">(Nov 15 2021 at 19:33)</a>:</h4>
<p>That idea probably extends well to impls returning a concrete type, too, as a form of "complete leakage", should they choose to do so</p>
<p>Doesn't necessarily work for async fn in traits, though one could imagine so; you wouldn't be able to do Trait::Type to get the output type there in a generic context but that's not always crucial anyway, and you can always define a separate supertrait with <code>type Foo = ...</code> for this case to wrap concrete impls with concrete return types.</p>



<a name="261564855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/return%20position%20impl%20trait%20in%20trait/near/261564855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/return.20position.20impl.20trait.20in.20trait.html#261564855">(Nov 15 2021 at 21:53)</a>:</h4>
<p>We should be able to support an "on/off-ramp" from <code>async fn foo()</code> to <code>fn foo() -&gt; impl Future&lt;Output = ()&gt;</code> for both the trait and impl independently, which would allow the impl to refine the return type (if, say, your future happens to impl <code>Debug</code>)</p>



<a name="261699706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/return%20position%20impl%20trait%20in%20trait/near/261699706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/return.20position.20impl.20trait.20in.20trait.html#261699706">(Nov 16 2021 at 20:09)</a>:</h4>
<p><span class="user-mention" data-user-id="116883">@tmandry</span> yes. I think that now that we have the RPITIT RFC we could probably amend the existing static async fn to be a bit more "permissive" here</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>