<html>
<head><meta charset="utf-8"><title>async foundations stakeholder planning · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html">async foundations stakeholder planning</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261701131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701131">(Nov 16 2021 at 20:20)</a>:</h4>
<p><span class="user-mention" data-user-id="116883">@tmandry</span> So I'm working through the <a href="https://hackmd.io/5MakNcwCRDKWnP6UTL58wg">impl trait update</a> for the lang team and I'm beginning to question the idea of making <code>impl Trait</code> in argument position be "late bound types".</p>



<a name="261701149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701149">(Nov 16 2021 at 20:20)</a>:</h4>
<p>It's not that I don't like the idea exactly, which I do</p>



<a name="261701184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701184">(Nov 16 2021 at 20:20)</a>:</h4>
<p>But I think I might like the idea <em>better</em> to move to a future where <em>everything</em> is late-bound</p>



<a name="261701242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701242">(Nov 16 2021 at 20:21)</a>:</h4>
<p>Actually, I wonder why we don't do that even now</p>



<a name="261701254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701254">(Nov 16 2021 at 20:21)</a>:</h4>
<p>You can't make <em>everything</em> late-bound</p>



<a name="261701264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701264">(Nov 16 2021 at 20:21)</a>:</h4>
<p>Anything that appears in return type but not argument types must be early bound</p>



<a name="261701285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701285">(Nov 16 2021 at 20:22)</a>:</h4>
<p><em>But</em>.. if we moved all the where clauses to the impl (logically)</p>



<a name="261701379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701379">(Nov 16 2021 at 20:22)</a>:</h4>
<p>At that point, I think <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> has a point that (to me) it feels like "fewer concepts" to say that APIT desugars <em>exactly</em> to a fresh generic type parameter. We could address some of the other shortcomings (e.g., it's nice to not have to specify the values for all parameters) in an orthogonal way.</p>



<a name="261701436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701436">(Nov 16 2021 at 20:23)</a>:</h4>
<p>My main concern was that, for async functions at least, you're going to need to specify the types of the arguments regardless, but that kind of works either way</p>



<a name="261701458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701458">(Nov 16 2021 at 20:23)</a>:</h4>
<p>Ah, well, I guess it's also weird that the generic type for a function has to list the values for "some" of its generics</p>



<a name="261701599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701599">(Nov 16 2021 at 20:24)</a>:</h4>
<p>/me thinks</p>



<a name="261701646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701646">(Nov 16 2021 at 20:25)</a>:</h4>
<p>I guess I would say that, as a user, I'd prefer for things to be late-bound most of the time</p>



<a name="261701675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701675">(Nov 16 2021 at 20:25)</a>:</h4>
<p>I just would also like a way to give it a name</p>



<a name="261701679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701679">(Nov 16 2021 at 20:25)</a>:</h4>
<p>Example:</p>



<a name="261701745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701745">(Nov 16 2021 at 20:25)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">do_the_thing</span><span class="p">(</span><span class="o">&amp;</span><span class="k">impl</span><span class="w"> </span><span class="n">Display</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span>
</code></pre></div>



<a name="261701832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701832">(Nov 16 2021 at 20:26)</a>:</h4>
<p>To get the output type of that, we are going to have to specify both the lifetime and the <code>impl Display</code> type</p>



<a name="261701885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701885">(Nov 16 2021 at 20:26)</a>:</h4>
<p>I would prefer to do that with </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&lt;</span><span class="k">fn</span>#<span class="n">do_the_thing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nb">FnOnce</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">MyType</span><span class="p">)</span><span class="o">&gt;</span>::<span class="n">Output</span><span class="w"></span>
</code></pre></div>



<a name="261701924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701924">(Nov 16 2021 at 20:27)</a>:</h4>
<p>Ah, right, ok, I'm remembering that my big concern was more about <em>typeof</em></p>



<a name="261701967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261701967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261701967">(Nov 16 2021 at 20:27)</a>:</h4>
<p>and how it would manage situations like this (wanting to avoid things like <a href="https://en.cppreference.com/w/cpp/utility/declval">declval</a>)</p>



<a name="261702156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261702156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261702156">(Nov 16 2021 at 20:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/async.20foundations.20stakeholder.20planning/near/261701885">said</a>:</p>
<blockquote>
<p>I would prefer to do that with ... <em>long hideous thing follows</em></p>
</blockquote>
<p>to be clear, I'd probably prefer a shorthand most of all...</p>



<a name="261702239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261702239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261702239">(Nov 16 2021 at 20:29)</a>:</h4>
<p>I guess that <code>()</code> are not used in type grammar... we could e.g. do </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span>#<span class="n">do_the_thing</span><span class="p">(</span><span class="o">&amp;'</span><span class="na">a</span><span class="w"> </span><span class="n">MyType</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="261702284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261702284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261702284">(Nov 16 2021 at 20:29)</a>:</h4>
<p>i.e., <code>T(A1, A2, A3)</code> could be shorthand for </p>
<p><code>&lt;T as FnOnce&lt;(A1, A2, A3)&gt;::Output</code></p>



<a name="261702346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261702346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261702346">(Nov 16 2021 at 20:30)</a>:</h4>
<p>did I already decide I hate that for some reason? :)</p>



<a name="261772864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261772864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261772864">(Nov 17 2021 at 11:40)</a>:</h4>
<p>I have a reservation about both the approaches which is that I would expect that <code>::Output</code> would give the return type as written in the function signature, i.e., <code>impl Tr</code>. I don't see any justification for why it should return the concrete type from the implementation. It seems like this is a bit of hand-waviness which could bite us in the future since  there is no syntactic distinction between the output type in the signature vs the concrete type.</p>



<a name="261773065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261773065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261773065">(Nov 17 2021 at 11:42)</a>:</h4>
<p>Getting slightly more philosophical, I find the whole motivation a bit off. The whole point of impl Trait is to abstract away the concrete type and we're now trying to find a way to break that encapsulation. Seems like a footgun, since upstream might change the implementation and break downstream code which relies on that named type. Unless I'm missing some safeguards against this</p>



<a name="261773312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261773312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261773312">(Nov 17 2021 at 11:45)</a>:</h4>
<p>And semi-seriously, these types are ugly as hell! I am getting flashbacks to impossible to parse C++ template types. I pity any beginner or intermediate Rust programmer who comes across these in the wild. The understandability complaint applies maybe more to the shorthands than the longhand version.</p>



<a name="261773695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261773695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261773695">(Nov 17 2021 at 11:49)</a>:</h4>
<p>My counter proposal is that either we find ways to address the motivations without needing to name the concrete return type (e.g.,  would it help to allow <code>impl Trait</code> as the type of struct fields with some semantics? Or leverage TAIT or ATIT to widen the scope of naming the concrete type without widening it to the whole program?). And if we can't do that, we just accept that there are some limitations in the type system that won't be fixed because the cost of doing so is too high.</p>



<a name="261941181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261941181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261941181">(Nov 18 2021 at 15:20)</a>:</h4>
<p>Yeah, I am incliend to agree with 'ugly as hell'. I've significantly revised the approach and I'm much happier with it. Take a look at current draft: <a href="https://hackmd.io/@nikomatsakis/BJfj7BeOK">https://hackmd.io/@nikomatsakis/BJfj7BeOK</a></p>



<a name="261942786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261942786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261942786">(Nov 18 2021 at 15:31)</a>:</h4>
<p>wrong link?</p>



<a name="261942899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261942899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261942899">(Nov 18 2021 at 15:32)</a>:</h4>
<p>don't think so</p>



<a name="261942910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261942910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261942910">(Nov 18 2021 at 15:32)</a>:</h4>
<p><a href="https://hackmd.io/@nikomatsakis/BJfj7BeOK#Async-fn-in-traits">this section</a> covers it</p>



<a name="261942954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261942954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261942954">(Nov 18 2021 at 15:32)</a>:</h4>
<p><a href="https://hackmd.io/@nikomatsakis/BJfj7BeOK#Naming-the-future-that-is-returned">and this one</a></p>



<a name="261942959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261942959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261942959">(Nov 18 2021 at 15:32)</a>:</h4>
<p>it's so much simpler you might not recognize it :)</p>



<a name="261942989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261942989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261942989">(Nov 18 2021 at 15:33)</a>:</h4>
<p>tl;dr when you have <code>-&gt; impl Trait</code> in a trait, we add an associated type with same name as the method to represent the return type</p>



<a name="261943021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261943021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261943021">(Nov 18 2021 at 15:33)</a>:</h4>
<p>plus a <em>touch</em> of sugar to help make the <code>for&lt;'a&gt;</code> more tractable</p>



<a name="261943049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261943049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261943049">(Nov 18 2021 at 15:33)</a>:</h4>
<p>(the sugar may be a bit controversial; there are some alternatives i've been toying with there, though what's written up there is the one I like best)</p>



<a name="261943061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261943061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261943061">(Nov 18 2021 at 15:33)</a>:</h4>
<p>ah I see, /me reads</p>



<a name="261943079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261943079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261943079">(Nov 18 2021 at 15:34)</a>:</h4>
<p>gosh so many updates to make to the async fundamentals repo</p>



<a name="261943216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261943216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261943216">(Nov 18 2021 at 15:34)</a>:</h4>
<p>it also covers the "dyner" story, <span class="user-mention" data-user-id="256841">@Nick Cameron</span></p>



<a name="261943236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261943236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261943236">(Nov 18 2021 at 15:35)</a>:</h4>
<p>though I had some ideas on the subway home last night that made it a bit out of date :)</p>



<a name="261943892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261943892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261943892">(Nov 18 2021 at 15:39)</a>:</h4>
<p>So, to rephrase, the idea is that you allow users of an async trait to name the synthesised associated types? Presumably the same thing works for RPITIT</p>



<a name="261944187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261944187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261944187">(Nov 18 2021 at 15:41)</a>:</h4>
<p>IS the HRL shorthand proposed, or does that work today?</p>



<a name="261944779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261944779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261944779">(Nov 18 2021 at 15:45)</a>:</h4>
<p>Could you use it in a trait decl too? As a way to add bounds to the future. E.g.,:</p>
<div class="codehilite"><pre><span></span><code>trait HttpRequestProvider {
  async fn request(&amp;mut self, request: Request) -&gt; Response where Self::request: Send;
}
</code></pre></div>



<a name="261944828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261944828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261944828">(Nov 18 2021 at 15:45)</a>:</h4>
<p>That seems kind of long-winded though</p>



<a name="261949638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261949638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261949638">(Nov 18 2021 at 16:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/async.20foundations.20stakeholder.20planning/near/261943049">said</a>:</p>
<blockquote>
<p>(the sugar may be a bit controversial; there are some alternatives i've been toying with there, though what's written up there is the one I like best)</p>
</blockquote>
<p>What about:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="n">P</span>::<span class="n">request</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span>: <span class="nb">Send</span>
</code></pre></div>
<p>The more I think about (explicitly-)elided lifetime parameters in <code>where</code> clauses, the more it makes sense to make them higher-order (at least when on the left-hand side of the clause):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">T</span><span class="w"> </span>: <span class="nb">Send</span><span class="p">,</span><span class="w"> </span><span class="c1">// instead of `T : Sync`</span>
</code></pre></div>
<p>with the caveat (similar to that when defining an <code>impl</code> receiver), of having "input lifetime parameter" elision rules only: each elided lifetime would be distinct from one another:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">where</span><span class="w"></span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">P</span>::<span class="n">request</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="w"> </span>: <span class="nb">Send</span><span class="p">,</span><span class="w"></span>
<span class="c1">// same as:</span>
<span class="w">    </span><span class="k">for</span><span class="o">&lt;'</span><span class="na">any0</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">any1</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;'</span><span class="na">any0</span><span class="w"> </span><span class="n">P</span>::<span class="n">request</span><span class="o">&lt;'</span><span class="na">any1</span><span class="o">&gt;</span><span class="w"> </span>: <span class="nb">Send</span><span class="p">,</span><span class="w"></span>
</code></pre></div>



<a name="261949931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261949931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261949931">(Nov 18 2021 at 16:16)</a>:</h4>
<p>Although I can see why <code>P::request&lt;'_, '_, '_, '_&gt;</code> may not be ideal either <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">P</span>::<span class="n">request</span><span class="o">&lt;'..&gt;</span><span class="w"></span>
</code></pre></div>
<p>? <span aria-label="see no evil" class="emoji emoji-1f648" role="img" title="see no evil">:see_no_evil:</span></p>



<a name="261951567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/261951567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rpjohnst <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#261951567">(Nov 18 2021 at 16:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/async.20foundations.20stakeholder.20planning/near/261941181">said</a>:</p>
<blockquote>
<p>Yeah, I am incliend to agree with 'ugly as hell'. I've significantly revised the approach and I'm much happier with it. Take a look at current draft: <a href="https://hackmd.io/@nikomatsakis/BJfj7BeOK">https://hackmd.io/@nikomatsakis/BJfj7BeOK</a></p>
</blockquote>
<p>I don't see it mentioned in the doc but this has a really nice symmetry with tuple structs- <code>struct Foo(T, U)</code> desugars to a type <code>Foo</code> and a constructor <code>fn Foo</code>; here <code>async fn foo</code> also desugars to a type <code>foo</code> and a constructor <code>fn foo</code>!</p>



<a name="262017434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/262017434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#262017434">(Nov 19 2021 at 01:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/async.20foundations.20stakeholder.20planning/near/261943892">said</a>:</p>
<blockquote>
<p>So, to rephrase, the idea is that you allow users of an async trait to name the synthesised associated types? Presumably the same thing works for RPITIT</p>
</blockquote>
<p>yeah, we should do the same for RPITIT</p>



<a name="262017535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/262017535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#262017535">(Nov 19 2021 at 01:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/async.20foundations.20stakeholder.20planning/near/261773065">said</a>:</p>
<blockquote>
<p>Getting slightly more philosophical, I find the whole motivation a bit off. The whole point of impl Trait is to abstract away the concrete type and we're now trying to find a way to break that encapsulation. Seems like a footgun, since upstream might change the implementation and break downstream code which relies on that named type. Unless I'm missing some safeguards against this</p>
</blockquote>
<p>you can make the type nameable <em>without</em> giving up the encapsulation ordinarily provided by <code>impl Trait</code></p>



<a name="262017662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/262017662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#262017662">(Nov 19 2021 at 01:43)</a>:</h4>
<p><code>impl Trait</code> already leaks auto traits like <code>Send</code> (as long as you know what impl is being used; i.e. you're using static dispatch)</p>



<a name="262017893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/262017893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#262017893">(Nov 19 2021 at 01:46)</a>:</h4>
<p>so when you write <code>P::request</code> the value of that associated type can still be <code>impl Future&lt;Output = Response&gt;</code>, which tells you only about the <code>Future</code> bound and the auto traits of the type</p>



<a name="262018240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/262018240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#262018240">(Nov 19 2021 at 01:53)</a>:</h4>
<p>On the <a href="https://github.com/rust-lang/rfcs/pull/3193">RPITIT RFC</a> there was discussion around how this can be extended to other properties the impl chooses to advertise. So for example</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">MyIntoIterator</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Item</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">my_into_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Item</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>could be "refined" in an impl:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">NewIntoIterator</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Range</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">type</span> <span class="nc">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">into_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt;
        <span class="nc">impl</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">Item</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">        </span><span class="nb">DoubleEndedIterator</span><span class="w"></span>
<span class="w">    </span><span class="c1">//  ^^^^^^^^^^^^^^^^^^^ not in the trait!</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="262018259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/262018259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#262018259">(Nov 19 2021 at 01:53)</a>:</h4>
<p>But this is something the impl opts in to, giving the author as much flexibility as they want to make future changes</p>



<a name="262043347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/262043347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#262043347">(Nov 19 2021 at 09:16)</a>:</h4>
<p>Yeah, I'm all for allowing refinement of abstract return types in impls</p>



<a name="262043494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/262043494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#262043494">(Nov 19 2021 at 09:18)</a>:</h4>
<p>I like the associated type proposal, that seems to get the balance right in that it lets users constrain the type without being able to name the concrete type. Presumably that means it doesn't address some of the use cases, but that is fine by me</p>



<a name="262085657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20foundations%20stakeholder%20planning/near/262085657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20foundations.20stakeholder.20planning.html#262085657">(Nov 19 2021 at 15:59)</a>:</h4>
<p>It's possible we could allow the impl could refine the type all the way to a concrete type</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>