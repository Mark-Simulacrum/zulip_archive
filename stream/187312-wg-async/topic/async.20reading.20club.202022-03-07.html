<html>
<head><meta charset="utf-8"><title>async reading club 2022-03-07 · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html">async reading club 2022-03-07</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274414658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274414658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274414658">(Mar 07 2022 at 16:17)</a>:</h4>
<p>Hey <span class="user-group-mention" data-user-group-id="1172">@WG-async-foundations</span> !</p>



<a name="274414765"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274414765" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274414765">(Mar 07 2022 at 16:18)</a>:</h4>
<p>I was getting ready to send a message :)</p>



<a name="274414769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274414769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274414769">(Mar 07 2022 at 16:18)</a>:</h4>
<p>The plan for today was to do our first session of the <a href="https://hackmd.io/6kSbmyggT6eAy5uvdB6srA?view">Async Reading Club</a>, right?</p>



<a name="274414807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274414807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274414807">(Mar 07 2022 at 16:18)</a>:</h4>
<p>To that end, let me review the way we expected this to go...</p>



<a name="274414821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274414821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274414821">(Mar 07 2022 at 16:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274414658">said</a>:</p>
<blockquote>
<p>Hey <span class="user-group-mention silent" data-user-group-id="1172">WG-async-foundations</span> !</p>
</blockquote>
<p>also, we need to rename that alias</p>



<a name="274414844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274414844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274414844">(Mar 07 2022 at 16:18)</a>:</h4>
<p>first off, please <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> on the top message to show you're around</p>



<a name="274414904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274414904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274414904">(Mar 07 2022 at 16:19)</a>:</h4>
<p>second, today's reading is <a href="https://blog.yoshuawuyts.com/async-cancellation-1/">async cancellation I</a> by our very own <span class="user-mention" data-user-id="211722">@Yoshua Wuyts [he/they]</span> <span aria-label="clap" class="emoji emoji-1f44f" role="img" title="clap">:clap:</span> <span aria-label="clap" class="emoji emoji-1f44f" role="img" title="clap">:clap:</span> <span aria-label="clap" class="emoji emoji-1f44f" role="img" title="clap">:clap:</span></p>



<a name="274414950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274414950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274414950">(Mar 07 2022 at 16:19)</a>:</h4>
<p>the idea is that we will read for "a while" and then chat about it afterwards</p>



<a name="274414976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274414976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274414976">(Mar 07 2022 at 16:19)</a>:</h4>
<p>I figure we can keep track of who is still reading by adding emoji to a message</p>



<a name="274414996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274414996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274414996">(Mar 07 2022 at 16:19)</a>:</h4>
<p>the expected alloc was 15 minutes to read, 30 minutes to chat</p>



<a name="274415009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274415009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274415009">(Mar 07 2022 at 16:19)</a>:</h4>
<p>but we can extend the reading time as needed</p>



<a name="274415034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274415034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274415034">(Mar 07 2022 at 16:20)</a>:</h4>
<p>questions?</p>



<a name="274415130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274415130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274415130">(Mar 07 2022 at 16:20)</a>:</h4>
<p>Hah, I think I assumed folks would read in advance, and this meeting was just for discussion!</p>



<a name="274415147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274415147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274415147">(Mar 07 2022 at 16:20)</a>:</h4>
<p>I don't believe in homework</p>



<a name="274415160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274415160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274415160">(Mar 07 2022 at 16:21)</a>:</h4>
<p>by which I mean "nobody ever does it" :)</p>



<a name="274415175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274415175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274415175">(Mar 07 2022 at 16:21)</a>:</h4>
<p>In case anyone finishes reading sooner, I started work on a follow-up today: <a href="https://hackmd.io/xoKN8luWTcSKw5kJfNLJ5Q?view">https://hackmd.io/xoKN8luWTcSKw5kJfNLJ5Q?view</a></p>



<a name="274415201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274415201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274415201">(Mar 07 2022 at 16:21)</a>:</h4>
<p>To signal you are reading, please add the <span aria-label="book" class="emoji emoji-1f4d6" role="img" title="book">:book:</span> emoji to this message. To signal you're done, add the <span aria-label="checkbox" class="emoji emoji-2611" role="img" title="checkbox">:checkbox:</span> emoji.</p>



<a name="274418047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274418047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274418047">(Mar 07 2022 at 16:35)</a>:</h4>
<p>it's been 15 minutes-- I'm still reading a bit</p>



<a name="274418060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274418060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274418060">(Mar 07 2022 at 16:35)</a>:</h4>
<p>seems like 2 others are too</p>



<a name="274418116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274418116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274418116">(Mar 07 2022 at 16:36)</a>:</h4>
<p>5 more minutes?</p>



<a name="274418254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274418254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274418254">(Mar 07 2022 at 16:36)</a>:</h4>
<p>Already this is reminding me of the classic "cancellation of a non-cancel-safe future" in a <code>select!</code> statement. I fixed one literally on friday (fortunately not exploitable), having an <code>Async</code> trait that the future that was being selected did not implement would have caught it earlier!</p>



<a name="274419031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419031">(Mar 07 2022 at 16:41)</a>:</h4>
<p>ok, I'm done now</p>



<a name="274419048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419048">(Mar 07 2022 at 16:42)</a>:</h4>
<p>and it's been 5 minutes</p>



<a name="274419095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419095">(Mar 07 2022 at 16:42)</a>:</h4>
<p>shall we chat?</p>



<a name="274419164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419164">(Mar 07 2022 at 16:42)</a>:</h4>
<p>I have a question for <span class="user-mention" data-user-id="211722">@Yoshua Wuyts [he/they]</span></p>



<a name="274419178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419178">(Mar 07 2022 at 16:42)</a>:</h4>
<p>Yeah for sure!</p>



<a name="274419209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419209">(Mar 07 2022 at 16:42)</a>:</h4>
<p>the post talks about challenges caused by manual implementations of <code>Future</code></p>



<a name="274419262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419262">(Mar 07 2022 at 16:43)</a>:</h4>
<p>I'm curious what challenges you are thinking of; it's not obvious to me why manual impls would be more-or-less robust than async-await based code</p>



<a name="274419305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419305">(Mar 07 2022 at 16:43)</a>:</h4>
<p>in particular, I would expect that (either way) all state that must be stored across a poll finds its way into <code>self</code>, which is dropped</p>



<a name="274419440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419440">(Mar 07 2022 at 16:44)</a>:</h4>
<p>Yes, that makes sense</p>



<a name="274419544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419544">(Mar 07 2022 at 16:45)</a>:</h4>
<p>the challenging cases (for both of them, in my mind) come about when there is no destructor to run, and the expectation is that something will happen because the "state machine" will take us to a state where it occurs</p>
<p>e.g.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">activate</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">R</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w"> </span><span class="c1">// in sync code, this would be a `FnOnce()`</span>
<span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274419628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419628">(Mar 07 2022 at 16:45)</a>:</h4>
<p>right that's true</p>



<a name="274419739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419739">(Mar 07 2022 at 16:46)</a>:</h4>
<p>I think what I meant there is that writing state machines by hand is hard</p>



<a name="274419770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419770">(Mar 07 2022 at 16:46)</a>:</h4>
<p>no argument there :)</p>



<a name="274419849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419849">(Mar 07 2022 at 16:46)</a>:</h4>
<p>So you have to be extra extra extra careful about your assumptions; especially when e.g. modifying non-local state (state which outlives the existence of the future)</p>



<a name="274419904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419904">(Mar 07 2022 at 16:47)</a>:</h4>
<p>one thing I thought was interesting was talking about <em>why</em> one might want to "catch" a cancellation; it seems like that question also depends on why cancellations are occurring in the first place</p>



<a name="274419965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274419965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274419965">(Mar 07 2022 at 16:47)</a>:</h4>
<p>I've seen two (maybe 3, depending on how you count) general patterns</p>



<a name="274420050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420050">(Mar 07 2022 at 16:48)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> So I try and answer that in more detail in the follow-up post: <a href="https://hackmd.io/xoKN8luWTcSKw5kJfNLJ5Q?view#Async-Cancellation-vs-Other-Halts">https://hackmd.io/xoKN8luWTcSKw5kJfNLJ5Q?view#Async-Cancellation-vs-Other-Halts</a>; I actually don't think we ever want to "catch" cancellations.</p>



<a name="274420084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420084">(Mar 07 2022 at 16:48)</a>:</h4>
<p>one is basically "client dropped their side of the connection" (or, similarly, timed out) -- then you just want to tear down everything related to that client</p>



<a name="274420164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420164">(Mar 07 2022 at 16:49)</a>:</h4>
<p>I agree that "catching" isn't likely what you want, though you do want to "recover"</p>



<a name="274420227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420227">(Mar 07 2022 at 16:49)</a>:</h4>
<p>"cancellations" are something you call / opt into. As opposed to "errors/panics" which you need to guard against or "catch".</p>



<a name="274420276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420276">(Mar 07 2022 at 16:49)</a>:</h4>
<p>Talking about catching a cancellation always feels backwards to me. Catching in the contexts of exceptions means catching an exception that came from down the stack, while async cancellation comes from up the stack.</p>



<a name="274420415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420415">(Mar 07 2022 at 16:50)</a>:</h4>
<p>I guess that sounds different than the example you're providing; so I think we may be looking at it differently. I would assume that if a client unexpectedly hangs up, that would be a state represented by <code>io::Result</code>?</p>



<a name="274420419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420419">(Mar 07 2022 at 16:50)</a>:</h4>
<p>another reason that people use cancellation, e.g. the reason highlighted in <a href="https://tomaka.medium.com/a-look-back-at-asynchronous-rust-d54d63934a1c">tomaka's blog post</a>), seems to be about "interrupts". tokio's mini-redis serve also has this pattern:</p>
<p><a href="https://github.com/tokio-rs/mini-redis/blob/6513e5226c2cfe1108cb89de009c29fe756d436a/src/cmd/subscribe.rs#L127-L137">https://github.com/tokio-rs/mini-redis/blob/6513e5226c2cfe1108cb89de009c29fe756d436a/src/cmd/subscribe.rs#L127-L137</a></p>



<a name="274420473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420473">(Mar 07 2022 at 16:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211722">Yoshua Wuyts [he/they]</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274420415">said</a>:</p>
<blockquote>
<p>I guess that sounds different than the example you're providing; so I think we may be looking at it differently. I would assume that if a client unexpectedly hangs up, that would be a state represented by <code>io::Result</code>?</p>
</blockquote>
<p>well, it may first be detected that way</p>



<a name="274420532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420532">(Mar 07 2022 at 16:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274420419">said</a>:</p>
<blockquote>
<p>another reason that people use cancellation, e.g. the reason highlighted in <a href="https://tomaka.medium.com/a-look-back-at-asynchronous-rust-d54d63934a1c">tomaka's blog post</a>), seems to be about "interrupts". tokio's mini-redis serve also has this pattern:</p>
</blockquote>
<p>(I feel that this is not desirable, to be clear)</p>



<a name="274420608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420608">(Mar 07 2022 at 16:52)</a>:</h4>
<p>I think we need a better primitive here, this is basically a missing "run these two things concurrently" primitive; something like scoped spawn would be ideal</p>



<a name="274420628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420628">(Mar 07 2022 at 16:52)</a>:</h4>
<p>I'm not sure I understand the "interrupts" analogy?</p>



<a name="274420632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420632">(Mar 07 2022 at 16:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211722">Yoshua Wuyts [he/they]</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274420415">said</a>:</p>
<blockquote>
<p>I guess that sounds different than the example you're providing; so I think we may be looking at it differently. I would assume that if a client unexpectedly hangs up, that would be a state represented by <code>io::Result</code>?</p>
</blockquote>
<p>it'd probably be good to talk through the expected workflow for a case like this in detail, agreed</p>



<a name="274420727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420727">(Mar 07 2022 at 16:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274420628">said</a>:</p>
<blockquote>
<p>I'm not sure I understand the "interrupts" analogy?</p>
</blockquote>
<p>what happens in that snippet is:</p>
<ul>
<li>one future processes frames in a kind of loop</li>
<li>another future waits for a message to arrive</li>
</ul>
<p>there is a select of the two</p>
<p>if a message arrives, it will cancel the first and immediate respond to that message</p>



<a name="274420756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420756">(Mar 07 2022 at 16:53)</a>:</h4>
<p>the code is written to be "halt-" or "cancel-safe", so that canceling it doesn't lose work</p>



<a name="274420758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420758">(Mar 07 2022 at 16:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274420419">said</a>:</p>
<blockquote>
<p>another reason that people use cancellation, e.g. the reason highlighted in <a href="https://tomaka.medium.com/a-look-back-at-asynchronous-rust-d54d63934a1c">tomaka's blog post</a>), seems to be about "interrupts". tokio's mini-redis serve also has this pattern:</p>
<p><a href="https://github.com/tokio-rs/mini-redis/blob/6513e5226c2cfe1108cb89de009c29fe756d436a/src/cmd/subscribe.rs#L127-L137">https://github.com/tokio-rs/mini-redis/blob/6513e5226c2cfe1108cb89de009c29fe756d436a/src/cmd/subscribe.rs#L127-L137</a></p>
</blockquote>
<p>Both those examples seem to rely heavily on <code>select! {}</code>. I wrote <a href="https://blog.yoshuawuyts.com/futures-concurrency-3/">a post</a> recently dissecting <code>select! {}</code> and its issues. I'd be interested in seeing examples that don't use <code>select! {}</code>.</p>



<a name="274420811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420811">(Mar 07 2022 at 16:53)</a>:</h4>
<p>I personally think select <em>and select-like</em> APIs are key to the failure modes here</p>



<a name="274420829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420829">(Mar 07 2022 at 16:53)</a>:</h4>
<p>it's easy to construct a similar example from <code>race</code></p>



<a name="274420861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420861">(Mar 07 2022 at 16:53)</a>:</h4>
<p>but it looks a bit more...semantically fishy :)</p>



<a name="274420967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274420967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274420967">(Mar 07 2022 at 16:54)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">while</span><span class="w"> </span><span class="n">not_done</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">process_low_priority_message</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">race</span><span class="p">(</span><span class="n">process_higher_priority_message</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274421035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421035">(Mar 07 2022 at 16:54)</a>:</h4>
<p>to be clear on what I'm saying, I am not saying "look, you can mis-use race, therefore cancellation is broken"</p>



<a name="274421062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421062">(Mar 07 2022 at 16:55)</a>:</h4>
<p>I think in general, the reason a future wants to catch a cancellation is because cancellation is very abrupt, you can't prepare for it. Therefore, the future might want to tidy up its resources in a more predictable way. This is somewhat analogous to panicking where we assume that panicking leaves the thread in an inconsistent state (thus mutex poisoning, etc), but since cancellation doesn't kill the thread, people want some opportunity to get back to a consistent state</p>



<a name="274421064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421064">(Mar 07 2022 at 16:55)</a>:</h4>
<p>I'm saying "race is probably a better abstraction, because it's clearer about its purpose, and it's more obvious that the above code is broken"</p>



<a name="274421130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421130">(Mar 07 2022 at 16:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274421062">said</a>:</p>
<blockquote>
<p>I think in general, the reason a future wants to catch a cancellation is because cancellation is very abrupt, you can't prepare for it. Therefore, the future might want to tidy up its resources in a more predictable way. This is somewhat analogous to panicking where we assume that panicking leaves the thread in an inconsistent state (thus mutex poisoning, etc), but since cancellation doesn't kill the thread, people want some opportunity to get back to a consistent state</p>
</blockquote>
<p>right, and one question I have is how much async-drop changes the calculus here</p>



<a name="274421150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421150">(Mar 07 2022 at 16:55)</a>:</h4>
<p>I think that forced, synchronous cancellation is not great</p>



<a name="274421259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421259">(Mar 07 2022 at 16:56)</a>:</h4>
<p>the other question is how much things like scope do, because examples like the one I gave (<code>self.active = false</code>) don't matter if <code>self</code> itself will get torn down</p>



<a name="274421307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421307">(Mar 07 2022 at 16:56)</a>:</h4>
<p>async drop seems less than a complete solution, for IO in particular, you cancel because you don't want to wait, but async drop would still block the task</p>



<a name="274421323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421323">(Mar 07 2022 at 16:56)</a>:</h4>
<p>(but that in turn comes back to why we are using cancellation)</p>



<a name="274421347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421347">(Mar 07 2022 at 16:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274421062">said</a>:</p>
<blockquote>
<p>I think in general, the reason a future wants to catch a cancellation is because cancellation is very abrupt, you can't prepare for it. Therefore, the future might want to tidy up its resources in a more predictable way. This is somewhat analogous to panicking where we assume that panicking leaves the thread in an inconsistent state (thus mutex poisoning, etc), but since cancellation doesn't kill the thread, people want some opportunity to get back to a consistent state</p>
</blockquote>
<p>I guess I don't understand what this means?</p>



<a name="274421366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421366">(Mar 07 2022 at 16:57)</a>:</h4>
<p>things like select give no reason at all; this like race are a bit better, but I could see them being vulnerable to the bugs I talked about</p>



<a name="274421451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421451">(Mar 07 2022 at 16:57)</a>:</h4>
<p>e.g., </p>
<p><code>with_flag_set(do_the_thing()).race(other_thing()).await</code></p>
<p>the <code>with_flag_set</code> method needs to use some kind of destructor to "unset" the flag</p>



<a name="274421459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421459">(Mar 07 2022 at 16:57)</a>:</h4>
<p>"I guess I don't understand what this means?" - which part?</p>



<a name="274421552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421552">(Mar 07 2022 at 16:58)</a>:</h4>
<p>in any case, we're approaching time--</p>



<a name="274421566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421566">(Mar 07 2022 at 16:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274421459">said</a>:</p>
<blockquote>
<p>"I guess I don't understand what this means?" - which part?</p>
</blockquote>
<p>I guess I don't understand what people say with "catching a cancellation" <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="274421603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421603">(Mar 07 2022 at 16:58)</a>:</h4>
<p><span class="user-mention" data-user-id="211722">@Yoshua Wuyts [he/they]</span> should we throw your hackmd on the list of future reads?</p>



<a name="274421623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421623">(Mar 07 2022 at 16:58)</a>:</h4>
<p>(I think I'm having a hard time articulating it over text)</p>



<a name="274421674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421674">(Mar 07 2022 at 16:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I can probably work it into a full post. <a href="https://blog.yoshuawuyts.com/futures-concurrency-3/">https://blog.yoshuawuyts.com/futures-concurrency-3/</a> might be a better one to add to it first.</p>



<a name="274421687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421687">(Mar 07 2022 at 16:59)</a>:</h4>
<p>One of the things I find challenging about cancellation is that there are different vantage points you can look at it from, and I'm not sure we've categorized all these.</p>



<a name="274421720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421720">(Mar 07 2022 at 16:59)</a>:</h4>
<p>I want to emphasize that I think the goal of these async reading clubs is <em>mostly</em> to have us all reading things and sparking conversation, I imagine most of the interesting conversation will occur in follow-ups, so perhaps <span class="user-mention" data-user-id="256841">@Nick Cameron</span> and <span class="user-mention" data-user-id="211722">@Yoshua Wuyts [he/they]</span> you can continue this afterwards</p>



<a name="274421753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421753">(Mar 07 2022 at 16:59)</a>:</h4>
<p>but one thing I would like to do before we hit the hour mark</p>



<a name="274421766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421766">(Mar 07 2022 at 16:59)</a>:</h4>
<p>is to select what we'll read in 2 weeks!</p>



<a name="274421803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421803">(Mar 07 2022 at 16:59)</a>:</h4>
<p>Like, there's cancellation from the view of a future that is at a <code>.await</code> point and no one polls them, and there's cancellation from the view of the runtime, etc.</p>



<a name="274421897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421897">(Mar 07 2022 at 17:00)</a>:</h4>
<p>looks like we should add "Futures concurrency 3" to the list</p>



<a name="274421915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274421915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274421915">(Mar 07 2022 at 17:00)</a>:</h4>
<p><a href="https://hackmd.io/6kSbmyggT6eAy5uvdB6srA?view">https://hackmd.io/6kSbmyggT6eAy5uvdB6srA?view</a></p>



<a name="274422080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422080">(Mar 07 2022 at 17:01)</a>:</h4>
<p>I propose</p>
<table>
<thead>
<tr>
<th><a href="https://perchance.org/emoji">Random emoji</a></th>
<th>Document</th>
<th>Added to list by</th>
<th>Why?</th>
</tr>
</thead>
<tbody>
<tr>
<td><span aria-label="peach" class="emoji emoji-1f351" role="img" title="peach">:peach:</span></td>
<td><a href="https://www.ncameron.org/blog/async-read-and-write-traits/">Async I/O traits</a></td>
<td>nikomatsakis</td>
<td>Key output of one of our groups</td>
</tr>
</tbody>
</table>
<p>?</p>



<a name="274422110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422110">(Mar 07 2022 at 17:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211722">Yoshua Wuyts [he/they]</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274421566">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274421459">said</a>:</p>
<blockquote>
<p>"I guess I don't understand what this means?" - which part?</p>
</blockquote>
<p>I guess I don't understand what people say with "catching a cancellation" <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
</blockquote>
<p>Some kind of hook so that a future can take action in the event of cancellation. I imagine something like <code>defer</code> but only called on cancellation, rather than on every exit. Or something like that.</p>



<a name="274422187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422187">(Mar 07 2022 at 17:01)</a>:</h4>
<p>would it be crazy to add <a href="https://tomaka.medium.com/a-look-back-at-asynchronous-rust-d54d63934a1c">https://tomaka.medium.com/a-look-back-at-asynchronous-rust-d54d63934a1c</a> to the list? I feel like that brings up a couple interesting things</p>



<a name="274422207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422207">(Mar 07 2022 at 17:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274422080">said</a>:</p>
<blockquote>
<p>I propose</p>
<table>
<thead>
<tr>
<th><a href="https://perchance.org/emoji">Random emoji</a></th>
<th>Document</th>
<th>Added to list by</th>
<th>Why?</th>
</tr>
</thead>
<tbody>
<tr>
<td><span aria-label="peach" class="emoji emoji-1f351" role="img" title="peach">:peach:</span></td>
<td><a href="https://www.ncameron.org/blog/async-read-and-write-traits/">Async I/O traits</a></td>
<td>nikomatsakis</td>
<td>Key output of one of our groups</td>
</tr>
</tbody>
</table>
<p>?</p>
</blockquote>
<p>I have read it but wfm</p>



<a name="274422217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422217">(Mar 07 2022 at 17:01)</a>:</h4>
<p>nope, feel free <span class="user-mention" data-user-id="257428">@Gus Wynn</span></p>



<a name="274422306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422306">(Mar 07 2022 at 17:02)</a>:</h4>
<p>but also, <span class="user-mention" data-user-id="421986">@eholk</span> 's point that we haven't actually fully categorized what cancellation IS is a good one</p>



<a name="274422329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422329">(Mar 07 2022 at 17:02)</a>:</h4>
<p>yes, I think a good idea would be to have more blog posts exploring that</p>



<a name="274422350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422350">(Mar 07 2022 at 17:02)</a>:</h4>
<p><span class="user-mention" data-user-id="256841">@Nick Cameron</span> Ohh, right yeah! I guess right now we have that in the form of <code>Drop</code> / drop guards. But something like an "async drop" / <code>defer</code> / "async <code>defer</code>" might make that easier.</p>



<a name="274422377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422377">(Mar 07 2022 at 17:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116883">tmandry</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274422207">said</a>:</p>
<blockquote>
<p>I have read it but wfm</p>
</blockquote>
<p>other suggestions?</p>



<a name="274422479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422479">(Mar 07 2022 at 17:03)</a>:</h4>
<p>Maybe <a href="https://blog.yoshuawuyts.com/async-overloading/">https://blog.yoshuawuyts.com/async-overloading/</a> ?</p>



<a name="274422484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422484">(Mar 07 2022 at 17:03)</a>:</h4>
<p>(side note, I should probably remove the "random emoji" entry :)</p>



<a name="274422498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422498">(Mar 07 2022 at 17:03)</a>:</h4>
<p>(sorry to be tooting my own horn here)</p>



<a name="274422507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422507">(Mar 07 2022 at 17:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211722">Yoshua Wuyts [he/they]</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274422479">said</a>:</p>
<blockquote>
<p>Maybe <a href="https://blog.yoshuawuyts.com/async-overloading/">https://blog.yoshuawuyts.com/async-overloading/</a> ?</p>
</blockquote>
<p>that could be a good one, yes</p>



<a name="274422539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422539">(Mar 07 2022 at 17:03)</a>:</h4>
<p>it does seem like an imp't thing for us to be discussing, but it's also a <em>bit</em> further out</p>



<a name="274422550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422550">(Mar 07 2022 at 17:03)</a>:</h4>
<p>which I like</p>



<a name="274422563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422563">(Mar 07 2022 at 17:03)</a>:</h4>
<p>i.e., I intend to read the async I/O traits sooner too :)</p>



<a name="274422594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422594">(Mar 07 2022 at 17:03)</a>:</h4>
<p>let's do that!</p>



<a name="274422695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422695">(Mar 07 2022 at 17:04)</a>:</h4>
<p>sounds good</p>



<a name="274422753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274422753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274422753">(Mar 07 2022 at 17:04)</a>:</h4>
<p>on the topic of tooting one's own horn, if folks haven't read it, I also wrote <a href="https://smallcultfollowing.com/babysteps//blog/2022/01/27/panics-vs-cancellation-part-1/">panics vs cancellation, part 1</a>, and I've got some other parts upcoming...</p>



<a name="274423040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274423040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274423040">(Mar 07 2022 at 17:06)</a>:</h4>
<p>I added it to the list too</p>



<a name="274423089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274423089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274423089">(Mar 07 2022 at 17:06)</a>:</h4>
<p>thanks all!</p>



<a name="274423099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274423099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274423099">(Mar 07 2022 at 17:06)</a>:</h4>
<p>this was fun :)</p>



<a name="274423135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274423135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274423135">(Mar 07 2022 at 17:07)</a>:</h4>
<p>thanks!</p>



<a name="274509495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274509495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274509495">(Mar 08 2022 at 08:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="211722">Yoshua Wuyts [he/they]</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274422350">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> Ohh, right yeah! I guess right now we have that in the form of <code>Drop</code> / drop guards. But something like an "async drop" / <code>defer</code> / "async <code>defer</code>" might make that easier.</p>
</blockquote>
<p>I guess that drop guards/defer are somewhat equivalent. Though I think the higher order bit here is that we (as a group I mean, or maybe just I) don't have a great idea about how this would look. Maybe it is worth thinking that through? I've mostly been considering non-cancellable futures rather than futures with an opportunity to catch cancellation. It seems like the latter would be much easier to incorporate without huge changes.</p>



<a name="274509735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274509735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274509735">(Mar 08 2022 at 08:31)</a>:</h4>
<p>In particular, I think its worth considering how guaranteed to run such a hook would have to be to be useful. At the moment, regular <code>drop</code> is not good enough for many uses, but we'd never be able to guarantee 100% that a hook would run (at the limit, the process could be terminated between cancellation starting and the cancel hook running). Is it enough to say the hook will run unless the task terminates? The thread?</p>



<a name="274510058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274510058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274510058">(Mar 08 2022 at 08:35)</a>:</h4>
<p>If the hook is async, I think that thread-level is needed to support structured concurrency? For the use case for completion IO buffers that might not be enough.</p>



<a name="274510208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274510208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274510208">(Mar 08 2022 at 08:37)</a>:</h4>
<p>I guess even for structured concurrency it might not be enough, depending on the guarantees people want to rely on it for</p>



<a name="274522684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274522684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274522684">(Mar 08 2022 at 10:39)</a>:</h4>
<p><span class="user-mention" data-user-id="256841">@Nick Cameron</span> so if I'm understanding you correctly by "async hook" you mean something resembling an "async drop guard", and what makes an "async drop guard" possible is "async drop". Async drop is definitely crucial to Rust's async story, very much including cancellation, and imo as long as we don't have it we'll be working around it awkwardly.</p>



<a name="274523039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274523039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274523039">(Mar 08 2022 at 10:42)</a>:</h4>
<p>I don't quite understand the concerns of "structured concurrency" or the comments on when async drop would be run. The way I've been thinking about it, we should be able to <code>.await</code> destructors on drop within async contexts in the same spots sync drop would run. The only library code which really needs to be aware of async drop would be runtimes, which need to ensure that the top-level futures passed to them also have their destructors run.</p>



<a name="274523116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274523116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274523116">(Mar 08 2022 at 10:43)</a>:</h4>
<p>There are some fun design questions about async drop though, in particular the issue of <a href="https://without.boats/blog/poll-drop/">introducing new state</a>. But even this I suspect we may be able to figure out. So we don't end up with a <code>poll_drop</code> method, but an <code>async fn drop</code> instead.</p>



<a name="274523665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274523665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274523665">(Mar 08 2022 at 10:48)</a>:</h4>
<p>So, I think async drop might not be enough because it would not be guaranteed to run (like sync drop) and for a cancellation hook to be useful (well, as useful as non-cancellable futures) I think we need SOME stronger guarantee than that.</p>



<a name="274523734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274523734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274523734">(Mar 08 2022 at 10:49)</a>:</h4>
<p>Can you elaborate why?</p>



<a name="274523811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274523811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274523811">(Mar 08 2022 at 10:49)</a>:</h4>
<p>IMO, defer might be a good solution because it means we wouldn’t need async drop, it could just be a regular function which you await in the defer block. Of course that means defer has to be special rather than just sugar for drop</p>



<a name="274523913"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274523913" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274523913">(Mar 08 2022 at 10:50)</a>:</h4>
<p>I'm not sure I understand how that would be different from an "async drop" ?</p>



<a name="274524053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524053">(Mar 08 2022 at 10:52)</a>:</h4>
<p>So, my reasoning is that async drop is equivalent to non cancellable because you can await in it, ie you can block the task for as long as you need before cancellation finishes. However, that is only true if the drop is guaranteed to be run, if not then you can still be abruptly cancelled and cannot reason about the state of the program in all cases</p>



<a name="274524089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524089">(Mar 08 2022 at 10:52)</a>:</h4>
<p>It is different because the await can be made explicit</p>



<a name="274524126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524126">(Mar 08 2022 at 10:52)</a>:</h4>
<p>ah, so I think this gets to a question: "should async drop be cancellable?"</p>



<a name="274524138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524138">(Mar 08 2022 at 10:52)</a>:</h4>
<p>which feels in the vein of: "can we unwind while unwinding", etc.</p>



<a name="274524148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524148">(Mar 08 2022 at 10:52)</a>:</h4>
<p>Not sure if that is enough of a reason to do it, but it seems that implicit await for drop is weird</p>



<a name="274524215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524215">(Mar 08 2022 at 10:53)</a>:</h4>
<p>I would assume cancelling async drop would abort similar to a double panic. Seems too weak otherwise</p>



<a name="274524516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524516">(Mar 08 2022 at 10:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274524148">said</a>:</p>
<blockquote>
<p>Not sure if that is enough of a reason to do it, but it seems that implicit await for drop is weird</p>
</blockquote>
<p>heh, I guess it depends on your perspective. For example, I suspect that the moment we get it, the weirdness will almost immediately wear off and folks will just be happy to have an async version of drop.</p>



<a name="274524566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524566">(Mar 08 2022 at 10:57)</a>:</h4>
<p>Also if we consider <code>.await</code> as marking a "halting point", and we don't want "async drop" to be cancellable, then the omission of <code>.await</code> makes sense in that regard.</p>



<a name="274524636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524636">(Mar 08 2022 at 10:58)</a>:</h4>
<p>That’s an interesting point!</p>



<a name="274524705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524705">(Mar 08 2022 at 10:59)</a>:</h4>
<p>This analogy _slightly_ gets a bit on thin ice when we consider that before the start of a function block there also exists a "halting point", but that's not annotated by <code>.await</code>. (because futures are never guaranteed to be executed after construction). But maybe that's the odd one out (:</p>



<a name="274524720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524720">(Mar 08 2022 at 10:59)</a>:</h4>
<p>I feel the weirdness is not so much something which feels weird, but just makes the mental model of the whole thing a little bit bigger and harder to explain.</p>



<a name="274524764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524764">(Mar 08 2022 at 10:59)</a>:</h4>
<p>Yeah, I consider that a pretty different kind of halting point to be honest, feels like a different class of thing</p>



<a name="274524921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524921">(Mar 08 2022 at 11:00)</a>:</h4>
<p>Like it’s not ‘started and canceled’ it’s ‘never started’</p>



<a name="274524996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274524996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274524996">(Mar 08 2022 at 11:01)</a>:</h4>
<p>Is it tho?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">fut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">my_fn</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span><span class="w"> </span><span class="n">arg2</span><span class="p">);</span><span class="w"></span>
<span class="nb">drop</span><span class="p">(</span><span class="n">fut</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="274525105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274525105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274525105">(Mar 08 2022 at 11:02)</a>:</h4>
<p>This creates a future, but then drops it. The state machine is still created, values are still moved into it, and destructors will need to be run. To me that feels like "starting and then cancelling".</p>



<a name="274525133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274525133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274525133">(Mar 08 2022 at 11:02)</a>:</h4>
<p>It might be different, but imo not significantly so.</p>



<a name="274525372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274525372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274525372">(Mar 08 2022 at 11:05)</a>:</h4>
<p>From the perspective of the implementer of my_fn, it feels different. There is no opportunity to establish its invariants. Essentially there is no distinction between that and never calling my_fn</p>



<a name="274525458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274525458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274525458">(Mar 08 2022 at 11:06)</a>:</h4>
<p>From outside it is equivalent to calling drop(arg1) and drop(arg2), but polling just once means that is not true</p>



<a name="274525649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274525649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274525649">(Mar 08 2022 at 11:07)</a>:</h4>
<p>It's also calling <code>drop(fut)</code>; and sync functions may establish invariants even if they later return a future.</p>



<a name="274525737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274525737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274525737">(Mar 08 2022 at 11:08)</a>:</h4>
<p>Silly thought: "futures have a life before <code>poll</code>"</p>



<a name="274525828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274525828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274525828">(Mar 08 2022 at 11:09)</a>:</h4>
<p>Right but my point is that for async functions dropping the future is not observable (other than dropping the arguments)</p>



<a name="274525891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274525891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274525891">(Mar 08 2022 at 11:09)</a>:</h4>
<p>I agree that what I shared is less common though; most user code is unlikely to do anything other than immediately return a <code>Future</code>. But strictly speaking, that doesn't necessarily need to be the case.</p>



<a name="274525911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274525911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274525911">(Mar 08 2022 at 11:09)</a>:</h4>
<p>With customs futures returned from a sync function things are different</p>



<a name="274525977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274525977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274525977">(Mar 08 2022 at 11:10)</a>:</h4>
<p>yes okay, sounds like we're on the same page ^^</p>



<a name="274526069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274526069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274526069">(Mar 08 2022 at 11:11)</a>:</h4>
<p>Yeah, I think fundamentally a sync function returning a future and an async function cannot be treated equivalently by the caller, although the differences are usually not too important</p>



<a name="274526166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274526166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274526166">(Mar 08 2022 at 11:12)</a>:</h4>
<p>Can you elaborate why not?</p>



<a name="274526905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274526905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274526905">(Mar 08 2022 at 11:18)</a>:</h4>
<p>Oh actually, I think I might understand what you mean</p>



<a name="274527112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274527112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274527112">(Mar 08 2022 at 11:19)</a>:</h4>
<p>I agree that the differences are unlikely to be meaningful to the caller. Regardless of how things are created, once you have a future you'll want to run its destructors.</p>



<a name="274623440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274623440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274623440">(Mar 08 2022 at 23:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07/near/274524053">said</a>:</p>
<blockquote>
<p>So, my reasoning is that async drop is equivalent to non cancellable because you can await in it, ie you can block the task for as long as you need before cancellation finishes. However, that is only true if the drop is guaranteed to be run, if not then you can still be abruptly cancelled and cannot reason about the state of the program in all cases</p>
</blockquote>
<p>Do we have any way we could guarantee  async destructors run? I'd expect those to be vulnerable to <code>mem::forget</code> as well.</p>



<a name="274626148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274626148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274626148">(Mar 09 2022 at 00:04)</a>:</h4>
<p><span class="user-mention" data-user-id="421986">@eholk</span> can't use use the same technique as <code>crossbeam::scope</code> and use an async-drop guard inside a closure, so it can't be leaked?</p>



<a name="274626674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274626674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274626674">(Mar 09 2022 at 00:10)</a>:</h4>
<p>Hmm, maybe? Is the idea there that once a closure starts, it runs to completion (barring a panic, anyway)?</p>



<a name="274628843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274628843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274628843">(Mar 09 2022 at 00:37)</a>:</h4>
<p>well, i imagine it would be like this: <a href="https://docs.rs/crossbeam-utils/0.8.5/src/crossbeam_utils/thread.rs.html#163">https://docs.rs/crossbeam-utils/0.8.5/src/crossbeam_utils/thread.rs.html#163</a></p>
<div class="codehilite"><pre><span></span><code>async fn async_scope&lt;F: Future, &#39;env&gt;(f: FnOnce() -&gt; F + &#39;env) {
       let scope = whatever();
       let jh = spawn(async move {
               catch_unwind(f(scope).await);
               // implicit async_drop(scope)
       });
       jh.await
}
</code></pre></div>
<p>if you ever call this, then even if you dont poll the future, the scope is created, and guaranteed to be polled by the runtime, and if the closure panics, or exits, or anything, you are guaranteed to async-drop the scope at the end</p>
<p>I think the problem is: you need to guarantee that the enclosing scope you are borrowing from and calling <code>async_scope</code> stays put until you are done with the scope task...not sure how that would work</p>



<a name="274629176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274629176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274629176">(Mar 09 2022 at 00:42)</a>:</h4>
<p>Ah, I see what you mean. I feel like there's a question of here about whether we trust the runtime (or manually implemented futures) to handle this correctly, or whether we can guarantee that with the language.</p>



<a name="274629248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274629248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274629248">(Mar 09 2022 at 00:44)</a>:</h4>
<p>Like, should I be able to get away with this?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">leaky_race</span><span class="p">(</span><span class="n">f1</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="p">,</span><span class="w"> </span><span class="n">f2</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Future</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">mem</span>::<span class="n">forget</span><span class="p">(</span><span class="n">f1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">f2</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="274629375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274629375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274629375">(Mar 09 2022 at 00:45)</a>:</h4>
<p>Then I could do</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">async_scope</span><span class="p">(</span><span class="o">|</span><span class="n">scope</span><span class="o">|</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">leaky_race</span><span class="p">(</span><span class="n">async_fn_a</span><span class="p">(),</span><span class="w"> </span><span class="n">async_fn_b</span><span class="p">());</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
<p>and end up not calling the destructor for <code>async_fn_a()</code>.</p>



<a name="274753276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274753276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274753276">(Mar 09 2022 at 21:14)</a>:</h4>
<p>I agree</p>
<p>To me it seems REALLY hard to make sure that the future that we are borrowing from (where the <code>'env</code> lifetime is coming from) does NOT progress until the sub-tasks are done unless either:</p>
<ul>
<li>trust the runtime to NEVER poll the borrowed-from task until the sub tasks are done. I am not sure how this is possible if you are creating the subtasks in an <code>async</code> context. I am not 100% sure how this would work</li>
<li>go with what I think was <span class="user-mention" data-user-id="116009">@nikomatsakis</span> 's idea and I have <code>?Leak</code> and <code>!Leak</code>, and really do make values that cannot be leaked (including somehow preventing reference-cycle leaks....) This would be a huge change</li>
</ul>



<a name="274755841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274755841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274755841">(Mar 09 2022 at 21:36)</a>:</h4>
<p>So I haven't really worked out how to do this yet, but it seems like it should be possible to put the parent task in an <code>Arc</code> and have subtasks keep a strong reference to the parent task, or something similar. I think in this case you can even have the runtime poll the parent task, as long as the borrow checker is otherwise happy.</p>



<a name="274755895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274755895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274755895">(Mar 09 2022 at 21:37)</a>:</h4>
<p>Although that also seems like an obvious enough idea that I expect someone would have done it already if it were possible.</p>



<a name="274874444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/async%20reading%20club%202022-03-07/near/274874444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/async.20reading.20club.202022-03-07.html#274874444">(Mar 10 2022 at 18:15)</a>:</h4>
<p>hmm, ill have to think about that</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>