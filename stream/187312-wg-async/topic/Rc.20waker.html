<html>
<head><meta charset="utf-8"><title>Rc waker · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html">Rc waker</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273679039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273679039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Karneges <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273679039">(Mar 01 2022 at 17:33)</a>:</h4>
<p>our app is multithreaded, but we use a single-threaded executor in each thread, and so our wakers are Rc-based. is anyone else doing Rc wakers? I wonder if it could be worth having something in std</p>



<a name="273679916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273679916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273679916">(Mar 01 2022 at 17:38)</a>:</h4>
<p>I thought the existing Send / Sync impls on Context and Waker, don't leave enough wiggle room to make it a valid implementation <a href="https://github.com/rust-lang/rust/issues/66481">#66481</a>.</p>



<a name="273681561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273681561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273681561">(Mar 01 2022 at 17:48)</a>:</h4>
<p>You can implement Send/Sync and check thread IDs</p>



<a name="273684229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273684229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Karneges <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273684229">(Mar 01 2022 at 18:04)</a>:</h4>
<p>yeah I'm curious about that. currently we don't check thread IDs and our waker contract is "promise not to pass to another thread". but if it is possible to efficiently check for invalid use and panic, then that seems like a good enough solution. the discussion in the above issue and <a href="https://boats.gitlab.io/blog/post/wakers-ii/">https://boats.gitlab.io/blog/post/wakers-ii/</a> about ergonomics in the common case make sense to me. it is/was a tricky design problem</p>



<a name="273820119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273820119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273820119">(Mar 02 2022 at 15:06)</a>:</h4>
<p>Oh yeah, that's a really good question. This is relevant for e.g. Glommio too. iirc there was an issue about this, proposing we remove the <code>Send</code> / <code>Sync</code> bounds from <code>task::Context</code>, so we can add a <code>local_waker</code> method which can be based on <code>Rc</code>.</p>



<a name="273820294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273820294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273820294">(Mar 02 2022 at 15:07)</a>:</h4>
<p>That's a backwards-incompatible change -- but I believe the theory is that that might actually have minimal breakage since <code>Context</code> is rarely held over <code>Send</code> bounds; <code>Waker</code> is</p>



<a name="273820525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273820525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273820525">(Mar 02 2022 at 15:08)</a>:</h4>
<p>Oh yeah, the thread is indeed <a href="https://github.com/rust-lang/rust/issues/66481">https://github.com/rust-lang/rust/issues/66481</a>, tracked in the WG as <a href="https://github.com/rust-lang/wg-async/issues/87">https://github.com/rust-lang/wg-async/issues/87</a></p>



<a name="273820850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273820850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273820850">(Mar 02 2022 at 15:10)</a>:</h4>
<p>cc/ <span class="user-mention" data-user-id="256841">@Nick Cameron</span> maybe we should pick this up?</p>



<a name="273820967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273820967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273820967">(Mar 02 2022 at 15:11)</a>:</h4>
<p>Glommio does currently check thread IDs</p>



<a name="273821149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273821149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273821149">(Mar 02 2022 at 15:12)</a>:</h4>
<p><span class="user-mention" data-user-id="363998">@Ibraheem Ahmed</span> Not sure I understand what that's in reply to?</p>



<a name="273821381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273821381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273821381">(Mar 02 2022 at 15:14)</a>:</h4>
<p>You mentioning glommio and <span class="user-mention" data-user-id="462944">@Justin Karneges</span> asking about checking for invalid use</p>



<a name="273821461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273821461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273821461">(Mar 02 2022 at 15:15)</a>:</h4>
<p>Oh I see</p>



<a name="273822006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273822006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273822006">(Mar 02 2022 at 15:18)</a>:</h4>
<p>For context: I talked to Glommio's lead and asked them to weigh in on this last year, here: <a href="https://github.com/rust-lang/wg-async/issues/87#issuecomment-821567041">https://github.com/rust-lang/wg-async/issues/87#issuecomment-821567041</a> -- they seemed keen if we could move the <code>!Send</code> / <code>!Sync</code> contract out into the type system.</p>



<a name="273822685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273822685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273822685">(Mar 02 2022 at 15:22)</a>:</h4>
<p>I think the rough steps to take here are as follows:</p>
<ol>
<li>Prototype a <code>Context::local_waker</code> impl with the right <code>!Send</code> / <code>!Sync</code> bounds to prove things work, possibly outside of std.</li>
<li>Get a branch / PR of this in to the compiler, so we can do a crater run and see how much breaks.</li>
<li>Decide on next steps based on that run. If nothing breaks we're lucky and can probably move ahead. If it does, we'll have to figure something else out.</li>
</ol>
<p>Something like that?</p>



<a name="273822893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273822893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273822893">(Mar 02 2022 at 15:24)</a>:</h4>
<p>I'm not sure if this is RFC material. If there's breakage it might very well need to be, since we need to justify it. But if the crater run turns up nothing, then possibly not?</p>



<a name="273824357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273824357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273824357">(Mar 02 2022 at 15:33)</a>:</h4>
<p>I don't think a large change like this can be made purely by a crater run</p>



<a name="273825716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273825716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273825716">(Mar 02 2022 at 15:40)</a>:</h4>
<p>I think it has to be an RFC - there are so many large async projects (with complex executor stuff) not published on <a href="http://crates.io">crates.io</a></p>



<a name="273825812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273825812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273825812">(Mar 02 2022 at 15:41)</a>:</h4>
<p>This gets back to the private crater run idea</p>



<a name="273825849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273825849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273825849">(Mar 02 2022 at 15:41)</a>:</h4>
<p>But I still think it would need an RFC</p>



<a name="273825902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273825902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273825902">(Mar 02 2022 at 15:42)</a>:</h4>
<p>I<br>
<span class="user-mention silent" data-user-id="211722">Yoshua Wuyts [he/they]</span> <a href="#narrow/stream/187312-wg-async/topic/Rc.20waker/near/273820850">said</a>:</p>
<blockquote>
<p>cc/ <span class="user-mention silent" data-user-id="256841">Nick Cameron</span> maybe we should pick this up?</p>
</blockquote>
<p>we probably should, but I'm not sure where it fits exactly. I def don't have the bandwidth at the moment though</p>



<a name="273834979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273834979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Karneges <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273834979">(Mar 02 2022 at 16:34)</a>:</h4>
<p>as others have said, including boats, removing Sync from Context seems like it should be harmless. the Waker change, less so. there is a possible midway point: making <code>Context::local_waker()</code> return a normal Waker that will panic if used improperly</p>



<a name="273836953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273836953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Karneges <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273836953">(Mar 02 2022 at 16:45)</a>:</h4>
<p>hmm, it occurs to me that if a <code>local_waker()</code> accessor is introduced, that an executor would still be obligated to provide a regular <code>waker()</code> accessor. so this change would be a way for a Future to opt-in to using a thread local waker, rather than a way for an executor to express to a Future that its wakers are not thread-safe. meaning, even our single-threaded executor which currently only provides Rc-based wakers would need to also implement a <code>waker()</code> that returns a thread-safe waker for completeness. this is a little surprising, but probably reasonable</p>



<a name="273838725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273838725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273838725">(Mar 02 2022 at 16:55)</a>:</h4>
<p>to allow executors to express they don't support Send/Sync wakers, we'd need <code>LocalFuture</code>, <code>LocalContext</code>, <code>LocalWaker</code>. Such an executor would only allow spawning <code>LocalFuture</code>s, not <code>Future</code>s</p>



<a name="273846762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273846762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Karneges <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273846762">(Mar 02 2022 at 17:41)</a>:</h4>
<p>true. and that does feel a bit excessive to me. even as someone that uses only thread-local wakers, I think I'd sooner prefer to implement thread-safe wakers that go unused, or make <code>Context::waker()</code> panic, rather than push to introduce <code>LocalFuture</code> into the ecosystem</p>



<a name="273847661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273847661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Karneges <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273847661">(Mar 02 2022 at 17:46)</a>:</h4>
<p>I suppose there could be other benefits of thread-local futures beyond optimizing waker, but I think this could be expressed with <code>Future + !Send + !Sync</code></p>



<a name="273847849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273847849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273847849">(Mar 02 2022 at 17:47)</a>:</h4>
<p>a <code>Future + !Send + !Sync</code> might still try to Send its Waker</p>



<a name="273848125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273848125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Karneges <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273848125">(Mar 02 2022 at 17:49)</a>:</h4>
<p>right, but having <code>Context::local_waker()</code> might be a sufficient solution to that</p>



<a name="273848215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273848215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dario Nieuwenhuis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273848215">(Mar 02 2022 at 17:49)</a>:</h4>
<p><code>LocalFuture</code> wouldn't be able to because it'd only have access to a <code>LocalWaker</code> which is <code>!Send</code></p>



<a name="273850835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Rc%20waker/near/273850835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Justin Karneges <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Rc.20waker.html#273850835">(Mar 02 2022 at 18:04)</a>:</h4>
<p>understood, <code>LocalFuture</code> would be forced to use <code>LocalWaker</code>. but if futures are given a choice, by offering both <code>Context::waker()</code> and <code>Context::local_waker()</code> (the latter providing a <code>LocalWaker</code> which is <code>!Send</code>), then a <code>Future + !Send + !Sync</code> could access either waker without causing problems</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>