<html>
<head><meta charset="utf-8"><title>[polish] `let r = &amp;p[0];` vs `let r = &amp;*p.index(0);` #72956 · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html">[polish] `let r = &amp;p[0];` vs `let r = &amp;*p.index(0);` #72956</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258484465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258484465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258484465">(Oct 21 2021 at 04:04)</a>:</h4>
<p>Hi everyone! I have been spending a little time today looking at <a href="https://github.com/rust-lang/rust/issues/72956">#72956</a>. I had thought when I first started looking at this that the “obvious” answer would be to revise <code>generator_interior.rs</code> to add a special-case for <code>ExprKind::Index</code> and force it to be treated like its desugared form.</p>



<a name="258484482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258484482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258484482">(Oct 21 2021 at 04:04)</a>:</h4>
<p>However, after digging in a little bit, I am revisiting that assumption</p>



<a name="258484635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258484635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258484635">(Oct 21 2021 at 04:07)</a>:</h4>
<p>In particular: The internal logic of <code>generator_interior.rs</code>, as part of its analysis, makes a call  <code>self.region_scope_tree.temporary_scope(expr.hir_id.local_id)</code></p>



<a name="258484862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258484862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258484862">(Oct 21 2021 at 04:10)</a>:</h4>
<p>And the interesting thing I discovered, when I compare a version of the code that does <code>let _r = peach[0];</code> with another that does <code>let _r = drop(&amp;peach);</code> (where I’m pretty sure that drop call is the moral equivalent of <code>Index::index(&amp;peach, 0)</code>, but with less perturbation of the resulting AST and HIR id numbers), is that the version that uses <code>&amp;peach[0]</code> produces Remainder temporary scopes for <code>Peach</code> and <code>&amp;Peach</code>. The version that does <code>drop(&amp;peach)</code> merely produces a Node scope.</p>



<a name="258484898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258484898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258484898">(Oct 21 2021 at 04:11)</a>:</h4>
<p>So: this raises a question to me: Why the broader scope for <code>&amp;peach[0]</code>, when it desugars to <code>Index::index(&amp;peach, 0)</code> …?</p>



<a name="258484985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258484985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258484985">(Oct 21 2021 at 04:12)</a>:</h4>
<p>(at the same time, the scope code is so fundamental to so many things in the language/compiler, I am <em>very</em> hesitant to muck with it without a really solid grasp of the implications. Its been a long time since I’ve had my hands dirty in it…)</p>



<a name="258485274"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258485274" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258485274">(Oct 21 2021 at 04:17)</a>:</h4>
<p>(I am currently guessing the answer to my question is going to lie in the implementation and history of <a href="https://github.com/rust-lang/rust/blob/efd0483949496b067cd5f7569d1b28cd3d5d3c72/compiler/rustc_passes/src/region.rs#L660">record_rvalue_scope</a>…)</p>



<a name="258485777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258485777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258485777">(Oct 21 2021 at 04:24)</a>:</h4>
<p>(Hmm. I wonder if there are some cases where this difference in scoping ends up being significant, e.g. when you have array expressions inline as the <code>recv</code> in<code>let _r = recv[idx];</code>/<code>let _r = recv.index(idx);</code> …)</p>



<a name="258486119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258486119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258486119">(Oct 21 2021 at 04:30)</a>:</h4>
<p>Yep, it does matter: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=9a3a0cb2ac1c7f1e1ac14129dd5a10ab">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=9a3a0cb2ac1c7f1e1ac14129dd5a10ab</a></p>



<a name="258486307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258486307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258486307">(Oct 21 2021 at 04:32)</a>:</h4>
<p>I’ll go write a comment on the issue noting that these two forms are not 100% interchangable. (I don’t think that implies we should close the issue, though. We may be able to make our analysis more precise here.)</p>



<a name="258488053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258488053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258488053">(Oct 21 2021 at 04:58)</a>:</h4>
<p>(also, my attempt to just YOLO it and try a  <a href="https://github.com/rust-lang/rust/blob/efd0483949496b067cd5f7569d1b28cd3d5d3c72/compiler/rustc_passes/src/region.rs#L660">record_rvalue_scope</a> that didn’t treat <code>Index</code> this way immediately broke, due to code like this <code>let utf8 = &amp;mut [first_byte, 0, 0, 0][..utf8_len];</code> in rustc-demangle crate.)</p>



<a name="258491571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258491571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258491571">(Oct 21 2021 at 05:50)</a>:</h4>
<p>New update: posted another, more narrowly focused, YOLO change to record_rvalue_scope: <a href="https://github.com/rust-lang/rust/issues/72956#issuecomment-948271239">https://github.com/rust-lang/rust/issues/72956#issuecomment-948271239</a></p>



<a name="258565628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/258565628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#258565628">(Oct 21 2021 at 15:23)</a>:</h4>
<p>I at least don't see an obvious reason why that wouldn't work. If there does turn out to be some soundness issue in practice we should get an ICE due to the comparison with MIR analysis.</p>



<a name="259306320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%5Bpolish%5D%20%60let%20r%20%3D%20%26p%5B0%5D%3B%60%20vs%20%60let%20r%20%3D%20%26%2Ap.index%280%29%3B%60%20%2372956/near/259306320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.5Bpolish.5D.20.60let.20r.20.3D.20.26p.5B0.5D.3B.60.20vs.20.60let.20r.20.3D.20.26*p.2Eindex(0).3B.60.20.2372956.html#259306320">(Oct 27 2021 at 21:05)</a>:</h4>
<p>okay. I guess I could just make a PR with it. (To be honest I'm not 100% sure why the change <em>works</em>; that is, I don't understand how in a block <code>{ let var = ... ; let _other = var[idx]; ... </code>, I don't understand how the temporary for the array-base of the index expression can end up with a longer scope than the let bound variable itself... I haven't had a chance to look more deeply into that question, though.)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>