<html>
<head><meta charset="utf-8"><title>Blog post: async cancellation · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.3A.20async.20cancellation.html">Blog post: async cancellation</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261114845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%3A%20async%20cancellation/near/261114845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.3A.20async.20cancellation.html#261114845">(Nov 11 2021 at 10:18)</a>:</h4>
<p>Hey all, I finally published <a href="https://blog.yoshuawuyts.com/async-cancellation-1/">my blog post on async cancellation</a>! Figured it'd be interesting for some here; especially as it touches on the interaction with the Futures 2.0 designs. I've opened <a href="https://internals.rust-lang.org/t/blog-post-async-cancellation/15591">a thread on internals for comments</a>. Thanks!</p>



<a name="261118655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%3A%20async%20cancellation/near/261118655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.3A.20async.20cancellation.html#261118655">(Nov 11 2021 at 10:58)</a>:</h4>
<p>Your link appears to go to 127.0.0.1</p>



<a name="261124508"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%3A%20async%20cancellation/near/261124508" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Charles Lew <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.3A.20async.20cancellation.html#261124508">(Nov 11 2021 at 12:03)</a>:</h4>
<p>The correct link: <a href="https://blog.yoshuawuyts.com/async-cancellation-1/">https://blog.yoshuawuyts.com/async-cancellation-1/</a></p>



<a name="261128813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%3A%20async%20cancellation/near/261128813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.3A.20async.20cancellation.html#261128813">(Nov 11 2021 at 12:46)</a>:</h4>
<p>What a nice post; very nice to have laid out the essentials starting from the basics, up until spelling out the "joinhandles / tasks' detach-on-drop semantics make 'cancellation propagation' opt-in" as indeed an important footgun to keep in mind <span aria-label="ok" class="emoji emoji-1f44c" role="img" title="ok">:ok:</span> </p>
<p>A few remarks:</p>
<hr>
<blockquote>
<p>By design [a <code>Future</code>] does nothing unless <code>.await</code>ed</p>
</blockquote>
<p>You could add a footnote mentioning that a <code>Future</code>-yielding function call could still do some setup work before reaching the suspended state, such as <code>Arc::clone</code>-ing and whatnot so as to be <code>'static</code>. That is, to somehow hint at the points mentioned <a href="https://docs.rs/async_fn/0.0.2/async_fn/macro.before_async.html#eager-vs-lazy--suspended-code">here</a>.</p>
<hr>
<p>Another tiny nit is that you could try to be slightly more consistent with the <code>println!</code> "labels", and with the <code>Drop</code> guard idea to show drop order (I was slightly confused by the location of the <code>println!("2")</code> statement having changed in between two examples, for instance, although granted, I skimmed the code snippet quite quickly). The drop guard idea is awesome, and, if moreover you were to add names to it, you could use them for <em>each</em> of these <code>async fn</code>s futures:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Deathrattle</span><span class="p">(</span><span class="o">&amp;'</span><span class="nb">static</span><span class="w"> </span><span class="kt">str</span><span class="p">);</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Deathrattle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Dropped `{}`"</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">_</span>: <span class="nc">Deathrattle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// …</span>
<span class="w">    </span><span class="n">bar</span><span class="p">(</span><span class="n">Deathrattle</span><span class="p">(</span><span class="s">"bar()"</span><span class="p">)).</span><span class="n">timeout</span><span class="w"> </span><span class="c1">// …</span>
<span class="w">    </span><span class="c1">// …</span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// …</span>
<span class="n">foo</span><span class="p">(</span><span class="n">Deathrattle</span><span class="p">(</span><span class="s">"foo()"</span><span class="p">)).</span><span class="n">timeout</span><span class="w"> </span><span class="c1">// …</span>
<span class="c1">// …</span>
</code></pre></div>



<a name="261158503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%3A%20async%20cancellation/near/261158503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.3A.20async.20cancellation.html#261158503">(Nov 11 2021 at 16:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/Blog.20post.3A.20async.20cancellation/near/261118655">said</a>:</p>
<blockquote>
<p>Your link appears to go to 127.0.0.1</p>
</blockquote>
<p>oooops; haha</p>



<a name="261158687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%3A%20async%20cancellation/near/261158687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.3A.20async.20cancellation.html#261158687">(Nov 11 2021 at 16:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> I appreciate the feedback!</p>



<a name="261173395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Blog%20post%3A%20async%20cancellation/near/261173395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Blog.20post.3A.20async.20cancellation.html#261173395">(Nov 11 2021 at 19:10)</a>:</h4>
<p><span class="user-mention" data-user-id="211722">@Yoshua Wuyts [he/they]</span>  I like the start of the post. I gives a good intra for readers that are not familiar yet with async cancellation about the problem.</p>
<p>Some super high level comments about the following sections: You might want to check out <a href="https://gist.github.com/Matthias247/354941ebcc4d2270d07ff0c6bf066c64">https://gist.github.com/Matthias247/354941ebcc4d2270d07ff0c6bf066c64</a><br>
which is discussed (well - not really so far) in  <a href="#narrow/stream/187312-wg-async-foundations/topic/A.20case.20for.20CancellationTokens">https://rust-lang.zulipchat.com/#narrow/stream/187312-wg-async-foundations/topic/A.20case.20for.20CancellationTokens</a></p>
<p>It describes common denominators between async and sync cancellation. I've not done any more work on this so far due to lack of interest, but I'm happy to discuss.</p>
<p>In the blog article, you might want to mention in "Patching cancellation propagation" that this still doesn't guarantee cancellation. Tasks that are e.g. spawned using <code>spawn_blocking</code>, or anyones which are not paused at at <code>.await</code> point will continue to run until the next one of those.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>