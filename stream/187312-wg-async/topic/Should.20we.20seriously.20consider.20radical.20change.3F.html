<html>
<head><meta charset="utf-8"><title>Should we seriously consider radical change? · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html">Should we seriously consider radical change?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270954336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/270954336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#270954336">(Feb 07 2022 at 09:52)</a>:</h4>
<p>In particular, the idea of implicit await and/or non-cancellable futures?</p>



<a name="270954505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/270954505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#270954505">(Feb 07 2022 at 09:54)</a>:</h4>
<p>Rather than discussing the merits of these ideas in depth here, I think we should consider if we could make these changes at all, and if there is such a possibility we should do some thinking/planning/discussion <em>now</em> since the earlier we do huge changes ,the better and it touches on design questions for almost everything else we're looking at</p>



<a name="271004144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271004144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271004144">(Feb 07 2022 at 16:28)</a>:</h4>
<p>How willing are we to break backwards compatibility?</p>



<a name="271005954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271005954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271005954">(Feb 07 2022 at 16:41)</a>:</h4>
<p>Imo it could be an option if we find we have structural problems in our current design which cannot be overcome in any other way. But I've been actively looking at areas folks point out as problematic (e.g. <code>io_uring</code>, cancellation), and so far I haven't been able to find anything that could warrant breakage.</p>



<a name="271006704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271006704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271006704">(Feb 07 2022 at 16:46)</a>:</h4>
<p>I believe non-cancellable futures potentially merits breakage, but it comes down to how much we care about parallelism</p>



<a name="271006743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271006743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271006743">(Feb 07 2022 at 16:46)</a>:</h4>
<p>In general I feel like there's regular talk about breaking changes, but relatively little writing in terms of motivating cases, and exploration of alternative ways to solve the same problems. I'd like us to focus more on that first, and only if we find that all other options are exhausted, to consider breakage.</p>



<a name="271006747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271006747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271006747">(Feb 07 2022 at 16:46)</a>:</h4>
<p>I don't think implicit await is worth it at present, although I see some advantages</p>



<a name="271006799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271006799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271006799">(Feb 07 2022 at 16:47)</a>:</h4>
<p>I agree we should justify whatever we do with very solid arguments :)</p>



<a name="271006813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271006813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271006813">(Feb 07 2022 at 16:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I like the series you've started on async cancellation, and am excited for the next installment which promises to go into examples - would love to see more of that (:</p>



<a name="271006826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271006826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271006826">(Feb 07 2022 at 16:47)</a>:</h4>
<p>However, I think it is pretty well established that we cannot have scoped parallelism without some changes to the Future trait.</p>



<a name="271006922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271006922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271006922">(Feb 07 2022 at 16:48)</a>:</h4>
<p>Though I agree it would be good to collect the arguments in a clear form</p>



<a name="271007001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271007001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271007001">(Feb 07 2022 at 16:48)</a>:</h4>
<p>heh, yeah I was about to say</p>



<a name="271020698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271020698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271020698">(Feb 07 2022 at 18:21)</a>:</h4>
<p>What would a breaking change look like? Would that mean code that used to compile doesn't anymore? That we add a <code>Future2</code> trait? That we create Rust 2.0 or maybe fork and have a new language Async Rust. (To be clear, the last one especially is in my opinion firmly in the extremely bad idea category, I'm just throwing it out there to cover the spectrum)</p>



<a name="271021272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271021272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271021272">(Feb 07 2022 at 18:25)</a>:</h4>
<p>Those are some scary ideas <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="271021948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271021948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271021948">(Feb 07 2022 at 18:30)</a>:</h4>
<p>Actually, re-reading my list, I think all but <em>maybe</em> <code>Future2</code> (with a better name) are bad ideas.</p>



<a name="271034678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271034678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271034678">(Feb 07 2022 at 20:05)</a>:</h4>
<p>I'm in favor of substantial change <em>if</em> it has commensurate value.</p>



<a name="271034825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271034825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271034825">(Feb 07 2022 at 20:06)</a>:</h4>
<p>For io_uring in particular, I think it's worth some substantially different interfaces, but I also think we should not gate present improvements to the state of futures on that.</p>



<a name="271034857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271034857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271034857">(Feb 07 2022 at 20:06)</a>:</h4>
<p>I think io_uring is sufficiently different that more than just futures would need to change, and we should do that in parallel.</p>



<a name="271034980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271034980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271034980">(Feb 07 2022 at 20:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F/near/271006826">said</a>:</p>
<blockquote>
<p>However, I think it is pretty well established that we cannot have scoped parallelism without some changes to the Future trait.</p>
</blockquote>
<p>Can you elaborate on this? By "scoped parallelism", do you mean unifying futures with something like Rayon, for compute-intensive work? Or do you mean "scoped futures" similar to scoped threads where you can hand a borrow to a future because you know it won't outlive what it borrows?</p>



<a name="271052640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271052640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271052640">(Feb 07 2022 at 22:29)</a>:</h4>
<p>I think Niko means the latter</p>



<a name="271052688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271052688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271052688">(Feb 07 2022 at 22:29)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="271086115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271086115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271086115">(Feb 08 2022 at 06:22)</a>:</h4>
<p>The whole non-cancellable futures thing mainly gets us scoped tasks as I see it. There's nothing blocking us from implementing <code>tokio::fs::File</code> to use io_uring as its interface is today.</p>



<a name="271097906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271097906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sashanoraa <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271097906">(Feb 08 2022 at 09:01)</a>:</h4>
<p>I'm currently working on an io_uring based async io library using io_uring. While non-cancellable futures would be nice in some instances, the main thing I've found to an issue are the AsyncRead and AsyncWrite traits from futures.</p>



<a name="271098039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271098039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sashanoraa (any/all) <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271098039">(Feb 08 2022 at 09:02)</a>:</h4>
<p>Nothing it std has been a major hurdle thus far, though we'll see if I feel differently when the library is closer to completion.</p>



<a name="271100129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271100129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271100129">(Feb 08 2022 at 09:20)</a>:</h4>
<p>I feel like when people talk about io_uring requiring different designs there are unspoken design requirements? Because it seems pretty easy to have an optimally performant io_uring implementation today (using either AsyncBufRead or maybe even AsyncRead) as long as you have some kind of buffer manager rather than expecting the future calling <code>read</code> to allocate the buffer on it s stack.</p>



<a name="271100245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271100245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271100245">(Feb 08 2022 at 09:21)</a>:</h4>
<p>I would like to know what those 'unspoken requirements' are precisely</p>



<a name="271100483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271100483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271100483">(Feb 08 2022 at 09:23)</a>:</h4>
<p>I feel like cancellation brings a bunch of footguns, not just with parallelism. But I don't have a list (probably should!)</p>



<a name="271100651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271100651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271100651">(Feb 08 2022 at 09:24)</a>:</h4>
<p>In the case of <code>tokio::fs::File</code>, we would simply use an internal buffer to store the data while its in the kernel - this is already what we do today, so it's fine. As for avoiding the copy, then you do indeed need a different trait, but such a trait _is_ possible today.</p>



<a name="271103635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271103635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271103635">(Feb 08 2022 at 09:52)</a>:</h4>
<p>Right, avoiding the copy seems pretty easy - the obvious design for AsyncBufRead should permit it (pretty easy from the POV of the trait design, not necessarily the concrete implementation)</p>



<a name="271103974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271103974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271103974">(Feb 08 2022 at 09:55)</a>:</h4>
<p>I guess by avoiding the copy you mean that you want the kernel to write directly into the user's data structure rather than an intermediate buffer? I think then to be precise about the buffer manager, I mean that the user has to use  these managed buffers for their data structures</p>



<a name="271104131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271104131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271104131">(Feb 08 2022 at 09:57)</a>:</h4>
<p>So perhaps the unspoken requirement is that people want to be able to pass pointers to memory which they fully own to read and have the kernel write directly into them without any copying?</p>



<a name="271111920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271111920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271111920">(Feb 08 2022 at 11:12)</a>:</h4>
<p>The tokio-uring crate has a fancy IoBuf trait that lets you temporarily give away ownership of the buffer, then get it back when the operation completes.</p>



<a name="271147658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271147658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271147658">(Feb 08 2022 at 15:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="218683">Alice Ryhl</span> <a href="#narrow/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F/near/271100651">said</a>:</p>
<blockquote>
<p>In the case of <code>tokio::fs::File</code>, we would simply use an internal buffer to store the data while its in the kernel - this is already what we do today, so it's fine. As for avoiding the copy, then you do indeed need a different trait, but such a trait _is_ possible today.</p>
</blockquote>
<p>Yeah, I don't think this needs new <em>language</em> features for the most part. And I do think separate traits are the right answer, rather than trying to adapt our existing async-related traits. But it's not just about avoiding copies; there's also the use of internal ring file indexes rather than file descriptors, the use of kernel-registered buffers, and the ability to do fused operations that stay in the kernel (e.g. "read from here and write to there" or "open this file, read from it, close it").</p>



<a name="271365011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/271365011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#271365011">(Feb 09 2022 at 23:46)</a>:</h4>
<p>for what its worth, I agree with <span class="user-mention" data-user-id="218683">@Alice Ryhl</span> that un-cancellable futures might be necessary for scoped spawns, and I think scoped spawns would be a huge upgrade for the ecosystem</p>



<a name="272564963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Should%20we%20seriously%20consider%20radical%20change%3F/near/272564963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthias247 <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Should.20we.20seriously.20consider.20radical.20change.3F.html#272564963">(Feb 20 2022 at 04:27)</a>:</h4>
<p><span class="user-mention" data-user-id="421986">@eholk</span> </p>
<blockquote>
<p>What would a breaking change look like? Would that mean code that used to compile doesn't anymore? That we add a Future2 trait? </p>
</blockquote>
<p>Not sure if you've seen it, but there's a RFC around it for quite some time: <a href="https://github.com/Matthias247/rfcs/pull/1/files">https://github.com/Matthias247/rfcs/pull/1/files</a><br>
There's actually nothing breaking in it at this point in time - it's compatible to what exists. Like both non-generic Java collections can coexist with the generic ones, and like C# has 2 sets of collection types ;) <br>
The main concern back then was whether the extra addition to the language and ecosystem is worth it.</p>
<p><span class="user-mention" data-user-id="256841">@Nick Cameron</span> </p>
<blockquote>
<p>So perhaps the unspoken requirement is that people want to be able to pass pointers to memory which they fully own to read and have the kernel write directly into them without any copying?</p>
</blockquote>
<p>Yes. But you might just call it "behaves exactly as <code>Read</code> and <code>Write</code>" - it directly transfers data from a slice to a sink or the other way around.<br>
What you talk about mostly here it the <code>Read</code> route, but let's for example briefly look at <code>Write</code>. Let's assume we have a HTTP stack and a TLS library. Let's call that rustls. When the request/response generates data, it makes a <code>write()</code> call to the TLS library. That has an internal buffer. In there we encrypt things. Now we want to write the encrypted data using syscalls. There's now 2 options:</p>
<ul>
<li>Just write the internal buffer - which is exactly what is done today.</li>
<li>Swap out the existing buffer in the TLS library, somehow give ownership for it to a background task which can do the write. And then think deeply about you get backpressure back. This is doable, but requires more deliberate changes in the whole stack. You will probably end up going to rewrite a whole bunch of infrastructure on top of buffer pools like how some infrastructure (DPDK, nginx) is already managing data. </li>
</ul>
<p>There's similar examples for the reading side, where we would like to read data from the kernel exactly to a certain memory location, because then it's most efficient to further process it.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>