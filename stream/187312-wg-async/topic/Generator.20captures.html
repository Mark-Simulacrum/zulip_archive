<html>
<head><meta charset="utf-8"><title>Generator captures · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html">Generator captures</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="250420679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250420679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250420679">(Aug 23 2021 at 22:31)</a>:</h4>
<p>Should this snippet be allowed (taken from <code>not-send-sync.rs</code>)?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">assert_sync</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">//~^ ERROR: generator cannot be shared between threads safely</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cell</span>::<span class="n">new</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kr">yield</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
</code></pre></div>
<p>Currently it is not, I'm assuming because <code>a</code> is in scope across the <code>yield</code>. But, when basing captures off liveness instead, <code>a</code> doesn't get captured because <code>a</code> is not used after the yield.</p>



<a name="250534155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250534155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250534155">(Aug 24 2021 at 19:15)</a>:</h4>
<p><span class="user-mention" data-user-id="421986">@eholk</span> and because it doesn't have a destructor? We do currently take that into account from borrow check (sheesh, I should take my own advice and try to document those rules).</p>



<a name="250534182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250534182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250534182">(Aug 24 2021 at 19:15)</a>:</h4>
<p>I am in favor of using consistent rules</p>



<a name="250544549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250544549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250544549">(Aug 24 2021 at 20:33)</a>:</h4>
<p>Correct, in this case it doesn't have a destructor.</p>



<a name="250544707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250544707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250544707">(Aug 24 2021 at 20:34)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> I wonder if we could actually unify all these rules. We might need different implementations of them, due to pass phasing issues, which would be sad, but at least we could just say "We use the standard liveness/borrow/capture rules."</p>



<a name="250544906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250544906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250544906">(Aug 24 2021 at 20:36)</a>:</h4>
<p>Do we have another set of rules for closures too? It seems like they should be a subset of the generator rules, since it seems like closures should just be generators that don't yield.</p>



<a name="250579901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250579901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250579901">(Aug 25 2021 at 04:50)</a>:</h4>
<p>Generators are indeed a generalization of closures and they have the same capture semantics, but liveness wouldn't come into the picture with regular closures</p>



<a name="250698692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250698692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250698692">(Aug 25 2021 at 23:43)</a>:</h4>
<p><span class="user-mention" data-user-id="421986">@eholk</span> yes, I think we should strive to have unified rules</p>



<a name="250698705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250698705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250698705">(Aug 25 2021 at 23:44)</a>:</h4>
<p>I'm not sure how much we can do that by having one bit of code, but we should try to write out the rules</p>



<a name="250698747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250698747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250698747">(Aug 25 2021 at 23:44)</a>:</h4>
<p>and then we can at least test for consistency</p>



<a name="250832029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250832029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250832029">(Aug 26 2021 at 20:07)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> - I was just looking at how <code>ExprUseVisitor</code> is used in <code>closure_analyze</code>. I wonder if we could do the live-across-yield analysis as part of closure analysis too, since closures basically generators that don't yield.</p>



<a name="250832184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250832184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250832184">(Aug 26 2021 at 20:08)</a>:</h4>
<p><code>resolve_generator_interiors</code> runs right after <code>closure_analyze</code>, so it seems like unifying the two may sorta kinda work.</p>



<a name="250866878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/250866878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#250866878">(Aug 27 2021 at 01:55)</a>:</h4>
<p>seems reasonable</p>



<a name="251267683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/251267683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#251267683">(Aug 30 2021 at 17:56)</a>:</h4>
<p>So there's another aspect of this I've been thinking about. Consider this case:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Client</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="n">status</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="mi">200</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">get</span><span class="p">().</span><span class="k">await</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This future is not <code>Send</code> because <code>client</code> is not <code>Sync</code>, and therefore the borrow of <code>client</code> is not <code>Send</code>. (Let's assume the current rules, not the new liveness rules I'm working on. We could construct a similar example under the liveness rules though)</p>



<a name="251267902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/251267902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#251267902">(Aug 30 2021 at 17:58)</a>:</h4>
<p>It seems like this should be okay, since the future owns <code>client</code>. In general it wouldn't be safe to send the <code>&amp;Client</code> to another thread, but if we send the generator we'll send both the <code>Client</code> and the <code>&amp;Client</code>.</p>



<a name="251267982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/251267982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#251267982">(Aug 30 2021 at 17:58)</a>:</h4>
<p>I wonder if there's a way we account for this in our rules too.</p>



<a name="251268197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/251268197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#251268197">(Aug 30 2021 at 18:00)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> or <span class="user-mention" data-user-id="116883">@tmandry</span>, what do you think?</p>



<a name="251294443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/251294443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#251294443">(Aug 30 2021 at 21:01)</a>:</h4>
<p>Also, I have a patch that describes liveness-based auto traits for generators in the Reference. I'd appreciate some feedback from the async folks, and then I'll look at proposing this to the lang team.<br>
<a href="https://github.com/eholk/reference/commit/3f831eafd7a497ce5c6859dcceb3b58f0ea76917">https://github.com/eholk/reference/commit/3f831eafd7a497ce5c6859dcceb3b58f0ea76917</a></p>



<a name="251588398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/251588398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#251588398">(Sep 01 2021 at 16:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/Generator.20captures/near/251267902">said</a>:</p>
<blockquote>
<p>It seems like this should be okay, since the future owns <code>client</code>. In general it wouldn't be safe to send the <code>&amp;Client</code> to another thread, but if we send the generator we'll send both the <code>Client</code> and the <code>&amp;Client</code>.</p>
</blockquote>
<p>yeah, so this came up in <a href="#narrow/stream/187312-wg-async-foundations/topic/Example.20of.20odd.20composing.20of.20Send">this thread</a></p>



<a name="251588429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/Generator%20captures/near/251588429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/Generator.20captures.html#251588429">(Sep 01 2021 at 16:27)</a>:</h4>
<p>I wrote down some ideas about it at some point and haven't revisited</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>