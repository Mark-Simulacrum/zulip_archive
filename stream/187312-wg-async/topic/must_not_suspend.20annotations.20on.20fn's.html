<html>
<head><meta charset="utf-8"><title>must_not_suspend annotations on fn&#x27;s · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html">must_not_suspend annotations on fn&#x27;s</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252224562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252224562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252224562">(Sep 06 2021 at 21:22)</a>:</h4>
<p>On <a href="https://github.com/rust-lang/rfcs/blob/master/text/3014-must-not-suspend-lint.md">https://github.com/rust-lang/rfcs/blob/master/text/3014-must-not-suspend-lint.md</a>, I am finding that it is significantly more difficult to correctly lint if we allow <code>#[must_not_suspend]</code> on fn/method items (which works for <code>#[must_use]</code>. Can someone confirm that I am reading that RFC right, and we want <code>#must_not_suspend]</code> to work on ADTs, fns (including trait method definitions and methods), and traits (I think this just affects <code>impl Trait</code> and <code>impl Trait</code> and MAYBE <code>dyn Trait</code>?)</p>
<p>Also, as it will probably require more complex changes to <a href="http://generator_interior.rs">generator_interior.rs</a>, and this lint is gated on a nightly feature, is it reasonable to split up making it work on ADT's and work on fn calls as separate PRs? cc <span class="user-mention" data-user-id="116009">@nikomatsakis</span> I believe was mentoring for this (its labor day so feel free to ignore my ping till another day)</p>



<a name="252340984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252340984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252340984">(Sep 07 2021 at 17:27)</a>:</h4>
<p>I think it's fine to do this incrementally and split making with work on ADTs and fn calls as separate PRs.</p>



<a name="252341323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252341323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252341323">(Sep 07 2021 at 17:29)</a>:</h4>
<p>While<code>#[must_use]</code> on an fn item makes sense ("you must use the result of this specific call"), I don't know that it makes as much sense for <code>#[must_not_suspend]</code> to apply to the results of specific functions. Tying it to types only seems pretty reasonable to me.</p>



<a name="252341369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252341369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252341369">(Sep 07 2021 at 17:29)</a>:</h4>
<p>How to make it work with traits is kind of interesting though.</p>



<a name="252341532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252341532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252341532">(Sep 07 2021 at 17:30)</a>:</h4>
<p>Like, does it apply if a type impls <em>any</em> trait marked with <code>#[must_not_suspend]</code>? Or does it only matter if the type is used as that trait?</p>



<a name="252358462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252358462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252358462">(Sep 07 2021 at 19:22)</a>:</h4>
<p>It's definitely possible to do it fns/methods/etc, and the rfc does say this in the reference explanation: "The must_not_suspend attribute is used to issue a diagnostic warning when a value is not "used". It can be applied to user-defined composite types (structs, enums and unions), traits."</p>
<p>but like I said, it would require more complex changes to the generator yield analysis, which I would need help on. I think my plan is, this week sometime ill 1. figure out how to scope the attribute to just ADTs for now and 2. fix up the language and nice-looking-ness of the diagnostic that I have working</p>



<a name="252358542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252358542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252358542">(Sep 07 2021 at 19:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20annotations.20on.20fn's/near/252341532">said</a>:</p>
<blockquote>
<p>Like, does it apply if a type impls <em>any</em> trait marked with <code>#[must_not_suspend]</code>? Or does it only matter if the type is used as that trait?</p>
</blockquote>
<p>no, I think for traits its JUST <code>impl Trait</code> (and maybe <code>dyn Trait</code>, i havent checked); or at least, thats how must_use works</p>



<a name="252359308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252359308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252359308">(Sep 07 2021 at 19:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20annotations.20on.20fn's/near/252341323">said</a>:</p>
<blockquote>
<p>While<code>#[must_use]</code> on an fn item makes sense ("you must use the result of this specific call"), I don't know that it makes as much sense for <code>#[must_not_suspend]</code> to apply to the results of specific functions. Tying it to types only seems pretty reasonable to me.</p>
</blockquote>
<p>I agree with this</p>



<a name="252361249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252361249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252361249">(Sep 07 2021 at 19:44)</a>:</h4>
<p>okay nice, <code>check_attr.rs</code> here I come!</p>



<a name="252371167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252371167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252371167">(Sep 07 2021 at 20:59)</a>:</h4>
<p>Oh yeah, <code>impl Trait</code> makes sense, and if that's the behavior of <code>must_use</code> anyway, then following that seems pretty reasonable.</p>



<a name="252371302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252371302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252371302">(Sep 07 2021 at 21:00)</a>:</h4>
<p><span class="user-mention" data-user-id="257428">@Gus Wynn</span> - I've been spending a lot of time staring at <code>generator_interior.rs</code> lately, so feel free to reach out if you want help getting started if and when you come to that part.</p>



<a name="252375091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252375091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252375091">(Sep 07 2021 at 21:33)</a>:</h4>
<p>impl trait is likely not too bad, in fact it may already work with the code I wrote (copied from the <code>must_use</code> code, copied cause its sufficiently different now)</p>
<p>the difficulty with fn/method annotations is that the Visitor in generator_interior <code>visit_expr</code>'s and <code>visit_pat's</code>....so for things like<br>
<code>let guard = thing()</code>, btw the time you are visiting the <code>guard</code> pat, you have lost the context of the <code>thing()</code> expr that you need to check for the <code>must_not_suspend</code> annotation. </p>
<p>I could "lift" this up and instead override <code>visit_stmt</code> and then delegate to a function that checks the expr's, but i would have to be careful to not break the existing code, and also make sure I correctly pass context for ALL exprs that are callsites that produce values (i guess, non-temporary values?). <code>must_use</code> only cares about <code>StmtKind::Semi</code>, but its more complex for <code>must_not_suspend</code></p>
<p>also for things like:</p>
<div class="codehilite"><pre><span></span><code>let thing = {
    let inner = fn_that_has_the_attribute();
    // do some other stuff
   inner
};
</code></pre></div>
<p>I have NO idea how to pass that context along. The generator visitor will visit the <code>thing</code> pattern and if the type ITSELF (be that impl trait or an ADT) has the annotation, then its ez to discover that here, but it seems in general impossible to know if a value came from a function call that has a certain attribute?</p>
<p>Like, with <code>must_use</code>, its the callsite alone that you have to check, but with <code>must_not_suspend</code> it seems really difficult?</p>



<a name="252383728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252383728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252383728">(Sep 07 2021 at 23:06)</a>:</h4>
<p>Yeah, that makes sense. I think the way I'd approach it (not saying it's the right idea, or even that it will work), is to try to mark the type of the return from <code>fn_that_has_the_attribute()</code> as <code>must_not_suspend</code>.</p>



<a name="252383854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252383854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252383854">(Sep 07 2021 at 23:07)</a>:</h4>
<p>Basically, generator interior only gathers up types that are live across a yield, so what I'd try to do is make a "virtual singleton type" that represents the return value of a <code>must_not_suspend</code> function.</p>



<a name="252384193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252384193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252384193">(Sep 07 2021 at 23:10)</a>:</h4>
<p>I <em>think</em> the right way to do this is to make <code>InteriorVisitor::yield</code> take another flag that says whether the thing we're yielding has the <code>must_not_suspend</code> attribute.</p>



<a name="252384220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252384220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252384220">(Sep 07 2021 at 23:10)</a>:</h4>
<p>and then do the appropriate plumbing from there...</p>



<a name="252384336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252384336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252384336">(Sep 07 2021 at 23:12)</a>:</h4>
<p>oh yeah, then <code>GeneratorInteriorTypeCause</code> would get an extra field that says whether the <code>must_not_suspend</code> attribute was given.</p>



<a name="252384426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252384426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252384426">(Sep 07 2021 at 23:13)</a>:</h4>
<p>Actually, you might even be able to recover the attribute from the <code>expr</code> field in <code>GeneratorInteriorTypeCause</code>.</p>



<a name="252386745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252386745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252386745">(Sep 07 2021 at 23:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20annotations.20on.20fn's/near/252383728">said</a>:</p>
<blockquote>
<p>Yeah, that makes sense. I think the way I'd approach it (not saying it's the right idea, or even that it will work), is to try to mark the type of the return from <code>fn_that_has_the_attribute()</code> as <code>must_not_suspend</code>.</p>
</blockquote>
<p>hmm, that would infect other instances of that type tho?</p>



<a name="252386769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252386769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252386769">(Sep 07 2021 at 23:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20annotations.20on.20fn's/near/252384336">said</a>:</p>
<blockquote>
<p>oh yeah, then <code>GeneratorInteriorTypeCause</code> would get an extra field that says whether the <code>must_not_suspend</code> attribute was given.</p>
</blockquote>
<p>currently I lint right before I add the TypeCause, but I like this idea</p>



<a name="252485742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252485742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252485742">(Sep 08 2021 at 15:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257428">Gus Wynn</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20annotations.20on.20fn's/near/252386745">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20annotations.20on.20fn's/near/252383728">said</a>:</p>
<blockquote>
<p>Yeah, that makes sense. I think the way I'd approach it (not saying it's the right idea, or even that it will work), is to try to mark the type of the return from <code>fn_that_has_the_attribute()</code> as <code>must_not_suspend</code>.</p>
</blockquote>
<p>hmm, that would infect other instances of that type tho?</p>
</blockquote>
<p>Yeah, you don't want to mark the type itself. I was thinking more like making an implicit newtype for each return value from when the function is called.</p>



<a name="252492770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252492770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252492770">(Sep 08 2021 at 16:39)</a>:</h4>
<p>oh i meant to send this last night: "I still think it may be worth it to do the ADT part separately, first" <br>
as a good chunk of the code will be shared</p>



<a name="252492796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252492796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252492796">(Sep 08 2021 at 16:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20annotations.20on.20fn's/near/252485742">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257428">Gus Wynn</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20annotations.20on.20fn's/near/252386745">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20annotations.20on.20fn's/near/252383728">said</a>:</p>
<blockquote>
<p>Yeah, that makes sense. I think the way I'd approach it (not saying it's the right idea, or even that it will work), is to try to mark the type of the return from <code>fn_that_has_the_attribute()</code> as <code>must_not_suspend</code>.</p>
</blockquote>
<p>hmm, that would infect other instances of that type tho?</p>
</blockquote>
<p>Yeah, you don't want to mark the type itself. I was thinking more like making an implicit newtype for each return value from when the function is called.</p>
</blockquote>
<p>thats something to look into!</p>



<a name="252498595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252498595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252498595">(Sep 08 2021 at 17:16)</a>:</h4>
<p>I think the <code>GeneratorTypeInteriorCause</code> change will have kind of the same effect as making an implicit newtype, at least as far as <code>generator_interior.rs</code> is concerned</p>



<a name="252499339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252499339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252499339">(Sep 08 2021 at 17:21)</a>:</h4>
<p>Ah I see</p>



<a name="252926038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252926038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252926038">(Sep 11 2021 at 18:12)</a>:</h4>
<p>its mostly working: <a href="https://github.com/rust-lang/rust/pull/88865">https://github.com/rust-lang/rust/pull/88865</a></p>



<a name="252927040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/252927040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#252927040">(Sep 11 2021 at 18:32)</a>:</h4>
<p>why would hashing a TyKind cause a hash of RegionKind?</p>



<a name="255070954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/255070954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#255070954">(Sep 27 2021 at 15:46)</a>:</h4>
<p>I did come up with one place that having <code>must_not_suspend</code> on a fn/method might be nice: we can put it on the <code>lock</code> method of mutex, so even if someone forgets to unwrap/handle the poison error, they get the lint (ie, if the <code>Result&lt;MutexGuard, PoisonError&gt;</code> is held across the await point. This may also work if we went with <span class="user-mention" data-user-id="124288">@oli</span> 's suggestion to use an auto-trait like <code>?Suspend</code> to mark safety</p>
<p>but I am not sure if its worth it</p>
<p>in any case: <a href="https://github.com/rust-lang/rust/pull/89303">https://github.com/rust-lang/rust/pull/89303</a></p>



<a name="256078247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256078247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256078247">(Oct 04 2021 at 15:31)</a>:</h4>
<p><span class="user-mention" data-user-id="257428">@Gus Wynn</span> I'm confused about this example</p>



<a name="256078272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256078272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256078272">(Oct 04 2021 at 15:31)</a>:</h4>
<p>doesn't <code>MutexGuard</code> have a "must not suspend" annotation?</p>



<a name="256078292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256078292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256078292">(Oct 04 2021 at 15:31)</a>:</h4>
<p>is the problem that it doesn't "bubble up" through <code>Result</code>?</p>



<a name="256079625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256079625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256079625">(Oct 04 2021 at 15:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20annotations.20on.20fn's/near/256078292">said</a>:</p>
<blockquote>
<p>is the problem that it doesn't "bubble up" through <code>Result</code>?</p>
</blockquote>
<p>yeah this is the problem</p>
<p>We could special case result, but that seems problematic.</p>



<a name="256079718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256079718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256079718">(Oct 04 2021 at 15:40)</a>:</h4>
<p>(we do bubble up for things like <code>Box</code>)</p>



<a name="256080827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256080827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256080827">(Oct 04 2021 at 15:47)</a>:</h4>
<p>I think we should probably bubble</p>



<a name="256080851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256080851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256080851">(Oct 04 2021 at 15:47)</a>:</h4>
<p>Though I've kind of been altering my opinion on this</p>



<a name="256080867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256080867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256080867">(Oct 04 2021 at 15:47)</a>:</h4>
<p>I also think that <code>#[must_use]</code> should behave analogously</p>



<a name="256080907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256080907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256080907">(Oct 04 2021 at 15:47)</a>:</h4>
<p>I think my opinion before was that we should fix this in a comparable way for the two</p>



<a name="256080991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256080991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256080991">(Oct 04 2021 at 15:48)</a>:</h4>
<p>What would be the logic? arbitrary deep nesting within an ADT? If we have that, we would need a way to turn it off, as someone could be making a wrapper that IS suspendable</p>



<a name="256081531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256081531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256081531">(Oct 04 2021 at 15:51)</a>:</h4>
<p>There were a few proposals</p>



<a name="256081549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256081549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256081549">(Oct 04 2021 at 15:51)</a>:</h4>
<p>One was arbitrary deep nesting, another was using a trait</p>



<a name="256082000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256082000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256082000">(Oct 04 2021 at 15:54)</a>:</h4>
<p>Yeah, I think Oli may have mentioned that in review. an auto-trait like Unpin, <code>`#[must_not_suspend]</code> is like <code>PhantomUnSuspend</code>, and people can override with <code>impl Suspend for Thing</code>, similar concept for <code>must_use</code></p>



<a name="256082076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256082076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256082076">(Oct 04 2021 at 15:55)</a>:</h4>
<p>Would adding bubbling like this be a breaking change? it may increase the number of warnings people get by a lot</p>



<a name="256082678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256082678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256082678">(Oct 04 2021 at 15:59)</a>:</h4>
<p>it's not considered a breaking change, because the cap-lint mechanism ensures that your dependencies don't break, but it would certainly take some preparation and consideration</p>



<a name="256082819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256082819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256082819">(Oct 04 2021 at 15:59)</a>:</h4>
<p>what is "cap-lint"? Does rustc ignore <code>deny</code> directives on deps?</p>



<a name="256084189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256084189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256084189">(Oct 04 2021 at 16:07)</a>:</h4>
<p><a href="https://rust-lang.github.io/rfcs/1193-cap-lints.html">https://rust-lang.github.io/rfcs/1193-cap-lints.html</a> oh nice, how did I not know about this?</p>



<a name="256264272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256264272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256264272">(Oct 05 2021 at 15:16)</a>:</h4>
<p>(another interesting quirk is that <code>impl Future</code> and async fn's trigger the <code>must_use</code> lint on Future, but concrete implementors dont. <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=807add1ad9d9fd8f7481173d5f83ce22">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=807add1ad9d9fd8f7481173d5f83ce22</a><br>
is that something we want to reconcile as well?)</p>



<a name="256387240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256387240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256387240">(Oct 06 2021 at 10:13)</a>:</h4>
<p>We put a manual <code>#[must_use]</code> on most of the manual future impls in Tokio, but I guess not that one</p>



<a name="256459374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/must_not_suspend%20annotations%20on%20fn%27s/near/256459374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/must_not_suspend.20annotations.20on.20fn&#x27;s.html#256459374">(Oct 06 2021 at 18:22)</a>:</h4>
<p>Interesting, it would be nice to have that automatically, but that seems like it would have to be solved orthogonally to the nesting <code>must_use</code>, <code>must_not_suspend</code> ask</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>