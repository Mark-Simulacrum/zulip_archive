<html>
<head><meta charset="utf-8"><title>pin! — the &quot;definitive&quot; edition (a rhs-compatible pin-nin... · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html">pin! — the &quot;definitive&quot; edition (a rhs-compatible pin-nin...</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268731241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268731241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268731241">(Jan 20 2022 at 17:52)</a>:</h4>
<p>Heh, I've managed to write a pretty simple rhs-compatible (ergo-pin-ish) stack pinning macro, so that:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;'</span><span class="nb">_</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">as_mut</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>Just Works™ (it just requires def-site hygiene and/or <code>decl_macro</code>)</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>Context</p>
</div><div class="spoiler-content" aria-hidden="true">
<p>It just occurred to me, from having recently been playing with both lifetime extension shenanigans (<a href="https://discord.com/channels/273534239310479360/592856094527848449/933773706575101983">https://discord.com/channels/273534239310479360/592856094527848449/933773706575101983</a>), as well as <code>def_site</code> hygiene shenanigans (<a href="#narrow/stream/122651-general/topic/Simulating.20a.20custom.20'namespace'.20in.20rustc.20plugin">https://rust-lang.zulipchat.com/#narrow/stream/122651-general/topic/Simulating.20a.20custom.20'namespace'.20in.20rustc.20plugin</a>), that with the latter we can polyfill what would otherwise have needed <code>unsafe fields</code> (by having only-macro-accessible fields), and yet, by virtue of being a macro, it doesn't change the fact that we end up using a literal struct expression, which thus enables lifetime extension to kick in.</p>
<p>That is, the naive <code>macro pin($e) { unsafe { Pin::new_unchecked(&amp;mut { $e }) }}</code> obviously doesn't work, but if instead of <code>Pin</code>, we were to be using a custom struct, then lifetime extension can kick in.</p>
<p>Hence the implementation:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#![feature(decl_macro)]</span><span class="w"> </span><span class="c1">// &lt;- we need hygiene for safety</span>

<span class="k">mod</span> <span class="nn">lib</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span>::<span class="n">core</span>::<span class="n">pin</span>::<span class="n">Pin</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span> <span class="nc">StackPinned</span><span class="o">&lt;'</span><span class="na">frame</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="c1">// &lt;- Private!</span>
<span class="w">        </span><span class="o">&amp;'</span><span class="na">frame</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">impl</span><span class="o">&lt;'</span><span class="na">frame</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">StackPinned</span><span class="o">&lt;'</span><span class="na">frame</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="w"></span>
<span class="w">        </span><span class="k">fn</span> <span class="nf">as_mut</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span>: <span class="kp">&amp;</span><span class="o">'</span><span class="nb">_</span> <span class="nc">mut</span><span class="w"> </span><span class="n">StackPinned</span><span class="o">&lt;'</span><span class="na">frame</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"></span>
<span class="w">          </span>-&gt; <span class="nc">Pin</span><span class="o">&lt;&amp;'</span><span class="nb">_</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Safety: the only public constructor</span>
<span class="w">                </span><span class="c1">// is the macro, which takes a</span>
<span class="w">                </span><span class="c1">// `&amp;mut`-lifetime-extended expression.</span>
<span class="w">                </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"></span>
<span class="w">    </span><span class="kr">macro</span><span class="w"> </span><span class="n">pin</span><span class="w"> </span><span class="p">{(</span><span class="w"> </span><span class="cp">$e</span>:<span class="nc">expr</span><span class="w"> </span><span class="cp">$(,</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">StackPinned</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cp">$e</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">)}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<ul>
<li><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=8c5bc627f00e79cede0ae20cb27f8838">Playground</a></li>
</ul>
</div></div>



<a name="268739149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268739149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268739149">(Jan 20 2022 at 18:46)</a>:</h4>
<p>Regarding the "we need hygiene for safety" comment, doesn't macro_rules have hygiene on stable?</p>



<a name="268741699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268741699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268741699">(Jan 20 2022 at 19:04)</a>:</h4>
<p>Not for field names, I believe: a <code>macro_rules!</code> would have needed that <code>&amp;mut T</code> field to have been declared public</p>



<a name="268741872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268741872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268741872">(Jan 20 2022 at 19:06)</a>:</h4>
<p>Yep</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0451</span><span class="p">]</span>: <span class="nc">field</span><span class="w"> </span><span class="sc">'0'</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="k">struct</span> <span class="o">'</span><span class="na">StackPinned</span><span class="o">'</span> <span class="nc">is</span><span class="w"> </span><span class="n">private</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span>-&gt; <span class="nc">src</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span>:<span class="mi">25</span>:<span class="mi">36</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
<span class="mi">25</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="cp">$crate</span>::<span class="n">lib</span>::<span class="n">StackPinned</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cp">$e</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                                    </span><span class="o">^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">field</span><span class="w"></span>
<span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="mi">43</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span>: <span class="nc">lib</span>::<span class="n">StackPinned</span><span class="o">&lt;</span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w">                                                  </span><span class="o">-------------------</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">invocation</span><span class="w"></span>
<span class="w">   </span><span class="o">|</span><span class="w"></span>
</code></pre></div>



<a name="268748528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268748528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268748528">(Jan 20 2022 at 19:57)</a>:</h4>
<p>ah, I see</p>



<a name="268755809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268755809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268755809">(Jan 20 2022 at 20:52)</a>:</h4>
<p>This is the best I've been able to do in stable Rust: <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=b536f548e13de6de48c8ac0f81831b84">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=b536f548e13de6de48c8ac0f81831b84</a>. It's way less ergonomic since the <code>StackPinned</code> is then just a type-state proof and it needs to be <em>moved</em> into a <code>Pin</code> to activate that property (since without hygiene, callers have non-<code>unsafe</code> access to the fields, and thus they are free to <code>take()</code> the referee and whatnot):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pinnable</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">pin</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">as_mut</span><span class="p">();</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">as_mut</span><span class="p">();</span><span class="w"></span>
</code></pre></div>
<p>At that point the current macro is better; the whole point of a rhs-macro was being able to pin and rename in one go</p>



<a name="268828255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268828255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268828255">(Jan 21 2022 at 11:20)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span> are you sure this is sound? I might be missing something, but I don't believe the following should be allowed?:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span>::<span class="n">mem</span>::<span class="n">swap</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=8ae49b336e050b4e34a0e7ce94d9b466">playground</a></p>



<a name="268828333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268828333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268828333">(Jan 21 2022 at 11:21)</a>:</h4>
<p><code>pin!</code> doesn't actually appear to pin? Because <code>as_mut</code> takes <code>&amp;mut self</code> we could do:</p>
<ul>
<li>call <code>pin!</code></li>
<li>call <code>as_mut</code></li>
<li>call <code>mem::swap</code></li>
<li>call <code>as_mut</code> again</li>
<li>we now have undefined behavior?</li>
</ul>



<a name="268828523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268828523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268828523">(Jan 21 2022 at 11:23)</a>:</h4>
<p>As I understand it "pin to the stack" and "get a <code>Pin&lt;&amp;mut T&gt;</code>" require being done in a single operation; otherwise we can mess with the intermediate type like I've shown ^ ?</p>



<a name="268828634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268828634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268828634">(Jan 21 2022 at 11:24)</a>:</h4>
<p>Well, does your code really swap the pinned elements, or do they just swap a struct with a reference to those pinned elements?</p>



<a name="268828908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268828908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268828908">(Jan 21 2022 at 11:27)</a>:</h4>
<p>Oh yeah, good point!</p>



<a name="268829052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268829052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268829052">(Jan 21 2022 at 11:28)</a>:</h4>
<p><span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<a name="268829301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268829301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268829301">(Jan 21 2022 at 11:31)</a>:</h4>
<p>I think I did manage to do something cool? I believe we might be able to collapse <code>pin!</code> and <code>as_mut</code> into a single operation?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=5203838d76a17dd93d7cfc8d5fc89b1b">playground</a></p>



<a name="268837661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268837661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268837661">(Jan 21 2022 at 12:52)</a>:</h4>
<p>ahh, dang -- this doesn't actually work. If we attempt to use the returned value, we run into lifetime issues once again:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">val</span>: <span class="nc">Pin</span><span class="o">&lt;&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">PhantomPinned</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="codehilite" data-code-language="txt"><pre><span></span><code>error[E0716]: temporary value dropped while borrowed
  --&gt; src/main.rs:19:44
   |
19 |         $crate::lib::StackPinned { 0: &amp;mut { $e } }.into_mut()
   |                                            ^^^^^^ creates a temporary which is freed while still in use
...
</code></pre></div>



<a name="268838486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268838486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268838486">(Jan 21 2022 at 13:00)</a>:</h4>
<p>Oh lmao, but this does?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">PhantomPinned</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="268838942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268838942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268838942">(Jan 21 2022 at 13:02)</a>:</h4>
<p>Does anyone what the state of resolving <code>error[E0716]: temporary value dropped while borrowed</code> for cases like these is in the compiler? Am I right in assuming that this will require Polonius to be integrated first?</p>



<a name="268839288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268839288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268839288">(Jan 21 2022 at 13:06)</a>:</h4>
<p>Polonius wont solve it. The problem is that the destructor runs too early, but polonius does not change when destructors run.</p>



<a name="268839349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268839349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alice Ryhl <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268839349">(Jan 21 2022 at 13:06)</a>:</h4>
<p>The reason that <code>dbg!(pin!(PhantomPinned))</code> works is that the value is dropped at the end of the expression, so as long as you stay within the expression, you're good.</p>



<a name="268839607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268839607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268839607">(Jan 21 2022 at 13:08)</a>:</h4>
<p>Thanks; yeah that makes a lot of sense</p>



<a name="268839770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268839770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268839770">(Jan 21 2022 at 13:10)</a>:</h4>
<p>I'm slowly coming to terms with the idea that <code>pin!/StackPinned/StackPinned::as_mut</code> might just be the best way we can make in-line pinning work for the foreseeable future.</p>



<a name="268839867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268839867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268839867">(Jan 21 2022 at 13:11)</a>:</h4>
<p>The construction also feels analogous to <code>Pin::new/Pin/Pin::as_mut</code>; so even if we need to introduce a few new types, the way it works is actually quite similar.</p>



<a name="268849502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268849502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268849502">(Jan 21 2022 at 14:27)</a>:</h4>
<p>Yeah, that was the objective. I've tried really hard to explore so many analogous variations —believe me, I've had some horrendously crazy stuff going on at some point— and at the end of the day, this implementation of <code>pin!</code>, involving <code>StackPinned!</code> and <code>as_mut!</code>, and the already existing <code>pin_mut!</code> macros are the best thing available out there.</p>
<p>That being said, if we were the core / standard library, we could cut the <code>StackPinned</code> middlecrap and use <code>Pin { pointer: &amp;mut { $e } }</code>, hence yielding a genuine <code>Pin&lt;&amp;mut _&gt;</code> type!</p>
<p>Hence my suggesting this macro <em>here</em>, rather than as a third-party crate: both the <code>def_site</code> and the required access to the private <code>pointer</code> field of <code>Pin</code> lead to this macro having to be featured by the stdlib</p>



<a name="268850434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268850434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268850434">(Jan 21 2022 at 14:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/A.20rhs-compatible.20pin-ning.20macro/near/268849502">said</a>:</p>
<blockquote>
<p>That being said, if we were the core / standard library, we could cut the <code>StackPinned</code> middlecrap and use <code>Pin { pointer: &amp;mut { $e } }</code>, hence yielding a genuine <code>Pin&lt;&amp;mut _&gt;</code> type!</p>
</blockquote>
<p>ohhhhhh!</p>



<a name="268850470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268850470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yoshua Wuyts [he/they] <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268850470">(Jan 21 2022 at 14:35)</a>:</h4>
<p>yesssssss</p>



<a name="268865766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268865766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268865766">(Jan 21 2022 at 16:21)</a>:</h4>
<p>this looks exciting :)</p>



<a name="268908995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268908995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268908995">(Jan 21 2022 at 22:01)</a>:</h4>
<h4>Submitted <a href="https://github.com/rust-lang/rust/pull/93176">https://github.com/rust-lang/rust/pull/93176</a></h4>



<a name="268909034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268909034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268909034">(Jan 21 2022 at 22:01)</a>:</h4>
<p>(gotta add some compile_fail tests, but other than that it's already pretty documented)</p>



<a name="268970207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268970207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268970207">(Jan 22 2022 at 18:13)</a>:</h4>
<blockquote>
<p>it just requires def-site hygiene and/or decl_macro</p>
</blockquote>
<p>that, or just <code>allow_internal_unstable</code> which already works fine: <a href="https://github.com/m-ou-se/rust/commit/stack-pinning-macro">https://github.com/m-ou-se/rust/commit/stack-pinning-macro</a></p>
<p>so no need to wait for full macros 2.0</p>



<a name="268971786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268971786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268971786">(Jan 22 2022 at 18:48)</a>:</h4>
<p>What's the benefit of that over using a macro 2.0?</p>



<a name="268971897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268971897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268971897">(Jan 22 2022 at 18:51)</a>:</h4>
<p>full macro 2.0 hygiene isn't finished yet</p>



<a name="268971912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268971912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268971912">(Jan 22 2022 at 18:51)</a>:</h4>
<p>and it'll probably take a long time before it is stable</p>



<a name="268971953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268971953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268971953">(Jan 22 2022 at 18:52)</a>:</h4>
<p>We don't need it to be stable though</p>



<a name="268971957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268971957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268971957">(Jan 22 2022 at 18:52)</a>:</h4>
<p>then <code>pin!()</code> can't be stable.</p>



<a name="268971964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268971964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268971964">(Jan 22 2022 at 18:52)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="268971977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268971977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268971977">(Jan 22 2022 at 18:53)</a>:</h4>
<p>addr_of! is stable</p>



<a name="268971979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268971979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268971979">(Jan 22 2022 at 18:53)</a>:</h4>
<p>and uses decl_macro</p>



<a name="268972034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268972034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268972034">(Jan 22 2022 at 18:54)</a>:</h4>
<p>yes, none of those uses macro 2.0 hygiene. they're all using semitransparent hygiene.</p>



<a name="268972048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268972048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268972048">(Jan 22 2022 at 18:54)</a>:</h4>
<p>(<a href="https://github.com/rust-lang/rust/blob/ecf72996eda4f8af19b0ca7235c6f62e0245a313/library/core/src/ptr/mod.rs#L1520">https://github.com/rust-lang/rust/blob/ecf72996eda4f8af19b0ca7235c6f62e0245a313/library/core/src/ptr/mod.rs#L1520</a>)</p>



<a name="268972057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268972057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268972057">(Jan 22 2022 at 18:55)</a>:</h4>
<p>Ah I see</p>



<a name="268972107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268972107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268972107">(Jan 22 2022 at 18:56)</a>:</h4>
<p>the feature that allows you to use private fields/types/anything from the crate that the macro is defined in is nowhere near stabilization.</p>



<a name="268972116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268972116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268972116">(Jan 22 2022 at 18:56)</a>:</h4>
<p>And it has to be stable before it can be exposed in a stable macro?</p>



<a name="268972126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268972126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268972126">(Jan 22 2022 at 18:57)</a>:</h4>
<p>Why is it different than other features</p>



<a name="268972177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268972177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268972177">(Jan 22 2022 at 18:58)</a>:</h4>
<p>because it isn't finished yet. we can't expose any unfinished or partially broken features.</p>



<a name="268973546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973546">(Jan 22 2022 at 19:31)</a>:</h4>
<p>Having to use <code>allow_internal_unstable</code> would be a pity, though, because it'd technically mean the <code>pin_internals</code> feature would be unsound (as in: a user could cause UB without using <code>unsafe</code> thanks to enabling that feature) <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="268973696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973696">(Jan 22 2022 at 19:35)</a>:</h4>
<p>I'd thus like to gauge the "unsatbility" / unreliability of the <code>decl_macro</code>s: cc <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> <span class="user-mention" data-user-id="125294">@Aaron Hill</span>, how "reliable" / "unreliable" would you deem <code>def_site</code> hygiene to be, relative to considering an <em>eventual</em> stabilization of the <code>pin!</code> macro?</p>
<p>For reference, it's defined as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">pin</span><span class="p">(</span><span class="cp">$e</span>:<span class="nc">expr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Pin</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pointer</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cp">$e</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>from within the module where the <code>Pin</code> type is defined, thus relying on def_site hygiene:</p>
<ul>
<li>to resolve the <code>Pin</code> path (not paramount, a <code>$crate::pin::Pin</code> path could always be used),</li>
<li>to have access to the <strong>private</strong> <code>pointer</code> field: <strong>paramount</strong></li>
</ul>



<a name="268973740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973740">(Jan 22 2022 at 19:36)</a>:</h4>
<p>I didn't even realize that def-site hygiene affected field privacy</p>



<a name="268973749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973749">(Jan 22 2022 at 19:36)</a>:</h4>
<p>In fact, I think I saw a proposal a while back around adding privacy-relates behavior to macros</p>



<a name="268973766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973766">(Jan 22 2022 at 19:37)</a>:</h4>
<p>You can't get that behavior with macro_rules, right?</p>



<a name="268973782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973782">(Jan 22 2022 at 19:37)</a>:</h4>
<p>Indeed you cannot</p>



<a name="268973826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973826">(Jan 22 2022 at 19:38)</a>:</h4>
<p>I thought the mixed hygiene for macro rules was supposed to be 'def-site for identifiers / local vars, use-site for everything else'</p>



<a name="268973829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973829">(Jan 22 2022 at 19:38)</a>:</h4>
<p>Which is why <span class="user-mention" data-user-id="310399">@Mara</span>'s approach was to make it <code>pub</code>-but-unstable, since <code>macro_rules!</code> macros can dodge stability issues</p>



<a name="268973831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973831">(Jan 22 2022 at 19:38)</a>:</h4>
<p>But it seems like 'pure' def-site hygiene has additional privacy behvaior</p>



<a name="268973850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973850">(Jan 22 2022 at 19:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20.28a.20rhs-compatible.20pin-nin.2E.2E.2E/near/268973546">said</a>:</p>
<blockquote>
<p>Having to use <code>allow_internal_unstable</code> would be a pity, though, because it'd technically mean the <code>pin_internals</code> feature would be unsound (as in: a user could cause UB without using <code>unsafe</code> thanks to enabling that feature) <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>
</blockquote>
<p>there are many unstable features that can be misused for unsoundness. enabling a feature called '_internals' is just asking for trouble.</p>



<a name="268973897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973897">(Jan 22 2022 at 19:40)</a>:</h4>
<p>unless the behavior is only triggered when the <em>struct path</em> has def-site hygiene? Let me see if I can find the code that deals with this</p>



<a name="268973941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268973941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268973941">(Jan 22 2022 at 19:41)</a>:</h4>
<p>we could name it <code>unsafe_pin_internals</code> to be clearer</p>



<a name="268974632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268974632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268974632">(Jan 22 2022 at 19:55)</a>:</h4>
<p>Macros 2.0 hygiene is super unstable. Like an actual research project levels of unstable. It’s not unimaginable that we’d tear it out macros 2.0 completely and do something different</p>



<a name="268974707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268974707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268974707">(Jan 22 2022 at 19:56)</a>:</h4>
<p>I see where the difference is coming from. During resolution, we choose the type of hygiene based on whether or not we're resolving a local variable: <a href="https://github.com/rust-lang/rust/blob/d63a8d965e76f29a2b65c1f22a32613df1fe5c2c/compiler/rustc_resolve/src/lib.rs#L1942">https://github.com/rust-lang/rust/blob/d63a8d965e76f29a2b65c1f22a32613df1fe5c2c/compiler/rustc_resolve/src/lib.rs#L1942</a></p>



<a name="268974789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268974789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268974789">(Jan 22 2022 at 19:58)</a>:</h4>
<p>However, during field resolution, we unconditionally use macros 2.0 hygiene (ignoring the macro_rules hygiene): <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/expr.rs#L1830">https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/expr.rs#L1830</a></p>



<a name="268974793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268974793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268974793">(Jan 22 2022 at 19:58)</a>:</h4>
<p>So, field resolution is treated differently than local variable resolution w.r.t hygiene</p>



<a name="268974825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268974825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268974825">(Jan 22 2022 at 20:00)</a>:</h4>
<p>Crazy idea: We implement unstable <em>fields</em> (if we don't already support that), and make the <code>Pin</code> structs field public and unstable</p>



<a name="268974924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268974924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268974924">(Jan 22 2022 at 20:00)</a>:</h4>
<p>And just use allow_internal_unstable to access that specific field, using normal (macro_rules hygiene)</p>



<a name="268974935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268974935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268974935">(Jan 22 2022 at 20:00)</a>:</h4>
<p>similar to what we do for the <code>format!</code> infrastructure</p>



<a name="268974936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268974936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268974936">(Jan 22 2022 at 20:00)</a>:</h4>
<p>Isn't that what Mara is proposing?</p>



<a name="268974949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268974949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268974949">(Jan 22 2022 at 20:01)</a>:</h4>
<p>Oh, yeah <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="268974963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268974963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268974963">(Jan 22 2022 at 20:01)</a>:</h4>
<p>I missed her proposal - sorry about that</p>



<a name="268974965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268974965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268974965">(Jan 22 2022 at 20:01)</a>:</h4>
<p>That sounds good to me</p>



<a name="268975051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268975051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268975051">(Jan 22 2022 at 20:03)</a>:</h4>
<p>I also agree that we have plenty of unsound features, so it would be fine to add another one. We could even mark it as 'incomplete' to further discourage use (which it technically is, since ideally we'd use a hygiene-based solution)</p>



<a name="268975316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268975316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268975316">(Jan 22 2022 at 20:09)</a>:</h4>
<p>Side note: I think it's somewhat unfortunate that the rules around lifetime extension are forcing us into defining this macro in <code>core</code></p>



<a name="268975378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268975378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268975378">(Jan 22 2022 at 20:10)</a>:</h4>
<p>Ideally, the only reason to put this in <code>core</code> would be for convenience, and users would be able to define an identical macro themselves (both would use <code>Pin::new_unchecked</code>)</p>



<a name="268975389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268975389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268975389">(Jan 22 2022 at 20:11)</a>:</h4>
<p>This seems like a problem that could potentially be faced by other 'constructor' macros</p>



<a name="268975392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268975392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268975392">(Jan 22 2022 at 20:11)</a>:</h4>
<p>There's a similar problem with format_args!</p>



<a name="268975671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268975671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268975671">(Jan 22 2022 at 20:13)</a>:</h4>
<p>Doesn't RFC 66 solve it?</p>



<a name="268975727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268975727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268975727">(Jan 22 2022 at 20:14)</a>:</h4>
<blockquote>
<p>Crazy idea</p>
</blockquote>
<p>Hey! tsk.</p>



<a name="268975940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268975940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268975940">(Jan 22 2022 at 20:14)</a>:</h4>
<p>Well, we both independently came up with it, so I guess it's pretty reasonable after all <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="268975970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268975970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268975970">(Jan 22 2022 at 20:15)</a>:</h4>
<p>it's how all macros work that access something 'private' <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="268976056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976056">(Jan 22 2022 at 20:16)</a>:</h4>
<p><span class="user-mention" data-user-id="232018">@Daniel Henry-Mantilla</span>  regarsing the lifetime extension issue: what prevents the macro from just using the manual desugaring that you wrote down?</p>



<a name="268976252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976252">(Jan 22 2022 at 20:17)</a>:</h4>
<p>The StackPinned struct?</p>



<a name="268976267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976267">(Jan 22 2022 at 20:18)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">anon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$value</span><span class="p">;</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Pin</span>::<span class="n">new_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">anon</span><span class="p">);</span><span class="w"></span>
</code></pre></div>



<a name="268976318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976318">(Jan 22 2022 at 20:18)</a>:</h4>
<p>Is is that we're not guaranteed to actually move the expression?</p>



<a name="268976333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976333">(Jan 22 2022 at 20:18)</a>:</h4>
<p>That is how the current macros work</p>



<a name="268976342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976342">(Jan 22 2022 at 20:18)</a>:</h4>
<p>But it is not very ergonomic</p>



<a name="268976349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976349">(Jan 22 2022 at 20:19)</a>:</h4>
<p>We want to <em>return</em> a Pin&lt;&amp;mut T&gt; from the macro</p>



<a name="268976353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976353">(Jan 22 2022 at 20:19)</a>:</h4>
<p>Oh - without an enclosing block, we can't use it as the RHS of a let?</p>



<a name="268976440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976440">(Jan 22 2022 at 20:19)</a>:</h4>
<p>and using an enclosing block would cause <code>anon</code> to be dropped</p>



<a name="268976614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976614">(Jan 22 2022 at 20:20)</a>:</h4>
<p>Right</p>



<a name="268976624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976624">(Jan 22 2022 at 20:20)</a>:</h4>
<p>It ends up looking like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="n">pin</span><span class="o">!</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span><span class="w"></span>
<span class="n">foo</span><span class="o">..</span><span class="p">.</span><span class="w"></span>
</code></pre></div>



<a name="268976653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976653">(Jan 22 2022 at 20:21)</a>:</h4>
<p>The original binding has to be shadowed to ensure it's never used again.</p>



<a name="268976810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976810">(Jan 22 2022 at 20:23)</a>:</h4>
<p>Tbh, one way or another, I'd hope that macros get to be able to access privacy in a way that <code>def_site()</code> currently achieves, if the latter is deemed too unstable.</p>



<a name="268976860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976860">(Jan 22 2022 at 20:24)</a>:</h4>
<p>would be nice. but totally not worth blocking <code>pin!()</code> on.</p>



<a name="268976877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976877">(Jan 22 2022 at 20:24)</a>:</h4>
<p>Yeah yeah, agreed. That's why I'm currently working with the changes you've suggested</p>



<a name="268976893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976893">(Jan 22 2022 at 20:25)</a>:</h4>
<p>I've renamed it to <code>unsafe_…</code>, and making it be an <code>incomplete</code> feature as well.</p>



<a name="268976958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976958">(Jan 22 2022 at 20:26)</a>:</h4>
<p>an <code>incomplete</code> library feature? that's new.</p>



<a name="268976993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976993">(Jan 22 2022 at 20:26)</a>:</h4>
<p>Ah, then maybe it won't work; I'm writing it as we speak</p>



<a name="268976997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268976997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268976997">(Jan 22 2022 at 20:26)</a>:</h4>
<p><a href="/user_uploads/4715/jCRjPI1b5XZVbfiq-NhTbVUc/Screen-Shot-2022-01-22-at-21.26.28.png">Screen-Shot-2022-01-22-at-21.26.28.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/jCRjPI1b5XZVbfiq-NhTbVUc/Screen-Shot-2022-01-22-at-21.26.28.png" title="Screen-Shot-2022-01-22-at-21.26.28.png"><img src="/user_uploads/4715/jCRjPI1b5XZVbfiq-NhTbVUc/Screen-Shot-2022-01-22-at-21.26.28.png"></a></div>



<a name="268977023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268977023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268977023">(Jan 22 2022 at 20:27)</a>:</h4>
<p>I liked the phrasing in:</p>
<blockquote>
<p>Let's thus hope an <code>unsafe</code>-named <code>incomplete</code> <code>unstable</code> feature is enough deterrent…</p>
</blockquote>
<p><span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="268977080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268977080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268977080">(Jan 22 2022 at 20:28)</a>:</h4>
<p>we have plenty of features that you shouldn't enable if you want correct/sound code.</p>



<a name="268977114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268977114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268977114">(Jan 22 2022 at 20:29)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/93210">this issue</a> is a bit annoying, but shouldn't take long to be fixed.</p>



<a name="268977202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268977202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268977202">(Jan 22 2022 at 20:31)</a>:</h4>
<p>How would one check if a field is marked as unstable?</p>



<a name="268977290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268977290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268977290">(Jan 22 2022 at 20:33)</a>:</h4>
<p><code>tcx.is_doc_hidden(did)</code> should be enough</p>



<a name="268977291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268977291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268977291">(Jan 22 2022 at 20:33)</a>:</h4>
<p>the error message is generated here I think: &lt;<a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/expr.rs#L1749">https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/expr.rs#L1749</a>&gt;</p>



<a name="268977296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268977296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268977296">(Jan 22 2022 at 20:33)</a>:</h4>
<p>Ah okay, I'll see if I can fix that</p>



<a name="268977792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268977792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268977792">(Jan 22 2022 at 20:45)</a>:</h4>
<p>Fixed <a href="https://github.com/rust-lang/rust/pull/93214">https://github.com/rust-lang/rust/pull/93214</a></p>



<a name="268977993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268977993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268977993">(Jan 22 2022 at 20:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="310399">Mara</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20.28a.20rhs-compatible.20pin-nin.2E.2E.2E/near/268977080">said</a>:</p>
<blockquote>
<p>we have plenty of features that you shouldn't enable if you want correct/sound code.</p>
</blockquote>
<p>Ok, I'll extract the more debatable <code>incomplete</code> feature part to its own commit, so that it can easily be reverted during PR review; I'm not gonna preemptively revert it since I think this is a discussion I'd like there to be, <em>somewhere</em>[^1]: we have <code>unsafe_code</code> which already covers stuff which was deemed "out of scope for <code>unsafe</code>", such as <code>#[no_mangle]</code>.</p>
<p>Ideally, we'd similarly have "conceptually <code>unsafe</code> to enable" feature gates, which would include our current <code>incomplete_features</code> (since potentially unsound), and a new category of <code>unsafe_features</code>.</p>
<p>[^1]: Maybe we could fork this thread into <code>t-lang</code> and bring it up there?</p>



<a name="268979730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/268979730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#268979730">(Jan 22 2022 at 21:31)</a>:</h4>
<p>unstable features are unstable for a reason.. we make no guarantees about what happens when you enable nightly features. i'd be opposed to a way of specifying a feature is 'unsafe', because it sets the expectation that all other features are always safe</p>



<a name="269089605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269089605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269089605">(Jan 24 2022 at 11:08)</a>:</h4>
<p>This seems like piling back on top of hack to get something landed now. I want to make sure we keep track of the problems and what a principled solution looks like so we keep working towards that too and don’t stabilise anything that prohibits changing implementation in the long run</p>



<a name="269092159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269092159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269092159">(Jan 24 2022 at 11:32)</a>:</h4>
<p>I think that the macro + unstable feature has been used enough times to be a reliable approach; I've featured it in the PR. I'll nonetheless add a mention to this semi-transparent <em>vs.</em> opaque implementations in the tracking issue <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<ul>
<li>So this at least guarantees the existence of an easy path to stabilization, <em>implementation-wise</em>; and now that we know of it, it's true that it shouldn't be that important which implementation the <em>currently unstable</em> macro ends up using in this very first PR</li>
</ul>



<a name="269106384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269106384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269106384">(Jan 24 2022 at 13:42)</a>:</h4>
<p>I think macro + unstable feature is a hack and every time it has been used we should feel bad (but note that feeling bad is sometimes a worthwhile price to pay to get a feature early). And while we might assess each feature to be worth some cost in hackiness, this is technical debt and worse, it is technical debt in APIs with strict back compat so it can effectively never be paid off, so I think we should be extremely careful about considering the overall effect on the whole library/language of repeatedly paying these small costs in hackiness.</p>



<a name="269106670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269106670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269106670">(Jan 24 2022 at 13:44)</a>:</h4>
<p>Note sure how seriously I mean this, but as an alternative, why not just make the <code>pointer</code> field in <code>Pin</code> public? Then you wouldn't need a macro for stack pinning at all?</p>



<a name="269106879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269106879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269106879">(Jan 24 2022 at 13:45)</a>:</h4>
<p>OK, no that's stupid <span aria-label="rolling on the floor laughing" class="emoji emoji-1f923" role="img" title="rolling on the floor laughing">:rolling_on_the_floor_laughing:</span></p>



<a name="269106922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269106922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269106922">(Jan 24 2022 at 13:45)</a>:</h4>
<p>You need it to be write-only public or something</p>



<a name="269107026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269107026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269107026">(Jan 24 2022 at 13:46)</a>:</h4>
<p>I guess what we really want here is placement new?</p>



<a name="269107215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269107215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269107215">(Jan 24 2022 at 13:47)</a>:</h4>
<p>Placement new?</p>



<a name="269107287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269107287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269107287">(Jan 24 2022 at 13:48)</a>:</h4>
<p>I don't see how that fits in here</p>



<a name="269107393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269107393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269107393">(Jan 24 2022 at 13:49)</a>:</h4>
<p>What we really want is RFC 66 or some spinoff of it</p>



<a name="269109027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269109027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269109027">(Jan 24 2022 at 13:59)</a>:</h4>
<p>I was thinking you want <code>let pinned &lt;= Pin::new(&amp;mut foo.bar());</code> or whatever to work, where the semantics of that is that it creates the Pin around the result of the expression on the stack (i.e., in place), rather than passing the result to <code>new</code>?</p>



<a name="269109619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269109619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269109619">(Jan 24 2022 at 14:03)</a>:</h4>
<p>That's a bit different to placement new but feels philosophically similar</p>



<a name="269109790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269109790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269109790">(Jan 24 2022 at 14:04)</a>:</h4>
<p>Hm so you're thinking placement new would influence temporary lifetimes</p>



<a name="269109953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269109953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269109953">(Jan 24 2022 at 14:05)</a>:</h4>
<p>I think maybe what we want is an easy way to extend a temp lifetime; the implicit extension proposed by RFC 66 feels like it would be very footgunny with RAII like mutex guards</p>



<a name="269110533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269110533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269110533">(Jan 24 2022 at 14:09)</a>:</h4>
<p>Something like <code>let pinned = Pin::new(&amp;'fn mut foo.bar());</code></p>



<a name="269110700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269110700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269110700">(Jan 24 2022 at 14:10)</a>:</h4>
<p><code>fn foo() { let x; { x = &amp;'fn String::new(); } println!("{}", x) }</code></p>



<a name="269110738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269110738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269110738">(Jan 24 2022 at 14:10)</a>:</h4>
<p>That wouldn't work very well with method chains though</p>



<a name="269113025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269113025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269113025">(Jan 24 2022 at 14:29)</a>:</h4>
<p>I must admit to being handwavey here and be going with a feeling rather than having a plan. Having said that, I'm not thinking in terms of lifetimes, I would expect the lifetimes follow the place where we construct the object, and I'm thinking primarily in terms of placement. So Pin::new creates a Pin locally and copies it back to the caller, but a placement new feature of some kind would allow Pin::new to create the Pin directly in the callers stack frame, similarly to how <code>box</code> creates an object directly on the heap</p>



<a name="269113537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269113537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269113537">(Jan 24 2022 at 14:33)</a>:</h4>
<p>I suppose something like that would work as well, but it feels much more niche than a general lifetime extension feature</p>



<a name="269113950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269113950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269113950">(Jan 24 2022 at 14:36)</a>:</h4>
<p>I think it is not niche in that this is just one use of it that essentially 'comes for free'. There is a strong motivation for being able to create big objects on the heap without copying, using custom allocators in an ergonomic way, and possible working with arenas/GC</p>



<a name="269114048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269114048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ibraheem Ahmed <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269114048">(Jan 24 2022 at 14:37)</a>:</h4>
<p>Oh, I thought you were saying this would be a different feature than placement new</p>



<a name="269114159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269114159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269114159">(Jan 24 2022 at 14:38)</a>:</h4>
<p>Well, I am hand-waving :-) but I hope that a flexible placement new could be used here</p>



<a name="269382436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269382436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269382436">(Jan 26 2022 at 09:28)</a>:</h4>
<blockquote>
<p>I think macro + unstable feature is a hack and every time it has been used we should feel bad</p>
</blockquote>
<p>i don't agree. <code>allow_internal_unstable</code> is a very common tool in the standard library and it works well. and even if you want to remove that feature, there's not a lot of techincal debt involved, as all of them could be replaced by full macros 2.0 hygiene, whenever that happens.</p>



<a name="269388261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269388261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269388261">(Jan 26 2022 at 10:24)</a>:</h4>
<p>I don't think there's anything wrong with allow_internal_unstable. I think that using it to simulate visibility is a bit of a hack because the principled way to do it would be to just use visibility :-) (of course just because it's hack doesn't mean it isn't sometimes necessary).</p>



<a name="269388364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269388364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269388364">(Jan 26 2022 at 10:25)</a>:</h4>
<p>I wouldn't bet on macros 2.0 to save us because given current progress, macros 2.0 will never actually happen, and if it does, I think the whole hygiene model is basically an open question</p>



<a name="269398237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/pin%21%20%E2%80%94%20the%20%22definitive%22%20edition%20%28a%20rhs-compatible%20pin-nin.../near/269398237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/pin!.20.E2.80.94.20the.20.22definitive.22.20edition.20(a.20rhs-compatible.20pin-nin.2E.2E.2E.html#269398237">(Jan 26 2022 at 11:45)</a>:</h4>
<blockquote>
<p>I think that using it to simulate visibility is a bit of a hack</p>
</blockquote>
<p>most usages of allow_internal_unstable are exactly that. e.g. format_args being allowed to call fmt::Arguments::new, or println or panic or assert being allowed to call the underlying print/panic/assert function, etc.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>