<html>
<head><meta charset="utf-8"><title>#57017 · wg-async · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/index.html">wg-async</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html">#57017</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="247743929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247743929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247743929">(Jul 30 2021 at 18:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116883">@tmandry</span> - here's the hack I mentioned in the meeting earlier: <a href="https://github.com/eholk/rust/commit/4ef682c0f63b056423cb69d9caf91b22ed1ba94b">https://github.com/eholk/rust/commit/4ef682c0f63b056423cb69d9caf91b22ed1ba94b</a></p>



<a name="247743956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247743956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247743956">(Jul 30 2021 at 18:17)</a>:</h4>
<p>It fails several tests in the test suite, so that's good</p>



<a name="247744171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247744171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247744171">(Jul 30 2021 at 18:19)</a>:</h4>
<p>On of the tests it fails is from <a href="http://async-fn-nonsend.rs">async-fn-nonsend.rs</a>:</p>
<div class="codehilite"><pre><span></span><code>async fn non_send_temporary_in_match() {
    // We could theoretically make this work as well (produce a `Send` future)
    // for scrutinees / temporaries that can or will
    // be dropped prior to the match body
    // (e.g. `Copy` types).
    match Some(non_send()) {
        Some(_) =&gt; fut().await,
        None =&gt; {}
    }
}
</code></pre></div>
<p>That looks pretty similar, but I'm not sure whether it should work or not. Are we allowed to drop the result of <code>Some(non_send())</code> before calling <code>fut().await</code>, since even though we technically still have a borrow in the pattern, <code>Some(_)</code>, it's not actually used?</p>



<a name="247771298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247771298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247771298">(Jul 30 2021 at 22:58)</a>:</h4>
<p>hmm, good question</p>



<a name="247771575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247771575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247771575">(Jul 30 2021 at 23:02)</a>:</h4>
<p>the language semantics are that <code>Some(non_send())</code> lives until the end of the match</p>



<a name="247771584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247771584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247771584">(Jul 30 2021 at 23:02)</a>:</h4>
<p>so I think we should err on the side of not allowing it for now</p>



<a name="247771876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247771876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247771876">(Jul 30 2021 at 23:06)</a>:</h4>
<p>it isn't specified how define how captures across await points actually work; I think we <em>could</em> define them to behave this way, but it feels like a special case</p>



<a name="247771932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247771932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247771932">(Jul 30 2021 at 23:07)</a>:</h4>
<p>borrowing semantics, on the other hand, are clearly defined by control flow</p>



<a name="247772175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247772175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247772175">(Jul 30 2021 at 23:11)</a>:</h4>
<p>actually, the more I think about it</p>



<a name="247772430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247772430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247772430">(Jul 30 2021 at 23:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116883">tmandry</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.2357017/near/247771932">said</a>:</p>
<blockquote>
<p>borrowing semantics, on the other hand, are clearly defined by control flow</p>
</blockquote>
<p>that's not what <a href="https://github.com/rust-lang/rust/issues/57017">#57017</a> is about, it's about holding a value (which happens to be a reference) that isn't <code>Sync</code> over an await point</p>



<a name="247772626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247772626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247772626">(Jul 30 2021 at 23:18)</a>:</h4>
<p>and control flow analysis for these values is really what we want</p>



<a name="247772845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247772845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247772845">(Jul 30 2021 at 23:22)</a>:</h4>
<p><span class="user-mention" data-user-id="127859">@Taylor Cramer</span> can you explain the comment about <code>Copy</code> types?</p>



<a name="247772868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/247772868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#247772868">(Jul 30 2021 at 23:23)</a>:</h4>
<p>I can't find anything that would imply that unused <code>Copy</code> temporaries in scrutinees can be dropped prior to the match body</p>



<a name="249175292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249175292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249175292">(Aug 11 2021 at 22:02)</a>:</h4>
<p>Okay, I'm finally coming back to this. Looking at the <code>async-fn-nonsend.rs</code> test again, it looks like <code>non_sync_with_method_call</code> is more like the test case from <a href="https://github.com/rust-lang/rust/issues/57017">#57017</a>:</p>
<div class="codehilite"><pre><span></span><code>async fn non_sync_with_method_call() {
    // FIXME: it&#39;d be nice for this to work.
    let f: &amp;mut std::fmt::Formatter = panic!();
    if non_sync().fmt(f).unwrap() == () {
        fut().await;
    }
}
</code></pre></div>



<a name="249175516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249175516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249175516">(Aug 11 2021 at 22:05)</a>:</h4>
<p>Anyway, back to <a href="https://github.com/rust-lang/rust/issues/57017">#57017</a>, the test cases I've been looking into is:</p>
<div class="codehilite"><pre><span></span><code>pub fn wat1() -&gt; impl Future + Send {
    let client = Client(Box::new(true));
    assert_send(client);
    async move {
        match client.status() {
            200 =&gt; {
                get().await;
            },
            _ =&gt; (),
        }
    }
}
</code></pre></div>



<a name="249175706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249175706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249175706">(Aug 11 2021 at 22:07)</a>:</h4>
<p>As I understand it, the <code>match</code> gets simplified into something like this:</p>
<div class="codehilite"><pre><span></span><code>let client = Client(Box::new(true));
let t1: &amp;Client = &amp;client;
let t2: u32 = Client::status(t1);
match t2 {
    100 =&gt; get().await,
    _ =&gt; (),
}
</code></pre></div>



<a name="249176096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249176096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249176096">(Aug 11 2021 at 22:10)</a>:</h4>
<p>So to approximate for the type of the closure for the <code>.await</code>, we basically just look at the types of everything in scope at that point. So in this case, we have a <code>Client</code>, an <code>&amp;Client</code>, and a <code>u32</code>. The problem is that since <code>Client</code> is <code>Send</code> but not <code>Sync</code>, <code>&amp;Client</code> is not <code>Send</code>.</p>



<a name="249176295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249176295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249176295">(Aug 11 2021 at 22:12)</a>:</h4>
<p>But if the rule is that the scrutinee of the match expression must live for the whole match expression, it seems like that should only include <code>t2: u32</code>. Any intermediate temporaries should be able to be dropped, right?</p>



<a name="249176585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249176585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249176585">(Aug 11 2021 at 22:15)</a>:</h4>
<p>So brainstorming a little more, it seems like maybe this scope-based analysis for live-across-yield types shouldn't include temporaries, but only things that are (roughly) bound to some name the program can access. I'm being pretty imprecise about what I mean by bound here though.</p>



<a name="249176767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249176767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249176767">(Aug 11 2021 at 22:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.2357017/near/249176295">said</a>:</p>
<blockquote>
<p>But if the rule is that the scrutinee of the match expression must live for the whole match expression, it seems like that should only include <code>t2: u32</code>. Any intermediate temporaries should be able to be dropped, right?</p>
</blockquote>
<p>I mean, not according to <a href="https://doc.rust-lang.org/reference/destructors.html#temporary-scopes">the reference</a></p>



<a name="249176794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249176794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249176794">(Aug 11 2021 at 22:17)</a>:</h4>
<blockquote>
<p>The scrutinee of a match expression is not a temporary scope, so temporaries in the scrutinee can be dropped after the match expression.</p>
</blockquote>



<a name="249176803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249176803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249176803">(Aug 11 2021 at 22:17)</a>:</h4>
<p>Ah thanks, that reference looks like something I should read :)</p>



<a name="249176909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249176909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249176909">(Aug 11 2021 at 22:18)</a>:</h4>
<p>yeah, so what I'm thinking is that <em>scopes</em> shouldn't actually matter for this analysis, but rather <em>liveness</em></p>



<a name="249176976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249176976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249176976">(Aug 11 2021 at 22:19)</a>:</h4>
<p>i.e. whether a value is actually <em>used</em> after an await point, as opposed to being potentially usable</p>



<a name="249177049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177049">(Aug 11 2021 at 22:19)</a>:</h4>
<p>this is what we do for NLL</p>



<a name="249177168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177168">(Aug 11 2021 at 22:20)</a>:</h4>
<p>if we were to use scopes, we'd have to change the semantics I linked to do anything about this :-)</p>



<a name="249177179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177179">(Aug 11 2021 at 22:20)</a>:</h4>
<p>Yeah, scopes are an overapproximation of liveness.</p>



<a name="249177209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177209">(Aug 11 2021 at 22:21)</a>:</h4>
<p>So if the type implements <code>Drop</code>, would that count as a use after the <code>await</code>?</p>



<a name="249177221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177221">(Aug 11 2021 at 22:21)</a>:</h4>
<p>good question, and yes!</p>



<a name="249177297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177297">(Aug 11 2021 at 22:22)</a>:</h4>
<p>So another thing I don't have a great handle on is why this case does work:</p>
<div class="codehilite"><pre><span></span><code>pub fn ok() -&gt; impl Future + Send {
    let client = Client(Box::new(true));
    async move {
        if client.status() == 200 {
            let _x = get().await;
        }
    }
}
</code></pre></div>



<a name="249177339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177339">(Aug 11 2021 at 22:22)</a>:</h4>
<p>I figured it was because <code>if</code> doesn't keep its expression live until the end of the <code>if</code> expression, but I'm not sure</p>



<a name="249177367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177367">(Aug 11 2021 at 22:23)</a>:</h4>
<p>right</p>



<a name="249177407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177407">(Aug 11 2021 at 22:23)</a>:</h4>
<p>the condition of an <code>if</code> expression is a temporary scope, so the borrow is dropped before entering the body</p>



<a name="249177488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177488">(Aug 11 2021 at 22:24)</a>:</h4>
<p>Ah, okay. So (and I'm not saying we should do this, but...) if we made the scrutinee of a <code>match</code> a temporary scope, would that fix this issue?</p>



<a name="249177549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177549">(Aug 11 2021 at 22:25)</a>:</h4>
<p>if the analysis is doing what I think it is, yes</p>



<a name="249177588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177588">(Aug 11 2021 at 22:25)</a>:</h4>
<p>but the current behavior is load bearing now :)</p>



<a name="249177601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177601">(Aug 11 2021 at 22:25)</a>:</h4>
<p>This works:</p>
<div class="codehilite"><pre><span></span><code>pub fn wat1() -&gt; impl Future + Send {
    let client = Client(Box::new(true));
    async move {
        match {let s = client.status(); s} {
            200 =&gt; {
                get().await;
            },
            _ =&gt; (),
        }
    }
}
</code></pre></div>



<a name="249177611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177611">(Aug 11 2021 at 22:25)</a>:</h4>
<p>Which I think is manually introducing a temporary scope there, roughly?</p>



<a name="249177687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177687">(Aug 11 2021 at 22:26)</a>:</h4>
<p>yeah, specifically the statement <code>let s = client.status();</code></p>



<a name="249177776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177776">(Aug 11 2021 at 22:27)</a>:</h4>
<p>Was it intentional that the scrutinee is not a temporary scope, or is that a bug that people started to rely on?</p>



<a name="249177937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249177937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249177937">(Aug 11 2021 at 22:29)</a>:</h4>
<p>I'm not 100% sure of the history here, but now discussions of new language sugar often define themselves in terms of <code>match</code> for this reason; it's a useful tool to have in your toolbox</p>



<a name="249178121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178121">(Aug 11 2021 at 22:31)</a>:</h4>
<p>Sounds good</p>



<a name="249178209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178209">(Aug 11 2021 at 22:32)</a>:</h4>
<p>By the time we get to <code>generator_interior.rs</code>, do we know what types implement <code>Drop</code>?</p>



<a name="249178212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178212">(Aug 11 2021 at 22:32)</a>:</h4>
<p><a href="https://github.com/rust-lang/rfcs/pull/2442#issuecomment-894682987">recent example</a> if you're interested</p>



<a name="249178345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178345">(Aug 11 2021 at 22:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.2357017/near/249178209">said</a>:</p>
<blockquote>
<p>By the time we get to <code>generator_interior.rs</code>, do we know what types implement <code>Drop</code>?</p>
</blockquote>
<p>for concrete types we can query for this information, I think. for generics we'll have to be conservative</p>



<a name="249178390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178390">(Aug 11 2021 at 22:34)</a>:</h4>
<p>Makes sense</p>



<a name="249178395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178395">(Aug 11 2021 at 22:34)</a>:</h4>
<p>I'm not sure if this was brought up before actually</p>



<a name="249178438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178438">(Aug 11 2021 at 22:34)</a>:</h4>
<p>but yeah I don't see a reason not to make things that should obviously work, work :-)</p>



<a name="249178603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178603">(Aug 11 2021 at 22:37)</a>:</h4>
<p>we can always be conservative and target <em>just</em> reference types for now</p>



<a name="249178627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178627">(Aug 11 2021 at 22:37)</a>:</h4>
<p>Oh yeah, because reference types never implement <code>Drop</code>?</p>



<a name="249178629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178629">(Aug 11 2021 at 22:37)</a>:</h4>
<p>(including <code>&amp;T</code> for generic types <code>T</code>, since it doesn't matter what <code>T</code> is)</p>



<a name="249178636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178636">(Aug 11 2021 at 22:37)</a>:</h4>
<p>yeah</p>



<a name="249178711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178711">(Aug 11 2021 at 22:38)</a>:</h4>
<p>I bet that would be a lot cheaper actually</p>



<a name="249178729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178729">(Aug 11 2021 at 22:38)</a>:</h4>
<p>Yeah, handling just reference types would probably cover a lot of the cases people are hitting so far.</p>



<a name="249178769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178769">(Aug 11 2021 at 22:38)</a>:</h4>
<p>yeah, that seems right to me</p>



<a name="249178779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178779">(Aug 11 2021 at 22:38)</a>:</h4>
<p>The hard part seems like writing a liveness pass rather than which types we support though</p>



<a name="249178797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178797">(Aug 11 2021 at 22:39)</a>:</h4>
<p>I think we have something like this for HIR already</p>



<a name="249178802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178802">(Aug 11 2021 at 22:39)</a>:</h4>
<p>niko showed me once</p>



<a name="249178814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178814">(Aug 11 2021 at 22:39)</a>:</h4>
<p>not sure if it's quite what you'd want or not</p>



<a name="249178827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178827">(Aug 11 2021 at 22:39)</a>:</h4>
<p>Going from reference types to any types seems like it's a matter of replace <code>if ty.is_reference_type()</code> with <code>if ty.has_destructor()</code></p>



<a name="249178838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178838">(Aug 11 2021 at 22:39)</a>:</h4>
<p>Is this the <code>ExprUseVisitor</code>?</p>



<a name="249178944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178944">(Aug 11 2021 at 22:40)</a>:</h4>
<p>I looked at it briefly when I first started looking at this bug, and it didn't seem like quite what we want, although maybe it will look different now that I understand the issues better.</p>



<a name="249178957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178957">(Aug 11 2021 at 22:41)</a>:</h4>
<p>that rings a bell</p>



<a name="249178978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249178978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249178978">(Aug 11 2021 at 22:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.2357017/near/249178827">said</a>:</p>
<blockquote>
<p>Going from reference types to any types seems like it's a matter of replace <code>if ty.is_reference_type()</code> with <code>if ty.has_destructor()</code></p>
</blockquote>
<p>oh, yeah we have a flag for this of course</p>



<a name="249179019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249179019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249179019">(Aug 11 2021 at 22:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.2357017/near/249178838">said</a>:</p>
<blockquote>
<p>Is this the <code>ExprUseVisitor</code>?</p>
</blockquote>
<p>there's also <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_passes/liveness/index.html"><code>rustc_passes::liveness</code></a></p>



<a name="249179085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249179085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249179085">(Aug 11 2021 at 22:42)</a>:</h4>
<p>those docs say AST but I see HIR types in the code</p>



<a name="249179088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249179088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249179088">(Aug 11 2021 at 22:42)</a>:</h4>
<p>Oh, that sounds more like what I want</p>



<a name="249389040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249389040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249389040">(Aug 13 2021 at 17:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/meeting.202021-08-13/near/249386035">said</a>:</p>
<blockquote>
<p>I'm still working on the generator capture issue. We talked some the other day. Liveness seems like the way to go. I was hoping to add a little extra to the existing liveness pass to track what's live across yields that we could use in <code>generator_interior.rs</code>, but unfortunately liveness happens after type checking.</p>
</blockquote>
<p>hmm, I'm wondering if the uses of typeck in here can all be replaced with conservative assumptions</p>



<a name="249389081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249389081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249389081">(Aug 13 2021 at 17:34)</a>:</h4>
<p>from a quick skim it wasn't obvious that all of them could, but it seemed like some of them could</p>



<a name="249389230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249389230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249389230">(Aug 13 2021 at 17:36)</a>:</h4>
<p>I'm thinking about making the code generic on the kind of information it has, not changing how existing uses work</p>



<a name="249389440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249389440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249389440">(Aug 13 2021 at 17:38)</a>:</h4>
<p>it seems like the alternative is writing a brand new pass, which might be better, I'm not sure</p>



<a name="249390074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249390074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249390074">(Aug 13 2021 at 17:43)</a>:</h4>
<p><code>generator_interior.rs</code> runs as part of type checking though, right?</p>



<a name="249390498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249390498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249390498">(Aug 13 2021 at 17:45)</a>:</h4>
<p>Or do you mean changing liveness to not require type checking first?</p>



<a name="249390864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249390864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249390864">(Aug 13 2021 at 17:48)</a>:</h4>
<p>My current thinking (and I don't love it) is to add a mini liveness pass that runs in <code>generator_interior::resolve_interior</code> that figures out what's live across yield points, and then uses the results of that to replace the scope tree liveness approximation in <code>InteriorVisitor::record</code>.</p>



<a name="249394179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249394179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249394179">(Aug 13 2021 at 18:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.2357017/near/249390498">said</a>:</p>
<blockquote>
<p>Or do you mean changing liveness to not require type checking first?</p>
</blockquote>
<p>that's what I meant, yes</p>



<a name="249394209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249394209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249394209">(Aug 13 2021 at 18:16)</a>:</h4>
<p>Ah, okay.</p>



<a name="249394214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249394214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249394214">(Aug 13 2021 at 18:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="421986">eholk</span> <a href="#narrow/stream/187312-wg-async-foundations/topic/.2357017/near/249390864">said</a>:</p>
<blockquote>
<p>My current thinking (and I don't love it) is to add a mini liveness pass that runs in <code>generator_interior::resolve_interior</code> that figures out what's live across yield points, and then uses the results of that to replace the scope tree liveness approximation in <code>InteriorVisitor::record</code>.</p>
</blockquote>
<p>this is what I meant by "brand new pass"</p>



<a name="249394318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249394318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249394318">(Aug 13 2021 at 18:17)</a>:</h4>
<p>I tried moving <code>typeck::check_crate(tcx)</code> after <code>misc_checking_2</code> yesterday and got a bunch of test failures, but I didn't look into them much yet.</p>



<a name="249394405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249394405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249394405">(Aug 13 2021 at 18:18)</a>:</h4>
<p>It actually looks like we could split out just liveness from <code>misc_checking_2</code> and bring that ahead of type checking.</p>



<a name="249394702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249394702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249394702">(Aug 13 2021 at 18:20)</a>:</h4>
<p>Anyway, at this point my goal is to find a way to ask "what variables are live across this expression," although potentially restricted to just yields.</p>



<a name="249420879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249420879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249420879">(Aug 13 2021 at 22:16)</a>:</h4>
<p>I was more thinking of making that liveness code reusable instead of writing a new pass from scratch</p>



<a name="249420907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249420907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249420907">(Aug 13 2021 at 22:16)</a>:</h4>
<p>than changing around existing stages, since I'm not sure what implications there are</p>



<a name="249420919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249420919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tmandry <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249420919">(Aug 13 2021 at 22:17)</a>:</h4>
<p>but it might be easier to start from scratch honestly</p>



<a name="249426147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249426147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249426147">(Aug 13 2021 at 23:38)</a>:</h4>
<p>Yeah, I could see either way.</p>



<a name="249426162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/249426162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#249426162">(Aug 13 2021 at 23:39)</a>:</h4>
<p>At the very least, I'm going to crib a lot from the existing liveness pass. It looks like there are a lot of small details in there that may be tricky to get right.</p>



<a name="250019128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250019128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250019128">(Aug 19 2021 at 17:32)</a>:</h4>
<p>So I've got some hacky code that starts to use liveness to figure out what values to capture in the generator: <a href="https://github.com/eholk/rust/tree/precise-generator-yield-captures">https://github.com/eholk/rust/tree/precise-generator-yield-captures</a></p>



<a name="250019592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250019592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250019592">(Aug 19 2021 at 17:36)</a>:</h4>
<p>This repurposes the existing <a href="http://liveness.rs">liveness.rs</a> pass, but I think what that pass needs and what our pass needs are enough different that we should probably write a separate pass.</p>



<a name="250019751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250019751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250019751">(Aug 19 2021 at 17:37)</a>:</h4>
<p>The existing pass only looks at bound variables (let bindings, parameters, captures, etc.), but it doesn't consider temporaries at all. I think temporaries matter for generators, especially if they have a destructor, so we don't want to ignore all of those.</p>



<a name="250019986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250019986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250019986">(Aug 19 2021 at 17:39)</a>:</h4>
<p>Also, since I made <code>typeck_results</code> optional in <a href="http://liveness.rs">liveness.rs</a>, it means we can't see captured variables (I'm guessing there's a way around this), but captures are pretty important to generators.</p>



<a name="250020764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250020764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250020764">(Aug 19 2021 at 17:44)</a>:</h4>
<p>Also, I'm pretty the following case should _not_ work, but I'm not sure.</p>
<div class="codehilite"><pre><span></span><code>    let g = move || {
        let client = Client;
        match status(&amp;client) {
            _status =&gt; yield,
        }
        status(&amp;client)
    };
    assert_send(g);
</code></pre></div>
<p>Here <code>Client</code> has <code>impl !Sync</code>, although maybe <code>Client</code> is still <code>Send</code> and therefore this example should work?</p>



<a name="250052574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250052574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250052574">(Aug 19 2021 at 21:36)</a>:</h4>
<p><span class="user-mention" data-user-id="421986">@eholk</span> btw you can use <a href="https://calendly.com/nikomatsakis">https://calendly.com/nikomatsakis</a> if you want to book some time to talk about this :)</p>



<a name="250052629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250052629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250052629">(Aug 19 2021 at 21:37)</a>:</h4>
<p>liveness is currently only used to report warnings, I'm a bit nervous about using it for something that is soundness-crucial</p>



<a name="250055967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250055967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250055967">(Aug 19 2021 at 22:13)</a>:</h4>
<p>Yeah, I think the existing liveness pass isn't what we want, but I think liveness as a concept would work well to solve this problem.</p>



<a name="250056071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250056071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250056071">(Aug 19 2021 at 22:14)</a>:</h4>
<p>On the bright side, we have a safety net in the MIR translation step, so if we do something unsound here we'll end up with an ICE in MIR generation. Not that we want to introduce more ICEs, but at least this should keep us from silently introducing soundness holes.</p>



<a name="250056182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250056182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250056182">(Aug 19 2021 at 22:15)</a>:</h4>
<p>The current liveness pass doesn't work for this case, from <code>addassign-yield.rs</code>:</p>
<div class="codehilite"><pre><span></span><code>    let _x = static || {
        let mut s = String::new();
        s += { yield; &quot;&quot; };
    };
</code></pre></div>



<a name="250056311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250056311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250056311">(Aug 19 2021 at 22:17)</a>:</h4>
<p>Although that may be because I had to neuter some of the liveness analysis around method calls since we didn't have enough type information available yet.</p>



<a name="250056492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/187312-wg-async/topic/%2357017/near/250056492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/187312-wg-async/topic/.2357017.html#250056492">(Aug 19 2021 at 22:19)</a>:</h4>
<p>Oh wait, no. That part only deals with functions that return <code>!</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>