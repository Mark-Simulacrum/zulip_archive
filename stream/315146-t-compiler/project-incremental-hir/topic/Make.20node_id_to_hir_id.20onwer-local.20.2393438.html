<html>
<head><meta charset="utf-8"><title>Make node_id_to_hir_id onwer-local #93438 · t-compiler/project-incremental-hir · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/index.html">t-compiler/project-incremental-hir</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html">Make node_id_to_hir_id onwer-local #93438</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270597348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270597348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270597348">(Feb 03 2022 at 18:42)</a>:</h4>
<p><span class="user-mention" data-user-id="248906">@cjgillot</span> <span class="user-mention" data-user-id="124288">@oli</span> <span class="user-mention" data-user-id="116009">@nikomatsakis</span> <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>



<a name="270597416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270597416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270597416">(Feb 03 2022 at 18:42)</a>:</h4>
<p>we've already seen a couple of benchmarks about this change</p>



<a name="270597435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270597435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270597435">(Feb 03 2022 at 18:42)</a>:</h4>
<p>there are 2 here <a href="https://github.com/rust-lang/rust/issues/93438">#93438</a></p>



<a name="270597674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270597674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270597674">(Feb 03 2022 at 18:44)</a>:</h4>
<p>one using <span class="user-mention" data-user-id="248906">@cjgillot</span> original changes, which uses <code>FxHashSet</code> result <a href="https://github.com/rust-lang/rust/pull/93438#issuecomment-1024811844">here</a>, another one using <code>VecMap</code> results <a href="https://github.com/rust-lang/rust/pull/93438#issuecomment-1027361293">here</a></p>



<a name="270597777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270597777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270597777">(Feb 03 2022 at 18:45)</a>:</h4>
<p>we've also tried <a href="https://github.com/rust-lang/rust/issues/93547">#93547</a> with a <code>BTreeMap</code> results <a href="https://github.com/rust-lang/rust/pull/93547#issuecomment-1027575913">here</a></p>



<a name="270597848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270597848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270597848">(Feb 03 2022 at 18:45)</a>:</h4>
<p>and <a href="https://github.com/rust-lang/rust/issues/93552">#93552</a> with a <code>SortedMap</code> results <a href="https://github.com/rust-lang/rust/pull/93552#issuecomment-1028168431">here</a></p>



<a name="270597945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270597945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270597945">(Feb 03 2022 at 18:46)</a>:</h4>
<p>we've discussed with <span class="user-mention" data-user-id="124288">@oli</span> to try with an <code>IndexVec</code>, unsure why we didn't that before :P</p>



<a name="270597976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270597976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270597976">(Feb 03 2022 at 18:46)</a>:</h4>
<p>and also Niko wanted to try something like ...</p>



<a name="270598038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270598038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270598038">(Feb 03 2022 at 18:47)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">const</span><span class="w"> </span><span class="n">N</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="n">MASK</span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">SparseVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">chunks</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Chunk</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Chunk</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">chunk_index</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">data</span>: <span class="p">[</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="n">N</span><span class="p">],</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">SparseVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">insert</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">index</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">data</span>: <span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">chunk_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">insert_chunk</span><span class="p">(</span><span class="n">chunk_index</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MASK</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">chunk</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">index</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">chunk_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">find_chunk</span><span class="p">(</span><span class="n">chunk_index</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">chunk</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">].</span><span class="n">as_ref</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">insert_chunk</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">chunk_index</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Chunk</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// FIXME: use a binary search and keep it sorted</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">chunks</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">chunk_index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">chunk_index</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">chunks</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">Chunk</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">chunk_index</span><span class="p">,</span><span class="w"> </span><span class="n">data</span>: <span class="nb">Default</span>::<span class="n">default</span><span class="p">()</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">chunks</span><span class="p">.</span><span class="n">last_mut</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">find_chunk</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">chunk_index</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">Chunk</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// FIXME: binary search</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">chunks</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">c</span><span class="o">|</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">chunk_index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">chunk_index</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="270598064"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270598064" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270598064">(Feb 03 2022 at 18:47)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> believes that it's not going to work out really well</p>



<a name="270598077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270598077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270598077">(Feb 03 2022 at 18:47)</a>:</h4>
<p>anyway, wanted to open this topic so we can all discuss in one place</p>



<a name="270622221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270622221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270622221">(Feb 03 2022 at 21:41)</a>:</h4>
<p>Can you maybe put summary table in the description of <a href="https://github.com/rust-lang/rust/issues/93438">#93438</a>, with each row holding a description of the experiment, a link to its commit, a link to its perf run, and the regression reported by perf?</p>



<a name="270622364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270622364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270622364">(Feb 03 2022 at 21:42)</a>:</h4>
<p>(i’m having a hard time from skimming the comment thread seeing what the individual experiments were.) Alterantively, I’d be happy with inline edits near where the perf runs were done that state what is the intended test.</p>



<a name="270713760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270713760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270713760">(Feb 04 2022 at 13:25)</a>:</h4>
<p>good idea <span class="user-mention" data-user-id="116083">@pnkfelix</span></p>



<a name="270713782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270713782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270713782">(Feb 04 2022 at 13:25)</a>:</h4>
<p>can place a table there</p>



<a name="270713850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270713850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270713850">(Feb 04 2022 at 13:25)</a>:</h4>
<p>also tried using an <code>IndexVec</code> results <a href="https://github.com/rust-lang/rust/pull/93438#issuecomment-1029575637">here</a></p>



<a name="270713930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270713930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270713930">(Feb 04 2022 at 13:26)</a>:</h4>
<p>insertions are too sparse for <code>IndexVec</code> to work correctly I guess</p>



<a name="270713952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270713952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270713952">(Feb 04 2022 at 13:26)</a>:</h4>
<p>so there is a ton of <code>None</code> padding</p>



<a name="270721300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721300">(Feb 04 2022 at 14:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/131828-t-compiler/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438/near/270598064">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="124288">oli</span> believes that it's not going to work out really well</p>
</blockquote>
<p>in what sense not well? not perform well?</p>



<a name="270721405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721405">(Feb 04 2022 at 14:23)</a>:</h4>
<p>I'd leave the answer up to Oli but if remember correctly he believes lookups are the problem</p>



<a name="270721455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721455">(Feb 04 2022 at 14:24)</a>:</h4>
<p>lookups here are still quite cheap</p>



<a name="270721464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721464">(Feb 04 2022 at 14:24)</a>:</h4>
<p>but yeah, it may not</p>



<a name="270721474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721474">(Feb 04 2022 at 14:24)</a>:</h4>
<p>that said</p>



<a name="270721480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721480">(Feb 04 2022 at 14:24)</a>:</h4>
<p>if lookups are the problem</p>



<a name="270721485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721485">(Feb 04 2022 at 14:24)</a>:</h4>
<p>but <code>IndexVec</code> perf seems to show that inserts are problematic</p>



<a name="270721491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721491">(Feb 04 2022 at 14:24)</a>:</h4>
<p>we could do the less sparse version</p>



<a name="270721510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721510">(Feb 04 2022 at 14:24)</a>:</h4>
<p>where you have a "prefilled vector"</p>



<a name="270721514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721514">(Feb 04 2022 at 14:24)</a>:</h4>
<p>I am thinking a bit</p>



<a name="270721582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721582">(Feb 04 2022 at 14:25)</a>:</h4>
<p>sorry, the less sparse version, to be explicit, is that you have a <code>Vec&lt;Option&lt;Chunk&gt;&gt;</code> for all the possible chunks</p>



<a name="270721624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721624">(Feb 04 2022 at 14:25)</a>:</h4>
<p>so that lookups are just 2 indices</p>



<a name="270721629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721629">(Feb 04 2022 at 14:25)</a>:</h4>
<p>and no searching</p>



<a name="270721647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721647">(Feb 04 2022 at 14:25)</a>:</h4>
<p>that said, <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> , maybe we can capture the access pattern?</p>



<a name="270721680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721680">(Feb 04 2022 at 14:25)</a>:</h4>
<p>e.g., print out "PUSH_HIR_OWNER" and "INSERT N" and "LOOKUP N" and "POP_HIR_OWNER" to a file</p>



<a name="270721682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721682">(Feb 04 2022 at 14:25)</a>:</h4>
<p>so we can analyze it?</p>



<a name="270721734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721734">(Feb 04 2022 at 14:26)</a>:</h4>
<p>I think there's a lot of fine details here that are worth looking at</p>



<a name="270721748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721748">(Feb 04 2022 at 14:26)</a>:</h4>
<p>(e.g., how compact are the ranges? etc)</p>



<a name="270721796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721796">(Feb 04 2022 at 14:26)</a>:</h4>
<p>right, makes sense</p>



<a name="270721876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270721876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270721876">(Feb 04 2022 at 14:27)</a>:</h4>
<p>Oli was mentioning something interesting, maybe there's a crate that has some extremely performant data structure for this</p>



<a name="270722094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722094">(Feb 04 2022 at 14:29)</a>:</h4>
<p>Could be</p>



<a name="270722106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722106">(Feb 04 2022 at 14:29)</a>:</h4>
<p>I mean there's only so many possibilities</p>



<a name="270722137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722137">(Feb 04 2022 at 14:29)</a>:</h4>
<p>but I think first we should have a good answer to the characteristics of our access patterns</p>



<a name="270722235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722235">(Feb 04 2022 at 14:30)</a>:</h4>
<p>the other option I'm pondering is if we can use some kind of cow setup</p>



<a name="270722258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722258">(Feb 04 2022 at 14:30)</a>:</h4>
<p>depends on how many things we access and how much they overlap</p>



<a name="270722263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722263">(Feb 04 2022 at 14:30)</a>:</h4>
<p>e.g. if we had a single huge array</p>



<a name="270722272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722272">(Feb 04 2022 at 14:31)</a>:</h4>
<p>but we keep a version number</p>



<a name="270722290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722290">(Feb 04 2022 at 14:31)</a>:</h4>
<p>so that you supply your current version when you insert/lookup</p>



<a name="270722296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722296">(Feb 04 2022 at 14:31)</a>:</h4>
<p>and it checks if that version matches</p>



<a name="270722306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722306">(Feb 04 2022 at 14:31)</a>:</h4>
<p>and makes it "appear" to be empty if not</p>



<a name="270722319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722319">(Feb 04 2022 at 14:31)</a>:</h4>
<p>(and presumably we save anything that gets overwritten and restore it when you "pop")</p>



<a name="270722331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722331">(Feb 04 2022 at 14:31)</a>:</h4>
<p>this could work very well especially if the accessed ranges are basically disjoint</p>



<a name="270722344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722344">(Feb 04 2022 at 14:31)</a>:</h4>
<p>though I guess we have the goal of being able to walk parts of the HIR independently</p>



<a name="270722403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722403">(Feb 04 2022 at 14:32)</a>:</h4>
<p>(side note, did we try ... just a huge vector? that ... might be fairly cheap)</p>



<a name="270722412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270722412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270722412">(Feb 04 2022 at 14:32)</a>:</h4>
<p>you do have to initialize it, but ...</p>



<a name="270723705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270723705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270723705">(Feb 04 2022 at 14:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/131828-t-compiler/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438/near/270722137">said</a>:</p>
<blockquote>
<p>but I think first we should have a good answer to the characteristics of our access patterns</p>
</blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span>, I can try to get that information first and then see</p>



<a name="270724041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270724041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270724041">(Feb 04 2022 at 14:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/131828-t-compiler/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438/near/270722403">said</a>:</p>
<blockquote>
<p>(side note, did we try ... just a huge vector? that ... might be fairly cheap)</p>
</blockquote>
<p>unsure what you meant but this structure is discarded at the end of <code>with_hir_id_owner</code></p>



<a name="270724067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270724067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270724067">(Feb 04 2022 at 14:46)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/93438/files#diff-ad0c15bbde97a607d4758ec7eaf88248be5d6b8ae084dfc84127f81e3f7a9bb4R453">https://github.com/rust-lang/rust/pull/93438/files#diff-ad0c15bbde97a607d4758ec7eaf88248be5d6b8ae084dfc84127f81e3f7a9bb4R453</a></p>



<a name="270724114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270724114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270724114">(Feb 04 2022 at 14:46)</a>:</h4>
<p>but in some sense we did with <code>IndexVec</code> and <code>VecMap</code></p>



<a name="270730600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270730600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270730600">(Feb 04 2022 at 15:34)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/131828-t-compiler/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438/near/270598064">said</a>:</p>
</blockquote>
<blockquote>
<p><span class="user-mention silent" data-user-id="124288">oli</span> believes that it's not going to work out really well</p>
</blockquote>
<p>in what sense not well? not perform well?</p>
<p>As far as I can tell from the ast node allocation, with enough macros involved ids can be horribly all over the place. Which is why I wanted to suggest to dump the maps at drop time and analyze them, but your idea of just dumping reads and writes is much better, as we can also see whether it helps to lazily doing some operations like shifting entire sections or allocating a bit of space before, not just after.</p>



<a name="270733377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270733377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270733377">(Feb 04 2022 at 15:54)</a>:</h4>
<blockquote>
<p>e.g. if we had a single huge array</p>
</blockquote>
<p>That's what we have right now, and versioning the entries unfortunately doesn't help, as our goal is to split lowering and thus repeat such datastructures in each query call. It may be entirely possible that splitting alone will get us more benefits than using a hashmap costs us. Or we introduce some global mutable map that we carefully check for validity via those versioning IDs or sth similar</p>



<a name="270733672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270733672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270733672">(Feb 04 2022 at 15:56)</a>:</h4>
<p>Or in the end we should just give up and go for salsa already <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="270735652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270735652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270735652">(Feb 04 2022 at 16:08)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> to migrate everything to Salsa <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>



<a name="270735892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270735892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270735892">(Feb 04 2022 at 16:10)</a>:</h4>
<p>Salsa doesn't yet support serialization and deserialization I believe.</p>



<a name="270736139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270736139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270736139">(Feb 04 2022 at 16:12)</a>:</h4>
<p>it was a joke <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> but I guess from what Niko have said and from what I could imagine ...</p>



<a name="270736178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270736178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270736178">(Feb 04 2022 at 16:12)</a>:</h4>
<p>if we were doing this for real, just because of a performance issue, we would hit way worser performance problems :)</p>



<a name="270736295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270736295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270736295">(Feb 04 2022 at 16:13)</a>:</h4>
<p>until they get fixed of course :)</p>



<a name="270737748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/270737748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Florian Diebold <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#270737748">(Feb 04 2022 at 16:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/131828-t-compiler/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438/near/270735892">said</a>:</p>
<blockquote>
<p>Salsa doesn't yet support serialization and deserialization I believe.</p>
</blockquote>
<p>some push to implement that would be nice though ;)</p>



<a name="271051472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271051472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271051472">(Feb 07 2022 at 22:20)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> made some dumps of access patterns of hir IDs during lowering. Mostly its lots of inserts, in order, few reads out of order (I didn't see any in the example dump), so we probably don't even need random access that much</p>



<a name="271444944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271444944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271444944">(Feb 10 2022 at 15:14)</a>:</h4>
<p>This topic was moved here from <a class="stream-topic" data-stream-id="131828" href="/#narrow/stream/131828-t-compiler/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438">#t-compiler &gt; Make node_id_to_hir_id onwer-local #93438</a> by <span class="user-mention silent" data-user-id="124288">oli</span></p>



<a name="271445514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271445514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271445514">(Feb 10 2022 at 15:17)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span> they are not strictly in order -- I think we want some "chunking" to allow for that, but yes, agreed that they are quite dominated by inserts that are mostly ascending</p>



<a name="271445733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271445733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271445733">(Feb 10 2022 at 15:18)</a>:</h4>
<p>one amusing thing we should dig into: are the values from the table ever read (except in the big iterations at the end)?</p>



<a name="271445843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271445843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271445843">(Feb 10 2022 at 15:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> is investigating, if we never read previous values, then we could move to multiple append-only lists that we don't even put all values in</p>



<a name="271445977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271445977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271445977">(Feb 10 2022 at 15:20)</a>:</h4>
<p>the docs on <code>lower_node_id</code> say that it can be called twice, but is it ever called twice on the same value?</p>



<a name="271446050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271446050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271446050">(Feb 10 2022 at 15:20)</a>:</h4>
<p>we have resolutions and resolution lookups, but those are way fewer values than all the values, as we just need to store definitions, not all ids</p>



<a name="271446301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271446301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271446301">(Feb 10 2022 at 15:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="124288">oli</span> <a href="#narrow/stream/315146-t-compiler.2Fproject-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438/near/271445733">said</a>:</p>
<blockquote>
<p>one amusing thing we should dig into: are the values from the table ever read (except in the big iterations at the end)?</p>
</blockquote>
<p>lol, this is a good point</p>



<a name="271447229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271447229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271447229">(Feb 10 2022 at 15:28)</a>:</h4>
<p>yeah, there are a lot of weird things like that</p>



<a name="271447370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271447370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271447370">(Feb 10 2022 at 15:29)</a>:</h4>
<p>I was telling <span class="user-mention" data-user-id="124288">@oli</span> I'm going to remove the ability to call <code>lower_node_id</code> twice but add an assert if you do and try to see if the compiler compiles, if it doesn't compile try to not call it twice and if it does, just remove the thing</p>



<a name="271447419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271447419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271447419">(Feb 10 2022 at 15:29)</a>:</h4>
<p>later today I should have time to gather better data but I've also figured that it would be good to properly set up my perf environment</p>



<a name="271493212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315146-t-compiler/project-incremental-hir/topic/Make%20node_id_to_hir_id%20onwer-local%20%2393438/near/271493212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315146-t-compiler/project-incremental-hir/topic/Make.20node_id_to_hir_id.20onwer-local.20.2393438.html#271493212">(Feb 10 2022 at 20:58)</a>:</h4>
<p>sounds good</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>