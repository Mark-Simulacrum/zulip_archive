<html>
<head><meta charset="utf-8"><title>Breaking change in de-duplicating manifests? · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Breaking.20change.20in.20de-duplicating.20manifests.3F.html">Breaking change in de-duplicating manifests?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="278722814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Breaking%20change%20in%20de-duplicating%20manifests%3F/near/278722814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Breaking.20change.20in.20de-duplicating.20manifests.3F.html#278722814">(Apr 12 2022 at 17:09)</a>:</h4>
<p>In <a href="https://github.com/rust-lang/rfcs/blob/master/text/2906-cargo-workspace-deduplicate.md">RFC 2906</a>, it talks about implicitly adding the version field to path dependencies.  For people leaving off the version field today, it will cause it to now be set.  This probably is fine for most cases but if a dev-dependency depends on something not published but doesn't explicitly call out <code>publish = false</code>, publishing will break.  I looked through the RFC and tracking issue discussions and didn't see this discussed at all.</p>
<p>Is this a concern or are we ok with this?</p>



<a name="278723069"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Breaking%20change%20in%20de-duplicating%20manifests%3F/near/278723069" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Breaking.20change.20in.20de-duplicating.20manifests.3F.html#278723069">(Apr 12 2022 at 17:11)</a>:</h4>
<p>On a only slightly related note, I'm still a bit unsure of the value of this behavior.  Superficially it seems helpful but when combined with <code>version.workspace = true</code> in the dependency, its going to force both to release all the time which is less than ideal but worse is this can get messy with circular dependencies via dev-dependencies.</p>



<a name="278723670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Breaking%20change%20in%20de-duplicating%20manifests%3F/near/278723670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Breaking.20change.20in.20de-duplicating.20manifests.3F.html#278723670">(Apr 12 2022 at 17:17)</a>:</h4>
<p>Actually, that made me realize this feature does break for users for the <code>publish = true</code> case as well.</p>
<p>Example crate: <code>clap_derive</code> used to own its own tests and would have a dev-dependency on <code>clap</code>.  <code>clap</code> exports <code>clap_derive</code>.  Both are published.  According to the RFC, <code>clap_derive</code> will implicitly get a <code>clap = { path = "..", version = "{clap.version}" }</code></p>
<p>Case 1: If <code>clap_derive</code> and <code>clap</code> use <code>version.workspace = true</code>, then when we bump <code>workspace.version</code>, <code>clap_derive</code> will point to the new <code>clap</code> but it won't be released yet and will fail the verification build that <code>cargo publish</code> does</p>
<p>Case 2: If we keep the versions independent, we'll break within <code>cargo-release</code> because it bumps all versions in a single commit before doing any <code>cargo publish</code>.  Again, <code>clap_derive</code> will have a dev-dependency on <code>clap</code> that doesn't exist and <code>cargo publish</code>s build will fail.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>