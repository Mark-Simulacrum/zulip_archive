<html>
<head><meta charset="utf-8"><title>benchmarking · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html">benchmarking</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="255664282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255664282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255664282">(Sep 30 2021 at 23:16)</a>:</h4>
<p>I have basic resolver benchmarking working:</p>
<div class="codehilite"><pre><span></span><code>resolve_ws/empty        time:   [343.20 us 344.65 us 346.11 us]
resolve_ws/toml-rs      time:   [5.2462 ms 5.3742 ms 5.5166 ms]
resolve_ws/cargo        time:   [65.070 ms 65.563 ms 66.052 ms]
resolve_ws/rust         time:   [235.68 ms 237.31 ms 239.04 ms]
resolve_ws/gecko-dev    time:   [341.92 ms 346.19 ms 351.11 ms]
resolve_ws/tikv         time:   [376.43 ms 379.93 ms 384.06 ms]
resolve_ws/diem         time:   [393.93 ms 395.52 ms 397.08 ms]
resolve_ws/substrate    time:   [575.69 ms 577.35 ms 579.07 ms]
resolve_ws/servo        time:   [690.91 ms 699.96 ms 710.48 ms]
</code></pre></div>
<p>It is curious that servo is so much slower than firefox or substrate, which have substantially more packages.</p>



<a name="255706085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255706085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255706085">(Oct 01 2021 at 08:07)</a>:</h4>
<p>What's the root crate for servo?</p>



<a name="255774586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255774586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255774586">(Oct 01 2021 at 16:54)</a>:</h4>
<p>It is a virtual workspace with 74 members.</p>



<a name="255774737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255774737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255774737">(Oct 01 2021 at 16:55)</a>:</h4>
<p>Servo currently has 663 packages, substrate has 952.</p>



<a name="255793130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255793130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255793130">(Oct 01 2021 at 19:09)</a>:</h4>
<p>I'm wondering if there's some scaling issue present, where perhaps servo has a different branching factor at some level where we don't scale linearly.</p>



<a name="255793161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255793161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255793161">(Oct 01 2021 at 19:09)</a>:</h4>
<p>What's the next biggest virtual workspace?</p>



<a name="255793658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255793658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255793658">(Oct 01 2021 at 19:13)</a>:</h4>
<p>These are wonderful questions to look at after we have a benchmarking system set up. Lets not delay getting measurements on understanding them. (Unless that is what Eric would find Fun, then don't let me stop you!)</p>



<a name="255794544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255794544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255794544">(Oct 01 2021 at 19:20)</a>:</h4>
<p>(Agreed, and none of that was meant to be a delay on the benchmarking infrastructure.)</p>



<a name="255798588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255798588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255798588">(Oct 01 2021 at 19:53)</a>:</h4>
<p>hah, no worries, I wasn't going to dig into it. I just found it curious.</p>
<p>Here are the workspace sizes:</p>
<p>1 empty  <br>
14 toml-rs  <br>
165 cargo  <br>
513 rust  <br>
521 tikv  <br>
570 gecko-dev  <br>
663 servo  <br>
740 diem  <br>
952 substrate</p>



<a name="255798675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255798675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255798675">(Oct 01 2021 at 19:54)</a>:</h4>
<p>The main concern was whether or not the benchmark was working correctly, but I think it is.</p>



<a name="255801384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255801384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255801384">(Oct 01 2021 at 20:14)</a>:</h4>
<p><span class="user-mention" data-user-id="120518">@Eric Huss</span> How many projects are in the top-level workspace, vs pulled in via dependencies?</p>



<a name="255801706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255801706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255801706">(Oct 01 2021 at 20:17)</a>:</h4>
<p>This is the number of members:</p>
<p>1 cargo<br>
1 empty<br>
2 toml-rs<br>
66 tikv<br>
72 gecko-dev<br>
74 servo<br>
115 rust<br>
189 diem<br>
216 substrate</p>



<a name="255990281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255990281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255990281">(Oct 04 2021 at 00:12)</a>:</h4>
<p>Huh, interesting. That <em>really</em> makes me wonder what's up with servo then, yeah.</p>



<a name="255990288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255990288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255990288">(Oct 04 2021 at 00:12)</a>:</h4>
<p>That'll be fun to profile in the future.</p>



<a name="255990291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/255990291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#255990291">(Oct 04 2021 at 00:12)</a>:</h4>
<p>Thanks for working on the benchmarks!</p>



<a name="256476718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/256476718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#256476718">(Oct 06 2021 at 20:12)</a>:</h4>
<p>I'm struggling to figure out how to have an expensive setup function that only runs once when the benchmark is run. In our case, we have a group <code>resolve_ws</code> with several bench functions (<code>cargo</code>, <code>tikv</code>, <code>servo</code>, etc.). I want to prepare the workspace once for each bench function, and then have criterion run the iterator repeatedly. However, that does not appear to be the way criterion works. It seems to run the entire bunch function multiple times based on whatever rules it has.</p>
<p>I see <a href="https://github.com/bheisler/criterion.rs/issues/514">https://github.com/bheisler/criterion.rs/issues/514</a> which implies it is not possible. I've tried using <a href="https://docs.rs/criterion/0.3.5/criterion/struct.Bencher.html#method.iter_batched"><code>iter_batched</code></a>, but that doesn't help even though it claims to be made for this case.</p>
<p>Anyone have any ideas about that? I feel like I really don't understand how criterion works.</p>



<a name="256478600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/256478600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#256478600">(Oct 06 2021 at 20:26)</a>:</h4>
<p><code>iter_batched</code> is for a slightly different case. It is for when you don't want to time the set up code. Where as you don't want to run the set up code.</p>



<a name="256478827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/256478827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#256478827">(Oct 06 2021 at 20:28)</a>:</h4>
<p>How big is the overhead of setting up the workspace more often?</p>



<a name="256479497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/256479497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#256479497">(Oct 06 2021 at 20:32)</a>:</h4>
<p>Oh I thought setup was basically "do it outside the <code>iter</code> closure"?</p>



<a name="256479549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/256479549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#256479549">(Oct 06 2021 at 20:33)</a>:</h4>
<p>oh but you probably want per-iteration setup that isn't timed</p>



<a name="256480311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/256480311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#256480311">(Oct 06 2021 at 20:38)</a>:</h4>
<p>Hm, I'm looking more closely, I think I was confused, and it does seem to be working mostly how I expect.  I'm still trying to figure out how it decides the batch size automatically, since it often ends up with a batch of 1 which seems unnecessary.</p>



<a name="256480658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/256480658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#256480658">(Oct 06 2021 at 20:41)</a>:</h4>
<p>there is <a href="https://docs.rs/criterion/0.3.5/criterion/enum.BatchSize.html">https://docs.rs/criterion/0.3.5/criterion/enum.BatchSize.html</a> witch is one piece of the puzzle</p>



<a name="256480904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/benchmarking/near/256480904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/benchmarking.html#256480904">(Oct 06 2021 at 20:43)</a>:</h4>
<p>Yea, I was thinking about using <code>NumIterations</code>, though there seem to be plenty of warnings telling you not to do that.   I'm still trying to figure out what the warmup does, since I'm guessing that is how it decides how to batch things.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>