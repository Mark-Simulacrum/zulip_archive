<html>
<head><meta charset="utf-8"><title>RFC 3013: Checking conditional compilation at compile time · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html">RFC 3013: Checking conditional compilation at compile time</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274199017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274199017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274199017">(Mar 04 2022 at 22:47)</a>:</h4>
<p>Hi, I have been working for the last few weeks on <a href="https://github.com/rust-lang/rfcs/pull/3013">RFC 3013: Checking conditional compilation at compile time</a>. I have made good progress on the <code>rustc</code> and <code>rustdoc</code> side but I'm starting to have some trouble going forward.<br>
These struggle are all related to the <code>cargo</code> integration. Unfortunately or fortunately depending on your side didn't the RFC was primarily focus on the <code>rustc</code> side and only talked a bit about the <code>cargo</code> integration. The only thing where the RFC was clear about <code>cargo</code> is : "[..] it seems uncontroversial for Cargo to enable checking for feature = "..." values immediately [..]" which I implemented as an unstable option <a href="https://github.com/rust-lang/cargo/pull/10408"><code>-Z check-cfg-features</code></a>.<br>
But the RFC and I would like for conditional compilation checking to be enable by <strong>default</strong> for all <strong>well known names</strong> (values shouldn't be a problem), this requires some mechanism to deal with custom/external cfg, those are as fart as I know never known by <code>cargo</code>.  I have been thinking about it some the last week and I have to proposition for which I would like your input:</p>
<ul>
<li>
<ol>
<li>Enable it by default for all package, provide a way to disable well known names checking and have a way to set them with <code>build.rs</code> but we don't do anything to cover other names</li>
</ol>
</li>
<li>
<ol start="2">
<li>Or enable it by default for all package, provide a way to set them with <code>build.rs</code> and have a configuration inside <code>Cargo.toml</code> to set extra cfg. This is a draft of syntax that could be used:</li>
</ol>
</li>
</ul>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span><span class="w"></span>
<span class="c1"># ...</span><span class="w"></span>

<span class="p">[</span><span class="n">check-cfg</span><span class="p">]</span><span class="w"> </span><span class="c1"># or [package.check-cfg] ?</span><span class="w"></span>
<span class="n">well-known</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">true</span><span class="w">   </span><span class="c1"># this only and exclusively control the names() part</span><span class="w"></span>
<span class="w">                    </span><span class="c1"># aka as the well-known names (or values, maybe) in rustc</span><span class="w"></span>
<span class="w">                    </span><span class="c1"># this default to true</span><span class="w"></span>
<span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"no_global_oom_handling"</span><span class="p">]</span><span class="w"> </span><span class="c1"># this is the names(...) part, this</span><span class="w"></span>
<span class="w">                                   </span><span class="c1"># only check the name part of the cfg</span><span class="w"></span>
<span class="w">                                   </span><span class="c1"># and never the value of it (except if</span><span class="w"></span>
<span class="w">                                   </span><span class="c1"># defined below in values, or by cmd)</span><span class="w"></span>

<span class="p">[[</span><span class="n">check-cfg</span><span class="p">.</span><span class="n">values</span><span class="p">]]</span><span class="w"> </span><span class="c1"># this is the values(...) part</span><span class="w"></span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"use_libc"</span><span class="w"> </span><span class="c1"># this is not equivalent to just putting the name in</span><span class="w"></span>
<span class="w">                  </span><span class="c1"># package.cfg.check.names as this defines an implicit</span><span class="w"></span>
<span class="w">                  </span><span class="c1"># values = [], meaning that no values are allowed</span><span class="w"></span>

<span class="k">[[check-cfg.values]]</span><span class="w"></span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"feature"</span><span class="w">         </span><span class="c1"># feature will be automatically set by cargo, but</span><span class="w"></span>
<span class="w">                         </span><span class="c1"># could still be extented</span><span class="w"></span>
<span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"foo"</span><span class="p">,</span><span class="w"> </span><span class="s">"bar"</span><span class="p">]</span><span class="w"></span>
</code></pre></div>
<p>I personally thinks that option 2 is too involved and I'm leaning for option 1 which is simpler and straight forward.<br>
What are your input on this ?</p>



<a name="274454090"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274454090" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274454090">(Mar 07 2022 at 20:41)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="239881">@Josh Triplett</span> <span class="user-mention" data-user-id="120518">@Eric Huss</span> <span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span></p>



<a name="274454625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274454625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274454625">(Mar 07 2022 at 20:45)</a>:</h4>
<p>My first inclination would be to check things like features by default, but require an opt in to check things that can be set programmatically from <a href="http://build.rs">build.rs</a>.</p>



<a name="274454785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274454785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274454785">(Mar 07 2022 at 20:47)</a>:</h4>
<p>And all else being equal, I would prefer to enumerate possible programmatically set cfg values in Cargo.toml, but before even doing that, I think we could just check features and anything else that isn't programmatically settable from <a href="http://build.rs">build.rs</a> and that will get us the vast majority of the benefit.</p>



<a name="274455094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455094">(Mar 07 2022 at 20:49)</a>:</h4>
<p>The one other case that seems likely to be worth catching is when people write <code>cfg(xyz)</code> where they meant to write <code>cfg(feature = "xyz")</code>. Long-term, I wonder if we could handle that by changing the syntax of the former for the <a href="http://build.rs">build.rs</a> case to be something more specific to user-set cfg values, over an edition boundary.</p>



<a name="274455155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455155">(Mar 07 2022 at 20:50)</a>:</h4>
<p>Okay, and how would you want to deal with projects that don't use <code>build.rs</code> but still have custom cfg ?<br>
Having an option in the <code>Cargo.toml</code>to disable it ?</p>



<a name="274455207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455207">(Mar 07 2022 at 20:50)</a>:</h4>
<p>(e.g. if the former needed <code>cfg(something = "xyz")</code> then the two would be harder to mix up.)</p>



<a name="274455240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455240">(Mar 07 2022 at 20:50)</a>:</h4>
<p>What do you mean by "custom cfg" exactly?</p>



<a name="274455284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455284">(Mar 07 2022 at 20:50)</a>:</h4>
<p>cfg set on the rustc command line but not as a feature?</p>



<a name="274455325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455325">(Mar 07 2022 at 20:51)</a>:</h4>
<p>Crossbeam have <code>crossbeam_loom</code>, that they only set with <code>--cfg</code></p>



<a name="274455418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455418">(Mar 07 2022 at 20:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time/near/274455284">said</a>:</p>
<blockquote>
<p>cfg set on the rustc command line but not as a feature?</p>
</blockquote>
<p>Yes. I'm talking about this.</p>



<a name="274455564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455564">(Mar 07 2022 at 20:53)</a>:</h4>
<p>The feature case is already handle by <code>-Z check-cfg-features</code> on cargo.</p>



<a name="274455704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455704">(Mar 07 2022 at 20:54)</a>:</h4>
<p>I think that one should be opt-in.</p>



<a name="274455795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455795">(Mar 07 2022 at 20:55)</a>:</h4>
<p>Features can be opt out, because we know the complete list of features from the cargo manifest.</p>



<a name="274455854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455854">(Mar 07 2022 at 20:56)</a>:</h4>
<p>cfg we don't, and we can only check if the crate gives us a list. So I think we add an opt-in mechanism, enabled by supplying that list in the cargo manifest.</p>



<a name="274455943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274455943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274455943">(Mar 07 2022 at 20:56)</a>:</h4>
<p>(Or on the rustc command line directly, using the same underlying mechanism that cargo uses to pass the list from the manifest. Since people can always invoke rustc directly without using cargo.)</p>



<a name="274456437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274456437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274456437">(Mar 07 2022 at 21:00)</a>:</h4>
<p>That seems unfortunate, as the vast majority of them don't use any custom cfg.</p>



<a name="274456575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274456575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274456575">(Mar 07 2022 at 21:00)</a>:</h4>
<p>In that case what do you think about my draft of syntax ?</p>



<a name="274464978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274464978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274464978">(Mar 07 2022 at 22:04)</a>:</h4>
<p>Seems potentially reasonable, for a mechanism to opt in. I would be interested to hear what you think such a mechanism should look like if we consider the possibility of modifying custom cfg syntax in a future edition to make it feasible to check non-custom cfg by default.</p>



<a name="274466115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274466115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274466115">(Mar 07 2022 at 22:14)</a>:</h4>
<p>You mean like requiring that every <code>--cfg</code> name and value are always passed as part of at least one <code>--check-cfg</code> argument ?<br>
Ex: if I use <code>--cfg my_cfg</code> then I obliged by the compiler to also give the corresponding <code>--check-cfg=names(my_cfg)</code> ?</p>



<a name="274467140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274467140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274467140">(Mar 07 2022 at 22:20)</a>:</h4>
<p>If that's what you're referring to then I think that we should also consider disallowing the state: We know all the cfg names but not if they values or not. Ie always requiring <code>--check-cfg=values()</code> and forbidding <code>--check-cfg=names()</code>.</p>



<a name="274467330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274467330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274467330">(Mar 07 2022 at 22:22)</a>:</h4>
<p>That way the syntax could be made simpler by not having to make the distinction between <em>name without values</em> and <em>name with values</em>.</p>



<a name="274472136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274472136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274472136">(Mar 07 2022 at 23:06)</a>:</h4>
<p><span class="user-mention" data-user-id="327095">@Urgau</span> No, what I meant was that we could move user-defined cfg from <code>cfg(xyz)</code> to <code>cfg(user::xyz)</code> or similar, which would then mean that we can check every top-level <code>cfg(xyz)</code> by default.</p>



<a name="274472167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274472167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274472167">(Mar 07 2022 at 23:06)</a>:</h4>
<p>We could, perhaps, at the same time, require declaring every <code>cfg(user::xyz)</code> in advance, but we wouldn't <em>have</em> to do that.</p>



<a name="274472653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274472653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274472653">(Mar 07 2022 at 23:11)</a>:</h4>
<p>Oh, I see. You want to have a concept of "namespace" but for cfg.</p>



<a name="274472832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274472832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274472832">(Mar 07 2022 at 23:13)</a>:</h4>
<p>But how would be handle thing like <code>debug_assertions</code> ? or <code>miri</code> ?<br>
Would they still be passed by <code>--cfg</code> ? But with an explicit <code>--check-cfg=names()</code> ?</p>



<a name="274473360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274473360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274473360">(Mar 07 2022 at 23:19)</a>:</h4>
<p>Anyway, having this sort of name spacing would certainly help the checking of them. As we could enable them you for some namespace and not the other. In term of syntax I don't know how It would look like, probably not that different from my draft.</p>



<a name="274473364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274473364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274473364">(Mar 07 2022 at 23:19)</a>:</h4>
<p>Debug assertions are controlled by -Cdebug-assertions, not --cfg.</p>



<a name="274473601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274473601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274473601">(Mar 07 2022 at 23:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time/near/274473364">said</a>:</p>
<blockquote>
<p>Debug assertions are controlled by -Cdebug-assertions, not --cfg.</p>
</blockquote>
<p>Yeah, but nothing prevents you from manually doing this: <code>rustc -Copt-level=3 --cfg=debug_assertions a.rs</code>.</p>



<a name="274473640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274473640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274473640">(Mar 07 2022 at 23:22)</a>:</h4>
<p>I expect it won't have the full effect that way</p>



<a name="274479725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274479725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274479725">(Mar 08 2022 at 00:31)</a>:</h4>
<p><span class="user-mention" data-user-id="327095">@Urgau</span> Anything that's well-known and defined by the compiler would remain in the top-level namespace and be something checked.</p>



<a name="274479731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274479731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274479731">(Mar 08 2022 at 00:31)</a>:</h4>
<p><code>cfg(doc)</code> for instance.</p>



<a name="274479789"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274479789" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274479789">(Mar 08 2022 at 00:32)</a>:</h4>
<p>Or <code>cfg(miri)</code>.</p>



<a name="274513708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274513708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274513708">(Mar 08 2022 at 09:15)</a>:</h4>
<p>That's could work pretty well.</p>



<a name="274513827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274513827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274513827">(Mar 08 2022 at 09:16)</a>:</h4>
<p>Btw <code>miri</code> is not currently a well known name, because it's not set by <code>rustc</code>. Should it be added ?</p>



<a name="274579527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274579527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274579527">(Mar 08 2022 at 18:00)</a>:</h4>
<p>I think it should, yes.</p>



<a name="274579570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274579570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274579570">(Mar 08 2022 at 18:00)</a>:</h4>
<p>Anything set (or settable) by an official Rust tool shipped by rustup.</p>



<a name="274589445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274589445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274589445">(Mar 08 2022 at 19:03)</a>:</h4>
<p>Miri is a nightly-only tool though.</p>



<a name="274589829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/274589829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#274589829">(Mar 08 2022 at 19:05)</a>:</h4>
<p>The current list well known names and values includes every cfg that <code>rustc</code> or <code>rustdoc</code> sets not matter if they are nightly or not.<br>
I will open a PR to add it to list.</p>



<a name="275978138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/275978138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#275978138">(Mar 20 2022 at 17:27)</a>:</h4>
<p>I've created a <a href="https://github.com/rust-lang/cargo/pull/10486">PR</a> adding <code>-Z check-cfg-well-known-{names,values}</code> to be able to check the well known names and values. <span class="user-mention" data-user-id="239881">@Josh Triplett</span> Do you have an opinion on it ? Does it seems to be a good (intermediate ?) way forward ?</p>



<a name="275984211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/275984211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#275984211">(Mar 20 2022 at 19:43)</a>:</h4>
<p>Can you link to more information on the <code>names()</code> and <code>values()</code> arguments to rustc's option?</p>



<a name="275987057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/275987057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#275987057">(Mar 20 2022 at 20:51)</a>:</h4>
<p>I added a section on the unstable book: <a href="https://doc.rust-lang.org/nightly/unstable-book/compiler-flags/check-cfg.html#the-names-form">https://doc.rust-lang.org/nightly/unstable-book/compiler-flags/check-cfg.html#the-names-form</a> but <code>values()</code> is not yet in there but it's basically the same as <code>names()</code> which is the way to enable well known names checking of conditional compilation name and <code>values</code> is the way to enable well known values checking of conditional compilation value.</p>



<a name="276549875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/276549875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#276549875">(Mar 24 2022 at 22:56)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I don't if you saw it but I left a pretty long reply on the cargo PR that may interest you: <a href="https://github.com/rust-lang/cargo/pull/10486#issuecomment-1074496055">https://github.com/rust-lang/cargo/pull/10486#issuecomment-1074496055</a></p>



<a name="278427302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RFC%203013%3A%20Checking%20conditional%20compilation%20at%20compile%20time/near/278427302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Urgau <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RFC.203013.3A.20Checking.20conditional.20compilation.20at.20compile.20time.html#278427302">(Apr 09 2022 at 19:49)</a>:</h4>
<p>I've opened <a href="https://github.com/rust-lang/cargo/pull/10539">https://github.com/rust-lang/cargo/pull/10539</a> to add <code>cargo:rustc-check-cfg</code> as a build script output.<br>
It was noticed that we where missing it when bumping to beta 1.61 on rust.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>