<html>
<head><meta charset="utf-8"><title>Defaults for faster compilation of &quot;for host&quot; units · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html">Defaults for faster compilation of &quot;for host&quot; units</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275241014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275241014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275241014">(Mar 14 2022 at 14:12)</a>:</h4>
<p>Hello everyone,</p>
<p>We've recently been looking at how <a href="https://blog.rust-lang.org/inside-rust/2022/02/22/compiler-team-ambitions-2022.html#faster-builds-initiatives--%EF%B8%8F">compile times look in practice</a> across a wider slice of the ecosystem. Looking at cargo schedules, it seems there are quite a few projects where build scripts, proc-macros, and their dependencies are on the critical path, and the reason why I'm opening this thread: to discuss the default settings used to build the "for host" nodes.</p>
<p>There were already great insights about these a few years ago: cargo focuses on fast compile times rather than raw throughput of the built artifacts, leading to the current defaults for build dependencies (for the people following at home: <a href="https://doc.rust-lang.org/cargo/reference/profiles.html#build-dependencies">no optimizations, no limits on CGUs</a>). These defaults merge with the other profile defaults, leading to the additional settings that the <code>dev</code>profile brings: debuginfo at level 2, and incremental turned on.</p>
<p>To illustrate my proposal, I'll take building <code>syn-1.0.86</code>locally as an example: It's present in so many projects using proc-macros that any improvement will be noticeable across the whole ecosystem (which is also why I've experimented with prioritizing it in the build schedules with interesting results that I've discussed with eh2406, so more about that in the future -- or just tried to remove its and <code>proc-macro2</code>'s build scripts altogether, with most of the same effect).</p>
<p>I'd like to specifically discuss these in the <code>dev</code> profile:</p>
<ul>
<li><code>-Cdebuginfo=2</code>: is this removable ? I myself have never tried running a build script or proc-macro in a debugger (and I'd suspect the latter to be hindered by the proc macro bridge + rustc execution model) but that would impact backtraces and lineinfo, if panics happen (though I'm not sure how compile errors generated by panicking proc-macros look under a different debuginfo level). On <code>syn</code>, this improves from scratch debug builds by 13% or so.</li>
<li><code>-Cincremental</code>: this looks removable. Incremental compilation is a 30%-50% pessimization, that is amortized by building things more than once. Build dependencies are most likely only built once. I've now noticed this is already tracked in <a href="https://github.com/rust-lang/cargo/issues/8545">this cargo issue</a> about build scripts: it would improve build scripts, but they are usually small so the absolute improvements would also be small. proc-macros and their dependencies on the other hand, especially on the critical path, would see noticeable effects. On <code>syn</code>, this also improves from scratch debug builds by 12% or so.</li>
<li><code>-Cstrip=debuginfo</code>: on the targets where the linker is aware of this (rather than stripping after the fact) this is also a slight win (on <code>syn</code>s build script only, it's around 10%, and on the whole crate it's like 1%). This one could arguably be added to the <code>release</code> profile as well if for some reason we wanted to be as aggressive as possible, but it's probably slightly better but within noise in release builds of <code>syn</code>.</li>
</ul>
<p>Overall with these three on <code>syn</code>, we have <code>cargo check</code>s improved by 13%, and by 17% when all its features are toggled on; <code>cargo build</code>s by 27% and 35%, respectively. These numbers are only an informative proxy of realistic use in a different context, and mostly to illustrate the effect each setting has, so I've tried to validate them in the real world: </p>
<ul>
<li>since this is quite simple to try, I've made <a href="https://github.com/lqd/cargo/commit/f6cfe00baa8bb06bc83bc735e3e7a9ff9bc75d1c">a prototype of this</a></li>
<li>did a <a href="https://github.com/rust-lang/rust/pull/94851">perf.rlo run</a> to "ensure" there are no surprising regressions (but perf.rlo itself only tracks leaf crates build times in most situations)</li>
<li>and <a href="https://lqd.github.io/rustc-benchmarking-data/experiments/cargo-build-defaults/">benchmarked it locally</a> over our extended set of crates, with check and debug builds. There's a readme in there with more info, simple summaries and hyperfine results for each crate. (Note that these benchmarks were done with the slightly more aggressive "symbols" stripping, but it seems more sensible to only strip "debuginfo" in the odd case a panic happens. That's a 1% improvement at best anyways. I have not measured stripping in release builds either)</li>
</ul>
<p>These wins seem to indeed translate to real world uses. In the cases we're interested in, heavy build dependencies on the critical path, that is quite noticeable: a lot of nice improvements with a tight confidence interval, both for <a href="https://lqd.github.io/rustc-benchmarking-data/experiments/cargo-build-defaults/summary-check-j12-improvements.txt">check builds</a> and <a href="https://lqd.github.io/rustc-benchmarking-data/experiments/cargo-build-defaults/summary-build-j8-improvements.txt">debug builds</a>. The regressions are smaller in magnitude and with a wide confidence interval: there are a few super short benchmarks (20-30% of all the crates), making variance in timing more impactful in their results (both improvements and regressions). That looks like an improvement to me.</p>
<p>These just being the default values means they're easily overridable by users, and documentation would be needed to show which settings to choose for maximum debuggability of build dependencies when needed, rather than fastest compile times. I believe all of the above is achievable today by individual crates, by overriding the <code>dev</code> build profile (and if anyone reading this is interested, it's <a href="https://gist.github.com/lqd/cb65b8582cd213bb901502093089ec72">as simple as that</a>), and an alternative could be to just document that without changing the defaults. I'd probably prefer these defaults as the "pit of success" for the common cases and faster compiles, but could have easily missed important use-cases making this change unacceptable.</p>
<p>What do you all think ?</p>



<a name="275241500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275241500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275241500">(Mar 14 2022 at 14:16)</a>:</h4>
<p>Incremental compilation is disabled for non-local dependencies already.</p>



<a name="275241648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275241648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275241648">(Mar 14 2022 at 14:17)</a>:</h4>
<p>As for debuginfo maybe switch to <code>-Cdebuginfo=1</code> for build dependencies by default?</p>



<a name="275242063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275242063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275242063">(Mar 14 2022 at 14:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units/near/275241500">said</a>:</p>
<blockquote>
<p>Incremental compilation is disabled for non-local dependencies already.</p>
</blockquote>
<p>ah maybe, in that case the improvements are mostly from the build script ?</p>



<a name="275242149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275242149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275242149">(Mar 14 2022 at 14:20)</a>:</h4>
<p>Most changes come from disabling debuginfo I think.</p>



<a name="275242369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275242369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275242369">(Mar 14 2022 at 14:22)</a>:</h4>
<p>could be, yeah. compounding over many nodes in the schedules</p>



<a name="275242749"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275242749" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275242749">(Mar 14 2022 at 14:24)</a>:</h4>
<p>in any case, these nodes are all bottlenecks and any improvement becomes significant</p>



<a name="275243426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275243426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275243426">(Mar 14 2022 at 14:29)</a>:</h4>
<p>(and I'd also like to see numbers for these using cg_clif <span class="user-mention" data-user-id="133247">@bjorn3</span> if that's already testable :)</p>



<a name="275244874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275244874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275244874">(Mar 14 2022 at 14:40)</a>:</h4>
<p>Yes, cg_clif is more than complete enough. It has supported proc-macros for a long time now.</p>



<a name="275245024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275245024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275245024">(Mar 14 2022 at 14:41)</a>:</h4>
<p>great</p>



<a name="275245118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275245118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275245118">(Mar 14 2022 at 14:42)</a>:</h4>
<p>You can build it from source or download a prebuilt version from <a href="https://github.com/bjorn3/rustc_codegen_cranelift/actions/runs/1980357175">https://github.com/bjorn3/rustc_codegen_cranelift/actions/runs/1980357175</a> The build directory contains a cargo-clif executable you can use in the place of cargo. It invokes cargo in such a way that cg_clif is used.</p>



<a name="275245796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275245796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275245796">(Mar 14 2022 at 14:47)</a>:</h4>
<p>nice, thank you. <br>
I remember your benchmarks where build times were improved over cg_llvm for debug builds, and run times a bit lower, the cool thing is the latter shouldn't matter much for the build dependencies, so it could be interesting to see the effect here. I'll have to look into that, and will let you know if there are interesting results.</p>



<a name="275246294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275246294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275246294">(Mar 14 2022 at 14:51)</a>:</h4>
<p>One thing to be aware if is that I haven't yet implemented parallel compilation, so while the user time is lower, the wall time may be a bit higher if only a single crate is being compiled. If multiple dependencies are being compiled at the same time cg_clif is likely to finish ~30% earlier than cg_llvm.</p>



<a name="275252976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275252976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275252976">(Mar 14 2022 at 15:33)</a>:</h4>
<p><span class="user-mention" data-user-id="116113">@lqd</span> I would love to see those changes by default in the profile used to build dependencies.</p>



<a name="275253220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275253220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275253220">(Mar 14 2022 at 15:35)</a>:</h4>
<p>In build-override, specifically, not in the base dev profile.</p>



<a name="275253362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275253362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275253362">(Mar 14 2022 at 15:36)</a>:</h4>
<p>I don't know if the team has regular meetings and nominations ?  Would you say I should just open a PR ?</p>



<a name="275253722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275253722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275253722">(Mar 14 2022 at 15:38)</a>:</h4>
<p>We have weekly meetings. If the change is just a couple of lines to the default build override (and the docs), go ahead and send a PR (including the performance numbers) and I'll put it on tomorrow's agenda. If it wouldn't be a trivial PR, post an issue with the numbers and we can review it tomorrow and approve first.</p>



<a name="275254416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275254416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275254416">(Mar 14 2022 at 15:42)</a>:</h4>
<p>The change I've made is indeed a <a href="https://github.com/lqd/cargo/commit/f6cfe00baa8bb06bc83bc735e3e7a9ff9bc75d1c">couple of lines</a> (though I haven't changed the book yet) but I wasn't sure about all of them (e.g. it's possible that stripping is slower on osx IIRC) wrt debugging and backtraces, and if I was missing other important considerations. The specifics can be discussed in the PR as well, so I'll change the docs and open one soon. Thanks!</p>



<a name="275278730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275278730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275278730">(Mar 14 2022 at 18:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="133247">bjorn3</span> <a href="#narrow/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units/near/275246294">said</a>:</p>
<blockquote>
<p>If multiple dependencies are being compiled at the same time cg_clif is likely to finish ~30% earlier than cg_llvm.</p>
</blockquote>
<p>that's veering into off-topic for this thread but I'm indeed seeing around 27% in check builds on "syn as a proxy for build dependencies compilation" (fun: in release as well, but that's not for build dependencies of course), and 7-10% in debug builds, a sign we should benchmark this more thoroughly. And also one that we really should land your PR to distribute cg_clif via rustup, so that people would simply <code>codegen-backend</code> their <code>build-override</code>s to test and enjoy <span aria-label="ok" class="emoji emoji-1f44c" role="img" title="ok">:ok:</span></p>



<a name="275301499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275301499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275301499">(Mar 14 2022 at 21:35)</a>:</h4>
<p>Would be fun to test that. I'm curious how much of a runtime performance hit there is for parsing Rust code with the resulting syn.</p>



<a name="275302923"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275302923" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275302923">(Mar 14 2022 at 21:51)</a>:</h4>
<p>debug mode cg_llvm and cg_clif should be roughly even. i expect within like 10%.</p>



<a name="275305031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275305031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275305031">(Mar 14 2022 at 22:13)</a>:</h4>
<p>Oh, interesting! I previously had the impression that that wasn't the case?</p>



<a name="275305045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275305045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275305045">(Mar 14 2022 at 22:13)</a>:</h4>
<p>I'm glad to hear that that's not an issue.</p>



<a name="275361384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275361384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275361384">(Mar 15 2022 at 11:44)</a>:</h4>
<p>I saw this while updating unit tests: how impactful is reuse between regular and build dependencies ? </p>
<p>Changing the build-override defaults to e.g. remove debuginfo can build such a shared dependency twice (once with debuginfo for the dev dependency, and once without debuginfo for the build dependency) where it used to only build it once</p>



<a name="275417046"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275417046" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275417046">(Mar 15 2022 at 18:34)</a>:</h4>
<p>(I won't be done with the PR before today's t-cargo meeting so I've opened an issue as josh suggested <a href="https://github.com/rust-lang/cargo/issues/10481">https://github.com/rust-lang/cargo/issues/10481</a>)</p>



<a name="275423045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275423045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275423045">(Mar 15 2022 at 19:21)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="239881">@Josh Triplett</span> , at what date+time <em>is</em> the cargo meeting where the above issue would be discussed?</p>



<a name="275423370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275423370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275423370">(Mar 15 2022 at 19:24)</a>:</h4>
<p>It was at <time datetime="2022-03-15T15:00:00Z">2022-03-15T11:00:00-04:00</time>, the next one will be at  <time datetime="2022-03-22T16:00:00Z">2022-03-22T12:00:00-04:00</time> .</p>



<a name="275710045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275710045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275710045">(Mar 17 2022 at 19:00)</a>:</h4>
<p>Thanks for the t-cargo meeting feedback!</p>
<p>I've <a href="https://github.com/rust-lang/cargo/issues/10481#issuecomment-1071210673">added more numbers</a> and info to the issue, to show some of the impact of each of those settings, why I believe turning debuginfo off is the way to go, and that I'll be working on the error messages to the either lower or disable debuginfo without degrading the user experience.</p>



<a name="275710142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275710142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275710142">(Mar 17 2022 at 19:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units/near/275301499">said</a>:</p>
<blockquote>
<p>Would be fun to test that. I'm curious how much of a runtime performance hit there is for parsing Rust code with the resulting syn.</p>
</blockquote>
<p>I don't have an easy way to get these numbers exactly, but a reasonable facsimile: a cg_clif check build at j12. 528 wins, 248 losses, no failures/ICEs. 470 wins over 10%, 140 over 20%. 100 losses over 20%, 3 around 40%. I believe that many of those are due to many benchmarks being super short, and the backend having no parallelism yet, other than cargo's own.</p>
<p>(I'm imagining a shiny future <span aria-label="crab" class="emoji emoji-1f980" role="img" title="crab">:crab:</span> where <code>build-override</code> also has: lld/mold, cg_clif + we finish splitting linking from rustc so that we can also pipeline the compilation phase and not just metadata)</p>



<a name="275710403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275710403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275710403">(Mar 17 2022 at 19:02)</a>:</h4>
<blockquote>
<p>we finish splitting linking from rustc so that we can also pipeline the compilation phase and not just metadata</p>
</blockquote>
<p>That is in principle doable using only cargo changes. <code>-Zno-link</code> and <code>-Zlink-only</code> are already supported by rustc. They aren't tested though and <code>#![crate_type]</code> doesn't work with it currently.</p>



<a name="275710573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275710573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275710573">(Mar 17 2022 at 19:04)</a>:</h4>
<p>I know but IIRC it's still not optimal/complete, although I haven't checked in a while</p>



<a name="275717621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275717621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275717621">(Mar 17 2022 at 20:01)</a>:</h4>
<p><span class="user-mention" data-user-id="116113">@lqd</span> Based on the information you posted, I agree that we could turn off debuginfo for build-override as the highest-impact change.</p>



<a name="275717658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275717658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275717658">(Mar 17 2022 at 20:01)</a>:</h4>
<p>With an update to the documentation, and an update to the message shown when a build script fails.</p>



<a name="275720453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/275720453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#275720453">(Mar 17 2022 at 20:22)</a>:</h4>
<p>cool :) I'll keep working in this direction then</p>



<a name="276060527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/276060527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#276060527">(Mar 21 2022 at 14:44)</a>:</h4>
<p>I've updated tests and the message shown when a build script fails, and have opened the draft PR, for discussion and guidance on the remaining tasks (whether the tests relying on build reuse are acceptable ? how to fix <code>-Z scrape-examples</code> which seems to be incorrect wrt build reuse as well) here: <a href="https://github.com/rust-lang/cargo/pull/10493">https://github.com/rust-lang/cargo/pull/10493</a></p>



<a name="276373896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/276373896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#276373896">(Mar 23 2022 at 17:48)</a>:</h4>
<p>I've opened <a href="https://github.com/rust-lang/cargo/issues/10500">https://github.com/rust-lang/cargo/issues/10500</a> to track the pre-existing <code>-Z rustdoc-scrape-examples</code> issue, which I assume would block the PR (it would otherwise very likely prevent the unstable feature from working altogether). Will said he'll look into it <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="276981339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/276981339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#276981339">(Mar 29 2022 at 09:53)</a>:</h4>
<p>another update: after discussing <a href="https://github.com/rust-lang/rust/issues/10500">#10500</a> with Will, it turns out that their other PR <a href="https://github.com/rust-lang/cargo/pull/10343">https://github.com/rust-lang/cargo/pull/10343</a> had a fix for it. That unblocks <a href="https://github.com/rust-lang/rust/issues/10493">#10493</a> so I've incorporated the fix and tests, and marked the PR as ready to review.</p>



<a name="278713361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278713361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278713361">(Apr 12 2022 at 15:57)</a>:</h4>
<p>I was wondering, given the recent t-cargo Inside Rust blog post, would this work be rejected as a new feature, or just delayed until reviewers have time to look at it (which is perfectly fine and expected to be clear) ?</p>



<a name="278713544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278713544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278713544">(Apr 12 2022 at 15:59)</a>:</h4>
<p>I've been running some benchmarks locally (they are running right now).  I'm having some mixed results on different projects, and I want to get a better understanding of how much of a win it is.</p>



<a name="278713548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278713548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278713548">(Apr 12 2022 at 15:59)</a>:</h4>
<p>I believe were excited for this work, and will happily see incremental progress on this. We will merge it at whatever pace we can manage.</p>



<a name="278713904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278713904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278713904">(Apr 12 2022 at 16:01)</a>:</h4>
<p>This is a pretty major change since it causes <em>more</em> rustc compilations in some cases, and I'm not sure if we want to make that jump or not.</p>



<a name="278714199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278714199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278714199">(Apr 12 2022 at 16:03)</a>:</h4>
<p>interesting yes, in the cases where some dependencies are shared between the build dependencies and the leaf crates it could cause another compilation to be triggered</p>



<a name="278714224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278714224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278714224">(Apr 12 2022 at 16:03)</a>:</h4>
<p>(thanks to the both of you for the answers)</p>



<a name="278714272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278714272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278714272">(Apr 12 2022 at 16:03)</a>:</h4>
<p>if you have specific benchmarks I could also take a look at them</p>



<a name="278714397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278714397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278714397">(Apr 12 2022 at 16:04)</a>:</h4>
<p>esp if they're not the crates we've been looking at earlier, or have big regressions</p>



<a name="278714548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278714548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278714548">(Apr 12 2022 at 16:05)</a>:</h4>
<p>the ones we saw were <a href="https://github.com/lqd/rustc-benchmarking-data/tree/main/experiments/cargo-build-defaults">here</a> in the "regressions.txt" files for check and debug builds, and were often short and high-variance</p>



<a name="278714693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278714693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278714693">(Apr 12 2022 at 16:06)</a>:</h4>
<p>while the improvements had a tighter confidence range and higher magnitude</p>



<a name="278730165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278730165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278730165">(Apr 12 2022 at 18:03)</a>:</h4>
<p>We talked briefly about the idea of a "debug = don't care" mechanism, for "prefer to unify and do one build rather than two, only omit debug info if nothing else building this crate has a preference". But that'd be a larger and more invasive change, and unification seems subtle and quick to anger.</p>



<a name="278731570"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Defaults%20for%20faster%20compilation%20of%20%22for%20host%22%20units/near/278731570" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Defaults.20for.20faster.20compilation.20of.20.22for.20host.22.20units.html#278731570">(Apr 12 2022 at 18:13)</a>:</h4>
<p>at the very least we can document these defaults in nick's rust perf book chapter on compile times</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>