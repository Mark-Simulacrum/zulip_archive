<html>
<head><meta charset="utf-8"><title>TomlManifest (de)serialization IR · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html">TomlManifest (de)serialization IR</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265231249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265231249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265231249">(Dec 16 2021 at 22:51)</a>:</h4>
<p>Turns out serde generates a _lot_ of (de)serialization code for <code>TomlManifest</code>. Which makes compiling anything that uses it pretty darn slow.</p>
<div class="codehilite"><pre><span></span><code>$ cat src/main.rs
fn main() {
    let _: cargo::util::toml::TomlManifest = toml::from_str(&quot;&quot;).unwrap();
}
$ touch src/main.rs
$ cargo llvm-lines --bin slow-cargo-rebuild | head -10
   Compiling slow-cargo-rebuild v0.1.0 (/local/home/jongje/slow-cargo-rebuild)
warning: `slow-cargo-rebuild` (bin &quot;slow-cargo-rebuild&quot;) generated 2 warnings
    Finished dev [unoptimized + debuginfo] target(s) in 9.14s
  Lines          Copies       Function name
  -----          ------       -------------
  230408 (100%)  3409 (100%)  (TOTAL)
   25227 (10.9%)    5 (0.1%)  &lt;cargo::util::toml::_::&lt;impl serde::de::Deserialize for cargo::util::toml::TomlProject&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
   11721 (5.1%)     6 (0.2%)  &lt;cargo::util::toml::_::&lt;impl serde::de::Deserialize for cargo::util::toml::TomlProfile&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
   11053 (4.8%)    31 (0.9%)  &lt;toml::de::MapVisitor as serde::de::MapAccess&gt;::next_value_seed
   10582 (4.6%)     5 (0.1%)  &lt;cargo::util::toml::_::&lt;impl serde::de::Deserialize for cargo::util::toml::TomlTarget&gt;::deserialize::__Visitor as serde::de::Visitor&gt;::visit_map
    9320 (4.0%)    54 (1.6%)  &lt;toml::de::SpannedDeserializer&lt;T&gt; as serde::de::MapAccess&gt;::next_value_seed
    8414 (3.7%)    23 (0.7%)  &lt;toml::de::ValueDeserializer as serde::de::Deserializer&gt;::deserialize_any
    7715 (3.3%)    10 (0.3%)  &lt;toml::de::MapVisitor as serde::de::MapAccess&gt;::next_key_seed
</code></pre></div>



<a name="265231371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265231371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265231371">(Dec 16 2021 at 22:52)</a>:</h4>
<p>I tried adding tiny function to <code>cargo</code> like this:</p>
<div class="codehilite"><pre><span></span><code>pub fn parse_manifest(contents: &amp;str) -&gt; CargoResult&lt;TomlManifest&gt; {
    Ok(toml::from_str(contents)?)
}
</code></pre></div>
<p>and calling that instead so that the IR is contained within the <code>cargo</code> crate, so:</p>
<div class="codehilite"><pre><span></span><code>fn main() {
    let _: cargo::util::toml::TomlManifest = cargo::util::toml::parse_manifest(&quot;&quot;).unwrap();
}
</code></pre></div>
<p>and lo and behold:</p>
<div class="codehilite"><pre><span></span><code>    Finished dev [unoptimized + debuginfo] target(s) in 5.54s
  Lines       Copies     Function name
  -----       ------     -------------
  177 (100%)  13 (100%)  (TOTAL)
   40 (22.6%)  1 (7.7%)  core::result::Result&lt;T,E&gt;::unwrap
   33 (18.6%)  2 (15.4%) core::ops::function::FnOnce::call_once
   26 (14.7%)  1 (7.7%)  std::sys_common::backtrace::__rust_begin_short_backtrace
   22 (12.4%)  1 (7.7%)  std::rt::lang_start
   12 (6.8%)   1 (7.7%)  std::rt::lang_start::{{closure}}
    9 (5.1%)   1 (7.7%)  core::ops::function::FnOnce::call_once{{vtable.shim}}
    9 (5.1%)   1 (7.7%)  slow_cargo_rebuild::main
</code></pre></div>



<a name="265231587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265231587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265231587">(Dec 16 2021 at 22:55)</a>:</h4>
<p>Thoughts on making a simple helper function like that available?</p>



<a name="265231630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265231630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265231630">(Dec 16 2021 at 22:55)</a>:</h4>
<p>(note the compilation time was cut in half, down by 5s — the remaining 5s is because I'm using an ancient linker)</p>



<a name="265231739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265231739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265231739">(Dec 16 2021 at 22:56)</a>:</h4>
<p>Maybe under the name <code>parse_plain_manifest</code>?</p>



<a name="265231808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265231808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265231808">(Dec 16 2021 at 22:57)</a>:</h4>
<p>Why does it generate so much IR? Can we reduce the raw complexity of the deserializing code?</p>



<a name="265231896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265231896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265231896">(Dec 16 2021 at 22:58)</a>:</h4>
<p>I think it's because there are just a _lot_ of fields in there. See <code>TomlProject</code> for example: &lt;<a href="https://github.com/rust-lang/cargo/blob/bfb7f2e083cc93e20ab98e97045c64c7144cca5f/src/cargo/util/toml/mod.rs#L852">https://github.com/rust-lang/cargo/blob/bfb7f2e083cc93e20ab98e97045c64c7144cca5f/src/cargo/util/toml/mod.rs#L852</a>&gt;</p>



<a name="265231960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265231960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265231960">(Dec 16 2021 at 22:59)</a>:</h4>
<p>&lt;<a href="https://github.com/rust-lang/cargo/blob/bfb7f2e083cc93e20ab98e97045c64c7144cca5f/src/cargo/util/toml/mod.rs#L283">https://github.com/rust-lang/cargo/blob/bfb7f2e083cc93e20ab98e97045c64c7144cca5f/src/cargo/util/toml/mod.rs#L283</a>&gt; is both deep and wide, so a lot of code is needed to walk it to serialize and deserialize</p>



<a name="265232007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265232007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265232007">(Dec 16 2021 at 22:59)</a>:</h4>
<p>It probably adds a non-trivial amount of time to compiling cargo itself tbh, though I think it's time that's tricky to get back</p>



<a name="265232125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265232125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265232125">(Dec 16 2021 at 23:00)</a>:</h4>
<p>But at least a helper function like this would avoid passing it on unnecessarily to consumers should they need to deserialize a <code>TomlManifest</code> .</p>



<a name="265232198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265232198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265232198">(Dec 16 2021 at 23:00)</a>:</h4>
<p>Admittedly very few consumers should need to do that, but there's always the one weird one (often me recently it seems <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> )</p>



<a name="265232302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265232302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265232302">(Dec 16 2021 at 23:01)</a>:</h4>
<p>Honestly, in my case, it'd be fine if <code>do_read_manifest</code> was just public (&lt;<a href="https://github.com/rust-lang/cargo/blob/bfb7f2e083cc93e20ab98e97045c64c7144cca5f/src/cargo/util/toml/mod.rs#L60">https://github.com/rust-lang/cargo/blob/bfb7f2e083cc93e20ab98e97045c64c7144cca5f/src/cargo/util/toml/mod.rs#L60</a>&gt;). I just have a modified in-memory representation of an on-disk <code>Cargo.toml</code> that I want to turn into a <code>Manifest</code></p>



<a name="265234142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265234142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265234142">(Dec 16 2021 at 23:21)</a>:</h4>
<p>I went ahead and cut a PR that just makes that function <code>pub</code> (under a slightly better name) since that would actually be sufficient for my use-case! &lt;<a href="https://github.com/rust-lang/cargo/pull/10209">https://github.com/rust-lang/cargo/pull/10209</a>&gt;</p>



<a name="265311394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265311394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265311394">(Dec 17 2021 at 15:33)</a>:</h4>
<p>I am ok with that PR, but would appreciate input from the rest of the team.</p>



<a name="265547919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265547919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265547919">(Dec 20 2021 at 10:59)</a>:</h4>
<p>hmm</p>



<a name="265547942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265547942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265547942">(Dec 20 2021 at 10:59)</a>:</h4>
<p>that issue doesn't seem to be accurate anymore?</p>



<a name="265548161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/TomlManifest%20%28de%29serialization%20IR/near/265548161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pietro Albini <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/TomlManifest.20(de)serialization.20IR.html#265548161">(Dec 20 2021 at 11:01)</a>:</h4>
<p>this results in the correct URL being used:</p>
<ul>
<li><code>cargo install empty-library --registry staging</code> to update the index</li>
<li><code>rm -rf ~/.cargo/registry/{cache,src}/github.com-80cf1661ba913b15/</code> (force Cargo to re-download)</li>
<li><code>cargo check</code></li>
</ul>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>