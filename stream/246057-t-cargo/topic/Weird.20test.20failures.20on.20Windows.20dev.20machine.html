<html>
<head><meta charset="utf-8"><title>Weird test failures on Windows dev machine · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html">Weird test failures on Windows dev machine</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268589964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268589964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268589964">(Jan 19 2022 at 19:17)</a>:</h4>
<p>I'm trying to run <code>cargo test</code> in the cargo repo on a Windows 11 machine and I'm getting some weird behavior. Basically, several tests fail, but if I run the test individually then they succeed. The other weird thing is that while running <code>cargo test</code>, some other programs on my machine fail to save files, giving an <code>EBUSY: resource busy or locked</code> error.</p>



<a name="268590052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268590052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268590052">(Jan 19 2022 at 19:18)</a>:</h4>
<p>That is odd. :-(</p>



<a name="268590057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268590057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268590057">(Jan 19 2022 at 19:18)</a>:</h4>
<p>It seems like maybe one of the cargo tests is taking an overly broad file system lock?</p>



<a name="268590457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268590457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268590457">(Jan 19 2022 at 19:21)</a>:</h4>
<p>If I run <code>cargo test fix</code> then I start noticing the save errors in other programs, so it seems like the culprit is a test that runs during that set, but I haven't been able to narrow it down further.</p>



<a name="268602259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268602259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268602259">(Jan 19 2022 at 20:58)</a>:</h4>
<p>Sorry I don't have a win11 to test on. Please let use know what you find.</p>



<a name="268603184"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268603184" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268603184">(Jan 19 2022 at 21:04)</a>:</h4>
<p>this is often related to antivirus things which generally wreak havoc with programs trying to access the filesystem, do you know if you have anything like that configured?</p>



<a name="268603234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268603234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268603234">(Jan 19 2022 at 21:04)</a>:</h4>
<p>an example is that antivirus things can often keep files open long after cargo closes them, preventing cargo from deleting files it thinks it should be able to delete</p>



<a name="268613239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268613239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268613239">(Jan 19 2022 at 22:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116015">Alex Crichton</span> <a href="#narrow/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine/near/268603184">said</a>:</p>
<blockquote>
<p>this is often related to antivirus things which generally wreak havoc with programs trying to access the filesystem, do you know if you have anything like that configured?</p>
</blockquote>
<p>As far as I know I just have the normal Windows Defender stuff running, although maybe this is causing the problem.</p>



<a name="268614045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268614045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268614045">(Jan 19 2022 at 22:39)</a>:</h4>
<p>can you gist the failures that you're seeing?</p>



<a name="268614121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268614121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268614121">(Jan 19 2022 at 22:40)</a>:</h4>
<p>Hmm, adding the exclusion didn't help</p>



<a name="268614157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268614157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268614157">(Jan 19 2022 at 22:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116015">Alex Crichton</span> <a href="#narrow/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine/near/268614045">said</a>:</p>
<blockquote>
<p>can you gist the failures that you're seeing?</p>
</blockquote>
<p><a href="https://gist.github.com/eholk/07c54be54d345e259716af6c2cb872cc">https://gist.github.com/eholk/07c54be54d345e259716af6c2cb872cc</a></p>



<a name="268614523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268614523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268614523">(Jan 19 2022 at 22:44)</a>:</h4>
<p>hm ok so that looks like it's in cargo's cleanup code for tests, so probably unrelated to cargo itself, and I think that most likely has to do with something stray keeping it open like a process or something like that</p>



<a name="268614561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268614561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268614561">(Jan 19 2022 at 22:45)</a>:</h4>
<p>another random thought is that maybe your windows has nested job objects disabled? I thought that was enabled by default though in like windows 10 or years ago though</p>



<a name="268614595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268614595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268614595">(Jan 19 2022 at 22:45)</a>:</h4>
<p>Do you know how to check?</p>



<a name="268614600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268614600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268614600">(Jan 19 2022 at 22:45)</a>:</h4>
<p>Unfortunately I don't know how to figure out what's keeping something open</p>



<a name="268614614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268614614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268614614">(Jan 19 2022 at 22:45)</a>:</h4>
<p>you can try poking around in cargo's jobserver bits</p>



<a name="268614630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268614630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268614630">(Jan 19 2022 at 22:45)</a>:</h4>
<p>I think there's a <code>CARGO_LOG</code> incantation to print things but I forget what itt is</p>



<a name="268616011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268616011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268616011">(Jan 19 2022 at 22:59)</a>:</h4>
<p>I assume you've run <code>cargo clean</code> at some point?  </p>
<p>The <code>target</code> directory is supposed to be excluded from indexing, but I would double-check that is still working.  I'm uncertain how to do that exactly, but I would try just manually adding your work directory to the exclusion list.</p>
<p>I would also temporarily disable the Defender real-time scanning.</p>
<p>Presumably the locks are transient, which makes it hard to catch the bad-actor.  Process Explorer can be used to find those, but only if they hold the file open for a long period of time.</p>



<a name="268616015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268616015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268616015">(Jan 19 2022 at 22:59)</a>:</h4>
<p>Hmm, so deleting my <code>target</code> directory and rebooting, along with the Windows Defender exclusion fixed it. Maybe I just had some stale files in the target directory with bad permissions.</p>



<a name="268616143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268616143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268616143">(Jan 19 2022 at 23:00)</a>:</h4>
<p><span class="user-mention" data-user-id="120518">@Eric Huss</span> - yeah, I hadn't run <code>cargo clean</code> yet, but that failed and then manually deleting the files fixed it.</p>



<a name="268616219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268616219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268616219">(Jan 19 2022 at 23:00)</a>:</h4>
<p>Ah.  Hopefully it doesn't crop up again, that can be annoying to track down.</p>



<a name="268616273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268616273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268616273">(Jan 19 2022 at 23:01)</a>:</h4>
<p>At least now I'm armed with a few more troubleshooting tips if it does :)</p>



<a name="268616277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Weird%20test%20failures%20on%20Windows%20dev%20machine/near/268616277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eholk <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine.html#268616277">(Jan 19 2022 at 23:01)</a>:</h4>
<p>Thanks for the help!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>