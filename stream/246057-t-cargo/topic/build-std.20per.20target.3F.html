<html>
<head><meta charset="utf-8"><title>build-std per target? · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/build-std.20per.20target.3F.html">build-std per target?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="268661538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/build-std%20per%20target%3F/near/268661538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Oppermann <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/build-std.20per.20target.3F.html#268661538">(Jan 20 2022 at 09:04)</a>:</h4>
<p>Hi, I just came across PR <a href="https://github.com/rust-lang/cargo/pull/10308">#10308</a>  (move <code>build-std</code> to Cargo.toml) and <a href="#narrow/stream/246057-t-cargo/topic/build-std.20in.20Cargo.2Etoml/near/268603472">your discussion about it</a>.</p>
<p>The main issue with <code>build-std</code> being a global setting is that there are workspaces that contain both bare-metal crates and tooling crates that should run on the host (e.g. using the common <a href="https://github.com/matklad/cargo-xtask/">cargo-xtask</a> pattern). Enabling build-std globally in a <code>.cargo/config</code> file is not really possible for such workspaces because it then also applies to the host-level crates, which then don't build anymore because build-std requires a <code>--target</code> argument.<br>
Also, with the upcoming artifact dependencies feature, it would not be possible to include an artifact that requires <code>-Zbuild-std</code> to build (there are no ways to pass additional cli arguments AFAIK).</p>
<p>Given that some targets <em>require</em> <code>build-std</code> for a successful build, I wonder how you feel about making the <code>build-std</code> setting configurable per-target? There are already <a href="https://doc.rust-lang.org/nightly/cargo/reference/config.html#target">target specific configs</a> for rustflags and runner executables, so maybe we could allow the unstable <code>build-std</code> and <code>build-std-features</code> keys there too? I think this would solve the mentioned problems without polluting the Cargo.toml, and it should be relatively simple to implement too (the stdlib needs to be built per-target anyway).</p>



<a name="268701138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/build-std%20per%20target%3F/near/268701138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/build-std.20per.20target.3F.html#268701138">(Jan 20 2022 at 14:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="121929">Philipp Oppermann</span> <a href="#narrow/stream/246057-t-cargo/topic/build-std.20per.20target.3F/near/268661538">said</a>:</p>
<blockquote>
<p>which then don't build anymore because build-std requires a <code>--target</code> argument.</p>
</blockquote>
<p>That requirement is just an implementation limitation that we plan to remove.</p>
<blockquote>
<p>I wonder how you feel about making the <code>build-std</code> setting configurable per-target? </p>
</blockquote>
<p>I would prefer to not expose that level of detail.  The long term goal is to make it a global on/off flag, and then perhaps eventually make it always on (once there is sufficient caching available).</p>



<a name="268703406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/build-std%20per%20target%3F/near/268703406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Oppermann <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/build-std.20per.20target.3F.html#268703406">(Jan 20 2022 at 14:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120518">Eric Huss</span> <a href="#narrow/stream/246057-t-cargo/topic/build-std.20per.20target.3F/near/268701138">said</a>:</p>
<blockquote>
<blockquote>
<p>which then don't build anymore because build-std requires a <code>--target</code> argument.</p>
</blockquote>
<p>That requirement is just an implementation limitation that we plan to remove.</p>
</blockquote>
<p>Good to know! Do you think that this is something that can be solved in the short term or does it require more work?</p>



<a name="268703632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/build-std%20per%20target%3F/near/268703632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Oppermann <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/build-std.20per.20target.3F.html#268703632">(Jan 20 2022 at 14:56)</a>:</h4>
<p>I still think that there would be some value in a "compile core/std only if needed" mode to keep compile times low</p>



<a name="268703680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/build-std%20per%20target%3F/near/268703680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/build-std.20per.20target.3F.html#268703680">(Jan 20 2022 at 14:56)</a>:</h4>
<p>Short term is probably "no", as I don't plan to address it any time soon.</p>



<a name="268705032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/build-std%20per%20target%3F/near/268705032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Oppermann <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/build-std.20per.20target.3F.html#268705032">(Jan 20 2022 at 15:04)</a>:</h4>
<p>Hmm ok. It would be great to have some workaround available until then. We could put the target-specific build-std settings in an explicit <code>target.&lt;cfg&gt;.unstable</code> table and document clearly that this is only a workaround. As soon as the <code>--target</code> limitation is lifted, we could remove it again.</p>



<a name="268709337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/build-std%20per%20target%3F/near/268709337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/build-std.20per.20target.3F.html#268709337">(Jan 20 2022 at 15:29)</a>:</h4>
<p>I think I'm a little more dubious than <span class="user-mention" data-user-id="120518">@Eric Huss</span> about turning build-std on-by-default globally, personally I would be ok with a target-level config to force it on for some targets but not others. Similarly I'd be ok making it an option in manifests as well but I would not want to remove it from <code>.cargo/config.toml</code> (which I think the PR does?)</p>



<a name="268709588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/build-std%20per%20target%3F/near/268709588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/build-std.20per.20target.3F.html#268709588">(Jan 20 2022 at 15:30)</a>:</h4>
<p>I do think that artifact dependencies, if we push on them, does sort of mean that CLI flags are really not all that useful because many artifacts are built as part of a build invocation rather than specifically on the command line</p>



<a name="269019817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/build-std%20per%20target%3F/near/269019817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Philipp Oppermann <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/build-std.20per.20target.3F.html#269019817">(Jan 23 2022 at 14:13)</a>:</h4>
<blockquote>
<p>I would not want to remove it from .cargo/config.toml (which I think the PR does?)</p>
</blockquote>
<p>Agreed! There are use cases where a global switch is very useful. Also, removing it would lead to unnecessary churn.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>