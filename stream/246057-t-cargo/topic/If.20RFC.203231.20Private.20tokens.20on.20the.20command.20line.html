<html>
<head><meta charset="utf-8"><title>If RFC 3231 Private tokens on the command line · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html">If RFC 3231 Private tokens on the command line</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274051510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274051510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274051510">(Mar 03 2022 at 22:43)</a>:</h4>
<p>There was a legitimate question on my RFC about the <a href="https://github.com/rust-lang/rfcs/pull/3231#discussion_r812435273">command line interface</a> of cargo login (if RFC 3231 is merged).</p>
<p>The existing behavior:</p>
<ul>
<li><code>cargo login</code> prompts for a secret token.</li>
<li><code>cargo login -- value</code> does not have a prompt but leaks the value into the shell history.</li>
</ul>
<p>Proposed additions:</p>
<ul>
<li><code>cargo login --private-key</code> prompts for a private-key.</li>
<li><code>cargo login --private-key -- value</code> does not have a prompt but leaks the value into the shell history.</li>
</ul>
<p>possibley with a check, if you <code>cargo login</code> then give something that looks like a private key we will ask you to confirm witch one it is.</p>



<a name="274051920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274051920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274051920">(Mar 03 2022 at 22:47)</a>:</h4>
<p>My expertise is not in CLI design.</p>
<ul>
<li>Is this good design?</li>
<li>Is this something we can do with clap?</li>
<li>How stable does the <code>prompt</code> interface need to stay?</li>
</ul>



<a name="274056004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274056004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274056004">(Mar 03 2022 at 23:26)</a>:</h4>
<p>I would argue it should be _impossible_ to provide the token as a command argument. It should either be provided on stdin, or via a file. Arguments tend to leak all over the place.</p>



<a name="274056305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274056305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274056305">(Mar 03 2022 at 23:29)</a>:</h4>
<p>Absolutely. In particular, arguments are accessible to other applications on the same system that do not otherwise share privileges.</p>



<a name="274056839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274056839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274056839">(Mar 03 2022 at 23:33)</a>:</h4>
<p>So that points out a question:</p>
<ul>
<li>how important is it for login to have consistent API between secret tokens and asymmetric tokens?</li>
</ul>
<p>How big a deal is it to say <code>-- value</code> will not work with <code>--private-key</code>?</p>



<a name="274056866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274056866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274056866">(Mar 03 2022 at 23:33)</a>:</h4>
<p>Also should we remove support for that for old style tokens?</p>



<a name="274057003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274057003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274057003">(Mar 03 2022 at 23:34)</a>:</h4>
<p>I think we should remove that. But more importantly, let's not <em>extend</em> it to any new cases.</p>



<a name="274057284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274057284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274057284">(Mar 03 2022 at 23:38)</a>:</h4>
<p>If we're serious about that, the first step would be to stop recommending it <a href="https://doc.rust-lang.org/cargo/reference/publishing.html#before-your-first-publish">https://doc.rust-lang.org/cargo/reference/publishing.html#before-your-first-publish</a></p>



<a name="274162439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274162439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274162439">(Mar 04 2022 at 17:32)</a>:</h4>
<p><a href="https://github.com/rust-lang/cargo/pull/10458">https://github.com/rust-lang/cargo/pull/10458</a></p>



<a name="274193692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274193692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274193692">(Mar 04 2022 at 21:54)</a>:</h4>
<p>Given that <a href="https://github.com/rust-lang/cargo/blob/9d754ed085a97d486cda45308a3c749c818305a5/src/cargo/ops/registry.rs#L700-L713">this code</a> is not covered by tests, what is the best way for me to test that the <code>cargo login --private-key</code> prompts for a key?</p>



<a name="274195007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274195007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274195007">(Mar 04 2022 at 22:06)</a>:</h4>
<p>I don't think the test support code has any support for sending data via stdin.  It would need to be done manually, something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cargo_test_support</span>::<span class="n">cargo_process</span><span class="p">(</span><span class="s">"login"</span><span class="p">).</span><span class="n">build_command</span><span class="p">();</span><span class="w"></span>
<span class="n">cargo</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">stdin</span><span class="p">(</span><span class="n">Stdio</span>::<span class="n">piped</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">stdout</span><span class="p">(</span><span class="n">Stdio</span>::<span class="n">piped</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">stderr</span><span class="p">(</span><span class="n">Stdio</span>::<span class="n">piped</span><span class="p">());</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cargo</span><span class="p">.</span><span class="n">spawn</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="n">child</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="n">unwrap</span><span class="p">().</span><span class="n">write_all</span><span class="p">(</span><span class="s">b"some token"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
</code></pre></div>



<a name="274195568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/If%20RFC%203231%20Private%20tokens%20on%20the%20command%20line/near/274195568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/If.20RFC.203231.20Private.20tokens.20on.20the.20command.20line.html#274195568">(Mar 04 2022 at 22:12)</a>:</h4>
<p>FYI I'm getting close to releasing a new version of a crate that should help with this.   In cargo-edit, I had been using a <code>[[bin]]</code> snapshotting crate I wrote called <code>trycmd</code> but it isn't flexible to handle the registry stuff.  I'm experimenting with a lower level <code>[[bin]]</code> snapshotting crate that is more like a generalized <code>cargo_test_support</code> but with snapshotting.   it has good support for <code>stdin</code>.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>