<html>
<head><meta charset="utf-8"><title>Custom cargo command example and best practices · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20cargo.20command.20example.20and.20best.20practices.html">Custom cargo command example and best practices</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265049835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20cargo%20command%20example%20and%20best%20practices/near/265049835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20cargo.20command.20example.20and.20best.20practices.html#265049835">(Dec 15 2021 at 18:02)</a>:</h4>
<p>I'm experimenting with yet another cargo subcommand and figured we should probably provide examples in clap for this.</p>
<ul>
<li><a href="https://github.com/epage/clap/blob/cargo/examples/cargo-example.rs">cargo-example</a></li>
<li><a href="https://github.com/epage/clap/blob/cargo/examples/cargo-example.md">example output</a></li>
<li><a href="https://github.com/clap-rs/clap/pull/3180">relevant PR</a> (focus on the second commit, the first is cleanup that adds a lot of noise)</li>
</ul>
<p>Feel free to comment on that PR, even if I've already merged it, for any other recommendations or best practices I might have missed.</p>
<p>I know that <span class="user-mention" data-user-id="120054">@Jon Gjengset</span> has <a href="https://github.com/TeXitoi/structopt/issues/58">expressed interest in custom cargo commands being directly callable without the extra subcommand cargo requires</a>.  For myself, I guess I'm not dealt with that workflow so I have a hard time commenting on it.</p>



<a name="265079656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20cargo%20command%20example%20and%20best%20practices/near/265079656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20cargo.20command.20example.20and.20best.20practices.html#265079656">(Dec 15 2021 at 21:44)</a>:</h4>
<blockquote>
<p>I know that @Jon Gjengset has expressed interest in custom cargo commands being directly callable without the extra subcommand cargo requires.</p>
</blockquote>
<p>I would also find that super convenient - I had to make a separate binary altogether for this since otherwise the command name was ambiguous with a positional argument</p>



<a name="265082606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20cargo%20command%20example%20and%20best%20practices/near/265082606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20cargo.20command.20example.20and.20best.20practices.html#265082606">(Dec 15 2021 at 22:05)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span>  Could you help me understand the role of the tools and the user workflow where a bin gets called both standalone and as a custom cargo subcommand?</p>



<a name="265083025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20cargo%20command%20example%20and%20best%20practices/near/265083025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20cargo.20command.20example.20and.20best.20practices.html#265083025">(Dec 15 2021 at 22:09)</a>:</h4>
<p>here's the standalone binary:</p>
<div class="codehilite"><pre><span></span><code>$ deadlinks --help
Check your package&#39;s documentation for dead links.

Usage:
    deadlinks [options] &lt;directory&gt;...

Options:
    -h --help               Print this message
    --check-http            Check &#39;http&#39; and &#39;https&#39; scheme links
    --forbid-http           Give an error if HTTP links are found. This is incompatible with --check-http.
    --ignore-fragments      Don&#39;t check URL fragments.
    --debug                 Use debug output
    -v --verbose            Use verbose output
    -V --version            Print version info and exit.
</code></pre></div>
<p>and the cargo integration:</p>
<div class="codehilite"><pre><span></span><code>$ cargo-deadlinks deadlinks --help
Check your package&#39;s documentation for dead links.

Usage:
    cargo deadlinks [--dir &lt;directory&gt;] [--cargo-dir &lt;directory&gt;] [options] [-- &lt;CARGO_ARGS&gt;]

Options:
    -h --help               Print this message.
    --dir                   Specify a directory to check (default is all paths that have documentation generated by cargo).
    --cargo-dir             Specify which directory to look in for the Cargo manifest (default is the current directory).
    --check-http            Check &#39;http&#39; and &#39;https&#39; scheme links.
    --forbid-http           Give an error if HTTP links are found. This is incompatible with --check-http.
    --check-intra-doc-links Check for broken intra-doc links.
    --ignore-fragments      Don&#39;t check URL fragments.
    --no-build              Do not call `cargo doc` before running link checking. By default, deadlinks will call `cargo doc` if `--dir` is not passed.
    --debug                 Use debug output. This option is deprecated; use `RUST_LOG=debug` instead.
    -v --verbose            Use verbose output. This option is deprecated; use `RUST_LOG=info` instead.
    -V --version            Print version info and exit.

CARGO_ARGS will be passed verbatim to `cargo doc` (as long as `--no-build` is not passed).
</code></pre></div>
<p>Basically this makes sense to use both with and without cargo, but when running with cargo it's a lot smarter.</p>



<a name="265083101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20cargo%20command%20example%20and%20best%20practices/near/265083101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20cargo.20command.20example.20and.20best.20practices.html#265083101">(Dec 15 2021 at 22:10)</a>:</h4>
<p>the standalone one requires you to have pre-existing HTML files in a directory, the cargo one can build the docs for you</p>



<a name="265083714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20cargo%20command%20example%20and%20best%20practices/near/265083714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20cargo.20command.20example.20and.20best.20practices.html#265083714">(Dec 15 2021 at 22:13)</a>:</h4>
<p>if cargo didn't pass the command name unconditionally, I could just make <code>cargo-deadlinks</code> a symlink to <code>deadlinks</code>, which would save 10 MB of disk space and more importantly let me simplify the code - right now the directory structure looks like this:</p>
<div class="codehilite"><pre><span></span><code>src/bin/
├── cargo-deadlinks.rs
├── deadlinks.rs
└── shared.rs
</code></pre></div>



<a name="265084025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20cargo%20command%20example%20and%20best%20practices/near/265084025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20cargo.20command.20example.20and.20best.20practices.html#265084025">(Dec 15 2021 at 22:16)</a>:</h4>
<p>The in-work <a href="https://github.com/clap-rs/clap/issues/2861">multicall</a> feature could help with this.  It let's you treat the binary <code>file_stem</code> as a subcommand.   You would then define the following subcommands</p>
<ul>
<li><code>deadlinks</code></li>
<li><code>cargo-deadlinks</code><ul>
<li><code>deadlinks</code></li>
</ul>
</li>
</ul>
<p>You can break the deadlinks definition and business logic out into functions for reuse between the two subcommands.</p>



<a name="265084092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20cargo%20command%20example%20and%20best%20practices/near/265084092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20cargo.20command.20example.20and.20best.20practices.html#265084092">(Dec 15 2021 at 22:17)</a>:</h4>
<p>yes, but then I'd have to use clap :P</p>



<a name="265084199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20cargo%20command%20example%20and%20best%20practices/near/265084199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20cargo.20command.20example.20and.20best.20practices.html#265084199">(Dec 15 2021 at 22:18)</a>:</h4>
<p>Well, world domination is one step at a time :)</p>



<a name="265084320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20cargo%20command%20example%20and%20best%20practices/near/265084320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20cargo.20command.20example.20and.20best.20practices.html#265084320">(Dec 15 2021 at 22:19)</a>:</h4>
<p>Jon's request was for how to do it in structopt/clap, so that was the spirit of my answer.  The only option I've thought of besides multicall support, is if cargo changed its protocol for subcommands but I'm unsure if there is a path forward for that without breaking compatibility.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>