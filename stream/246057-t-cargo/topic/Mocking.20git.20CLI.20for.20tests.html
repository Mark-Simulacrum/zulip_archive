<html>
<head><meta charset="utf-8"><title>Mocking git CLI for tests · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Mocking.20git.20CLI.20for.20tests.html">Mocking git CLI for tests</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="252343846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Mocking%20git%20CLI%20for%20tests/near/252343846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> std::Veetaha <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Mocking.20git.20CLI.20for.20tests.html#252343846">(Sep 07 2021 at 17:46)</a>:</h4>
<p>Hey guys, and I think <span class="user-mention" data-user-id="116015">@Alex Crichton</span> in particular.<br>
I'd like to test <code>git</code> CLI retries with a mock like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg(test)]</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">cargo_util</span>::<span class="n">ProcessBuilder</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[cfg(not(test))]</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">tests</span>::<span class="n">MockProcessBuilder</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ProcessBuilder</span><span class="p">;</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">fetch_with_git_cli</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="n">ProcessBuilder</span>::<span class="n">new</span><span class="p">(</span><span class="o">..</span><span class="p">.).</span><span class="n">foo</span><span class="p">().</span><span class="n">bar</span><span class="p">().</span><span class="n">exec_with_output</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MockProcessBuilder</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Do you think this is acceptable? I would really like to test this because it will be very easy to introduce regressions to this functionality unless this is tested.<br>
The other option is that I could add one more one more <code>bin</code> target to <code>Cargo.toml</code> and make the method configurable with the git binary path to test it with the binary that outputs whatever we want in our tests.</p>
<p>The first option is much more lightweight, however, I don't know if it's acceptable here and considered idiomatic at all?</p>



<a name="252343893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Mocking%20git%20CLI%20for%20tests/near/252343893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> std::Veetaha <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Mocking.20git.20CLI.20for.20tests.html#252343893">(Sep 07 2021 at 17:47)</a>:</h4>
<p>This refers to <a href="https://github.com/rust-lang/cargo/pull/9870">https://github.com/rust-lang/cargo/pull/9870</a></p>



<a name="252348560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Mocking%20git%20CLI%20for%20tests/near/252348560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Mocking.20git.20CLI.20for.20tests.html#252348560">(Sep 07 2021 at 18:18)</a>:</h4>
<p>I would set up a test in <code>testsuite</code> that would exercise the real <code>git</code> against one of the real-world conditions that cause a retry.</p>



<a name="252348633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Mocking%20git%20CLI%20for%20tests/near/252348633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Mocking.20git.20CLI.20for.20tests.html#252348633">(Sep 07 2021 at 18:18)</a>:</h4>
<p>If necessary, you can set up a temporary server that has whatever behavior is desired.</p>



<a name="252348696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Mocking%20git%20CLI%20for%20tests/near/252348696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Mocking.20git.20CLI.20for.20tests.html#252348696">(Sep 07 2021 at 18:19)</a>:</h4>
<p>Search through the tests for <code>TcpListener</code> for some examples of where we do that.</p>



<a name="252348761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Mocking%20git%20CLI%20for%20tests/near/252348761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Mocking.20git.20CLI.20for.20tests.html#252348761">(Sep 07 2021 at 18:19)</a>:</h4>
<p><code>testsuite/git.rs</code> and <code>testsuite/git_auth.rs</code> have some examples for git specifically.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>