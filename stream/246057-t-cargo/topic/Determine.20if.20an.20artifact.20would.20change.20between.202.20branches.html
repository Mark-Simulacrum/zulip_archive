<html>
<head><meta charset="utf-8"><title>Determine if an artifact would change between 2 branches · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html">Determine if an artifact would change between 2 branches</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271045422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271045422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Park <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271045422">(Feb 07 2022 at 21:37)</a>:</h4>
<p>Hi all</p>
<p>I need to configure our CI/CD pipeline to be able to detect if a certain branch has actually introduces any changes in the final artifact of a project inside of a workspace. This is needed to cut down the time spent in CI/CD for projects that are not affected by a change. I have looked at the fresh field in the cargo metadata but it doesn't seem that it can predict if a artifact would be changed in this manner. I have also tried doing md5sums on the artifact between the branches (to at least cut out the testing phase of CI) but I can't seem to get that to work even if the final artifact should not be affected by the change in a shared lib (also inside of the workspace). Yes I have ensured that I strip the artifact after compilation but no luck.</p>
<p>Has anyone tackled this issue before?</p>



<a name="271047971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271047971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271047971">(Feb 07 2022 at 21:55)</a>:</h4>
<p>Have you looked at what is actually different between you're no op builds with different hashes?</p>



<a name="271048130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271048130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271048130">(Feb 07 2022 at 21:56)</a>:</h4>
<p>Trying to get bit for bit identical builds is called "reproducible builds", I don't know how close people are to that in rust but it might be a useful search term.</p>



<a name="271050937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271050937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Park <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271050937">(Feb 07 2022 at 22:16)</a>:</h4>
<p>Hmm yeah thanks, that lead me to this issue <a href="https://github.com/rust-lang/rust/issues/34902">https://github.com/rust-lang/rust/issues/34902</a> and the follow up <a href="https://github.com/rust-lang/rust/issues/75362">https://github.com/rust-lang/rust/issues/75362</a>. I will investigate them closer tomorrow. Thanks for the pointer :)</p>



<a name="271193739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271193739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Park <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271193739">(Feb 08 2022 at 21:29)</a>:</h4>
<p>Currently I run <code>env RUSTFLAGS ="-C link-arg=-s -C relocation-model=static" cargo build --release --message-format=json</code> but it doesn't seem that it is enough.Did not manage to track down what else I need to set so if anyone has any other ideas I would appreciate it.</p>



<a name="271196188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271196188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271196188">(Feb 08 2022 at 21:50)</a>:</h4>
<p>You could look at the <code>.d</code> file emitted next to the final artifact. It should list all source dependencies as well as all read env vars (env vars maybe only on nightly)</p>



<a name="271196251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271196251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271196251">(Feb 08 2022 at 21:51)</a>:</h4>
<p>I'm not sure if it also lists all <code>Cargo.toml</code> and the <code>Cargo.lock</code>.</p>



<a name="271478994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271478994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Park <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271478994">(Feb 10 2022 at 19:07)</a>:</h4>
<p>I checked and the .d files on stable did not include any information that I did not already get from the metadata messages :/</p>



<a name="271483167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271483167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271483167">(Feb 10 2022 at 19:37)</a>:</h4>
<p>Are you sure. For me it lists all source files. Eg</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ cat target/debug/foo.d
/data/data/com.termux/files/home/foo/target/debug/foo: /data/data/com.termux/files/home/foo/src/main.rs /data/data/com.termux/files/home/foo/target/debug/build/target-lexicon-536c49ee1f1884eb/out/host.rs
</code></pre></div>



<a name="271483268"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271483268" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271483268">(Feb 10 2022 at 19:37)</a>:</h4>
<p>looks like it is missing most of the source files for the target-lexicon dependency though.</p>



<a name="271634118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271634118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Park <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271634118">(Feb 11 2022 at 20:41)</a>:</h4>
<p>Ok, yeah it had a list of files but that doesn't help if say your <a href="http://host.rs">host.rs</a> in target-lexicon contains 2 functions and the binary only uses one of them (so an update should only be triggered if that one changes).</p>



<a name="271635358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271635358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271635358">(Feb 11 2022 at 20:52)</a>:</h4>
<p>Cargo only operates at a file level. You're not going to be able to get more detailed info from cargo.<br>
And remember that line numbers are part of debug info, if the function that changed moved what line numbers the function you used was on you will get a different artifact.<br>
You may be able to get more out of "incremental" within rustc, don't know how well that can be introspected.</p>



<a name="271636263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271636263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Park <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271636263">(Feb 11 2022 at 21:00)</a>:</h4>
<p>My current approach is to strip debug info and disable the relocation-model in hope that it would give a reproducible artifact.</p>



<a name="271636352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271636352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Park <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271636352">(Feb 11 2022 at 21:01)</a>:</h4>
<p>I'm not concerned with any security of the final artifact, as all I want to do is to determine if a workflow should run or not for this workspace project.</p>



<a name="271640199"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271640199" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271640199">(Feb 11 2022 at 21:29)</a>:</h4>
<p>Rustc requires recompiling the entire crate if any source file or any dependency changes. Rustc doesn't provide any way to recompile only some source files as all codegen units of a crate may be affected by a change in any source file. For example if you change an <code>#[inline]</code> function inlined into all codegen units. Changing an unused function may also change the abi of a used function when optimizing. In addition rustc flat out refuses compilation when any library is recompiled without recompiling all dependent libraries that are (directly or indirectly) used by the current crate. This even applies to whitespace only changes without debuginfo. A hash of among other things, all source files is used as unique identifier to check if a recompilation is necessary. Also even without debuginfo source locations are significant. Some end up in the final executable through <code>file!()</code>, <code>line!()</code>, <code>column!()</code> and <code>#[track_caller]</code> (the later used by all panics) They also end up in the crate metadata for cross crate diagnostics like pointing to the definition of a trait for which an implementation is missing a function.</p>



<a name="271641168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271641168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Park <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271641168">(Feb 11 2022 at 21:35)</a>:</h4>
<p>Hmm, ok. I guess that approach won't work then :/</p>



<a name="271641437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271641437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271641437">(Feb 11 2022 at 21:37)</a>:</h4>
<blockquote>
<p>I need to configure our CI/CD pipeline to be able to detect if a certain branch has actually introduces any changes in the final artifact of a project inside of a workspace. This is needed to cut down the time spent in CI/CD for projects that are not affected by a change. </p>
</blockquote>
<p>Have you looked at <a href="https://github.com/facebookincubator/cargo-guppy/tree/main/tools/determinator">determinator</a> to see if that helps?  Its goal is stated as "Figure out what packages in a Rust workspace changed between two commits.".</p>



<a name="271642354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Determine%20if%20an%20artifact%20would%20change%20between%202%20branches/near/271642354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fredrik Park <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Determine.20if.20an.20artifact.20would.20change.20between.202.20branches.html#271642354">(Feb 11 2022 at 21:46)</a>:</h4>
<p>I have not stumbled across it during my investigations. Will take a look at how it performs.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>