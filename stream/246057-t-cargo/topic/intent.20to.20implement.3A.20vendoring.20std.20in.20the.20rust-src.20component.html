<html>
<head><meta charset="utf-8"><title>intent to implement: vendoring std in the rust-src component · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html">intent to implement: vendoring std in the rust-src component</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="215724259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215724259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215724259">(Nov 05 2020 at 15:09)</a>:</h4>
<p>Going to be looking at implementing the design ehuss describes in this issue: <a href="https://github.com/rust-lang/wg-cargo-std-aware/issues/23">https://github.com/rust-lang/wg-cargo-std-aware/issues/23</a></p>



<a name="215724532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215724532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215724532">(Nov 05 2020 at 15:10)</a>:</h4>
<p>this will require: </p>
<ol>
<li>changing the code for creating the rust-src component so it vendors (somehow) the libtest/libstd dependencies</li>
<li>changing -Zbuild-std to grab that vendor and incorporate it into the build (<code>[patch]</code>?)</li>
<li>possibly adding a mode to <code>cargo vendor</code> to provide the infra for step 1</li>
</ol>



<a name="215724842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215724842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215724842">(Nov 05 2020 at 15:13)</a>:</h4>
<p>Not sure who needs to be roped in to make this an officially supported plan</p>



<a name="215724881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215724881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215724881">(Nov 05 2020 at 15:13)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="120518">@Eric Huss</span> and <span class="user-mention" data-user-id="116015">@Alex Crichton</span></p>



<a name="215724937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215724937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215724937">(Nov 05 2020 at 15:13)</a>:</h4>
<p>I'd be less certain about step 3 but otherwise sounds good to me!</p>



<a name="215725020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215725020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215725020">(Nov 05 2020 at 15:14)</a>:</h4>
<p>now where the heck is the rust-src generator xp</p>



<a name="215725123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215725123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215725123">(Nov 05 2020 at 15:15)</a>:</h4>
<p>There's a link in the issue: <a href="https://github.com/rust-lang/rust/blob/4f7612ac1499258025077f1fd05d2f429f9accfb/src/bootstrap/dist.rs#L1026-L1042">https://github.com/rust-lang/rust/blob/4f7612ac1499258025077f1fd05d2f429f9accfb/src/bootstrap/dist.rs#L1026-L1042</a></p>



<a name="215725157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215725157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215725157">(Nov 05 2020 at 15:15)</a>:</h4>
<p>oh great, thanks!</p>



<a name="215726000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215726000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215726000">(Nov 05 2020 at 15:21)</a>:</h4>
<p>On the Cargo side, the patches would go here: <a href="https://github.com/rust-lang/cargo/blob/d5556aeb8405b1fe696adb6e297ad7a1f2989b62/src/cargo/core/compiler/standard_lib.rs#L41-L56">https://github.com/rust-lang/cargo/blob/d5556aeb8405b1fe696adb6e297ad7a1f2989b62/src/cargo/core/compiler/standard_lib.rs#L41-L56</a>  It would need to go through the vendor directory and add a patch for each.  It can <em>probably</em> assume the directory name is the same as the package name?  I'm not sure if that's safe.  And hopefully there is never more than one version of the same package, but that could also be a problem.</p>



<a name="215726802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215726802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215726802">(Nov 05 2020 at 15:26)</a>:</h4>
<p>how manicured is the rust vendor? does anyone freak out if e.g. there's two versions of libc or something?</p>



<a name="215727880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215727880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215727880">(Nov 05 2020 at 15:33)</a>:</h4>
<p>I'm not sure I understand the question.  The vendor in <code>PlainSourceTarball</code> is just "everything".  For the <code>rust-src</code> vendor, it should just be the standard-lib dependencies, so in that sense it should be pretty minimal.  My concern about having multiple versions of dependencies is that creating the <code>patch</code> entries in Cargo might be awkward. But maybe it'll be fine, I dunno.  I don't think there are any dupes presently, but there might be in the future (but hopefully not).</p>



<a name="215728310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215728310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215728310">(Nov 05 2020 at 15:36)</a>:</h4>
<p>right, just wondering if that was anyone vigilant about that, or if it was just vaguely desirable</p>



<a name="215728355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215728355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215728355">(Nov 05 2020 at 15:36)</a>:</h4>
<p>IIRC there's no CI preventing duplicate versions</p>



<a name="215728365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215728365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215728365">(Nov 05 2020 at 15:36)</a>:</h4>
<p>so with some testing it looks like running <code>cargo vendor</code> in the libtest directory just... does the right thing?</p>



<a name="215728466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215728466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215728466">(Nov 05 2020 at 15:37)</a>:</h4>
<p>As far as building a clean vendor for just building it, lockfile auto-included</p>



<a name="215728529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215728529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215728529">(Nov 05 2020 at 15:37)</a>:</h4>
<p>evidently only <code>-s</code> has issues seeing the lockfile</p>



<a name="215728649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215728649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215728649">(Nov 05 2020 at 15:38)</a>:</h4>
<p>we could also pass <code>--versioned-dirs</code> to always have the version</p>



<a name="215728677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215728677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215728677">(Nov 05 2020 at 15:38)</a>:</h4>
<p>instead of sometimes having it and sometimes not</p>



<a name="215728693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215728693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215728693">(Nov 05 2020 at 15:38)</a>:</h4>
<p>true</p>



<a name="215740900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215740900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215740900">(Nov 05 2020 at 16:54)</a>:</h4>
<p>What's the magic/problem that rustc-std-workspace-core fake package is handling? The actual Cargo.tomls in the rustc source just use relative paths.</p>



<a name="215741173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215741173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215741173">(Nov 05 2020 at 16:56)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> It is described here: <a href="https://github.com/rust-lang/rust/blob/master/library/rustc-std-workspace-core/README.md">https://github.com/rust-lang/rust/blob/master/library/rustc-std-workspace-core/README.md</a></p>



<a name="215741211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215741211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215741211">(Nov 05 2020 at 16:56)</a>:</h4>
<p>ah, just found that, thanks :)</p>



<a name="215741363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215741363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215741363">(Nov 05 2020 at 16:57)</a>:</h4>
<p>"Crates on <a href="http://crates.io">crates.io</a> that the standard library depend on the rustc-std-workspace-core crate from <a href="http://crates.io">crates.io</a>" reads like some words are missing</p>



<a name="215741644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215741644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215741644">(Nov 05 2020 at 16:59)</a>:</h4>
<p>huh neat: <a href="https://github.com/rust-lang/getopts/blob/master/Cargo.toml#L18-L19">https://github.com/rust-lang/getopts/blob/master/Cargo.toml#L18-L19</a></p>



<a name="215741653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215741653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215741653">(Nov 05 2020 at 16:59)</a>:</h4>
<p>Yea, probably add the word <code>use</code>:  <code>depend on use the ...</code></p>



<a name="215748493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215748493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215748493">(Nov 05 2020 at 17:44)</a>:</h4>
<p>Is there a special utility in cargo I should be using to slurp up e.g. vendor/addr2line-0.13.0 into a Dependency, or should I just parse the version out of the file name and feed it into Dependency::parse_no_deprecated?</p>



<a name="215750364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215750364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215750364">(Nov 05 2020 at 17:58)</a>:</h4>
<p>There isn't anything I know of that will separate the name from the version. That's what I was concerned about in terms of having versions in the directory name (which would be required if there are multiple versions of a dependency).  Maybe <code>rsplit</code> on <code>-</code> and hope versions don't have dashes?  That seems too brittle, though.  It seems overkill to open each <code>Cargo.toml</code> and read it, though.  I don't have any particular good ideas for that.</p>



<a name="215750423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215750423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215750423">(Nov 05 2020 at 17:58)</a>:</h4>
<p>ah hmm</p>



<a name="215750434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215750434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215750434">(Nov 05 2020 at 17:58)</a>:</h4>
<p>well I already have to deal with wasi-0.9.0+wasi-snapshot-preview1</p>



<a name="215750554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215750554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215750554">(Nov 05 2020 at 17:59)</a>:</h4>
<p>I will ponder this</p>



<a name="215750818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215750818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215750818">(Nov 05 2020 at 18:01)</a>:</h4>
<p>not 100% clear on how the <code>patch</code> API works internally though. I'm <em>assuming</em> it uses the version argument to check if it should patch a given crate lookup.</p>



<a name="215750856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215750856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215750856">(Nov 05 2020 at 18:01)</a>:</h4>
<p>Which presumably it would be good to only patch exactly the versions std uses</p>



<a name="215750888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215750888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215750888">(Nov 05 2020 at 18:01)</a>:</h4>
<p>(or do we remove the patch once done building std?)</p>



<a name="215751935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215751935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215751935">(Nov 05 2020 at 18:09)</a>:</h4>
<p>std is built as a temporary, independent workspace, so the patches added only apply to that temporary workspace.  The version should not be included in the patch. Conceptually it is:</p>
<div class="codehilite"><pre><span></span><code>[patch.crates-io]
libc = { path = &quot;vendor/libc&quot; }
# etc.
</code></pre></div>
<p>So in the API to create those patches, it creates a <code>SourceId</code> for each directory (<code>SoruceId::for_path</code>), a <code>Dependency</code> (name="libc", version=None, source_id). And those entries are inserted into the <code>patch</code> table. Patches just "overlay" the normal <a href="http://crates.io">crates.io</a> registry, so there's no need to specify a version or features or anything.</p>



<a name="215760264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215760264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215760264">(Nov 05 2020 at 19:13)</a>:</h4>
<p>how does one resolve patches for two different versions, then?</p>



<a name="215760707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215760707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215760707">(Nov 05 2020 at 19:17)</a>:</h4>
<p>You have to use rename syntax like this:</p>
<div class="codehilite"><pre><span></span><code>log = {path=&quot;log&quot;}
log2 = {path=&quot;log2&quot;, package=&quot;log&quot;}
</code></pre></div>
<p>The name on the left (<code>log2</code> in this case) is ignored.</p>



<a name="215772150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215772150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215772150">(Nov 05 2020 at 20:50)</a>:</h4>
<p>So thinking about this, I think it would be a reasonable limitation that the rust-src component will either fail to build or be unvendorable if there are multiple versions of a crate</p>



<a name="215772220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215772220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215772220">(Nov 05 2020 at 20:51)</a>:</h4>
<p>the vendor usecase is probably pining compilers anyway</p>



<a name="215772231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215772231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215772231">(Nov 05 2020 at 20:51)</a>:</h4>
<p>(firefox is, certainly)</p>



<a name="215781307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215781307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215781307">(Nov 05 2020 at 22:14)</a>:</h4>
<p>Nice, I have a minimal working version</p>



<a name="215782233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215782233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215782233">(Nov 05 2020 at 22:26)</a>:</h4>
<p><a href="https://github.com/rust-lang/cargo/pull/8834">https://github.com/rust-lang/cargo/pull/8834</a></p>



<a name="215782284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/215782284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#215782284">(Nov 05 2020 at 22:26)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/78790">https://github.com/rust-lang/rust/pull/78790</a></p>



<a name="216097567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216097567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216097567">(Nov 09 2020 at 15:16)</a>:</h4>
<p><span class="user-mention" data-user-id="116015">@Alex Crichton</span> I assume --frozen/--locked/--no-delete won't actually do the specific thing I want here, in that if modifications would happen to the lock, it would just error?</p>



<a name="216097684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216097684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216097684">(Nov 09 2020 at 15:17)</a>:</h4>
<p>correct</p>



<a name="216099093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216099093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216099093">(Nov 09 2020 at 15:27)</a>:</h4>
<p><span class="user-mention" data-user-id="116015">@Alex Crichton</span> what exactly does it mean to "update the lock"? That only makes sense to me if a Cargo.toml has been edited and now a dependency conflict exists, but certainly I'm not editing the versions listed in any Cargo.toml..?</p>



<a name="216099231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216099231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216099231">(Nov 09 2020 at 15:28)</a>:</h4>
<p>(Also I made a mini version of what I'm doing with workspaces and it... does what I want?)</p>



<a name="216099295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216099295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216099295">(Nov 09 2020 at 15:28)</a>:</h4>
<p>I guess missing tomls could prompt deletions from the lock..?</p>



<a name="216099400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216099400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216099400">(Nov 09 2020 at 15:29)</a>:</h4>
<p>Ah yeah, the temp lock I copy in definitely gets edited</p>



<a name="216100024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216100024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216100024">(Nov 09 2020 at 15:33)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> so the top-level <code>Cargo.lock</code> encompasses the entire rustc workspace, but the workspace of the rust-src component is much smaller and doesn't have as many dependencies. As a result vendoring will update the lock file it's given because the lock file has a superset of dependencies</p>



<a name="216100074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216100074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216100074">(Nov 09 2020 at 15:33)</a>:</h4>
<p>Yeah agreed. I just don't get why that would change the root lock</p>



<a name="216100146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216100146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216100146">(Nov 09 2020 at 15:34)</a>:</h4>
<p>does Builder's API secretly do symlinky stuff...?</p>



<a name="216101859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216101859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216101859">(Nov 09 2020 at 15:45)</a>:</h4>
<p><span class="user-mention" data-user-id="137587">@Gankra</span> it does sort of -- <a href="https://github.com/rust-lang/rust/blob/25f6938da459a57b43bdf16ed6bdad3225b2a3ce/src/bootstrap/lib.rs#L1188-L1191">https://github.com/rust-lang/rust/blob/25f6938da459a57b43bdf16ed6bdad3225b2a3ce/src/bootstrap/lib.rs#L1188-L1191</a></p>



<a name="216101866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216101866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216101866">(Nov 09 2020 at 15:45)</a>:</h4>
<p>it hard links which would probably cause issues here</p>



<a name="216101984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216101984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216101984">(Nov 09 2020 at 15:46)</a>:</h4>
<p>yep, just found that too</p>



<a name="216101987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216101987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216101987">(Nov 09 2020 at 15:46)</a>:</h4>
<p>hmm</p>



<a name="216102443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216102443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216102443">(Nov 09 2020 at 15:49)</a>:</h4>
<p>Oh huh, so the dirs themselves aren't hardlinked</p>



<a name="216102476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216102476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216102476">(Nov 09 2020 at 15:49)</a>:</h4>
<p>so I can probably just use fs::copy directly with a comment</p>



<a name="216130724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216130724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216130724">(Nov 09 2020 at 19:15)</a>:</h4>
<p><span class="user-mention" data-user-id="120518">@Eric Huss</span> r? <a href="https://github.com/rust-lang/cargo/pull/8834">https://github.com/rust-lang/cargo/pull/8834</a> (the rust half is about to land)</p>



<a name="216130845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216130845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gankra <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216130845">(Nov 09 2020 at 19:16)</a>:</h4>
<p>(alternatively do you just wanna ship it, <span class="user-mention" data-user-id="116015">@Alex Crichton</span> ?)</p>



<a name="216135955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/intent%20to%20implement%3A%20vendoring%20std%20in%20the%20rust-src%20component/near/216135955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/intent.20to.20implement.3A.20vendoring.20std.20in.20the.20rust-src.20component.html#216135955">(Nov 09 2020 at 19:58)</a>:</h4>
<p>let's give ehuss a bit more time to take a look if he'd like</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>