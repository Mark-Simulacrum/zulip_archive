<html>
<head><meta charset="utf-8"><title>cargo-install-resolving · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo-install-resolving.html">cargo-install-resolving</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="256809361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo-install-resolving/near/256809361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo-install-resolving.html#256809361">(Oct 08 2021 at 21:35)</a>:</h4>
<p>Hi all! I've been digging through various Cargo resolver logic recently because I have to do some finagling in the context of another build system. And this particular resolver call-chain for <code>cargo install</code> has me confused:</p>
<ol>
<li><code>cargo install</code> calls <code>resolve_ws</code>: <a href="https://github.com/rust-lang/cargo/blob/0.56.0/src/cargo/ops/cargo_install.rs#L662">https://github.com/rust-lang/cargo/blob/0.56.0/src/cargo/ops/cargo_install.rs#L662</a></li>
<li><code>resolve_ws</code> calls <code>resolve_with_registry</code>: <a href="https://github.com/rust-lang/cargo/blob/0.56.0/src/cargo/ops/resolve.rs#L67">https://github.com/rust-lang/cargo/blob/0.56.0/src/cargo/ops/resolve.rs#L67</a></li>
<li>
<p><code>resolve_with_registry</code> calls <code>resolve_with_previous</code> with <code>CliFeatures::new_all(true)</code> and <code>HasDevUnits::Yes</code>: <a href="https://github.com/rust-lang/cargo/blob/0.56.0/src/cargo/ops/resolve.rs#L180-L181">https://github.com/rust-lang/cargo/blob/0.56.0/src/cargo/ops/resolve.rs#L180-L181</a><br>
   This means (if I understand correctly) that it resolves as if all features are enabled _and_ <code>dev-dependencies</code> should be considered.</p>
</li>
<li>
<p><code>resolve_ws</code> calls <code>get_resolved_packages</code>: <a href="https://github.com/rust-lang/cargo/blob/0.56.0/src/cargo/ops/resolve.rs#L68">https://github.com/rust-lang/cargo/blob/0.56.0/src/cargo/ops/resolve.rs#L68</a></p>
</li>
</ol>
<p>Taken together, this call-chain makes it seem like <code>cargo install</code> downloads potentially a _lot_ more dependencies than are actually needed by the following build. Am I missing something in the chain here that makes that not be the case?</p>
<p><span class="user-mention" data-user-id="120179">@Eh2406</span> suggested I specifically ping you about this <span class="user-mention" data-user-id="120518">@Eric Huss</span></p>



<a name="256809667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo-install-resolving/near/256809667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo-install-resolving.html#256809667">(Oct 08 2021 at 21:38)</a>:</h4>
<p>Now, ^ is _only_ the case when <code>check_yanked_install</code> is called, so it may not be _as_ much of a problem — I'm not sure how common that is?</p>



<a name="256811396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo-install-resolving/near/256811396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo-install-resolving.html#256811396">(Oct 08 2021 at 21:55)</a>:</h4>
<p><span class="user-mention" data-user-id="120054">@Jon Gjengset</span> That shouldn't download any packages, that query should only be hitting the index.</p>



<a name="256811608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo-install-resolving/near/256811608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo-install-resolving.html#256811608">(Oct 08 2021 at 21:57)</a>:</h4>
<p><code>get_resolved_packages</code> only creates a <code>PackageSet</code>, but the packages there are lazily loaded (<code>PackageSet::new</code> gets things ready to download, but doesn't actually download anything)</p>



<a name="256811683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo-install-resolving/near/256811683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo-install-resolving.html#256811683">(Oct 08 2021 at 21:58)</a>:</h4>
<p>Ahhh, yes, I see it now. Phew, okay, good. Thanks! Glad it was nothing :)</p>



<a name="256811729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo-install-resolving/near/256811729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo-install-resolving.html#256811729">(Oct 08 2021 at 21:58)</a>:</h4>
<p>Even so, it feels weird that it resolves differently from the actual build, no?</p>



<a name="256812386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo-install-resolving/near/256812386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo-install-resolving.html#256812386">(Oct 08 2021 at 22:04)</a>:</h4>
<p>Hm, I suppose it is possible that it would issue a warning for an optional dependency that is not enabled.</p>



<a name="256812657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo-install-resolving/near/256812657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo-install-resolving.html#256812657">(Oct 08 2021 at 22:07)</a>:</h4>
<p>It would also make a difference once we get something like HTTP registries where fetching more things from the index actually affects resolution time in a meaningful way.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>