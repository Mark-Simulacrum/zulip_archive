<html>
<head><meta charset="utf-8"><title>cargo metadata with binary git dep · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html">cargo metadata with binary git dep</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="253178238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253178238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253178238">(Sep 13 2021 at 23:54)</a>:</h4>
<p>Am I doing something wrong or did I find a cargo bug? </p>
<div class="codehilite"><pre><span></span><code>[package]
name = &quot;test_metadata&quot;
version = &quot;0.1.0&quot;
edition = &quot;2018&quot;

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html

[dependencies]
alloca = &quot;*&quot;
console-api = { git = &quot;https://github.com/guswynn/console.git&quot;, rev= &quot;55179438c7af5325bcf47f8092781c5c2298207c&quot;}
tokio-console = { git = &quot;https://github.com/guswynn/console.git&quot;, rev= &quot;55179438c7af5325bcf47f8092781c5c2298207c&quot;}
</code></pre></div>
<p>with <code>cargo metadata</code>, I get <code>alloca</code> (a binary crate) as a package, and <code>console-api</code> (a git lib crate), but NOT <code>tokio-console</code>, which is a git, binary crate</p>



<a name="253178993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253178993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Wagner-Hall <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253178993">(Sep 14 2021 at 00:02)</a>:</h4>
<p>Cargo metadata doesn't currently report binary deps at all</p>



<a name="253179025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253179025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253179025">(Sep 14 2021 at 00:03)</a>:</h4>
<p>Hm, I can see how that is a little confusing.  <code>cargo metadata</code> only includes library dependencies in the "resolve" graph, as it needs something to put in for the "name" field.  A package without a library won't have a value to put there.</p>



<a name="253179072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253179072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253179072">(Sep 14 2021 at 00:03)</a>:</h4>
<p>FWIW, cargo now warns about such dependencies.</p>



<a name="253179159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253179159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253179159">(Sep 14 2021 at 00:04)</a>:</h4>
<p><code>cargo metadata | jq .resolve.nodes | jq -r '.[]|select(.id | startswith("XXX"))'</code> works if you want to play around</p>



<a name="253179264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253179264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253179264">(Sep 14 2021 at 00:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="336670">Daniel Wagner-Hall</span> <a href="#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253178993">said</a>:</p>
<blockquote>
<p>Cargo metadata doesn't currently report binary deps at all</p>
</blockquote>
<p>but it seems to work with alloca? is that because it has a binary and a lib dep?</p>



<a name="253179353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253179353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Wagner-Hall <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253179353">(Sep 14 2021 at 00:05)</a>:</h4>
<p>FWIW I've been meaning to chime in on <a href="https://github.com/rust-lang/rfcs/pull/3168">https://github.com/rust-lang/rfcs/pull/3168</a> about this too, as it may be a reasonable place to reconsider this - I've been wanting binary deps in <code>cargo metadata</code> too :)</p>



<a name="253179443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253179443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Wagner-Hall <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253179443">(Sep 14 2021 at 00:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257428">Gus Wynn</span> <a href="#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253179264">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="336670">Daniel Wagner-Hall</span> <a href="#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253178993">said</a>:</p>
<blockquote>
<p>Cargo metadata doesn't currently report binary deps at all</p>
</blockquote>
<p>but it seems to work with alloca? is that because it has a binary and a lib dep?</p>
</blockquote>
<p>Yes, exactly - it's "pure" binary deps which are not reported</p>



<a name="253179506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253179506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253179506">(Sep 14 2021 at 00:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120518">Eric Huss</span> <a href="#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253179025">said</a>:</p>
<blockquote>
<p>Hm, I can see how that is a little confusing.  <code>cargo metadata</code> only includes library dependencies in the "resolve" graph, as it needs something to put in for the "name" field.  A package without a library won't have a value to put there.</p>
</blockquote>
<p>context is I am using a tool that consumes cargo vendor and cargo metadata to auto-generate build deps <br>
I could make a PR to have the tokio-console have an empty lib dep, but that seems kindof heavy weight, is there no way  around this?</p>



<a name="253179654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253179654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Wagner-Hall <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253179654">(Sep 14 2021 at 00:08)</a>:</h4>
<p>We do something similar in <a href="https://github.com/google/cargo-raze">https://github.com/google/cargo-raze</a> - our hack is pretty nasty, we create a workspace crate with the same name and use <a href="https://github.com/ehuss/cargo-clone-crate">https://github.com/ehuss/cargo-clone-crate</a> to give it the same deps as the real crate, then we retrofit the data we need to the workspace crate (which _will_ appear in the resolve)</p>



<a name="253179675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253179675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Wagner-Hall <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253179675">(Sep 14 2021 at 00:08)</a>:</h4>
<p>But would be interested in getting binary-only deps into the resolve graph at some point! If we can sketch out the details, I'd be happy to give a go at implementing</p>



<a name="253179909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253179909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253179909">(Sep 14 2021 at 00:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="336670">Daniel Wagner-Hall</span> <a href="#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253179654">said</a>:</p>
<blockquote>
<p>We do something similar in <a href="https://github.com/google/cargo-raze">https://github.com/google/cargo-raze</a> - our hack is pretty nasty, we create a workspace crate with the same name and use <a href="https://github.com/ehuss/cargo-clone-crate">https://github.com/ehuss/cargo-clone-crate</a> to give it the same deps as the real crate, then we retrofit the data we need to the workspace crate (which _will_ appear in the resolve)</p>
</blockquote>
<p>oh thats quite brutal, i will look into that. I also will see if the tokio folks are okay with me adding an empty lib crate</p>



<a name="253179950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253179950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253179950">(Sep 14 2021 at 00:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="336670">Daniel Wagner-Hall</span> <a href="#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253179675">said</a>:</p>
<blockquote>
<p>But would be interested in getting binary-only deps into the resolve graph at some point! If we can sketch out the details, I'd be happy to give a go at implementing</p>
</blockquote>
<p>is there an understanding of how ahrd this would be?</p>



<a name="253180135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253180135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Wagner-Hall <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253180135">(Sep 14 2021 at 00:14)</a>:</h4>
<p>(I'm not a cargo team person): I think just adding the data in isn't particularly hard, the tricky thing is what the presence in the resolve graph _means_ given there are multiple proposals out there to have binary deps actually have meaning</p>



<a name="253180259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253180259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Wagner-Hall <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253180259">(Sep 14 2021 at 00:16)</a>:</h4>
<p>If we just added them as nodes to the resolve graph, and didn't list them as deps, that's weird. If we did list them as deps in the graph, but as far as cargo is concerned the dep is meaningless and unused, that's also weird. We could maybe carve out a new <code>dep_kinds</code> value for them, but it would be kind of weird to do so given the only people actually using the metadata at the moment are people kind of cheating cargo...</p>



<a name="253180344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253180344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Wagner-Hall <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253180344">(Sep 14 2021 at 00:17)</a>:</h4>
<p>Which is why I was kind of hoping to piggy-back this onto <a href="https://github.com/rust-lang/rfcs/pull/3168">https://github.com/rust-lang/rfcs/pull/3168</a> or <a href="https://github.com/rust-lang/rfcs/pull/3028">https://github.com/rust-lang/rfcs/pull/3028</a>, so that we're actually attaching meaning to the dep in cargo, not just tacking on kinda-fake data</p>



<a name="253182141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253182141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253182141">(Sep 14 2021 at 00:43)</a>:</h4>
<p>I guess my argument is if "you add an empty <code>lib.rs</code> to  a binary cargo package, then ur binary target shows up in the resolve graph" is true (it is), then the semantics of binary targets in the resolve graph is already well-known, if not documented</p>



<a name="253182164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/cargo%20metadata%20with%20binary%20git%20dep/near/253182164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gus Wynn <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep.html#253182164">(Sep 14 2021 at 00:43)</a>:</h4>
<p>the dep is meaningless, but the presence of the target is not (also the dep is NOT meaningless, when running <code>cargo vendor</code></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>