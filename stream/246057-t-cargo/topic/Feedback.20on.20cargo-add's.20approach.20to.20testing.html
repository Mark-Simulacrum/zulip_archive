<html>
<head><meta charset="utf-8"><title>Feedback on cargo-add&#x27;s approach to testing · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Feedback.20on.20cargo-add&#x27;s.20approach.20to.20testing.html">Feedback on cargo-add&#x27;s approach to testing</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274614146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Feedback%20on%20cargo-add%27s%20approach%20to%20testing/near/274614146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Feedback.20on.20cargo-add&#x27;s.20approach.20to.20testing.html#274614146">(Mar 08 2022 at 22:03)</a>:</h4>
<p>I'm looking for feedback on how I'm testing <code>cargo-add</code> to see if</p>
<ul>
<li>There are concerns with it for when merging into cargo</li>
<li>If there would be interest in moving other cargo tests over to this style</li>
</ul>
<p>cargo-add is doing snapshot testing using <a href="https://docs.rs/snapbox/latest/snapbox/index.html">snapbox</a>, a snapshot testing toolbox</p>
<ul>
<li><a href="https://github.com/killercup/cargo-edit/blob/merge-add/crates/cargo-add/tests/cargo-add.rs">test definitions</a></li>
<li><a href="https://github.com/killercup/cargo-edit/tree/merge-add/crates/cargo-add/tests/snapshots/add">fixtures and snapshots</a></li>
</ul>
<p>You can think of <code>snapbox</code> as a cargo-agnostic subset of <code>cargo-test-support</code>.  It was extracted from <code>trycmd</code>.  cargo-add had been using <code>trycmd</code>, an end-to-end CLI testing crate inspired by <code>trybuild</code> and <code>cargo-test-support</code>.  </p>
<ul>
<li>The primary motivation for switching to <code>trycmd</code> was to make it easier to update the output as I went through feedback and as output changed as I switched from custom logic to building against cargo.</li>
<li>An unexpected benefit came up which is it "increased our coverage" in that we were more extensively testing our success and error output and made it more obvious that we had problems to fix (now fixed). </li>
</ul>
<p>The limitation with <code>trycmd</code> that was causing me problems is the need for programmtic fixtures, like local registries, git depednencies, etc.  cargo-add's tests is using test data triggered by a <code>CARGO_IS_TEST</code> env variable but this</p>
<ul>
<li>Reduced fidelity of the tests because we weren't testing all production code</li>
<li>Cargo's registry code has some architectural constraints, compared to <code>crates-index</code> that combined with <code>CARGO_IS_TEST</code>would add some unnecessary complexity compared to not using <code>CARGO_IS_TEST</code></li>
</ul>
<p>So as I work to get <code>cargo-add</code> to use cargo's registry code, I needed to drop <code>CARGO_IS_TEST</code> and integrate with <code>cargo-test-support</code>s registry fixture code, which led to <code>snapbox</code> (I had already been meaning to write it for clap, just no forcing function yet existed).</p>
<p><code>snapbox</code> compared to <code>cargo-test-support</code></p>
<ul>
<li>Both support variable substitution, path-separator and newline normalization, and <code>[..]</code> wildcards</li>
<li><code>snapbox</code> shows diffs like <code>cargo-test-support</code> except it will highlight differences within a line (esp useful for trailing whitespace) and has a special glyph to highlight no-newline (tempted to add glyphs for other invisible differences)</li>
<li><code>snabox</code> does not yet have json support like <code>cargo-test-support</code></li>
<li><code>snapbox</code> supports expected results to be sourced in a file and updated by running <code>SNAPSHOTS=overwrite cargo test</code> (failures tell you how to do this)</li>
<li><code>snapbox</code> has tried to align dependencies with <code>cargo</code> to keep build times down.  New dependencies are <code>normalize-line-endings</code>, <code>content_inspector</code>, <code>dunce</code>, <code>similar</code> (replaces need for bespoke diff algorithm in <code>cargo-test-support</code>),  <code>yansi</code>, and <code>concolor</code> (all are are light dependencies)</li>
</ul>
<p>Why <code>snapbox</code> over <code>insta</code>, the most popular snapshot testing crate I'm aware of</p>
<ul>
<li>Built-in support CLI concerns, like directory snapshots and <code>std::process::Command</code> output snapshots</li>
<li>Snapshots are not a custom file format and you can run regular tools on them, get syntax highlighting, can be user-readable for documentation, etc</li>
<li>Includes directory fixture support for easily converting a reproduction case into a test</li>
</ul>
<p>If we go forward with this</p>
<ul>
<li>Without converting all at once, we can switch <code>cargo-test-support</code>s diff to using the same style as <code>snapbox</code></li>
<li>In merging <code>cargo-add</code> into cargo, I'd refactor to share the <code>Command</code> initialization between existing <code>cargo-test-support</code> and this</li>
</ul>



<a name="274614376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Feedback%20on%20cargo-add%27s%20approach%20to%20testing/near/274614376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Feedback.20on.20cargo-add&#x27;s.20approach.20to.20testing.html#274614376">(Mar 08 2022 at 22:05)</a>:</h4>
<p>I like the concept of this, especially if you intend to support snapbox more broadly.</p>



<a name="274614568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Feedback%20on%20cargo-add%27s%20approach%20to%20testing/near/274614568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Feedback.20on.20cargo-add&#x27;s.20approach.20to.20testing.html#274614568">(Mar 08 2022 at 22:06)</a>:</h4>
<p><code>snapbox</code> is now being used by<code> clap_complete</code> and <code>clap_mangen</code>.  I also have several other crates using a predecessor of it that I'll be updating to it, so I am at least supporting it that broadly :).</p>
<p>As I see levels of interest, I'll also be advertising it more broadly.</p>



<a name="274614657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Feedback%20on%20cargo-add%27s%20approach%20to%20testing/near/274614657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed Page <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Feedback.20on.20cargo-add&#x27;s.20approach.20to.20testing.html#274614657">(Mar 08 2022 at 22:07)</a>:</h4>
<p>And <code>trycmd</code> is implemented using <code>snapbox</code> and I'm very much pushing for the use of <code>trycmd</code> :)<br>
(still need to update the <code>rust-cli</code> book to use it)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>