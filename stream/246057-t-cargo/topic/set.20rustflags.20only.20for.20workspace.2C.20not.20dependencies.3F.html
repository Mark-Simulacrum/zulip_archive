<html>
<head><meta charset="utf-8"><title>set rustflags only for workspace, not dependencies? · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html">set rustflags only for workspace, not dependencies?</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="257003254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257003254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257003254">(Oct 11 2021 at 02:23)</a>:</h4>
<p>Is there a way to add flags to rustc for "all path dependencies in the current workspace"? <code>cargo rustc</code> only sets it for a single package, and <code>RUSTFLAGS</code> also sets it for dependencies</p>



<a name="257003604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257003604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257003604">(Oct 11 2021 at 02:30)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> I think you'll need to use <code>RUSTC_WORKSPACE_WRAPPER</code>, and do something like <code>rustc "$@" --my-args</code></p>



<a name="257003969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257003969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257003969">(Oct 11 2021 at 02:36)</a>:</h4>
<p>is "rustc" in that example my custom wrapper?</p>



<a name="257004015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257004015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257004015">(Oct 11 2021 at 02:36)</a>:</h4>
<p>if so I'll probably just add this to <code>bootstrap/bin/rustc.rs</code> directly</p>



<a name="257004710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257004710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257004710">(Oct 11 2021 at 02:48)</a>:</h4>
<p>By <code>rustc</code> I was meaning something like a bash script.</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="ch">#!/bin/bash</span>

rustc <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span> --my-args
</code></pre></div>
<p><code>RUSTC_WORKSPACE_WRAPPER=/path/to/my_wrapper.sh cargo build</code></p>



<a name="257004739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257004739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257004739">(Oct 11 2021 at 02:49)</a>:</h4>
<p>hmm I wonder if we could replace bootstrap/rustc.rs with RUSTC_WORKSPACE_WRAPPER somehow</p>



<a name="257004755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257004755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257004755">(Oct 11 2021 at 02:49)</a>:</h4>
<p>I guess it would still be doing the same thing, just with cargo's knowledge</p>



<a name="257004768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257004768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257004768">(Oct 11 2021 at 02:49)</a>:</h4>
<p><span class="user-mention" data-user-id="120518">@Eric Huss</span> is there a way to tell from the arguments cargo passes whether this is a path dependency or not? I guess whether --cap-lints=allow is present?</p>



<a name="257005034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257005034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257005034">(Oct 11 2021 at 02:54)</a>:</h4>
<p>I can't think of any guaranteed way to do that.  For example <code>-vv</code> changes the lint cap.</p>



<a name="257005158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257005158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257005158">(Oct 11 2021 at 02:56)</a>:</h4>
<p>Hmm, ok :/ my overall goal is to avoid rebuilding all bootstrap's dependencies when <code>deny-warnings = false</code> is flipped, do you know a simple way to do that? trying to avoid an XY problem</p>



<a name="257005433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257005433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257005433">(Oct 11 2021 at 03:01)</a>:</h4>
<p>"just" stop using rustflags and pass the appropriate options via bootstrap/bin/rustc.rs. cap-lints will already mostly avoid trouble with dependencies and such.</p>
<p>But I don't think we should do this; as much as we can avoid any custom invalidation avoidance in bootstrap, we should</p>



<a name="257006000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/set%20rustflags%20only%20for%20workspace%2C%20not%20dependencies%3F/near/257006000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/set.20rustflags.20only.20for.20workspace.2C.20not.20dependencies.3F.html#257006000">(Oct 11 2021 at 03:10)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I was hoping to do it in some cargo-aware way so only path dependencies are rebuilt and not all dependencies</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>