<html>
<head><meta charset="utf-8"><title>external subcommand inherits jobserver fd · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html">external subcommand inherits jobserver fd</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276280259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276280259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Weihang Lo <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276280259">(Mar 23 2022 at 01:58)</a>:</h4>
<p>Hi, I am looking into this issue <a href="https://github.com/rust-lang/cargo/issues/10477">"Don't close jobserver fd when executing external subcommand"</a>.  After skimming the git history, I didn't found any evidence cargo decided not inherhit fd deliberately. I see the use case of <code>cargo-fuzz</code>, which internally calls <code>cargo</code>, is reasonable, so I wonder is there any drawback to let external subcommands get jobserver fd?</p>



<a name="276290419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276290419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276290419">(Mar 23 2022 at 05:29)</a>:</h4>
<p>In the strictest sense of compatibility there is. Inheriting unexpected file descriptors can sometimes (rarely, but sometimes) lead to program misbehavior, if the program doesn't expect any open files other than the ones it opens.</p>



<a name="276290469"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276290469" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276290469">(Mar 23 2022 at 05:30)</a>:</h4>
<p>Bad assumptions about file descriptor numbers, or similar.</p>



<a name="276290477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276290477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276290477">(Mar 23 2022 at 05:30)</a>:</h4>
<p>That said, programs really <em>shouldn't</em> make those assumptions.</p>



<a name="276290528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276290528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276290528">(Mar 23 2022 at 05:31)</a>:</h4>
<p>Most programs written in compiled languages don't, but shell scripts and perl scripts often <em>do</em> because they don't have much choice.</p>



<a name="276290577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276290577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276290577">(Mar 23 2022 at 05:32)</a>:</h4>
<p>For instance, some shell scripts or perl scripts make the assumption that they can open file descriptor 3 or 4.</p>



<a name="276290614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276290614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276290614">(Mar 23 2022 at 05:33)</a>:</h4>
<p>So if file descriptor 3 or 4 is the jobserver fd, they may encounter an error at best, or read/write the jobserver fd incorrectly at worst.</p>



<a name="276290620"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276290620" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276290620">(Mar 23 2022 at 05:33)</a>:</h4>
<p>I <em>think</em> that's part of why make requires an explicit indication to treat a command as a sub-make and pass the jobserver to it.</p>



<a name="276290629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276290629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276290629">(Mar 23 2022 at 05:33)</a>:</h4>
<p><code>+</code> at the start of the command in the makefile.</p>



<a name="276316462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276316462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Weihang Lo <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276316462">(Mar 23 2022 at 11:01)</a>:</h4>
<p>Thanks for the info <span aria-label="praise" class="emoji emoji-1f64c" role="img" title="praise">:praise:</span>  <br>
It's reasonable not to inherit if there are some compatibility concern. Now I tend to leave it as-is, since user has a simple workaround by using the subcommand executable directly (calling <code>+cargo-fuzz</code> instead of <code>+cargo fuzz</code>).</p>



<a name="276352568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276352568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276352568">(Mar 23 2022 at 15:41)</a>:</h4>
<p>Actually, that's an interesting case. If we created the jobserver we can't make any assumptions. But if we received the jobserver from our caller, that implies the <em>caller</em> passed it to us, which suggests they used + or equivalent.</p>



<a name="276352690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276352690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276352690">(Mar 23 2022 at 15:42)</a>:</h4>
<p>So I think if we inherit the jobserver ourselves, we should pass it on to our subcommand.</p>



<a name="276553810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/external%20subcommand%20inherits%20jobserver%20fd/near/276553810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Weihang Lo <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/external.20subcommand.20inherits.20jobserver.20fd.html#276553810">(Mar 24 2022 at 23:41)</a>:</h4>
<p>I am biased after perceiving that <code>cargo-clippy</code> as a custom subcommand is also affected by this behaviour. We probably need to fix it. <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span><br>
However, I found that the behaviour is not align to my expectation. I created a Makefile <code>all: +cargo build</code> and ran <code>make -j1</code>. The concurrency seems not change and differs from a simple <code>cargo build -j1</code>. I thought the two should be the same. Is there anything I did incorrect or it's expected?</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>