<html>
<head><meta charset="utf-8"><title>double free · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html">double free</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261574541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261574541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261574541">(Nov 15 2021 at 23:12)</a>:</h4>
<p><span class="user-mention" data-user-id="116015">@Alex Crichton</span> Did you follow the discussion about the double free issue with curl?</p>



<a name="261574934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261574934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261574934">(Nov 15 2021 at 23:16)</a>:</h4>
<p>only somewhat, not closely, but AFAIK it's all related to dropping a <code>Multi</code> while there's <code>Easy</code> handles still inside it, which I don't think Cargo runs afoul of</p>



<a name="261574953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261574953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261574953">(Nov 15 2021 at 23:16)</a>:</h4>
<p>except maybe for panics I suppose</p>



<a name="261574972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261574972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261574972">(Nov 15 2021 at 23:16)</a>:</h4>
<p>Yea, I just wanted to double check that it was unlikely to be an issue.</p>



<a name="261574978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261574978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261574978">(Nov 15 2021 at 23:16)</a>:</h4>
<p>I think it was coming up with a user using a proxy.</p>



<a name="261574986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261574986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261574986">(Nov 15 2021 at 23:16)</a>:</h4>
<p>And the proxy returned an error.</p>



<a name="261575015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575015">(Nov 15 2021 at 23:17)</a>:</h4>
<p>The reason I ask is that we have been seeing a high rate of SIGSEGV on rust-lang CI.</p>



<a name="261575031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575031">(Nov 15 2021 at 23:17)</a>:</h4>
<p>But just recently an error hit cargo with a double free.</p>



<a name="261575036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575036">(Nov 15 2021 at 23:17)</a>:</h4>
<p>oh I may be recalling the wrong issue though</p>



<a name="261575044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575044">(Nov 15 2021 at 23:17)</a>:</h4>
<p>And I can't tell if the two are related.</p>



<a name="261575063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575063">(Nov 15 2021 at 23:17)</a>:</h4>
<p>something I thought may have been fixed with 7.80.0</p>



<a name="261575111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575111">(Nov 15 2021 at 23:18)</a>:</h4>
<p>but I don't think I remember enough about all this to say with any certainty</p>



<a name="261575126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575126">(Nov 15 2021 at 23:18)</a>:</h4>
<p><a href="https://github.com/rust-lang-ci/rust/runs/4207171141?check_suite_focus=true">https://github.com/rust-lang-ci/rust/runs/4207171141?check_suite_focus=true</a></p>



<a name="261575141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575141">(Nov 15 2021 at 23:18)</a>:</h4>
<p><strong>* Error in `/checkout/obj/build/x86_64-unknown-linux-gnu/stage0/bin/cargo': double free or corruption (!prev): 0x0000562926d5b530 </strong>*</p>



<a name="261575203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575203">(Nov 15 2021 at 23:19)</a>:</h4>
<p>That happened when rustbuild called <code>cargo metadata</code></p>



<a name="261575204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575204">(Nov 15 2021 at 23:19)</a>:</h4>
<p>that seems highly likely to be related to this yeah, do you know if ci uses a proxy?</p>



<a name="261575213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575213">(Nov 15 2021 at 23:19)</a>:</h4>
<p>I don't think it does.</p>



<a name="261575371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575371">(Nov 15 2021 at 23:20)</a>:</h4>
<p>I wish the backtrace was more useful.  Do you know if it is possible to map those offsets to symbols?</p>



<a name="261575500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575500">(Nov 15 2021 at 23:21)</a>:</h4>
<p>I think so, probably with addr2line</p>



<a name="261575517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575517">(Nov 15 2021 at 23:21)</a>:</h4>
<p>I've never done it myself with addr2line though</p>



<a name="261575539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575539">(Nov 15 2021 at 23:22)</a>:</h4>
<p>Ah, yea, addr2line works.</p>



<a name="261575607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261575607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261575607">(Nov 15 2021 at 23:22)</a>:</h4>
<p>you may need to do math though relative to where cargo was loaded</p>



<a name="261578260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261578260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261578260">(Nov 15 2021 at 23:53)</a>:</h4>
<p><span class="user-mention" data-user-id="120518">@Eric Huss</span> thanks for digging into that -- I was sort of hopeful it's not actually a bug in Cargo so we could continue on the theory that the faults aren't due to Rust (but something somehow in environment or bad RAM etc).</p>
<p>please do leave an update on the issue when you get a chance</p>



<a name="261580173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261580173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261580173">(Nov 16 2021 at 00:11)</a>:</h4>
<p>Unfortunately I can't get sensible output with <code>addr2line</code> with those offsets.  It just gives random positions.</p>



<a name="261580453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261580453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261580453">(Nov 16 2021 at 00:15)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ llvm-symbolizer-11 -a -e ./x86_64-unknown-linux-gnu/stage0/bin/cargo --adjust-vma 0x56292468c000 0x562925044391 0x562925051af4 0x56292503d39f 0x562925042683
0x562925044391
OPENSSL_LH_free
??:0:0
0x562925051af4
OBJ_NAME_cleanup
??:0:0
0x56292503d39f
evp_cleanup_int
??:0:0
0x562925042683
OPENSSL_cleanup
??:0:0
</code></pre></div>



<a name="261580467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261580467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261580467">(Nov 16 2021 at 00:15)</a>:</h4>
<p><span class="user-mention" data-user-id="120518">@Eric Huss</span> that looks... at least plausible?</p>



<a name="261580635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261580635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261580635">(Nov 16 2021 at 00:17)</a>:</h4>
<p>Yea, I guess that is plausible.</p>



<a name="261580815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261580815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261580815">(Nov 16 2021 at 00:19)</a>:</h4>
<p>Is <code>OPENSSL_cleanup</code> called in atexit maybe?</p>



<a name="261580943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261580943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261580943">(Nov 16 2021 at 00:20)</a>:</h4>
<p>ah, indeed it is.</p>



<a name="261581014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261581014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261581014">(Nov 16 2021 at 00:21)</a>:</h4>
<p>was just about to comment that  <code>./target/release/examples/addr2line --exe ../rust/build/x86_64-unknown-linux-gnu/stage0/bin/cargo -f 0x9b8391 0x9c5af4 0x9b139f 0x9b6683</code> worked for me and I got that trace</p>



<a name="261581031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261581031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261581031">(Nov 16 2021 at 00:21)</a>:</h4>
<p>we don't have debuginfo for openssl afaik so lack of filename/line number makes sense</p>



<a name="261581091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261581091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261581091">(Nov 16 2021 at 00:22)</a>:</h4>
<p>this may be an openssl 3.0.0 thing given the timing</p>



<a name="261581093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261581093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261581093">(Nov 16 2021 at 00:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116015">Alex Crichton</span> <a href="#narrow/stream/246057-t-cargo/topic/double.20free/near/261581031">said</a>:</p>
<blockquote>
<p>we don't have debuginfo for openssl afaik so lack of filename/line number makes sense</p>
</blockquote>
<p>Might make sense for us to install debug symbols in CI.</p>



<a name="261581117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261581117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261581117">(Nov 16 2021 at 00:22)</a>:</h4>
<p>hm no, nevermind, not openssl 3.0.0 <code>libcurl: 7.79.1-DEV (sys:0.4.49+curl-7.79.1 vendored ssl:OpenSSL/1.1.1l)</code></p>



<a name="261581137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261581137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261581137">(Nov 16 2021 at 00:22)</a>:</h4>
<p>I don't think we can just install them -- cargo links statically to openssl, right?</p>



<a name="261581208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261581208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261581208">(Nov 16 2021 at 00:23)</a>:</h4>
<p>Ah, I didn't realize we were vendoring it in this context.</p>



<a name="261581272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/double%20free/near/261581272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/double.20free.html#261581272">(Nov 16 2021 at 00:24)</a>:</h4>
<p>Might still make sense for us to build it with debug symbols and then strip them into a separate file, but that'd be much more complex.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>