<html>
<head><meta charset="utf-8"><title>RUSTC_WRAPPER and caching · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RUSTC_WRAPPER.20and.20caching.html">RUSTC_WRAPPER and caching</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="251278517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RUSTC_WRAPPER%20and%20caching/near/251278517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RUSTC_WRAPPER.20and.20caching.html#251278517">(Aug 30 2021 at 19:08)</a>:</h4>
<p>I'm working on a rustc_private plugin. To integrate with Cargo, I'm using RUSTC_WRAPPER just like Clippy and Miri. My workflow is:</p>
<ol>
<li>User runs <code>cargo mytool</code></li>
<li><code>cargo-mytool</code> binary invokes <code>RUSTC_WRAPPER=mytool-rustc cargo check</code></li>
<li><code>mytool-rustc</code> then sanitizes arguments passed from Cargo and hands them off to <code>mytool-driver</code></li>
</ol>
<p>The issue I'm running into is that if the user has already run <code>cargo check</code>, then because the corresponding <code>.rmeta</code> file is already generated, subsequent calls to <code>cargo mytool</code> don't actually run my tool. What's the right way to work around this? I couldn't figure out what Clippy does. One possibility is trying to delete the <code>.rmeta</code> file, but reliably finding that file name would probably rely on private Cargo internals.</p>



<a name="251279883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RUSTC_WRAPPER%20and%20caching/near/251279883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RUSTC_WRAPPER.20and.20caching.html#251279883">(Aug 30 2021 at 19:17)</a>:</h4>
<p>Clippy uses the <code>RUSTC_WORKSPACE_WRAPPER</code> environment variable which keeps the cache files separate from <code>cargo check</code>.  However, that wrapper is only run for the "local" packages, and not registry dependencies, unlike <code>RUSTC_WRAPPER</code> which runs for all compilation steps.</p>



<a name="251280211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RUSTC_WRAPPER%20and%20caching/near/251280211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RUSTC_WRAPPER.20and.20caching.html#251280211">(Aug 30 2021 at 19:19)</a>:</h4>
<p>Ok so I was following that lead, since I saw in the Cargo docs the bit about the different cache. However if I simply replace <code>RUSTC_WRAPPER</code> with <code>RUSTC_WORKSPACE_WRAPPER</code>, then I get compilation errors like:</p>
<div class="codehilite"><pre><span></span><code>error: extern location for rg3d_core_derive does not exist: /Users/will/Code/tmp/rg3d/target/debug/deps/librg3d_core_derive-f60c2b904661c45b.dylib
  --&gt; rg3d-core/src/visitor.rs:11:9
   |
11 | pub use rg3d_core_derive::Visit;
   |         ^^^^^^^^^^^^^^^^

error: could not compile `rg3d-core` due to previous error
error: build failed
</code></pre></div>



<a name="251280347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RUSTC_WRAPPER%20and%20caching/near/251280347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RUSTC_WRAPPER.20and.20caching.html#251280347">(Aug 30 2021 at 19:20)</a>:</h4>
<p>Seems like there's a weird interaction with proc-macro dependencies potentially?</p>



<a name="251280451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RUSTC_WRAPPER%20and%20caching/near/251280451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RUSTC_WRAPPER.20and.20caching.html#251280451">(Aug 30 2021 at 19:21)</a>:</h4>
<p>Hm, I'm not sure.  Is that dylib missing?</p>



<a name="251280858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RUSTC_WRAPPER%20and%20caching/near/251280858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RUSTC_WRAPPER.20and.20caching.html#251280858">(Aug 30 2021 at 19:24)</a>:</h4>
<p>Ah no the issue is that I needed to test for <code>CARGO_PRIMARY_PACKAGE</code> like Clippy does. <a href="https://github.com/rust-lang/rust-clippy/blob/master/src/driver.rs#L336">https://github.com/rust-lang/rust-clippy/blob/master/src/driver.rs#L336</a> </p>
<p>All good, thanks for the pointers!</p>



<a name="251283894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RUSTC_WRAPPER%20and%20caching/near/251283894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RUSTC_WRAPPER.20and.20caching.html#251283894">(Aug 30 2021 at 19:47)</a>:</h4>
<p>Oh wow good catch with <code>CARGO_PRIMARY_PACKAGE</code>... I was having a similar issue where I only want to print output for the primary package</p>



<a name="251283961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RUSTC_WRAPPER%20and%20caching/near/251283961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Xavier Denis <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RUSTC_WRAPPER.20and.20caching.html#251283961">(Aug 30 2021 at 19:48)</a>:</h4>
<p>but definitely want to run my tool on all dependencies (to gather metadata)</p>



<a name="251292453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RUSTC_WRAPPER%20and%20caching/near/251292453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RUSTC_WRAPPER.20and.20caching.html#251292453">(Aug 30 2021 at 20:46)</a>:</h4>
<p>One other question in this vein... I'm observing that the time to actually run <code>cargo check</code> is dramatically slower when using RUSTC_WORKSPACE_WRAPPER than when running without the wrapper, even when the wrapper just invokes rustc. Like 3s vs. 30s. This is for a workspace with several very large crates. Any ideas on why this would happen?</p>



<a name="251296245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/RUSTC_WRAPPER%20and%20caching/near/251296245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Will Crichton <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/RUSTC_WRAPPER.20and.20caching.html#251296245">(Aug 30 2021 at 21:15)</a>:</h4>
<p>Nevermind, it's just polonius being extremely slow...</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>