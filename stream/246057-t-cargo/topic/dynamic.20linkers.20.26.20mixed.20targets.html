<html>
<head><meta charset="utf-8"><title>dynamic linkers &amp; mixed targets · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html">dynamic linkers &amp; mixed targets</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276671440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276671440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276671440">(Mar 25 2022 at 20:00)</a>:</h4>
<p>Does anyone know, do dynamic linkers ignore dylibs if they are built for a different target?  For example, if it is trying to find <code>libfoo.so</code> (or .dylib or .dll), and it finds one that is built for a different target, will it just ignore it?  (On all platforms?)</p>



<a name="276674245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276674245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276674245">(Mar 25 2022 at 20:22)</a>:</h4>
<p>They ignore dylibs that use a different object file format. PE and MachO also contain which OS they are built for AFAIK. ELF technically has also this, but most of the time the OS is specified as ELFOSABI_NONE independent of the actual target OS.</p>



<a name="276674316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276674316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276674316">(Mar 25 2022 at 20:23)</a>:</h4>
<p>So on ELF there is nothing preventing you from loading a dylib built for another OS that uses ELF. In the best case you will have missing libraries or symbols, in the worst case you have a mismatching ABI.</p>



<a name="276675160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276675160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276675160">(Mar 25 2022 at 20:31)</a>:</h4>
<p>Bionic linker seems to have some sanity checking <a href="https://android.googlesource.com/platform/bionic/+/refs/heads/master/linker/linker_phdr.cpp#221">https://android.googlesource.com/platform/bionic/+/refs/heads/master/linker/linker_phdr.cpp#221</a></p>



<a name="276675316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276675316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276675316">(Mar 25 2022 at 20:32)</a>:</h4>
<p>Musl linker is very straightforward as expected, it just loads stuff and expects it to be good <a href="https://github.com/kraj/musl/blob/kraj/master/ldso/dynlink.c#L624">https://github.com/kraj/musl/blob/kraj/master/ldso/dynlink.c#L624</a></p>



<a name="276675462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276675462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276675462">(Mar 25 2022 at 20:34)</a>:</h4>
<p>The bionic linker doesn't check the target os though. It accepts something obviously bogus like ELFOSABI_FREEBSD.</p>



<a name="276682668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276682668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276682668">(Mar 25 2022 at 21:45)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="133247">@bjorn3</span> .  I just did a quick little test with a FreeBSD .so, and indeed the loader does not pay attention to the OS and just fails.  <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span> </p>
<p>The problem I'm trying to figure out is how to handle <code>rustdoc --test</code>.  In order to run doctests, cargo needs to set up LD_LIBRARY_PATH so that the test can find shared libraries.  However, it also needs to set LD_LIBRARY_PATH for proc-macros to find shared libraries, too.  This seems like it could be a problem if someone just so happens to have a dylib with the same name needed for both purposes.  </p>
<p>Perhaps that situation is unlikely enough to just ignore?</p>



<a name="276682935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276682935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276682935">(Mar 25 2022 at 21:48)</a>:</h4>
<p>Won't they have different hashes in the name if they are for different targets?</p>



<a name="276683146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276683146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276683146">(Mar 25 2022 at 21:50)</a>:</h4>
<p>This is for C dylibs.  For example, a build script running <code>cc</code> to generate a <code>.so</code>.</p>



<a name="276683167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276683167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276683167">(Mar 25 2022 at 21:50)</a>:</h4>
<p>So unlikely to have any distinguishing markers in the filename.</p>



<a name="276683194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276683194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276683194">(Mar 25 2022 at 21:51)</a>:</h4>
<p>I feel like maybe I'm overthinking this, as that seems really unlikely.</p>



<a name="276683228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276683228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276683228">(Mar 25 2022 at 21:51)</a>:</h4>
<p>Overthinking thinks is our job :-P</p>



<a name="276683766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276683766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276683766">(Mar 25 2022 at 21:56)</a>:</h4>
<p>it should at least ignore libraries that are the wrong arch (e.g. ELF <code>e_machine</code>)</p>



<a name="276683807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276683807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276683807">(Mar 25 2022 at 21:57)</a>:</h4>
<p>Yea, I confirmed that it will ignore different arch (at least on linux).</p>



<a name="276684261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276684261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276684261">(Mar 25 2022 at 22:01)</a>:</h4>
<p>Apparently <code>cargo doc</code> is broken when using  a proc-macro that loads a shared library, and nobody has reported it, so perhaps people just don't build shared native libs with proc-macros.</p>



<a name="276686581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276686581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276686581">(Mar 25 2022 at 22:20)</a>:</h4>
<p>it's kind of tricky anyway, since you don't want to clash symbols with anything in the entire rustc process. I remember a bug about broken libstdc++ when used by a proc macro</p>



<a name="276686614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276686614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276686614">(Mar 25 2022 at 22:20)</a>:</h4>
<p>I've encountered the different-arch case before; it's not uncommon if you cross-compile and have some step that uses a native lib when it should have used a cross one or vice versa.</p>



<a name="276686637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276686637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276686637">(Mar 25 2022 at 22:21)</a>:</h4>
<p>I didn't realize that the Linux <a href="http://ld.so">ld.so</a> didn't check OS.</p>



<a name="276688105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dynamic%20linkers%20%26%20mixed%20targets/near/276688105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets.html#276688105">(Mar 25 2022 at 22:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="138448">cuviper</span> <a href="#narrow/stream/246057-t-cargo/topic/dynamic.20linkers.20.26.20mixed.20targets/near/276686581">said</a>:</p>
<blockquote>
<p>it's kind of tricky anyway, since you don't want to clash symbols with anything in the entire rustc process. I remember a bug about broken libstdc++ when used by a proc macro</p>
</blockquote>
<p>Yea, that's probably <a href="https://github.com/rust-lang/rust/issues/76980">#76980</a> where someone had a proc-macro doing vulkan shader compilation with a big C++ library linked in.</p>
<p>I wish proc-macros were more isolated.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>