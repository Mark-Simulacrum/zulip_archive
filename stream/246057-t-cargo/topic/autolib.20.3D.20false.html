<html>
<head><meta charset="utf-8"><title>autolib = false · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/autolib.20.3D.20false.html">autolib = false</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263740862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/autolib%20%3D%20false/near/263740862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Johnson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/autolib.20.3D.20false.html#263740862">(Dec 05 2021 at 00:52)</a>:</h4>
<p>Currently in Cargo.toml you can set <code>autobins = false</code> to avoid cargo picking up targets automatically for <code>src/main.rs</code> (and all the other places where binary targets would normally live). There also exists options for <code>autoexamples</code>, <code>autotests</code>, and <code>autobenches</code>. <a href="https://doc.rust-lang.org/cargo/reference/cargo-targets.html#target-auto-discovery">documentation</a></p>
<p>However, there's no <code>autolib</code> option for <code>src/lib.rs</code>. Would such an option be a reasonable addition?</p>
<p>My usecase: I have a crate which is entirely just an integration test of other software. Since the whole crate is just a test, it's not really clear what the crate root should be named, and because of historical accident it got named <code>src/lib.rs</code>. It doesn't normally actually get built by cargo at all (it uses another build system which drives rustc itself), but I'd like to _generate_ a <code>Cargo.toml</code> for this crate so that I can use the <code>cargo</code> ecosystem of tooling with it. So I've generated a <code>Cargo.toml</code> that looks something like this:</p>
<div class="codehilite"><pre><span></span><code>[package]
name = &quot;autolib&quot;
version = &quot;0.1.0&quot;
edition = &quot;2021&quot;

[[test]]
name = &quot;autolib&quot;
path = &quot;src/lib.rs&quot;
</code></pre></div>
<p>Which sort of works, but behaves weirdly:</p>
<div class="codehilite"><pre><span></span><code>$ cargo test --test autolib -v
warning: file found to be present in multiple build targets: /home/cdruid/autolib/src/lib.rs
   Compiling autolib v0.1.0 (/home/cdruid/autolib)
     Running `rustc --crate-name autolib --edition=2021 src/lib.rs --error-format=json --json=diagnostic-rendered-ansi --crate-type lib --emit=dep-info,metadata,link -C embed-bitcode=no -C debuginfo=2 -C metadata=989134b57a80d57f -C extra-filename=-989134b57a80d57f --out-dir /home/cdruid/autolib/target/debug/deps -C incremental=/home/cdruid/autolib/target/debug/incremental -L dependency=/home/cdruid/autolib/target/debug/deps`
     Running `rustc --crate-name autolib --edition=2021 src/lib.rs --error-format=json --json=diagnostic-rendered-ansi --emit=dep-info,link -C embed-bitcode=no -C debuginfo=2 --test -C metadata=b69d9bd01c641b07 -C extra-filename=-b69d9bd01c641b07 --out-dir /home/cdruid/autolib/target/debug/deps -C incremental=/home/cdruid/autolib/target/debug/incremental -L dependency=/home/cdruid/autolib/target/debug/deps --extern autolib=/home/cdruid/autolib/target/debug/deps/libautolib-989134b57a80d57f.rlib`
    Finished test [unoptimized + debuginfo] target(s) in 0.68s
     Running `/home/cdruid/autolib/target/debug/deps/autolib-b69d9bd01c641b07`

running 1 test
test t ... ok
</code></pre></div>
<p>That is, it first builds <code>lib.rs</code> as a lib, and then builds it as a test, which depends on the lib it just built. Which isn't what we want.</p>
<p>One thing that almost works is adding:</p>
<div class="codehilite"><pre><span></span><code>[lib]
crate-type = []
</code></pre></div>
<p>Then it doesn't get build as a dependency of the test. But that breaks <code>cargo build --all-targets</code>:</p>
<div class="codehilite"><pre><span></span><code>$ cargo build --all-targets
warning: file found to be present in multiple build targets: /home/cdruid/autolib/src/lib.rs
error: cannot compile `autolib v0.1.0 (/home/cdruid/autolib)` as the target `x86_64-unknown-linux-gnu` does not support any of the output crate types
</code></pre></div>
<p>I think an <code>autolib</code> toggle in the style of the other ones would make sense, and would solve this conundrum nicely. I'd probably be interested in implementing this if it were welcome and I could get some implementation pointers. I'd also be happy to file an issue on github if it's something that makes sense to others.</p>



<a name="263740938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/autolib%20%3D%20false/near/263740938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan Johnson <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/autolib.20.3D.20false.html#263740938">(Dec 05 2021 at 00:53)</a>:</h4>
<p>I could provide a lot more specifics of the actual details if it's helpful or interesting, but I think I've captured the essence above. Also the tests in question are open-source, but part of my $dayjob, hopefully no one from work notices I'm thinking about work on the weekend</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>