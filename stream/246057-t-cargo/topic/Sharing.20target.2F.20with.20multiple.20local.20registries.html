<html>
<head><meta charset="utf-8"><title>Sharing target/ with multiple local registries · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html">Sharing target/ with multiple local registries</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262647994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262647994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262647994">(Nov 24 2021 at 22:38)</a>:</h4>
<p>I have a probably fairly niche problem, but one I'm hoping there's a way to align with Cargo on so that things work out as desired. Basically, I'm using Cargo in the context of a larger build system (called Brazil). For various reasons, that build system constructs a local registry for each Brazil package that holds exactly the Cargo packages that that Brazil package is permitted to access. Some of those are mirrored from <a href="http://crates.io">crates.io</a>, and others are first-party packages (for <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> reasons <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span>  we're not using multiple registries).</p>
<p>Now, Brazil _also_ has a notion of workspaces, separate from Cargo workspaces, where you can have multiple Brazil packages checked out "as a group". When that happens, I'd like those packages to shared a Cargo target/ directory so that if you build Brazil package 1, and then Brazil package 2, any Cargo dependencies shared between them don't have to be compiled twice. Unfortunately, that doesn't work today, since (as far as I can tell) Cargo includes the _path_ to each dependency in the fingerprint used for artifact tracking. So even if Brazil packages 1 and 2 both take a dependency on, say, <code>autocfg 1.0.1</code>, and share both a <code>CARGO_HOME</code> and a <code>CARGO_TARGET_DIR</code>, <code>autocfg 1.0.1</code> will still be re-compiled because its fingerprint in package 1 includes <code>CARGO_HOME/registry/src/-&lt;hash of pkg1 local registry path&gt;/autocfg-1.0.1</code>, whereas its fingerprint in package 2 has the same path except with the hash of package 2's local registry path instead.</p>
<p>Worse yet, any time a user switches between the two Brazil packages, they'll re-compile _all_ the shared artifacts, because they'll all be tagged with the fingerprint from the _other_ package's path.</p>
<p>Now, this feels silly since in all of this, it's the _same_ <code>autocfg 1.0.1</code> — the one from <a href="http://crates.io">crates.io</a>, and that's at least partially expressed by the fact that each local registry is a source replacement for <code>[source.crates-io]</code>. I realize that what Cargo does here is more safe since it's _possible_ for two registries to have the same coordinate be represented by different backing sources, but I wonder if that would be better represented by, say, (name, version, checksum)?</p>
<p>Anyway, I know this is very open-ended, but wanted to get the team's take on the "right" thing to do for a build system wrapping Cargo in this way where each project gets its own local registry.</p>



<a name="262648115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262648115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262648115">(Nov 24 2021 at 22:40)</a>:</h4>
<p>Note that it's quite <em>easy</em> for two registries to have different sources for the same crate name/version. If they live in two separate directories, <em>nothing</em> checks that they're the same. You can put a hash into the file in the directory registry, but nothing checks that the contents of the directory match that hash.</p>



<a name="262648128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262648128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262648128">(Nov 24 2021 at 22:40)</a>:</h4>
<p>Two questions:</p>



<a name="262648135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262648135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262648135">(Nov 24 2021 at 22:40)</a>:</h4>
<p>Does anything you're doing guarantee that two copies of the same crate will be identical, in your system? (Are the sources obtained from the same place even if your build system then constructs different local registries for each user of them?)</p>



<a name="262648216"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262648216" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262648216">(Nov 24 2021 at 22:42)</a>:</h4>
<p>And could you arrange for your build system to share the actual crate directories between local registries for packages in a Brazil workspace, rather than having separate ones?</p>



<a name="262648306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262648306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262648306">(Nov 24 2021 at 22:43)</a>:</h4>
<p>Note that this is a "local registry" _not_ a "directory registry". As I understand it, the former does check checksums.</p>



<a name="262648432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262648432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262648432">(Nov 24 2021 at 22:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries/near/262648135">said</a>:</p>
<blockquote>
<p>Does anything you're doing guarantee that two copies of the same crate will be identical, in your system? (Are the sources obtained from the same place even if your build system then constructs different local registries for each user of them?)</p>
</blockquote>
<p>This is a subset mirror of <a href="http://crates.io">crates.io</a> with first-party crates added, so yes, the same coordinate in two of these registries should be the same.</p>



<a name="262648551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262648551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262648551">(Nov 24 2021 at 22:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries/near/262648216">said</a>:</p>
<blockquote>
<p>And could you arrange for your build system to share the actual crate directories between local registries for packages in a Brazil workspace, rather than having separate ones?</p>
</blockquote>
<p>I don't see how that's possible with a local registry if you want to make different subsets of crates to be available to each Brazil package? Basically, say I want Brazil package 1 to have access to <code>serde</code>, but _not_ Brazil package 2. But both have access to <code>autocfg</code>, and should share the build artifacts of that if they both use it.</p>



<a name="262648662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262648662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262648662">(Nov 24 2021 at 22:48)</a>:</h4>
<p>I see. This is not about local modifications, just about "you can't use anything except"?</p>



<a name="262648736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262648736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262648736">(Nov 24 2021 at 22:49)</a>:</h4>
<p>Exactly.</p>



<a name="262649557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262649557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262649557">(Nov 24 2021 at 23:01)</a>:</h4>
<p>Could you have the same paths to crates, but different index files?</p>



<a name="262649569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262649569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262649569">(Nov 24 2021 at 23:01)</a>:</h4>
<p>A directory registry looks at everything in the directory, but a local registry needs an index.</p>



<a name="262649655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262649655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262649655">(Nov 24 2021 at 23:03)</a>:</h4>
<p>One directory of crates, many indexes.</p>



<a name="262649846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262649846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262649846">(Nov 24 2021 at 23:06)</a>:</h4>
<p>I'm not sure I follow? Are you proposing I switch from a local registry to a directory registry? I _believe_ the input to Cargo's target artifact fingerprint is the path to the index, so in either case it would still fingerprint differently if the index differs</p>



<a name="262649874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262649874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262649874">(Nov 24 2021 at 23:07)</a>:</h4>
<p>Oh, I thought it was the path to the crate source.</p>



<a name="262649886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262649886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262649886">(Nov 24 2021 at 23:07)</a>:</h4>
<p>(And no, not proposing a switch.)</p>



<a name="262649938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262649938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262649938">(Nov 24 2021 at 23:08)</a>:</h4>
<p>Ah, so, it _is_ the crate source, but that path _includes_ the hash of the path to the registry</p>



<a name="262649962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262649962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262649962">(Nov 24 2021 at 23:08)</a>:</h4>
<p>e.g.: <code>~/.cargo/registry/src/github.com-1ecc6299db9ec823/autocfg-1.0.1/</code></p>



<a name="262649969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262649969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262649969">(Nov 24 2021 at 23:08)</a>:</h4>
<p>for a local registry, <code>github.com</code> is the empty string, but the hash is the hash of the path to the local registry index</p>



<a name="262649973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262649973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262649973">(Nov 24 2021 at 23:09)</a>:</h4>
<p>at least from what I can tell</p>



<a name="262649987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/262649987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#262649987">(Nov 24 2021 at 23:09)</a>:</h4>
<p>which means that different indexes yield different crate paths, which then go into the fingerprint</p>



<a name="264066078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Sharing%20target/%20with%20multiple%20local%20registries/near/264066078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries.html#264066078">(Dec 07 2021 at 20:21)</a>:</h4>
<p>FYI: I filed a subset of this that I _do_ think is an outright bug as &lt;<a href="https://github.com/rust-lang/cargo/issues/10179">https://github.com/rust-lang/cargo/issues/10179</a>&gt;.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>