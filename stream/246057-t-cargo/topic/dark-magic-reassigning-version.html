<html>
<head><meta charset="utf-8"><title>dark-magic-reassigning-version · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html">dark-magic-reassigning-version</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="260739083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739083">(Nov 09 2021 at 00:28)</a>:</h4>
<p>I'm trying to do something very dark and shady — I'm writing a Cargo subcommand that acts like <code>cargo publish</code>, but instead publishes... elsewhere (specifically, into a registry managed by a larger build system). As part of that, I want to adjust the minor version of the crate being published so that it gets an automatically-assigned minor version rather than using what's in <code>Cargo.toml</code>. Now, I know this is kind of deep in no-no territory (happy to get into why it's likely the right decision if that'd be helpful), but I'm wondering if it's _possible_. I _think_ I can reach into a <code>Workspace</code> deep enough to modify the in-memory state for a package to adjust the version before calling <code>package_one</code>, but is that likely to be sufficient?</p>
<p><a href="https://github.com/rust-lang/cargo/blob/4cc3f4f193c4018e4ffbe0e724686b53d5f38ad2/src/cargo/ops/cargo_package.rs#L581">https://github.com/rust-lang/cargo/blob/4cc3f4f193c4018e4ffbe0e724686b53d5f38ad2/src/cargo/ops/cargo_package.rs#L581</a></p>
<p>makes me think it's doable, but I wanted to check before I set down this path and try to actually write the dark voodoo code required</p>



<a name="260739219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739219">(Nov 09 2021 at 00:30)</a>:</h4>
<p><span class="user-mention" data-user-id="120054">@Jon Gjengset</span> So, there's a related concept that I think might be useful to you, if you might be interested in working on it.</p>



<a name="260739246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739246">(Nov 09 2021 at 00:30)</a>:</h4>
<p>Downstream distributors of crates sometimes need to make revisions. For instance, a Linux distribution might patch a crate.</p>



<a name="260739272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739272">(Nov 09 2021 at 00:31)</a>:</h4>
<p>I think it'd make sense to augment semver, and add a concept of sub-micro versions, which are infinitely divisible (e.g. there's always a new sub-micro version between any two semver versions).</p>



<a name="260739343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739343">(Nov 09 2021 at 00:32)</a>:</h4>
<p>So, if you're patching 1.2.3, you can make 1.2.3.1, and if someone needs to patch <em>that</em> they can make 1.2.3.1.1, and both of those come before 1.2.3.2 or 1.2.4.</p>



<a name="260739370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739370">(Nov 09 2021 at 00:32)</a>:</h4>
<p>Your description of adjusting the minor version of the crate makes me wonder if something like this might be what you're looking for.</p>



<a name="260739378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739378">(Nov 09 2021 at 00:32)</a>:</h4>
<p><span class="user-mention" data-user-id="120054">@Jon Gjengset</span> What do you think?</p>



<a name="260739482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739482">(Nov 09 2021 at 00:34)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> That _would_ be nice in terms of making the version re-assignment more obvious, but I don't _think_ that feature actually helps with the fact that ultimately I still need to package a crate with a different version than what's in its <code>Cargo.toml</code>?</p>



<a name="260739523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739523">(Nov 09 2021 at 00:34)</a>:</h4>
<p>I suppose it might suggest that <code>publish_one</code> could gain a "add_microversion" argument, though that just forwards the problem into Cargo</p>



<a name="260739530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739530">(Nov 09 2021 at 00:35)</a>:</h4>
<p>You'd still need to either patch or override <code>Cargo.toml</code>, yes.</p>



<a name="260739565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739565">(Nov 09 2021 at 00:35)</a>:</h4>
<p>Just wondering if the minor or micro version is <em>actually</em> what you were looking to change, or if you just need a workable scheme for downstream versioning.</p>



<a name="260739673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739673">(Nov 09 2021 at 00:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120054">Jon Gjengset</span> <a href="#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739523">said</a>:</p>
<blockquote>
<p>I suppose it might suggest that <code>publish_one</code> could gain a "add_microversion" argument, though that just forwards the problem into Cargo</p>
</blockquote>
<p>Are you looking to change it <em>without</em> patching the crate, or could you patch <code>Cargo.toml</code>?</p>



<a name="260739681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739681">(Nov 09 2021 at 00:36)</a>:</h4>
<p>I'm totally on board with assigning a new microversion instead if such a thing existed, but I specifically do not want to modify <code>Cargo.toml</code> in the file-system. I _only_ want the override in the packaged tarball. This is because the <code>Cargo.toml</code> is in a user's working directory, and I'd rather not make adjustments to their files (which are checked into git) that should be irrelevant to them.</p>



<a name="260739682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739682">(Nov 09 2021 at 00:36)</a>:</h4>
<p>(And do you apply any other patches to the crate, or is it unmodified?)</p>



<a name="260739693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739693">(Nov 09 2021 at 00:36)</a>:</h4>
<p>The crate is unpatched. I _only_ want to give it a modified version number.</p>



<a name="260739709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739709">(Nov 09 2021 at 00:37)</a>:</h4>
<p>In fact, it is arguably a design goal for this process to avoid stepping on Cargo's standard process as much as we possibly can.</p>



<a name="260739718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739718">(Nov 09 2021 at 00:37)</a>:</h4>
<p>To give a bit more context:</p>



<a name="260739934"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260739934" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260739934">(Nov 09 2021 at 00:40)</a>:</h4>
<p>The fundamental problem I'm trying to solve is that these crates are being built in the context of a larger build system that may choose to re-build a crate (which includes publishing it) even if the crate itself has not changed, such as if one of its (non-Cargo) dependencies changed. In such a case, there is no human who could bump the version in Cargo.toml, so we need to automatically assign the versions (the minor/micro versions specifically). And then I want to align that with the fact that there can _also_ be builds by humans in their development workspaces, where we don't want to be modifying their on-disk files any time the build system decides to publish, because it would just lead to spurious <code>Cargo.toml</code> modifications, which in turn cause git conflicts and pain.</p>



<a name="260740008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740008">(Nov 09 2021 at 00:41)</a>:</h4>
<p>What does "publish" mean here, if the crate is unmodified?</p>



<a name="260740045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740045">(Nov 09 2021 at 00:41)</a>:</h4>
<p>Or rather, what is the semantic function in your build system of publishing a new version of a crate if the previous version is identical?</p>



<a name="260740147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740147">(Nov 09 2021 at 00:43)</a>:</h4>
<p>So, it's not necessarily identical. For example, one of my non-Cargo dependencies might be a (non-Cargo) package that vends a JSON file of, say, pre-approved licenses, which I <code>include_str!</code> into my source as part of the build.</p>



<a name="260740262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740262">(Nov 09 2021 at 00:44)</a>:</h4>
<p>Point being, the "outer" build system has to assume that any change in the dependencies of A _may_ result in a change to the build artifacts of A, and therefore has to re-build A, which also means re-publishing A's artifacts, which thus need a new version number.</p>



<a name="260740348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740348">(Nov 09 2021 at 00:45)</a>:</h4>
<p>So, effectively, these are not versions of the source package, they're versions of the binary artifacts you're building?</p>



<a name="260740447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740447">(Nov 09 2021 at 00:46)</a>:</h4>
<p>And the "publish" operation you're describing is the build-and-ship of a binary compiled version of a crate?</p>



<a name="260740455"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740455" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740455">(Nov 09 2021 at 00:46)</a>:</h4>
<p>Well, sort of. It becomes complicated like in the above case for example where a dependency's effective source changes due to something like <code>include_str!</code>. Same thing can happen with things like crates that have build scripts that invoke <code>bindgen</code> on a header file vended by a (non-Cargo) dependency.</p>



<a name="260740475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740475">(Nov 09 2021 at 00:46)</a>:</h4>
<p>It really is publishing a <code>.crate</code>, and the contents of that <code>.crate</code> may have changed.</p>



<a name="260740607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740607">(Nov 09 2021 at 00:48)</a>:</h4>
<p>Sure, that makes sense. And your non-cargo build system is managing those other artifacts like the C libraries with their header files or the files being fed into <code>include_str!</code>, and that build system knows that if a dependency changes it needs to update the artifacts depending on it?</p>



<a name="260740619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740619">(Nov 09 2021 at 00:48)</a>:</h4>
<p>Exactly.</p>



<a name="260740630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740630">(Nov 09 2021 at 00:48)</a>:</h4>
<p>So, ignoring for a moment how this would integrate with Cargo...</p>



<a name="260740662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740662">(Nov 09 2021 at 00:49)</a>:</h4>
<p>It <em>seems</em>, to me, like you need an expanded version number here, in some fashion. You need the crate version, and then you need the version within your build system, which contains the crate version and an additional version (even if it's just a sequentially increasing number).</p>



<a name="260740729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740729">(Nov 09 2021 at 00:50)</a>:</h4>
<p>(This is assuming, for the moment, that the external dependencies don't actually semantically bump the major version number of a crate, or that you don't care if they do because your build system doesn't do Cargo-style dependency resolution.)</p>



<a name="260740774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740774">(Nov 09 2021 at 00:51)</a>:</h4>
<p>True. And my plan was to co-opt the minor version number for this. For various reasons, Cargo version numbers are _basically_ not used internally (which makes me sad, and I'm trying to change that somewhat), and _definitely_ not minor versions, so in the interest of getting something working in place, re-using that seemed like the easiest path.</p>



<a name="260740812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740812">(Nov 09 2021 at 00:51)</a>:</h4>
<p>If Cargo version numbers aren't used internally, do you actually need the crate version to change?</p>



<a name="260740820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740820">(Nov 09 2021 at 00:51)</a>:</h4>
<p>Or could you just have your own version number entirely?</p>



<a name="260740831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740831">(Nov 09 2021 at 00:51)</a>:</h4>
<p>Yes, because Cargo is _very_ picky about crate versions being immutable in registries.</p>



<a name="260740904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740904">(Nov 09 2021 at 00:52)</a>:</h4>
<p>It's a lot less picky about directory registries. What kind of registry are you using?</p>



<a name="260740947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740947">(Nov 09 2021 at 00:53)</a>:</h4>
<p>I'm genuinely wondering if what you're doing might do better to integrate very slightly less with Cargo. ;)</p>



<a name="260740949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260740949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260740949">(Nov 09 2021 at 00:53)</a>:</h4>
<p>My goal is to use a HTTP registry when that lands. For the time being, a dynamically constructed local registry with <code>[patch]</code> injected into <code>.cargo/config.toml</code> to work around the fact that I don't control the version numbers :p</p>



<a name="260741029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260741029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260741029">(Nov 09 2021 at 00:54)</a>:</h4>
<p>Hmmm.</p>



<a name="260741073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260741073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260741073">(Nov 09 2021 at 00:54)</a>:</h4>
<p>I forget exactly why I went with a local registry instead of a directory registry. I believe it was because I need to be able to do _resolution_ across basically all of <a href="http://crates.io">crates.io</a> using Cargo as a library, but then only actually pull in the artifacts that are truly needed.</p>



<a name="260741226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260741226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260741226">(Nov 09 2021 at 00:56)</a>:</h4>
<p>I _think_ the right thing to do here is to lean into Cargo as much as I possibly can and do everything "the standard way" and "the way Cargo wants". And part of that is because the more things that are custom, the more likely it is users will run into issues in "the way we do things", and can't take advantage of all the excellent work in Cargo itself. And I _think_ the way to do that is to give Cargo "the right version numbers". I think actually a lot of the pain we're currently having comes from the fact that we insist on giving all packages the same version number (specifically because devs never increment them + the auto-rebuild-on-dependencies case).</p>



<a name="260741381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260741381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260741381">(Nov 09 2021 at 00:59)</a>:</h4>
<p>Well, while I'm not speaking for any other members of the team, and I know that diverging from semver might be concerning and effortful and getting a patch <em>into</em> upstream semver would be harder, I <em>personally</em> would be hugely in favor of adding 1) more-than-three-component version numbers, with the obvious sorting, and 2) an <code>--override-submicro-version</code> option.</p>



<a name="260741655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260741655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260741655">(Nov 09 2021 at 01:02)</a>:</h4>
<p>I would highly, <em>highly</em> recommend getting confirmation from the full team on such a plan before embarking on it though.</p>



<a name="260741680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260741680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260741680">(Nov 09 2021 at 01:02)</a>:</h4>
<p>Would the combination of those two things address your issue?</p>



<a name="260741809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260741809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260741809">(Nov 09 2021 at 01:04)</a>:</h4>
<p>Yes, I think that combination would indeed do what I want. Though I also worry that it's a _very_ long path, especially as you observe because it requires changes to upstream semver. It might be something I can push on, but my guess for that is months-to-years before it actually being available to use. So the question then becomes what to do in the meantime. Which also relates to "how do you implement <code>--override-submicro-version</code>? Which gets back to my original question :p Not saying this wasn't/isn't a valuable discussion, but I think it's more of a long-term plan than a short-to-medium one.</p>



<a name="260742095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742095">(Nov 09 2021 at 01:08)</a>:</h4>
<p>Strictly speaking, it doesn't <em>require</em> changes to upstream semver, it'd just be nicer if we did.</p>



<a name="260742123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742123">(Nov 09 2021 at 01:09)</a>:</h4>
<p>I suppose that's true. Cargo already does some only-semi-semver things <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="260742153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742153">(Nov 09 2021 at 01:09)</a>:</h4>
<p>Actually, there <em>is</em> a path that would stay within semver, if you don't actually care at all about Cargo's version resolution (e.g. resolving <code>1.2.1</code> to <code>1.2.5</code> since the latter is compatible with the former).</p>



<a name="260742219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742219">(Nov 09 2021 at 01:10)</a>:</h4>
<p>I do care about Cargo's version resolution though, since I want it to pick the latest if there are multiple published versions</p>



<a name="260742237"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742237" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742237">(Nov 09 2021 at 01:11)</a>:</h4>
<p>Well, it may be possible to still use it, it just would take some validation to see how well it works.</p>



<a name="260742254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742254">(Nov 09 2021 at 01:11)</a>:</h4>
<p>You could use the semver "build metadata" field, which seems designed for this.</p>



<a name="260742266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742266">(Nov 09 2021 at 01:12)</a>:</h4>
<p>Hmm, I thought those were stripped by the time a version makes it to the registry?</p>



<a name="260742305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742305">(Nov 09 2021 at 01:12)</a>:</h4>
<p>No, there are crates in the registry that have them.</p>



<a name="260742323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742323">(Nov 09 2021 at 01:12)</a>:</h4>
<p>huh, oh yeah <a href="https://crates.io/crates/curl-sys">https://crates.io/crates/curl-sys</a></p>



<a name="260742324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742324">(Nov 09 2021 at 01:12)</a>:</h4>
<p><a href="https://crates.io/crates/zstd">https://crates.io/crates/zstd</a></p>



<a name="260742337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742337">(Nov 09 2021 at 01:12)</a>:</h4>
<p>You could add an <code>--append-build-metadata</code> option, which would append a new token to the build metadata.</p>



<a name="260742353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742353">(Nov 09 2021 at 01:13)</a>:</h4>
<p>hmmmm, I wonder what <a href="http://crates.io">crates.io</a> says if you try to publish two crates whose versions differ only be build metadata <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="260742371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742371">(Nov 09 2021 at 01:13)</a>:</h4>
<p>So, <code>--append-build-metadata my123</code> would turn <code>4.5.6</code> into <code>4.5.6+my123</code>, or turn <code>4.5.6+existing.metadata</code> into <code>4.5.6+existing.metadata.my123</code>.</p>



<a name="260742448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742448">(Nov 09 2021 at 01:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120054">Jon Gjengset</span> <a href="#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742353">said</a>:</p>
<blockquote>
<p>hmmmm, I wonder what <a href="http://crates.io">crates.io</a> says if you try to publish two crates whose versions differ only be build metadata <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>
</blockquote>
<p>I don't know if <a href="http://crates.io">crates.io</a> allows it. But your registry could. And as far as I know, <em>current</em> cargo should be alright with it, though older cargo had some bugs.</p>



<a name="260742574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742574">(Nov 09 2021 at 01:16)</a>:</h4>
<p>There's some discussion at <a href="https://github.com/rust-lang/crates.io/issues/1059">https://github.com/rust-lang/crates.io/issues/1059</a> .</p>



<a name="260742613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742613">(Nov 09 2021 at 01:16)</a>:</h4>
<p>And it <em>looks</em> like the semver crate handles this sensibly.</p>



<a name="260742625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742625">(Nov 09 2021 at 01:17)</a>:</h4>
<p>You might run into some corner cases that need fixing in cargo, but this seems like a workable solution path that wouldn't require waiting on long-term standards work.</p>



<a name="260742830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742830">(Nov 09 2021 at 01:19)</a>:</h4>
<p>Hmm, reading through that discussion it seems like the general consensus is that Cargo can choose randomly, and that _arguably_ it should be blocked on upload (&lt;<a href="https://github.com/rust-lang/crates.io/issues/1059#issuecomment-521787675">https://github.com/rust-lang/crates.io/issues/1059#issuecomment-521787675</a>&gt;). Which I suppose matches what you say — that if Cargo/<code>semver</code> do something sane, then it's workable.</p>



<a name="260742898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742898">(Nov 09 2021 at 01:20)</a>:</h4>
<p>Interestingly, this feels _more_ like a hack to me than modifying the minor version number. Because by using build metadata we're communicating the wrong _semantic_ information to semver.</p>



<a name="260742930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742930">(Nov 09 2021 at 01:21)</a>:</h4>
<p>Two versions that differ only in build metadata _should_ be equivalent, but in this case they really aren't. They _are_ new distinct versions with (potentially) different source.</p>



<a name="260742953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260742953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260742953">(Nov 09 2021 at 01:21)</a>:</h4>
<p>hmm hmm hmm</p>



<a name="260743344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260743344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260743344">(Nov 09 2021 at 01:27)</a>:</h4>
<p>So, that may be how semver describes it, but it isn't how people use it.</p>



<a name="260743397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260743397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260743397">(Nov 09 2021 at 01:28)</a>:</h4>
<p>The most common use I've seen is for the version number of an underlying FFI library.</p>



<a name="260743406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260743406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260743406">(Nov 09 2021 at 01:28)</a>:</h4>
<p>(see zstd for an example)</p>



<a name="260743417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260743417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260743417">(Nov 09 2021 at 01:28)</a>:</h4>
<p>That's what gave me the idea.</p>



<a name="260743565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260743565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260743565">(Nov 09 2021 at 01:30)</a>:</h4>
<p>Looking at that though, it does seem like build metadata because the Cargo version is _also_ incremented. There are no two releases that differ only in the build metadata. Instead, the build metadata merely indicates which version of the underlying library a given Cargo version was generated from — it's not used to ascribe ordering meaning to the version.</p>



<a name="260745625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260745625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260745625">(Nov 09 2021 at 02:02)</a>:</h4>
<p>Regardless of where I end up, this has been very helpful <span class="user-mention" data-user-id="239881">@Josh Triplett</span>  — thanks for taking the time!</p>



<a name="260746634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260746634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260746634">(Nov 09 2021 at 02:21)</a>:</h4>
<p>That's true about zstd, but I think other crates may not do that.</p>



<a name="260746636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260746636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260746636">(Nov 09 2021 at 02:21)</a>:</h4>
<p>And I'm glad!</p>



<a name="260746644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260746644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260746644">(Nov 09 2021 at 02:21)</a>:</h4>
<p>Thanks for putting so much effort into trying to cooperate with cargo!</p>



<a name="260761460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260761460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260761460">(Nov 09 2021 at 07:10)</a>:</h4>
<p>You could use prerelease versions (<code>1.0.0-1</code>) which should behave sensibly I think.</p>



<a name="260793827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260793827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260793827">(Nov 09 2021 at 13:01)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> Those sort earlier than the final version, though, which would make them problematic for dependencies.</p>



<a name="260794000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260794000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260794000">(Nov 09 2021 at 13:03)</a>:</h4>
<p>You can choose to never release the final version.</p>



<a name="260794243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260794243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260794243">(Nov 09 2021 at 13:05)</a>:</h4>
<p>If you're modifying <code>1.2.3</code> into <code>1.2.3~1</code>, that wouldn't (or at least <em>shouldn't</em>, I don't know if there are still issues) satisfy a dependency on "1.2.3".</p>



<a name="260816955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260816955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260816955">(Nov 09 2021 at 15:49)</a>:</h4>
<p>The crates are not public. It would be possible to depend on <code>1.2.3-0</code> and then modify the crate versions to <code>1.2.3-1</code>, <code>1.2.3-2</code>, ... on upload to the local registry. Newer pre-releases are considered to satisfy older pre-release requirements.</p>



<a name="260826338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260826338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260826338">(Nov 09 2021 at 17:00)</a>:</h4>
<p>I had the impression that some crates were imported from public, and if so, it might be painful to rewrite their dependencies too.</p>



<a name="260830698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260830698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260830698">(Nov 09 2021 at 17:31)</a>:</h4>
<p>Ah, so, we never modify public crates (that is, those imported from <a href="http://crates.io">crates.io</a>). This auto-versioning is only for "internal" crates managed by this bigger build system, which also means that no public crates will have dependencies on them. So it is feasible to require all internal versions and dependency specifiers to use pre-release versions. However, that feels pretty "anti-Cargo" — if the goal is to make internal Rust development as close to external development as possible (which it is), then "always use pre-release everywhere and never release a non-pre-release version" seems possibly counter-productive.</p>
<p>The more I think about this, the more I feel like auto-setting the patch version number is the right way to go short term, and then to have the long-term plan be to have semver (or at least Cargo's semver) have a notion of subpatch versions. Overnight I did realize that that likely won't make it into the semver spec though, since it would be a backwards incompatible change to the spec — parsers that support the _current_ version of the spec would fail to parse version specifiers using the expanded range.</p>



<a name="260831012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260831012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260831012">(Nov 09 2021 at 17:34)</a>:</h4>
<p>You feel like the patch version is going to be a better fit than the build metadata, even if the latter works in Cargo?</p>



<a name="260831387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260831387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260831387">(Nov 09 2021 at 17:37)</a>:</h4>
<p>I'm _really_ torn on build metadata. I like it as a solution because it appends instead of overwrites, but I dislike it because it goes directly against the spec. And experience tells me that going against the spec inevitably comes back to bite you in the ass. Whereas overwriting the patch version doesn't actually seem problematic in this case since I _know_ its unused for the crates anyway (in fact, I'm planning on emitting an error if the patch version is ever <code>!= 0</code>).</p>



<a name="260831709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260831709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260831709">(Nov 09 2021 at 17:39)</a>:</h4>
<p>FWIW, if the crates are <em>exclusively</em> your own, then that seems much less problematic.</p>



<a name="260832243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/260832243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#260832243">(Nov 09 2021 at 17:41)</a>:</h4>
<p>Yes, the crates I'm doing this to are exclusively internal crates (that is, crates written in the context of this build system).</p>



<a name="261202228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/dark-magic-reassigning-version/near/261202228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jon Gjengset <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/dark-magic-reassigning-version.html#261202228">(Nov 12 2021 at 01:16)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> FYI, I found the "same version different build metadata" issue you were thinking of: &lt;<a href="https://github.com/rust-lang/cargo/issues/7180">https://github.com/rust-lang/cargo/issues/7180</a>&gt;.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>