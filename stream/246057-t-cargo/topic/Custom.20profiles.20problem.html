<html>
<head><meta charset="utf-8"><title>Custom profiles problem · t-cargo · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/index.html">t-cargo</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html">Custom profiles problem</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263538821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263538821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263538821">(Dec 03 2021 at 05:53)</a>:</h4>
<p>I just updated to 1.57.0 and I'm seeing unexpected behaviour changes. I'm wondering if it's a bug related to custom profiles.</p>



<a name="263538826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263538826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263538826">(Dec 03 2021 at 05:53)</a>:</h4>
<p>My crates has this in the <code>Cargo.toml</code>:</p>
<div class="codehilite"><pre><span></span><code># This profile is used for `cargo test --release`, and some tests depend on
# having debug info.
[profile.bench]
debug = 1
</code></pre></div>



<a name="263538902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263538902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263538902">(Dec 03 2021 at 05:55)</a>:</h4>
<p>The tests mentioned by the comment are passing with 1.56.0, and failing with 1.57.0.</p>



<a name="263539023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263539023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263539023">(Dec 03 2021 at 05:57)</a>:</h4>
<p>The repo is <a href="https://github.com/nnethercote/dhat-rs/tree/dhat-0.3">https://github.com/nnethercote/dhat-rs/tree/dhat-0.3</a>. (Note that's a non-master branch.)</p>



<a name="263539423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263539423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263539423">(Dec 03 2021 at 06:04)</a>:</h4>
<p>When I run <code>cargo test --release -vv</code> with 1.56 I see lots of <code>-C debuginfo=1</code> in the output, I don't see that with 1.57.0.</p>



<a name="263539619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263539619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263539619">(Dec 03 2021 at 06:08)</a>:</h4>
<p>I found <a href="https://github.com/rust-lang/cargo/issues/6988#issuecomment-888991198">https://github.com/rust-lang/cargo/issues/6988#issuecomment-888991198</a>, which seems relevant: "turns out my bug was depending on lto specifically, and, when two profiles are active (cargo test --release), lto is implicitly disabled when it's not enabled in at least one profile."</p>



<a name="263539797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263539797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263539797">(Dec 03 2021 at 06:12)</a>:</h4>
<p>Anyway, it's very unclear to me if this is an intended behaviour change. As the comment in the <code>Cargo.toml</code> makes clear, my goal here is to build tests with debug info for both debug and release.</p>



<a name="263539876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263539876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263539876">(Dec 03 2021 at 06:14)</a>:</h4>
<p><a href="https://doc.rust-lang.org/cargo/reference/profiles.html#bench">https://doc.rust-lang.org/cargo/reference/profiles.html#bench</a> says</p>
<blockquote>
<p>The bench profile is used for building benchmarks, or when tests are built with the --release flag.</p>
</blockquote>



<a name="263539916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263539916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263539916">(Dec 03 2021 at 06:15)</a>:</h4>
<p>But <a href="https://doc.rust-lang.org/cargo/reference/profiles.html#profile-selection">https://doc.rust-lang.org/cargo/reference/profiles.html#profile-selection</a> says (my emphasis):</p>
<blockquote>
<p>The default profile if none is specified is:</p>
<ul>
<li>Build commands like cargo build, cargo rustc, cargo check, and cargo run: dev profile</li>
<li><strong>cargo test: test profile</strong></li>
<li>cargo bench: bench profile</li>
<li>cargo install: release profile</li>
</ul>
</blockquote>



<a name="263540023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263540023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263540023">(Dec 03 2021 at 06:18)</a>:</h4>
<p>Those two sections disagree?</p>



<a name="263540080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263540080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263540080">(Dec 03 2021 at 06:18)</a>:</h4>
<p>I tried adding <code>[profile.test] debug = 1</code>, but with that <code>cargo test --release</code> still fails on 1.57.0.</p>



<a name="263540178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263540178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263540178">(Dec 03 2021 at 06:20)</a>:</h4>
<p>Then I tried adding this instead:</p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[profile.foo]</span>
<span class="n">inherits</span> <span class="o">=</span> <span class="s">"test"</span>
<span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>
<p>And then <code>cargo test --profile=foo</code> works. But I'd rather just type <code>cargo test --release</code>...</p>



<a name="263540394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263540394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263540394">(Dec 03 2021 at 06:25)</a>:</h4>
<p>Aha! <a href="https://doc.rust-lang.org/cargo/commands/cargo-test.html#compilation-options">https://doc.rust-lang.org/cargo/commands/cargo-test.html#compilation-options</a> says:</p>
<blockquote>
<p>--release<br>
   Test optimized artifacts with the release profile. </p>
</blockquote>
<p>And I tried adding <code>[profile.release] debug = 1</code> and now <code>cargo test --release</code> succeeds with 1.57.0.</p>



<a name="263540413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263540413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263540413">(Dec 03 2021 at 06:25)</a>:</h4>
<p>So it's clear the behaviour has changed, and I've found three places in the docs that all say different things about which profile is used for <code>cargo test --release</code>.</p>



<a name="263598245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263598245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263598245">(Dec 03 2021 at 15:51)</a>:</h4>
<p>The very confusing behavior about what happens to dependencies of tests in release, was changed to be more compatible with custom profiles and to make more sense. The fact that our docs are inconsistent and incorrect, is definitely a bug.</p>



<a name="263617869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263617869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263617869">(Dec 03 2021 at 18:18)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> Sorry about the confusion. I have posted <a href="https://github.com/rust-lang/cargo/pull/10153">https://github.com/rust-lang/cargo/pull/10153</a> with a fix to the docs.</p>



<a name="263658459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263658459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263658459">(Dec 03 2021 at 21:56)</a>:</h4>
<p>Thanks, that's a clear improvement.</p>
<p>Is this an accurate thing to put in my Cargo.toml file?</p>
<div class="codehilite"><pre><span></span><code># Some tests require debug info. `cargo test` always enables debug info, but
# `cargo test --release` does not, so we enable it here. In Rust 1.56 and
# earlier, `profile.bench` was used for `cargo test --release`. In Rust 1.57
# and later, `profile.release` is used instead. So we specify both.
[profile.bench]
debug = 1
[profile.release]
debug = 1
</code></pre></div>



<a name="263660318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263660318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263660318">(Dec 03 2021 at 22:13)</a>:</h4>
<p>Yea, that seems right.</p>



<a name="263785877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/246057-t-cargo/topic/Custom%20profiles%20problem/near/263785877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/246057-t-cargo/topic/Custom.20profiles.20problem.html#263785877">(Dec 05 2021 at 19:56)</a>:</h4>
<p>Ok, thank you. I guess an alternative would be to specify 1.57 as the minimum version.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>