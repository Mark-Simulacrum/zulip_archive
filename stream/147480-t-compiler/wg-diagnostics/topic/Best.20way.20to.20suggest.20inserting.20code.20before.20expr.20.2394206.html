<html>
<head><meta charset="utf-8"><title>Best way to suggest inserting code before expr #94206 · t-compiler/wg-diagnostics · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/index.html">t-compiler/wg-diagnostics</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Best.20way.20to.20suggest.20inserting.20code.20before.20expr.20.2394206.html">Best way to suggest inserting code before expr #94206</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="275347241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Best%20way%20to%20suggest%20inserting%20code%20before%20expr%20%2394206/near/275347241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Best.20way.20to.20suggest.20inserting.20code.20before.20expr.20.2394206.html#275347241">(Mar 15 2022 at 09:18)</a>:</h4>
<p>What is the best way to suggest inserting a snippet of code in front (the line above) an expression?</p>
<p>E.g. if I have code like </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="c1">// ^ insert code here</span>
<span class="w">        </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>And I a want to suggest inserting something in front of the <code>match</code> like so:</p>
<div class="codehilite"><pre><span></span><code>help: move `x.y` in front of the `match`
   |
LL +     let value = x.y;
LL ~     match value.z {
   |           ~~~~~
</code></pre></div>
<p>How would I best produce a suggestion that says "insert this line in front of the match"?</p>
<p>This came up in <a href="https://github.com/rust-lang/rust/issues/94206">#94206</a>, but I wondered how to best do that myself sometimes before.</p>



<a name="275348468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Best%20way%20to%20suggest%20inserting%20code%20before%20expr%20%2394206/near/275348468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Best.20way.20to.20suggest.20inserting.20code.20before.20expr.20.2394206.html#275348468">(Mar 15 2022 at 09:29)</a>:</h4>
<p>My guess would have been to insert a snippet at the start of the line of the match and add a \n at the end of the snippet</p>



<a name="275348484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Best%20way%20to%20suggest%20inserting%20code%20before%20expr%20%2394206/near/275348484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Best.20way.20to.20suggest.20inserting.20code.20before.20expr.20.2394206.html#275348484">(Mar 15 2022 at 09:29)</a>:</h4>
<p>Not sure the diagnostic renderer handles this well though</p>



<a name="275350420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Best%20way%20to%20suggest%20inserting%20code%20before%20expr%20%2394206/near/275350420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Best.20way.20to.20suggest.20inserting.20code.20before.20expr.20.2394206.html#275350420">(Mar 15 2022 at 09:50)</a>:</h4>
<p>I would span over the <code>match x.y.z {</code> and include the <code>match x.y.z {</code> in the suggested string. Clippy does that for <a href="https://rust-lang.github.io/rust-clippy/master/index.html"><code>branches_sharing_code</code></a> and the <a href="https://github.com/rust-lang/rust-clippy/blob/master/tests/ui/branches_sharing_code/shared_at_top.stderr">output</a> looks like the example output <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="275350868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Best%20way%20to%20suggest%20inserting%20code%20before%20expr%20%2394206/near/275350868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Best.20way.20to.20suggest.20inserting.20code.20before.20expr.20.2394206.html#275350868">(Mar 15 2022 at 09:54)</a>:</h4>
<p>How would I get the span of the start of the line of the match? It would pretty much be an empty span. Does <code>expr.span.until(expr.span)</code> work?</p>
<blockquote>
<p>I would span over the <code>match x.y.z {</code> and include the <code>match x.y.z {</code> in the suggested string. </p>
</blockquote>
<p>That's how it is currently done. But since the <code>x.y</code> is replaced by the local it runs in a edge case with <code>match (x.y.z, true)</code>, where the <code>(</code> is then removed. In this case you can't just include the <code>match</code> verbatim, because you also have to modify the scrutinee.</p>



<a name="275351112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Best%20way%20to%20suggest%20inserting%20code%20before%20expr%20%2394206/near/275351112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> xFrednet <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Best.20way.20to.20suggest.20inserting.20code.20before.20expr.20.2394206.html#275351112">(Mar 15 2022 at 09:56)</a>:</h4>
<p>Ahh okay, The suggestion could only span over the <code>match</code> keyword excluding the scrutinee, but the suggesting might look a bit weird as a result as it will include the original scrutinee <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="275361407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Best%20way%20to%20suggest%20inserting%20code%20before%20expr%20%2394206/near/275361407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Best.20way.20to.20suggest.20inserting.20code.20before.20expr.20.2394206.html#275361407">(Mar 15 2022 at 11:45)</a>:</h4>
<p><a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_span/struct.Span.html#method.shrink_to_lo">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_span/struct.Span.html#method.shrink_to_lo</a> gives you a span pointing before its first character</p>



<a name="275574598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Best%20way%20to%20suggest%20inserting%20code%20before%20expr%20%2394206/near/275574598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Esteban Küber <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Best.20way.20to.20suggest.20inserting.20code.20before.20expr.20.2394206.html#275574598">(Mar 16 2022 at 20:45)</a>:</h4>
<p>A <code>multipart_suggestion</code> receiving a span for the <code>match_expr.span.shrink_to_lo()</code> and another for <code>x.y</code> should support everything working well. There's a (hacky) method whose name I don't recall now to get the indentation preceding the current span and you can use that as part of the snippet for <code>let value = x.y;\n{}</code> so that the match doesn't change positions, but that is something that you can skip and rely on <code>rustfmt</code> to fix for the user.</p>



<a name="275623665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/147480-t-compiler/wg-diagnostics/topic/Best%20way%20to%20suggest%20inserting%20code%20before%20expr%20%2394206/near/275623665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> flip1995 <a href="https://zulip-archive.rust-lang.org/stream/147480-t-compiler/wg-diagnostics/topic/Best.20way.20to.20suggest.20inserting.20code.20before.20expr.20.2394206.html#275623665">(Mar 17 2022 at 09:10)</a>:</h4>
<p>Thanks, this is how it is done now. I wanted to ask if there is a better way to deal with the indentation. Clippy has a uility called <code>indent_of(span)</code> that gets the indentation, that can then be used with <code>" ".repeat(indent)</code> to keep the <code>match</code> indentation. So that should work now. <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>